#! /usr/bin/env node
"use strict";var JT=Object.create;var li=Object.defineProperty;var YT=Object.getOwnPropertyDescriptor;var XT=Object.getOwnPropertyNames;var QT=Object.getPrototypeOf,ZT=Object.prototype.hasOwnProperty;var v=(s,e)=>()=>(s&&(e=s(s=0)),e);var z=(s,e)=>{for(var t in e)li(s,t,{get:e[t],enumerable:!0})},yd=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of XT(e))!ZT.call(s,n)&&n!==t&&li(s,n,{get:()=>e[n],enumerable:!(r=YT(e,n))||r.enumerable});return s};var I=(s,e,t)=>(t=s!=null?JT(QT(s)):{},yd(e||!s||!s.__esModule?li(t,"default",{value:s,enumerable:!0}):t,s)),qe=s=>yd(li({},"__esModule",{value:!0}),s);var je={};z(je,{log:()=>U,measure:()=>tw});function U(...s){if(!Td)return;let e=Date.now();console.log(`${e-ew}			${e-bd}			`,...s),bd=e}function tw(s,e){if(!Td)return;let t=Date.now();try{s()}finally{console.log(e||s.name,"took",Date.now()-t)}}var Td,ew,bd,$e=v(()=>{"use strict";Td=process.env.MEASURE_TESTIM_CLI_PERFORMANCE,ew=Date.now(),bd=Date.now()});var qt,Hr=v(()=>{"use strict";qt="element-6066-11e4-a52e-4f735466cecf"});function re(s=16){let e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",t="";for(let r=0;r<s;r++){let n=Math.floor(Math.random()*e.length);t+=e[n]}return t}function ze(s,e,t,r,n){let i="";return n=n?encodeURIComponent(n):"master",e&&t&&(i=`${s}/#/project/${e}/branch/${n}/test/${t}`,r&&(i+=`?result-id=${r}`)),i}function uc(s,e){return`Basic ${Buffer.from(`${s}:${e}`).toString("base64")}`}function Le(s){let e=/^(https?:\/\/)/i,t=new RegExp("^(?:(?:(?:https?|ftp):)?\\/\\/)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z0-9\\u00a1-\\uffff][a-z0-9\\u00a1-\\uffff_-]{0,62})?[a-z0-9\\u00a1-\\uffff]\\.)+(?:[a-z\\u00a1-\\uffff]{2,}\\.?))(?::\\d{2,5})?(?:[/?#]\\S*)?$","i");return e.test(s)||t.test(s)}var pc=v(()=>{"use strict"});var mc,wd,vd,yi=v(()=>{mc={ngrok:"4.3.3","v8-to-istanbul":"9.1.0","istanbul-lib-coverage":"3.2.0","@bcoe/v8-coverage":"0.2.3","convert-source-map":"1.7.0",multer:"2.0.1"},wd={"@applitools/eyes-sdk-core":"13.11.34-legacy.1","@applitools/spec-driver-webdriverio":"1.4.29","@segment/analytics-node":"2.1.3","@types/unzip-stream":"0.3.4",ajv:"6.12.6","body-parser":"1.20.3",chalk:"4.1.2","chrome-launcher":"0.15.0",commander:"10.0.0",compression:"1.7.4",cors:"2.8.5","data-uri-to-buffer":"2.0.2",dayjs:"1.11.8",eventsource:"3.0.6",express:"4.21.2",fkill:"7.2.1","form-data":"3.0.0","https-proxy-agent":"7.0.2","istanbul-lib-report":"3.0.0","istanbul-reports":"3.1.5",jimp:"1.1.4",jsonwebtoken:"9.0.0",linkedom:"0.18.0",lodash:"4.17.21","memory-fs":"0.5.0",ms:"2.1.2","node-fetch":"2.7.0",npm:"10.5.0","object-hash":"3.0.0",ora:"5.4.1","p-limit":"4.0.0","p-retry":"4.6.2",pako:"1.0.11",portfinder:"1.0.28","promise-queue":"2.2.5",prompts:"2.4.2","proxy-agent":"6.3.1","rox-node":"5.4.12",semver:"7.6.0","serialize-error":"7.0.1","socket.io-client":"4.8.0","source-map-support":"0.5.19",superagent:"9.0.1","superagent-proxy":"3.0.0","test-exclude":"7.0.0","ua-parser-js":"0.7.39","unzip-stream":"0.3.4",uuid:"11.0.5","validate-npm-package-name":"3.0.0",webdriverio:"8.44.1",winston:"3.11.0","winston-transport":"4.6.0",ws:"8.17.1",xml2js:"0.6.2",yaml:"2.2.2"},vd={node:">= 18.0.0"}});var dr,nw,Sd,mr,Ed,Rt,iw,js,Id,Rd,bi,tt,xd,he,Ad,Cd,Ti,We,fc,Pd,wi,kd,Od,JR,YR,_d,Ld,$s,Dd,Nd,Md,Ud,gc,hc,yc,bc,Fd,Ws,Bd,Tc,Vs,ae=v(()=>{"use strict";dr=process.env.SERVICES_HOST||"https://services.testim.io",nw="https://testimstatic.blob.core.windows.net",Sd="https://tstresultfiles.azureedge.net",mr="https://app.testim.io";process.env.GATEWAY_URL&&(process.env.CORALOGIX_URL=`${process.env.GATEWAY_URL}/testim/coralogix/api/v1/logs`,process.env.SERVICES_HOST=`${process.env.GATEWAY_URL}/testim/services`,process.env.EXTENSION_SERVICES_HOST=process.env.TUNNEL_GATEWAY?process.env.SERVICES_HOST:dr,dr=process.env.SERVICES_HOST);Ed=process.env.TESTIM_REGION||"us-west-2",Rt=process.env.RUNNER_ENVIRONMENT||"production",iw={production:"",staging:".staging",development:".dev"},js=process.env.EXTENSION_SP_S3_HOST||`https://playback-components${iw[Rt]}.testim.io`,Id=parseInt(process.env.DISABLE_AGENT_ORIGIN_CHECK||"0",10),Rd=parseInt(process.env.DISABLE_DEBUGGER_INFINITE_TIMEOUT||"0",10),bi=parseInt(process.env.OVERRIDE_TIMEOUTS||"0",10),tt=process.env.EDITOR_URL,xd=process.env.WEBSOCKET_HOST||`${dr}/ws`,he=()=>dr,Ad=parseInt(process.env.LOGGER_CONSOLE||"0",10),Cd=parseInt(process.env.LOGGER_DEBUG||"0",10),Ti=parseInt(process.env.WEBDRIVER_DEBUG||"0",10),We=parseInt(process.env.IS_ON_PREM||"0",10),fc=process.env.REQUESTS_QUEUE_SIZE?parseInt(process.env.REQUESTS_QUEUE_SIZE,10):void 0,Pd=parseInt(process.env.DEBUG_MODE||"0",10),wi=process.env.TESTIM_CONCURRENT_WORKER_COUNT?parseInt(process.env.TESTIM_CONCURRENT_WORKER_COUNT,10):null,kd=process.env.ROLLOUT_KEY||"5b5560729601aa6484276518",Od=process.env.CORALOGIX_PRIVATE_KEY||"d0eb01da-f966-1663-63c6-8871225d7c39",JR=parseInt(process.env.DF_ENABLE_VIDEO||"0",10),YR=process.env.APPIUM_VERSION||"1.10.1",_d=process.env.GATEWAY_URL,Ld=()=>process.env.EXTENSION_SERVICES_HOST||dr,$s=process.env.GATEWAY_URL?`${process.env.GATEWAY_URL}/testim/blob`:nw,Dd=process.env.GATEWAY_URL?`${process.env.GATEWAY_URL}/testim/edge`:Sd,Nd=Sd,Md=5*60*1e3,Ud=40,gc=process.env.HEADSPIN_MOBILE_API_BASE_URL||"https://api-dev.headspin.io",hc=process.env.TDC_MOBILE_API_BASE_URL||"https://api.tdc.tricentis-cloud.com",yc=process.env.HEADSPIN_TDC_DEVICES_API_PATH||"v0",bc=process.env.HEADSPIN_TDC_APPS_API_PATH||"v1",Fd=process.env.TVC_MOBILE_API_URL||"https://api.waldo.com",Ws=process.env.BROWSERSTACK_APPS_API_URL||"https://api-cloud.browserstack.com/app-automate",Bd=process.env.P_CLOUDY_DEFAULT_TEST_DURATION||60,Tc=process.env.P_CLOUDY_DEFAULT_ANDROID_DEVICE_NAME||"samsung",Vs=s=>{dr=s,process.env.SERVICES_HOST=s,process.env.EXTENSION_SERVICES_HOST=process.env.TUNNEL_GATEWAY?process.env.SERVICES_HOST:dr}});var jd,vi,$d=v(()=>{"use strict";jd=I(require("superagent"));ae();vi=class{constructor(e){this.logs=[];this.url=process.env.CORALOGIX_URL||"https://ingress.coralogix.com/logs/v1/bulk",this.token=Od,this.applicationName=e.applicationName,this.subsystemName=e.subsystemName,this.flushIntervalMs=e.flushIntervalMs||2e3,this.maxBufferedLogsCount=e.maxBufferedLogsCount||50,this.interval=setInterval(()=>this.flushLogs(),this.flushIntervalMs)}addLog(e){this.logs.push(e),this.logs.length>=this.maxBufferedLogsCount&&this.flushLogs()}setProxy(e){this.proxy=e}async waitForFlush(){clearInterval(this.interval),await this.flushLogs()}async flushLogs(){try{if(this.logs.length===0)return;let e={applicationName:this.applicationName,subsystemName:this.subsystemName,logEntries:[...this.logs]};this.logs=[];let t=jd.default.post(this.url).set("Content-Type","application/json; charset=UTF-8").set("Authorization",`Bearer ${this.token}`).send(e);this.proxy&&t.proxy(this.proxy),await t}catch{}}}});var Vd={};z(Vd,{CoralogixTransport:()=>wc});var Wd,ow,aw,wc,Gd=v(()=>{"use strict";Wd=I(require("winston-transport"));$d();ow={debug:1,silly:2,verbose:2,silent:2,info:3,http:3,warn:4,warning:4,error:5,critical:6,crit:6},aw=["err","error","reason","e"],wc=class extends Wd.default{constructor(t){super(t);this.name="Coralogix Transport",this.category=t.category,this.logger=new vi({applicationName:"testim",subsystemName:"runner"})}log(t,r){let{category:n,level:i,message:o,meta:a={},...c}=t,l={...a,...c},d={severity:ow[i],text:o,category:n||this.category};l.className&&(d.className=l.className),l.methodName&&(d.methodName=l.methodName),l.threadId&&(d.threadId=l.threadId),delete l.className,delete l.methodName,delete l.threadId,delete l.category,delete l.level,delete l.message;let m=!1;a instanceof Error&&(m=!0,l.msg=a.message+a.stack,o&&(l.msg=`${o}
${l.msg}`));for(let u of aw)a[u]instanceof Error&&(l[u]={message:a[u].message,stack:a[u].stack,name:a[u].name,type:a[u].type,cause:a[u].cause,...a[u]});Object.keys(l).length>0&&(o&&!m&&(l.msg=o),d.text=JSON.stringify(l)),this.logger.addLog(d),r(null,!0)}setProxy(t){this.logger.setProxy(t)}async waitForFlush(){return await this.logger.waitForFlush()}}});function uw(){let s=[],e=()=>Promise.resolve(),t=r=>{};if(!We){let{CoralogixTransport:r}=(Gd(),qe(Vd)),n=new r({category:"ROOT"});s.push(n),e=()=>n.waitForFlush(),t=i=>n.setProxy(i)}if(Ad){let r={depth:5,colors:!0};s.push(new ft.transports.Console({format:ft.format.combine(ft.format.colorize({all:!0,colors:{info:"blue",error:"red",warning:"yellow"}}),ft.format.timestamp({format:"HH:mm:ss:SSS"}),ft.format.printf(n=>`[${n.timestamp}] ${n.level}	 ${n.category}: ${n.message} ${Ei.inspect(n.meta,r)}`))}))}return[s,e,t]}function Xd(s){vc=s}function Qd(s){Yd=s}function Zd(s){We||!s||mw(s)}function qd(s){return{projectId:Yd,time:new Date().toISOString(),...vc&&!s&&{executionId:vc}}}function C(s){return new Sc(hw.child({category:s}))}var zd,ft,Ei,Si,Kd,cw,lw,Hd,Jd,pw,dw,mw,fw,gw,hw,vc,Yd,Sc,$=v(()=>{"use strict";zd=I(require("node:os")),ft=I(require("winston"));ae();Ei=I(require("node:util")),Si=I(require("chalk")),Kd=I(require("dayjs"));B();cw=zd.hostname(),lw=rt();Hd={depth:5,colors:!0},Jd=(s,e,t)=>{let r=`[${(0,Kd.default)().format("HH:mm:ss:SSS")}]`,n=Ei.inspect(e,Hd),i=Ei.inspect(t,Hd);return`${Si.default.white(r)} ${Si.default.reset()}SessionPlayer-${Si.default.red(s)}	 ${n} ${i}`},[pw,dw,mw]=uw(),fw=Cd?"debug":"info",gw={release:Boolean(!1),branch:"runner-v4.157.0"},hw=ft.createLogger({levels:ft.config.syslog.levels,level:fw,transports:pw,defaultMeta:{name:"runner",hostname:cw,nodeVersion:process.version,runnerVersion:lw,...gw}}),vc=null,Yd=null;Sc=class{constructor(e){this._logger=e;this.debug=this.debug.bind(this),this.info=this.info.bind(this),this.warn=this.warn.bind(this),this.error=this.error.bind(this),this.fatal=this.fatal.bind(this)}debug(e,t={}){this.innerLog("debug",e,t)}info(e,t={}){this.innerLog("info",e,t)}warn(e,t={}){this.innerLog("warning",e,t)}error(e,t={}){this.innerLog("error",e,t)}fatal(e,t={}){this.innerLog("crit",e,t)}innerLog(e,t,r={}){let{executionId:n}=r;try{this._logger.log(e,{meta:r,message:t,...qd(n)})}catch(i){try{this._logger.log("crit",{message:`failed to log message ${i.message}, ${i.stack}`,...qd(n)})}catch{}}}waitForFlush(){return dw()}}});var Ai,qr,A,zt,fr,xt,Ii,zr,ce,Gs,st,Kt,At,Ri,Kr,xi,Hs,X=v(()=>{"use strict";Ai=require("p-retry"),qr=class extends Error{constructor(){super(...arguments);this.name="NoArgsError"}},A=class extends Error{constructor(){super(...arguments);this.name="ArgError"}},zt=class extends Error{constructor(){super(...arguments);this.name="StopRunOnError"}},fr=class extends Error{constructor(t,r){super(t instanceof Error?t.message:t,{cause:t});this.type=r}},xt=class extends Ai.AbortError{},Ii=class extends Ai.AbortError{},zr=class extends Ai.AbortError{},ce=class extends Error{},Gs=class extends Error{},st=class extends Error{constructor(){super(...arguments);this.name="GridError"}toString(){return this.message}},Kt=class extends st{constructor(){super(...arguments);this.name="GridConcurrencyError"}},At=class extends Error{constructor(){super(...arguments);this.name="NpmPackageError"}},Ri=class extends Error{constructor(){super(...arguments);this.message="selenium driver crashed";this.name="SeleniumCrashError"}},Kr=class extends Error{constructor(t){super(`Testim had missing write access to ${t}`);this.path=t}},xi=class extends Error{constructor(e){super(`Package for CLI action need to have a CommonJS export which the package ${e} does not have`)}},Hs=class extends Error{constructor(e=!1){let t="not implemented";e&&(t="should be implemented on descendant"),super(t)}}});function Ec(s){return!!s&&(typeof s=="object"||typeof s=="function")&&typeof s.then=="function"&&typeof s.catch=="function"}function ue(s){return(0,rm.setTimeout)(s)}function Ic(s,e){let t=new Promise((r,n)=>{e.onabort=()=>{n(e.reason)}});return Promise.race([s,t])}function pe(s,e,t="Timeout Error"){bi&&!em&&(em=!0,console.log("Debugger connected - timeouts were overridden to 10 minutes to improve debugging"));let r=new ce(t);return e=bi?Number(bi)||6e5:e,Promise.race([s,ue(e).then(()=>{throw r})])}async function se(s,e,{concurrency:t}={}){if(t){tm||=(await import("p-limit")).default;let r=tm(t);return await Promise.all(Array.from(s,(n,i)=>r(()=>e(n,i))))}return await Promise.all(Array.from(s,e))}function Jt(s){return new Promise((e,t)=>{s((r,n)=>r?t(r):e(n))})}var rm,em,tm,Rc=v(()=>{"use strict";rm=require("timers/promises");X();ae();em=!1});var zs,sm,bw,qs,nm,Tw,ww,im,om=v(()=>{"use strict";zs=I(require("lodash"));ae();sm=require("dns");$();Rc();bw=C("http-request-counters"),qs=!1,nm=async()=>{if(We)return!0;let s=["www.google.com","www.facebook.com","www.microsoft.com","testim.io"];try{let e=Boolean(await se(s,t=>sm.promises.lookup(t)));return e||(qs=!0),e}catch{return bw.error("network connectivity test failed"),qs=!0,!1}},Tw=zs.throttle(nm,10*1e3),ww=60*1e3*15,im=()=>{let s={call:new Map,success:new Map,fail:new Map};function e(n,i){let o=n.get(i)||0;n.set(i,o+1),setTimeout(()=>{let a=n.get(i)||1;n.set(i,a-1)},ww)}function t(n,i=n.name){return async function(...o){e(s.call,i);try{let a=await n.call(null,...o);return e(s.success,i),a}catch(a){throw e(s.fail,i),qs||Tw(),a}}}async function r(){if(qs||!await nm())return!1;let n=zs.sum([...s.fail.values()]),i=zs.sum([...s.call.values()]);return n<i*.1}return r.counters=s,t.counters=s,t.isNetworkHealthy=r,t.didNetworkConnectivityTestFail=()=>qs,t}});var Ke={};z(Ke,{deleteReq:()=>Ks,didNetworkConnectivityTestFail:()=>_c,download:()=>kc,get:()=>Te,getFullRes:()=>Rw,getText:()=>Ys,head:()=>xw,isNetworkHealthy:()=>Oc,post:()=>Ve,postForm:()=>Js,postText:()=>Cc,put:()=>Pc});function Sw(){return global.caFileContent}function Ew(s,e){let t=[];s.on("data",r=>{t.push(r)}),s.on("end",()=>{e(null,Buffer.concat(t))})}function Iw(){return!gt.default.Request.prototype.proxy&&global.SuperagentProxy&&global.SuperagentProxy(gt.default),global.proxyUri}function gr(s,e=!1){let t=Sw();t&&s.ca(t);let r=!e&&Iw();r&&s.proxy(r)}async function am(s,e,t={},r=Jr,n=0){let i=gt.default.post(s).send(e).timeout(r).set(t);gr(i),n&&i.retry(n);try{return await i}catch(o){throw o.url=s,o.originalRequestTimeout=r,o.additionalSetHeaders=t,o}}async function Ac(s,e,t={},r=Jr,{isBinary:n=!1,skipProxy:i=!1}={}){let o=gt.default.get(s).query(e||{}).timeout(r).set(t);return n&&o.buffer(!0),gr(o,i),await o}var gt,xc,nt,Jr,vw,Ut,Ks,Ve,Js,Ys,Cc,Te,Rw,xw,Pc,kc,Oc,_c,Ge=v(()=>{"use strict";gt=I(require("superagent"));$();om();xc=C("http-request"),nt=im(),Jr=parseInt(process.env.DEFAULT_REQUEST_TIMEOUT||"0",10)||3e4,vw=6e4;Ut=(s,e,t)=>{let r=e.response;e.response instanceof gt.default.Response&&typeof r.toError=="function"&&(e=e.response.toError(),e.requestHeaders=r==null?void 0:r.header,e.responseHeaders=r==null?void 0:r.headers);let n=new Error("").stack;throw xc.error(s,{...t,error:e,logErrorAndRethrowStack:n}),e};Ks=nt(async(s,e={},t={},r=Jr)=>{try{let n=gt.default.delete(s).send(e).timeout(r).set(t);gr(n);let i=await n;return i.type==="text/plain"?i.text:i.body}catch(n){return Ut("failed to delete request",n,{url:s})}}),Ve=nt(async({url:s,body:e,headers:t,timeout:r,retry:n})=>{try{let i=await am(s,e,t,r,n);return i.type==="text/plain"?i.text:i.body}catch(i){return Ut("failed to post request",i,{url:s})}});Js=nt(async(s,e,t,r={},n=Jr)=>{let i=gt.default.post(s).type("form").timeout(n).set(r);i.field(e),Object.entries(t).forEach(([o,a])=>{i.attach(o,a.buffer,a.fileName)}),gr(i);try{let o=await i;return o.type==="text/plain"?o.text:o.body}catch(o){return Ut("failed to post request",o,{url:s})}});Ys=nt(async(s,e,t)=>{try{return(await Ac(s,e,t)).text}catch(r){return Ut("failed to getText request",r,{url:s,query:e})}}),Cc=nt(async({url:s,body:e,headers:t,timeout:r,retry:n})=>{try{return(await am(s,e,t,r,n)).text}catch(i){return Ut("failed to post request",i,{url:s})}}),Te=nt(async(s,e,t,r,n)=>{try{return(await Ac(s,e,t,r,n)).body}catch(i){return Ut("failed to get request",i,{url:s,query:e})}}),Rw=nt((s,e,t,r)=>Ac(s,e,t,r)),xw=nt(async s=>{let e=gt.default.head(s).timeout(Jr);gr(e);try{return await e}catch(t){return Ut("failed to head request",t,{url:s})}}),Pc=nt(async(s,e,t={},r=Jr)=>{let n=gt.default.put(s).send(e).timeout(r).set(t);gr(n);try{return(await n).body}catch(i){return Ut("failed to put request",i,{url:s})}}),kc=nt(async s=>{xc.info("start to download",{url:s});let e=gt.default.get(s).set("User-Agent","Testim.io").timeout(vw).buffer(!0).parse(Ew);gr(e);try{let t=await e;return xc.info("finished to download",{url:s}),t}catch(t){return Ut("failed to download",t,{url:s})}}),Oc=nt.isNetworkHealthy,_c=nt.didNetworkConnectivityTestFail});function ht(){let s;return require.main?(require.main.filename.includes("/src")||require.main.filename.includes("\\src")?s=Ft.resolve(__dirname,"../../"):s=Ft.resolve(__dirname,""),s):process.cwd()}function Ci(s,e){return Le(s)?e||Ft.join(process.cwd(),s.replace(/^.*[\\/]/,"")):e||Ft.basename(s)}function rt(){try{return require(`${__dirname}/package.json`).version}catch{return""}}function Nc(){try{return vd.node}catch{return""}}async function um(s,e,t=!0){let r=await it.promises.readdir(s,{withFileTypes:!0});await it.promises.mkdir(e,{recursive:t});for(let n of r){let i=Ft.join(s,n.name),o=Ft.join(e,n.name);n.isDirectory()?await um(i,o):await it.promises.copyFile(i,o)}}async function ye(s){try{return await it.promises.access(s),!0}catch(e){if(e.code==="ENOENT")return!1;throw e}}var Ft,cm,lm,it,Aw,Bt,Je,Pi,Lc,ot,Dc,pm=v(()=>{"use strict";Ft=I(require("node:path"));pc();yi();cm=I(require("unzip-stream")),lm=I(require("p-retry")),it=require("node:fs"),Aw=3;Bt=async s=>{let e=await Promise.resolve().then(()=>(Ge(),Ke));return(0,lm.default)(()=>e.download(s),{retries:Aw,factor:1})},Je=async(s,e)=>{let t=await Bt(s);return it.promises.writeFile(e,t.body)};Pi=async(s,e)=>{let t=Ci(s,e);return Le(s)?Je(s,t):it.promises.copyFile(s,t)},Lc=async s=>Le(s)?Bt(s):it.promises.readFile(s),ot=async(s,e)=>(0,it.createReadStream)(s).pipe(cm.Extract({path:e})),Dc=s=>(0,it.statSync)(s).size/1e6});var jt={};z(jt,{APPIUM_SESSION_MESSAGE:()=>jc,CLI_MODE:()=>K,MOBILE_APP_SOURCE:()=>ki,MOBILE_RUN_SKIP_REASON:()=>Bc,REGION_CONFIG:()=>Yr,X_HEADER_RUNNER_ID:()=>$c,gridMessages:()=>yt,gridTypes:()=>_,mobileWeb:()=>Uc,runnerStatus:()=>Mc,runnerTestStatus:()=>fe,socketEventTypes:()=>Ct,stepResult:()=>Qs,test:()=>Fc,testRunStatus:()=>Xs,testStatus:()=>Ye,timeoutMessages:()=>Ue});var Ue,Xs,Mc,fe,Ye,yt,Uc,Fc,Ct,K,_,Qs,ki,Bc,jc,$c,Yr,oe=v(()=>{"use strict";Ue={GET_BROWSER_TIMEOUT_MSG:"get-browser-timeout",TEST_START_TIMEOUT_MSG:"test-start-timeout",TEST_COMPLETE_TIMEOUT_MSG:"test-complete-timeout"},Xs={COMPLETED:"completed"},Mc={RUNNING:"RUNNING",SKIPPED:"SKIPPED",FINISHED:"FINISHED",ABORTED:"ABORTED",QUEUED:"QUEUED",TIMEOUT:"TIMEOUT"},fe={PASSED:"PASSED",FAILED:"FAILED",ABORTED:"ABORTED",SKIPPED:"SKIPPED",QUEUED:"QUEUED",PENDING:"PENDING"},Ye={DRAFT:"draft",EVALUATING:"evaluating",ACTIVE:"active",QUARANTINE:"quarantine"},yt={NOT_FOUND:"The specified grid is not available",UNKNOWN:"Test couldn't get browser - unknown error"},Uc={MOBILE_WEB_REMOTE_RUN_HEADER_SPACING:50},Fc={HIDDEN_PARAM:"TST_HIDDEN_PARAM"},Ct={TEST_RESULT_CREATED:"test-result-created",TEST_RESULT_UPDATED:"test-result-updated",REMOTE_STEP_SAVED:"remote-step-saved"},K={EXTENSION:"extension",SELENIUM:"selenium",APPIUM:"appium"},_={TESTIM_ENTERPRISE:"testimEnterprise",TESTIM:"testim",TESTIM_PRIVATE:"testimPrivate",LAMBDATEST:"lambdaTest",TESTIM_LAMBDATEST:"testimLambdaTest",DEVICE_FARM:"testimDF",HYBRID:"testimHybrid",BROWSERSTACK:"browserstack",SAUCELABS:"saucelabs",TESTIM_HEADSPIN:"testimHeadspin",TESTIM_TDC:"testimTDC",TESTIM_TVC:"testimTVC",P_CLOUDY:"pcloudy"},Qs={SETUP_TIMEOUT:"setup-timeout",NETWORK_ERROR:"network-error",GRID_ERROR:"grid-error",SELENIUM_ERROR:"selenium-error",BROWSER_CLOSED:"browser-closed",MOBILE_SESSION_ERROR:"mobile-session-error",UNKNOWN_ERROR:"unknown-error"},ki={FROM_LIBRARY:"from-library",FROM_DEVICE:"from-device"},Bc={APP_FROM_DEVICE:"app-from-device",VIRTUAL_BUILD:"virtual-build"},jc={APP_NOT_EXIST_ON_DEVICE:"used to start the app doesn't exist or cannot be launched",APP_NEVER_STARTED:"never started",DEVICE_OS_VERSION_TOO_LOW:"DeviceOSVersionTooLow",TIMEOUT_ERROR:"Timeout awaiting 'request'",SAUCELABS_APP_IS_NOT_INSTALLED:"Original error: 'app' option is required for reinstall"},$c="X-Testim-Runner-ID",Yr={TTL:1e3*60*60*24,CACHE_FN_NAME:"setRegionConfig"}});function Zs(s,e){var t,r,n,i,o,a;return(t=s.browserstack)!=null&&t.browserName||(r=s.saucelabs)!=null&&r.browserName?[(n=s.browser)==null?void 0:n.toLowerCase()]:(i=s.testConfigNames)!=null&&i.length||(o=s.testConfigIds)!=null&&o.length||s.testPlan.length||s.testPlanIds.length||!s.browser?[...new Set(e.map(c=>{var l;return(l=c.runConfig)==null?void 0:l.browserValue}))]:[(a=s.browser)==null?void 0:a.toLowerCase()]}function Cw(){let{argv:s}=process;if(s.includes("--remoteRunId"))return{remoteRunId:s[s.indexOf("--remoteRunId")+1],projectId:s[s.indexOf("--project")+1],token:s[s.indexOf("--token")+1]}}var en,dm,Xe,Pw,kw,Ow,_w,Lw,Wc,Vc,mm=v(()=>{"use strict";oe();en=s=>{var e,t;return Boolean(((e=s.testPlan)==null?void 0:e.length)||((t=s.testPlanIds)==null?void 0:t.length))},dm=s=>Boolean(s.resultId&&s.source==="remote-run"),Xe=(s,e)=>s.testStatus===Ye.QUARANTINE&&!dm(e)&&!e.runQuarantinedTests;Pw=s=>Boolean(s.loginMode),kw=s=>Boolean(s.tunnelOnlyMode),Ow=s=>Boolean(s.createPrefechedData),_w=s=>Boolean(s.installLazyDepsMode),Lw=s=>Boolean(s.agentMode),Wc=(s,e)=>{s.forEach((t,r)=>{e.has(t)&&(s[r]=`--${t}`)})},Vc=s=>{let e=[];return Object.entries(s).forEach(([t,r])=>{r&&e.push(`--${t}`,r)}),e}});function _i(s=0){return Oi.default.duration(s).format("HH:mm:ss.SSS")}function Gc(s=0){return Oi.default.duration(s).asSeconds()}var Oi,fm,gm=v(()=>{"use strict";Oi=I(require("dayjs")),fm=I(require("dayjs/plugin/duration"));Oi.default.extend(fm.default)});var tn,Xr,Yt,hm,Qr,ym=v(()=>{"use strict";oe();tn=s=>!(!s||"fileName"in s),Xr=(s,e)=>{if(e===_.TESTIM_TVC)return!1;if(s){if(s.appMetadata&&"iOSSupportedTargetDevice"in s.appMetadata)return s.appMetadata.iOSSupportedTargetDevice==="virtual";if("fileName"in s)return s.fileName.endsWith(".app")}return!1},Yt=s=>{var e,t;return((e=s.projectData)==null?void 0:e.type)==="ios"||((t=s.projectData)==null?void 0:t.type)==="android"},hm=s=>s===_.TESTIM_TVC,Qr=(s,e)=>hm(e)||!s.flags.allowAppFromDeviceRuns.isEnabled()});function Hc(s=4e3){let e=process.memoryUsage(),t=r=>Math.round(r/1024/1024*100)/100;return{isOverThreshold:t(e.rss)>s,rss:`${t(e.rss)} MB -> Resident Set Size - total memory allocated for the process execution`,heapTotal:`${t(e.heapTotal)} MB -> total size of the allocated heap`,heapUsed:`${t(e.heapUsed)} MB -> actual memory used during the execution`,external:`${t(e.external)} MB -> V8 external memory`}}var bm=v(()=>{"use strict"});var Y={};z(Y,{OSS:()=>Zr,TESTIM_BROWSER_DIR:()=>$t,buildBasicHeader:()=>uc,calcPercentile:()=>Ni,copyDir:()=>um,delay:()=>ue,doesPathExist:()=>ye,download:()=>Bt,downloadAndSave:()=>Je,extractElementId:()=>De,getArgsOnRemoteRunFailure:()=>Cw,getBrowserInfo:()=>Nw,getCdpAddressForHost:()=>br,getCliLocation:()=>ht,getDuration:()=>_i,getDurationSec:()=>Gc,getEnginesVersion:()=>Nc,getEnvironmentGitBranch:()=>yr,getLinksFromUnescapeHTML:()=>nn,getLocalFileSizeInMB:()=>Dc,getMemorySnapshot:()=>Hc,getPlanType:()=>Di,getRunConfigByBrowserName:()=>rn,getRunnerVersion:()=>rt,getSource:()=>Pi,getSourceAsBuffer:()=>Lc,getSourcePath:()=>Ci,getTestUrl:()=>ze,getUniqBrowsers:()=>Zs,groupTestsByRetries:()=>zc,guid:()=>re,hasTestPlanFlag:()=>en,isAgentMode:()=>Lw,isAppFromDevice:()=>tn,isAppFromDeviceDisabled:()=>Qr,isCreatePrefetchedDataMode:()=>Ow,isInstallLazyDepsMode:()=>_w,isLoginMode:()=>Pw,isMobileProject:()=>Yt,isPromise:()=>Ec,isQuarantineAndNotRemoteRun:()=>Xe,isRemoteRun:()=>dm,isTestimVirtualGrid:()=>hm,isTunnelOnlyMode:()=>kw,isURL:()=>Le,promiseAbort:()=>Ic,promiseFromCallback:()=>Jt,promiseMap:()=>se,promiseTimeout:()=>pe,removePropertyFromObject:()=>Li,replaceArgsWithNoDashes:()=>Wc,sanitizeNumberValue:()=>hr,shouldBlockVirtualIosBuild:()=>Xr,spreadObjectToArgs:()=>Vc,unescapeHTML:()=>sn,unzipFile:()=>ot});function hr(s,e){let t=Number(s);return Number.isNaN(t)||t<=0?e:t}function Nw(s){return s=s.toLowerCase(),qc.find(e=>e.browserValue===s)}function rn(s,e,t){s=s==null?void 0:s.toLowerCase();let r=qc.find(i=>i.browserName.toLowerCase()===s||s.includes(i.synonyms))||qc[0],n=Zr.find(i=>i.osName==="Windows 10");return e&&(e.platform?n=Zr.find(i=>i.sl.platform===e.platform):e.platformName&&(n=Zr.find(i=>i.sl.platformName===e.platformName))),t&&(t.os_version?n=Zr.find(i=>i.bs.os_version===t.os_version):t.platform&&(n=Zr.find(i=>i.bs.platform===t.platform))),es.merge(r,n)}function yr(){return process.env.GIT_BRANCH||process.env.CIRCLE_BRANCH||process.env.TRAVIS_BRANCH||process.env.CI_BRANCH}function Li(s,e,t){for(let r in s)Object.hasOwn(s,r)&&(t(r,e)?delete s[r]:typeof s[r]=="object"&&Li(s[r],e,t))}function De(s){return s.ELEMENT||s[qt]}function Di(s){s||={};let e=Date.now(),t=s.expireAt||s.expireAT;return s.plan!=="free"?"pro":t?t<e?"free":"trial":"free"}function zc(s=[]){return es.chain(s).groupBy(e=>e.originalTestResultId||e.resultId).values().reduce((e,t)=>{if(!t)return e;if(t.length===1)return e.push(t[0]),e;let r=t.slice().sort((i,o)=>{let a=typeof i.retryCount=="number"?i.retryCount:1,c=typeof o.retryCount=="number"?o.retryCount:1;return a===c?i.startTime-o.startTime:(i.retryCount??0)-(o.retryCount??0)}),n=es.cloneDeep(r.at(-1));return n&&(n.retryTestResults=r,e.push(n)),e},[]).compact().value()}function sn(s){return Sm.parseFromString(`<html><body>${s}</body></html>`,"text/html").documentElement.textContent}function nn(s){return[...Sm.parseFromString(`<html><body>${s}</body></html>`,"text/html").getElementsByTagName("a")].map(t=>t.href).filter(Boolean)}async function br(s,e){let t=await Promise.resolve().then(()=>(Ge(),Ke));try{return(await t.get(`http://${s}/json/version`,void 0,void 0,e)).webSocketDebuggerUrl}catch{throw new Error("unable to connect to devtools server")}}var Tm,es,wm,vm,Dw,$t,Zr,qc,Ni,Sm,B=v(()=>{"use strict";Tm=I(require("os")),es=I(require("lodash")),wm=I(require("path")),vm=require("linkedom");Hr();pm();mm();gm();pc();Rc();ym();bm();Dw=Tm.homedir(),$t=wm.join(Dw,".testim-browser-profile"),Zr=[{osName:"Linux",bs:{os:"LINUX"},sl:{platform:"Linux"},lt:{platform:"Linux"}},{osName:"Windows 11",bs:{os:"WINDOWS",os_version:"11"},sl:{platform:"Windows 11"},lt:{platform:"Windows 11"}},{osName:"Windows 10",bs:{os:"WINDOWS",os_version:"10"},sl:{platform:"Windows 10"},lt:{platform:"Windows 10"}},{osName:"Windows 8",bs:{os:"WINDOWS",os_version:"8"},sl:{platform:"Windows 8"}},{osName:"Windows 8.1",bs:{os:"WINDOWS",os_version:"8.1"},sl:{platform:"Windows 8.1"}},{osName:"Windows 7",bs:{os:"WINDOWS",os_version:"7"},sl:{platform:"Windows 7"}},{osName:"Windows XP",bs:{os:"WINDOWS",os_version:"XP"},sl:{platform:"Windows XP"}},{osName:"macOS Sonoma",bs:{os:"OS X",os_version:"Sonoma",safari_version:"17"},sl:{},lt:{platform:"macOS Sonoma",safari_version:"17"}},{osName:"macOS Ventura",bs:{os:"OS X",os_version:"Ventura",safari_version:"16.5"},sl:{platform:"macOS 13",safari_version:"latest"},lt:{platform:"macOS Ventura",safari_version:"16"}},{osName:"macOS Monterey",bs:{os:"OS X",os_version:"Monterey",safari_version:"15.6"},sl:{platform:"macOS 12",safari_version:"latest"},lt:{platform:"macOS Monterey",safari_version:"15"}},{osName:"macOS Big Sur",bs:{os:"OS X",os_version:"Big Sur",safari_version:"14.1"},sl:{platform:"macOS 11",safari_version:"latest"}},{osName:"macOS Catalina",bs:{os:"OS X",os_version:"Catalina",safari_version:"13.1"},sl:{platform:"macOS 10.15",safari_version:"latest"}},{osName:"macOS Mojave",bs:{os:"OS X",os_version:"Mojave",safari_version:"12.1"},sl:{platform:"macOS 10.14",safari_version:"latest"}},{osName:"macOS High Sierra",bs:{os:"OS X",os_version:"High Sierra",safari_version:"11.1"},sl:{platform:"macOS 10.13",safari_version:"latest"}},{osName:"macOS Sierra",bs:{os:"OS X",os_version:"Sierra",safari_version:"10.1"},sl:{platform:"macOS 10.12",safari_version:"latest"}},{osName:"OS X El Capitan",bs:{os:"OS X",os_version:"El Capitan",safari_version:"9.1"},sl:{platform:"OS X 10.11",safari_version:"latest"}},{osName:"OS X Yosemite",bs:{os:"OS X",os_version:"Yosemite",safari_version:"8"},sl:{platform:"OS X 10.10",safari_version:"latest"}},{osName:"OS X Mavericks",bs:{os:"OS X",os_version:"Mavericks",safari_version:"7.1"},sl:{platform:"OS X 10.9",safari_version:"latest"}},{osName:"OS X Mountain Lion",bs:{os:"OS X",os_version:"Mountain Lion",safari_version:"6.2"},sl:{platform:"OS X 10.8",safari_version:"latest"}},{osName:"OS X Lion",bs:{os:"OS X",os_version:"Lion",safari_version:"6"},sl:{}},{osName:"OS X Snow Leopard",bs:{os:"OS X",os_version:"Snow Leopard",safari_version:"5.1"},sl:{}},{osName:"iOS",bs:{platform:"MAC"},sl:{platformName:"iOS",appiumVersion:"1.6.4"}},{osName:"Android",bs:{platform:"ANDROID"},sl:{platformName:"Android",appiumVersion:"1.6.4"}}],qc=[{browserName:"Chrome",bs:{browser:"Chrome",browser_version:"112"},sl:{browserName:"chrome",version:"94.0"},browserValue:"chrome"},{browserName:"Firefox",bs:{browser:"Firefox",browser_version:"89"},sl:{browserName:"firefox",version:"89.0"},browserValue:"firefox"},{browserName:"Safari",bs:{browser:"Safari"},sl:{browserName:"safari"},browserValue:"safari"},{browserName:"Edge Chromium",bs:{browser:"Edge",browser_version:"112"},sl:{browserName:"MicrosoftEdge",version:"94"},synonyms:["edge-chromium"],browserValue:"edge-chromium",seleniumName:"MicrosoftEdge"},{browserName:"Browser",bs:{},sl:{browserName:"Browser"},browserValue:"browser"},{browserName:"Android",bs:{browserName:"android"},sl:{},browserValue:"android"},{browserName:"iPad",bs:{browserName:"iPad"},sl:{},browserValue:"ipad"},{browserName:"iPhone",bs:{browserName:"iPhone"},sl:{},browserValue:"iphone"}];Ni=(s,e)=>{if(s.length===0)return 0;if(typeof e!="number")throw new TypeError("p must be a number");if(s=[...s].sort((r,n)=>r-n),e<=0)return s[0];if(e>=100)return s.at(-1);let t=Math.ceil(s.length*(e/100))-1;return s[t]};Sm=new vm.DOMParser});var Kc={};z(Kc,{$schema:()=>Mw,default:()=>$w,definitions:()=>Uw,properties:()=>jw,required:()=>Bw,type:()=>Fw});var Mw,Uw,Fw,Bw,jw,$w,Em=v(()=>{Mw="http://json-schema.org/draft-07/schema#",Uw={request:{type:"object",required:["url"],additionalProperties:!1,properties:{url:{type:"string"},method:{type:"string",pattern:"^GET$|^HEAD$|^POST$|^PUT$|^DELETE$|^CONNECT$|^OPTIONS$|^TRACE$|^PATCH$"}}},header:{type:"object",required:["name","value"],additionalProperties:!1,properties:{name:{type:"string"},value:{type:"string"}}},cookie:{type:"object",required:["name","value"],additionalProperties:!1,properties:{name:{type:"string"},value:{type:"string"},path:{type:"string"},domain:{type:"string"},expires:{type:"string",format:"date-time"},httpOnly:{type:"boolean"},secure:{type:"boolean"}}},response:{type:"object",required:["status"],additionalProperties:!1,properties:{status:{type:"integer",minimum:100,exclusiveMaximum:600},headers:{type:"array",items:{$ref:"#/definitions/header"}},cookies:{type:"array",items:{$ref:"#/definitions/cookie"}},content:{type:"object",required:["text"],additionalProperties:!1,properties:{text:{type:"string"}}}}},redirectResponse:{type:"object",required:["redirectUrl"],additionalProperties:!1,properties:{redirectUrl:{type:"string"}}},passthroughResponse:{type:"object",required:["passthrough"],additionalProperties:!1,properties:{passthrough:{type:"boolean",enum:[!0]}}},entry:{type:"object",required:["request","response"],additionalProperties:!1,properties:{request:{$ref:"#/definitions/request"},response:{oneOf:[{$ref:"#/definitions/response"},{$ref:"#/definitions/redirectResponse"},{$ref:"#/definitions/passthroughResponse"}]},maxHits:{type:"integer",minimum:1}}}},Fw="object",Bw=["entries"],jw={version:{type:"string",enum:["1.2","1.2.0"]},creator:{type:"string"},entries:{type:"array",items:{$ref:"#/definitions/entry"}}},$w={$schema:Mw,definitions:Uw,type:Fw,required:Bw,properties:jw}});async function km(){try{return await pe(Mi.promises.readFile(ji()).then(async s=>{let e=await Pm;return Gw(e,s)}),3e4)}catch{return{}}}function Gw(s,e){let t=e.slice(0,16),r=e.slice(16),n=Buffer.from(s),i=rs.createDecipheriv("aes-256-cbc",Buffer.concat([n,Buffer.alloc(32)],32),t),o=i.update(r);return JSON.parse(Buffer.concat([o,i.final()]))}function Pt(s,e,t=Ww,r=void 0){return async()=>{if(!xm)return await s();let n=e;r&&(e+=JSON.stringify(r));let i=await Yc(e);if(i)return on.debug("cache hit:",{fnName:e}),i;if(on.debug("cache miss:",{fnName:e}),!Am)throw new Error(`Attempted to rebuild cache for ${n}. cache miss is not allowed with current run configuration`);let o=await s();return o&&await Hw(e,o,t),o}}async function Yc(s){let t=(await $i)[s];if(!t)return;let{value:r,expiry:n}=t;if(!(n<Date.now())&&r)return r}async function Hw(s,e,t){if(Jc)throw on.error("calling set after waitForSave is not allowed",{key:s,ttl:t}),new Error("calling set after waitForSave is not allowed");try{let r=await $i;r[s]={value:e,expiry:Date.now()+t},Cm=new Promise(n=>{Bi=n}),Vw(r)}catch{on.error("failed updating cache")}}async function ss(){let s=await $i;Object.keys(s).forEach(e=>{delete s[e]})}function Om(s){xm=s}function qw(s=!0){Am=s}async function _m(){try{return Jc=!0,await Cm}finally{Jc=!1}}function Lm(s){Fi=s,$i=km()}var Mi,Ui,rs,Im,on,Fi,Rm,Bi,xm,Am,Jc,Cm,Pm,Ww,ji,$i,Vw,Dm,Nm,xx,Mm,Xt=v(()=>{"use strict";Mi=I(require("fs")),Ui=I(require("path")),rs=I(require("crypto"));B();Im=require("lodash");$();on=C("local cache"),Fi=Ui.resolve(ht(),"testim-cache"),xm=!0,Am=!0,Jc=!1,Cm=new Promise(s=>{Bi=s}),Pm=new Promise(s=>{Rm=s}),Ww=1e3*60*60*3,ji=()=>Ui.resolve(Ui.resolve(Fi,"testim.cache"));$i=km(),Vw=(0,Im.debounce)(async s=>{let e;try{let t=await Pm,r=rs.randomBytes(16),n=JSON.stringify(s),i=Buffer.from(t),o=rs.createCipheriv("aes-256-cbc",Buffer.concat([i,Buffer.alloc(32)],32),r),a=Buffer.concat([r,o.update(n),o.final()]);await ye(Fi)||await Mi.promises.mkdir(Fi,{recursive:!0}),await Mi.promises.writeFile(ji(),a)}catch(t){on.error("failed saving cache",{err:t}),e=t}Bi(e?{success:!1,error:e}:{success:!0})},200);Dm=Rm,Nm=Om.bind(void 0,!1),xx=Om.bind(void 0,!0),Mm=()=>qw(!1)});function Wi(){return{cliLocation:ht(),userInfo:ns.userInfo(),platform:ns.platform(),release:ns.release()}}var ns,Xc=v(()=>{"use strict";ns=I(require("node:os"));B()});function zw(s){try{return Vi.resolve(Vi.dirname(require.resolve(`${s}/package.json`)),require(`${s}/package.json`).main||"")}catch(e){if(e.code==="ERR_PACKAGE_PATH_NOT_EXPORTED")return require.resolve(s);throw e}}function Qt(s){let e=zw(s);return require(e)}var Vi,an=v(()=>{"use strict";Vi=I(require("path"))});function Kw(s){let t=/EACCES[^']+'(.+)'/.exec(s);return t===null?!1:t[1]}function Jw(s){return/The "to" argument must be of type string./.exec(s)}function jm(s,e,t){let r=Kw(s),n=Jw(s);return r||n?(Bm.info("Failed to install package due to insufficient write access",{...Wi(),package:t,path:r}),console.error(`

Testim failed installing the package ${t||""} due to insufficient permissions.
This is probably due to an installation of @testim/testim-cli with sudo, and running it without sudo.
Testim had missing write access to ${r||e}

`),!0):!1}function el(s){try{return Qt(s)}catch{return!1}}function $m(s,e){return require(wr.join(s,`./node_modules/${e}/package.json`)).version}function Wm(s){if(typeof s=="string"&&s.endsWith(".cjs"))return s;if(typeof s=="object"&&s!==null)for(let e of Object.keys(s).filter(t=>t!=="browser")){let t=Wm(s[e]);if(t)return t}}function Vm(s){let e=require(wr.join(s,"package.json"));if(!("exports"in e))return"";let t=Wm(e);if(!t)throw new xi(e.name);return t}async function Hi(s,e,t){let r=wr.join(s,"npm-shrinkwrap.json"),n=wr.join(s,"npm-shrinkwrap-dummy.json"),i=!1;try{try{await ye(r)&&(await Zc.promises.rename(r,n),i=!0)}catch{}return await Fm(`npm i ${e} --no-save --no-prune --prefer-offline --no-audit --progress=false`,{...t,cwd:s}).catch(o=>{throw jm(o.stderr,s,e)?new Kr(`${s} Failed to install package: ${e} due to insufficient write access in directory`):o})}finally{if(i)try{await Zc.promises.rename(n,r)}catch{}}}function tl(s,e,t,r,n=!0){return new Promise((i,o)=>{let a=t?["--proxy",t]:[],c=t?{env:Object.assign(process.env,{HTTP_PROXY:t,HTTPS_PROXY:t})}:{},l="",d="",m=["--no-save","--no-package-lock","--no-prune","--no-audit","--progress=false"];n&&m.push("--prefer-offline");let u=(0,Gi.spawn)("node",[Qc,"i","--prefix",s,...m,...e,...a],c);u.stderr.pipe(process.stderr),u.stdout.pipe(process.stdout),u.stdout.on("data",f=>{l+=f}),u.stderr.on("data",f=>{d+=f}),u.on("close",f=>{var h,g;if(f){n&&tl(s,e,t,r,!1).then(i).catch(o);let y;try{let T=(h=/npm ERR! 404 {2}'(.+)' is not in the npm registry/gm.exec(d))==null?void 0:h[1],w=(g=/No matching version found for (\S+)@/gm.exec(d))==null?void 0:g[1];T||w?y=`404 Not Found - GET https://registry.npmjs.org/${w??T} - Not found`:jm(d,Qc)?y=`insufficient write access in location ${Qc}`:y=`Npm Installation closed with exit code ${f} with error: ${d}`}catch{y=`Npm Install closed with exit code ${f}
 stdout: ${l} stderr: ${d}`}Bm.info(`Npm Install closed with exit code ${f}`,{message:y,stderr:d}),o(new At(y))}else i(l)}),setTimeout(()=>{try{u.kill()}finally{o(new ce)}},r)})}async function Gm(){try{return(await Fm("npm -v")).stdout.trim()}catch{return""}}var Zc,wr,Um,Gi,Fm,Bm,Qc,is=v(()=>{"use strict";Zc=I(require("fs")),wr=I(require("path"));B();Um=require("util"),Gi=require("child_process");$();Xc();an();X();Fm=(0,Um.promisify)(Gi.exec),Bm=C("cli-service");Qc=wr.resolve(require.resolve("npm").replace("index.js",""),"bin","npm-cli.js")});var F,qm,zm,Km,Yw,Xw,Qw,Hm,qi,sl,O,de=v(()=>{"use strict";F=I(require("rox-node")),qm=I(require("node-fetch")),zm=require("eventsource");$();B();ae();Km=C("FeatureFlagsService"),Yw=!We&&!0&&!_d,Xw=2e4,Qw=60*60*24,Hm=["labs","disabled","enabled"],qi=class extends F.default.RoxString{constructor(e="disabled"){super(e,Hm)}getValue(){let e=super.getValue();return Hm.includes(e)?e:(Km.warn('unexpected value for lab feature flag. Falling back to value "labs"',{featureFlagName:this.name,value:e}),"labs")}},sl=class{constructor(){this.flags={useNewWSCLI:new F.default.Flag,useSafariWebdriverVisibilityChecks:new F.default.Flag,useClickimVisibilityChecks:new F.default.Flag,runGetElementCodeInAut:new F.default.Flag,enableFrameSwitchOptimization:new F.default.Flag,maximumJsResultSize:new F.default.RoxNumber(2e3*1024),skipFileInputClicks:new F.default.Flag,errorMessageOnBadNetwork:new F.default.Flag(!0),warnOnBadNetwork:new F.default.Flag(!1),overrideAzureStorageUrl:new F.default.Flag,autoSaveDownloadFileFireFox:new F.default.Flag(!0),safariSelectOptionDispatchEventOnSelectElement:new F.default.Flag(!0),experimentalPreCodeCompilation:new F.default.Flag(!0),experimentalAsyncCustomCode:new F.default.Flag,useSameBrowserForMultiTests:new qi("labs"),highSpeedMode:new qi,usePortedHtml5DragDrop:new F.default.Flag,testNamesToBeforeSuiteHook:new F.default.Flag,addCustomCapabilities:new F.default.RoxString("{}"),addCustomLTtunnelNTLMOptions:new F.default.RoxString("{}"),LTNetworkCapabilities:new F.default.Flag,downloadToBase64:new F.default.Flag,publicGridURL:new F.default.RoxString("public-grid.testim.io"),allowAppFromDeviceRuns:new F.default.Flag(!0),unsupportedCapsFields:new F.default.RoxString("[]"),dontFocusOnInit:new F.default.Flag,retryOnSeleniumHubError:new F.default.Flag,enableLambdaTestTunnelNTLM:new F.default.Flag,enableLambdaTestTunnelSkipUpgrade:new F.default.Flag,tdcHsPreventNetworkCapture:new F.default.Flag,headSpinTdcEnableFlagCapability:new F.default.Flag,enableBatchTDC:new F.default.Flag,enableBatchHeadSpin:new F.default.Flag,clearRunnerFileCache:new F.default.Flag,forceTurboModeIfNeeded:new F.default.Flag,redisSlotManager:new F.default.Flag,tunnelBinaryNewVersion:new F.default.Flag(!1),encryptedCredentials:new F.default.Flag,computePackagePathFromPackageJsonExports:new F.default.Flag,sendExtensionOnEdgeNonLinux:new F.default.Flag,enableAppium2pCloudy:new F.default.Flag,reuseCliPkgInstallFolder:new F.default.Flag,getPublicIpFrom3rdPartyServices:new F.default.Flag,chromedriverCdnBinariesUrl:new F.default.RoxString(""),sfdcHybridCompany:new F.default.Flag,allowFixingAppIdStructure:new F.default.Flag,enableAppium2BrowserStack:new F.default.Flag,increaseTDCRequestTimeout:new F.default.Flag,accessTokenExpiryMargin:new F.default.RoxNumber(300*1e3),useMV3Extension:new F.default.Flag,testimHeadlessExtensionDownloadUrl:new F.default.RoxString("",[]),applyMobileRestrictionFromDate:new F.default.RoxNumber(17235072e5),removeMobileTrialRestrictions:new F.default.Flag,appiumConnectionRetryCount:new F.default.RoxNumber(0),appiumConnectionRequestTimeout:new F.default.RoxNumber(12e4),DFBrowserVersion:new F.default.RoxString("latest",["latest","latest-1","latest-2"]),DFAcceptInsecureOrigins:new F.default.RoxString("http://jsbin.testim.io"),enableFixForCustomExtensionForLT:new F.default.Flag(!1),enableTestPlanAggregation:new F.default.Flag,secrets:new F.default.Flag,chromeArgsDisableFeatures:new F.default.RoxString("")},F.default.register("default",this.flags)}setProjectId(e){F.default.setCustomStringProperty("projectId",e)}setProjectType(e){F.default.setCustomStringProperty("projectType",e)}setCompanyProductType(e){F.default.setCustomStringProperty("productType",e)}setCompanyId(e){F.default.setCustomStringProperty("companyId",e)}setPlanType(e){F.default.setCustomStringProperty("planType",e)}setIsPOC(e){F.default.setCustomBooleanProperty("isPOC",e)}setIsStartUp(e){F.default.setCustomBooleanProperty("isStartUp",e)}setRunnerMode(e){F.default.setCustomStringProperty("runnerMode",e)}setRunnerEnvironment(e){F.default.setCustomStringProperty("runnerEnvironment",e)}async fetch({proxy:e}){let t,r,n;if(!Yw)return;if(e){t=require("https-proxy-agent").HttpsProxyAgent;let o=e?new t(e):void 0;r=(a,c)=>(0,qm.default)(a,{...c,agent:o}),n=function(a){return new zm.EventSource(a,{fetch:r})}}let i={fetchIntervalInSec:Qw,fetchFunction:r,eventSourceImpl:n};return pe(F.default.setup(kd,i),Xw).catch(o=>Km.error("failed to get feature flag status",o))}},O=new sl});var Qm={};z(Qm,{install:()=>ev,isReady:()=>rv,start:()=>tv});var Jm,Ym,Xm,il,nl,Zw,ev,tv,rv,Zm=v(()=>{"use strict";Jm=I(require("fkill")),Ym=I(require("p-retry"));is();Ge();B();an();de();Xm="chromedriver",il=9515,nl=`http://localhost:${il}/wd/hub`,Zw=[`--port=${il}`,"--url-base=/wd/hub","--disable-build-check","--whitelisted-ips=0.0.0.0","--log-level=OFF"],ev=async()=>{let s=O.flags.chromedriverCdnBinariesUrl.getValue(),e=Le(s)?`--chromedriver_cdnbinariesurl=${s}`:"";await Hi(ht(),`${Xm} --detect_chromedriver_version ${e}`)},tv=async()=>{process.env.NODE_OPTIONS="",await(0,Jm.default)(`:${il}`,{silent:!0}),await Qt(Xm).start(Zw,!0)},rv=async({chromeBinaryLocation:s})=>{await(0,Ym.default)(async()=>{var n;let e=await Te(`${nl}/status`);if(!((n=e==null?void 0:e.value)!=null&&n.ready))throw new Error("status failed");let t={...s&&{binary:s}},r=await Ve({url:`${nl}/session`,body:{desiredCapabilities:{browserName:"chrome",chromeOptions:t}},headers:{"Content-Type":"application/json"}});if(!r||r.status!==0||!r.sessionId)throw new Error("create session failed");await Ks(`${nl}/session/${r.sessionId}`)},{retries:99,factor:1,minTimeout:30})}});var ln={};z(ln,{getSessionPlayerFolder:()=>ll,prepareChromeDriver:()=>cn,prepareCustomExtension:()=>al,prepareExtension:()=>cl,preparePlayer:()=>vr});async function al(s,e=!1){if(!s)return;if(Le(s)){let n=os.join(process.cwd(),s.replace(/^.*[\\/]/,""));if(await sv(s)>ol&&!e)throw new A(ef);return await Je(s,n),n}let t=os.resolve(s);if(!rf.existsSync(t))throw new A(`Failed to find custom extension in location: ${t}`);if(Dc(t)>ol&&!e)throw new A(ef);return t}async function sv(s){let e=(Ge(),qe(Ke));try{let r=(await e.head(s)).headers["content-length"];return(r?parseInt(r,10):0)/1e6}catch(t){throw zi.warn("failed to download custom extension",{err:t}),new A(`Failed to download custom extension from location: ${s}`)}}function cl(s){zi.info("prepare extension",{locations:s});let e=s.map(t=>({location:t,path:Ci(t)}));return Pt(()=>se(e,({location:t,path:r})=>Pi(t,r)),"prepareExtension",nf,e)()}async function cn(s={},e={},t=!1){let n=require("ora")("Starting Driver").start(),i=await Promise.resolve().then(()=>(Zm(),Qm));try{await i.install(),await i.start(),t||await i.isReady(e),n.succeed("Chrome Driver initiated successfully")}catch(o){let a="Failed to initiate Chrome Driver";throw o instanceof Kr||(zi.error(a,{...s,...Wi(),error:(0,sf.serializeError)(o)}),console.log(`
1. If you don't have Chrome, please install it from https://www.google.com/chrome.
2. If Chrome is installed, please verify it's binary directory:
    - installed where chromedriver expects it (see https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver#requirements).
    - exists in your PATH environment variables.
3. Try adding --chrome-binary-location flag to Testim CLI specifying the exact location of chrome binary in your computer (e.g on Windows "C:/Program Files/Google/Chrome/Application/chrome.exe").
4. You can always use a standalone Selenium grid and providing it's details with the --host and --port flags (see https://www.npmjs.com/package/selenium-standalone)`)),n.fail(a),o}}async function nv(){let s=Rt==="staging"?`${js}/Staging-LATEST_VERSION`:`${$s}/extension/sessionPlayer_LATEST_RELEASE`;return(await Bt(s)).body.toString("utf8")}function iv(){return`${js}/dev-sessionPlayer.zip`}async function ov(s,e){if(!Le(s)||Le(s)&&e||We)return s;let t=await nv();return`${s}-${t}${Rt==="staging"?".zip":""}`}function ll(){let s=ht();return os.resolve(s,"testim-bin")}function av(){let s=ll();return os.resolve(s,"sessionPlayer.zip")}async function of(s,e,t=!1){try{return await Pi(s,e),await ot(e,ll())}catch(r){if(t)throw r;return await of(s,e,!0)}}async function vr(s,e){zi.info("prepare player",{location:s,canary:e});let t=av();return Pt(async()=>{let r=Rt==="development"?iv():await ov(s,e);return await of(r,t),{}},"preparePlayer",nf,[s,e,t])()}var tf,rf,os,sf,zi,nf,ol,ef,un=v(()=>{"use strict";tf=I(require("ms")),rf=I(require("node:fs")),os=I(require("node:path"));ae();Xt();sf=require("serialize-error");$();Xc();X();B();zi=C("prepare runner and testim start"),nf=(0,tf.default)("0.5 day"),ol=16,ef=`The size of the custom extension is more than ${ol}MB`});function cv(){let s=pn.type().toLowerCase();return s==="darwin"?pn.arch()==="arm"?"mac_arm":"mac":s==="windows_nt"?pn.arch()==="x64"?"win64":"win32":"linux"}async function Ji(){let s=cv(),e="https://storage.googleapis.com/chromium-browser-snapshots",t={linux:"Linux_x64",mac:"Mac",mac_arm:"Mac_Arm",win32:"Win",win64:"Win_x64"};if(!(s in t))throw new A(`Unsupported platform: ${s}`);let r=parseInt(dn,10)>591479?"chrome-win":"chrome-win32",n={linux:"chrome-linux",mac:"chrome-mac",mac_arm:"chrome-mac",win32:r,win64:r},i={linux:"chrome",mac:"Chromium.app/Contents/MacOS/Chromium",mac_arm:"Chromium.app/Contents/MacOS/Chromium",win32:"chrome.exe",win64:"chrome.exe"},o=`${e}/${t[s]}/${dn}/${n[s]}.zip`,a=Ki.join(ul,n[s]),c=`${a}.zip`,l=Ki.join(a,i[s]);if(await ye(l))return l;if(!await ye(c)){let m=(0,pl.default)("Downloading Chromium").start();try{await af.promises.mkdir(ul),await Je(o,c)}catch(u){let f=`Failed to download Chromium: ${u.message}`;throw m.fail(f),new Error(f)}m.succeed()}let d=(0,pl.default)("Extracting Chromium").start();try{await ot(c,ul)}catch(m){let u=`Failed to extract Chromium: ${m.message}`;throw d.fail(u),new Error(u)}return d.succeed(),l}var af,pn,Ki,pl,dn,ul,dl=v(()=>{"use strict";af=I(require("fs")),pn=I(require("os")),Ki=I(require("path")),pl=I(require("ora"));X();B();dn="1000968",ul=Ki.join($t,`chrome-${dn}`)});async function uf(s,e){return Sr=s,hl=e,await ml()}function pf(s,e){Sr=e.projectId,hl=e.token,mn=e.userAccessKey,at=s.token,gn=yl(at),hn=s.refreshToken,fl=s.ngrokToken,gl=s.isNgrokWhitelisted,cf=e.publicIp,lf=e.initializedFromCache}function uv(s=Sr,e=hl){return Pt(()=>(fn.info("request to get cli token from server"),Ve({url:`${he()}/auth/token`,body:{projectId:s,token:e}})),"getTokenV3",lv*10,{projectId:s,token:e})()}async function pv(){fn.info("request to refresh JWT cli token from server");let s=await Ve({url:`${he()}/auth/refreshToken`,body:{token:at,refreshToken:hn}});return at=s.token,gn=yl(at),s.refreshToken&&(hn=s.refreshToken),at}async function ml(){try{let s=await uv();return fn.info("successfully get cli token from server"),at=s.token,gn=yl(at),hn=s.refreshToken,fl=s.ngrokToken,gl=s.isNgrokWhitelisted,at}catch(s){throw s.message.includes("Unauthorized")?new A("Error trying to retrieve CLI token. Your CLI token and project might not match. Please make sure to pass `--project` and `--token` that match to each other or make sure they match in your ~/.testim file."):(fn.error(`While trying to retrieve CLI token. caught error: ${s}`,{projectId:Sr}),new A(`While trying to retrieve CLI token, caught error: ${s}`))}}function yl(s){return require("jsonwebtoken").decode(s).exp*1e3}async function kt(){if(!gn)return ml();let s=O.flags.accessTokenExpiryMargin.getValue();if(gn<Date.now()+4*s)try{return await pv()}catch(e){return fn.error("failed to refresh token, executing fallback",e),ml()}return at}function Yi(){return hn}function Er(){return at?{uid:require("jsonwebtoken").decode(at).id,ngrokToken:fl,isNgrokWhitelisted:gl}:{}}async function Xi(){if(!mn||!Sr)return;if(await bl({userAccessKey:mn,projectId:Sr}))return mn;let e=`user access key "${mn}" is invalid for project "${Sr}"`;throw new A(e)}function Qi(){return cf}function Zi(){return lf}var fn,at,gn,hn,fl,gl,Sr,hl,mn,cf,lf,lv,ct=v(()=>{"use strict";ae();Ge();Xt();X();$();ge();de();fn=C("testim-custom-token"),Sr=null,hl=null,lv=5*60*1e3});function dv(s){if(s.protocol)return s.protocol;if([_.TESTIM_PRIVATE,_.TESTIM,_.BROWSERSTACK,_.SAUCELABS].includes(s.type)&&s.port===443)return"https";if([_.TESTIM_ENTERPRISE,_.TESTIM_LAMBDATEST,_.DEVICE_FARM].includes(s.type)){let e=df.exec(s.host);return(e==null?void 0:e[2])||"https"}return""}function mv(s){let e=df.exec(s);return e==null?void 0:e[3]}function to(s){var S,E,k,D,G,x,R,L,M,V,W;let e=s&&mv(s.host),t=s.port,r=s.path,n=s&&dv(s),i=s.token,o=s.slotId,a=(S=s.hybrid)==null?void 0:S.tunnel,c=(E=s.external)==null?void 0:E.user,l=(k=s.external)==null?void 0:k.key,d=s.type,m=d===_.HYBRID?a&&((x=(G=(D=s.hybrid)==null?void 0:D.external)==null?void 0:G[s.hybrid.tunnel])==null?void 0:x.user):c,u=d===_.HYBRID?a&&((M=(L=(R=s.hybrid)==null?void 0:R.external)==null?void 0:L[s.hybrid.tunnel])==null?void 0:M.key):l,f=s.name,h=s&&(s._id||s.gridId),g=s.provider,y=(V=s.mobileTokens)==null?void 0:V.androidToken,T=(W=s.mobileTokens)==null?void 0:W.iosToken,w=s.apiUrl,b=s.isSupportGrid;return{host:e,port:t,path:r,protocol:n,accessToken:i,slotId:o,gridId:h,tunnel:a,user:c,key:l,type:d,name:f,provider:g,tunnelUser:m,tunnelKey:u,androidToken:y,iosToken:T,apiUrl:w,isSupportGrid:b}}async function gv(s,e,t,r,n,i){var a;let o;try{o=await i()}catch(c){throw Qe.error("failed to get grid",{projectId:s,companyId:e,err:c}),new Error(yt.UNKNOWN)}if(Qe.info("get grid info",{...o,projectId:s,companyId:e}),!o||!["success","error"].includes(o.status))throw Qe.error("invalid response - get grid",{res:o}),new Error(yt.UNKNOWN);if(o.status==="success"){if(o.grid.mode==="local")return{mode:"local"};((a=o.grid)==null?void 0:a.mode)==="custom"&&Object.assign(o.grid,hf(n));let c=to(o.grid);return fv(t,e,c.gridId,c.slotId,r,c.isSupportGrid),c}throw o.code==="not-found"?new st(yt.NOT_FOUND):o.code==="no-available-slot"?new Kt(`Failed to run test on ${r} - concurrency limit reached`):(Qe.error("invalid code error response - get grid",{res:o}),new st(yt.UNKNOWN))}function ff(s){return Il(s)}async function gf(s,e,t){let n=(t||await ff(s)).find(i=>i._id===e);if(!n)throw new A(`Failed to find grid id: ${e}`);return to(n)}async function hv(s,e,t){let n=(t||await ff(s)).find(i=>(i.name||"").toLowerCase()===e.toLowerCase());if(!n)throw new A(`Failed to find grid name: ${e}`);return to(n)}async function Tl(s,e){let t=yn[s];if(!t)return;let{slotId:r,gridId:n,browser:i,companyId:o,isSupportGrid:a}=t;if(delete yn[s],!a){if(!r){Qe.warn("failed to find grid slot id",{projectId:e});return}Qe.info("release slot id",{projectId:e,companyId:o,slotId:r,gridId:n,browser:i});try{await vl(o,e,r,n,i)}catch(c){Qe.error("failed to release slot",{projectId:e,err:c})}}}async function yv(s){let e=Object.values(yn).filter(Boolean);if(e.length!==0&&!e[0].isSupportGrid){Qe.info("keep alive worker slots",{projectId:s,slots:e});try{await wl(s,e)}catch(t){Qe.error("failed to update grid keep alive",{err:t,slots:e,projectId:s})}}}function bv(s){mf=global.setInterval(yv,1e4,s)}async function Tv(s){let e=Object.keys(yn);if(e.length){Qe.warn("not all slots released before end runner flow",{projectId:s});try{await se(e,t=>Tl(Number(t),s))}catch(t){Qe.error("failed to release all slots",{err:t,projectId:s})}}}async function wv(s){await Tv(s),clearInterval(mf)}function vv(s,e){let{testobjectSauce:t,saucelabs:r}=e;if(s==="testobject")return t.testobjectApiKey;if(s==="saucelabs")return r.accessKey}function Sv(s,e){let{saucelabs:t}=e;if(s==="saucelabs")return t.username}function hf(s){let t=(()=>eo.isEmpty(s.testobjectSauce)?eo.isEmpty(s.saucelabs)?eo.isEmpty(s.perfecto)?"hostAndPort":"perfecto":"saucelabs":"testobject")(),{host:r,port:n,path:i,protocol:o}=s,a=vv(t,s),c=Sv(t,s);return{host:r,port:n,path:i,protocol:o,type:t,user:c,key:a,gridId:re()}}async function yf(s,e){let t=s.company.companyId;return await gf(t,e.gridId,s.allGrids)}async function bf(s){let{allGrids:e,company:t,host:r,useLocalChromeDriver:n,localTmaUrl:i,useChromeLauncher:o,gridId:a,grid:c}=s;if(n||o||i)return{mode:"local"};if(r)return hf(s);let l=t==null?void 0:t.companyId;if(a)return gf(l,a,e);if(c)return hv(l,c,e);if(en(s)||s.tunnelOnlyMode){Qe.info("skipping getting grid, as it is set on test plan",{companyId:l});return}throw new st("Missing host or grid configuration")}async function Tf(s,e,t,r,n){let{host:i,project:o,grid:a,gridId:c,localTmaUrl:l,useLocalChromeDriver:d,useChromeLauncher:m,company:u}=t,f=Boolean(d||m||l),h=u==null?void 0:u.companyId;return gv(o,h,r,s,t,()=>El({projectId:o,companyId:h,browser:s,executionId:e,isRunningLocalMode:f,gridId:c,gridName:a,host:i,testResultId:n}))}var eo,Qe,yn,df,mf,fv,bn,wf,as=v(()=>{"use strict";eo=I(require("lodash"));ge();$();B();oe();X();Qe=C("grid-service"),yn={},df=/(^(https?):\/{2})?(.*)/,mf=null;fv=(s,e,t,r,n,i)=>{yn[s]={gridId:t,companyId:e,slotId:r,browser:n,isSupportGrid:i}};bn={start:bv,end:wv};wf=async(s={},e={},t={},r={},n={})=>{var h,g,y;let{company:{companyId:i}={}}=s,{gridId:o,type:a}=e,c=s.browser||t.browserValue,l=Boolean(s.tunnel),{maxRetries:d,currentRetry:m}=n;if(!o||!a||((a===_.TESTIM_LAMBDATEST||a===_.LAMBDATEST)&&await((h=r.enableIfNeeded)==null?void 0:h.call(r,e,i)),a!==_.HYBRID||!i||!c||!d||!m))return e;let u=await Sl({companyId:i,gridId:o,maxRetries:d,currentRetry:m,browser:c,usingTunnel:l});Qe.info("handling hybrid grid",{response:u,companyId:i});let f=to({...e,...u.connectionDetails,provider:u.provider});return u.provider!=="lambdatest"&&((g=r.disable)==null||g.call(r)),u.provider==="lambdatest"&&await((y=r.enableIfNeeded)==null?void 0:y.call(r,f,i)),f}});function wn(){return ro||"master"}function vf(s="master",e="false"){if(typeof s!="string"&&(s!=null&&s.branch)&&s.branch==="master"){ro="master";return}if(s!=null&&s.isArchived)throw new A(`Branch ${s.branch} is archived, run aborted.`);if(s){ro=s.branch||s;return}ro=e?"master":void 0}var ro,Rl=v(()=>{"use strict";X()});function xf(s){We||(s!=null&&s.userId||(s={anonymousId:Rf}),If.identify(s))}function bt(s,e){return Ir("ci",s,e)}function Ir(s,e,t){if(We)return;let r=s?{userId:s}:{anonymousId:Rf};If.track(Object.assign(r,{event:e,properties:t}))}var Ef,If,Rf,Rr=v(()=>{"use strict";ae();Ef=require("@segment/analytics-node"),If=new Ef.Analytics({writeKey:"sJOSIGKa5x5rJEGsaOlCjrgozAf7FnVY",flushAt:1}),Rf=require("crypto").randomBytes(20).toString("hex")});var Af={};z(Af,{isCi:()=>ls});var ls,so=v(()=>{"use strict";ls=Boolean(process.env.CI||process.env.CONTINUOUS_INTEGRATION||process.env.BUILD_NUMBER||process.env.RUN_ID||!1)});function Pf(s,e){return e!=null&&e.type&&(s[`${e.type}Mode`]=!0),s}function kf({executionId:s,projectId:e,testId:t,resultId:r,ucid:n,companyId:i,companyName:o,projectName:a,companyPlan:c,source:l,user:d,lightweightMode:m,isStartUp:u,projectType:f,appSource:h,gridType:g}){let y=Pf({executionId:s,projectId:e,testId:t,resultId:r,ucid:n,companyId:i,companyName:o,projectName:a,companyPlan:c,source:Cf(l,d),isStartUp:u,projectType:f,gridType:g,...["android","ios"].includes(f)&&h&&{appSource:h}},m);bt("test-run-ci",y)}function Of({executionId:s,projectId:e,testId:t,resultId:r,result:n,ucid:i,companyId:o,companyName:a,projectName:c,companyPlan:l,source:d,user:m,lightweightMode:u,logger:f,isStartUp:h,projectType:g,appSource:y,gridType:T}){try{let w=Pf({executionId:s,projectId:e,testId:t,resultId:r,ucid:i,companyId:o,companyName:a,projectName:c,companyPlan:l,mockNetworkEnabled:n.wasMockNetworkActivated,source:Cf(d,m),isStartUp:h,projectType:g,gridType:T,...["android","ios"].includes(g)&&y&&{appSource:y}},u);if(n.success){bt("test-run-ci-success",w);return}bt("test-run-ci-fail",{...w,failureReason:n.failureReason})}catch(w){f.error("failed to update test end analytics",{err:w})}}function _f(s){bt("batch-run-ci",s)}var Cf,xl=v(()=>{"use strict";Rr();so();Cf=(s,e)=>s!=="cli"&&s!=="cli-local"?s:ls&&e?"ci-with-user":ls?"ci":e?"cli-with-user":s});var vn,Al,Ev,Cl,Iv,no,io,oo,ao,co,lo=v(()=>{"use strict";B();oe();vn=s=>{let{status:e,mobile:t}=s;return t!=null&&t.isAppFromDevice||t!=null&&t.isAppForIosVirtualDevice?!1:e===fe.FAILED},Al=s=>{let{status:e}=s;return e===fe.ABORTED},Ev=s=>{let{status:e}=s;return e===fe.PASSED},Cl=s=>s.runnerStatus===Mc.SKIPPED,Iv=s=>s.testStatus===Ye.EVALUATING,no=(s,e)=>Object.values(s).filter(t=>{var r,n;return Cl(t)&&(Xe(t,e)||((r=t.mobile)==null?void 0:r.isAppFromDevice)||((n=t.mobile)==null?void 0:n.isAppForIosVirtualDevice))}).length,io=s=>Object.values(s).filter(e=>vn(e)&&Iv(e)).length,oo=s=>Object.values(s).filter(vn),ao=s=>Object.values(s).filter(Ev),co=s=>Object.values(s).filter(Al)});function xv(s){let e=s.indexOf("--token");if(e!==-1)try{let t=s.slice();return t.splice(e,2),t}catch{}return s}var Pl,uo,Rv,po,Df=v(()=>{"use strict";Pl=I(require("lodash"));$();lo();uo=C("debug-reporter"),Rv=["allGrids","authData","gridData","perfecto","projectData","runParams","testobjectSauce","token","userData","userParamsData","awsAccessKeyId","awsSecretAccessKey"],po=class{constructor(e){this.options=e}onTestStarted(e,t){uo.info("Test Started",{testId:e.testId,testName:e.name,resultId:e.resultId,workerId:t})}onTestFinished(e,t){let r=this.options.gridData||{},n=r.provider,i=r.host,o=r.gridId,a=r.type,c=r.failedGetBrowserAttempts;uo.info("Test Finished",{testId:e.testId,testName:e.name,resultId:e.resultId,success:e.success,duration:e.duration,browser:this.options.browser,companyId:this.options.company.companyId,grid:{provider:n,host:i,failedGetBrowserAttempts:c,id:o,type:a},workerId:t})}get sanitizedOptionsForLogging(){return{...Pl.default.omit(this.options,Rv),company:Pl.default.pick(this.options.company,["companyId","name","planType"]),activePlan:this.options.company.activePlan}}onTestPlanStarted(e,t,r,n,i,o,a){let c=xv(process.argv);uo.info("Test Plan Started",{executionId:i,testPlanName:n,isAnonymous:o,configName:a,options:this.sanitizedOptionsForLogging,args:c})}onTestPlanFinished(e,t,r,n,i){let o=ao(e).length,a=Object.keys(e).length-o;uo.info("Test Plan Finished",{executionId:n,testPlanName:t,isAnonymous:i,passed:o,failed:a,options:this.sanitizedOptionsForLogging,duration:r})}}});var kl,Ot,Sn=v(()=>{"use strict";oe();kl=class{constructor(){this._planType="free"}setPlanType(e){this._planType=e}get isTestStatusEnabled(){return["pro","trial"].includes(this._planType)}shouldShowFreeGridRunWarning(e){return this._planType!=="pro"&&e===_.DEVICE_FARM}},Ot=new kl});var _l={};z(_l,{Reporter:()=>Av});var er,En,xr,mo,Nf,Ol,Av,Ll=v(()=>{"use strict";er=I(require("chalk")),En=I(require("lodash"));B();oe();Sn();lo();xr={success:er.default.green,warn:er.default.yellow,error:er.default.red},{CLI_MODE:mo}=jt,Nf="device",Ol=class{constructor(e,t){this.options=e;this.branchToUse=t;this.config={showWorkerNames:e.parallel>1}}toWorkerIdPrefix(e){return this.config.showWorkerNames?`W:${e}`:""}printWorkerDivider(){console.log("-".repeat(process.stdout.columns||83))}onTestStarted(e,t){let r=`(${e.testId})`,n=`url: ${er.default.underline(ze(this.options.editorUrl,this.options.project,e.testId,e.resultId,this.branchToUse))}`;console.log(this.toWorkerIdPrefix(t),`Test "${e.name}" started ${r} ${n}`.trim())}onTestFinished(e,t){let r=e.success?fe.PASSED:fe.FAILED,n=`(${e.testId})`,i=xr[e.success?"success":"error"];console.log(i(this.toWorkerIdPrefix(t),`Test "${e.name}" finished status: ${r} ${n} duration: ${_i(e.duration)}`))}printAllFailedTests(e){if(!e.length)return;let t=e.map(r=>{let n=ze(this.options.editorUrl,this.options.project,r.testId,r.resultId,this.branchToUse);return`${r.name} : ${n}`});console.log(xr.error("Failed runs are:")),console.log(xr.error(t.join(`
\r`)))}onTestPlanFinished(e,t,r,n,i){let o=oo(e),a=ao(e),c=co(e),l=a.length,d=c.length,m=o.length,u="",f="";if(Ot.isTestStatusEnabled){let w=io(e);u=` FAILED-EVALUATING: ${w}`,m-=w,f=` SKIPPED: ${no(e,this.options)}`}let h=this.buildTestPlanName(i,t),g,y=xr[m?"error":"success"],T=`PASSED: ${l} FAILED: ${m}${u} ABORTED: ${d}${f} Duration: ${_i(r)}`;h.trim()===""||h.trim()==="Anonymous"?g=`Tests completed. ${T} (Execution ID: ${n})`:g=`Test plan${h} completed ${T} (${n})`,this.printWorkerDivider(),console.log(y(g)),this.printWorkerDivider(),this.printAllFailedTests(o)}buildTestPlanName(e,t){let r=En.isEmpty(this.options.suites)?"":`Suite: ${this.options.suites}`,n=En.isEmpty(this.options.label)?"":`Label: ${this.options.label}`,i=En.isEmpty(this.options.name)?"":`Name: ${this.options.name}`,o=En.isEmpty(this.options.testId)?"":`Test Id: ${this.options.testId}`,a=[i,n,r,o].filter(Boolean).join(", ");return e?` anonymous (${a})`:` '${t}'`}onTestPlanStarted(e,t,r,n,i,o,a){let c=u=>{u.forEach((f,h)=>{var w;let g=(w=f.testData)!=null&&w.index?`- ${f.testData.index} / ${f.testData.total} Data set`:"",y=`(${f.testId})`,T="";f.testOptimization?T=` [${f.testOptimization.reason}]`:Xe(f,this.options)&&(T="-quarantine"),console.log("	",h+1,":",`${f.name}${T}`,y,g)})},l=a?`config '${a}'`:"default configs",d=this.options.sfdcCredential?` SfdcCredential: ${this.options.sfdcCredential}`:"",m=`${l}, Project: ${this.options.project}, Branch: ${this.branchToUse}${d}`;console.log(`Run${this.buildTestPlanName(o,n)} test plan with ${m} (${i})`),this.printWorkerDivider(),e.length>0&&(console.log("Before all:"),c(e)),console.log("Test list:"),c(t),r.length>0&&(console.log("After all:"),c(r)),this.printWorkerDivider()}onGetSlot(e,t){let r=this.options.grid||this.options.gridId,n=this.options.mode===mo.APPIUM?Nf:t;r&&console.log(this.toWorkerIdPrefix(e),`Get ${er.default.underline(n)} slot from ${er.default.underline(r)}`)}onGetSession(e,t,r){let n=r===mo.APPIUM?Nf:"browser";console.log(this.toWorkerIdPrefix(e),`Get ${n} to run ${er.default.underline(t)}`)}onWaitToTestStart(e){console.log(this.toWorkerIdPrefix(e),"Wait for test start")}onWaitToTestComplete(e){console.log(this.toWorkerIdPrefix(e),"Wait for test complete")}onGetBrowserFailure(e,t,r){if(r!==2)return;let n=this.options.grid||this.options.gridId,i=this.options.mode===mo.APPIUM?"device":"browser";if(n)console.log(xr.warn(this.toWorkerIdPrefix(e),`It is taking us some time to get a ${i} from the grid ${n}`));else if(this.options.useLocalChromeDriver)console.log(xr.warn(this.toWorkerIdPrefix(e),"We are having issues starting ChromeDriver for you locally"));else if(this.options.host){let o=this.options.mode===mo.APPIUM?"Appium":"Selenium";console.log(xr.warn(this.toWorkerIdPrefix(e),`We are having issues reaching your ${o} grid at ${this.options.host}:${this.options.port||4444}`))}}},Av=Ol});var Ml={};z(Ml,{Reporter:()=>Lv});function Cv(s){let e=s.testData||{},t=typeof e.total=="number"&&e.total!==1?` - ${e.index} / ${e.total} Data set`:"";return`${s.name}${t}`}function Pv(s){return s.visitedUrlsList||console.log("No URLs found:","Please contact our support team or remove the --urls flag from the CLI command"),`${s.visitedUrlsList||""}`}function kv(s){return`${s.visitedUrlsJson||""}`}async function Ov(s,e,t,r,n,i){function o(u){let f=ze(s,t,u.testId,u.resultId,r),h={$:{name:Cv(u),classname:n,time:Gc(u.duration),ownedBy:u.testOwnerName,ownerEmail:u.testOwnerEmail},"system-out":f};if(vn(u)||Al(u)){let g=`Step Failed: ${u.failureReason||u.reason}`,y=vn(u)?`${g} More info at: ${f}`:g;h.failure={$:{message:y}}}return Cl(u)&&Xe(u,i)&&Ot.isTestStatusEnabled&&(h.skipped={}),i.urls&&(h["visited-urls-list"]=Pv(u),h["visited-urls-json"]=kv(u)),h}function a(u){let{results:f,testPlanName:h,configName:g}=u,y=f||{},w={name:(g&&h?`${h} with config '${g}'`:h)||"selenium run",tests:l(y),failures:d(y),timestamp:c(e)};if(Ot.isTestStatusEnabled){w.skipped=no(y,i);let b=io(y);w.failures-=b,w["failure-evaluating"]=b}return{$:w,testcase:Object.keys(y).map(b=>o(y[b]))}}function c(u){let f=Object.keys(u).map(g=>u[g].startTime),h=Math.min.apply(null,f);return h?new Date(h).toISOString():new Date().toISOString()}function l(u){return Object.keys(u).length}function d(u){return oo(u).length+co(u).length}let m={testsuites:{testsuite:e.map(u=>a(u))}};try{return new Nl.Builder().buildObject(m)}catch(u){return _v(u)}}function _v(s){let e=new Nl.Builder,t={testsuites:{testsuite:{$:{name:"selenium run",tests:1,failure:1,timestamp:Date.now()},testcase:{$:{name:"junit reporter generator failed",classname:"testim.io.jUnitXmlReporter"},error:{$:{message:s.message}}}}}};return e.buildObject(t)}var Nl,Mf,Dl,Lv,Ul=v(()=>{"use strict";Nl=I(require("xml2js"));B();Mf=require("fs");Sn();lo();Dl=class{constructor(e,t){this.options=e;this.branchToUse=t;this.classname="testim.io.test",typeof e.reportFileClassname=="string"&&(this.classname=e.reportFileClassname),e.reportFileClassname===!0&&(this.classname="")}async createResultsReport(e){let t=this.options.reportFile,r=this.options.project,n=await Ov(this.options.editorUrl,e,r,this.branchToUse,this.classname,this.options);if(t)try{return await Mf.promises.writeFile(t,n),console.log("JUnit XML file saved to",t),e}catch(i){return console.error("could not save report file",t,i),e}}async onAllTestPlansFinished(e){await this.createResultsReport(e)}};Lv=Dl});var Uf={};z(Uf,{Reporter:()=>Dv});function us(s){return s?s.replace(/\|/g,"||").replace(/'/g,"|'").replace(/\n/g,"|n").replace(/\r/g,"|r").replace(/\u0085/g,"|x").replace(/\u2028/g,"|l").replace(/\u2029/g,"|p").replace(/\[/g,"|[").replace(/\]/g,"|]"):""}var Fl,Bl,Dv,Ff=v(()=>{"use strict";$();Fl=C("team-city-reporter");Bl=class{constructor(e){this.options=e}getPrintName(e){let t=e.config||{},r=typeof t.testDataTotal=="number"?` - ${t.testDataIndex} / ${t.testDataTotal} Data set`:"",n=`${e.name} (${e.testId})${r}`;return us(n)}onTestStarted(e,t,r,n){if(r){Fl.debug("skip report test started because is rerun");return}let i=this.getPrintName(e);console.log(`##teamcity[testStarted name='${i}' captureStandardOutput='true' flowId='${n}']`)}onTestFailed(e,t,r,n,i,o){if(i){Fl.debug("skip report test failed because is rerun");return}let a=this.getPrintName(e);console.log(`##teamcity[testFailed name='${a}' message='${us(t)}' details='${us(r)}' flowId='${o}']`)}onTestFinished(e,t,r){if(r){Fl.debug("skip report test finished because is rerun");return}let n=this.getPrintName(e);console.log(`##teamcity[testFinished name='${n}' duration='${e.duration}' flowId='${e.resultId}']`)}onTestIgnored(e,t,r="ignore"){let n=this.getPrintName(t);console.log(`##teamcity[testIgnored name='${n}' message='${us(r)}']`)}onTestPlanStarted(e,t,r,n){console.log(`##teamcity[testSuiteStarted name='${us(n)}']`)}onTestPlanFinished(e,t){console.log(`##teamcity[testSuiteFinished name='${us(t)}']`)}},Dv=Bl});var Bf={};z(Bf,{Reporter:()=>Nv});var jl,Nv,jf=v(()=>{"use strict";jl=class{constructor(e){this.options=e}onTestStarted(e,t){console.log(JSON.stringify({name:"testStarted",data:{test:e,workerId:t}}))}onTestFinished(e,t){console.log(JSON.stringify({name:"testFinished",data:{test:e,workerId:t}}))}onTestPlanStarted(e,t,r,n,i){let o={name:"suiteStarted",data:{projectId:this.options.project,executionId:i}};console.log(JSON.stringify(o))}onTestPlanFinished(e){console.log(JSON.stringify({name:"suiteFinished",data:{testResults:e}}))}},Nv=jl});function go(s){let{platform:e}=process;e==="win32"?(0,fo.exec)(`start chrome ${s}`):e==="darwin"?(0,fo.exec)(`open -a "Google Chrome" ${s}`):e==="linux"&&(0,fo.exec)(`google-chrome ${s}`)}var fo,$l=v(()=>{"use strict";fo=require("child_process")});var $f={};z($f,{Reporter:()=>Mv});var Wl,Mv,Wf=v(()=>{"use strict";B();$l();Wl=class{constructor(e,t){this.options=e;this.branchToUse=t}onTestStarted(e){let t=ze(this.options.editorUrl,this.options.project,e.testId,e.resultId,this.branchToUse);return go(t)}},Mv=Wl});var Vl,Q,_t=v(()=>{"use strict";Df();Vl=class{constructor(){this.reporters=[];this.onGetBrowserFailure=this.generateHook("onGetBrowserFailure");this.onGetBrowserSuccess=this.generateHook("onGetBrowserSuccess");this.onTestPlanStarted=this.generateHook("onTestPlanStarted");this.onGetSlot=this.generateHook("onGetSlot");this.onGetSession=this.generateHook("onGetSession");this.onTestFinished=this.generateHook("onTestFinished");this.onTestFailed=this.generateHook("onTestFailed");this.onTestPassed=this.generateHook("onTestPassed");this.onTestStarted=this.generateHook("onTestStarted");this.onTestIgnored=this.generateHook("onTestIgnored");this.onWaitToTestStart=this.generateHook("onWaitToTestStart");this.onWaitToTestComplete=this.generateHook("onWaitToTestComplete");this.onTestPlanFinished=this.generateHook("onTestPlanFinished",this.onTestPlanFinishedMutator);this.onAllTestPlansFinished=this.generateHook("onAllTestPlansFinished",this.onAllTestPlansFinishedMutator)}async setOptions(e,t){this.reporters=[];let r=e.reporters;if(this.reporters.push(new po(e)),r===void 0||r.length===0){let{Reporter:n}=await Promise.resolve().then(()=>(Ll(),_l));if(this.reporters.push(new n(e,t)),(e==null?void 0:e.reportFile)!==void 0){let{Reporter:i}=await Promise.resolve().then(()=>(Ul(),Ml));this.reporters.push(new i(e,t))}}else(await Promise.all([r.includes("teamcity")&&Promise.resolve().then(()=>(Ff(),Uf)),r.includes("console")&&Promise.resolve().then(()=>(Ll(),_l)),r.includes("junit")&&Promise.resolve().then(()=>(Ul(),Ml)),r.includes("json")&&Promise.resolve().then(()=>(jf(),Bf)),r.includes("chrome")&&Promise.resolve().then(()=>(Wf(),$f))])).forEach(i=>{i&&this.reporters.push(new i.Reporter(e,t))})}onTestPlanFinishedMutator(e,t,r,n,i){let o={};o=e;let a=Date.now()-(r||0);return[o,t,a,n,i]}onAllTestPlansFinishedMutator(e){return[e]}generateHook(e,t){return async(...r)=>{var i;let n=t==null?void 0:t(...r);for(let o of this.reporters)await((i=o[e])==null?void 0:i.call(o,...n||r))}}},Q=new Vl});async function Gl(s,e,t){let r=ps[s];if(!r)return;let{slotId:n}=r;if(delete ps[s],!n){lt.warn("failed to find slot slot id",{companyId:e,workerId:s});return}lt.info("release slot id",{companyId:e,slotId:n});try{await ql(e,t,n)}catch(i){lt.error("failed to release slot",{companyId:e,err:i})}}async function Uv(s,e){let t=Object.values(ps).filter(Boolean);if(t.length!==0){lt.info("keep alive worker slots",{companyId:s,slots:t});try{await Kl(s,e,t)}catch(r){lt.error("failed to update slot keep alive",{err:r,slots:t,companyId:s})}}}function Fv(s,e){Vf=global.setInterval(()=>Uv(s,e),1e4)}async function Bv(s,e){let t=Object.keys(ps);if(t.length){lt.warn("not all slots released before end runner flow",{companyId:s});try{await se(t,r=>Gl(Number(r),s,e))}catch(r){lt.error("failed to release all slots",{err:r,companyId:s})}}}async function jv(s,e){await Bv(s,e),clearInterval(Vf)}async function Hf(s,e,t){let r;try{r=await Hl(s,e)}catch(n){throw lt.error("failed to get slot",{companyId:s,err:n}),new Error(yt.UNKNOWN)}if(lt.info("get slot info",{...r,companyId:s}),!r||!["success","error"].includes(r.status))throw lt.error("invalid response - get slot",{res:r}),new Error(yt.UNKNOWN);if(r.status==="success")return Gf(t,{slotId:r.slotId}),r.slotId;throw r.code==="not-found"?new st(yt.NOT_FOUND):r.code==="no-available-slot"?new Kt("Failed to run test - concurrency limit reached"):(lt.error("invalid code error response - get slot",{res:r}),new st(yt.UNKNOWN))}async function qf(s,e,t,r){let n=ps[r];if(!n)throw new Error("slot not found");Object.assign(n,t),Gf(r,n),await zl(s,e,n),lt.info("update slot data on server",{companyId:s,projectId:e,slotData:t})}var lt,ps,Vf,Gf,In,ds=v(()=>{"use strict";ge();$();B();oe();X();lt=C("slot-service"),ps={},Vf=null,Gf=(s,e)=>{ps[s]=e};In={start:Fv,end:jv}});function Kf(s,e=process){async function t(r){await pe(se(zf,async n=>n()),1e4).catch(()=>null),s(r)}e.on("uncaughtException",async r=>{xn.error("Caught exception",{err:r}),console.log("Uncaught exception"),r.message&&console.log("Message =",r.message),r.reason&&console.log("Reason =",r.reason),await t(r)}),e.on("unhandledRejection",r=>{var n;if(xn.fatal("Caught unhandled promise rejection",r),!((n=r==null?void 0:r.message)!=null&&n.includes("ENOTFOUND x-api.rollout.io")))throw r}),e.on("rejectionHandled",()=>{xn.error("Caught rejection handled")}),e.once("SIGTERM",()=>{let r="Runner aborted - SIGTERM event",n=new Error(r);throw xn.error(r),t(n),n}),e.once("SIGINT",()=>{let r="Runner aborted - SIGINT event",n=new Error(r);throw xn.error(r),t(n),n}),e.once("exit",r=>{s(r)})}function ms(s){zf.push(s)}var xn,zf,An=v(()=>{"use strict";$();B();xn=C("process-handler"),zf=[]});var Qf={};z(Qf,{installAllLazyDependencies:()=>Gv,lazyRequire:()=>ut});async function ut(s,e={}){let t=el(s);if(t)return t;let r;e.silent||(r=(0,Jf.default)(`Installing ${s} before first usage...`).start());try{let n=await Vv(s);return r&&r.succeed(),n}catch(n){Wv.warn("failed to install dependency lazily",{dependency:s,err:n});let i=Xf(s),o=`${s}@${i}`,c=process.argv.includes("npx")?"":"-g ",l=`Installation of ${s} failed. This typically means you are running an out-of-date version of Node.js or NPM.Please manually install by running the following command: npm install ${c}${o}`;throw r&&r.fail(l),n}}async function Vv(s){return fs.has(s)||(fs.set(s,Yf(s)),fs.get(s).catch(()=>{fs.delete(s)})),fs.get(s)}async function Yf(s){let e=el(s);if(e)return e;let t=Xf(s),r=`${s}@${t}`;return await Hi(ht(),r),Qt(s)}async function Gv(){let s=Object.keys(mc);for(let e of s)await Yf(e)}function Xf(s){let e=Object.entries(mc).find(([t])=>t===s);if(!e)throw new Error("The given package name is not lazyDependencies");return e[1]}var Jf,Wv,fs,Cn=v(()=>{"use strict";Jf=I(require("ora"));is();$();B();yi();an();Wv=C("lazy-require"),fs=new Map});var Zf,ho,eg=v(()=>{"use strict";Zf=require("istanbul-lib-report"),ho=class extends Zf.ReportBase{constructor(t){super();t||={},this.appendToObject=t.appendToObject||{}}onStart(t){let r=t.getCoverageSummary(!1);this.appendToObject=Object.assign(this.appendToObject,r.toJSON())}}});var tg,rg,sg,Pn,Tt,ng,yo,Jl,ig,Hv,og,ag,qv,zv,cg,Kv,Jv,Yv,Xv,Qv,lg,ug=v(()=>{"use strict";tg=I(require("ora")),rg=I(require("dayjs")),sg=I(require("test-exclude")),Pn=I(require("fs")),Tt=I(require("path")),ng=I(require("istanbul-reports")),yo=I(require("istanbul-lib-report"));ge();X();B();$();Cn();eg();Jl=C("test-run-status"),ig=s=>{try{return new URL(s)}catch{try{return new URL(`file://${s}`)}catch{return{}}}},Hv=s=>!!ig(s).search,og=s=>s?ig(s).pathname.substring(1):"",ag=(s,e)=>{let t=og(e);return!new sg.default({relativePath:!1,include:s}).shouldInstrument(t)},qv=s=>s.substring(0,s.indexOf("?")),zv=async({source:s,sourceMapDir:e,sourceMapType:t})=>{let r=await ut("convert-source-map");if(t==="file"&&!e)throw new A("--code-coverage-source-map-path [path]");return e?r.fromMapFileSource(s,e):r.fromSource(s)},cg=(s,e)=>`${Tt.resolve(s,og(e))}.js`,Kv=async(s,e,t)=>{let{codeCoverageInclude:r}=s;await se(Object.values(t),async n=>{if(!n)return;let i=n.toObject();await se(i.sources,async(o,a)=>{if(ag(r,o))return;let c=cg(e,o);await Pn.promises.mkdir(Tt.parse(c).dir,{recursive:!0}),await Pn.promises.writeFile(c,i.sourcesContent[a])})})},Jv={getPath(s){if(typeof s=="string")return s;let e=s.getQualifiedName();return s.isSummary()?e!==""?e+="/index.html":e="index.html":(Hv(e)&&(e=qv(e)),e+=".html"),e},relativePath(s,e){let t=this.getPath(e),r=Tt.dirname(this.getPath(s));return Tt.posix.relative(r,t)},assetPath(s,e){return this.relativePath(this.getPath(s),e)}},Yv=async(s,e,t,r)=>{let{codeCoverageReporter:n}=s,i={},o=yo.createContext({dir:t,coverageMap:e,watermarks:yo.getDefaultWatermarks(),sourceFinder:a=>{try{let c=cg(r,a);return Pn.readFileSync(c,"utf8")}catch(c){throw new Error(`Unable to lookup source: ${a} (${c.message})`)}}});return new ho({appendToObject:i}).execute(o),Array.isArray(n)&&n.forEach(a=>{let c={projectRoot:"/"};a==="html"&&(c={linkMapper:Jv}),ng.create(a,c).execute(o)}),i},Xv=async(s,{source:e,sourceMap:t,functions:r})=>{let{codeCoverageInclude:n}=s;if(!t||t.sourcemap.sources.length===0)return;let o=(await ut("v8-to-istanbul"))("FAKE_PATH",0,{source:e,sourceMap:t},a=>ag(n,a));return await o.load(),o.applyCoverage(r),o.toIstanbul()},Qv=async(s,e)=>{let{mergeProcessCovs:r}=await ut("@bcoe/v8-coverage"),n={result:[]},i=new Map,a=(await Xl(s,"testResult",`runId=${e}`)).data.docs;return await se(a.flatMap(c=>c.JSCoverageURLS||[]),async c=>{let l=await kn(c,9e4);await se(l,async d=>{if(!i.has(d.url)){let m=d.text;d.sourceUrl&&(i.set(d.url,"TEMP"),m=await Yl(d.sourceUrl)),i.set(d.url,{text:m,url:d.url,sourceMapType:d.sourceMapType,hash:d.hash})}delete d.text,n=r([n,{result:[d]}])})},{concurrency:20}),{covUrlMap:i,mergedCoverages:n}},lg=async(s,e,t,r)=>{if(!s.collectCodeCoverage)return;Jl.info("start js coverage process");let n=(0,tg.default)(`analyzing coverage for ${t} ${t===1?"test":"tests"}`).start(),i=Tt.resolve(s.codeCoverageReportPath||"./coverage"),o=Tt.resolve(i,`.js/${(0,rg.default)().format("DDMMYYYYHHmmss")}`),a=s.codeCoverageSourceMapPath?Tt.resolve(s.codeCoverageSourceMapPath):void 0;try{let[c,{mergedCoverages:l,covUrlMap:d}]=await Promise.all([ut("istanbul-lib-coverage"),Qv(s.project,r)]);if(l.result.length===0){n.fail("Failed to report coverage information - js code coverage is empty");return}Jl.info("start js coverage merge and remap",{numOfFiles:d.size,numMergedCoverages:l.result.length});let m=c.createCoverageMap({}),u={};await se(l.result,async({url:h,functions:g})=>{let{text:y,sourceMapType:T}=d.get(h),w=await zv({sourceMapType:T,source:y,sourceMapDir:a});u[h]=w;let b=await Xv(s,{source:y,sourceMap:w,functions:g});m.merge(b)}),await Kv(s,o,u);let f=await Yv(s,m,i,o);return n.succeed(),f}catch(c){let l="Failed to report coverage information";c instanceof A?n.fail(`${l}, missing arg: ${c.message}`):n.fail(l),Jl.error(l,{err:c})}}});var pg={};z(pg,{SELENIUM_PERF_MARKS:()=>Ce,SeleniumPerfStats:()=>Ar});var Ce,Zv,Ar,gs=v(()=>{"use strict";B();Ce={GET_BROWSER:"GET_BROWSER",GET_HTML:"GET_HTML",GET_ELEMENT:"GET_ELEMENT",GET_SCREENSHOT:"GET_SCREENSHOT"},Zv=["ALL",...Object.values(Ce)],Ar=class{constructor(){this.marks=Object.fromEntries(Zv.map(e=>[e,[]]));this.startTimes={}}markStart(e){let t=re();return this.startTimes[`${e}:${t}`]=Date.now(),t}markEnd(e,t){let r=Date.now()-this.startTimes[`${t}:${e}`];if(delete this.startTimes[`${t}:${e}`],!this.marks[t]){this.marks.ALL.push(r);return}this.marks[t].push(r)}getStats(){let e=Object.entries(this.marks).flatMap(([t,r])=>!Array.isArray(r)||!r.length?[]:[[`${t}_COUNT`,r.length],[`${t}_P50`,Ni(r,50)],[`${t}_P95`,Ni(r,95)]]);return{seleniumPerfMarks:this.marks,seleniumStats:Object.fromEntries(e)}}}});var gg={};z(gg,{initServer:()=>rS,mapFilesToLocalDrive:()=>Zl});function Zl(s,e){try{s.failurePath=(s.failurePath||[]).map(t=>Object.assign(t,bo[t.id]?{screenshot:bo[t.id]}:{})),Object.keys(To).forEach(t=>{s.assets||={},s.assets[fg[t]]=To[t]}),s.assets||={},s.assets.screenshots=Object.values(bo)}catch(t){e&&e.error("failed to map files to local drive",{err:t}),s.failurePath||=[],s.assets||={},s.assets.screenshots||=[]}}async function rS({agentPort:s,agentBind:e,saveRCALocally:t}){let r=await ut("multer"),n=typeof t=="string"?t:eS;await Ql.promises.mkdir(n,{recursive:!0});let i=r({storage:r.diskStorage({async destination(c,l,d){let m=JSON.parse(c.body.metadata||"{}");if(!m.testResultId)return d(new Error("missing testResultId"),"");let u=On.join(n,m.testResultId);try{await Ql.promises.mkdir(u,{recursive:!0})}catch(f){return d(f,"")}return d(null,u)},filename(c,l,d){let{fileName:m}=c.body,u=JSON.parse(c.body.metadata||"{}");if(!u.stepId&&!m)return d(new Error("missing stepId or fileName"),"");if(u.stepId){let f=On.extname(m);return d(null,`step_${u.stepId}_${u.stepName||""}${f}`.replace(/[/\\?%*:|"<>\s]/g,"-"))}return d(null,m)}})}),o=(0,mg.default)();o.disable("x-powered-by"),o.post("/",i.single("file"),(c,l)=>{let d=JSON.parse(c.body.metadata||"{}");d.stepId&&(bo[d.stepId]=c.file.path),d.testResultId&&tS.includes(d.subType)&&(To[d.subType]||=[],To[d.subType].push(c.file.path)),l.sendStatus(200)}),o.use((c,l)=>l.status(404).send("Endpoint Not Found"));let{createServer:a}=await import("http");return await new Promise((c,l)=>{let d=a(o);d.listen(s,e),d.on("error",m),d.on("listening",()=>c(d.address()));function m(u){if(u.syscall!=="listen")return l(u);switch(u.code){case"EACCES":case"EPERM":return l(new A(`Port ${s} requires elevated privileges`));case"EADDRINUSE":return l(new A(`Port ${s} is already in use`));default:return l(u)}}})}var Ql,dg,On,mg,eS,bo,To,fg,tS,eu=v(()=>{"use strict";Ql=I(require("fs")),dg=I(require("os")),On=I(require("path")),mg=I(require("express"));X();Cn();eS=On.join(dg.tmpdir(),"testim/rca/"),bo={},To={},fg={"test-log":"consoleLogs","har-file":"networkLogs"},tS=Object.keys(fg)});var tr,tu,wo,hg=v(()=>{"use strict";tr=I(require("lodash"));B();$();tu=C("override-test-data-builder"),wo=class{constructor(e,t,r){this.params=e;this.testInfoList=t;this.projectId=r}isObjectNotArray(e){return tr.isObject(e)&&!Array.isArray(e)}isArrayOfObjects(e){return Array.isArray(e)&&e.filter(t=>!this.isObjectNotArray(t)).length===0}overrideTestData(){let{params:e,projectId:t}=this;return this.isObjectNotArray(e)&&e.overrideTestData!==void 0&&(this.isObjectNotArray(e.overrideTestData)&&!tr.isEmpty(e.overrideTestData)?(Object.keys(e.overrideTestData).forEach(r=>this.overrideSingleTest(r,e.overrideTestData[r])),delete e.overrideTestData):tu.error("invalid overrideTestData",{overrideTestData:e.overrideTestData,projectId:t})),this.isObjectNotArray(e)&&e.overrideAllTestsData!==void 0&&(tr.isObject(e.overrideAllTestsData)&&!tr.isEmpty(e.overrideAllTestsData)?(this.testInfoList.map(n=>n.name).forEach(n=>this.overrideSingleTest(n,e.overrideAllTestsData)),delete e.overrideAllTestsData):tu.error("invalid overrideAllTestsData",{overrideAllTestsData:e.overrideAllTestsData,projectId:t})),this.testInfoList}overrideSingleTest(e,t){let{projectId:r}=this;if(this.isObjectNotArray(t)||this.isArrayOfObjects(t)){this.replaceAndCreateOverrideTestData(e,t);return}tu.error("skip override test data to test name",{testName:e,projectId:r}),console.error(`Invalid override test data provided to test '${e}'`)}replaceAndCreateOverrideTestData(e,t){let r=this.mapTestListToUniqueId(e);if(r.length!==0)return this.createNewTestPerOverrideTestData(r,t)}mapTestListToUniqueId(e){let{testInfoList:t}=this;return tr.chain(t).map(r=>{if(r.name.toLowerCase()===e.toLowerCase())return this.generateTestUniqId(r)}).compact().uniq().value()}createNewTestPerOverrideTestData(e,t){let{testInfoList:r}=this;return[...new Set(e)].map(n=>{let i=r.map(d=>this.generateTestUniqId(d)),o=i.indexOf(n),a=i.lastIndexOf(n),c=r[o],l=this.createNewTestItems(c,t);return r.splice(o,a-o+1,...l)})}createNewTestItems(e,t){return[].concat(t).map((r,n)=>{let i=re();return{...e,resultId:i,testData:{value:r,index:n+1,total:t.length||1}}})}getTestType(e){return e.isBeforeTestPlan?"before":e.isAfterTestPlan?"after":"test"}generateTestUniqId(e){return`${e.testId}:${e.testConfig.id}:${this.getTestType(e)}`}}});async function vo(s,...e){if(!(!s||typeof s!="function"))try{return await s(...e)||{}}catch(t){throw Ze.warn("failed to run hook",{err:t}),new A(`failed to run hook promise ${t.message}`)}}var Cr,Ze,sS,nS,iS,oS,So,yg=v(()=>{"use strict";Cr=I(require("lodash"));B();oe();as();ds();ge();X();$();_t();An();ug();gs();eu();ae();de();hg();Sn();Ze=C("test-run-status"),sS=yr(),nS=process.env.GIT_COMMIT||process.env.CIRCLE_SHA1||process.env.TRAVIS_COMMIT,iS=process.env.GIT_URL||process.env.CIRCLE_REPOSITORY_URL,oS=rt();So=class{constructor(e,t,r,n){this.testInfoList=e;this.options=t;this.branchToUse=n;this.exportsGlobal={};this.startTime=null;this.beforeSuiteParams={};this.executionStartedPromise=Promise.resolve();this.seleniumPerfStats=new Ar;var a,c,l,d;this.options.runParams||={},this.fileUserParamsData=this.options.userParamsData;let i=Zs(t,e),o=t.lightweightMode?t.lightweightMode.type:t.mode;this.execConfig={parallel:wi||t.parallel||1,browser:i,gitBranch:sS,gitCommit:nS,gitRepoUrl:iS,runnerVersion:oS,gridHost:t.host||((a=t.gridData)==null?void 0:a.host),testimBranch:n,canaryMode:t.canary,source:t.source,schedulerId:t.schedulerId,testPlanId:r,testPlans:t.testPlan,testLabels:t.label,testSuites:[...new Set(e.flatMap(m=>m.testSuites))],testNames:t.name,testIds:t.testId,testConfigs:t.testConfigNames,testConfigIds:t.testConfigIds,port:t.port,browserTimeout:t.browserTimeout,timeout:t.timeout,newBrowserWaitTimeout:t.newBrowserWaitTimeout,tunnel:t.tunnel,tunnelPort:t.tunnelPort,tunnelHostHeader:t.tunnelHostHeader,runnerMode:o,gridId:t.gridId||((c=t.gridData)==null?void 0:c.gridId),gridName:t.grid||((l=t.gridData)==null?void 0:l.name),gridType:(d=t.gridData)==null?void 0:d.type,retentionDays:t.retentionDays,codeCoverageReportPath:t.codeCoverageReportPath,collectCodeCoverage:t.codeCoverageUrlFilter||t.collectCodeCoverage,sessionType:"codeless"},this.testRunStatus=this.calcTestRunStatus()}waitForExecutionStartedFinished(){return this.executionStartedPromise}getTestResult(e){return this.testRunStatus[e]}async addRetryTestResult({newResultId:e,originalTestResultId:t,previousTestResultId:r,projectId:n,executionId:i,retryCount:o=1}){let a=this.testRunStatus[t]||{},{config:c,testId:l,name:d,testStatus:m,testCreatorName:u,testCreatorEmail:f,testOwnerName:h,testOwnerEmail:g,testLabels:y,testSuites:T,allLabels:w}=a,b={originalTestResultId:t,previousTestResultId:r,config:Cr.cloneDeep(c),testId:l,status:"QUEUED",name:d,resultId:e,retryCount:o,testStatus:m};return this.testRunStatus[e]={...b,testCreatorName:u,testCreatorEmail:f,testOwnerName:h,testOwnerEmail:g,testLabels:y,testSuites:T,allLabels:w},nu({projectId:n,runId:i,testId:l,newResultId:e,originalTestResultId:t,previousTestResultId:r,testResult:b})}testStart(e,t,r,n){let i=this.getTestResult(r);return i.workerId=e,Q.onTestStarted(i,e,n,r),i}async updateTestStatusRunning(e,t,r){var l;let{project:n,remoteRunId:i,projectData:o}=this.options;if((l=this.options.lightweightMode)!=null&&l.onlyTestIdsNoSuite)return this.executionStartedPromise;let a="";try{a=await Io(n,e.testId,e.resultId,e.config.testData,o.defaults)||""}catch(d){Ze.error("failed to upload test data artifact (runner)",{err:d})}let c=Cr.cloneDeep(e.config);return delete c.testData,c.testDataUrl=a,await this.executionStartedPromise,Pr(n,t,e.testId,e.resultId,"RUNNING",{startTime:e.startTime,config:c,remoteRunId:i,testRetryKey:r})}async testStartReport(e,t,r){if(Xe(e,this.options))return;let n=this.exportsGlobal;try{let i=await vo(this.options.beforeTest,{...e,exportsGlobal:n,globalParameters:n},this.options.userData.loginData.token);return e.config.testData={...e.config.testData,...this.exportsGlobal,...this.fileUserParamsData,...this.beforeSuiteParams,...i},this.options.runParams[e.resultId]=e.config.testData,e.startTime=Date.now(),await this.updateTestStatusRunning(e,t,r),e}catch(i){throw Ze.error("Failed to start test",{err:i}),i}}testStartAndReport(e,t,r,n,i){let o=this.testStart(e,t,r,n);return this.testStartReport(o,t,i)}onGridSlot(e,t){let r=this.getTestResult(e);r.config.gridInfo={...t,key:void 0,user:void 0},Ze.info("on get grid info",{gridInfo:r.config.gridInfo})}reportTestStatus(e,t,r,n){let{name:i,testId:o,testStatus:a}=r,{resultId:c,success:l}=t;if(a===Ye.EVALUATING&&Ot.isTestStatusEnabled){Q.onTestIgnored(e,r,`test in ${Ye.EVALUATING} status`);return}if(l){Q.onTestPassed(i);return}Q.onTestFailed(r,r.failureReason,ze(this.options.editorUrl,this.options.project,o,c,this.branchToUse),o,n,c)}calcResultText(e){return e.success?fe.PASSED:fe.FAILED}onTestIgnored(e,t){let r=this.getTestResult(t);Q.onTestIgnored(e,r,`test in ${Ye.QUARANTINE}`)}monitorMemoryUsage(e){let t=Hc();t.isOverThreshold&&Ze.info("memoryUsage is over threshold",{memoryUsage:t,testName:e.name,testId:e.testId,resultId:e.resultId,startTime:e.startTime,duration:e.duration,success:e.success,failureReason:e.failureReason,lightweightMode:this.options.lightweightMode,parallel:this.options.parallel,browser:this.options.browser})}testEnd(e,t,r,n,i){let o=this.getTestResult(t.resultId),a=t.endTime-t.startTime||0;o.sessionId=n,o.startTime=t.startTime||o.startTime||Date.now(),o.duration=a,t.duration=a,o.failureReason=t.failureReason||t.reason,t.failureReason=o.failureReason,o.failurePath=t.failurePath,o.resultId=t.resultId,o.success=t.success,this.options.saveRCALocally&&Zl(o,Ze),o.resultUrl=ze(this.options.editorUrl,this.options.project,o.testId,o.resultId,this.branchToUse),o.status=this.calcResultText(t),t.status=o.status,t.name=o.name,t.testStatus=o.testStatus,t.testId||=o.testId,t.testCreatorName=o.testCreatorName,t.testCreatorEmail=o.testCreatorEmail,t.testOwnerName=o.testOwnerName,t.testOwnerEmail=o.testOwnerEmail,t.testData=o.config&&typeof o.config.testDataTotal=="number"?{total:o.config.testDataTotal,index:o.config.testDataIndex}:{},this.reportTestStatus(e,t,o,i),this.monitorMemoryUsage(o),Q.onTestFinished(o,e,i);let c={...this.exportsGlobal,...t.exportsGlobal};return this.exportsGlobal=c,o}async testEndReport(e,t,r,n){var o;let i=r.exportsGlobal;try{try{await vo(this.options.afterTest,{...e,exportsGlobal:i,globalParameters:i},this.options.userData.loginData.token)}catch(a){Ze.error("HOOK threw an error",{test:e.testId,err:a}),console.error("HOOK threw an error",a)}return(o=this.options.lightweightMode)!=null&&o.onlyTestIdsNoSuite?void 0:await Pr(this.options.project,t,e.testId,e.resultId,"FINISHED",{startTime:e.startTime,endTime:r.endTime,success:e.success,failureReason:e.failureReason,remoteRunId:this.options.remoteRunId,...n},5)}catch(a){throw Ze.error("Failed to update test finished",{err:a}),a}}testEndAndReport(e,t,r,n,i,o){let a=this.testEnd(e,t,r,n,i);return this.testEndReport(a,r,t,o)}getMobileRunSkippedReason(e,t,r){let n="",{APP_FROM_DEVICE:i,VIRTUAL_BUILD:o}=Bc;return e&&(n=i),Xr(t,r)&&(n=o),n}calcTestRunStatus(){var o;let{options:e,testInfoList:t}=this,r=e.company.companyId,n=(o=e.gridData)==null?void 0:o.type,i=t.map(a=>{var f,h,g;let c=e.browser?rn(e.browser,e.saucelabs,e.browserstack):a.runConfig,l=Qr(O,n)&&tn(a.nativeApp)&&!e.appId,d=Yt(e)&&(Xr(a.nativeApp,n)||l),m=Xe(a,e)||d,u={testId:a.testId,testOptimization:a.testOptimization,status:m?fe.SKIPPED:fe.QUEUED,name:a.name,resultId:a.resultId,testStatus:a.testStatus||Ye.DRAFT,testCreatorName:a.creatorName,testCreatorEmail:a.creatorEmail,testOwnerName:a.testOwnerName,testOwnerEmail:a.testOwnerEmail,testLabels:a.testLabels,testSuites:a.testSuites,allLabels:a.allLabels,...d&&{reason:this.getMobileRunSkippedReason(l,a.nativeApp,n)},config:{...this.execConfig,companyId:r,testData:((f=a.testData)==null?void 0:f.value)||null,isBeforeTestPlan:a.isBeforeTestPlan,isAfterTestPlan:a.isAfterTestPlan,testDataTotal:((h=a.testData)==null?void 0:h.total)||null,testDataIndex:((g=a.testData)==null?void 0:g.index)||null,baseUrl:e.baseUrl||a.baseUrl||a.testConfig.baseUrl,testConfig:a.overrideTestConfig||a.testConfig,browser:c.browserValue.toLowerCase()}};return[a.resultId,u]});return Object.fromEntries(i)}async endKeepAlive(e,t,r){e==="redis"&&await In.end(r,t),e==="mongo"&&await bn.end(t)}async executionStart(e,t,r,n,i){Ze.info("execution started",{executionId:e,gridId:this.execConfig.gridId,gridHost:this.execConfig.gridHost,gridName:this.execConfig.gridName,gridType:this.execConfig.gridType,parallel:this.execConfig.parallel,runnerVersion:this.execConfig.runnerVersion,source:this.execConfig.source});let{options:o}=this,{remoteRunId:a,projectData:c,company:{companyId:l}={},slotService:d}=o;ms(()=>Promise.all([this.endKeepAlive(d,t,l),Eo("ABORTED",e,t,!1,void 0,a,{gridName:this.options.grid})])),this.startTime=r||Date.now();let m={projectId:t,executionId:e,...O.flags.testNamesToBeforeSuiteHook.isEnabled()&&{testNames:i}},u=await vo(o.beforeSuite,m),f=new wo(u,Cr.cloneDeep(this.testInfoList),t);this.testInfoList=f.overrideTestData(),this.testRunStatus=this.calcTestRunStatus(),this.beforeSuiteParams=u;let{testInfoList:h}=this,g=[],y=[],T=[];for(let b of h){if(b.isBeforeTestPlan){g.push(b);continue}if(b.isAfterTestPlan){T.push(b);continue}y.push(b)}let w=async()=>{let b=Cr.cloneDeep(this.testRunStatus);await se(Object.keys(b),async k=>{var L;let D=b[k],G=(L=D.config)==null?void 0:L.testData,x=D.testId,R=await Io(t,x,k,G,c.defaults);R&&(delete D.config.testData,D.config.testDataUrl=R)});let S=Boolean(o.useLocalChromeDriver||o.useChromeLauncher),E=su({executionId:e,projectId:t,labels:n||[],startTime:r,executions:b,config:this.execConfig,resultLabels:o.resultLabels,remoteRunId:o.remoteRunId,localRunUserId:o.user,isLocalRun:S,intersections:o.intersections});return this.executionStartedPromise=E,E.catch(k=>Ze.error(k)),E};try{await w()}catch(b){Ze.error("Failed to start suite",{err:b}),console.error("Failed to start test run. Please contact support@testim.io")}return{beforeTests:g,tests:y,afterTests:T}}concatSeleniumPerfMarks(e){Cr.chain(e).keys().each(t=>{let r=t;this.seleniumPerfStats.marks[r]&&(this.seleniumPerfStats.marks[r]=[...this.seleniumPerfStats.marks[r],...e[r]])}).value()}async executionEnd(e){var d;let t=zc(this.testRunStatus),r=t.length,n=0,i=0,o=0;for(let{status:m,testStatus:u}of t)m===fe.PASSED&&n++,m===fe.SKIPPED&&i++,m===fe.FAILED&&u===Ye.EVALUATING&&o++;let{seleniumPerfMarks:a,...c}=this.seleniumPerfStats.getStats();try{await vo(this.options.afterSuite,{exportsGlobal:this.exportsGlobal,tests:t,total:r,passed:n,skipped:i})}catch(m){console.log("check your callback handler on afterSuite Hook for syntax or exception errors"),Ze.warn("error while running afterSuite Hook",{err:m,projectId:this.options.projectData.projectId,executionId:this.options.executionId})}let l=await lg(this.options,this.branchToUse,r,e);if(Object.assign(c,{coverageSummary:l}),!((d=this.options.lightweightMode)!=null&&d.onlyTestIdsNoSuite))try{return await Eo("FINISHED",e,this.options.project,r===n+i+o,{tmsSuppressReporting:this.options.tmsSuppressReporting,tmsRunId:this.options.tmsRunId,tmsCustomFields:this.options.tmsCustomFields},this.options.remoteRunId,c)}catch(m){throw Ze.error("Failed to update suite finished",{err:m}),m}}async markAllQueuedTests(e,t,r,n){let i=Object.keys(this.testRunStatus).filter(o=>this.getTestResult(o).status==="QUEUED");await ru(e,["QUEUED"],t,r,n,this.startTime,null,this.options.project);for(let o of i){let a=this.getTestResult(o);a.status=t,a.failureReason=r,a.success=n}return this.testRunStatus}}});function iu(s,e){var o;let t=s.canary?"-master.zip":".zip",r=`${e?Nd:$s}/extension/testim-headless${t}`,n=O.flags.testimHeadlessExtensionDownloadUrl.getValue({companyId:(o=s.company)==null?void 0:o.companyId,projectId:s.project,runnerEnvironment:Rt});return n||(aS.warn("testimHeadlessExtensionDownloadUrl flag is not set, defaulting to MV3 extension",{resultId:s.resultId,executionId:s.executionId,projectId:s.project}),n="https://testimstatic.blob.core.windows.net/extension/testim-headless.zip"),!(s.ext||s.extensionPath)&&n&&(r=n,s.testimHeadlessExtensionDownloadUrl=n),{chrome:r,"edge-chromium":r}}function bg(s){let{chrome:e}=iu(s,!1);return e}function Ro(s){let e=Rt==="staging"?`${js}/staging-sessionPlayer`:`${$s}/extension/sessionPlayer`;return s.canary?`${e}-master`:e}var aS,_n=v(()=>{"use strict";ae();de();$();aS=C("runOptionsUtils")});function wg(s,e){if(e){if(!mS.has(e)){Ln.warn(`OS ${e} is not supported by LT`,{testResultId:s});return}return e}}var vg,Sg,Wt,Eg,Ig,Rg,xo,xg,Ln,cS,lS,Dn,uS,pS,dS,ne,mS,Ao=v(()=>{"use strict";vg=I(require("ms")),Sg=I(require("p-retry")),Wt=I(require("node:os")),Eg=I(require("portfinder")),Ig=I(require("node:child_process"));B();Ge();ge();Rg=I(require("node:fs")),xo=I(require("node:fs/promises")),xg=require("node:path");X();$();_n();oe();de();B();Ln=C("lambdatestService"),cS="https://downloads.lambdatest.com/tunnel/v3",lS={win32ia32:"windows/32bit/LT_Windows.zip",win32x64:"windows/64bit/LT_Windows.zip",darwinia32:"mac/32bit/LT_Mac.zip",darwinx64:"mac/64bit/LT_Mac.zip",darwinarm64:"mac/64bit/LT_Mac.zip",linuxia32:"linux/32bit/LT_Linux.zip",linuxx64:"linux/64bit/LT_Linux.zip",freebsdia32:"freebsd/32bit/LT_Freebsd.zip",freebsdx64:"freebsd/64bit/LT_Freebsd.zip"},Dn=`${Wt.tmpdir()}/LT`,uS=`${Dn}/LT`,pS=(0,vg.default)("15m"),dS="2560x1440",ne=class{constructor(){this.isActive=!1}static isLambdatestGrid(e){return e.type===_.TESTIM_LAMBDATEST||e.type===_.LAMBDATEST||e.type===_.HYBRID&&e.provider==="lambdatest"}isLambdatestRun(){return this.isActive}async enableIfNeeded(e,t){ne.isLambdatestGrid(e)&&(ne.lambdatestConfigPromise||=ou(t),ne.lambdatestConfig=await ne.lambdatestConfigPromise,this.isActive=!0)}disable(){this.isActive=!1}get getSessionTimeout(){return this.isActive?pS:null}get getSessionRetries(){return this.isActive?1:null}static async prepareTunnel(){if(await ye(uS))return;let t=lS[Wt.platform()+Wt.arch()];if(!t)throw new Error(`tunnel on ${Wt.platform()+Wt.arch()} platform is not supported.`);let r=`${Dn}.zip`;await Je(`${cS}/${t}`,r),await ot(r,Dn)}static async chmodLtTunnel(e){if(!(Wt.platform()==="win32"||!await ye(e))){try{await xo.access(e,Rg.constants.X_OK);return}catch{}try{await xo.chmod(e,"777")}catch(r){throw Ln.error("Failed to make LT tunnel executable",{e:r}),r}}}static async delay(e){await ue(e)}static async connectTunnel(e){if(e.externalLambdatestTunnelId){ne.tunnelName=e.externalLambdatestTunnelId;return}await this.prepareTunnel();let t=await Eg.getPortPromise(),{gridData:r={},gridUsername:n,gridPassword:i,externalLambdatestNTLMTunnelUsername:o,externalLambdatestNTLMTunnelPassword:a}=e,c=global.proxyUri;ne.tunnelName=re();let l=["--tunnelName",ne.tunnelName,"--infoAPIPort",String(t)];if(O.flags.enableLambdaTestTunnelNTLM.isEnabled())if(l=[...l,"--ntlm"],o&&a)l=[...l,"--ntlm-username",o,"--ntlm-password",a];else{let u=JSON.parse(O.flags.addCustomLTtunnelNTLMOptions.getValue());u&&(l=[...l,...Vc(u)])}if(O.flags.enableLambdaTestTunnelSkipUpgrade.isEnabled()&&(l=[...l,"--skip-upgrade"]),e.externalLambdatestUseWss&&(l=[...l,"--mode","ws"]),e.externalLambdatestDisableAutomationTunneling&&(l=[...l,"--bypassHosts","run.testim.io,services.testim.io,api.coralogix.com,conf.rollout.io,statestore.rollout.io,push.rollout.io,analytic.rollout.io"]),r.tunnelUser&&r.tunnelKey)l=[...l,"--user",r.tunnelUser,"--key",r.tunnelKey];else if(n&&i)l=[...l,"--user",n,"--key",i];else throw new A("tunnel requires username and password");if(c)try{let u=new URL(c);l=[...l,"--proxy-host",u.hostname],u.port&&(l=[...l,"--proxy-port",u.port]),u.username&&u.password&&(l=[...l,"--proxy-user",u.username,"--proxy-pass",u.password])}catch{throw new A("proxy url is invalid")}e.externalLambdatestMitm&&(l=[...l,"--mitm"]),await ne.delay(3e3),await ne.chmodLtTunnel((0,xg.join)(Dn,"LT")),ne.tunnel=Ig.spawn("./LT",l,{cwd:Dn});let d="",m="";ne.tunnel.stdout.on("data",u=>{d+=u.toString()}),ne.tunnel.stderr.on("data",u=>{m+=u.toString()});try{let u=await(0,Sg.default)(()=>Te(`http://127.0.0.1:${t}/api/v1.0/info`,{},{},void 0,{skipProxy:!0}),{onFailedAttempt:f=>{if(d.includes("Invalid Credentials"))throw Object.assign(f,{isInvalidCredsForLT:!0})},retries:30,minTimeout:2e3});Ln.info("LT tunnel info",u)}catch(u){throw Object.assign(u,{stdoutResult:d,stderrResult:m}),Ln.error("Failed to start LT tunnel",{err:u}),u}}static async disconnectTunnel(e){if(!(e.externalLambdatestTunnelId||!ne.tunnel))return new Promise((t,r)=>{ne.tunnel.on("close",n=>{n&&r(new Error(`tunnel process exited with code ${n}`)),t()}),ne.tunnel.kill()})}getCapabilities(e,t,r,n,i,o,a,c){var T,w;if(!this.isActive)return{};let l=ne.lambdatestConfig.CAPABILITIES[t]||{},d={...ne.tunnelName&&{tunnel:!0,tunnelName:ne.tunnelName}},m=[],{canary:u,ext:f,extensionPath:h,installCustomExtension:g}=e,y={platform:wg(n,a==null?void 0:a.os)||wg(n,(T=o==null?void 0:o.lt)==null?void 0:T.platform)||l.platform||ne.lambdatestConfig.PLATFORM,resolution:ne.lambdatestConfig.RESOLUTION??dS,version:t==="safari"&&((w=o==null?void 0:o.lt)==null?void 0:w.safari_version)||l.version};if(c!==K.APPIUM&&c!==K.SELENIUM&&!f){let b=iu({canary:u},!0);!h&&b[t]&&(m=[...m,b[t]]),h&&Le(h)&&(m=[...m,h]),m.length||Ln.warn("No extension was loaded in LambdaTestService",{extUrls:b,extensionPath:h})}return O.flags.enableFixForCustomExtensionForLT.isEnabled()&&g&&Le(g)&&(m=[...m,g]),{build:r,name:`${n} - ${i}`,selenium_version:ne.lambdatestConfig.SELENIUM_VERSION,timezone:ne.lambdatestConfig.TIMEZONE,...l,...y,loadExtension:m,...d,console:!0,queueTimeout:300,network:O.flags.LTNetworkCapabilities.isEnabled(),ntlm:O.flags.enableLambdaTestTunnelNTLM.isEnabled(),skipBinaryUpgrade:O.flags.enableLambdaTestTunnelSkipUpgrade.isEnabled()}}},mS=new Set(["Linux","Windows 10","Windows 11","macOS Sonoma","macOS Ventura","macOS Monterey","macOS Catalina","macOS Big Sur"])});function gS(s,e){let t={browserName:"safari",...e==="safari technology preview"&&{"safari.options":{technologyPreview:!0}}};return Object.assign(s.desiredCapabilities,t),s}function Dg(s){return kg.readFileSync(s,{encoding:"base64"})}function Ng(s,e,t){if(!(t!=null&&t.isLambdatestRun()&&Le(s))&&s){let r=Dg(s);ys.info(`adding extension: custom, path: ${s} length: ${r.length} hash: ${lu(r)} current extension count: ${e.length}`),e.push(r)}}function Mg(s,e,t,r,n){if(n!=null&&n.isLambdatestRun())return;let i=s.testimHeadlessExtensionDownloadUrl;if((s.ext||r)&&!i){let d=typeof s.ext=="string"?s.ext:`${__dirname}/..`,m=r||d,u=`--load-extension=${m}`;ys.info(`adding extension: testim unpacked , path: ${m}`),t.push(u);return}let a=`testim-headless${s.canary?"-master.zip":".zip"}`;!s.extensionPath&&i&&(a=Co.basename(i));let c=Co.join(process.cwd(),a),l=Dg(c);ys.info(`adding extension: testim zipped, path: ${c} length: ${l.length} hash: ${lu(l)} current extension count: ${e.length}`),e.push(l)}function hS(s,e,t,r,n,i,o,a){var g,y;let c=t.seleniumName||t.browserValue,l=[],d=[...Lg];e.headless&&d.push("--headless");let m={prefs:{"profile.default_content_setting_values.popups":au.CONTENT_SETTING_ALLOW,"profile.default_content_setting_values.automatic_downloads":au.CONTENT_SETTING_ALLOW,"plugins.always_open_pdf_externally":!0,"safebrowsing.enabled":!0,"profile.content_settings.exceptions.clipboard":{"[*.],*":{last_modified:Date.now(),setting:1}},"download.allow_office_viewer_for_download":!1,"profile.password_manager_leak_detection":!1},w3c:!0};if(cu(n)){let T=O.flags.DFAcceptInsecureOrigins.getValue();typeof T=="string"&&d.push(`--unsafely-treat-insecure-origin-as-secure=${T}`),m.prefs["download.default_directory"]="C:\\Users\\testnode",s.desiredCapabilities.version=O.flags.DFBrowserVersion.getValue(),s.desiredCapabilities["aws:maxDurationSecs"]=2400,s.desiredCapabilities["aws:idleTimeoutSecs"]=60}cu(n)&&c==="MicrosoftEdge"&&(s.desiredCapabilities["ms:edgeChromium"]=!0),e.chromeExtraPrefs&&Object.assign(m.prefs,e.chromeExtraPrefs),e.chromeExtraArgs&&e.chromeExtraArgs.forEach(T=>d.push(`--${T}`));try{let T=Po();T.length&&T.forEach(w=>d.push(`--disable-features=${w}`))}catch{}e.chromeBlockLocation&&(m.prefs["profile.default_content_setting_values.geolocation"]=au.CONTENT_SETTING_BLOCK),e.chromeUserDataDir&&d.push(`--user-data-dir=${e.chromeUserDataDir}`),(y=(g=e.projectData)==null?void 0:g.defaults)!=null&&y.disableChromiumGpu&&d.push("--disable-gpu"),Object.assign(s.desiredCapabilities,{browserName:c});function u(){t.mobileEmulation&&(m.mobileEmulation={deviceMetrics:{width:t.mobileEmulation.device.width,height:t.mobileEmulation.device.height+Uc.MOBILE_WEB_REMOTE_RUN_HEADER_SPACING,pixelRatio:t.mobileEmulation.device.deviceScaleFactor},userAgent:t.mobileEmulation.userAgent})}u(),Ng(r,l,o),a===K.EXTENSION&&Mg(e,l,d,i,o),l.length>0&&(m.extensions=l),e.disableCookiesSameSiteNoneRequiresSecure&&(m.localState={"browser.enabled_labs_experiments":["cookies-without-same-site-must-be-secure@2"]}),m.args=d;let f={MicrosoftEdge:"edgeOptions",chrome:"chromeOptions"}[c],h={MicrosoftEdge:"ms",chrome:"goog"}[c];return ne.isLambdatestGrid(n)&&delete m.w3c,e.oldCapabilities&&n.type!=="testimEnterprise"&&!(o!=null&&o.isLambdatestRun())&&(s.desiredCapabilities[f]=m),(e.w3cCapabilities||n.type==="testimEnterprise")&&(s.desiredCapabilities[`${h}:${f}`]=m),s}function bS(s,e,t){let r={"pdfjs.disabled":!0};return O.flags.autoSaveDownloadFileFireFox.isEnabled()&&Object.assign(r,{"browser.helperApps.neverAsk.saveToDisk":Cg.join(","),"browser.helperApps.neverAsk.openFile":Cg.join(","),"browser.helperApps.alwaysAsk.force":!1,"browser.download.manager.useWindow":!1,"browser.download.manager.focusWhenStarting":!1,"browser.download.manager.alertOnEXEOpen":!1,"browser.download.manager.showWhenStarting":!1,"browser.download.manager.closeWhenDone":!0,"browser.download.manager.showAlertOnComplete":!1}),Object.assign(s.desiredCapabilities,{acceptInsecureCerts:!0,browserName:"firefox",marionette:!0,"moz:firefoxOptions":{prefs:r}},t!=null&&t.isLambdatestRun()?{enableCustomTranslation:!0}:{}),e.disableCookiesSameSiteNoneRequiresSecure&&(s.desiredCapabilities["moz:firefoxOptions"].prefs["network.cookie.sameSite.noneRequiresSecure"]=!1),e.headless&&(s.desiredCapabilities["moz:firefoxOptions"].args||(s.desiredCapabilities["moz:firefoxOptions"].args=[]),s.desiredCapabilities["moz:firefoxOptions"].args.push("-headless")),s}function hs(s){return`${s.width}x${s.height}`}function IS(s){let{platform:e}=s;if(!e)return hs(Pg);let t=e.split(" ")[1];return e.startsWith("Windows")&&ES.has(t)?hs(wS):e==="Linux"?hs(TS):e.startsWith("macOS")?hs(vS):hs(e==="OS X El Capitan"||e==="OS X Yosemite"?SS:Pg)}function RS(s,e,t){let{saucelabs:r}=s;if(r!=null&&r.browserVersion&&(r.version=r.browserVersion),r!=null&&r.username&&r.accessKey){let n={"sauce:options":{name:e}};if(n["sauce:options"].screenResolution=IS(t.sl),t){t.sl.version=t.browserValue==="safari"?t.sl.safari_version:t.sl.version,t.sl.appiumVersion=r.appiumVersion||t.sl.appiumVersion;let i=(0,_g.cloneDeep)(t.sl);return delete i.screenResolution,t.browserValue!=="safari"&&delete i.safari_version,pt.merge(i,n,r)}return pt.merge(n,r)}return{}}function xS(s){let{runnerOptions:e}=s;if(pt.isEmpty(e.browserstack))return{};let{projectData:t,testRunConfig:r,testId:n,testName:i,executionId:o,executionName:a}=s,c={buildName:`${a} - ${o}`,sessionName:`${i} - ${n}`,projectName:`${t.name} - ${t.projectId}`,...e.browserstack};return r?(r.bs.browser_version=r.browserValue==="safari"?r.bs.safari_version:r.bs.browser_version,r.browserValue==="safari"&&r.bs.safari_version==="10"&&Object.assign(r.bs,{"safari.options":{technologyPreview:!0}}),{...c,...r.bs}):c}function AS(s){return s.perfecto?s.perfecto:{}}function CS(s,e,t){if(s.experitestToken){let r=e==="safari";return{accessKey:s.experitestToken,browserVersion:"latest",platformName:r?"MAC":"WIN10",seleniumScreenshot:r,newSessionWaitTimeout:t}}return{}}function PS(s,e={}){let{gridData:t={},gridUsername:r,gridPassword:n}=s,i=r||t.user||e.user,o=n||t.key||e.key,a={};return i&&o&&(a.Authorization=uc(i,o)),a}function Po(){return(O.flags.chromeArgsDisableFeatures.getValue()||"").split(",").filter(s=>s.trim().length)}function ko(s){var k,D,G,x;let{overrideConfiguration:e,browserOptions:t,testId:r,testName:n,testRunConfig:i,gridInfo:o,customExtensionLocalLocation:a,executionId:c,executionName:l,projectData:d,testResultId:m,lambdatestService:u,mode:f}=s;if(o.mode==="local"){let R=[],L=[...Lg],M={};t.headless&&L.push("--headless"),t.silentDebuggerExtensionApi&&L.push("--silent-debugger-extension-api"),t.remoteDebuggingPort!==void 0&&L.push(`--remote-debugging-port=${t.remoteDebuggingPort}`);try{let V=Po();V.length&&V.forEach(W=>L.push(`--disable-features=${W}`))}catch{}return t.chromeExtraArgs&&t.chromeExtraArgs.forEach(V=>L.push(`--${V}`)),t.chromeBinaryLocation&&(M.binary=t.chromeBinaryLocation),f!==K.SELENIUM&&Mg(t,R,L,null,u),Ng(a,R,u),{logLevel:Ag,capabilities:{alwaysMatch:{"goog:chromeOptions":{args:L,extensions:R,...M},browserName:"chrome"},firstMatch:[{}]},path:"/wd/hub",hostname:"localhost",port:9515}}let{driverRequestTimeout:h,driverRequestRetries:g}=t,y=PS(t,o),T={hostname:o.host,host:o.host,port:o.port||4444,path:o.path||"/wd/hub",protocol:o.protocol||"http",logLevel:Ag,connectionRetryTimeout:h,connectionRetryCount:g,getSessionTimeout:Math.max(u.getSessionTimeout,t.getSessionTimeout),getSessionRetries:u.getSessionRetries||t.getSessionRetries,deprecationWarnings:!1,desiredCapabilities:{acceptSslCerts:!0,unexpectedAlertBehaviour:"accept"},...!pt.isEmpty(y)&&{headers:y},...t.proxyForGrid&&{agent:new global.ProxyAgent(global.proxyUri)}};cu(o)&&(t.oldCapabilities=!1,t.w3cCapabilities=!0,T.desiredCapabilities={unexpectedAlertBehaviour:"accept"}),t.disableNativeEvents&&(T.desiredCapabilities.nativeEvents=!1),o.user&&o.key&&(o.type==="saucelabs"&&(t.saucelabs||={},t.saucelabs.username||=o.user,t.saucelabs.accessKey||=o.key),o.type==="browserstack"&&(t.browserstack||={},t.browserstack["browserstack.user"]||=o.user,t.browserstack["browserstack.key"]||=o.key)),o.key&&o.type==="perfecto"&&(t.perfecto.securityToken=o.key);let w=Number(t.browserTimeout/1e3),b=t.browser||(i==null?void 0:i.browserValue),S={runnerOptions:t,testId:r,testName:n,testRunConfig:i,executionId:c,executionName:l,projectData:d};pt.merge(T.desiredCapabilities,RS(t,n,i),xS(S),AS(t),CS(t,b,w),u==null?void 0:u.getCapabilities(t,b,c,m,n,i,e,f));let E=null;switch(!t.ext&&!t.extensionPath&&((k=o.host)!=null&&k.endsWith(".testim.io"))&&!t.canary&&f===K.EXTENSION&&(b==="chrome"||b==="edge-chromium"&&O.flags.sendExtensionOnEdgeNonLinux.isEnabled())&&(E="/opt/testim-headless"),b){case"chrome":case"edge-chromium":T=yS(T,t,i,a,o,E,u,f);break;case"firefox":T=bS(T,t,u);break;case"safari":case"safari technology preview":T=gS(T,b);break;default:break}pt.merge(T.desiredCapabilities,t.seleniumCapsFileContent);try{let R={"hub.lambdatest.com":"lambdatest",[O.flags.publicGridURL.getValue()]:"testim","testgrid-devicefarm.us-west-2.amazonaws.com":"devicefarm"},L=q=>q[o.provider]||q[T.host]||q[R[T.host]],M=q=>{var ie,Ee;return L(q)||q[(ie=T.desiredCapabilities)==null?void 0:ie.browserName]||q[(Ee=T.desiredCapabilities)==null?void 0:Ee.version]||q||{}},V=JSON.parse(O.flags.addCustomCapabilities.getValue()||"{}"),W=M(M(V));Object.keys(W).length&&(ys.info(`Adding custom capabilities: ${JSON.stringify(W)}`),Object.assign(T.desiredCapabilities,W))}catch(R){ys.error("Failed to load custom capabilities",{error:R,customCapabilities:O.flags.addCustomCapabilities.getValue()})}if(T.desiredCapabilities&&!T.capabilities&&(fS(T),T.capabilities={alwaysMatch:T.desiredCapabilities,firstMatch:[{}]},delete T.desiredCapabilities),T.hostname=T.host,s.printFinalCaps){let R=(D=T.capabilities)==null?void 0:D.alwaysMatch,L=JSON.parse(JSON.stringify(T)),M=(G=L==null?void 0:L.capabilities)==null?void 0:G.alwaysMatch,V=q=>q.substring(0,80);["goog:chromeOptions","ms:edgeOptions"].forEach(q=>{var ie,Ee;M!=null&&M[q]&&(M[q].extensions=(Ee=(ie=R==null?void 0:R[q])==null?void 0:ie.extensions)==null?void 0:Ee.map(V))}),M!=null&&M.loadExtension&&(M.loadExtension=(x=R==null?void 0:R.loadExtension)==null?void 0:x.map(V));let W=require("node:util");console.log(W.inspect(L,{showHidden:!1,depth:null,colors:!0}))}return T}var kg,Co,Og,pt,_g,ys,Ag,au,Lg,lu,cu,fS,yS,Cg,Pg,TS,wS,vS,SS,ES,Oo=v(()=>{"use strict";kg=I(require("node:fs")),Co=I(require("node:path")),Og=I(require("node:crypto")),pt=I(require("lodash"));B();ae();$();de();oe();Ao();_g=require("lodash"),ys=C("testim-desired-capabilities-builder"),Ag=Ti?"debug":"silent",au={CONTENT_SETTING_DEFAULT:0,CONTENT_SETTING_ALLOW:1,CONTENT_SETTING_BLOCK:2,CONTENT_SETTING_ASK:3},Lg=["--disable-popup-blocking","--ignore-gpu-blacklist","--auto-select-desktop-capture-source=Entire screen","--ignore-certificate-errors","--disable-features=TranslateUI","--disable-background-networking","--disable-sync","--metrics-recording-only","--disable-default-apps","--mute-audio","--no-first-run","--disable-back-forward-cache"],lu=(...s)=>Og.createHash("sha256").update(s.join("")).digest("hex"),cu=s=>s.type===_.DEVICE_FARM||s.type===_.HYBRID&&s.provider==="devicefarm",fS=s=>{var r;let{desiredCapabilities:e}=s;Object.hasOwn(e,"version")&&(e.browserVersion=e.version,delete e.version),Object.hasOwn(e,"platform")&&(e.platformName=e.platform,delete e.platform),Object.hasOwn(e,"acceptSslCerts")&&(e.acceptInsecureCerts=e.acceptSslCerts,delete e.acceptSslCerts),Object.hasOwn(e,"unexpectedAlertBehaviour")&&(e.unhandledPromptBehavior=e.unexpectedAlertBehaviour,delete e.unexpectedAlertBehaviour),Object.hasOwn(e,"chromeOptions")&&(e["goog:chromeOptions"]??=e.chromeOptions,delete e.chromeOptions),Object.hasOwn(e,"edgeOptions")&&(e["ms:edgeOptions"]??=e.edgeOptions,delete e.edgeOptions),Object.hasOwn(e,"firefoxOptions")&&(e["moz:firefoxOptions"]??=e.firefoxOptions,delete e.firefoxOptions),((r=e["goog:chromeOptions"])==null?void 0:r.w3c)===!1&&(e["goog:chromeOptions"].w3c=!0),"username"in s.desiredCapabilities&&(s.user=s.desiredCapabilities.username,delete s.desiredCapabilities.username),"accessKey"in s.desiredCapabilities&&(s.key=s.desiredCapabilities.accessKey,delete s.desiredCapabilities.accessKey);let t;try{t=O.flags.unsupportedCapsFields.getValue();let n=JSON.parse(t);if(!Array.isArray(n))return;n.forEach(i=>{delete e[i]})}catch{ys.error('Fail to parse "unsupportedCapsFields" flag',{unsupportedCapsFields:t})}};yS=pt.memoize(hS,(s,e,t,r,n,i)=>{let o=JSON.stringify(s.desiredCapabilities),a=JSON.stringify(pt.omit(e,"runParams")),c=JSON.stringify(t),l=JSON.stringify(n.type);return lu(o,a,c,r,l,i)}),Cg=["application/force-download","application/pdf","application/x-pdf","application/acrobat","applications/vnd.pdf","text/pdf","text/x-pdf","application/vnd.cups-pdf"];Pg={width:1920,height:1080},TS={width:1920,height:1200},wS={width:2560,height:1600},vS={width:2360,height:1770},SS={width:2048,height:1536},ES=new Set(["7","8","8.1","10","11"])});function Fe(s){var e,t,r,n,i,o,a,c;return((e=s.message)==null?void 0:e.match(/Command not found/))||s.message==="HTTP method not allowed"||((t=s.message)==null?void 0:t.toLowerCase())==="unknown error"||((r=s.message)==null?void 0:r.match(/Unknown timeout type/))||s.name==="unknown command"||((n=s.message)==null?void 0:n.match(/did not match a known command/))||((i=s.message)==null?void 0:i.match(/Server returned HTTP response code: 405 for URL/))||((o=s.seleniumStack)==null?void 0:o.message)==="The arguments passed to a command are either invalid or malformed."||((a=s.message)==null?void 0:a.match(/Invalid timeout type specified: ms/))||((c=s.message)==null?void 0:c.match(/\.\w* is not a function/))}function Fg(s,e,t){if(!e||!s)return s;if(s.includes("%"))return s.replace(/ /g,"%20");try{return decodeURI(s)!==s?s:encodeURI(s)}catch(r){return t&&t.warn("tried to encode url but failed",{err:r,url:s}),s}}var uu=v(()=>{"use strict"});function pu(s){function e(u){return u?[Node.ELEMENT_NODE,Node.DOCUMENT_NODE,Node.DOCUMENT_FRAGMENT_NODE].includes(u.nodeType):!1}function t(u){return u?r(u.parentNode,e):null}function r(u,f){for(let h=u;h&&h!==u.ownerDocument;h=h.parentNode)if(f(h))return h;return null}function n(u,f){for(let h=u;h&&h!==u.ownerDocument;h=t(h))if(f(h))return h;return null}function i(u,f){if(!u||!f)return null;u instanceof DocumentFragment&&(u=u.host);let g=window.getComputedStyle(u).getPropertyValue(f);if(g&&g!=="inherit")return g;let y=t(u);return i(y,f)}function o(u){let f=u.getBoundingClientRect();if(f.width>0&&f.height>0)return!0;if(u.tagName.toUpperCase()==="PATH"&&f.width+f.height>0){let g=i(u,"stroke-width");return!!g&&parseInt(g,10)>0}return i(u,"overflow")==="hidden"?!1:Array.from(u.childNodes).some(g=>g.nodeType===Node.TEXT_NODE?!0:e(g)?o(g):!1)}function a(u){return i(u,"overflow")==="hidden"}function c(u){return!u||!a(u)||!u.childNodes.length?!1:Array.from(u.childNodes).every(f=>f.nodeType===Node.TEXT_NODE?!1:!e(f)||!o(f)?!0:c(f))}function l(u){var f;return u?(f=u.parentNode)!=null&&f.host?!0:l(u.parentNode):!1}if(!s||!l(s)&&!document.contains(s))return!1;switch(s.tagName.toUpperCase()){case"BODY":return!0;case"SCRIPT":case"NOSCRIPT":return!1;case"OPTGROUP":case"OPTION":{let f=r(s,h=>h.tagName.toUpperCase()==="SELECT");return pu(f)}case"INPUT":if(s.type==="hidden")return!1;break;default:break}if(i(s,"visibility")!=="visible")return!1;let d=!!n(s,u=>Number(i(u,"opacity"))===0),m=!!n(s,u=>i(u,"display")==="none");return!(d||m||!o(s)||c(s))}var Bg=v(()=>{"use strict"});var jg,$g,Vt,kS,OS,_o,Wg=v(()=>{"use strict";jg=I(require("promise-queue")),$g=I(require("webdriverio"));ae();$e();B();$();Hr();Bg();uu();gs();Vt=C("WebDriverApi"),kS=function(){return{screenWidth:Math.floor(window.innerWidth||0),screenHeight:Math.floor(window.innerHeight||0)}},OS={implicit:0,pageLoad:1,script:2},_o=class{constructor(){this.unsupportedActions=new Set}get capabilities(){var e;return(e=this.client)==null?void 0:e.capabilities}get browserName(){var e;return this.capabilities&&"browserName"in this.capabilities&&((e=this.capabilities.browserName)==null?void 0:e.toLocaleLowerCase())||void 0}windowHandleMaximize(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.maximizeWindow()})}async rejectWithLog(e,t){let{testName:r,testResultId:n}=this,i=t?t.toString().slice(0,2e3):"";throw Vt.warn("error from selenium",{err:e,testResultId:n,testName:r,crashingFunc:i}),e}initQueueRequests(){let e=1/0;this.isAndroid()&&(e=1),fc!==void 0&&(e=fc);let t=1/0;this.queue=new jg.default(e,t)}async addToQueue(e){var r,n;let t=(r=this.seleniumPerfStats)==null?void 0:r.markStart();try{return await this.queue.add(e)}catch(i){return this.rejectWithLog(i,e)}finally{(n=this.seleniumPerfStats)==null||n.markEnd(t)}}async initClient(e,t,r){var o,a,c,l,d,m,u,f;this.testName=t,this.testResultId=r,e.deprecationWarnings=!1,this.initQueueRequests(),U("right before addToQueue");let n=((o=e.capabilities.alwaysMatch)==null?void 0:o.loadExtension)||((a=e.capabilities.alwaysMatch)==null?void 0:a.loadExt)||((m=(d=(l=(c=e.capabilities.alwaysMatch)==null?void 0:c["goog:chromeOptions"])==null?void 0:l.extensions)==null?void 0:d[0])==null?void 0:m.slice(0,80)),i=(u=this.seleniumPerfStats)==null?void 0:u.markStart(Ce.GET_BROWSER);try{await this.addToQueue(async()=>{Vt.info("requesting browser",{testResultId:r,testName:t,extUrl:n}),U("before this.client.init"),e.headers||={},e.headers["Test-Result-Id"]=r??"",this.client=await $g.remote(e),this.logGridStatus(r)}),U("after client init")}finally{(f=this.seleniumPerfStats)==null||f.markEnd(i,Ce.GET_BROWSER)}}async logGridStatus(e){var o;if(!this.client)return;let{sessionId:t}=this.client,r="N/A",n="N/A",i;try{i=await this.client.status();for(let a of i.nodes||[])for(let c of a.slots||[])if(((o=c==null?void 0:c.session)==null?void 0:o.sessionId)===t){r=a,n=c;break}}catch(a){if(a.message==="unknown error"){Vt.info("grid status is not supported by the grid",{testResultId:e});return}Vt.error("failed to get grid status",{error:a,testResultId:e});return}r&&typeof r=="object"&&"slots"in r&&(r==null||delete r.slots),Vt.info("grid status",{gridStatusMsg:i.message,ready:i.ready,browserNode:r,gridSlot:n,testResultId:e})}get isMobile(){var e;return(e=this.client)==null?void 0:e.isMobile}getSessionId(){var e;return(e=this.client)==null?void 0:e.sessionId}isChrome(){return this.browserName==="chrome"}isChromium(){return this.isChrome()||this.isEdgeChromium()}isFirefox(){return this.browserName==="firefox"}isSafari(){return this.browserName==="safari"||this.browserName==="safari technology preview"}isAndroid(){var e;return this.capabilities&&"platformName"in this.capabilities&&((e=this.capabilities.platformName)==null?void 0:e.toLocaleLowerCase())==="android"}isEdgeChromium(){let e=this.capabilities&&"_isOldEdge"in this.capabilities&&this.capabilities._isOldEdge;return this.browserName==="microsoftedge"&&!e}async execute(e,...t){return{value:await this.addToQueue(async()=>{if(typeof e!="string"&&typeof e!="function")throw new TypeError("number or type of arguments don't agree with execute protocol command");typeof e=="function"&&(e=`return (${e}).apply(null, arguments)`);let n=a=>{throw Object.assign(a,{executedScript:e}),a},i=()=>this.client.execute(e,t).catch(n),o=()=>this.client.executeScript(e,t).catch(n);if(this.unsupportedActions.has("execute"))return i();t=t.map(a=>{if(a===null){Vt.warn('The function "executeScript" in webdriverio can no longer accept "null" as an argument, it was replaced with "undefined"',{script:e,args:t});return}return a});try{return await o()}catch(a){if(Fe(a))return this.unsupportedActions.add("execute"),i();throw a}})}}async executeAsync(e,...t){return{value:await this.addToQueue(async()=>{if(typeof e!="string"&&typeof e!="function")throw new TypeError("number or type of arguments don't agree with execute protocol command");typeof e=="function"&&(e=`return (${e}).apply(null, arguments)`);let n=()=>this.client.executeAsync(e,...t),i=()=>this.client.executeAsyncScript(e,t);if(this.unsupportedActions.has("executeAsync"))return n();try{return await i()}catch(o){if(Fe(o))return this.unsupportedActions.add("executeAsync"),n();throw o}})}}async executeCDP(e,t={}){var n;if(!this.isChromium())return;let r=await((n=this.client)==null?void 0:n.sendCommandAndGetResult(e,t));return r!=null&&r.targetInfos?r.targetInfos:[]}async takeScreenshot(){var t,r;let e=(t=this.seleniumPerfStats)==null?void 0:t.markStart(Ce.GET_SCREENSHOT);try{return{value:await this.addToQueue(()=>{var i;return(i=this.client)==null?void 0:i.takeScreenshot()})}}finally{(r=this.seleniumPerfStats)==null||r.markEnd(e,Ce.GET_SCREENSHOT)}}async takeElementScreenshot(e){let t=this.seleniumPerfStats.markStart(Ce.GET_SCREENSHOT);try{return await this.addToQueue(()=>this.client.takeElementScreenshot(De(e)))}finally{this.seleniumPerfStats.markEnd(t,Ce.GET_SCREENSHOT)}}async getElementBySelector(e){return{value:await this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.$(e)})}}elementIdDisplayed(e){return this.addToQueue(async()=>{let t=()=>this.client.isElementDisplayed(e).then(n=>({value:n})),r=()=>this.execute(pu,{ELEMENT:e,[qt]:e});if(this.unsupportedActions.has("elementIdDisplayed"))return r();try{return await t()}catch(n){if(Fe(n))return this.unsupportedActions.add("elementIdDisplayed"),r();throw n}})}windowHandles(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.getWindowHandles().then(t=>({value:t}))})}async url(e){if(e)return await this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.url(Fg(e,this.isSafari(),Vt))})}reloadTab(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.refresh()})}source(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.getPageSource()})}timeouts(e,t){return this.addToQueue(async()=>{let r=()=>{let i=[];return i[OS[e]]=t,this.client.setTimeouts(...i)},n=()=>this.client.setTimeout({[e]:t});if(this.unsupportedActions.has("timeouts"))return n();try{return await r()}catch(i){if(Fe(i))return this.unsupportedActions.add("timeouts"),n();throw i}})}scroll(e,t){e=typeof e=="number"?e:0,t=typeof t=="number"?t:0;let r=function(n,i){window.scrollTo(n,i)};return this.execute(r,e,t)}async setValue(e,t){return await this.elementIdClear(De(e)),await this.elementIdValue(De(e),t)}async getViewportSize(e){let t=await this.execute(kS);if(typeof e=="string"&&/(width|height)/.test(e)){let r=`screen${e.slice(0,1).toUpperCase()}${e.slice(1)}`;return t.value[r]}return{width:t.value.screenWidth||0,height:t.value.screenHeight||0}}async elementIdValue(e,t){let r=Array.isArray(t)?t.join():t;return{value:await this.addToQueue(()=>{var i;return(i=this.client)==null?void 0:i.elementSendKeys(e,r)})}}elementIdClear(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.elementClear(e)})}submitForm(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.elementSubmit(De(e))})}submitFormManually(e){return this.addToQueue(async()=>{var i;let t=await((i=this.client)==null?void 0:i.$(e)),r=await t.$('button[type="submit"]');return await r.isExisting()?r.click():(await t.$("input:last-of-type")).keys("Enter")})}async findElementAndPress(e,t,r){return{value:await this.addToQueue(()=>{var i;return(i=this.client)==null?void 0:i.$(e).click({x:Math.floor(t.clickOffset.x),y:Math.floor(t.clickOffset.y),button:r})})}}_rightClick(e,t){return this.findElementAndPress(e,t,"right")}_leftClick(e,t){return this.findElementAndPress(e,t,"left")}elementIdClick(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.elementClick(e)})}sendKeyboardShortcut(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.keys(e)})}async actions(e){return{value:await this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.performActions(e)})}}async doDoubleClick(e){return{value:await this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.$(e).doubleClick()})}}async _dragAndDrop(e,t){return{value:await this.addToQueue(()=>{var n;return(n=this.client)==null?void 0:n.$(e).dragAndDrop(t)})}}async buttonDown(){return{value:await this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.buttonDown()})}}async buttonUp(){return{value:await this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.buttonUp()})}}moveTo(e,t,r){let n={...typeof t=="number"&&{xOffset:t},...typeof r=="number"&&{yOffset:r}};return this.isSafari()&&!Object.hasOwn(n,"yoffset")&&(n.yOffset=1),this.isSafari()&&!Object.hasOwn(n,"xoffset")&&(n.xOffset=1),this.addToQueue(async()=>{if(!this.client)throw new Error("The client is not initialized");let i=await this.client.$(e);await this.client.action("pointer").move({origin:i}).perform()})}async uploadFile(e){return{value:await this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.uploadFile(e)})}}getUrl(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.getUrl()})}getTitle(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.getTitle()})}async windowHandleSize(e){return{value:await this.addToQueue(async()=>{let r=async()=>await this.client.getWindowSize(),n=async()=>await this.client._getWindowSize();if(e!=null&&e.width&&(e!=null&&e.height)){let i=Math.abs(e.width),o=Math.abs(e.height);r=async()=>await this.client.setWindowSize(i,o),n=async()=>await this.client._setWindowSize(i,o)}if(this.unsupportedActions.has("windowHandleSize"))return r();try{return await n()}catch(i){if(Fe(i))return this.unsupportedActions.add("windowHandleSize"),r();throw i}})}}setCookie(e,t,r,n,i,o,a){return this.addToQueue(()=>{var c;return(c=this.client)==null?void 0:c.setCookies({name:e,value:t,domain:r,httpOnly:n,secure:i,path:o,expiry:a&&Math.floor(a)})})}getCookie(e){return this.addToQueue(async()=>{var r;return(await((r=this.client)==null?void 0:r.getCookies(e))??[])||(typeof e=="string"?null:[])})}deleteCookie(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.deleteCookie(e)})}isVisibleWithinViewport(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.$(e).isDisplayedInViewport()})}getCurrentTabId(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.getWindowHandle()})}frame(e=null){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.switchToFrame(e)})}switchTab(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.switchToWindow(e)})}alertAccept(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.acceptAlert()})}log(e="browser"){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.getLogs(e)})}async end(){try{this.client&&await this.executeAsync(async e=>{var t,r;await((r=(t=window.TSTA)==null?void 0:t.gracefulShutdown)==null?void 0:r.call(t)),e(!0)})}catch(e){Vt.warn("error while trying to shutdown gracefully",{error:e})}if(this.unsupportedActions.clear(),!!this.queue)return await this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.deleteSession()})}async forceEnd(){if(this.unsupportedActions.clear(),!!this.client)return await this.client.deleteSession()}touchAction(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.touchAction(e)})}pressKeycode(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.pressKeyCode(e)})}setImmediateValue(e,t){return this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.setValueImmediate(e,t)})}elementIdText(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.getElementText(e)})}async isAppInstalled(e){let t=await this.addToQueue(()=>{var r;return(r=this.client)==null?void 0:r.isAppInstalled(e)});return Vt.info(`is app (${e}) installed?`,{isInstalled:t}),{value:t}}launch(){return this.addToQueue(()=>{var e;return(e=this.client)==null?void 0:e.launchApp()})}context(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.switchContext(e)})}elementIdLocation(e){return this.addToQueue(()=>{var t;return(t=this.client)==null?void 0:t.getElementLocation(e)})}}});var rr={};z(rr,{getSessionPlayer:()=>Z,options:()=>mu});var Lo,mu,du,Z,we=v(()=>{"use strict";Lo=require("path");$();mu={playerPath:void 0},Z=()=>{if(du)return du;let s=($e(),qe(je));s.log("getSessionPlayerRequire start");let{getSessionPlayerFolder:e}=(un(),qe(ln)),t=e(),r=mu.playerPath?(0,Lo.resolve)(mu.playerPath,"src/background/sessionPlayerInit.ts"):(0,Lo.join)(t,"sessionPlayer.js"),n=require(r);return s.log("getSessionPlayerRequire end"),du=n,process.env.LOGGER_CONSOLE&&process.env.DEBUG&&n.setLoggerFormatter&&n.setLoggerFormatter(Jd),n}});var Vg={};z(Vg,{doubleClick:()=>_S});var _S,Gg=v(()=>{"use strict";_S=function(s,e){let t=["pointerup","pointerdown","pointermove"],r=getLocatedElement(s.locatedElement);if(!r)throw new Error("element not found");let n=s.events,i={status:"done",success:!0};window.__unloadNavigator=function(){e(i)};let o=function(u){function f(w,b,S){return S>w&&S<b}let h=u.pointerPosition||{},g=r.getBoundingClientRect(),y=h.originX&&f(g.left,g.left+g.width,h.originX)?h.originX:g.left+g.width/2,T=h.originY&&f(g.top,g.top+g.height,h.originY)?h.originY:g.top+g.height/2;return{x:y,y:T}},a=function(u,f){return{screenX:0,screenY:0,clientX:u,clientY:f,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,bubbles:!0,cancelable:!0,button:0,pointerType:"mouse",isPrimary:!0}},c=function(u,f,h){if(!window.PointerEvent)return;let g=a(f,h);return new window.PointerEvent(u,g)},l=function(u,f,h){let g=document.createEvent("MouseEvents");return g.initMouseEvent(u,!0,!0,document.defaultView,1,0,0,f,h,!1,!1,!1,!1,0,document.body?document.body.parentNode:document.documentElement),g},d=function(){var f;let u=document.activeElement;for(;(f=u.shadowRoot)!=null&&f.activeElement;)u=u.shadowRoot.activeElement;return u},m=function(u){let f=o(u),h=u.event;return t.includes(h)?c(h,f.x,f.y):l(h,f.x,f.y)};try{n.map(f=>m(f)).filter(Boolean).forEach(f=>r.dispatchEvent(f));let u=d();dispatchFocus(s.elementToFocusLocatedElement,u),window.__unloadNavigator&&(window.removeEventListener("unload",window.__unloadNavigator),window.__unloadNavigator=null),e(i)}catch(u){window.__unloadNavigator&&(window.removeEventListener("unload",window.__unloadNavigator),window.__unloadNavigator=null),e({status:"done",result:u.toString(),success:!1})}}});var Nn={};z(Nn,{dispatchFocus:()=>LS});function LS(s,e){function t(i){let o=document.createEvent("HTMLEvents");return o.initEvent(i,!0,!1),o}function r(){var o;let i=document.activeElement;for(;(o=i.shadowRoot)!=null&&o.activeElement;)i=i.shadowRoot.activeElement;return i}function n(i,o){o&&(o.dispatchEvent(t("focusout")),o.dispatchEvent(t("blur"))),i.dispatchEvent(t("focusin")),i.dispatchEvent(t("focus")),typeof i.focus=="function"&&i.focus();let a=r();o&&a===o&&typeof o.blur=="function"&&o.blur()}if(s){let i=getLocatedElement(s);if(i&&i!==e)try{n(i,e)}catch{}}else e&&typeof e.blur=="function"&&e.blur()}var Mn=v(()=>{"use strict"});var Jg={};z(Jg,{WebDriver:()=>_r});async function US(s){var e,t;try{let r=(t=(e=s==null?void 0:s.value)==null?void 0:e["goog:chromeOptions"])==null?void 0:t.debuggerAddress;return r?await NS(r):void 0}catch(r){Be.info("Error getting cdpAddress",r);return}}var bs,zg,Kg,Be,sr,DS,Hg,NS,kr,MS,qg,Or,_r,Un=v(()=>{"use strict";bs=I(require("lodash"));B();$e();Oo();zg=I(require("p-retry")),Kg=I(require("ua-parser-js"));Hr();$();uu();Wg();X();de();gs();Be=C("webdriver"),[sr,DS]=[0,2],{extractElementId:Hg,getCdpAddressForHost:NS}=Y,kr=()=>(we(),qe(rr)).getSessionPlayer().codeSnippets,MS=()=>(we(),qe(rr)).getSessionPlayer().locatorBuilderUtils,qg=()=>(we(),qe(rr)).getSessionPlayer().utils,Or=()=>(we(),qe(rr)).getSessionPlayer().positionUtils;_r=class extends _o{constructor(){super(...arguments);this.started=!1;this.keepAliveTimer=null;this._isAlive=!1;this._keepAliveRequests=[];this.browserClosedCallbacks=[];this.browserClosedFailedKeepAlives=0;this.ignoreHiddenTagsText=!1;this.browserAndOS=null;this.stopKeepAliveInterval=()=>{this.keepAliveTimer&&(this.unregisterToClosedBrowser(this.stopKeepAliveInterval),clearInterval(this.keepAliveTimer))}}getIgnoreVisibility(){return this.ignoreVisibility}setIgnoreVisibility(t){this.ignoreVisibility=t}registerToClosedBrowser(t){this.browserClosedCallbacks.push(t)}unregisterToClosedBrowser(t){this.browserClosedCallbacks=this.browserClosedCallbacks.filter(r=>r!==t)}async init(t){var k,D,G,x,R,L,M,V;let{projectData:r,overrideConfiguration:n,browserOptions:i,testId:o,testName:a,testRunConfig:c,gridInfo:l,customExtensionLocalLocation:d,executionId:m,executionName:u,testResultId:f,seleniumPerfStats:h,fastInit:g,lambdatestService:y,printFinalCaps:T,mode:w}=t;this.browserClosedFailedKeepAlives=0,this.ignoreHiddenTagsText=Boolean((G=(D=(k=i==null?void 0:i.company)==null?void 0:k.activePlan)==null?void 0:D.premiumFeatures)==null?void 0:G.ignoreHiddenTagsText),this.browserClosedCallbacks=[];let b=ko({projectData:r,browserOptions:i,testId:o,testName:a,testRunConfig:c,gridInfo:l,customExtensionLocalLocation:d,executionId:m,executionName:u,testResultId:f,lambdatestService:y,overrideConfiguration:n,printFinalCaps:T,mode:w});b.desiredCapabilities&&delete b.desiredCapabilities.marionette,b.capabilities&&delete b.capabilities.alwaysMatch.marionette,this.initUnsupportedActions(y==null?void 0:y.isLambdatestRun()),this.browserAndOS=null,this.seleniumPerfStats=h;let S=g?0:1500,E=g?()=>null:()=>this.executeJS("window.focus()");try{U("before initClient in webdriver.js init");let W=await this.initClient(b,a,f);U("after initResult before getCdpAddress in init"),this.cdpUrl=await US(W),U("after getCdpAddress in webdriver.js init"),Be.info(`init new session testName: ${a}`,{sessionId:this.getSessionId(),testResultId:f}),await ue(S),O.flags.dontFocusOnInit.isEnabled()||await E(),U("after focus and delay in webdriver.js init")}catch(W){let q=JSON.stringify(bs.omit(b,"extensions","capabilities.extensions","capabilities.capabilities.extensions","capabilities.alwaysMatch.goog:chromeOptions.extensions"));Be.error("failed to init webdriver",{err:W,capabilitiesAsString:q});let ie=((R=(x=i==null?void 0:i.company)==null?void 0:x.activePlan)==null?void 0:R.plan)==="free";throw(L=W.stack)!=null&&L.includes("at startWebDriverSession")&&((M=W.message)!=null&&M.startsWith("Failed to create session"))&&((V=W.message)!=null&&V.includes("Timeout awaiting 'request'"))&&ie?new Error("Our free grids are in full capacity, please try again or upgrade to our Professional plan"):/Invalid username or password/.test(W.message)?new zr(W.message):/capabilit(y|ies)/.test(W.message)?new Ii(W.message):/403 Forbidden/.test(W.message)?new Error("Grid Access Denied"):/Browser_Version not supported/.test(W.message)?new Error("Browser or Browser version not supported"):new Error(`Failed to init client driver: ${W.message}`)}}initUnsupportedActions(t){t&&this.unsupportedActions.add("move")}isAlive(){return this._isAlive}maxKeepAliveGap(){let t=i=>bs.zip(i.slice(0,-1),i.slice(1)),r=this._keepAliveRequests.map(({start:i})=>i).filter(Boolean),n=t(r).map(([i,o])=>o-i);return Math.max(...n)}isClosedBrowserError(t){return["session-not-found","no such window","invalid session id"].includes(t==null?void 0:t.name)?!0:["CLIENT_STOPPED_SESSION","BROWSER_TIMEOUT","was terminated due to TIMEOUT","window was already closed","chrome not reachable","not connected to DevTools"].some(n=>t.message.includes(n))}start(){if(this.started)return;this.started=!0;let t=async()=>{let r=a=>this._keepAliveRequests.push({start:Date.now(),id:a}),n=(a,c)=>{let l=this._keepAliveRequests.find(d=>d.id===c);l&&(l[a]=Date.now())};function i(){var a;return(a=window.getTestimStatus)==null?void 0:a.call(window)}if(this.queue.getQueueLength()>0)return;let o=re();r(o);try{await this.executeJS(i),this._isAlive=!0,n("end",o),this.browserClosedFailedKeepAlives=0}catch(a){if(n("error",o),a.name==="unexpected alert open"){this.browserClosedFailedKeepAlives=0,Be.warn("close unexpected alert open"),await this.alertAccept().catch(c=>Be.warn("failed to click on alert",{err:c}));return}if(Be.warn("err while getting testim status",{err:a,testResultId:this.testResultId}),this._isAlive=!1,this.isClosedBrowserError(a)){this.browserClosedFailedKeepAlives++;let c=3;Be.warn("browser was closed",{err:a,testResultId:this.testResultId,counter:this.browserClosedFailedKeepAlives,threshold:c,numOfCallbacks:this.browserClosedCallbacks.length}),this.browserClosedFailedKeepAlives>=c&&this.browserClosedCallbacks.forEach(l=>{try{l(a)}catch{}})}else this.browserClosedFailedKeepAlives=0}};this.keepAliveTimer=setInterval(t,1e4),this.registerToClosedBrowser(this.stopKeepAliveInterval)}async switchToLocatedFrame(t){let r=await this.getElement(t),n=Hg(r.value);return await this.switchToFrame({ELEMENT:n,[qt]:n}),r}switchToFrame(t){return this.frame(t)}async switchToTopFrame(){var t;try{return await this.frame()}catch(r){throw(t=r.message)!=null&&t.includes("ECONNREFUSED")?new Ri:r}}async getElement(t){var i;let r=this.seleniumPerfStats.markStart(Ce.GET_ELEMENT);if(typeof t=="string"||typeof t=="number")try{return await this.getElementBySelector(`[testim_dom_element_id='${t}']`)}finally{this.seleniumPerfStats.markEnd(r,Ce.GET_ELEMENT)}if(((i=t==null?void 0:t.shadowPath)==null?void 0:i.length)||O.flags.runGetElementCodeInAut.isEnabled()&&this.isSafari())try{return await this.execute(`
                        var fn = ${kr().getLocatedElementCode};
                        return fn.apply(null, arguments);
                    `,t)}finally{this.seleniumPerfStats.markEnd(r,Ce.GET_ELEMENT)}try{return await this.getElementBySelector(`[testim_dom_element_id='${t==null?void 0:t.testimId}']`)}finally{this.seleniumPerfStats.markEnd(r,Ce.GET_ELEMENT)}}executeJS(t,...r){return this.execute(t,...r)}async executeCodeAsync(t,r,...n){return await this.timeouts("script",r),await this.executeAsync(t,...n)}async markDynamicParent(t,r){function n({attributeName:i,attributeValue:o,locatedElement:a}){let c=getLocatedElement(a);if(!c)throw new Error("could not find dynamic parent");c.setAttribute(i,o)}await this.executeJS(`
            var getLocatedElement = ${kr().getLocatedElementCode};
            var setDynamicParentAttribute = ${n.toString()};
            return setDynamicParentAttribute.apply(null, arguments)
        `,{attributeName:MS().DYNAMIC_PARENT_FIELD_NAME,attributeValue:r,locatedElement:t.locatedElement})}getLocatedElementRectWithPadding(t){function r(n){let i=getLocatedElement(n);if(!i)return null;let o=parseInt(window.getComputedStyle(i).paddingTop.replace("px",""),10)||0,a=parseInt(window.getComputedStyle(i).paddingLeft.replace("px",""),10)||0,c=i.getBoundingClientRect();return{top:Math.round(c.top+o),left:Math.round(c.left+a)}}return this.executeJS(`
            const getLocatedElement = ${kr().getLocatedElementCode};
            const getLocation = ${r.toString()};
            return getLocation.apply(null, arguments)
        `,t)}getElementLocationWithPadding(t){return this.getLocatedElementRectWithPadding(t)}getLocatedElementRect(t){function r(n){let i=getLocatedElement(n);if(!i)return null;let o=i.getBoundingClientRect();return{bottom:Math.round(o.bottom),height:Math.round(o.height),x:Math.round(o.left),right:Math.round(o.right),y:Math.round(o.top),width:Math.round(o.width)}}return this.executeJS(`
            const getLocatedElement = ${kr().getLocatedElementCode};
            const getLocation = ${r.toString()};
            return getLocation.apply(null, arguments)
        `,t)}getElementLocation(t){return this.getLocatedElementRect(t.locatedElement)}getTargetText(t){return this.getElementTextJS(t.locatedElement)}async getElementTextJS(t){function r(i,o){function a(u){var h;return(h=u.childNodes)!=null&&h.length&&[...u.childNodes].filter(g=>g.nodeType===Node.ELEMENT_NODE).forEach(g=>{typeof g.tagName=="string"&&g.tagName.toLowerCase()==="title"?u.removeChild(g):a(g)}),u}function c(u){return["INPUT","TEXTAREA"].includes(u.tagName)}function l(u){var f,h,g;try{if(u.shadowRoot&&!((g=(h=Object.getOwnPropertyDescriptor((f=u.ownerDocument.defaultView)==null?void 0:f.Node.prototype,"textContent"))==null?void 0:h.get)!=null&&g.toString().includes("[native code]")))return u.shadowRoot.textContent.replace(/(\r\n|\n|\r)/gm,"")}catch{}if(o&&Array.prototype.some.call(u.children,y=>y.hidden)){let y=u.cloneNode(!0);return Array.prototype.filter.call(y.children,w=>w.hidden).forEach(w=>y.removeChild(w)),y.textContent.replace(/(\r\n|\n|\r)/gm,"")}return u.textContent.replace(/(\r\n|\n|\r)/gm,"")}function d(u){if(c(u))return u.value;if(u instanceof SVGElement){let f=u.cloneNode(!0);return a(f).textContent.replace(/(\r\n|\n|\r)/gm,"")}return l(u)}let m=getLocatedElement(i);return m?d(m):""}let{value:n}=await this.executeJS(`
            const getLocatedElement = ${kr().getLocatedElementCode};
            const extractText = ${r.toString()};
            return extractText.apply(null, arguments)
        `,t,this.ignoreHiddenTagsText);return n}async getHTML(t){var i,o;let r=kr().getHtmlCode(void 0,t),n=this.seleniumPerfStats.markStart(Ce.GET_HTML);try{let{value:a}=await this.executeJS(r);return this.seleniumPerfStats.markEnd(n,Ce.GET_HTML),a}catch(a){this.seleniumPerfStats.markEnd(n,Ce.GET_HTML);let c=Object.assign(new Error(""),{success:!1,reason:a.toString(),errorType:"internal-error"});throw(o=(i=this.client)==null?void 0:i.requestHandler)!=null&&o.sessionID||Object.assign(c,{extraInfo:"Inside getHtml catch and trying to check if in quirks mode - but the session has already terminated"}),c}}maximizeWithoutValidation(){return this.windowHandleMaximize()}setViewportSizeNEW(t,r){class i extends Error{}function o(){return{screenWidth:Math.floor(window.innerWidth||0),screenHeight:Math.floor(window.innerHeight||0)}}let a=()=>(0,zg.default)(async()=>{let{value:l}=await this.windowHandleSize(),{value:d}=await this.execute(o),m=l.width-d.screenWidth,u=l.height-d.screenHeight;await this.windowHandleSize({width:t.width+m,height:t.height+u});let{value:f}=await this.execute(o);if(f.screenWidth!==t.width||f.screenHeight!==t.height)throw new i},{retries:5-1,factor:1,minTimeout:0}).catch(l=>{if(!(l instanceof i))throw l});if(typeof t!="object"||typeof t.width!="number"||typeof t.height!="number"||r!==void 0&&typeof r!="boolean")throw new Error("number or type of arguments don't agree with setViewportSize command");return(r===void 0?!0:r)?a():this.windowHandleSize(t)}setViewportSize(t,r){return this.setViewportSizeNEW({width:t,height:r},!0)}getBrowserMajorVersion(t){var r;try{return parseInt(((r=t.browser)==null?void 0:r.version)||"0",10)}catch(n){return Be.error("failed to get browser version",{err:n}),0}}async getBrowserAndOS(){function t(a){let c=a.match(/(opera|chrome|safari|firefox)\/?\s*(\d+)/i)||[];if(c[1]==="Chrome"&&a.match(/\bOPR\/(\d+)/)!==null)return"opera";if(c[1]==="Chrome"&&a.match(/\bEdge|Edg\/(\d+)/)!==null)return"edge";c=c[2]?[c[1],c[2]]:[a.appName,a.appVersion,"-?"];let l=a.match(/version\/(\d+)/i);return l!==null&&c.splice(1,1,l[1]),c[0].toLowerCase()}if(this.browserAndOS)return this.browserAndOS;function r(){var a;return(a=window==null?void 0:window.navigator)!=null&&a.userAgent?window.navigator.userAgent:"unknown"}let{value:n}=await this.executeJS(r),i=(0,Kg.default)(n),o=i.os;return this.browserAndOS={os:`${o.name} ${o.version}`,browserMajor:this.getBrowserMajorVersion(i),browser:t(n),userAgent:n,browserVersion:i.browser.version},this.browserAndOS}setValue(t,r){return super.setValue(t,r)}getRelativeMoveActions(t,r){let{rect:n,clickOffset:i}=t,o=Or().calculateElementMiddlePoint(n),a=i.x,c=i.y;return!qg().isWithinBounds(n.left,n.left+n.width,o.x+a)||!qg().isWithinBounds(n.top,n.top+n.height,o.y+c)?(Be.warn("using element center as fallback for offset"),this.getMoveActions(0,0,r)):this.getMoveActions(a,c,r)}computeAbsoluteMovement(t){let{frameOffset:r,rect:n,clickOffset:i}=t,o=n.left+i.x+r.x,a=n.top+i.y+r.y;return{x:o,y:a}}async actWithActionsAPI(t,r,n,i){let o=this.getRelativeMoveActions(t,n),a=this.getClickActions(i,r);try{return await this.actions([{type:"pointer",id:"mouse",parameters:{pointerType:"mouse"},actions:o.concat(a)}])}catch(c){Be.error("tried to use element origin but failed because of visibility, trying absolute",c);let{x:l,y:d}=this.computeAbsoluteMovement(t),m=this.getMoveActions(l,d);return this.actions([{type:"pointer",id:"mouse",parameters:{pointerType:"mouse"},actions:m.concat(a)}])}}doubleClickWithActionsAPI(t,r){return this.actWithActionsAPI(r,sr,t,["pointerDown","pointerUp","pointerDown","pointerUp"])}async doubleClickWithJS(t){let[{doubleClick:r},{dispatchFocus:n}]=await Promise.all([Promise.resolve().then(()=>(Gg(),Vg)),Promise.resolve().then(()=>(Mn(),Nn))]);return this.executeCodeAsync(`
            var getLocatedElement = ${kr().getLocatedElementCode};
            var dispatchFocus = ${n.toString()};
            var doubleClick = ${r.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return doubleClick.call(null, eventData, done);
        `,t.timeout,t)}getClickActions(t=[],r=void 0){return t.map(n=>({type:n,button:r}))}getClickActionList(t=[],r=void 0){return[{type:"pointer",id:"mouse",actions:this.getClickActions(t,r)}]}leftClickWithActionsAPI(t,r){return this.actWithActionsAPI(r,sr,t,["pointerDown","pointerUp"])}rightClickWithActionsAPI(t,r){return this.actWithActionsAPI(r,DS,t,["pointerDown","pointerUp"])}async rightClick(t,r){if(this.unsupportedActions.has("move"))return this.rightClickWithActionsAPI(t,r);try{return await super._rightClick(t,r)}catch(n){if(Fe(n))return this.unsupportedActions.add("move"),this.rightClickWithActionsAPI(t,r);throw n}}async leftClick(t,r){if(this.unsupportedActions.has("move"))return this.leftClickWithActionsAPI(t,r);try{return await super._leftClick(t,r)}catch(n){if(Fe(n))return this.unsupportedActions.add("move"),this.leftClickWithActionsAPI(t,r);throw n}}async dragAndDropOldAPI(t,r){return await this.moveTo(t),await this.buttonDown(),await this.moveTo(r),await this.buttonUp()}async calculateElementMiddlePoint(t,r={top:0,left:0}){let n=await this.getLocatedElementRect(t);if(!(n!=null&&n.value))throw Be.warn(`could not find element for locatedElement ${t==null?void 0:t.testimId}`),new Error("could not calculate rect");let{x:i,y:o,width:a,height:c}=n.value;return{x:r.left+i+a/2,y:r.top+o+c/2}}async hover(t,r){if(this.unsupportedActions.has("move"))return this.moveToElementWithActionsAPI(t,r);let{x:n,y:i}=r.clickOffset;try{return await this.moveTo(t,n,i)}catch(o){if(Fe(o))return this.unsupportedActions.add("move"),this.moveToElementWithActionsAPI(t,r);throw o}}getMoveActions(t=1,r=1,n="viewport",i=0){return[{type:"pointerMove",duration:i,x:Math.floor(t)||1,y:Math.floor(r)||1,origin:n}]}moveWithActionsAPI(t){let r=this.getMoveActions(t.x,t.y);return this.actions([{type:"pointer",id:"mouse",actions:r}])}async moveToElementWithActionsAPI(t,r){try{return await this.actions([{type:"pointer",id:"mouse",actions:this.getRelativeMoveActions(r,t)}])}catch(n){Be.error("tried to use element origin but failed because of visibility, trying location",n);let i=this.computeAbsoluteMovement(r);return await this.moveWithActionsAPI(i)}}getDragCoordinates(t){let r=t.filter(o=>o.event==="mousemove"||o.event==="pointermove"),n=r[0].pointerPosition,i=r.at(-1).pointerPosition;return{xDiff:i.screenX-n.screenX,yDiff:i.screenY-n.screenY}}async dragWithMoveTo(t,r,n,i,o){return await this.moveTo(t,i,o),await this.buttonDown(),await this.moveTo(t,r,n),await this.buttonUp()}dragWithActionsAPI(t,r,n,i,o){let a=this.getMoveActions(i,o,t,1),c=this.getClickActions(["pointerDown"],sr),l=this.getMoveActions(r,n,"pointer",1),d=this.getClickActions(["pointerUp"],sr);return this.actions([{type:"pointer",id:"mouse",actions:a.concat(c).concat(l).concat(d)}])}async drag(t,r,n,i,o){let{width:a,height:c}=r,l=n-a/2+1,d=i-c/2,m=this.getDragCoordinates(o),{xDiff:u,yDiff:f}=m;if(this.unsupportedActions.has("move"))return this.dragWithActionsAPI(t,u,f,l,d);try{return await this.dragWithMoveTo(t,u,f,l,d)}catch(h){if(Fe(h))return this.unsupportedActions.add("move"),this.dragWithActionsAPI(t,u,f,l,d);throw h}}getMoveRelativeSequence(t,r,n,i){let o=(u,f)=>Math.hypot(u.x-f.x,u.y-f.y),a={x:t,y:r},c={x:n,y:i},l=10,d=Math.round(o(a,c)/l),m=Array.from({length:d},()=>({x:Math.round((c.x-a.x)/d),y:Math.round((c.y-a.y)/d)}));return[{x:1,y:1}].concat(m)}getMoveAbsoluteSequence(t,r,n,i){return this.getMoveRelativeSequence(t,r,n,i).reduce((a,c)=>{let l=a.at(-1);return a.concat({x:Math.round(l.x+c.x),y:Math.round(l.y+c.y)})},[{x:Math.round(t),y:Math.round(r)}])}async dragAndDropWithGeneratedMoves(t,r,n){let{fromRect:i,fromX:o,fromY:a,toRect:c,toX:l,toY:d}=n,m=Or().calculateElementMiddlePoint(i),u=Or().calculateElementMiddlePoint(c),f=this.getMoveRelativeSequence(m.x+o,m.y+a,u.x+l,u.y+d);await this.moveTo(t,Math.floor(o),Math.floor(a)),await this.buttonDown();for(let h of f)await this.moveTo(null,h.x,h.y);return await this.moveTo(r,Math.round(l),Math.round(d)),await this.buttonUp()}dragAndDropWithActionsAPIWithGeneratedMoves(t){let{fromRect:r,fromX:n,fromY:i,toRect:o,toX:a,toY:c}=t,l=Or().calculateElementMiddlePoint(r),d=Or().calculateElementMiddlePoint(o),m=Math.floor(l.x+n),u=Math.floor(l.y+i),f=Math.floor(d.x+a),h=Math.floor(d.y+c),g=this.getMoveAbsoluteSequence(m,u,f,h),y=this.getMoveActions(m,u),T=this.getClickActions(["pointerDown"],sr),w=bs.flatMap(g,k=>this.getMoveActions(k.x,k.y)),b=this.getMoveActions(f,h),S=this.getClickActions(["pointerUp"],sr),E=y.concat(T).concat(w).concat(b).concat(S);return this.actions([{type:"pointer",id:"mouse",actions:E}])}async dragAndDrop(t,r,n){if(this.isSafari()){if(this.unsupportedActions.has("move"))return this.dragAndDropWithActionsAPIWithGeneratedMoves(n);try{return await this.dragAndDropWithGeneratedMoves(t,r,n)}catch(i){if(Fe(i))return this.unsupportedActions.add("move"),this.dragAndDropWithActionsAPIWithGeneratedMoves(n);throw i}}if(this.unsupportedActions.has("move"))return this.dragAndDropWithActionsAPI(n);try{return await this.dragAndDropOldAPI(t,r)}catch(i){if(Fe(i))return this.unsupportedActions.add("move"),this.dragAndDropWithActionsAPI(n);throw i}}doubleClickFallback(t,r,n){return this.isSafari()?this.doubleClickWithJS(r):this.doubleClickWithActionsAPI(t,n)}async doubleClick(t,r,n){if(this.unsupportedActions.has("move")||this.isSafari())return this.doubleClickFallback(t,r,n);try{return await this.doDoubleClick(t)}catch(i){if(Fe(i))return this.unsupportedActions.add("move"),this.doubleClickFallback(t,r,n);throw i}}async dragAndDropWithActionsAPI(t){let{fromRect:r,fromX:n,fromY:i,toRect:o,toX:a,toY:c}=t,l=Or().calculateElementMiddlePoint(r),d=Or().calculateElementMiddlePoint(o),m=Math.floor(l.x+n),u=Math.floor(l.y+i),f=Math.floor(d.x+a),h=Math.floor(d.y+c);await this.moveWithActionsAPI({x:m,y:u});let g=this.getClickActionList(["pointerDown"],sr);await this.actions(g),await this.moveWithActionsAPI({x:f,y:h});let y=this.getClickActionList(["pointerUp"],sr);return this.actions(y)}async getTabIds(){let{value:t}=await this.windowHandles();return t}async isVisible(t){let{value:r}=await this.elementIdDisplayed(Hg(t));return r}getSource(){return this.source()}async getElementRect(t){let r={width:0,height:0,top:0,left:0},n;try{n=await this.getElementLocation(t)}catch(i){Be.error("error getting element location",{err:i})}return n!=null&&n.value?{top:n.value.y,left:n.value.x,width:n.value.width,height:n.value.height}:r}async end(){Be.info("delete session",{sessionId:this.getSessionId()}),this.getSessionId()||Be.warn("failed to close session because session is undefined"),this.stopKeepAliveInterval();try{return await super.end()}catch{return}}async submit(t){if(this.unsupportedActions.has("submit"))return await super.submitFormManually(t);try{return await super.submitForm(t)}catch(r){if(Fe(r))return this.unsupportedActions.add("submit"),super.submitFormManually(t);throw r}}}});var fu,gu,Fn,hu=v(()=>{"use strict";$();de();ge();fu=C("lab-features-service"),gu=class{constructor(){this.featuresForProject=[];this.labBatman=!1}async loadLabFeatures(e,t){(!t||!e)&&(fu.error("missing companyPlan or projectId when loading lab features",{companyPlan:t,projectId:e}),this.featuresForProject=[]);try{let r=this.isLabsEnabledForCompany(t),n=r?await yu(e):[];this.featuresForProject=n,this.labBatman=r}catch(r){fu.error("failed loading lab features",{err:r,companyPlan:t,projectId:e}),this.featuresForProject=[]}}isFeatureAvailableForProject(e){let t=O.flags[e];this.validateAsLabFeatureFlag(t);let r=t.getValue();if(r==="disabled")return!1;if(r==="enabled")return!0;let{featuresForProject:n,labBatman:i}=this,o=n.find(c=>c.featureFlagName===e),a=o==null?void 0:o.enabled;return Boolean(i&&a)}isLabsEnabledForCompany(e){var t;return Boolean((t=e==null?void 0:e.premiumFeatures)==null?void 0:t.enableLabFeatures)}validateAsLabFeatureFlag(e){if("getValue"in e)return;let t=`Attempted querying a lab feature flag which isn't a variant. This means that a wrong configuration is being used in FeatureFlagsService (for feature flag: ${e.name}`;throw fu.error(t,{featureFlagName:e.name}),new Error(t)}},Fn=new gu});function FS(s){let e=s.startsWith("\\\\?\\"),t=/[^\u0000-\u0080]+/.test(s);return e||t?s:s.replace(/\\/g,"/")}function BS(s){try{return{sync:!0,lib:globalThis.require(s)}}catch(e){if(e.code!=="ERR_REQUIRE_ESM")throw e;let{sep:t,join:r}=globalThis.require("path"),{promises:n}=globalThis.require("fs");return{sync:!1,lib:n.readFile(`${s}${t}package.json`).then(o=>{let a=JSON.parse(o);return import(r(s,a.main||`${t}index.js`))})}}}function jS(s){let e=Object.getPrototypeOf(async()=>null).constructor;function t(){return e.apply(null,s)}return t.prototype=e.prototype,new t}async function $S(s,e,t,r,n={},i=void 0,o=void 0){let a=Object.keys(n).map(h=>`
        var res = requireOrImportMethod('${FS(n[h])}');
        if (res.sync) {
            var ${h} = res.lib;
        } else {
            var ${h} = await res.lib;
        }
        `).join(""),c=o?`
            ${Qg.default.toString()}
            var fileBuffer = dataUriToBuffer('${o}');
        `:"var fileBuffer = null;",l=`
        const getMessage = arguments => {
            const args = Array.prototype.slice.call(arguments);
            let message = args.shift() + '';
            if (!args.length) {
                return message;
            }
            message = message.replace(/%([odifs])/g, function (s, param) {
                // Formatting is not yet supported.
                var arg;
                if (!args.length) {
                    return '';
                }
                arg = args.shift();
                if (param === 'o') {
                    return arg + '';
                } else if (param === 'd' || param === 'i') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseInt(arg, 10);
                    return isNaN(arg) ? '0' : arg + '';
                } else if (param === 'f') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseFloat(arg);
                    return isNaN(arg) ? '0.000000' : arg.toFixed(6) + '';
                } else if (param === 's') {
                    return arg + '';
                }
            });
            if (message) {
                args.unshift(message);
            }
            return args.join(' ').replace(/\\s*$/, ' ');
        };

        const pushNewMessage = (method, consoleArgs) => {
            const message = getMessage(consoleArgs);
            parentPort.postMessage({
                action: 'progress',
                data: {
                    method,
                    msg: message,
                    timestamp: Date.now(),
                }
            });
        };

        ["log", "info", "warn", "error", "debug"].forEach(function (method) {
            const nativeMethod = console[method];
            const oldMethod = nativeMethod?.bind(console);
            console[method] = function () {
                pushNewMessage(method, arguments);
                oldMethod?.apply(console, arguments);
            };
        });
    `,d=`
        function injectCode(params, args, incomingParams, context, code) {
            const constructWithArguments = ${jS.toString()}

            const resolve = result => {
                parentPort.postMessage({
                    action: 'finish',
                    data: {
                        status: 'done',
                        result: result,
                        success: true,
                    }
                });
            };
            const reject = result => {
                parentPort.postMessage({
                    action: 'finish',
                    data: {
                        status: 'failed',
                        result: result,
                        success: false,
                    }
                });
            };

            try {
                params.push(code);
                const functionToRun = constructWithArguments(params);

                const result = functionToRun.apply(null, args);
                if (isPromise(result)) {
                    result.then(res => {
                        resolve({
                            resultValue: res,
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    }).catch(err => {
                        reject({
                            resultValue: err?.toString(),
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    });
                } else {
                    resolve({
                        resultValue: result,
                        exports: exportedData,
                        exportsTest: exportedTestData,
                        exportsGlobal: exportedGlobalData
                    });
                }
            } catch (e) {
                reject({
                    resultValue: e?.toString(),
                    exports: exportedData,
                    exportsTest: exportedTestData,
                    exportsGlobal: exportedGlobalData
                });
            }
        }
    `,m=`
        (async function() {
            // A hack to fix an issue with stringified functions which use require. when compiling to JS, calls to require change to __require.
            const __require = require;
            const { parentPort } = require('worker_threads');
            const requireOrImportMethod = ${BS.toString()}

            // requireCode will set async to be true if needed.
            ${a}

            ${c}

            ${l}

            const isPromise = ${Ec.toString()}

            parentPort.once('message', input => {
                const { incomingParams, context, code } = input;

                const exportedData = {};
                const exportedTestData = {};
                const exportedGlobalData = {};

                const params = ["context"]
                    .concat(incomingParams.as.functionParameters)
                    .concat(${JSON.stringify(Object.keys(n))})
                    .concat(['exports', 'exportsTest', 'exportsGlobal']);

                const args = [context]
                    .concat(incomingParams.as.functionArguments)
                    .concat([${Object.keys(n).join(",")}])
                    .concat([exportedData, exportedTestData, exportedGlobalData]);

                if(fileBuffer) {
                    params.push('fileBuffer');
                    args.push(fileBuffer);
                }

                ${d}

                injectCode(params, args, incomingParams, context, code);
            });
        })();
    `,u=[],f=new Zg.Worker(m,{eval:!0});try{return await pe(new Promise(h=>{f.on("message",g=>{if(g.action==="finish"){let{data:y}=g,T={...y,tstConsoleLogs:u};dt.debug("Run code worker response",{messageWithLogs:T,transactionId:s}),h(T)}else g.action==="progress"&&u.push(g.data)}).on("error",g=>{g.message==="malformed data: URI"?dt.error("Run code worker error",{err:g,transactionId:s,fileDataUrl:o}):dt.error("Run code worker error",{err:g,transactionId:s}),h({tstConsoleLogs:u,status:"failed",result:{resultValue:g==null?void 0:g.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1})}).on("exit",()=>{dt.debug("Run code worker has been terminated",{transactionId:s})}),f.postMessage({incomingParams:e,context:JSON.parse(JSON.stringify(t)),code:r})}),i)}catch(h){if(!(h instanceof ce))throw h;return dt.warn("timeout to run code",{transactionId:s,err:h}),{tstConsoleLogs:u,status:"failed",result:{resultValue:h==null?void 0:h.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1}}finally{f==null||f.terminate()}}async function WS(s){try{await Yg.promises.rm(s,{recursive:!0,force:!0})}catch(e){dt.warn("failed to remove install npm packages folder",{err:e})}}function eh(s,e,t,r){return`${e}_${t}_${s}_${r}`}async function ws(s,e,t,r,n,i){let o=eh(n,e,s,t),{data:a}=await VS(o,r,i);return a}async function vs(s,e,t,r,n,i,o,a,c,l){var g;let d=r.computePackagePathFromPackageJsonExports||O.flags.computePackagePathFromPackageJsonExports.isEnabled(),m=Object.fromEntries(((g=t.nodePackageParams)==null?void 0:g.map(y=>{if(d){let T=Vm(y.testimPackageLocalLocation);return[y.paramName,Ts.join(y.testimPackageLocalLocation,T)]}return[y.paramName,y.testimPackageLocalLocation]}))||[]),u=eh(o,n,e,i);if(l){let y=await kn(l);y&&(c=y)}Buffer.isBuffer(c)&&(dt.debug("runCodeWithPackages: converted a buffer to base 64 string data URI",{fileDataUrl:c}),c=c.toString());let f="data:,";return c==="data:"&&(dt.debug("runCodeWithPackages, fileDataUrl was an empty string ",{fileDataUrl:c}),c=f),{...await $S(u,t,r,s,m,a,c),nodeVersion:process.version}}async function VS(s,e,t){let r=e.map(l=>`${l.packageName}@${l.packageVersion}`),n=th(),o=O.flags.reuseCliPkgInstallFolder.isEnabled()?n:Ts.join(n,`/${s}`),a=global.proxyUri;async function c(){let l="";try{if(l=await tl(o,r,a,t),dt.info("npm package install finished",{transactionId:s,output:l,timeout:t}),Number(l.trim().split(" ")[1])<r.length)throw"npm package install failed, couldn't install all packages";return{data:e.map(m=>{let u=$m(o,m.packageName);return{...m,packageFullName:`${m.packageName}@${u}`,packageLocalLocation:Ts.resolve(o,"node_modules",m.packageName)}}),installFolder:o}}catch(d){throw dt.warn("npm package install failed",{transactionId:s,err:d}),d}}try{return await pe(c(),t)}catch(l){throw l instanceof ce&&dt.warn("timeout to install package",{packages:r,transactionId:s,err:l,timeout:t}),l}}function th(){return Ts.join(Xg.tmpdir(),"/testim_local_packages")}function GS(){let s=th();return WS(s)}var Yg,Xg,Ts,Qg,Zg,dt,Ss=v(()=>{"use strict";Yg=I(require("fs")),Xg=I(require("os")),Ts=I(require("path"));B();is();Qg=I(require("data-uri-to-buffer")),Zg=require("worker_threads");X();$();ge();is();de();dt=C("cli-service");GS().catch(s=>dt.warn("failed to clean local package folder",{err:s}))});var nr={};z(nr,{run:()=>qS});function HS(s,e){try{let t=e.defaults.enforceMaximumJsResultSize,r=O.flags.maximumJsResultSize.getValue(),n=JSON.stringify(s).length>r;return t?n:!1}catch{return!1}}var qS,rh=v(()=>{"use strict";Ss();X();de();qS=async(s,e,t)=>{let{code:r,stepId:n,incomingParams:i,context:o,testResultId:a,retryIndex:c,stepResultId:l,runTimeout:d,fileDataUrl:m,s3filepath:u}=e.data;try{let f=await vs(r,n,i,o,a,c,l,d,m,u);return f&&HS({result:f.result,tstConsoleLogs:f.tstConsoleLogs},t)?{code:"js-result-max-size-exceeded",success:!1}:{data:f,success:!0}}catch(f){throw f instanceof ce?new Error("Timeout while running action"):f}}});var bu={};z(bu,{run:()=>zS});var zS,sh=v(()=>{"use strict";Ss();X();zS=async(s,e)=>{let{stepId:t,testResultId:r,retryIndex:n,stepResultId:i,packageData:o,timeout:a}=e.data;try{return{data:await ws(t,r,n,o,i,a),success:!0}}catch(c){if(c instanceof At)return{success:!1,code:"invalid-node-package",message:c.message};if(c instanceof ce)return{success:!1,code:"timeout"};throw c}}});async function ih(s,e,t,r){try{return await Tu(s,e,t,r)}catch{Do.error("failed to report remote step state",{projectId:s,resultId:e,stepId:t});return}}async function JS(s,e,t,r,n){return Do.info("finished to run remote step",{stepId:t,sessionId:n}),await ih(s,e,t,{status:"completed",success:!0,failureReason:null,data:r})}async function nh(s,e,t,r,n){return Do.info("failed to run remote step",{stepId:t,sessionId:n,failureReason:r}),await ih(s,e,t,{status:"completed",success:!1,failureReason:r})}async function oh(s,e,t,r){if(!(t!=null&&t.type)||t.status==="completed")return;let{project:n,projectData:i}=s,o=t.type,a=e.getSessionId(),c=t.id;Do.info("start play remote step",{stepType:o,stepId:c,sessionId:a});let l=KS[o];if(!l)return await nh(n,r,c,`Failed to find step type ${o}`,a);try{let d=await l.run(e,t,i);return await JS(n,r,c,d,a)}catch(d){return await nh(n,r,c,d.message,a)}}var Do,KS,ah=v(()=>{"use strict";rh();ge();sh();$();Do=C("step-playback"),KS={"cli-validation-code-step":nr,"cli-wait-for-code-step":nr,"cli-action-code-step":nr,"cli-api-code-step":nr,"cli-condition-step":nr,"cli-download-code-step":nr,"node-package":bu}});var lh={};z(lh,{preloadTests:()=>jn});async function jn(s){if(!Array.isArray(s.testId)||!s.testId.length)return{};let e={branch:s.branch,projectId:s.project};return await Pt(async()=>{let t=await se(s.testId,r=>$n({...e,testId:r}),{concurrency:2});return ch.keyBy(t,"testData.id")},"loadTests",XS,[e,s.testId])()}var ch,XS,No=v(()=>{"use strict";ch=I(require("lodash"));Xt();ge();B();XS=1e3*60*60*10});var wu,uh,Lr,QS,vu,wt,Mo=v(()=>{"use strict";B();ct();wu=I(require("ws")),uh=require("events");$();ae();Lr=C("socket-service"),QS=5e3,vu=class extends uh.EventEmitter{constructor(){super(...arguments);this.clientId=re();this.ws=null;this.filterMap={};this.listeners={}}onReconnect(t){Lr.info("test result websocket re-connect"),setTimeout(()=>this.connect(t),QS)}formatUrl(t){return t.startsWith("http://")?t.replace("http://","ws://"):t.startsWith("https://")?t.replace("https://","wss://"):t}parseEvent(t){try{return JSON.parse(t)}catch(r){Lr.error("failed to parse or trigger event",{err:r})}}connect(t){let r=this.formatUrl(xd);return kt().then(n=>new Promise(i=>{let o={...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};this.ws=new wu.default(`${r}?projectId=${t}&clientId=${this.clientId}&token=${n}`,o),this.ws.on("open",()=>{var a;return Lr.info("websocket opened"),this.reSendAllExistingFilters(),(a=this.onConnect)==null||a.call(this),i()}),this.ws.on("close",a=>{Lr.info("websocket closed",{event:a}),(!this.ws||this.ws.readyState===wu.default.CLOSED)&&this.onReconnect(t)}),this.ws.on("error",a=>{Lr.info("websocket error",{event:a})}),this.ws.on("message",a=>{let c=this.parseEvent(a);c!=null&&c.type&&this.emit(c.type,c.data)})}))}sendMessage(t){if(!this.ws){Lr.warn("tried to send error when websocket was disconnected");return}try{this.ws.send(JSON.stringify(t))}catch(r){Lr.error("failed to stringify message for sending",{err:r})}}listenOnce(t,r,n){let i=o=>{r(o)&&(n(o),this.removeListener(t,i))};this.on(t,i)}listenTo(t,r,n,i){function o(c){n(c)&&i(c)}(Array.isArray(r)?r:[r]).forEach(c=>{this.listeners[`${t}:${c}`]||=[];let l=o.bind(this);this.listeners[`${t}:${c}`].push(l),this.on(c,l)})}reSendAllExistingFilters(){Object.keys(this.filterMap).forEach(t=>{let r=this.filterMap[t];this.sendMessage({type:"add-filter",filter:r})})}addFilter(t,r,n,i=!1){return new Promise(o=>{let a=re(),c={query:r,id:a,type:n,fullDocument:i};this.listenOnce("add-filter:done",l=>l.id===a,o),this.sendMessage({type:"add-filter",filter:c}),this.filterMap[t]=c})}removeListeners(t,r){Object.keys(this.listeners).length!==0&&r.forEach(n=>{let i=this.listeners[`${t}:${n}`];i&&(delete this.listeners[`${t}:${n}`],i.forEach(o=>this.removeListener(n,o)))})}removeFilter(t,r){let n=this.filterMap[t];if(!n)return;let i=Array.isArray(r)?r:[r];this.removeListeners(t,i),delete this.filterMap[t],this.sendMessage({type:"remove-filter",filter:n})}},wt=new vu});var dh,Su,ZS,eE,tE,ph,Uo,Es,Eu=v(()=>{"use strict";dh=I(require("p-retry")),Su=I(require("socket.io-client"));ae();B();$();ZS=50,eE=10,tE=5e3,ph=10*1e3,Uo=C("base socket service"),Es=class{constructor(){this.attempts=0;this.rooms={};this.emitPromiseQueue=void 0}joinToMultipleResults(){let e=Object.keys(this.rooms);Uo.info("re-join all existing rooms",{testResultIds:e}),e.forEach(t=>{var n;let r=this.rooms[t];(n=this.emitJoinRoom)==null||n.call(this,t,r)})}joinRoom(e,t){this.rooms[e]=t}leaveRoom(e){delete this.rooms[e]}addSocketHandlers(){let e=(t,r)=>{let n="websocket";try{n=this._socket.io.engine.transport.name}catch{}Uo.error(`Error in SocketService websocket _${t}_ socket ${this._socket.id} is ${this.url} over ${n}. Reconnect attempts ${this.attempts}. Error is: ${r==null?void 0:r.message}`)};this._socket.on("reconnect_attempt",t=>{if(e("reconnect_attempt",{message:"reconnect attempt",attempt:t}),this.attempts++,this.attempts===eE&&!this.isAllowedWS&&(this._socket.io.opts.transports=["polling"],this._socket.io.opts.upgrade=!1),this.attempts>=ZS)throw new Error(`Can't connect to Testim Servers.
Action required: Please allow opening a websockets connection to ${he()} in your firewall/proxy`)}),this._socket.on("connect_error",t=>{e("connect_error",t)}),this._socket.on("connect_timeout",t=>{e("connect_timeout",t)}),this._socket.on("error",t=>{e("error",t)}),this._socket.on("reconnect_error",t=>{this.prevErr&&this.prevErr.type===t.type||(this.prevErr=t,e("reconnect_error",t))}),this._socket.on("reconnect",()=>{Uo.info("reconnect to socket and re-join to rooms"),this.joinToMultipleResults()}),this._socket.on("connect",()=>{var t;this.attempts=0,this.isAllowedWS===void 0&&(this.isAllowedWS=this._socket.io.engine.transport&&this._socket.io.engine.transport.name==="websocket"),(t=this.onConnect)==null||t.call(this)})}initNewSocket(e,t){let r={query:{projectId:e},requestTimeout:ph,transports:["websocket"],upgrade:!1,forceNew:!0,rejectUnauthorized:process.env.NODE_TLS_REJECT_UNAUTHORIZED!=="0",...global.caFileContent&&{ca:global.caFileContent},...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};return new Promise(n=>{this.url=`${he()}/${t}`,this._socket=Su.connect(this.url,r),this.addSocketHandlers(),this._socket.on("connect",n),this._socket.open()})}init(e,t){let r={query:{projectId:e},requestTimeout:ph,transports:["websocket"],upgrade:!1,rejectUnauthorized:process.env.NODE_TLS_REJECT_UNAUTHORIZED!=="0",...global.caFileContent&&{ca:global.caFileContent},...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};this.url=`${he()}/${t}`,this._socket=Su.connect(this.url,r),this.addSocketHandlers()}emitPromise(e,t){let r={},n=()=>new Promise((i,o)=>{this._socket.emit(e,t,a=>a!=null&&a.success?i():(r[e]=t,o(new Error("bad ack"))))});return this.emitPromiseQueue=(this.emitPromiseQueue||Promise.resolve()).then(()=>(0,dh.default)(()=>pe(n(),tE),{retries:200,minTimeout:3e3,factor:1})).finally(()=>{Object.keys(r).length>0&&Uo.error("Bad acknowledge from socket emit",{errorneousEvents:r})}),this.emitPromiseQueue}}});var mh={};z(mh,{remoteStepServiceSocketIO:()=>rE});var Iu,rE,fh=v(()=>{"use strict";Eu();Iu=class extends Es{constructor(){super(...arguments);this.listeners={}}init(t){super.init(t,"remoteStep"),this.listeners={}}emitJoinRoom(t){return this.emitPromise("remoteStep:join",{resultId:t})}emitLeaveRoom(t){return this.emitPromise("remoteStep:leave",{resultId:t})}async joinToRemoteStep(t){this.rooms[t]||(this.joinRoom(t),await this.emitJoinRoom(t))}listenToRemoteStep(t,r){this.listeners[t]&&(this._socket.off("remoteStep:saved",this.listeners[t]),delete this.listeners[t]),this.listeners[t]=n=>{n.resultId===t&&n.remoteStep&&n.remoteStep.status==="pending"&&r(n.remoteStep)},this._socket.on("remoteStep:saved",this.listeners[t])}async unlistenToRemoteStep(t){this.listeners[t]&&(this.leaveRoom(t),this._socket.off("remoteStep:saved",this.listeners[t]),delete this.listeners[t],await this.emitLeaveRoom(t))}},rE=new Iu});var gh={};z(gh,{remoteStepService:()=>Is});var Ru,Wn,xu,Is,Fo=v(()=>{"use strict";Mo();oe();de();({REMOTE_STEP_SAVED:Ru}=Ct),xu=class{async init(e){O.flags.useNewWSCLI.isEnabled()||(Wn=(await Promise.resolve().then(()=>(fh(),mh))).remoteStepServiceSocketIO,Wn.init(e))}joinToRemoteStep(e){return O.flags.useNewWSCLI.isEnabled()?wt.addFilter(`${e}:remoteStep`,{resultId:e},[Ru]):Wn.joinToRemoteStep(e)}listenToRemoteStep(e,t){if(O.flags.useNewWSCLI.isEnabled()){wt.listenTo(`${e}:remoteStep`,[Ru],r=>r.resultId===e&&r.remoteStep&&r.remoteStep.status==="pending",r=>t(r.remoteStep));return}Wn.listenToRemoteStep(e,t)}unlistenToRemoteStep(e){return O.flags.useNewWSCLI.isEnabled()?(wt.removeFilter(`${e}:remoteStep`,[Ru]),Promise.resolve()):Wn.unlistenToRemoteStep(e)}},Is=new xu});var Au,Dr,hh=v(()=>{"use strict";Eu();Au=class extends Es{constructor(){super(...arguments);this.listeners={}}init(t){super.init(t,"testResult"),this.listeners={}}listenToTestResult(t,r,n){this.listeners[t]&&(this._socket.off("testResult:updated",this.listeners[t]),delete this.listeners[t]),this.listeners[t]=i=>{i.resultId===t&&i.testId===r&&n(i.testResult)},this._socket.on("testResult:updated",this.listeners[t])}emitJoinRoom(t,r){return this.emitPromise("testResult:join",{resultId:t,testId:r})}async joinToTestResult(t,r){this.rooms[t]||this.joinRoom(t,r),await this.emitJoinRoom(t,r)}emitLeaveRoom(t,r){return this.emitPromise("testResult:leave",{resultId:t,testId:r})}leaveTestResult(t,r){return this.listeners[t]?(this.leaveRoom(t),this._socket.off("testResult:updated",this.listeners[t]),delete this.listeners[t],this.emitLeaveRoom(t,r)):Promise.resolve()}getSocket(){return this._socket}},Dr=new Au});var bh={};z(bh,{testResultService:()=>Lt});var yh,Cu,Lt,Bo=v(()=>{"use strict";yh=require("events");Mo();oe();de();hh();Cu=class extends yh.EventEmitter{init(e){if(O.flags.useNewWSCLI.isEnabled()){wt.onConnect=()=>this.emit("socket-connected");return}Dr.init(e),Dr.onConnect=()=>this.emit("socket-connected")}joinToTestResult(e,t){return O.flags.useNewWSCLI.isEnabled()?wt.addFilter(`${e}:testResult`,{resultId:e,testId:t},[Ct.TEST_RESULT_UPDATED,Ct.TEST_RESULT_CREATED]):Dr.joinToTestResult(e,t)}async leaveTestResult(e,t){if(O.flags.useNewWSCLI.isEnabled()){wt.removeFilter(`${e}:testResult`,[Ct.TEST_RESULT_UPDATED,Ct.TEST_RESULT_CREATED]);return}await Dr.leaveTestResult(e,t)}listenToTestResult(e,t,r){if(O.flags.useNewWSCLI.isEnabled()){wt.listenTo(`${e}:testResult`,[Ct.TEST_RESULT_UPDATED,Ct.TEST_RESULT_CREATED],n=>n.resultId===e&&n.testId===t,n=>r(n));return}Dr.listenToTestResult(e,t,r)}getSocket(){if(!O.flags.useNewWSCLI.isEnabled())return Dr.getSocket()}},Lt=new Cu});var wh,vh,Sh,Se,sE,Eh,Th,nE,jo,Ih=v(()=>{"use strict";wh=I(require("lodash"));B();ae();$e();Rr();ct();ge();ah();vh=I(require("p-retry")),Sh=require("node:url");$();No();gs();oe();Fo();Bo();ge();Se=C("test-run-handler"),sE=3,Eh=20*1e3,Th=s=>JSON.stringify(s).length<Eh,nE="Test couldn't be started",jo=class{constructor(e,t,r,n,i,o){this._executionId=e;this._executionName=t;this._options=n;this._branch=i;this._testRunStatus=o;this.seleniumPerfStats=new Ar;this._totalRetryCount=1;this._retryCount=1;this._timeoutRetryCount=1;this.testInfraIssueRetryCount=2;this.isRerunOnTestStartTimeOutError=!1;this.clearTestResultFinished=Promise.resolve(void 0);var c,l;this._testStatus=r.testStatus,this._testId=r.testId,this._testOptimization=r.testOptimization,this._testName=r.name,this._testResultId=r.resultId,this._baseUrl=n.baseUrl||r.baseUrl||r.testConfig.baseUrl,this._nativeApp=r.nativeApp,this._overrideTestConfig=r.overrideTestConfig||r.testConfig,this._overrideTestConfigId=(c=r.overrideTestConfig)==null?void 0:c.id,this._maxRetryCount=n.retries,this._remoteRunId=n.remoteRunId;let a=!((l=r.runConfig)!=null&&l.isMobileWeb)&&n.browser;this._runConfig=a?rn(n.browser,n.saucelabs,n.browserstack):r.runConfig}async waitForExecutionStartedFinished(){return await this._testRunStatus.waitForExecutionStartedFinished(),await this.clearTestResultFinished}get testStatus(){return this._testStatus}get runMode(){return this._options.mode}get runConfig(){return this._runConfig}get testResultId(){return this._testResultId}get baseUrl(){return this._baseUrl}set baseUrl(e){this._baseUrl=e}get executionId(){return this._executionId}get nativeApp(){return this._nativeApp}get executionName(){return this._executionName}getSauceLabsAppPath(e,t){var r,n;return this.isAppFromDevice?null:t?e.includes("us-west-1")?t.usSauceLabsAppId:t.euSauceLabsAppId:e.includes("us-west-1")?(r=this._nativeApp)==null?void 0:r.usSauceLabsAppId:(n=this._nativeApp)==null?void 0:n.euSauceLabsAppId}getAppPath(e,t){var r;return this.isAppFromDevice?null:t?t[e]:(r=this._nativeApp)==null?void 0:r[e]}getAppPathByGridType(e,t,r){var n,i,o,a;return this.isAppFromDevice?null:r?(i=(n=r.gridData)==null?void 0:n[e])==null?void 0:i[t]:this._nativeApp&&"gridData"in this._nativeApp?(a=(o=this._nativeApp.gridData)==null?void 0:o[e])==null?void 0:a[t]:null}get appPackageNameOrBundleId(){return this.nativeAppMetadata?this.nativeAppMetadata.id||this.nativeAppMetadata.packageName:null}get androidActivityWait(){var r;let e=(r=this.nativeAppMetadata)==null?void 0:r.activity;if(!e)return null;let t=e.split(".").pop();return e.replace(t,"*")}get isAppFromDevice(){return tn(this._nativeApp)}get isAppForIosVirtualDevice(){var t;let e=(t=this._options.gridData)==null?void 0:t.type;return Xr(this._nativeApp,e)}get getAppSource(){if(this._nativeApp)return this.isAppFromDevice?ki.FROM_DEVICE:ki.FROM_LIBRARY}get downloadableAppPublicLink(){return this._nativeApp&&"filePath"in this._nativeApp?`${he()}/storage${this._nativeApp.filePath}?access_token=${this._options.authData.token}`:null}get mobileApp(){return this._nativeApp}set nativeApp(e){this._nativeApp=e}get nativeAppMetadata(){return this._nativeApp?"appMetadata"in this._nativeApp?this._nativeApp.appMetadata:this._nativeApp:null}get branch(){return this._branch}get sfdcCredential(){return this._options.sfdcCredential}get remoteRunId(){return this._remoteRunId}get overrideTestConfig(){return this._overrideTestConfig}get overrideTestConfigId(){return this._overrideTestConfigId}markClearBrowser(){this.clearBrowser=!0}async isTestRecordedWithEnhancedMode(){return(await $n({projectId:this._options.project,testId:this.testId,branch:this.branch})).domMode==="enhanced"}async getRunRequestParams(){var r,n;let t={tokenV3:await kt(),refreshToken:Yi(),projectId:this._options.project,executionId:this._executionId,executionName:this._executionName,testId:this._testId,resultId:this._testResultId,baseUrl:this._baseUrl,branch:this._branch,servicesUrl:Ld(),remoteRunId:this.remoteRunId,previousTestResultId:this.previousTestResultId,testRetryCount:this.retryCount,...this._options.shouldMonitorPerformance&&{shouldMonitorPerformance:!0},...this._options.company&&{companyId:this._options.company.companyId,planType:this._options.company.planType,isPOC:this._options.company.isPOC,isStartUp:this._options.company.isStartUp},...this._options.collectCodeCoverage&&{codeCoverageUrlFilter:this._options.codeCoverageUrlFilter||`${this.baseUrl}*`},...this._options.disableMockNetwork&&{disableMockNetwork:this._options.disableMockNetwork},...this._options.lightweightMode&&{lightweightMode:this._options.lightweightMode},...this.clearBrowser&&{clearBrowser:!0},...this._options.localRCASaver&&{localRCASaver:this._options.localRCASaver},...this.sfdcCredential&&{sfdcCredential:this.sfdcCredential},userAccessKey:await Xi()};if(this._options.disableMockNetwork&&bt("user-disable-mock"),t.lightweightMode&&((r=this._options.lightweightMode)!=null&&r.general)){Object.assign(t,{company:this._options.company});let i=this.runData,o=Th(i);Object.assign(t.lightweightMode,{isRunDataSentInUrl:o});let a=JSON.stringify(i).length,c=this.testId;o?(Object.assign(t,{runData:i}),Se.info(`Run data sent as URL param, test id: ${c} run data length: ${a}`)):Se.warn(`Run data is too big to be sent as a URL param. Test id: ${c}, run data size: ${a} (limit: ${Eh} characters)`),Object.assign(t,{isLocalRun:Boolean(this._options.useLocalChromeDriver||this._options.useChromeLauncher)})}if((n=this._options.lightweightMode)!=null&&n.preloadTests&&this._options.useChromeLauncher){let i=await jn(this._options);Object.assign(t,{preloadedTest:i[t.testId]})}return t}async getRunTestUrl(){let e=await this.getRunRequestParams(),t=`https://run.testim.io/?params=${encodeURIComponent(JSON.stringify(e))}`;return Se.info(`Test (${this.testId}) run URL length: ${t.length}`),t}set sessionId(e){this._sessionId=e}get sessionId(){return this._sessionId}get testId(){return this._testId}get testOptimization(){return this._testOptimization}get testName(){return this._testName}get runParams(){var e;return((e=this._options.runParams)==null?void 0:e[this._testResultId])||{}}get runData(){return{userParamsData:this.runParams,overrideTestConfigId:this._overrideTestConfigId||null}}async clearTestResult(){var i;let e={...this.runData,...this._options.mockNetworkRules&&{mockNetworkRules:this._options.mockNetworkRules}},t=this._timeoutRetryCount>1||this._retryCount>1;if((i=this._options.lightweightMode)!=null&&i.disableResults&&!t&&Th(e))return;let r=async()=>{try{return await Ou(this._options.project,this._testId,this._testResultId,e)}catch(o){return Se.error("failed to upload run data artifact (runner)",{err:o}),""}},n=async()=>{let o=await r();return await this._testRunStatus.waitForExecutionStartedFinished(),ku(this._options.project,this._testResultId,this._testId,{name:this._testName,resultId:this._testResultId,status:"pending",retryCount:this._retryCount,runDataUrl:o,runData:o?void 0:e,testRetryKey:this.retryKey})};return this.clearTestResultFinished=n(),this.clearTestResultFinished}hasMoreRetries(){return this._retryCount<this._maxRetryCount}isSeleniumHubNoMatchSessionError(e){return/Session \[([a-zA-Z0-9]+)\] not available and is not among the last \d+ terminated sessions/.test(e)}isRerunOnInfraError(e){return(this.isSeleniumHubNoMatchSessionError(e)||e===nE||this.isRerunOnTestStartTimeOutError)&&this.testInfraIssueRetryCount}setReRunOnTestStartTimeOutError(e){this.isRerunOnTestStartTimeOutError=e}decreaseInfraErrorRetry(){this.testInfraIssueRetryCount--}get retryOnInfraErrors(){return Boolean(this.testInfraIssueRetryCount)}get retryKey(){return`${this._retryCount}:${this._timeoutRetryCount}`}startNewRetry(){return this._retryCount++,this._timeoutRetryCount=1,this.onRetry()}async runTestUsingCDP(e){U("runTestUsingCDP");let{targetInfos:t}=await e.cdpCommand("Target.getTargets")||{targetInfos:[]},r=new Set(["Testim Editor","Tricentis Testim Editor","Service Worker chrome-extension://pebeiooilphfmbohdbhbomomkkoghoia/background/background.js"]),{targetId:n}=t.find(o=>(o.type==="background_page"||o.type==="service_worker")&&r.has(o.title))||{},{targetId:i}=t.find(o=>o.type==="page")||{};if(!n)throw new Error("Tricentis Testim extension not found");if(!i)throw new Error("AUT target not found");try{U("before Target.attachToTarget");let[o,a]=await Promise.all([e.cdpCommand("Target.attachToTarget",{targetId:n,flatten:!0}),this.getRunRequestParams()]),{sessionId:c}=o||{};U("before Runtime.evaluate"),await(0,vh.default)(async()=>{let{result:d}=await e.cdpCommand("Runtime.evaluate",{expression:"typeof runTestimTest !== 'undefined'",returnByValue:!0},c);if(!d.value)throw new Error("runTestimTest not available on global scope")},{retries:100,minTimeout:30,factor:1}),U("after wait for runTestimTest function");let{result:l}=await e.cdpCommand("Runtime.evaluate",{expression:`runTestimTest(${JSON.stringify(a)})`,awaitPromise:!0,returnByValue:!0},c);if(l.subtype==="error")throw new Error(l.description);return U("after Runtime.evaluate"),l.value}catch(o){throw Se.error("error running test using CDP",{err:o}),new Error("Error running test using CDP")}}isRetryKeyMismatch(e){return e.testRetryKey&&e.testRetryKey!==this.retryKey}validateRunConfig(){let{baseUrl:e,runConfig:{browserValue:t}}=this;if(e&&t==="safari"){let r;try{r=new Sh.URL(e)}catch{return}let{username:n,password:i}=r;if(n||i)throw new Error("Basic authentication in URL is not supported in Safari")}}onStarted(e){return new Promise(t=>{let r=!1,n=i=>{if(!r){if(this.isRetryKeyMismatch(i)){Se.warn(`ignoring result update for on started due to retry key mismatch, got ${i.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId});return}["running","completed"].includes(i.status)&&(i.resultId=this.testResultId,i.status==="completed"&&!this.isRerunOnInfraError(i.reason)&&(Se.info("setting _wasCompletedOnStartedCheck to true",{testResult:i,resultId:this.testResultId,testId:this.testId,testRetryKey:this.retryKey}),this._wasCompletedOnStartedCheck=i),r=!0,t(i))}};if(this._options.disableSockets){let i=Date.now()+e,o=async()=>{if(Date.now()>i)return;let{testId:a,testResultId:c,branch:l,_options:{project:d}}=this;try{let m=await Nr(a,c,d,l);n(m),r||setTimeout(o,3e3)}catch(m){Se.error("failed to check if done",{err:m}),setTimeout(o,3e3)}};setTimeout(o,3e3)}else Lt.listenToTestResult(this._testResultId,this._testId,n)})}async checkViaRestAPIIfTestStarted(){let{testId:e,testResultId:t,_options:{project:r},branch:n}=this;try{let i=await Nr(e,t,r,n),o=["running","completed"];if(o.includes(i.status))return Se.info(`get status: ${i.status} after not get test started status`,{testId:e,testResultId:t,branch:n}),i;throw Se.error(`test not start test status: ${i.status} (expected [${o.join(", ")}])`,{testId:e,testResultId:t,branch:n}),new Error(Ue.TEST_START_TIMEOUT_MSG)}catch(i){throw Se.error("failed to get test result after test start timeout",{err:i,testId:e,testResultId:t,branch:n}),new Error(Ue.TEST_START_TIMEOUT_MSG)}}async onCompletedCleanup(){if(!this._options.disableSockets)return await Lt.leaveTestResult(this._testResultId,this._testId)}async onCompleted(){let e;try{let t=await new Promise(r=>{if(this._wasCompletedOnStartedCheck&&!this.isRetryKeyMismatch(this._wasCompletedOnStartedCheck)){Se.info("test was already completed in on started check",{resultId:this.testResultId,testId:this.testId}),r(this._wasCompletedOnStartedCheck);return}this._options.disableSockets||Lt.listenToTestResult(this._testResultId,this._testId,o=>{if(this.isRetryKeyMismatch(o)){Se.warn(`ignoring result update for on completed due to retry key mismatch, got ${o.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId});return}o.status==="completed"&&(o.resultId=this._testResultId,r(o))});let n=this._options.disableSockets?0:Math.floor(1e4+Math.random()*5e3),i=this._options.disableSockets?0:Math.floor(6e4+Math.random()*15e3);if(e=wh.debounce(async()=>{try{await Lt.joinToTestResult(this._testResultId,this.testId)}catch(o){Se.error("failed joining to test result updates after socket reconnected",{error:o})}try{let o=await Nr(this._testId,this._testResultId,this._options.project,this.branch);return this.isRetryKeyMismatch(o)?(Se.warn(`ignoring result update for on completed (in reconnect) due to retry key mismatch, got ${o.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId}),!1):(o==null?void 0:o.status)==="completed"?(Se.info("Socket reconnected - Test complete",{testId:this._testId,resultId:this._testResultId,projectId:this._options.project}),o.resultId=this._testResultId,r(o),!0):!1}catch(o){return Se.warn("Error while trying to check status on socket connect",o),!1}},n,{maxWait:i}),!this._options.disableSockets)Lt.on("socket-connected",e);else{let o=()=>{setTimeout(async()=>{try{let{isComplete:a}=await Pu(this._testResultId,this._options.project,this.retryKey);a?await e()||(Se.warn("onConnected returned false even though isComplete was true"),o()):o()}catch(a){Se.error("failed to check is complete",{err:a}),o()}},3e3)};o()}});return await this.onCompletedCleanup(),t}finally{e&&!this._options.disableSockets&&Lt.off("socket-connected",e)}}listenToRemoteStep(e){Is.listenToRemoteStep(this.testResultId,t=>{oh(this._options,e,t,this.testResultId)})}hasMoreTimeoutRetries(){let e=this._options.disableTimeoutRetry?1:sE;return this._timeoutRetryCount<e}decreaseRetryCount(){this._retryCount--,this._totalRetryCount--}startNewTimeoutRetry(){return this._timeoutRetryCount++,this.onRetry()}get retryCount(){return this._retryCount}get previousTestResultId(){return this._previousTestResultId}isAllowReportTestResultRetries(){var e,t,r;return Boolean((r=(t=(e=this._options.company)==null?void 0:e.activePlan)==null?void 0:t.premiumFeatures)==null?void 0:r.allowReportTestResultRetries)}async onRetry(){var e;this._previousTestResultId=this.testResultId,this.isAllowReportTestResultRetries()&&(this._totalRetryCount++,this._originalTestResultId||=this._previousTestResultId,this._testResultId=re(),!((e=this._options.lightweightMode)!=null&&e.onlyTestIdsNoSuite)&&await this._testRunStatus.addRetryTestResult({retryCount:this._totalRetryCount,executionId:this._executionId,projectId:this._options.project,newResultId:this._testResultId,originalTestResultId:this._originalTestResultId,previousTestResultId:this._previousTestResultId}))}}});var $o,Rh=v(()=>{"use strict";Ih();$o=class{constructor(e,t,r,n,i,o){this.pendingAppUploads=new Map;let a=new Set(r.map(c=>{var l;return(l=c.nativeApp)==null?void 0:l.appId}).filter(Boolean));!n.appId&&a.size>1&&a.forEach(c=>{this.pendingAppUploads.set(c,{isUploaded:!1,uploadedAppId:""})}),n.appId&&this.pendingAppUploads.set(n.appId,{isUploaded:!1,uploadedAppId:""}),this._waitingTests=r.map(c=>new jo(e,t,c,n,i,o))}stop(){this._waitingTests=[]}getNext(){let e=this._waitingTests.shift();if(e)return e}hasMoreTests(){return Boolean(this._waitingTests.length)}}});async function Ah(s,e){var t;return(t=s.lightweightMode)!=null&&t.onlyTestIdsNoSuite&&s.testId?{tests:[s.testId.map(n=>({testId:n,testConfig:{},resultId:re()}))]}:await Du({projectId:s.project,labels:s.label,testIds:s.testId,testNames:s.name,testConfigNames:s.testConfigNames,suiteNames:s.suites,suiteIds:s.suiteIds,branch:e,rerunFailedByRunId:s.rerunFailedByRunId,testConfigIds:s.testConfigIds,intersections:s.intersections})}function _u(s){let e=Object.keys(s).length,t=Object.keys(s).reduce((r,n)=>r+(s[n].success===!0?1:0),0);return e===t}async function Lu(s,e){let t=s.mode===K.EXTENSION?Mr:Vn,r=xh.difference(Zs(s,e),t);if(r.length>0)throw bt("invalid-config-run",{browser:r.join(", "),mode:"runner"}),new A(`browser type <${r}> is not supported in ${s.mode} mode.`);return e}var xh,Mr,Vn,Wo=v(()=>{"use strict";xh=I(require("lodash"));B();Rr();ge();X();oe();Mr=["edge-chromium","chrome"],Vn=[...Mr,"firefox","safari","safari technology preview"]});var iE,oE,aE,Gn,Nu=v(()=>{"use strict";as();ds();$();iE=C("worker-utils"),oE=async(s,e,t)=>{e&&await Tl(s,t)},aE=async(s,e,t)=>{await Gl(s,e,t)},Gn=async(s,e,t,r,n,i)=>{iE.info("releasing player",{hasPlayer:Boolean(i)});try{await(i==null?void 0:i.onDone())}finally{n==="mongo"&&await oE(s,e,t),n==="redis"&&await aE(s,r,t)}}});function pE(s,e,t,r){return{testId:s,reason:r,name:e,resultId:t,success:!1}}var Go,kh,Ho,Fu,Oh,vt,Ch,Ph,Mu,Hn,cE,Uu,lE,ir,uE,Vo,dE,Dt,qn=v(()=>{"use strict";Go=I(require("ms")),kh=I(require("lodash")),Ho=I(require("p-retry")),Fu=I(require("dayjs")),Oh=I(require("dayjs/plugin/duration"));B();$e();as();ds();ge();$();Nu();_t();Ao();de();Fo();Bo();ct();Ge();oe();X();Fu.default.extend(Oh.default);vt=C("base-worker"),{GET_BROWSER_TIMEOUT_MSG:Ch,TEST_START_TIMEOUT_MSG:Ph,TEST_COMPLETE_TIMEOUT_MSG:Mu}=Ue,{SETUP_TIMEOUT:Hn,NETWORK_ERROR:cE,GRID_ERROR:Uu,BROWSER_CLOSED:lE,SELENIUM_ERROR:ir,UNKNOWN_ERROR:uE,MOBILE_SESSION_ERROR:Vo}=Qs;dE=["fullLogs","locatorStats","stepsResults","setupStepResult","sharedStepClasses","revisionStatus","revisions","testData","exportsGlobal"],Dt=class{constructor(e,t,r,n,i,o,a,c,l=!0){this.executionQueue=e;this.options=t;this.customExtensionLocalLocation=r;this.executionId=n;this.onTestStarted=i;this.onTestCompleted=o;this.onGridSlot=a;this.onTestIgnored=c;this.releaseSlotOnTestFinished=l;this.lambdatestService=new ne;this.id=0;this.uniqueId="";this.baseUrl=t.baseUrl,this.testRunTimeout=t.timeout,this.userData=t.userData}async getGridSlot(e,t){let r=await Tf(e,t.executionId,this.options,this.id,t.testResultId);return this.onGridSlot(t.testResultId,r),r}async getSlotOnce(e){let{browserValue:t}=this.testRunConfig;return Q.onGetSlot(this.id,t||"chrome"),await this.getGridSlot(t,e)}initPlayer(e){throw new Hs(!0)}async getBrowserOnce(e,t,r,n){throw new Hs(!0)}async runTestOnce(e,t){return e.sessionId=t.getSessionId(),vt.info("Test run started",{testId:e.testId,resultId:e.testResultId,seleniumSession:t.getSessionId(),executionId:e.executionId}),await e.clearTestResult()}handleQuarantine(e){if(!Xe({testStatus:e.testStatus},this.options))return;let t={name:e.testName,testId:e.testId,resultId:e.testResultId,runnerStatus:fe.SKIPPED,testStatus:e.testStatus,testOptimization:e.testOptimization};return this.onTestIgnored(this.id,t),t}handleMobileTest(e){var n,i;if(((n=this.options.gridData)==null?void 0:n.mode)==="local")return;let t=Qr(O,(i=this.options.gridData)==null?void 0:i.type)&&e.isAppFromDevice&&!this.options.appId,r=e.isAppForIosVirtualDevice;if(t||r){let o={name:e.testName,testId:e.testId,resultId:e.testResultId,runnerStatus:fe.SKIPPED,testStatus:e.testStatus,mobile:{isAppFromDevice:t,isAppForIosVirtualDevice:r}};return this.onTestIgnored(this.id,o),o}}calculateMobileTestTimeout(e){let t=O.flags.increaseTDCRequestTimeout.isEnabled(),r=e===_.TESTIM_TDC||e===_.TESTIM_HEADSPIN,n=hr(O.flags.appiumConnectionRequestTimeout.getValue(),(0,Go.default)("2m")),i=hr(O.flags.appiumConnectionRetryCount.getValue(),1),o=n*i;return e===_.BROWSERSTACK||t&&r?o+(0,Go.default)("10m"):o+(0,Go.default)("1m")}getSessionTimeout(){if(Yt(this.options)){let t=this.options.gridData.type,r=this.calculateMobileTestTimeout(t);return Math.max(r,this.options.getSessionTimeout)}return Math.max(this.lambdatestService.getSessionTimeout||0,this.options.getSessionTimeout)}async getGridInfoAndSlotFromMongoGridQueue(e){let t=0;return{gridInfo:await(0,Ho.default)(async()=>{let n=Date.now();try{return await pe(this.getSlotOnce(e),this.options.getBrowserTimeout,Ue.GET_BROWSER_TIMEOUT_MSG)}catch(i){return t++,await this.handleGetSlotError(i,n)}},{retries:this.options.getBrowserRetries-1,minTimeout:0,factor:1}),failedAttemptsCount:t}}async getSlotFromCompanySlotManager(){let e=0;return{slotId:await(0,Ho.default)(async()=>{var n,i;let r=Date.now();try{let o=(n=this.options.company)==null?void 0:n.companyId,a=(i=this.options.projectData)==null?void 0:i.projectId;return await pe(Hf(o,a,this.id),this.options.getBrowserTimeout,Ue.GET_BROWSER_TIMEOUT_MSG)}catch(o){return e++,await this.handleGetSlotError(o,r)}},{retries:this.options.getBrowserRetries-1,minTimeout:0,factor:1}),failedAttemptsCount:e}}async handleGetSlotError(e,t){let r={testId:this.testId,testResultId:this.testResultId,executionId:this.executionId};throw e instanceof Kt?vt.info("could not get grid slot due to concurrency issue",r):vt.error("error getting grid slot",{error:e,...r}),await ue(this.options.getBrowserTimeout-(Date.now()-t)),e}async handleGetSlot(e){if(this.options.slotService==="redis"){let{failedAttemptsCount:t}=await this.getSlotFromCompanySlotManager();return{gridInfo:this.options.gridData,failedAttemptsCount:t}}return await this.getGridInfoAndSlotFromMongoGridQueue(e)}async getTestPlayer(e,t){var i;let r=(i=this.userData)==null?void 0:i.projectId,n;try{U("before getSlotOnce retries");let{failedAttemptsCount:o,gridInfo:a={}}=await this.handleGetSlot(e);U("before getBrowserOnce retries");let c=this.options.getBrowserRetries-o;if(!c)throw new Error("No free browser slots in desired grid");let l=0;n=await(0,Ho.default)(async()=>{let d=Date.now(),m=this.initPlayer(e);try{let u=await wf(this.options,a,this.testRunConfig,this.lambdatestService,{maxRetries:c,currentRetry:l+1});this.options.gridData.provider=u.provider,this.options.gridData.host=u.host,this.options.gridData.failedGetBrowserAttempts=l,U("before getBrowserOnce");let f=await pe(this.getBrowserOnce(e,t,m,u),this.getSessionTimeout(),Ue.GET_BROWSER_TIMEOUT_MSG);return U("after getBrowserOnce"),Q.onGetBrowserSuccess(this.id,r),m||f}catch(u){let f={...a,failedGetBrowserAttempts:l,id:this.options.gridData.gridId},h=this.options.mode===K.APPIUM?"device":"browser";throw vt.error(`error getting ${h} from grid`,{error:u,testId:this.testId,testResultId:this.testResultId,executionId:this.executionId,grid:f,publicIps:this.options.publicIps}),Q.onGetBrowserFailure(this.id,r,++l),m.onDone(),!(u instanceof xt)&&this.options.mode!==K.APPIUM&&await ue(this.options.getBrowserTimeout-(Date.now()-d)),u}},{retries:c-1,minTimeout:0,factor:1}),U("after getBrowserOnce retries")}catch(o){throw await Gn(this.id,this.releaseSlotOnTestFinished,r,this.options.company.companyId,this.options.slotService,n),[xt,zr].some(a=>o instanceof a)?o:o instanceof st?new fr(o,Uu):new fr(o,ir)}return n}async runTest(e,t,r){var d;U("inside runTest");let n=(d=this.userData)==null?void 0:d.projectId,i=this.handleQuarantine(e);if(i)return i;let o=Yt(this.options)&&this.handleMobileTest(e);if(o)return o;U("before runTest onTestStarted");let a=e.getAppSource,c=await this.onTestStarted(this.id,e.testId,e.testResultId,r,e.retryKey,a);e.baseUrl=c.config.baseUrl;let l=await this.getTestPlayer(e,t);try{return this.userData.loginData.token=await kt(),await this.runTestOnce(e,l)}finally{await Gn(this.id,this.releaseSlotOnTestFinished,n,this.options.company.companyId,this.options.slotService,l)}}async runTestCleanup(){}async onQueueCompleted(){}run(e,t,...r){var f,h;let n=async(g,y)=>{var L,M;if(Xe(g,this.options)||Qr(O,(L=this.options.gridData)==null?void 0:L.type)&&e.isAppFromDevice&&!this.options.appId||e.isAppForIosVirtualDevice){t(this.id,...r);return}let T=e.sessionId;e.setReRunOnTestStartTimeOutError(!1);let w=V=>y==null?void 0:y.message.includes(V),b=y&&y instanceof fr,S=w(Ph),E=y&&(w(Mu)||S&&!e.retryOnInfraErrors),D=(!!g.reason&&e.isSeleniumHubNoMatchSessionError(g.reason)||S)&&e.retryOnInfraErrors,G=E&&e.hasMoreTimeoutRetries(),x=e.hasMoreRetries()&&!b&&!E,R=!g.success&&(x||G||D);try{let V=e.retryKey;g.testRetryKey=V;let W=e.getAppSource;if(await this.onTestCompleted(this.id,this.testId,g,T,R,W),await this.runTestCleanup(),R){if(G&&await e.startNewTimeoutRetry(),D){vt.info(`retry test id: ${this.testId} name: ${this.testName} again due to infrastructure issues`,{testId:e.testId,retryReason:g.reason,testName:this.testName,testResultId:this.testResultId,executionId:this.executionId,err:y});let q=(M=this.options.projectData)==null?void 0:M.projectId,ie=e.testResultId,Ee=e.testId;await qo(q,ie,Ee,{show:!1}),e.decreaseInfraErrorRetry(),e.decreaseRetryCount(),e.setReRunOnTestStartTimeOutError(!0),await e.startNewRetry()}return x&&!D&&!G&&await e.startNewRetry(),vt.info(`retry test id: ${this.testId} name: ${this.testName} again`,{testId:this.testId,testName:this.testName,isTimeoutErrors:E,testRetryKey:V,totalRetries:e._totalRetryCount}),this.testResultId=e.testResultId,await u(R)}t(this.id,...r);return}catch(V){if(V instanceof zt)return;vt.error("failed to process test result",{error:V}),t(this.id,...r);return}},i=()=>`Due to network connectivity issues, Testim CLI has been unable to connect to the grid.
Please make sure the CLI has stable access to the internet. ${_c()?"(Internal: network connectivity test failed)":""}`,o=g=>{let{DEVICE_OS_VERSION_TOO_LOW:y,APP_NOT_EXIST_ON_DEVICE:T,APP_NEVER_STARTED:w,TIMEOUT_ERROR:b,SAUCELABS_APP_IS_NOT_INSTALLED:S}=jc,E=g instanceof Error?g.message:g;return E.replace(/(Visit\s+)?(https?:\/\/\S+)?(\s+)?(for\s+troubleshooting(\.)?)?/gi,""),E.includes(Ch)||E.includes(b)?{errorType:Hn,reason:"timeout while getting device"}:E.includes(T)||E.includes(S)?{errorType:Vo,reason:"app doesn't exist on device"}:E.includes(w)?{errorType:Vo,reason:"app never started, check app permission or app activity"}:E.includes(y)?{errorType:Vo,reason:"Unable to install app: DeviceOSVersionTooLow"}:{errorType:Vo,reason:E}},a=(g,y)=>{let T=this.options.mode===K.APPIUM?"device":"browser";if(!y&&O.flags.errorMessageOnBadNetwork.isEnabled())return{errorType:cE,reason:i()};let w=g instanceof Error?g.message:g;if(w.includes(Ch))return{errorType:Hn,reason:`Test couldn't get ${T}`};if(w.includes(Ph))return{errorType:Hn,reason:"Test couldn't be started"};if(w.includes(Mu)){if(!this.testRunTimeout)return{errorType:Hn,reason:"Test timeout reached: test is too long"};let b=Fu.default.duration({milliseconds:this.testRunTimeout}),S=Math.floor(b.asMinutes()),E=b.asSeconds(),k=S>0?` ${S} min`:"",D=E>0?` ${E} sec`:"";return{errorType:Hn,reason:`Test timeout reached (timeout:${k}${D}): test is too long`}}if(g instanceof fr&&g.type){if(g.type===Uu)return{errorType:Uu,reason:`Test couldn't get ${T} from grid - ${g.message}`};if(g.type===ir)return{errorType:ir,reason:`Failed to create new session - ${g.message}`}}return"type"in g&&g.type===lE?{errorType:ir,reason:`Session terminated, this is often caused to connection
                                problems between the Testim CLI and the grid running the test. Please check your network connection.`}:/SeleniumError: connect ECONNREFUSED/.test(g.message)||/Couldn't connect to selenium server/.test(g.message)?{errorType:ir,reason:"Failed to connect to the grid, please check if the grid is accessible from your network"}:/terminated due to FORWARDING_TO_NODE_FAILED/.test(g.message)?{errorType:ir,reason:"Session terminated, it is likely that the grid is out of memory or not responding, please try to rerun the test"}:/terminated due to PROXY_REREGISTRATION/.test(g.message)?{errorType:ir,reason:"Session terminated, it is likely that the grid is not responding, please try to rerun the test"}:/forwarding the new session cannot find : Capabilities/.test(g.message)?{errorType:ir,reason:`Session could not be created, please check that the ${T} you requested is supported in your plan`}:{errorType:uE,reason:w}},c=async g=>{var S;let y=await Oc();!y&&O.flags.warnOnBadNetwork.isEnabled()&&console.warn(i()),vt.warn("error on run",{err:g});let T=(S=this.userData)==null?void 0:S.projectId,{errorType:w,reason:b}=this.options.mode===K.APPIUM?o(g):a(g,y);qo(T,this.testResultId,this.testId,{status:Xs.COMPLETED,success:!1,reason:b,errorType:w,testRetryKey:e.retryKey,setupStepResult:{status:Xs.COMPLETED,success:!1,reason:b,errorType:w}},e.remoteRunId),await n(pE(this.testId,this.testName,this.testResultId,b),g)},l=async g=>{var S;let y=this.testId,T=this.testResultId,w=(S=this.userData)==null?void 0:S.projectId,b=this.branch;if(!y||!T||!w||!b)return vt.warn("Test failed. Not enough data to recover results via API",{err:g}),c(g);try{let E=await Nr(y,T,w,b);if(vt.warn("Test failed. Got results via API",{err:g,testResult:kh.default.omit(E,dE),resultId:T}),E&&E.status===Xs.COMPLETED&&!g.message.includes(Mu))return await n(E);throw g}catch(E){return E!==g&&vt.error("Failed to fetch test results from server",{testId:y,resultId:T,projectId:w,branch:b,err:E}),c(g)}},d=this.options.disableSockets||((f=this.options.lightweightMode)==null?void 0:f.disableResults)&&(this.options.useChromeLauncher||this.options.mode===K.SELENIUM),m=this.options.disableSockets||((h=this.options.lightweightMode)==null?void 0:h.disableRemoteStep),u=async g=>{try{await Promise.all([!m&&Is.joinToRemoteStep(this.testResultId),!d&&Lt.joinToTestResult(this.testResultId,this.testId)]),this.options.mode!==K.APPIUM&&e.validateRunConfig();let y=await this.runTest(e,this.customExtensionLocalLocation,g);await n(y),U("After onRunComplete"),t(this.id,...r)}catch(y){await l(y),t(this.id,...r)}finally{m||Is.unlistenToRemoteStep(this.testResultId)}};return this.testId=e.testId,this.testName=e.testName,this.testResultId=e.testResultId,this.overrideTestConfigId=e.overrideTestConfigId,this.testRunConfig=e.runConfig,this.branch=e.branch,u()}}});var Lh,_h,Rs,Bu=v(()=>{"use strict";B();Lh=I(require("p-retry"));B();$();X();_h=C("window-utils"),Rs=class{constructor(e,t){this.id=e;this.driver=t}async getElementFromPoint(e,t){function r(i,o){let a=document.elementFromPoint(i,o);return{testimId:a?a.getAttribute("testim_dom_element_id"):null,tagName:a?a.tagName:null}}let{value:n}=await this.driver.executeJS(r,e,t);return n}getLocation(){return this.driver.getUrl()}async stopListeningToScroll(){}async resumeListeningToScroll(){}scrollToPosition(e){return this.driver.scroll(e.x,e.y)}scrollToPositionWithoutAnimation(e){function t(r){return"scrollBehavior"in document.documentElement.style?window.scrollTo({left:r.x,top:r.y,behavior:"instant"}):window.scrollTo(r.x,r.y)}return this.driver.executeJS(t,e)}async getCurrentScrollPosition(){function e(){return{x:window.scrollX,y:window.scrollY}}let{value:t}=await this.driver.executeJS(e);return t}navigate(e,t=15e3){let r=async(n=3)=>{try{await this.driver.url(e)}catch(i){let o=i.message.includes("method IWebBrowser2::Navigate2() failed");if(i.seleniumStack&&o&&n>0)return _h.warn("selenium navigation failed. retrying to navigate",{err:i}),await ue(1500),r(n-1);throw!i.seleniumStack&&o&&_h.warn("selenium navigation failed. Due to wdio7 the error is unhandled",{err:i}),i}};return Promise.race([r(),ue(t)])}reloadTab(e=15e3){return Promise.race([this.driver.reloadTab(),ue(e)])}async getZoom(){function e(){return{zoomLevel:window.outerWidth/window.innerWidth}}let{value:t}=await this.driver.executeJS(e);return t}getViewportSize(){return this.driver.getViewportSize()}maximizeWithoutValidation(){return this.driver.maximizeWithoutValidation()}async getFullPageSize(){function e(){let r=document.body,n=document.documentElement,i=Math.max(r.scrollHeight,r.offsetHeight,n.clientHeight,n.scrollHeight,n.offsetHeight),o=Math.max(r.scrollWidth,r.offsetWidth,n.clientWidth,n.scrollWidth,n.offsetWidth);return{height:i,width:o}}let{value:t}=await this.driver.executeJS(e);return t}async extractToNewWindow(){}async checkSize(e){await ue(1e3);let t=await this.getViewportSize();if(t.width!==e.width||t.height!==e.height)throw Object.assign(new Error("checkSize failed"),{actualSize:t,expectedSize:e});return{actualSize:t,expectedSize:e}}async setViewportSize(e){return await this.driver.setViewportSize(e.width,e.height),await this.checkSize(e)}async validatePageIsAvailable(){function e(){let r;if(typeof window<"u"&&window.location!==void 0)r=window.location;else return!1;return r.href!=="chrome-error://chromewebdata/"&&r.href!=="safari-resource:/ErrorPage.html"&&!r.href.startsWith("res://ieframe.dll/http_404.htm")&&!r.href.startsWith("ms-appx-web://microsoft.microsoftedge/assets/errorpages/")}if(!(await this.driver.executeJS(e)).value)throw new xt("validatePageIsAvailable:PageNotAvailableError")}focusTab(){return this.driver.switchTab(this.id)}quit(){}async getOsAndBrowser(){let e=await(0,Lh.default)(()=>this.driver.getBrowserAndOS(),{retries:3,factor:1});return{uaBrowserName:e.browser,uaOs:e.os,userAgent:e.userAgent,browserVersion:e.browserVersion}}}});var ju,xs,$u=v(()=>{"use strict";$();ju=C("cookies-utils"),xs=class{constructor(e){this.driver=e}async set(e){let t=e.domain;!e.hostOnly&&t&&!t.startsWith(".")&&(t=`.${t}`);try{return await this.driver.setCookie(e.name,e.value,t,e.httpOnly,e.secure,e.path,e.expirationDate)}catch(r){throw ju.error("failed to set cookie",{err:r}),r}}async get(e){try{return await this.driver.getCookie(e.name)}catch(t){throw ju.error("failed to get cookie",{err:t}),t}}async remove(e){try{return await this.driver.deleteCookie(e.name)}catch(t){throw ju.error("failed to remove cookie",{err:t}),t}}}});var Wu,zo,Dh=v(()=>{"use strict";Wu=I(require("p-retry")),zo=class{constructor(e,t,r={takeScreenshots:!0}){this.tabId=e;this.driver=t;this.options=r;this.screencastHandler=void 0}base64AddPadding(e){return e+Array((4-e.length%4)%4+1).join("=")}shouldTakeScreenshots(){return typeof this.options.takeScreenshots!="boolean"?!0:this.options.takeScreenshots}async takeScreenshot(){if(!this.shouldTakeScreenshots())return{devicePixelRatio:1,image:""};let e=3,t=2e3,r=this.currentDevicePixelRatio||this.getDevicePixelRatio(),n=()=>Promise.all([r,this.driver.takeScreenshot()]),[i,o]=await(0,Wu.default)(n,{retries:e,minTimeout:t,factor:1}),a=o?o.value:"";return{image:`data:image/png;base64,${this.base64AddPadding(a.replace(/[\r\n]/g,""))}`,devicePixelRatio:i}}async takeElementScreenshot(e){if(!this.shouldTakeScreenshots())return{devicePixelRatio:1,image:""};let t=3,r=2e3,n=this.currentDevicePixelRatio?Promise.resolve(this.currentDevicePixelRatio):this.getDevicePixelRatio(),i=()=>Promise.all([n,this.driver.takeElementScreenshot(e)]),[o,a]=await(0,Wu.default)(i,{retries:t,minTimeout:r,factor:1}),c=a||"";return{image:`data:image/png;base64,${this.base64AddPadding(c.replace(/[\r\n]/g,""))}`,devicePixelRatio:o}}async getDevicePixelRatio(){function e(){try{return window.devicePixelRatio}catch{return 1}}let{value:t}=await this.driver.executeJS(e);return t}forcePixelRatio(e=1){return this.currentDevicePixelRatio=e,Promise.resolve()}getCurrentDevicePixelRatio(){return this.currentDevicePixelRatio}}});async function Nh(s,e){let t=e.image||e,r=e.devicePixelRatio;if(!t)throw new Error("Failed to get image");let n=t.match(/^data:[^;]*;base64,(.*)$/);if(!n)throw new Error("Image is not in base64 format");let i=s.offset||{top:0,left:0};if(i.top*=r,i.left*=r,!s.elementRect)return mE.warn("missing elementRect",Uh.omit(s,"image")),{};let{elementRect:o}=s,a=await Ko.Jimp.fromBuffer(Buffer.from(n[1],"base64")),c=o.left*r+i.left*r,l=o.top*r+i.top*r,d=o.width*r,m=o.height*r;c<0&&(d+=c,d=Math.max(d,0),c=0),l<0&&(m+=l,m=Math.max(m,0),l=0);let u=a.bitmap.width,f=a.bitmap.height;if(c+d>u&&(d=u-c),l+m>f&&(m=f-l),m<=0||d<=0)throw new Vu("height or width is equal or lower than zero");return{elementImage:await a.crop({x:c,y:l,w:d,h:m}).getBase64(Fh)}}async function fE(s,e){let t=new Ko.Jimp({width:s.width,height:s.height});for(let n of e){let i=n.image.match(/^data:[^;]*;base64,(.*)$/),o=await Ko.Jimp.fromBuffer(Buffer.from(i[1],"base64"));t.composite(o,n.position.left,n.position.top)}return await t.getBase64(Fh)}function gE(s,e){return fE(s,e)}async function hE(){}async function yE(s){function e(i){let o=s[i];return typeof o=="string"&&o.startsWith("data")}async function t(i){let o=await hE(s[i]);return{key:i,url:o}}let r=await se(Object.keys(s).filter(e),t),n=Object.fromEntries(r.map(i=>[i.key,i.url]));return Object.assign(s,n)}function Mh(s,e){return e||=1,s||={left:0,top:0,width:0,height:0},{left:e*Math.round(s.left),top:e*Math.round(s.top),width:e*Math.round(s.width),height:e*Math.round(s.height),pixelRatio:e}}var Uh,Ko,mE,Fh,Vu,Jo,Bh=v(()=>{"use strict";Uh=I(require("lodash"));B();Ko=require("jimp");$();mE=C("image-capture-utils"),Fh="image/png",Vu=class extends Error{constructor(){super(...arguments);this.rectIsOutsideOfImageError=!0}};Jo=class{constructor(e,t,r){this.windowUtils=t;this.screenshotUtils=r}async takeViewPortImage(){let e=await this.screenshotUtils.takeScreenshot();return typeof e=="string"?e:e.image}takeImageForComparison(){return this.takeViewPortImage()}async takeAreaDataUrl(e){let t=await this.screenshotUtils.takeScreenshot(),r=await Nh(e,t);return Object.assign(r,{screenImage:t.image,absoluteScreenHighlight:Mh(e.elementRect,t.devicePixelRatio)})}async takeElementImage(e){let t=await this.screenshotUtils.takeElementScreenshot({ELEMENT:e});return{elementImage:typeof t=="string"?t:t.image}}async takeArea(e){let t=await this.screenshotUtils.takeScreenshot();return yE({screenImage:t.image,absoluteScreenHighlight:Mh(e.elementRect,t.devicePixelRatio)})}forcePixelRatio(e){return this.screenshotUtils.forcePixelRatio(e)}getCurrentDevicePixelRatio(){return this.screenshotUtils.getCurrentDevicePixelRatio()}async takeStitchedDataUrl(e){let{windowUtils:t,screenshotUtils:r}=this,n=()=>ue(250),i=Boolean(e);async function o(u,f){i?await t.scrollToPositionWithoutAnimation(u):await t.scrollToPosition(u),await n();let h=await r.takeScreenshot(),g=await Nh({elementRect:f},h);return{position:{left:u.x+f.left,top:u.y+f.top},size:{width:f.width,height:f.height},image:g.elementImage}}async function a(u){let f=[];for(let h of u){let g=await o(h.scrollPos,h.cropData);f.push(g)}return f}function c(u,f){let h=Math.max(u.width,f.width),g=f.width,y=Math.max(u.height,f.height),T=f.height,w=Array.from({length:Math.ceil(h/g)},(S,E)=>({scrollX:Math.min(E*g,h-g),cropX:E*g-Math.min(E*g,h-g),cropW:g-(E*g-Math.min(E*g,h-g))})),b=Array.from({length:Math.ceil(y/T)},(S,E)=>({scrollY:Math.min(E*T,y-T),cropY:E*T-Math.min(E*T,y-T),cropH:T-(E*T-Math.min(E*T,y-T))}));return w.flatMap(S=>b.map(E=>({scrollPos:{x:S.scrollX,y:E.scrollY},cropData:{top:E.cropY,left:S.cropX,width:S.cropW,height:E.cropH}})))}async function l(u,f){let h=await t.getCurrentScrollPosition(),g=c(u,f),y=await a(g);return await t.scrollToPosition(h),gE(u,y)}let[d,m]=await Promise.all([t.getFullPageSize(),t.getViewportSize()]);return await l(d,m)}}});var jh,$h,Yo,Xo,Wh=v(()=>{"use strict";jh=I(require("p-retry")),$h=I(require("semver"));B();$();Bu();Dh();Bh();we();Yo=C("tab-service"),Xo=class{constructor(e){this.driver=e;this.sessionTabs={};this._utils={};this.pendingTabs={};this.addedTabs={}}on(){}tabCount(e){if(this.sessionTabs[e])return this.sessionTabs[e].tabCount}getAllOpenTabIds(e){let t=this.getAllTabInfos(e);return Object.keys(t).filter(r=>!t[r].isClosed)}getActiveTabInfo(e){return this.sessionTabs[e].lastActiveTabInfo}getAllTabIds(e){return Object.keys(this.getAllTabInfos(e)).map(t=>t)}isSessionTab(e,t){return this.getAllTabIds(e).includes(t)}createSesion(e){this.sessionTabs[e]||(this.addedTabs[e]=new Set,this.sessionTabs[e]={pendingInfos:{},tabCount:0,tabInfos:{}})}setAddFrameHandlerCallBack(e){this.addFrameHandler=e}getAllTabInfoStrings(e){return this.getAllTabIds(e).map(r=>{let n=this.getTabInfo(e,r);return`tabId=${r}, url=${n.url}, order=${n.order}, isMain=${n.isMain}, openerStepId=${n.openerStepId}, isClosed=${n.isClosed}, currentUrl: ${n.currentUrl}, lastUpdatedUrl: ${n.lastUpdatedUrl}`})}getAllTabInfos(e){return this.sessionTabs[e].tabInfos}async addNewTab(e,t,r,n){if(!this.addedTabs[e].has(t))return this.addedTabs[e].add(t),Yo.info(`Adding a new tab sessionId: ${e}, tabId: ${t}, openerId: ${r}`),this.addTab(e,t,this.sessionTabs[e].tabCount++,r,n)}addOpenerStepId(e,t,r){this.sessionTabs[e].tabInfos[t].openerStepId=r}addOpenerStep(e,t,r){this.sessionTabs[e].tabInfos[t].openerStepId=r.id,this.sessionTabs[e].tabInfos[t].openerOriginalStepId=r.originalStepId}fixMissingMainTab(e){if(this.getMainTabInfo(e))return;let r=this.getAllTabInfos(e);Object.keys(r).length!==0&&(Object.values(this.getAllTabInfos(e))[0].isMain=!0)}async buildTabInfo(e,t,r,n,i={}){let o=await this.getTabDetails(t,e,i),a=re();function c(l){return i.checkForMainTab?o.isMainTab:!o.isMainTab||o.isMainTab==="unknown"?!l.getMainTabInfo(e):o.isMainTab}return this.sessionTabs[e].tabInfos[t]={infoId:a,url:o.url,title:o.title,favIconUrl:o.favIconUrl,order:r,from:this.getTabInfo(e,o.openerTabId),isMain:c(this),openerStepId:n},a}async addTab(e,t,r,n,i={}){let o=await this.buildTabInfo(e,t,r,n,i),a=new Rs(t,this.driver);this._utils[o]={attachDebugger:()=>Promise.resolve(),detachDebugger:()=>Promise.resolve(),onDebuggerDetached:()=>{},tabId:t,domUtils:{getDOM:async()=>{}},windowUtils:a,imageCaptureUtils:new Jo(t,a,new zo(t,this.driver,{takeScreenshots:i.takeScreenshots}))}}getTabUtilsByTabIdAndSessionId(e,t){let r=this.sessionTabs[e].tabInfos[t];return this._utils[r.infoId]}getTabUtilsByTabId(e){let t=Object.keys(this._utils).find(r=>this._utils[r].tabId===e);return this._utils[t]}getTabInfo(e,t){return this.sessionTabs[e].tabInfos[t]}getTabUtils(e,t){if(!t)return this.getMainTabUtils(e);if(this._utils[t.infoId])return this._utils[t.infoId];if(t.isMain)return this.getMainTabUtils(e);let r=this.getAllTabInfos(e),n=Object.keys(r).map(o=>r[o]).filter(o=>!o.isMain);if(n.length===1)return this._utils[n[0].infoId];let i=Object.keys(e).map(o=>e[o]).filter(o=>this.isSameTab(e,t,o));return i.length>0?this._utils[i[0].infoId]:this.getMainTabUtils(e)}exactUrlMatch(e,t,r){let n=r.filter(i=>i===t.url);return!!((e.url===t.url||e.currentUrl===t.url||e.currentUrl&&e.currentUrl===t.currentUrl)&&n.length===1)}singleExactMatchForParts(e,t,r,n){let{urlUtils:i}=Z(),o=i.urlBreaker(e.url||e.currentUrl),a=i.urlBreaker(t.url||t.currentUrl),c=n(o),l=n(a),d=r.map(m=>i.urlBreaker(m)).map(m=>n(m)).filter(m=>m===c);return c===l&&d.length===1}isSameTab(e,t,r){let{tabMatcher:n}=Z();if(n){let l=this.getAllTabInfos(e),d=Object.keys(l).map(m=>l[m]);return n.isSameTab(d,t,r)}if(t.isMain&&r.isMain||t.openerStepId&&r.openerStepId&&t.openerStepId===r.openerStepId)return!0;let i=this.getAllTabInfos(e),o=Object.keys(i).map(l=>i[l].url);if(this.exactUrlMatch(t,r,o))return!0;let a=l=>`${l.domain}/${l.path.join("/")}`;if(this.singleExactMatchForParts(t,r,o,a))return!0;let c=l=>`${l.domain}/${l.path.join("/")}#${l.hash}`;return!!(this.singleExactMatchForParts(t,r,o,c)||t.order===r.order)}getMainTabInfo(e){let t=this.getAllTabInfos(e);return Object.keys(t).map(r=>t[r]).find(r=>r.isMain)}getMainTabUtils(e){let t=this.getMainTabInfo(e);return t?this.getTabUtils(e,t):{}}removeTabInfo(e,t){let n=this.getAllTabInfos(e)[t];delete this.sessionTabs[e].tabInfos[t],delete this._utils[n.infoId],this.sessionTabs[e].tabCount--}getMainTabId(e){let t=this.getAllTabInfos(e);return Object.keys(t).find(r=>t[r].isMain)}async isMainTabExists(e){let t=this.getMainTabId(e);return Boolean(t)}clearAllTabs(e){let t=this.getAllTabInfos(e);this.sessionTabs[e].tabCount=0,Object.keys(t).forEach(r=>this.removeTabInfo(e,r))}clearNonMainTabs(e){let t=this.getAllTabInfos(e);Object.keys(t).filter(r=>!t[r].isMain).forEach(r=>this.removeTabInfo(e,r)),this.sessionTabs[e].tabCount=1}async switchTab(e,t,{forceSwitch:r=!1}={}){let n=this.sessionTabs[t]?this.sessionTabs[t].tabCount:1;if(typeof n=="number"&&n>1||r)return this.driver.switchTab(e)}async getTabDetails(e,t,r={}){try{if(await this.switchTab(e,t,r),r.skipLoadInfo)return{title:"",url:""};let n=Promise.resolve("unknown");r.checkForMainTab&&(n=this.driver.executeJS("return window.__isMainTestimTab").then(i=>i.value));try{let[i,o,a]=await Promise.all([this.driver.getTitle(),this.driver.getUrl(),n]);return{title:i,url:o,isMainTab:a}}catch(i){Yo.error("failed to get url or title",{err:i})}}catch(n){Yo.error("failed to switch to tab",{tabId:e,err:n})}return{title:"",url:""}}async getUnregisteredTabId(e){return(await this.driver.getTabIds()).find(r=>!this.getAllTabIds(e).includes(r))}async waitForTabToOpen(e){let t=await this.getUnregisteredTabId(e);return t||(await ue(500),await this.waitForTabToOpen(e))}async tryToAddTab(e){if(this.pendingTabs[e])return;let t=await this.getUnregisteredTabId(e);t&&(await this.addNewTab(e,t),await this.addFrameHandler(t),Object.assign(this.sessionTabs[e],{currentTab:null}))}async addNewPopup(e,t){let r=this.getAllTabInfos(e);if(Object.keys(r).find(o=>r[o].openerStepId===t))return;if(this.pendingTabs[e]){Yo.info(`overriding opener step id from ${this.pendingTabs[e]} to ${t}`),this.pendingTabs[e]=t;return}this.pendingTabs[e]=t;let i=await this.waitForTabToOpen(e);await this.addNewTab(e,i,this.pendingTabs[e]),this.addFrameHandler(i),delete this.pendingTabs[e],Object.assign(this.sessionTabs[e],{currentTab:null})}async waitToPendingTabs(e,t){if(t)return(0,jh.default)(()=>{if(this.pendingTabs[e]===t)throw new Error("awaiting pending tabs")},{retries:5,factor:1,minTimeout:500,maxTimeout:500}).catch(()=>{})}async isMainTabIncognito(){return!1}isInvalidStepVersion(e){let t=$h.lt(e._version||e.version,"1.2.0"),r=!!e.parameterValues,n=r&&e.parameterValues.some(i=>i.type==="locate"&&!i.frameLocators);return t&&(!r||n)}async getTabIdByTabInfo(e,t){var c,l;let{tabMatcher:r,commonConstants:n}=Z();if(this.isInvalidStepVersion(t))throw Object.assign(new Error(""),{success:!1,shouldRetry:!1,errorType:n.stepResult.INVALID_TEST_VERSION});if((c=t.useCurrentTab)!=null&&c.call(t)){let d=await this.driver.getCurrentTabId();if(d)return d;let m=this.getMainTabId(e);if(m)return m;throw new Error("Current tab not found")}let i=(l=t.tabInfo)==null?void 0:l.openerStepId;await this.waitToPendingTabs(e,i),await this.tryToAddTab(e);let o=this.getAllTabIds(e).map(d=>({...this.getTabInfo(e,d),tabId:d})).filter(d=>!d.isClosed),a=r.matchTabs(t,o);if(!a)throw new Error("No tab ID found");if(this.sessionTabs[e].currentTab===a)return a;try{return await this.switchTab(a,e),Object.assign(this.sessionTabs[e],{currentTab:a}),a}catch(d){let m=["no such window","no window found","the window could not be found"];if(d.message&&m.some(u=>d.message.toLowerCase().includes(u)))return this.sessionTabs[e].tabCount--,this.sessionTabs[e].tabInfos[a].isClosed=!0,this.getTabIdByTabInfo(e,t);throw d}}}});var Gu,Qo,Hu=v(()=>{"use strict";Gu=class{select(){return console.log(`
			internal error - cant use port selector in selenium!!!!
`),Promise.reject({reason:"cant use port selector in selenium!"})}prepare(){}handleLegacyDataCaching(){}},Qo=new Gu});var zn,Zo,ea=v(()=>{"use strict";$u();B();we();zn={8:"\uE008",9:"\uE004",13:"\uE007",27:"\uE00C",33:"\uE00E",34:"\uE00F",35:"\uE010",36:"\uE011",45:"\uE016",112:"\uE031",113:"\uE032",114:"\uE033",115:"\uE034",116:"\uE035",117:"\uE036",118:"\uE037",119:"\uE038",120:"\uE039",121:"\uE03A",122:"\uE03B",123:"\uE03C"},Zo=class{constructor(e){this.driver=e;this._abortedSteps=[];this.unescapeHTML=sn;this.getLinksFromUnescapeHTML=nn;this.cookieUtils=new xs(this.driver)}get sessionPlayerInit(){return Z()}resetAbort(){this._abortedSteps.length=0}abort(e){this._abortedSteps.push(e)}get abortedSteps(){return this._abortedSteps}getClickOffset(e,t){let{utils:r,positionUtils:n}=this.sessionPlayerInit,i=n.calculateElementMiddlePoint(t);return e&&r.isWithinBounds(t.left,t.left+t.width,e.x)&&r.isWithinBounds(t.top,t.top+t.height,e.y)?{x:e.x-i.x,y:e.y-i.y}:{x:0,y:0}}async executeInAut(e,t){let{value:r}=await this.driver.executeJS(t);return r}extractTargetText(e){return this.driver.getTargetText(e)}extractText(e){return this.driver.getElementTextJS(e)}async markDynamicParent(e,t){await this.driver.markDynamicParent(e,t)}getCookie(e){return this.cookieUtils.get({name:e})}setCookie(e){return this.cookieUtils.set(e)}async getNextDynamicParent(e,t){let r=this.sessionPlayerInit.codeSnippets.getNextDynamicParent(t),{value:n}=await this.driver.executeJS(`return (function() { ${r} })();`);return n}}});function Gh(s){class e{constructor(r,n){this.frameManager=r;this.LocateElementPlayer=n;this._cache={}}cacheResults(r,n){this._cache[r]=n}getResultsFromCache(r){return this._cache[r]}cacheFrameLocateResults(r){if(r!=null&&r.seleniumFrameElement&&r.frameLocateResultUrl){let n=Vh(r.seleniumFrameElement);n&&this.cacheResults(n,r.frameLocateResultUrl)}}async foundFrameCallback(r,n,i){let{frameOffset:o,locatedElement:a}=r,{locatorBuilderUtils:c}=Z();if(c.isEmptyResult(a)){let u="got empty result in frame result, not rejected from locate element player";throw bE.error(u),new Error(u)}let l=await s.switchToLocatedFrame(a),d=Vh(l.value),m=this.getResultsFromCache(d);return{url:"",frameId:-1,frameOffset:o,tabInfo:n.tabInfo,tabId:n.tabId,testimFrameId:i,testimFullFrameId:`${this.currentFrameHandler.testimFullFrameId}-${i}`,seleniumFrameElement:l.value,frameLocateResultUrl:m}}async locate(r,n,i,o,a,c){let l=new this.LocateElementPlayer(o);r.targetId=`frameLocator_${n}`;let d=await l.locate(r,i,r.targetId);d.isVisible=!0;let m=await l.handleLocateResult(d,c,r).catch(()=>{throw new Error("")}),{locatedElement:u}=o.data[r.targetId],h=(await s.getElementLocationWithPadding(u)).value||{top:0,left:0};m.frameOffset={top:i.frameOffset.top+h.top,left:i.frameOffset.left+h.left},l.addFrameDataToContext&&l.addFrameDataToContext(m.targetId,m.locateResult);let g=await this.foundFrameCallback(m,a,r.testimFrameId);return this.currentFrameHandler=g,g}async findFrame(r,n,i,o){let a=O.flags.enableFrameSwitchOptimization.isEnabled(),l=i.playback.resultsHandler.resultsByChronologicOrder.at(-1),d=1,m=l&&l.stepId===r.id&&l.results.length>d;if(a&&!m&&this.currentFrameHandler){let y=n.findIndex(T=>T.testimFrameId===this.currentFrameHandler.testimFrameId);if(y>-1){let T=n.slice(y+1),w=0;for(let b of T)w++,this.currentFrameHandler=await this.locate(b,w,this.currentFrameHandler,i,o,r);return this.currentFrameHandler}}let u=await o.getTopFrameHandler();u.frameOffset={top:0,left:0},await(a&&this.currentFrameHandler===u?this.currentFrameHandler:s.switchToTopFrame()),this.cacheFrameLocateResults(this.currentFrameHandler),this.currentFrameHandler=u;let h=0,g=u;for(let y of n)h++,g=await this.locate(y,h,g,i,o,r);return g}}return e}var bE,TE,Vh,Hh=v(()=>{"use strict";$();de();we();Hr();bE=C("frame-locator"),TE="ELEMENT",Vh=s=>s?s[TE]||s[qt]:null});var ta,qu=v(()=>{"use strict";ae();ta=()=>{try{if(Rd)return!1;if(require("inspector").url())return!0}catch{}return!1}});var H,me=v(()=>{"use strict";we();H=class{constructor(e,t,r,n={},i=void 0,o=void 0,a={}){this.step=e;this.context=t;this.frameHandler=r;this.exportsGlobal=n;this.stepActionUtils=i;this.locateElementPlayer=o;this.exportsTest=a;this.frameId=0}get driver(){var e;return(e=this.context.project.defaults)!=null&&e.ignoreVisibilityForExisting&&!this.stepActionUtils.driver.getIgnoreVisibility()&&this.stepActionUtils.driver.setIgnoreVisibility(!0),this.stepActionUtils.driver}get sessionPlayerInit(){return Z()}async performAction(){throw new Error("not implemented")}getTarget(){let e=this.step.targetId||"targetId";return this.context.data[e]}async execute(){try{return{success:!0,...await this.performAction()}}catch(e){let t=e==null?void 0:e.message,r=e==null?void 0:e.displayMessage;return{success:!1,reason:t,exception:e,errorType:this.sessionPlayerInit.commonConstants.stepResult.ACTION_EXCEPTION,resultInfo:{exception:`selenium exception: ${t}`,error:r||t}}}}}});function vE(s,e,t,r){return s.opacity===0||s.isShadowed?!1:e===void 0||t===void 0?!0:O.flags.useClickimVisibilityChecks.isEnabled()?!1:r.isSafari()?O.flags.useSafariWebdriverVisibilityChecks.isEnabled():!0}function SE(s){return{getFrameIdByTestimFrameId(){},async setElementResultDataOnContext(e){let t=await s.getElement(e.locatedElement);e.seleniumElement=t.value},getElementRectangle(e){return s.getElementRect(e)},async getOffsets(e){return[e.frameOffset||{}]},htmlStringToDom(e,t){let n=new qh.DOMParser().parseFromString("<html><body></body></html>","text/html");return n.body.outerHTML=e,Object.assign(n,{TESTIM_URL:t,parsedUsingLinkedom:!0})},async isVisible(e,t,r,n,i,o,a){let{locatorBuilderUtils:c,codeSnippets:l,visibilityUtils:d,positionUtils:m}=Z();if(vE(n,d,m,s))return s.isVisible(e.seleniumElement);if(s.getIgnoreVisibility())return{visible:!0,invisibleReason:"visibility is ignored"};if(!e.seleniumElement)return{visible:!1,invisibleReason:"element not found"};try{await s.isVisible(e.seleniumElement)}catch{}if(!t||c.isEmptyResult(t))return{visible:!1,invisibleReason:"element not found"};let h=[m.calculateElementMiddlePoint(r),m.calculateClickPoint(n.clickOffset,r)].filter(Boolean),g=l.getVisibilityCode.getCompoundVisibilityInfoCode(e.locatedElement,h,!1,n),y;try{y=await s.execute(`return ${g}`)}catch(E){throw Ur.error("failed to execute getVisibilityCode",{err:E}),E}let{value:T}=y||{},w=T.elementVisibilityInfo||wE,[b,S]=T.elementsFromPointResults||[null,null];return d.checkElementVisibility(w,n,S,b,a,t,!1)},async scrollToElement(e,t){let{codeSnippets:{scrollToElement:r}}=Z();await s.execute(r(t))}}}var qh,Ur,wE,Kn,zh=v(()=>{"use strict";me();$();de();we();qh=require("linkedom"),Ur=C("locate-step-action"),wE={opacity:1,clientRects:{}};Kn=class extends H{execute(){return this.driver.getHTML(this.step)}static getUtils(e){return SE(e)}static getFrameIdByTestimFrameId(){throw Ur.warn("Unplanned access to getFrameIdByTestimFrameId()"),new Error("Use .getUtils() instead")}static setElementResultDataOnContext(){throw Ur.warn("Unplanned access to setElementResultDataOnContext()"),new Error("Use .getUtils() instead")}static getElementRectangle(){throw Ur.warn("Unplanned access to getElementRectangle()"),new Error("Use .getUtils() instead")}static getOffsets(){throw Ur.warn("Unplanned access to getOffsets()"),new Error("Use .getUtils() instead")}static htmlStringToDom(){throw Ur.warn("Unplanned access to htmlStringToDom()"),new Error("Use .getUtils() instead")}static isVisible(){throw Ur.warn("Unplanned access to isVisible()"),new Error("Use .getUtils() instead")}}});var Kh={};z(Kh,{scroll:()=>EE});var EE,Jh=v(()=>{"use strict";EE=function(s,e,t,r,n,i,o,a){function c(w,b){if(!b)return{success:!1};elementScrollTo(b,w.x,w.y);let S=b.scrollLeft,E=b.scrollTop;return{success:Math.abs(E-w.y)<1&&Math.abs(S-w.x)<1,actualX:S,actualY:E}}function l(w,b){if(!t)return{x:n,y:i};let S=getLocatedElement(b);if(r&&!S)return{x:w.scrollWidth,y:w.scrollHeight};if(!S)throw new Error("could not find target element");let E=S.getBoundingClientRect(),k=0,D=0,G=Math.max(window.innerHeight-(E.height+10),0),x=Math.max(window.innerWidth-(E.width+10),0);return k=a?w.scrollTop+E.top-Math.min(i,G):w.scrollTop,D=o?w.scrollLeft+E.left-Math.min(n,x):w.scrollLeft,{x:Math.round(D),y:Math.round(k)}}let d=!s,m=d?document.scrollingElement||document.documentElement:getLocatedElement(s);if(!m)throw new Error("could not find target to scroll on");let u={top:m.scrollTop,left:m.scrollLeft},f=l(m,e),h=c(f,m);d&&!document.scrollingElement&&!h.success&&u.top===m.scrollTop&&u.left===m.scrollLeft&&(m=document.body,f=l(m,e),h=c(f,m));let g=h.actualX,y=h.actualY,T=getLocatedElement(e);if(t&&r&&!T)return{success:!1,expectedPosition:f};if(t){if(!T)throw new Error("could not find target to scroll to");let w=T.getBoundingClientRect();g=w.left,y=w.top}return{success:h.success,actualX:g,actualY:y}}});var ra,Yh=v(()=>{"use strict";me();ra=class extends H{getFailureString(e,t,r,n,i){if(!e.isScrollToElement)return`Scrolling limit reached. Expected:(y: ${r}, x: ${t}); Actual:(y:${i}, x: ${n})`;let o="Scrolling limit reached";return e.shouldScrollTop&&(o+=`. Expected top margin: ${r}, actual: ${i}`),e.shouldScrollLeft&&(o+=`. Expected left margin: ${t}, actual: ${n}`),o}async scroll(e,t,r){let{codeSnippets:n,commonConstants:{stepResult:i}}=this.sessionPlayerInit,o=Math.round(Number(t.isScrollToElement?t.marginTop:t.y)),a=Math.round(Number(t.isScrollToElement?t.marginLeft:t.x)),c=this.driver.isFirefox()?function(m,u,f){m.scrollTo(u,f)}:function(m,u,f){m.scrollTop=f,m.scrollLeft=u},{scroll:l}=await Promise.resolve().then(()=>(Jh(),Kh)),d=`
            const getLocatedElement = ${n.getLocatedElementCode};
            const elementScrollTo = ${c.toString()};
            const scroll = ${l.toString()};
            return scroll.apply(null, arguments)
        `;try{let m=await this.driver.executeJS(d,r,e??void 0,Boolean(t.isScrollToElement),Boolean(t.isDynamicScroll),a,o,t.shouldScrollLeft,t.shouldScrollTop);if(!(m!=null&&m.value))return{errorType:i.SCROLL_ACTION_FAILURE,success:!1};let{success:u,actualX:f,actualY:h}=m.value;return u?{success:!0}:{errorType:i.SCROLL_ACTION_FAILURE,success:!1,resultInfo:{error:this.getFailureString(t,a,o,f,h)}}}catch{return{errorType:i.SCROLL_ACTION_FAILURE,success:!1}}}scrollOnDocument(e,t){return this.scroll(t,e)}scrollOnElement(e,t){return this.scroll(t,e,this.getTarget().locatedElement)}execute(){let{context:e,step:t}=this,r=t.isScrollToElement?e.data.scrollToElement.locatedElement:null;return t.element.isDocument?this.scrollOnDocument(t,r):this.scrollOnElement(t,r)}}});var Xh,Qh=v(()=>{"use strict";Xh=function(s){let e={};function t(a){return a!=null&&a.toLowerCase?(a=a.toLowerCase(),a==="text"?"text/plain":a==="url"?"text/uri-list":a):a}let r={data:{},setData(a,c){e[t(a)]=c},getData(a){return e[t(a)]}},n=getLocatedElement(s.fromLocatedElement),i=getLocatedElement(s.toLocatedElement);if(!n)throw new Error("from element not found");if(!i)throw new Error("to element not found");let o=function(a,c){let l=document.createEvent("CustomEvent");l.initCustomEvent(c,!0,!0,null),Object.assign(l,{dataTransfer:r}),a.dispatchEvent?a.dispatchEvent(l):a.fireEvent&&a.fireEvent(`on${c}`,l)};o(n,"dragstart"),o(i,"drop"),o(n,"dragend")}});var Zh,ey=v(()=>{"use strict";Zh=function(s,e){let t=typeof MouseEvent=="function",r=typeof DragEvent=="function",n=typeof PointerEvent=="function",i={};window.__unloadNavigator=o,window.addEventListener("unload",window.__unloadNavigator);function o(R){e({status:"done",result:R,success:!0})}function a(R){R||={},e({status:"failed",result:R,success:!1,keep:!0})}function c(R){return R!=null&&R.toLowerCase?(R=R.toLowerCase(),R==="text"?"text/plain":R==="url"?"text/uri-list":R):R}function l(){try{return new DataTransfer}catch{return{data:{},setData(L,M){i[c(L)]=M},getData(L){return i[c(L)]}}}}let d=["drag","dragstart","dragend"],m=["pointerup","pointerdown","pointermove"],u=d.concat(["drop","dragenter","dragover"]);function f(R){let L=R;for(;L&&L!==document.documentElement;){if(L.draggable)return L;L=L.parentElement}return null}function h(R,L,M){let V=L.element,{dispatchDragEventsOnClosestDraggable:W}=M;if(d.includes(R.type)&&W){if(!V&&L.lastDraggedElement)return L.lastDraggedElement;let q=f(V);if(q)return L.lastDraggedElement=q,q}return V}function g(R,L,M){function V(Et,Gr,P){return P>Et&&P<Gr}let W=R.pointerPosition||{};if(L)return{x:W.originX||0,y:W.originY||0};let q=M.getBoundingClientRect(),ie=W.originX&&V(q.left,q.left+q.width,W.originX)?W.originX:q.left+q.width/2,Ee=W.originY&&V(q.top,q.top+q.height,W.originY)?W.originY:q.top+q.height/2;return{x:ie,y:Ee}}function y(R,L,M){let V=(L==null?void 0:L.modifiers)||{},W=g(R,M.isDrag,M.element),q=(L==null?void 0:L.button)||0,ie=R.event;return m.includes(ie)?w(ie,V,W.x,W.y,q):u.includes(ie)?S(ie,V,W.x,W.y):b(ie,V,W.x,W.y,q)}function T(R,L,M){return{screenX:0,screenY:0,clientX:L,clientY:M,ctrlKey:Boolean(R.ctrl),altKey:Boolean(R.alt),shiftKey:Boolean(R.shift),metaKey:Boolean(R.meta),bubbles:!0,cancelable:!0,composed:!0}}function w(R,L,M,V,W){if(n){let ie=T(L,M,V);return ie.pointerType="mouse",ie.isPrimary=!0,new window.PointerEvent(R,ie)}let q=document.createEvent("PointerEvent");return q.initPointerEvent(R,!0,!0,document.defaultView,1,0,0,M,V,Boolean(L.ctrl),Boolean(L.alt),Boolean(L.shift),Boolean(L.meta),W,document.body?document.body.parentNode:document.documentElement,0,0,0,0,0,0,0,0,0,"mouse",0,!0),q}function b(R,L,M,V,W){let q=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return q.initMouseEvent(R,!0,!0,document.defaultView,1,0,0,M,V,Boolean(L.ctrl),Boolean(L.alt),Boolean(L.shift),Boolean(L.meta),W,document.body?document.body.parentNode:document.documentElement),q}function S(R,L,M,V){if(R==="dragstart"&&(window.TSTA||={},window.TSTA.dataTransfer=l()),!r){let ie=document.createEvent("CustomEvent");return ie.initCustomEvent(R,!0,!0,null),Object.assign(ie,{dataTransfer:window.TSTA.dataTransfer}),ie}let W=T(L,M,V),q=new window.DragEvent(R,W);return Object.defineProperties(q,{dataTransfer:{get(){return window.TSTA.dataTransfer}}}),q}function E(R,L,M){let V=h(R,L,M);V==null||V.dispatchEvent(R)}function k(R,L){function M(){return R.event==="click"&&L.isDrag&&!L.allEventsOnSameElement}return M()}function D(R,L,M){if(M){let V=Math.min(M.timeStamp-L.timeStamp,40);setTimeout(()=>{G(R)},V)}else window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),o()}function G(R){let L,M=R.events[R.eventIndex],V=R.events[++R.eventIndex];try{R.element=getLocatedElement(M.locatedElement),L=y(M,s,R)}catch(W){return a(`exception in get event in drag step:${W.message}`)}if(k(M,R))return D(R,M,V);if(L)try{E(L,R,M)}catch(W){return a(`exception in executeEvent in drag step:${W.message}`)}else return a(`cannot execute event ${M.event}`);D(R,M,V)}let x={eventIndex:0,allEventsOnSameElement:s.allEventsOnSameElement,events:s.events,eventType:s.eventType,eventData:s.eventData,stepId:s.id,testResultId:s.testResultId,isDrag:s.isDrag,useRecordedMousedown:s.useRecordedMousedown,trackActiveElement:s.trackActiveElement};setTimeout(()=>{try{G(x)}catch(R){a(R)}},0)}});var ty={};z(ty,{doClick:()=>IE});var IE,ry=v(()=>{"use strict";IE=(s,e)=>{let t=typeof Event=="function";window.__unloadNavigator=o,window.addEventListener("unload",window.__unloadNavigator);function r(b,S){var D;function E(G){function x(){return i(G).find(M=>[...M.classList||[]].includes("Select-control"))}function R(){let M=x();return M?M.querySelector("input"):null}let L=R();L==null||L.focus()}let k=(D=b.quirks)==null?void 0:D.isReactSelect;S.type==="mousedown"&&k&&E(b.element)}function n(b,S){var k;let E=(k=b.quirks)==null?void 0:k.isCKEditorFrame;S.type==="click"&&E&&document.body.focus()}function i(b){let S=[];for(;b!=null&&b.parentNode;)S.push(b),b=b.parentNode;return S}function o(b){let S={status:"done",result:b,success:!0,...w.isNonTextableElemnet&&{reason:"Set text on non input element"}};e(S)}function a(b){b||="",e({status:"failed",result:b,success:!1})}function c(b){let S=t?new Event("mouseover",{composed:!0}):document.createEvent("Events");S.initEvent("mouseover",!0,!0),b.dispatchEvent(S)}function l(b){let S={},E=b.getBoundingClientRect(),k=E.left+E.width/2,D=E.top+E.height/2,R=f("mousemove",S,k,D,0);b.dispatchEvent(R)}function d(b,S){function E(R,L,M){return M>R&&M<L}let k=b.pointerPosition||{},D=S.getBoundingClientRect(),G=k.originX&&E(D.left,D.left+D.width,k.originX)?k.originX:D.left+D.width/2,x=k.originY&&E(D.top,D.top+D.height,k.originY)?k.originY:D.top+D.height/2;return{x:G,y:x}}function m(b,S,E){return{screenX:0,screenY:0,clientX:S,clientY:E,ctrlKey:Boolean(b.ctrl),altKey:Boolean(b.alt),shiftKey:Boolean(b.shift),metaKey:Boolean(b.meta),bubbles:!0,cancelable:!0,composed:!0}}function u(b,S,E,k){if(!window.PointerEvent)return;let D=m(S,E,k);return D.pointerType="mouse",D.isPrimary=!0,new window.PointerEvent(b,D)}function f(b,S,E,k,D){let G=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return G.initMouseEvent(b,!0,!0,document.defaultView,1,0,0,E,k,Boolean(S.ctrl),Boolean(S.alt),Boolean(S.shift),Boolean(S.meta),D,document.body?document.body.parentNode:document.documentElement),G}function h(b,S){let E=["pointerup","pointerdown","pointermove"],k=S.modifiers||{},D=d(b,S.element),G=S.button||0,x=b.event;return E.includes(x)?u(x,k,D.x,D.y):f(x,k,D.x,D.y,G)}function g(){var S;let b=document.activeElement;for(;(S=b.shadowRoot)!=null&&S.activeElement;)b=b.shadowRoot.activeElement;return b}function y(b){b.events.map(S=>{try{return h(S,b)}catch{return}}).filter(Boolean).forEach(S=>{b.element.dispatchEvent(S),r(b,S),n(b,S)}),window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator)}let w={element:s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),events:s.events,quirks:s.quirks,modifiers:s.modifiers,button:s.button};if(!w.element){a("element not found");return}c(w.element),l(w.element);try{y(w);let b=g(),S=w.quirks,E=S==null?void 0:S.isReactSelect,k=S==null?void 0:S.isCKEditorFrame;!E&&!k&&dispatchFocus(s.elementToFocusLocatedElement,b),o()}catch(b){a(b.toString())}}});var sy={};z(sy,{doDragPath:()=>RE});var RE,ny=v(()=>{"use strict";RE=function(s,e){let t=typeof Event=="function",r=typeof PointerEvent=="function",n=40;window.__unloadNavigator=i,window.addEventListener("unload",window.__unloadNavigator);function i(b){e({status:"done",result:b,success:!0})}function o(b){b||="",e({status:"failed",result:b,success:!1})}function a(b){let S=t?new Event("mouseover",{composed:!0}):document.createEvent("Events");S.initEvent("mouseover",!0,!0),b.dispatchEvent(S)}function c(b){let S={},E=b.getBoundingClientRect(),k=E.left+E.width/2,D=E.top+E.height/2,R=u("mousemove",S,k,D,0);b.dispatchEvent(R)}function l(b,S){function E(R,L,M){return M>R&&M<L}let k=b.pointerPosition||{};if(w.isDrag)return{x:k.originX||0,y:k.originY||0};let D=S.getBoundingClientRect(),G=k.originX&&E(D.left,D.left+D.width,k.originX)?k.originX:D.left+D.width/2,x=k.originY&&E(D.top,D.top+D.height,k.originY)?k.originY:D.top+D.height/2;return{x:G,y:x}}function d(b,S,E){return{screenX:0,screenY:0,clientX:S,clientY:E,ctrlKey:Boolean(b.ctrl),altKey:Boolean(b.alt),shiftKey:Boolean(b.shift),metaKey:Boolean(b.meta),bubbles:!0,cancelable:!0,composed:!0}}function m(b,S,E,k,D){if(r){let x=d(S,E,k);return x.pointerType="mouse",x.isPrimary=!0,new window.PointerEvent(b,x)}let G=document.createEvent("PointerEvent");return G.initPointerEvent(b,!0,!0,document.defaultView,1,0,0,E,k,Boolean(S.ctrl),Boolean(S.alt),Boolean(S.shift),Boolean(S.meta),D,document.body?document.body.parentNode:document.documentElement,0,0,0,0,0,0,0,0,0,"mouse",0,!0),G}function u(b,S,E,k,D){let G=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return G.initMouseEvent(b,!0,!0,document.defaultView,1,0,0,E,k,Boolean(S.ctrl),Boolean(S.alt),Boolean(S.shift),Boolean(S.meta),D,document.body?document.body.parentNode:document.documentElement),G}function f(b,S){let E=["pointerup","pointerdown","pointermove"],k=S.modifiers||{},D=l(b,S.element),G=S.button||0,x=b.event;return E.includes(x)?m(x,k,D.x,D.y,G):u(x,k,D.x,D.y,G)}function h(b,S){function E(){return b.event==="click"&&S.isDrag&&!S.allEventsOnSameElement}return E()}function g(b,S,E){try{let k=f(S.events[b],S);h(k,S)||S.element.dispatchEvent(k)}catch{}if(b+1===S.events.length)E();else{let k=Math.min(S.events[b+1].timeStamp-S.events[b].timeStamp,n);setTimeout(()=>{g(b+1,S,E)},k)}}function y(b,S){g(0,b,()=>{window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),S()})}let w={eventIndex:0,element:s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),events:s.events,eventType:s.eventType,eventData:s.eventData,stepId:s.id,testResultId:s.testResultId,quirks:s.quirks,isDoubleClick:s.isDoubleClick,isDrag:s.isDrag,useRecordedMousedown:s.useRecordedMousedown,trackActiveElement:s.trackActiveElement,allEventsOnSameElement:s.allEventsOnSameElement};if(!w.element){o("element not found");return}a(w.element),c(w.element),y(w,()=>{i()})}});var Jn,sa,iy=v(()=>{"use strict";Jn=I(require("lodash"));me();Qh();de();ey();sa=class extends H{getDnDRectsAndOffsets(e,t,r,n){let i=this.stepActionUtils.getClickOffset(r,e.rectWithoutFrameOffset),o=this.stepActionUtils.getClickOffset(n,t.rectWithoutFrameOffset);return{fromRect:e.rectWithoutFrameOffset,fromX:i.x,fromY:i.y,toRect:t.rectWithoutFrameOffset,toX:o.x,toY:o.y}}async clickJs(){var d;let{step:e,context:t}=this,r=this.getTarget(),n=t.data.timeToPlayStep+3e3,i=e.events;if(!(i!=null&&i.length))return{success:!1,reason:"Malformed step: missing recorded events"};let o={isRoot:r.isRoot,locatedElement:r.locatedElement,events:i,quirks:e.quirks,modifiers:e.modifiers,button:e.button},[{doClick:a},{dispatchFocus:c}]=await Promise.all([Promise.resolve().then(()=>(ry(),ty)),Promise.resolve().then(()=>(Mn(),Nn))]),l=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${c.toString()};
            var doClick = ${a.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return doClick.call(null, eventData, done);
        `;try{return(d=(await this.driver.executeCodeAsync(l,n,o)).value)!=null&&d.success?{success:!0}:{success:!1}}catch(m){return{success:!1,reason:m.message,exception:m}}}isWithinBounds(e,t,r){return r>e&&r<t}getEventSequenceOffset(){var c;let e=(c=this.step.events[0])==null?void 0:c.pointerPosition;if(!e)return{xOffset:0,yOffset:0};let r=this.getTarget().rectWithoutFrameOffset,n=this.isWithinBounds(r.left,r.left+r.width,e.originX),i=this.isWithinBounds(r.top,r.top+r.height,e.originY),o=n?0:r.left+r.width/2-e.originX,a=i?0:r.top+r.height/2-e.originY;return{xOffset:o,yOffset:a}}addOffsetToEvents(e){this.step.events.forEach(t=>{t!=null&&t.pointerPosition&&(t.pointerPosition.originX+=e.xOffset,t.pointerPosition.originY+=e.yOffset)})}generateEventOfType(e,t){let r=Jn.cloneDeep(e);return r.event=t,r}fixAbsoluteDragEventSequence(){let{events:e=[],allEventsOnSameElement:t,isHTML5Drag:r,toElement:n}=this.step,i=e.find(l=>["mousedown","pointerdown"].includes(l.event));if(i){let l=e.indexOf(i);e.splice(l,0,this.generateEventOfType(i,"mouseover"))}let{recordPointerMoveEvents:o=!1}=this.context.project.defaults||{},a=e.find(l=>l.event==="mouseup")||o&&e.find(l=>l.event==="pointerup"),c=Number(Jn.findLastIndex(e,l=>l.event==="mousemove")||o&&Jn.findLastIndex(e,l=>l.event==="pointermove"));a&&c>0&&!t&&e.splice(c+1,0,this.generateEventOfType(a,"mouseover")),r&&!n&&(this.step.events=this.addDragendIfNeeded(e)),this.addOffsetToEvents(this.getEventSequenceOffset())}async dragPathJs(){var d,m;let{step:e,context:t}=this,r=this.getTarget(),n=t.data.timeToPlayStep+3e3;if(!((d=e.events)!=null&&d.length))return{success:!1,reason:"Malformed step: missing recorded events"};this.fixAbsoluteDragEventSequence();let i=e.events,o={isRoot:r.isRoot,locatedElement:r.locatedElement,events:i,quirks:e.quirks,modifiers:e.modifiers,button:e.button,isDrag:!0,allEventsOnSameElement:e.allEventsOnSameElement},[{doDragPath:a},{dispatchFocus:c}]=await Promise.all([Promise.resolve().then(()=>(ny(),sy)),Promise.resolve().then(()=>(Mn(),Nn))]),l=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${c.toString()};
            var doDragPath = ${a.toString()};
            return doDragPath.apply(null, arguments);
        `;try{return(m=(await this.driver.executeCodeAsync(l,n,o)).value)!=null&&m.success?{success:!0}:{success:!1}}catch(u){return{success:!1,reason:u.message,exception:u}}}async chooseAndRunAction(){let e=this.getTarget(),{locatedElement:t,seleniumElement:r,rectWithoutFrameOffset:n,rect:i}=e,o={frameOffset:{x:i.left-n.left,y:i.top-n.top},rect:n,clickOffset:this.stepActionUtils.getClickOffset(this.step.element.clickOffset,n)};if(O.flags.skipFileInputClicks.isEnabled()&&e.tagName==="INPUT"&&(e.elementSymbol.includes('type="file"')||e.elementSymbol.includes("type='file'")||e.elementSymbol.includes("type=file")))return{keep:!0,success:"skipped",reason:"Clicking on input type=file is disabled"};if(this.step.isDoubleClick){let d={elementToFocusLocatedElement:e.elementToFocusLocatedElement,locatedElement:t,events:this.step.events,timeout:this.context.data.timeToPlayStep+3e3};return this.driver.doubleClick(r,d,o)}if(this.step.isDrag){if(this.step.toElement){let d=this.context.data.toElement;if(this.step.isHTML5Drag){if(O.flags.usePortedHtml5DragDrop.isEnabled()){let h=this.generateHTML5DragEventSequence(),g=this.context.data.timeToPlayStep+3e3,y=this.getTarget(),T={transactionId:`${this.context.testResultId}:${this.step.id}`,id:this.step.id,testResultId:this.context.testResultId,eventType:this.step.type,events:h,eventData:{modifiers:this.step.modifiers,button:this.step.button},quirks:this.step.quirks,isDrag:this.step.isDrag,useRecordedMousedown:this.step.useRecordedMousedown,allEventsOnSameElement:this.step.allEventsOnSameElement,elementToFocusLocatedElement:y.elementToFocusLocatedElement,trackActiveElement:this.step.trackActiveElement,locatedElement:y.locatedElement,isRoot:y.isRoot},w=`
                        var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                        var dnd = ${Zh.toString()};
                        var eventData = arguments[0];
                        var done = arguments[1];
                        return dnd.call(null, eventData, done);
                    `;return this.driver.executeCodeAsync(w,g,T)}let u=`
                        var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                        var dnd = ${Xh.toString()};
                        var eventData = arguments[0];
                        return dnd.call(null, eventData);
                    `,f={fromLocatedElement:t,toLocatedElement:d.locatedElement};return this.driver.executeJS(u,f)}let m=this.getDnDRectsAndOffsets(e,d,this.step.element.clickOffset,this.step.toElement.clickOffset);return this.driver.dragAndDrop(r,d.seleniumElement,m)}return this.dragPathJs()}let c=this.driver.isSafari()&&this.step.button===2,l=this.driver.isSafari()&&e.tagName==="SELECT";return l?{keep:!0,success:"skipped",forceTreatAsWarning:!0,reason:"Safari does not support clicking on select elements"}:!l&&(!this.step.nativeEvents||c)?this.clickJs():this.step.button===2?this.driver.rightClick(r,o):this.driver.leftClick(r,o)}async performAction(){let e=await this.chooseAndRunAction();if(!e.status&&e.value&&e.value.keep&&(e=e.value),e.keep)return delete e.keep,e}addDragendIfNeeded(e){if(e.some(r=>r.event==="dragend"))return e;let t={event:"dragend",eventInfo:{detail:0},pointerPosition:this.getToElementPosition()};return e.concat(t)}getToElementPosition(){var t,r;if(!((r=(t=this.context.data)==null?void 0:t.toElement)!=null&&r.rect))return;let{rect:e}=this.context.data.toElement;return{originX:e.left+e.width/2,originY:e.top+e.height/2}}addDragOverBeforeDragEnd(e){let t=e.findIndex(n=>["dragend","drop"].includes(n.event)),r=e[t-1];if(!r||r.event!=="dragover"){let n={event:"dragover",eventInfo:{detail:0},pointerPosition:this.getToElementPosition(),fireOnTarget:!0};e.splice(t,0,n)}else Object.assign(r,{fireOnTarget:!0});return e}fixEventSequence(e){let t=this.addDragendIfNeeded(e);return this.addDragOverBeforeDragEnd(t)}addElementLocatedElementToDragEvents(e,t,r){let n=i=>i.fireOnTarget||["drop","dragenter"].includes(i.event);return e.forEach(i=>Object.assign(i,{locatedElement:n(i)?r:t})),e}generateHTML5DragEventSequence(){let e=this.context.data.targetId,t=this.context.data.toElement,r=this.step.events.filter(n=>n.event!=="mousemove"&&n.event!=="pointermove");return r=this.fixEventSequence(r),r=this.addElementLocatedElementToDragEvents(r,e.locatedElement,t.locatedElement),this.step.dispatchDragEventsOnClosestDraggable&&r.forEach(n=>Object.assign(n,{dispatchDragEventsOnClosestDraggable:!0})),r}}});var Yn,oy=v(()=>{"use strict";me();Yn=class extends H{async performAction(){let{step:e,context:t,sessionPlayerInit:{stepParamExpressionEvaluator:r,utils:n,commonConstants:i}}=this,o=this.getTarget();try{let a=await this.stepActionUtils.extractTargetText(o),{evaluatedText:c}=r.computeExpression(e.expression2,t,this.exportsGlobal,this.exportsTest);try{return n.compareOrMatch(c,a)?{success:!0}:{success:!1,errorType:i.stepResult.TEXT_COMPARE_FAILURE,resultInfo:{expected:String(c),actual:a}}}catch{return{success:!1,errorType:i.stepResult.TEXT_COMPARE_FAILURE,resultInfo:{expected:c.toString(),actual:a}}}}catch(a){return{success:!1,reason:a.message,exception:a,shouldRetry:!0}}}}});var ay,xE,na,cy=v(()=>{"use strict";ay=I(require("lodash"));me();$();xE=C("evaluate-expression-step-action"),na=class extends H{async execute(){let{step:e,context:t,exportsGlobal:r,exportsTest:n}=this;try{xE.info("runner running incoming params evaluation");let i=t.incomingParams||{};ay.isEmpty(i)&&(i=this.sessionPlayerInit.StepParamsBuilder.getStepInputs(e,t,r,n));let o=["context",...i.as.functionParameters],a=[t,...i.as.functionArguments],l=`return ${e.subType==="text"?`'${e.expression.replace(/'/g,"\\'")}'`:e.expression}`.replace(/\n/g,"\\n"),m=Function.apply(Function,o.concat([l]))(...a);return t.data[e.targetName]=m,t.data[e.targetId]=m,t.internalParams&&t.internalParams.add(e.targetId),{success:!0,evaluatedText:m,data:t.data}}catch(i){let{stepResult:o}=this.sessionPlayerInit.commonConstants;throw{errorType:o.EVALUATE_EXPRESSION_EXCEPTION,resultInfo:{exception:i.toString()},success:!1}}}}});var ly={};z(ly,{setText:()=>AE});var AE,uy=v(()=>{"use strict";AE=function(s,e){let t=typeof Event=="function",r=s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),n={eventIndex:0,element:r,events:s.events,eventType:s.eventType,quirks:s.quirks};if(!r)throw new Error("element not found");window.__unloadNavigator=function(){Ee()},window.addEventListener("unload",window.__unloadNavigator);let i=new Set(["keydown","keyup","keypress"]),o=15;function a(P){try{if(!t)return;let N=new CustomEvent("textInput",{bubbles:!0,cancelable:!0});return P.eventData&&(N.data=P.eventData.data),N}catch{}}function c(P){try{let N=document.createEvent("TextEvent");N.data=P.eventData.data;let j=1,J=P.eventData.locale||"en-US";return N.initTextEvent("textInput",!0,!0,window,P.eventData.data,j,J),N}catch{}}function l(P){return a(P)||c(P)}function d(P,N,j){try{return new KeyboardEvent(P,{bubbles:!0,cancelable:!0,location:N.location||0,key:N.key||"",ctrlKey:Boolean(j.ctrl),shiftKey:Boolean(j.shift),altKey:Boolean(j.alt),metaKey:Boolean(j.meta)})}catch{}}function m(P,N,j){try{let J=document.createEvent("KeyboardEvent");return J.initKeyEvent(P,!0,!0,null,Boolean(j.ctrl),Boolean(j.alt),Boolean(j.shift),Boolean(j.meta),N.key||"",0),J}catch{}}function u(P,N,j){try{let J=document.createEvent("Events");return J.initEvent(P,!0,!0),Object.assign(J,{altKey:Boolean(j.alt),ctrlKey:Boolean(j.ctrl),metaKey:Boolean(j.meta),shiftKey:Boolean(j.shift),keyCode:N.key||""}),J}catch{}}function f(P,N,j){return d(P,N,j)||m(P,N,j)||u(P,N,j)}function h(P){if(!i.has(P.event))return null;let N=P.eventData,j=N.modifiers||{},J=f(P.event,N,j);return Object.defineProperties(J,{keyCode:{enumerable:!0,get(){return this._keyCode_}},charCode:{enumerable:!0,get(){return this._charCode_}},which:{enumerable:!0,get(){return this._keyCode_}}}),Object.assign(J,{_keyCode_:N.keyCode,_charCode_:N.charCode||0}),J}function g(P){return P.event==="textInput"?l(P):h(P)}function y(P,N){return(()=>{var J;return P.event==="textInput"&&!((J=N.quirks)!=null&&J.isAuth0Form)})()}function T(P,N){return P.event==="keyup"&&N.event==="keydown"?o:0}function w(P,N){let j=T(P,N);return Math.min(N.timeStamp-P.timeStamp,j)}function b(P){let N=Object.getOwnPropertyDescriptor(P,"value");if(!N)return;let j=P.value;P.value=`${j}#`,N.configurable&&delete P.value,P.value=j;let J=document.createEvent("HTMLEvents");J.initEvent("input",!0,!1),P.dispatchEvent(J),Object.defineProperty(P,"value",N)}function S(P){if(V(P.element))try{if(b(P.element),t)P.element.dispatchEvent(new Event("change"));else{let N=document.createEvent("HTMLEvents");N.initEvent("change",!1,!0),P.element.dispatchEvent(N)}}catch{}}function E(P,N,j){j?setTimeout(()=>{M(P)},w(N,j)):(window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),S(P),Ee())}function k(P,N){return(P==="change"||P==="blur")&&N.element.tagName==="OPTION"}function D(P,N,j){return k(P.type,N)?N.element.parentElement:j.locatedElement?getLocatedElement(j.locatedElement):N.element}function G(P,N){let j=P.firstChild,J;for(;j;){if(j.nodeType===3){if(N.offset--<=0)return j}else if(j.nodeType===1&&(J=G(j,N),J))return J;j=j.nextSibling}return null}function x(P,N){if(!(!P||!N)){if(!isNaN(N.start))Object.assign(P,{selectionStart:N.start,selectionEnd:N.end});else if(!isNaN(N.nodeOffset)){let j;if(P.firstChild?j=G(P,{offset:N.nodeOffset}):j=P,j){let J=window.getSelection(),Oe=document.createRange();try{J.removeAllRanges(),Oe.setStart(j,N.textOffset),Oe.setEnd(j,N.textOffset),J.addRange(Oe)}catch{}}}}}function R(P,N){return P==="submit"&&Boolean(N.action)}function L(P,N,j){if(N.isFocusable&&N.isSelectable(P)&&P.type!=="submit")try{x(N.element,j.eventData.selection)}catch{}let J=D(P,N,j);if(!J)throw new Error("could not find element");R(P.type,J)?J.submit():J.dispatchEvent(P)}function M(P){let N,j=P.events[P.eventIndex],J=P.events[++P.eventIndex];try{N=g(j)}catch(Oe){return Et(`exception in get event in text step:${Oe.message}`)}if(y(j,P))return E(P,j,J);if(N)try{L(N,P,j)}catch(Oe){return Et(`exception in executeEvent in text step:${Oe.message}`)}else if(P.noEventExecuter)P.noEventExecuter(P,j);else return Et(`cannot execute event ${j.event}`);E(P,j,J)}function V(P){let N=P.tagName;return N==="INPUT"||N==="TEXTAREA"}function W(P){return P.getAttribute?Boolean(P.getAttribute("contenteditable")==="true"):!1}function q(P,N){if(V(P.element)){P.element.value=N.eventData.text;let j=document.createEvent("Event");j.initEvent("input",!0,!1),P.element.dispatchEvent(j)}else P.isContentEditable&&(P.element.innerHTML=N.eventData.text)}function ie(){var N;let P=document.activeElement;for(;(N=P.shadowRoot)!=null&&N.activeElement;)P=P.shadowRoot.activeElement;return P}function Ee(P){let N={status:"done",result:P,success:!0,...n.isNonTextableElemnet&&{reason:"Set text on non input element"}};e(N)}function Et(P){P||="";let N={status:"failed",result:P,success:!1,...n.isNonTextableElemnet&&{reason:"Set text on non input element"}};e(N)}try{let P=V(n.element);n.isContentEditable=W(n.element),!P&&!n.isContentEditable&&(n.isNonTextableElemnet=!0),n.isFocusable=P||n.isContentEditable,n.isSelectable=N=>N.type!=="keyup",n.noEventExecuter=q}catch(P){Et(`exception in set text step:${P.message}`);return}let Gr=ie();dispatchFocus(s.elementToFocusLocatedElement,Gr),M(n)}});var ia,py=v(()=>{"use strict";me();B();ia=class extends H{async setValueNative(){let e=this.context,t=this.getTarget();return this.step.delayBetweenChars?(await this.driver.elementIdClear(De(t.seleniumElement)),await this.setTextDelayed()):this.driver.setValue(t.seleniumElement,e.stepText)}async setValueJS(){var h;let{step:{events:e,type:t,quirks:r},context:n,sessionPlayerInit:i}=this,o=this.getTarget(),a=n.data.timeToPlayStep+3e3,{setTextDraftJs:c}=i.codeSnippets;if(o.isDraftEditor&&c)return this.driver.executeJS(c(o.locatedElement,n.stepText));if(!(e!=null&&e.length))return;let l={eventType:t,events:e,quirks:r,locatedElement:o.locatedElement,isRoot:o.isRoot,elementToFocusLocatedElement:o.elementToFocusLocatedElement},[{setText:d},{dispatchFocus:m}]=await Promise.all([Promise.resolve().then(()=>(uy(),ly)),Promise.resolve().then(()=>(Mn(),Nn))]),u=`
            var getLocatedElement = ${i.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${m};
            var setText = ${d.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return setText.call(null, eventData, done);
        `,f=await this.driver.executeCodeAsync(u,a,l);return{success:Boolean((h=f.value)==null?void 0:h.success)}}async setTextDelayed(){let e=this.context.stepText,t=this.getTarget();for(let r=0;r<e.length;r++)await this.driver.elementIdValue(De(t.seleniumElement),e[r]),r<e.length-1&&await ue(this.step.delayBetweenChars||0)}async setValueAppendNative(){let e=[],t=this.context,r=this.getTarget();if(r!=null&&r.seleniumElement)return this.step.delayBetweenChars?this.setTextDelayed():(e.push(Array.from(t.stepText)),this.driver.elementIdValue(De(r.seleniumElement),e));throw new Error("missing selenium element")}async performAction(){let e=this.getTarget(),t=this.driver.isSafari()&&e.locatedElement&&e.locatedElement.shadowPath&&Array.isArray(e.locatedElement.shadowPath)&&e.locatedElement.shadowPath.length>1;return this.step.nativeEvents&&!t?this.setValueNative():this.setValueJS()}}});var dy={};z(dy,{runCode:()=>CE});var CE,my=v(()=>{"use strict";CE=function(s,e){var d;function t(m,u){let f=`data-testim-${m}`,h="Native sessionStorage is not available";function g(y){return y!=null&&y.toString?y.toString().includes("[native code]"):!1}try{if(![window.sessionStorage.setItem,window.sessionStorage.getItem].every(g))throw new Error(h);let T={...JSON.parse(window.sessionStorage.getItem(f)||"{}"),...u};window.sessionStorage.setItem(f,JSON.stringify(T))}catch(y){let T=y.message.toLowerCase().includes("quota"),w=y.message===h;if(y.message.includes("sessionStorage")||y.message.includes("The operation is insecure")||T||w){let b=document.head.querySelector("#testim-storage-backup");b||(b=document.createElement("meta"),b.id="testim-storage-backup",document.head.append(b));let E={...JSON.parse(b.getAttribute(f)||"{}"),...u};if(b.setAttribute(f,JSON.stringify(E)),T||w)try{window.sessionStorage.removeItem(f)}catch{}return}throw y}}function r(m){return m.function?m.function.args.map(u=>u!=null&&u.locatedElement?getLocatedElement(u.locatedElement):u):m.directParams.map(u=>u.selector?document.querySelector(u.selector):u.value).concat(m.otherParams)}function n(m,u){function f(){return m.apply(null,u)}return f.prototype=m.prototype,new f}let i={},o={},a={},c=s.functionParams,l=s.transactionId;try{let m=r(s);m.push(i,o,a);let u=((d=s.function)==null?void 0:d.params)||c,h=(e||n(Function,u)).apply(null,m);typeof Promise<"u"&&h instanceof Promise?(t(l,{type:"promise"}),h.then(g=>{t(l,{status:"done",success:!0,result:{resultValue:g,exports:i,exportsTest:o,exportsGlobal:a}})},g=>{t(l,{status:"failed",success:!1,result:{resultValue:g.toString(),exports:i,exportsTest:o,exportsGlobal:a}})})):t(l,{status:"done",success:!0,result:{resultValue:h,exports:i,exportsTest:o,exportsGlobal:a}})}catch(m){t(l,{status:"failed",success:!1,result:{resultValue:m.toString(),exports:i,exportsTest:o,exportsGlobal:a}})}}});var oa,Xn,or,aa=v(()=>{"use strict";oa=I(require("lodash"));B();me();$();de();Xn=C("base-js-step-action"),or=class extends H{isExceedingMaxResultSize(t,r){var n;try{let i=(n=r.project.defaults)==null?void 0:n.enforceMaximumJsResultSize,o=O.flags.maximumJsResultSize.getValue(),a=JSON.stringify(t).length>o;return i?a:(a&&Xn.warn(`js result size exceeded ${o}, stepId: ${this.step.id}`),!1)}catch{return!1}}executeGetStatus(t){return this.driver.executeJS(r=>{let n=`data-testim-${r}`;try{return window.sessionStorage.getItem(n)}catch(i){if(i.message.includes("sessionStorage")||i.message.includes("The operation is insecure")){let o=document.head.querySelector("#testim-storage-backup");return o?o.getAttribute(n):"{}"}throw i}},t)}constructJSFunParams(t){let r=t.incomingParams,n=["context",...r.as.functionParameters,"exports","exportsTest","exportsGlobal"],i=[t.context,...r.as.functionArguments];return n.push(t.code),i.forEach(o=>{oa.isObject(o)&&Li(o,"seleniumElement",oa.isEqual)}),{function:{params:n,args:i},transactionId:t.transactionId,browser:t.browser,browserMajor:t.browserMajor}}checkStatus(t){let{context:r,stepActionUtils:n,step:{id:i=""}}=this,o=r.config.retryTimeout,a=r.data.timeToPlayStep-o,c=async()=>{let l;try{l=await this.executeGetStatus(t)}catch(u){Xn.warn("failed to get js status",{err:u}),l={value:'{ "status": "exception" }'}}let d;try{d=JSON.parse((l==null?void 0:l.value)||"{}")}catch{Xn.warn("non object value",{selRes:l}),d={status:"exception"}}let m=n.abortedSteps.find(u=>u.id===i);return m||(d?d.status==="done"?d:d.status==="failed"?{success:!1,shouldRetry:!0,result:d.result}:a-o<=0?Object.assign(d,{success:!1,shouldRetry:!0}):(a-=o,await ue(o),c()):{success:!0})};return c()}async executeInAut(t){let r=O.flags.experimentalPreCodeCompilation.isEnabled(),n=O.flags.experimentalAsyncCustomCode.isEnabled(),i=this.constructJSFunParams(t),o=i.function.args.some(m=>Boolean(m==null?void 0:m.locatedElement)),a="undefined";if(r){let m=i.function.params.slice(0,-1);a=n?`async function(${m.join(",")}) {
                ${t.code}
            };`:`function(${m.join(",")}) {
                ${t.code}
            };`,i.function.params.pop()}let{codeSnippets:c}=this.sessionPlayerInit,{runCode:l}=await Promise.resolve().then(()=>(my(),dy)),d=`
            ${o?`var getLocatedElement = ${c.getLocatedElementCode};`:";"}
            var runCode = ${l.toString()};
            var eventData = arguments[0];
            var funcToRun = ${a};
            return runCode.call(null, eventData, funcToRun);
        `;if(!r)return this.driver.executeJS(d,i);try{return await this.driver.executeJS(d,i)}catch(m){return this.handleExecutionError(m)}}codeExecDone(t){let{stepResult:r}=this.sessionPlayerInit.commonConstants,{context:n}=this,{result:i={},tstConsoleLogs:o,nodeVersion:a,navigateToDifferentDomain:c}=t;i.exports&&(n.data.exports=i.exports);let l={nodeVersion:a,tstConsoleLogs:o,data:n.data};return this.isFailedResult(i.resultValue)?{...l,success:!1,errorType:r.JS_ASSERTION_FAILED}:this.isExceedingMaxResultSize({result:i,tstConsoleLogs:o},n)?{...l,success:!1,errorType:r.JS_RESULT_MAX_SIZE_EXCEEDED}:{...l,success:!0,exportsTest:i.exportsTest,exportsGlobal:i.exportsGlobal,...c&&{navigateToDifferentDomain:c}}}codeExecFailed(t){let{stepResult:r}=this.sessionPlayerInit.commonConstants,{context:n}=this;if(t.type==="promise")return{data:n.data,success:!1,shouldRetry:!0,isPendingPromise:!0,errorType:r.JS_ASSERTION_FAILED};if(t.reason==="stopped")return{...t,errorType:r.STOPPED};let{result:i={},tstConsoleLogs:o}=t;return{tstConsoleLogs:o,data:n.data,exportsGlobal:i.exportsGlobal,exportsTest:i.exportsTest,success:!1,errorType:r.UNWRAPPED_AUT_REJECT,resultInfo:{error:i.resultValue}}}checkCodeResponse(t){return t!=null&&t.success?this.codeExecDone(t):this.codeExecFailed(t)}getTransactionId(t,r){var i;let n=t.id;return t.id||(Xn.warn("step.id doesn't exist on step",{step:t,context:r}),n=r.stepResultId),"stepResultId"in r&&((i=r.stepResultId)!=null&&i.length)?n=r.stepResultId:Xn.warn("stepResultId is not present in context",{step:t,context:r}),`${r.testResultId}:${n}`}async performAction(){let{step:t,context:r}=this;this.startTimestamp=Date.now();let n=await this.driver.getBrowserAndOS(),i={transactionId:this.getTransactionId(t,r),id:t.id,eventType:t.type,code:t.code,incomingParams:r.incomingParams,exportsGlobal:this.exportsGlobal,exportsTest:this.exportsTest,context:{config:r.config,data:r.data},testResultId:r.testResultId,browser:n.browser,browserMajor:n.browserMajor};r.isPendingPromise||await this.executeInAut(i);let o=await this.checkStatus(i.transactionId);return this.checkCodeResponse(o)}handleExecutionError(t){throw(t==null?void 0:t.name)==="javascript error"?new Error(t.message):t}}});var Gt,fy=v(()=>{"use strict";aa();Gt=class extends or{isFailedResult(e){return e===!1}}});var As,gy=v(()=>{"use strict";aa();As=class extends or{isFailedResult(e){return!e}}});var ca,hy=v(()=>{"use strict";me();B();ea();ca=class extends H{setWithValueApi(e){let t=this.getTarget();return t!=null&&t.seleniumElement?this.driver.elementIdValue(De(t.seleniumElement),e):Promise.reject(new Error("missing selenium element"))}performAction(){let e=[],t=this.step.events[0].eventData.keyCode;return t>=32&&t<=127?e.push(String.fromCharCode(t)):e.push(zn[t]),this.setWithValueApi(e)}}});var la,yy=v(()=>{"use strict";me();ea();la=class extends H{async performAction(){var i,o;let e=this.context.config.os.startsWith("Mac");if(e&&!((i=this.step.keys)!=null&&i.mac)||!e&&!((o=this.step.keys)!=null&&o.windows))return;let t=[],r=e?this.step.keys.mac:this.step.keys.windows;r.altKey&&t.push("\uE052"),r.ctrlKey&&t.push("\uE051"),r.metaKey&&t.push("\uE03D"),r.shiftKey&&t.push("\uE050");let n=r.keyCode;if(n>=32&&n<=127)t.push(r.key);else if(zn[n])t.push(zn[n]);else throw new Error(`Invalid key with keyCode ${n}.`);return await this.driver.sendKeyboardShortcut(t)}}});var by={};z(by,{selectOption:()=>PE});function PE(s,e){function t(r,n){let i=Element.prototype.matches,o=i&&isNativeFunction(i)?i:document.createElement(r.tagName).__proto__.matches;do{if(o.call(r,n))return r;r=r.parentElement||r.parentNode}while(r!==null&&r.nodeType===1);return null}try{let r=getLocatedElement(s);if(!r)return{success:!1,status:"failed",result:"option element not found"};let n=t(r,"select");return n?(n.focus(),r.selected?{success:!0,status:"done"}:(r.selected=!0,["input","change"].map(o=>{let a=document.createEvent("HTMLEvents");return a.initEvent(o,!0,!1),a}).forEach(o=>{if(e){n.dispatchEvent(o);return}r.dispatchEvent(o)}),{success:!0,status:"done"})):{success:!1,status:"failed",result:"select element not found"}}catch(r){return{success:!1,status:"failed",result:r.toString()}}}var Ty=v(()=>{"use strict"});var ua,wy=v(()=>{"use strict";me();B();de();ua=class extends H{async performAction(){var u,f;let e=this.getTarget(),{seleniumElement:t,locatedElement:r}=e,i=(await this.driver.getBrowserAndOS()).browserMajor,o=this.driver.isSafari(),a=Boolean((u=this.step.element)==null?void 0:u.isShadowed);if(!o||o&&i>=13&&!a)try{return await this.driver.elementIdClick(De(t))}catch(h){if(!h.message.includes("Cannot check the displayedness of a non-Element argument"))throw h}let{selectOption:c}=await Promise.resolve().then(()=>(Ty(),by)),l=O.flags.safariSelectOptionDispatchEventOnSelectElement.isEnabled(),d=`
            const getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            const isNativeFunction = ${this.sessionPlayerInit.utils.isNativeFunction.toString()};
            const selectOption = ${c.toString()};
            return selectOption.apply(null, arguments);
        `;return(f=(await this.driver.executeJS(d,r,l)).value)!=null&&f.success?{success:!0}:{success:!1}}}});var pa,vy=v(()=>{"use strict";me();pa=class extends H{async performAction(){await this.driver.submit(this.getTarget().seleniumElement)}}});var kE,da,Sy=v(()=>{"use strict";me();kE=(s,e,t,r)=>({x:t,y:r,width:e,height:s,get top(){return this.y},get left(){return this.x},get right(){return this.x+this.width},get bottom(){return this.y+this.height},toJSON(){}}),da=class extends H{getRect(){return this.driver.isFirefox()?this.getTarget().rectWithoutFrameOffset:this.getTarget().rect}async performAction(){let e=this.getTarget(),{seleniumElement:t,rectWithoutFrameOffset:r,rect:n}=e,{width:i,height:o}=n,a=i/2,c=o/2,l=this.step.element.clickOffset;if(l&&this.step.shouldAccountForMouseOffsetInHover){let{x:m,y:u}=l;this.sessionPlayerInit.utils.isWithinTargetRect(kE(o,i,0,0),m,u)&&(a=m,c=u)}let d={frameOffset:{x:n.left-r.left,y:n.top-r.top},rect:r,clickOffset:{x:Math.floor(a),y:Math.floor(c)}};return await this.driver.hover(t,d),{success:!0}}}});var Ey={};z(Ey,{wheel:()=>OE});var OE,Iy=v(()=>{"use strict";OE=function(s,e){function r(a,c){function l(h,g,y){return y>h&&y<g}let d=a.pointerPosition||{},m=c.getBoundingClientRect(),u=d.originX&&l(m.left,m.left+m.width,d.originX)?d.originX:m.left+m.width/2,f=d.originY&&l(m.top,m.top+m.height,d.originY)?d.originY:m.top+m.height/2;return{x:u,y:f}}function n(a,c,l){let d=r(a,l),m=(c==null?void 0:c.modifiers)||{},u={deltaX:a.deltaX,deltaY:a.deltaY,deltaZ:a.deltaZ,deltaMode:a.deltaMode,clientX:d.x,clientY:d.y,bubbles:!0,cancelable:!0,ctrl:Boolean(m.ctrl),alt:Boolean(m.alt),shift:Boolean(m.shift),meta:Boolean(m.meta)};return new WheelEvent("wheel",u)}function i(a,c){if(a.length===0){e({state:"success"});return}if(!c)throw new Error("element not found");let l=a.shift(),d=n(l,s.eventData,c),m=a[0]?Math.min(a[0].timeStamp-l.timeStamp,200):200;c.dispatchEvent(d),setTimeout(()=>{i(a,c)},m)}let o=getLocatedElement(s.locatedElement);i(s.events,o)}});var ma,Ry=v(()=>{"use strict";me();ma=class extends H{async performAction(){var m;let{step:e,context:t}=this,{events:r,modifiers:n,button:i}=e;if(!(r!=null&&r.length))return;let o={events:r,eventData:{modifiers:n,button:i},locatedElement:this.getTarget().locatedElement},a=t.data.timeToPlayStep+3e3,{wheel:c}=await Promise.resolve().then(()=>(Iy(),Ey)),l=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var wheel = ${c.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return wheel.call(null, eventData, done);
        `;return{success:((m=(await this.driver.executeCodeAsync(l,a,o)).value)==null?void 0:m.state)==="success"}}}});var xy={};z(xy,{downloadFileAndFireDropEvent:()=>_E});var _E,Ay=v(()=>{"use strict";_E=function(s,e){let t=getLocatedElement(s);if(!t)throw new Error("element not found");function r(){let o=-1,a=0,c=[],l={endWithCallback:void 0,waitOn(){let d=++o;return function(m){d in c||(c[d]=m,a++,e.length===a&&l.endWithCallback(c))}},endWith(d){l.endWithCallback=d}};return l}function n(o,a,c){let l=new XMLHttpRequest;l.open("GET",o),l.responseType="blob",l.onload=function(){if(this.status>=200&&this.status<300)c({blob:l.response,name:a});else throw new Error("Failed to load blob response code is not between 200 - 300")},l.onerror=function(){throw new Error("Failed to load blob")},l.send()}let i=r();e.forEach(o=>{n(o.url,o.name,i.waitOn())}),i.endWith(o=>{let a=createDropEvent(o);t.dispatchEvent(a)})}});var LE,fa,Cy=v(()=>{"use strict";me();$();de();LE=C("drop-file-step-action"),fa=class extends H{async performAction(){let{sessionPlayerInit:{codeSnippets:e,utils:t},context:r,step:n}=this,i=this.getTarget(),o=O.flags.overrideAzureStorageUrl.isEnabled(),a=await t.addTokenToFileUrls(r.project.id,n.fileUrls,this.stepActionUtils.testimServicesApi,o,LE),{downloadFileAndFireDropEvent:c}=await Promise.resolve().then(()=>(Ay(),xy)),l=`
            const getLocatedElement = ${e.getLocatedElementCode};
            const createDropEvent = ${e.createDropEvent.toString()};
            const downloadFileAndFireDropEvent = ${c.toString()};
            return downloadFileAndFireDropEvent.apply(null, arguments)
        `;return await this.driver.executeJS(l,i.locatedElement,a)}}});function Oy(s={width:"2px",height:"2px",left:"0px",top:"400px"}){return`function getVisibleElement(locatedElement) {
        var input = getLocatedElement(locatedElement);
        if(input) {
            function parents(element, _elements) {
                _elements = _elements || [];
                _elements.push(element);
                if(element.parentNode && element.tagName !== 'BODY') {
                    return parents(element.parentNode, _elements);
                }
                return _elements;
            }

            function forceStyle(el, name, value) {
                el.style.setProperty(name, value, 'important');
            }

            Array.apply(null, parents(input)).forEach(function(el) {
                let element = el;
                if (element instanceof DocumentFragment) {
                    element = element.host
                }

                var displayMode = window.getComputedStyle(element).display;
                if(displayMode === "none") {
                    forceStyle(element, 'display', 'block');
                }
            })

            forceStyle(input, 'visibility', 'visible');
            forceStyle(input, 'width', '${s.width}');
            forceStyle(input, 'max-width', '${s.width}');
            forceStyle(input, 'height', '${s.height}');
            forceStyle(input, 'max-height', '${s.height}');
            forceStyle(input, 'z-index', 100000000);
            forceStyle(input, 'opacity', 1);
            forceStyle(input, 'top', '${s.top}');
            forceStyle(input, 'left', '${s.left}');
            forceStyle(input, 'position', 'fixed');
            forceStyle(input, 'pointer-events', 'all');
            input.removeAttribute("disabled");
            input.focus();
        }
    }`}async function NE(s,e){let t=null;try{t=(await kc(s)).body}catch(n){if(DE.error("failed to download input-file content",{err:{message:n.message,stack:n.stack,status:n.status}}),n.response)t=n.response.body;else throw n.cause?new Error(n.message):n}let r=`${Py.tmpdir()}/${e}`;return await ky.promises.writeFile(r,t),r}function ME(s){return se(s,e=>NE(e.url,e.name))}function UE(s,e){return e(s)}async function _y(s,e){let t=await ME(s),r=await se(t,n=>UE(n,e));return Array.isArray(r)&&r.map(n=>n==null?void 0:n.value)}var Py,ky,DE,Ly=v(()=>{"use strict";Py=I(require("os"));Ge();ky=require("fs");B();$();DE=C("input-file-utils")});function BE(){return`async function downloadAndUpload(locatedElement, fileUrls) {
        const fileIsNative = typeof window.File === 'function' && (window.File.toString().indexOf('native code') > -1);
        const File = fileIsNative ? window.File : (function obtainSafeGlobals() {
            const attachTo  = document.body || document.documentElement;
            if (attachTo) {
                let tempIFrame;
                try {
                    tempIFrame = document.createElement('iframe');
                    tempIFrame.style.setProperty('display', 'none');
                    tempIFrame.style.setProperty('pointer-events', 'none');
                    attachTo.appendChild(tempIFrame);
                    const { File } = tempIFrame.contentWindow;
                    return File;
                } finally {
                    if (tempIFrame) {
                        tempIFrame.parentElement.remove(frame);
                    }
                }
            } else {
                return window.File;
            }
        })();
        const element = getLocatedElement(locatedElement);
        if(!element) {
            throw new Error('element not found');
        }

        function getFileBlob(url) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'blob';

                xhr.onload = function() {
                    if (this.status === 200) {
                        resolve(this.response);
                    } else {
                        reject(new Error('Could not load file, failure status:' + this.status));
                    }
                }
                xhr.onerror = function(e) {
                    reject(new Error("Error " + e.target.status + " occurred while loading the file."));
                };
                xhr.send();
            });

        }

        const fileList = await Promise.all(fileUrls.map(async ({ url, name }) => {
            let blob;
            try {
                const res = await fetch(url)
                blob = await res.blob();
            } catch (err) {
                blob = await getFileBlob(url); // Sometimes the fetch fails, try using XHR as fallback
            }
            return new File([blob], name, { type: blob.type });
        }));

        const dt = new DataTransfer();
        for (const file of fileList) {
            dt.items.add(file);
        }
        element.files = dt.files;

        let changeWasFired = false;
        const changeFiredHandler = (e) => {
            changeWasFired = true;
        };

        element.addEventListener("change", changeFiredHandler, true);
        await Promise.resolve(); // wait microtick
        element.dispatchEvent(new Event("input", { bubbles: true }));
        if (!changeWasFired) {
            element.dispatchEvent(new Event("change", { bubbles: true }));
        }
        element.removeEventListener("change", changeFiredHandler, true);
    }`}var ga,ha,Dy=v(()=>{"use strict";Ly();me();$();B();de();ga=C("input-file-step-action"),ha=class extends H{constructor(){super(...arguments);this.uploadFile=t=>this.driver.uploadFile(t)}forceInputToBeVisible(t,r){ga.info("workaround - stepaction - move element to visible position");let n=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var getVisibleElement = ${Oy(r)};
            return getVisibleElement.apply(null, arguments);
        `;return this.driver.executeJS(n,t.locatedElement)}async safariPreUploadActions(t){let r={width:"150px",height:"150px",left:"10px",top:"10px"};try{return await this.forceInputToBeVisible(t,r)}catch(n){throw ga.error("failed to set input file in Safari recovery",{err:n}),n}}async uploadFilesAndForceVisibility(t,r){try{this.driver.isSafari()&&await this.safariPreUploadActions(r),await this.uploadFiles(t,r)}catch(n){let i="The element is not editable",o="The element is not focusable",a="An element command could not be completed because the element is not visible on the page.",c="element not interactable",l="element is not pointer- or keyboard interactable",d="invalid element state: Element is not currently interactable and may not be manipulated",m="Element must not be hidden, disabled or read-only",u="is not reachable by keyboard",f=n?n.message:"";if(f===d||f.startsWith(m)||f.startsWith(i)||f.startsWith(o)||f.startsWith(a)||f.includes(u)||f.includes(c)||f.includes(l)){await this.forceInputToBeVisible(r),await this.uploadFiles(t,r);return}throw ga.error("failed to set input file",{err:n}),n}}async uploadFiles(t,r){for(let n of t)await this.driver.elementIdValue(De(r.seleniumElement),n)}async performAction(){let t=this.getTarget(),r=O.flags.overrideAzureStorageUrl.isEnabled(),n=O.flags.downloadToBase64.isEnabled(),{sessionPlayerInit:i,context:o,step:a,stepActionUtils:c,driver:l}=this,d=await i.utils.addTokenToFileUrls(o.project.id,a.fileUrls,c.testimServicesApi,r,ga);if(d.length===0)throw new Error("No files urls to upload");if(n&&(d=await Promise.all(d.map(async({name:u,url:f})=>{let h=await Bt(f);return{name:u,url:`data:${h.type};base64,${Buffer.from(h.body).toString("base64")}`}}))),l.isSafari()||l.isFirefox()||l.isEdgeChromium()){await this.driver.executeJS(`
                const getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                const downloadAndUploadFile = ${BE()};
                return downloadAndUploadFile.apply(null, arguments);`,t.locatedElement,d);return}let m=await _y(d,this.uploadFile);await this.uploadFilesAndForceVisibility(m,t)}}});var ya,ba,Ny=v(()=>{"use strict";ya=require("url");me();ba=class extends H{async updateBaseUrl(e){let t=new ya.URL(e),r=new ya.URL(this.context.recordedBaseUrl),n=new ya.URL(this.context.baseUrl);return t.host===r.host&&r.host!==n.host&&(t.host=n.host),t.href}async performAction(){let e=this.context.data.testimNavigationStepDestination||this.context.data.url;if(this.step.openInNewTab){await this.driver.client.newWindow(e);return}let t=await this.updateBaseUrl(e);await this.driver.url(t)}}});var Ta,My=v(()=>{"use strict";me();B();Ta=class extends H{async performAction(){await ue(this.step.durationMS||0)}}});var wa,Uy=v(()=>{"use strict";me();wa=class extends H{async execute(){try{return await this.driver.reloadTab(),{success:!0}}catch(e){return{success:!1,reason:e.message}}}}});var Qn,Fy=v(()=>{"use strict";me();Qn=class extends H{async runApiInAut(e){var n;e.withCredentials=!0;let t=this.context.data.timeToPlayStep+3e3,{apiCall:r}=this.sessionPlayerInit;try{let i=await this.driver.executeCodeAsync(r,t,e);return(i==null?void 0:i.value)||{}}catch(i){throw(n=i==null?void 0:i.message)!=null&&n.includes("Javascript execution context no longer exists")?new Error('The page refreshed or changed while executing this step. Please consider unchecking "Send via web page" if this is expected.'):i}}runApiInBg(e){let{apiCall:t}=this.sessionPlayerInit;return t(e)}async performAction(){let{sessionPlayerInit:{commonConstants:e},step:t,context:r}=this,n={id:t.id,url:r.apiUrl,method:t.method,headers:r.apiHeaders,body:r.apiBody,timeout:r.data.maxTotalStepTime,omitCookies:t.omitCookies,forceUseFetch:["android","ios"].includes(r.project.type),formData:t.formData,fileUrls:r.fileUrls},i=t.sendViaWebApp?await this.runApiInAut(n):await this.runApiInBg(n),o=i.result||{},a={method:t.method,status:o.status,url:t.url};return i.success?o.status===0?{result:o,resultInfo:a,shouldRetry:!1,success:!1,reason:"Connection problem",errorType:e.stepResult.API_REQUEST_NETWORK_ERROR}:{result:o,resultInfo:a,shouldRetry:!1,success:!0}:{result:o,resultInfo:a,shouldRetry:!1,success:!1,reason:o.error||e.error.REQUEST_TIMED_OUT,errorType:o.exception?void 0:o.error?e.stepResult.API_FAILURE:e.stepResult.API_REQUEST_NETWORK_ERROR}}}});var va,By=v(()=>{"use strict";me();va=class extends H{async performAction(){let e=this.step.extractTextParamName,t=await this.stepActionUtils.extractTargetText(this.getTarget());return this.context.data.exports||={},this.context.data.exports[e]=t,{success:!0,data:this.context.data}}}});var jy,zu,Ku,$y=v(()=>{"use strict";jy=I(require("@applitools/spec-driver-webdriverio"));yi();we();zu=class{constructor(){let{EyeSdkBuilder:e}=Z(),t=wd["@applitools/eyes-sdk-core"]||"N/A",{makeSDK:r}=require("@applitools/eyes-sdk-core");this.sdk=r({name:"Testim.io",version:`4.0.1/eyes-sdk-core/${t}`,spec:jy.default}),this.handleApplitoolsSdkResult=e.handleApplitoolsSdkResult}async getManager(e,t,r,n){let{EyeSdkBuilder:i}=Z(),o=await this.sdk.makeManager({type:e?"ufg":"classic",concurrency:t});return i.rememberCreatedBatch(r,n),o}},Ku=new zu});var Vy,Wy,Zn,Gy=v(()=>{"use strict";Vy=I(require("lodash"));me();$();$y();Wy=C("pixel-validation-step-action"),Zn=class extends H{async performAction(){var m,u;let{shouldUseVisualGrid:t,applitoolsSdkConfig:r,applitoolsSdkLogger:n,testResultId:i}=this.context;this.runContext=this.context.getRunContext(void 0);let o=((m=this.runContext.incomingParams)==null?void 0:m.final)||{},a=((u=r.batch)==null?void 0:u.id)||i,c=await Ku.getManager(t,this.context.config.applitoolsConcurrency||5,a,this.runContext.applitoolsIntegrationData),l=this.getTarget()||{},d;try{let f=await c.openEyes({driver:this.driver.client,config:r,logger:n}),g={region:this.step.action==="element"&&l.seleniumElement||void 0,fully:this.step.action==="stitched"};Vy.isPlainObject(o.applitoolsStepSettings)&&(Object.assign(g,o.applitoolsStepSettings),Wy.info("Applitools SDK step executed with applitoolsStepSettings parameter",{applitoolsStepSettings:o.applitoolsStepSettings})),await f.check({settings:g}),d={isApplitoolsSdkResult:!0,success:!0,eyesResults:await f.close()}}catch(f){Wy.error("Applitools SDK step failed",{err:f,info:f.info}),d={isApplitoolsSdkResult:!0,success:!1,err:f}}return await Ku.handleApplitoolsSdkResult(this.context,d,this.step)}}});var Cs,Ju=v(()=>{"use strict";Ss();X();aa();Cs=class extends or{async executeCliCode(){var h,g,y;let{step:e,context:t}=this,r=this.stepActionUtils.driver.isMobile;if(!((y=(g=(h=t.company)==null?void 0:h.activePlan)==null?void 0:g.premiumFeatures)==null?void 0:y.cliAction)&&!r)return{success:"skipped",reason:"CLI action is not enabled in your current plan"};let{code:i="",id:o=""}=e,{incomingParams:a,testResultId:c,retryIndex:l,stepResultId:d}=t,m={config:t.config,data:t.data},u=t.data.timeToPlayStep,f=await vs(i,o,a,m,c,l,d,u);return this.checkCodeResponse(f)}async performAction(){try{return await this.executeCliCode()}catch(e){let{stepResult:t}=this.sessionPlayerInit.commonConstants;return e instanceof ce?{success:!1,errorType:t.ACTION_TIMEOUT}:{success:!1,reason:e.message,exception:e}}}}});var ar,Hy=v(()=>{"use strict";Ju();ar=class extends Cs{isFailedResult(e){return e===!1}}});var Sa,qy=v(()=>{"use strict";Ju();Sa=class extends Cs{isFailedResult(e){return!e}}});var Ea,zy=v(()=>{"use strict";Ss();me();X();Ea=class extends H{async performAction(){let{stepId:e,packageData:t,resultId:r,retryIndex:n,stepResultId:i,timeToPlayBeforeExec:o}=this.context;try{return{data:await ws(e,r,n,t,i,o),success:!0}}catch(a){return a instanceof At?{success:!1,code:"invalid-node-package",message:a.message}:a instanceof ce?{success:!1,code:"timeout"}:{success:!1,reason:a.message,exception:a}}}}});var Fr,Ky=v(()=>{"use strict";me();Fr=class extends H{async performAction(){return{success:"skipped",reason:"This step can run only in \u2018extension\u2019 run mode with either Chrome or Edge Chromium"}}}});var be,Jy=v(()=>{"use strict";me();be=class extends H{async performAction(){var r,n;let{sfdc:e}=this.sessionPlayerInit,t=e.sfdcNewSePage(this.driver,this.context.sfdcLogHandler||((i,o)=>this.context.playback.sfdcAddLog(i,o)));t.log.info(`BEGIN STEP '${(n=(r=this.step).getStepPreview)==null?void 0:n.call(r)}'`);try{let i=this.context.sfdcTestActions;if(i===void 0)throw new Error("No test actions were compiled");return{success:!0,reason:await e.sfdcExecute(t,i,this.context)}}catch(i){return{success:!1,reason:i.reason||i.message,exception:i,shouldRetry:!1}}finally{t.releaseObjects()}}}});var Ia,Yy=v(()=>{"use strict";me();Ia=class extends H{async performAction(){var r,n;let{sfdc:e}=this.sessionPlayerInit,t=e.sfdcNewSePage(this.driver,this.context.sfdcLogHandler||((i,o)=>this.context.playback.sfdcAddLog(i,o)));t.log.info(`BEGIN STEP '${(n=(r=this.step).getStepPreview)==null?void 0:n.call(r)}'`);try{return{success:!0,reason:await e.sfdcExecuteRecordedStep(t,this.step.recordedData,this.context)}}catch(i){return{success:!1,reason:i.reason||i.message,exception:i,shouldRetry:!1}}finally{t.releaseObjects()}}}});var Ra,Xy=v(()=>{"use strict";me();Ra=class extends H{async performAction(){let{sfdc:e}=this.sessionPlayerInit,t=e.sfdcNewSePage(this.driver,this.context.sfdcLogHandler);try{return await e.sfdcExecuteJavascript(t,this.step.code||"",this.context),{success:!0}}catch(r){return{success:!1,reason:r.reason||r.message,exception:r,shouldRetry:!1}}finally{t.releaseObjects()}}}});function jE(s,e){Object.keys(s).forEach(t=>{e.registerStepAction(t,s[t])})}function xa(s,e){jE($E,e),e.registerLocateStepActionUtils(Kn.getUtils(s))}var $E,Yu=v(()=>{"use strict";zh();Yh();iy();oy();cy();py();fy();gy();hy();yy();wy();vy();Sy();Ry();Cy();Dy();Ny();My();Uy();Fy();By();Gy();Hy();qy();zy();Ky();Jy();Yy();Xy();$E={locate:Kn,scroll:ra,mouse:sa,submit:pa,text:ia,"special-key":ca,"user-code":Gt,"validation-code-step":Gt,"wait-for-code-step":Gt,"action-code-step":Gt,"condition-step":As,"skip-code-step":As,"element-code-step":As,"evaluate-expression":na,"text-validation":Yn,"wait-for-text-validation":Yn,"select-option":ua,"drop-file":fa,"input-file":ha,hover:da,navigation:ba,wheel:ma,sleep:Ta,refresh:wa,"keyboard-shortcut-step":la,"api-validation":Qn,"api-action":Qn,"api-code-step":Gt,"extract-text":va,"simple-ui-verification":Zn,"wait-for-simple-ui-verification":Zn,"cli-validation-download-file":Fr,"cli-wait-for-download-file":Fr,"network-validation-step":Fr,"cli-validation-code-step":ar,"cli-wait-for-code-step":ar,"cli-action-code-step":ar,"cli-api-code-step":ar,"cli-condition-step":Sa,"node-package":Ea,"email-code-step":Gt,"cli-email-code-step":ar,"sfdc-internal-test-step":Ra,"sfdc-recorded-step":Ia,"sfdc-step-login":be,"sfdc-step-loginas":be,"sfdc-step-logout":be,"sfdc-step-sobjectcreate":be,"sfdc-step-sobjectdelete":be,"sfdc-step-findrecord":be,"sfdc-step-quickaction":be,"sfdc-step-sobjectedit":be,"sfdc-step-sobjectvalidate":be,"sfdc-step-launchapp":be,"sfdc-step-wait-for-page-load":be,"sfdc-step-closeconsoletabs":be,"sfdc-step-relatedlistaction":be,"sfdc-step-permission-validation":be,"sfdc-step-convert-lead-to-opportunity":be,"sfdc-step-quotelineeditor":be,"sfdc-document-validation":Fr,"sfdc-step-flow-screen-completion":be,"sfdc-step-sobjectverifyoptions":be}});var Qy,WE,Ps,Xu=v(()=>{"use strict";Qy=["simple-ui-verification","wait-for-simple-ui-verification"],WE=[...Qy,"custom-validation","sfdc-internal-test-step","sfdc-recorded-step","sfdc-step-login","sfdc-step-loginas","sfdc-step-logout","sfdc-step-sobjectcreate","sfdc-step-sobjectdelete","sfdc-step-findrecord","sfdc-step-quickaction","sfdc-step-sobjectvalidate","sfdc-step-launchapp","sfdc-step-wait-for-page-load","sfdc-step-closeconsoletabs","sfdc-step-sobjectedit","sfdc-step-relatedlistaction","sfdc-step-permission-validation","sfdc-step-convert-lead-to-opportunity","sfdc-step-quotelineeditor","sfdc-document-validation","sfdc-step-flow-screen-completion","sfdc-step-sobjectverifyoptions"],Ps=class{constructor(e){this.isDebuggerConnected=e;this.totalStepTime=0;this.currentRetryStart=0;this.totalStepTimesReport=[];this.currentRetryTimes=[];this.currentRetryTimesReport={};this.resetStepVariables(),this.resetRetryVariables()}resetStepVariables(e,t){this.currentRetryTimes=t||[],this.totalStepTime=e||0,this.totalStepTimesReport=[],this.currentRetryTimesReport={};let r=Date.now();this.currentRetryStart=r,this.lastUpdateTime=r}resetRetryVariables(){let e=Date.now();this.currentRetryStart=e,this.lastUpdateTime=e,this.totalStepTimesReport.push(this.currentRetryTimesReport),this.currentRetryTimesReport={}}initStepRun(e){let t=i=>{let o=this.getTotalStepTimeLeftToPlay(e,i),a=5e3;return o<=a?[a]:[Math.max(a,o/3)]};e.setStartTimestamp();let r=this.getTotalStepRunTime(e),n=WE.includes(e.stepType)?[r]:t(r);this.resetStepVariables(r,n),e.context.data.maxTotalStepTime=r}initRetryTime(){this.resetRetryVariables()}getTotalStepRunTime(e){let r=e.context.config.stepTimeout;return Qy.includes(e.stepType)&&(r=e.context.config.applitoolsStepTimeout||18e5),e.step.type.startsWith("sfdc-")&&(r=e.step.defaultTimeout),e.step.useStepTimeout&&e.step.stepTimeout?e.step.stepTimeout:r}getTotalStepTimeLeftToPlay(e,t=this.totalStepTime){let r=Date.now()-e.startTimestamp;return t-r}getCurrentRetryTime(e){return e.retryIndex<this.currentRetryTimes.length?this.currentRetryTimes[e.retryIndex]:this.getTotalStepTimeLeftToPlay(e)}getTotalCurrentRetryTimeLeft(e){let t=Date.now()-this.currentRetryStart;return this.getCurrentRetryTime(e)-t+1e3}getTabTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getDynamicParentTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getFrameTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getLocateTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getActionTimeout(e){if(this.isDebuggerConnected)return 6e5;let t=5e3,r=e.step.type,n=3e4;return r==="sleep"?e.step.durationMS+t:Math.max(this.getTotalStepTimeLeftToPlay(e),n)}}});var eb={};z(eb,{SeleniumTestPlayer:()=>ei});var Zy,VE,ei,Qu=v(()=>{"use strict";B();Zy=require("@applitools/eyes-sdk-core");Un();X();$();$u();Wh();Hu();ea();Hh();qu();we();Yu();Xu();ae();VE=C("SeleniumTestPlayer"),ei=class{constructor(e,t,r,n,i=void 0,o=void 0){this.id=e;this.playbackTimeoutCalculator=new Ps(ta());let{SessionPlayer:a,commonConstants:c,StepActionFactory:l}=Z();this.driver=n??new _r;let d=new Zo(this.driver);this.stepActionFactory=new l(d),xa(this.driver,this.stepActionFactory),this.tabService=this.driver.tabService||new Xo(this.driver),this.driver.tabService=this.tabService,this.tabService.createSesion(e);let m=Gh(this.driver);this.sessionPlayer=new a(e,{tabService:this.tabService,cookieUtils:new xs(this.driver),FrameLocator:m,portSelector:Qo,LocateElementPlayer:null,stepActionUtils:d,stepActionFactory:this.stepActionFactory,playbackTimeoutCalculator:this.playbackTimeoutCalculator,makeSDK:Zy.makeSDK}),this.sessionPlayer.setShouldMonitorPerformance(Boolean(r)),this.tabService.setAddFrameHandlerCallBack(this.sessionPlayer.addPlaybackFrameHandler.bind(this.sessionPlayer)),this.sessionPlayer.playbackManager.isRemoteSession=!0,this.sessionPlayer.playbackManager.isLocalRun=!1,this.sessionPlayer.playbackManager.testRetryCount=i,this.sessionPlayer.playbackManager.previousTestResultId=o,this.sessionPlayer.playbackManager.userParamsData=t||{},this.onStepCompleted=this.onStepCompleted.bind(this),this.sessionPlayer.playbackManager.on(c.playback.RESULT,this.onStepCompleted)}onStepCompleted(e,t,r,n){n!=null&&n.isTabOpener&&this.tabService.addNewPopup(this.id,n.id).catch(()=>null)}async onDone(){var r,n;let{commonConstants:e}=Z(),t=1e3*60*2;try{await pe((r=this.driver)==null?void 0:r.end(),t)}catch(i){i instanceof ce&&await((n=this.driver)==null?void 0:n.forceEnd().catch(()=>null))}this.sessionPlayer.playbackManager.off(e.playback.RESULT,this.onStepCompleted),Object.assign(this,{sessionPlayer:null,tabService:null,stepActionFactory:null,driver:null})}clearSessionTabs(){this.tabService.clearAllTabs(this.id)}async addTab(e,t={loadInfo:!0}){let r=await this.driver.getTabIds();if(!Array.isArray(r)){VE.error("addTab: driver.getTabIds() returned a non-array",{ids:r});return}let n=r.at(-1);await this.tabService.addNewTab(this.id,n,e,t),await this.sessionPlayer.addPlaybackFrameHandler(n,void 0,{emptyPage:!0})}async addAllTabs(e,t={loadInfo:!0,checkForMainTab:!0,takeScreenshots:!0},r=[]){let n=await this.driver.getTabIds(),i=[new URL(tt||mr).hostname].concat(r);for(let o of n.reverse()){await this.tabService.addNewTab(this.id,o,e,{...t,forceSwitch:!0});let a=this.tabService.getTabInfo(this.id,o);if(i.some(c=>a.url.includes(c))){this.tabService.removeTabInfo(this.id,o);continue}await this.sessionPlayer.addPlaybackFrameHandler(o,void 0,{emptyPage:!0})}if(this.tabService.tabCount(this.id)===1){let o=this.tabService.getMainTabInfo(this.id),a=this.tabService.getTabUtils(this.id,o);await this.tabService.switchTab(a.tabId,this.id,{forceSwitch:!0})}this.tabService.fixMissingMainTab(this.id)}getSessionId(){return this.driver.getSessionId()}}});var ep={};z(ep,{WorkerSelenium:()=>Zu});function HE(s){let{playback:e}=Z().commonConstants;for(let t of Object.values(e))s.playbackManager.on(t,()=>U(`Got event ${t}`))}var Aa,GE,Zu,tp=v(()=>{"use strict";B();$e();qn();$();_t();No();oe();Bu();X();Qu();we();ct();Aa=C("worker-selenium"),GE=1e9,Zu=class extends Dt{initPlayer(t){return new ei(this.id,t.runParams,this.options.shouldMonitorPerformance,void 0,t.retryCount,t.previousTestResultId)}async getBrowserOnce(t,r,n,i){U("in WorkerSelenium getBrowserOnce"),Q.onGetSession(this.id,this.testName,t.runMode);let{driver:o}=n;this.windowUtils=new Rs(this.id,o),n.clearSessionTabs();let{browserValue:a}=this.testRunConfig,c=t.baseUrl;try{let l=this.options.useLocalChromeDriver;await o.init({browserOptions:this.options,testName:this.testName,testRunConfig:this.testRunConfig,gridInfo:i,customExtensionLocalLocation:r,executionId:this.executionId,testResultId:this.testResultId,seleniumPerfStats:t.seleniumPerfStats,fastInit:l,lambdatestService:this.lambdatestService,printFinalCaps:this.options.printFinalCaps,mode:K.SELENIUM}),U("in WorkerSelenium after driver.init"),await n.addTab(void 0,{skipLoadInfo:l}),U("in WorkerSelenium after addTab"),l||await this.windowUtils.navigate(c,GE),await this.windowUtils.validatePageIsAvailable(),U("in WorkerSelenium after navigate")}catch(l){let d=l.message&&(l.message.startsWith("Malformed URL")||l.message.includes("Reached error page: about:neterror"))&&a==="firefox",m=l.message&&l.message==="invalid argument";throw l instanceof xt||d||m?new xt(`Page '${c}' is not available`):(Aa.error("failed to navigate to page",{baseUrl:c,err:l,whitelistedPublicIp:Qi(),initializedFromCache:Zi()}),l)}}async runTestOnce(t,r){var m;let{manifestVersion:n,localAssetService:i}=Z(),{driver:o,sessionPlayer:a}=r,c=n||"runner";Q.onWaitToTestComplete(this.id),HE(a),a.playbackManager.executionId=t.executionId,a.playbackManager.executionName=t.executionName,this.options.mode===K.SELENIUM&&a.setLightweightMode(this.options.lightweightMode),t.sfdcCredential&&a.setSfdcCredential(t.sfdcCredential),i.initialize({serverUrl:this.options.localRCASaver});let l=null;(m=this.options.lightweightMode)!=null&&m.preloadTests&&(l=(await jn(this.options))[this.testId]);let d=async()=>pe(new Promise((u,f)=>{a.playByTestId({testId:this.testId,executionId:this.executionId,resultId:this.testResultId,baseUrl:this.baseUrl,userData:this.userData,version:c,resolve:u,isLocalRun:!1,overrideTestConfigId:this.overrideTestConfigId,branch:this.branch,incognito:!1,remoteRunId:t.remoteRunId,preloadedTest:l}).catch(f)}),this.testRunTimeout,Ue.TEST_COMPLETE_TIMEOUT_MSG).catch(u=>{var f;throw u instanceof ce&&((f=a.stopPlayingOnTestTimeout)==null||f.call(a)),u}).then(async u=>{await i.drain(),u.stepsResults=null,u.resultId=this.testResultId,o.isAlive()||(Aa.warn(`possible grid unresponsive for test ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),u.gridIssues="could not validate grid is alive");let f=o.maxKeepAliveGap();f>=3e4&&(Aa.warn(`possible browser keep alive issue ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),u.keepAliveIssue=f);let g={...u,...t.seleniumPerfStats.getStats()};return this.lambdatestService.isLambdatestRun()&&await o.executeJS(`lambda-status=${g.success?"passed":"failed"}`).catch(()=>{}),g});o.start(),U("right before super.runTestOnce in workerSelenium");try{await super.runTestOnce(t,r),U("right after super.runTestOnce in workerSelenium");let u=await d();return U("right after runSeleniumTest"),u}catch(u){throw Aa.error("failed to run test once",{err:u}),u}}}});var tb,rb,He,qE,zE,rp,St,Ca=v(()=>{"use strict";tb=I(require("ora")),rb=require("jimp");ae();Ge();ge();$();oe();we();de();He=C("mobile-grid-service"),qE="https://tdc.tricentis-cloud.com",zE="https://ui.headspin.io",rp=class{constructor(){this.gridsAppIdGetter={[_.TESTIM_TDC]:({testRunHandler:e,mobileApp:t})=>e.getAppPath("testimTdcAppId",t),[_.TESTIM_TVC]:({testRunHandler:e,mobileApp:t})=>e.getAppPath("testimTvcAppId",t),[_.P_CLOUDY]:({testRunHandler:e,mobileApp:t})=>e.getAppPath("pCloudyAppId",t),[_.TESTIM_HEADSPIN]:({testRunHandler:e,mobileApp:t})=>e.getAppPath("headSpinAppId",t),[_.BROWSERSTACK]:({testRunHandler:e,mobileApp:t})=>e.getAppPath("browserStackAppId",t),[_.SAUCELABS]:({testRunHandler:e,mobileApp:t,gridHost:r})=>e.getSauceLabsAppPath(r,t)}}isTdcOrHeadSpinGrid(e){return e===_.TESTIM_TDC||e===_.TESTIM_HEADSPIN}getLockDeviceApiUrl(e){let t=this.getBaseApiUrl(e);return this.isTdcOrHeadSpinGrid(e.type)?`${t}/lock`:""}getBaseApiUrl(e){let{type:t,apiUrl:r}=e;return t===_.TESTIM_HEADSPIN?`${r||gc}/${yc}/devices`:t===_.TESTIM_TDC?`${r||hc}/${yc}/devices`:""}getHeaders(e){return{...this.isTdcOrHeadSpinGrid(e.type)&&{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`}}}buildRequestBody(e,t){return{...this.isTdcOrHeadSpinGrid(e.type)&&{device_id:t}}}async lockDevice(e,t){let r=this.getLockDeviceApiUrl(e),n=this.getHeaders(e),i=this.buildRequestBody(e,t);try{await Ve({url:r,headers:n,body:i})}catch(o){throw He.debug(`error while locking device ${t}`,{error:o}),o.status===401?new Error(`failed to lock device ${t}, device may be already locked and in use`):o}}async getHeadSpinDeviceConnection(e,t){let n=`${this.getBaseApiUrl(e)}/device_id:${t}/automation-config`;try{let i=await Te(n,void 0,this.getHeaders(e));return this.extractHeadSpinDeviceConnection(i,e.accessToken)}catch(i){throw He.error("error while getting automation config for device",{error:i,deviceId:t}),i}}async getPCloudyAuthToken(e,t,r){let n=await Ys(`https://${e}/api/access`,void 0,{Authorization:`Basic ${Buffer.from(`${t}:${r}`).toString("base64")}`});return JSON.parse(n).result.token}extractHeadSpinDeviceConnection(e,t){let r=Object.keys(e)[0],n=e[r].driver_url,i=new URL(n);return{hostname:i.hostname,port:Number(i.port),protocol:i.protocol.slice(0,-1),path:`/v0/${t}/wd/hub`}}async getGridDirectConnection(e,t){let r={};return this.isTdcOrHeadSpinGrid(e.type)&&(r=await this.getHeadSpinDeviceConnection(e,t)),r}getGridConnection(e){var r;if(this.isTdcOrHeadSpinGrid(e.type)){let n=(r=e.host)!=null&&r.includes("ulb.tdc.tricentis-cloud.com")?`/ulb/appium/v0/${e.accessToken}/wd/hub`:`/v0/${e.accessToken}/wd/hub`;return{protocol:e.protocol||"https",hostname:e.host,port:e.port,path:n}}if(e.type===_.TESTIM_TVC)return{protocol:e.protocol||"https",hostname:e.host,port:443,path:"/wd/hub"};if(e.type===_.P_CLOUDY)return{protocol:e.protocol||"https",hostname:e.host,port:443,path:"/appiumcloud/wd/hub",user:e.user,key:e.key};if([_.BROWSERSTACK,_.SAUCELABS].includes(e.type))return{protocol:e.protocol||"https",hostname:e.host,port:443,path:"/wd/hub",user:e.user,key:e.key}}async getDeviceNameFromSessionCaps({capabilities:e,gridType:t,projectId:r,projectType:n,companyId:i,gridId:o}){var a,c,l;if(t===_.TESTIM_HEADSPIN||t===_.TESTIM_TDC){let d=await ri({projectId:r,projectType:n,companyId:i,gridId:o,selectors:`device_id:${e.udid}`});return((a=d==null?void 0:d[0])==null?void 0:a.name)||e.device}if(t===_.BROWSERSTACK)return((c=e.mobile)==null?void 0:c.version.split("-")[0])||((l=e.desired)==null?void 0:l.deviceName);if(t===_.SAUCELABS)return e.testobject_device_name;if(t===_.P_CLOUDY){if(e.pCloudy_DeviceFullName){let d=e.pCloudy_DeviceFullName.split("_");return`${d[0]} ${d[1]}`}return e.deviceModel}return e.device}async updateDeviceOnRemoteTestResult(e,t,r,n,i=!1){let{executionId:o,testId:a,testResultId:c}=e,{project:l,projectData:{type:d}={},company:{companyId:m=""}={},gridData:{gridId:u="",type:f=""}={}}=n,h=t.capabilities,g=h.platformName,y;if(f===_.TESTIM_TVC){let{getTvcDeviceInfoFromSessionCaps:w}=Z();y=w(t.capabilities,i)}else y=await this.getDeviceFromAppiumCapabilities(h,t,r,g,f,l,d,m,u,i);let T=await this.buildRemoteResultLink(n.gridData,t.sessionId,h);return await Pr(l,o,a,c,"RUNNING",{device:y,...T&&{remoteResultLink:T}}),He.info("device details updated on testResult",{testResultId:c,executionId:o,testId:a,device:y,remoteResultLink:T,gridType:f}),y}getOsVersion(e,t){var n;let r=e.platformVersion;return!r&&t===_.BROWSERSTACK?(n=e.mobile)==null?void 0:n.version.split("-")[1]:r}async getScaleFactorAndSize(e,t,r,n,i){if(e.pixelRatio&&typeof e.deviceScreenSize=="string"){let o=e.deviceScreenSize.split("x"),a=Number(o[0]),c=Number(o[1]);return{scaleFactor:e.pixelRatio,width:a,height:c}}try{let{AppiumApi:o}=Z(),a=new o(t,r.sessionId,null,i),[c,l]=await Promise.all([a.getScreenshot(),a.getDeviceSize()]),d=Buffer.from(c,"base64"),m=await rb.Jimp.fromBuffer(d),u=m.bitmap.width,f=m.bitmap.height;return{scaleFactor:u/l.width,width:u,height:f}}catch(o){return He.warn("failed to get device scale factor from appium, applying default scale factor",{err:o}),{scaleFactor:n==="android"?1:2}}}async getDeviceFromAppiumCapabilities(e,t,r,n,i,o,a,c,l,d){let[m,u]=await Promise.all([this.getScaleFactorAndSize(e,r,t,n,d),this.getDeviceNameFromSessionCaps({capabilities:e,gridType:i,projectId:o,projectType:a,companyId:c,gridId:l})]),f=this.getOsVersion(e,i);return{name:u??"",model:e.deviceModel,udid:e.udid,osVersion:f,osType:n,isVirtual:!1,...m}}async buildRemoteResultLink(e,t,r){return e.type===_.BROWSERSTACK?(await this.fetchWithUserAndPasswordAuth({url:`${Ws}/sessions/${t}.json`,user:e.user,key:e.key})).automation_session.public_url:e.type===_.SAUCELABS?r.testobject_test_report_url:e.type===_.TESTIM_TVC?r.replayUrl:e.type===_.TESTIM_HEADSPIN||e.type===_.TESTIM_TDC?`${e.type===_.TESTIM_HEADSPIN?zE:qE}/sessions/${t}/waterfall`:""}async getTmaDeviceDetails(e,t){let n=(await Te(`${e}/api/devices`)).find(i=>i.udid===t);if(!n)throw new Error(`device ${t} not found`);return{udid:n.udid,name:n.name,model:n.model,height:n.height,width:n.width,geo:"local",osVersion:n.osVersion,osType:n.deviceType.toLowerCase(),scaleFactor:n.scaleFactor??0,isVirtual:n.virtual??!1,minApiVersion:n.minApiVersion}}async updateTmaDeviceDetails(e,t,r){let{executionId:n,testId:i,testResultId:o}=r,{project:a,localTmaUrl:c}=t,l=await this.getTmaDeviceDetails(c,e);return await Pr(a,n,i,o,"RUNNING",{device:l}),He.info("device details updated on testResult",{testResultId:o,executionId:n,testId:i,device:l}),l}async getGridAppId({gridData:e,testRunHandler:t,projectId:r}){let n=e.type,i=t.mobileApp,o=this.gridsAppIdGetter[n]({testRunHandler:t,mobileApp:i,gridHost:e.host});return o?(O.flags.allowFixingAppIdStructure.isEnabled()&&(He.info("fixing gridAppId structure",{gridAppId:o,projectId:r,testResultId:t.testResultId,executionId:t.executionId}),await np({gridAppId:o,gridId:e.gridId,projectId:r,gridType:n,appId:i.appId,gridHost:e.host})),o):t.getAppPathByGridType(n,e.gridId,i)}async getMobileAppDataByAppId({appId:e,projectId:t,token:r}){let n=await ti({appId:e,projectId:t});return{appUrl:`${he()}/storage${n.filePath}?access_token=${r}`,mobileApp:n}}calculateUploadRequestTimeOut(e){let t=0,r=Math.ceil(e/1024);return t=(Math.ceil(r/(Ud*60))+1)*60*1e3,Math.max(Md,t)}async uploadAppToGrid({projectId:e,testRunHandler:t,mobileApp:r,gridId:n,gridType:i}){let a={[_.BROWSERSTACK]:{name:"Browserstack"},[_.TESTIM_TVC]:{name:"Mobile Virtual Grid"},[_.P_CLOUDY]:{name:"pCloudy"}}[i].name;if(t.isAppFromDevice)throw new Error(`Application from your device, ${a} grid dose not support application from device. Please choose a compatible application for testing.`);let c=r||t.mobileApp,l=(0,tb.default)(`uploading app to ${a} please wait..`).start();try{He.info(`uploading app to ${a} during test run`,{mobileApp:r,projectId:e,testResultId:t.testResultId,executionId:t.executionId});let d=await sp({projectId:e,gridId:n,app:c,timeout:this.calculateUploadRequestTimeOut(c.fileSize)});return l.succeed(`app uploaded successfully to ${a}`),d.gridAppId}catch(d){throw l.fail(`failed to upload app to ${a}`),He.error(`failed to upload app to ${a}`,{error:d,mobileApp:r,projectId:e,testResultId:t.testResultId,executionId:t.executionId}),new Error(`failed to upload app to ${a}`)}}async verifyAppAlreadyUploaded({testRunHandler:e,pendingAppUploads:t,projectId:r,gridId:n,gridType:i,mobileAppId:o}){let a=t.get(o);if(a!=null&&a.isUploaded)return a.uploadedAppId;let c=await this.uploadAppToGrid({projectId:r,testRunHandler:e,gridId:n,gridType:i});return t.set(o,{isUploaded:!0,uploadedAppId:c}),c}async getAppIdFromGridOrTestimPublicLink({testRunHandler:e,options:t,pendingAppUploads:r}){let n="",i,{executionId:o,testResultId:a}=e,{appId:c="",project:l,authData:{token:d=""}={},gridData:m={}}=t,{gridId:u="",type:f=""}=m;if(!c&&e.isAppFromDevice)return n;if(c){He.info("getting appData by appId",{appId:c,projectId:l,testResultId:a,executionId:o});let T=await this.getMobileAppDataByAppId({appId:c,projectId:l,token:d});n=T.appUrl,i=T.mobileApp,e.nativeApp=i}else He.info("no appId setting appPath from app associated with the test",{projectId:l,testResultId:a,executionId:o}),n=e.downloadableAppPublicLink||"";let h=c||e.mobileApp.appId,g=await this.getGridAppId({projectId:l,gridData:m,testRunHandler:e}),y=f===_.BROWSERSTACK||f===_.TESTIM_TVC||f===_.P_CLOUDY;if(g){let T=t.projectData.type,w=await this.verifyAppStillExistsOnGrid({gridAppId:g,gridData:m,projectType:T});w&&(He.info("app exists on grid, using gridAppId",{gridAppId:g,projectId:l,testResultId:a,executionId:o,mobileAppId:h}),n=g),!w&&y&&(He.info("app not exists on grid, uploading it",{gridAppId:g,projectId:l,testResultId:a,executionId:o,mobileAppId:h}),n=await this.verifyAppAlreadyUploaded({testRunHandler:e,pendingAppUploads:r,projectId:l,gridId:u,gridType:f,mobileAppId:h})),!w&&!y&&He.info("app not exists on grid, using testimStorage url",{projectId:l,testResultId:a,executionId:o})}return!g&&y&&(n=await this.verifyAppAlreadyUploaded({testRunHandler:e,pendingAppUploads:r,projectId:l,gridId:u,gridType:f,mobileAppId:h})),n}async verifyAppStillExistsOnGrid({gridAppId:e,gridData:t,projectType:r}){var d,m;let{accessToken:n,user:i,host:o,key:a,type:c,apiUrl:l}=t;if(c===_.BROWSERSTACK){let u=`${Ws}/recent_apps`,f=await this.fetchWithUserAndPasswordAuth({url:u,user:i,key:a});return Array.isArray(f)?f.some(h=>h.app_url===e):!1}if(c===_.SAUCELABS){let u=`https://${o==null?void 0:o.replace("ondemand","api")}/v1/storage/files`;return(await this.fetchWithUserAndPasswordAuth({url:u,user:i,key:a})).items.some(h=>h.id===e)}if(c===_.TESTIM_HEADSPIN||c===_.TESTIM_TDC){let u=`${l}/${bc}/apps`;return l||(u=`${c===_.TESTIM_HEADSPIN?gc:hc}/${bc}/apps`),(await this.fetchWithTokenAuth({url:u,accessToken:n,authType:"Bearer"})).apps.some(h=>h.app_id===e)}if(c===_.TESTIM_TVC){let u=`${Fd}/versions/${e}/info`,f=t[`${r}Token`];try{return await this.fetchWithTokenAuth({url:u,accessToken:f,authType:"Upload-Token",userAgent:"Testim-CLI"}),!0}catch(h){return h.status!==404&&He.error("error while verifying app exists on TVC",{error:h}),!1}}if(c===_.P_CLOUDY){let u=await this.getPCloudyAuthToken(o,i,a),f=`https://${o}/api/drive`,h=await Cc({url:f,body:{token:u,filter:"all"},headers:{contentType:null}});return(m=(d=JSON.parse(h).result)==null?void 0:d.files)==null?void 0:m.some(y=>y.file===e)}throw new Error(`grid type ${c} is not supported`)}async fetchWithUserAndPasswordAuth({url:e,user:t,key:r}){let n={Authorization:`Basic ${Buffer.from(`${t}:${r}`).toString("base64")}`};return await Te(e,void 0,n)}async fetchWithTokenAuth({url:e,accessToken:t,authType:r,userAgent:n}){let i={Authorization:`${r} ${t}`,...n&&{"User-Agent":n}};return await Te(e,void 0,i)}},St=new rp});function sb({nativeAppMetadata:s,appPath:e,gridInfo:t}){if(!s&&!e||!s)throw Error("Application not specified. Please provide the required application for execution and try again.");if(!s.id&&!s.activity&&!s.packageName)throw Error("The application appears to be corrupted. Please ensure the application is in a valid state before running the test.");if(t.mode!=="local"&&!KE.includes(t.type))throw Error(`unsupported grid was detected please make sure to select supported mobile grid (${t.type})`)}function JE({deviceUdid:s,gridInfo:e,testRunConfig:t}){let{staticAllocation:r}=(t==null?void 0:t.mobile)||{};if(e.type!==_.TESTIM_TDC&&e.type!==_.TESTIM_HEADSPIN)throw Error("unsupported grid was detected please make sure to select supported mobile grid for direct connection");if(!s&&!(r!=null&&r.deviceUdid))throw Error("missing device udid or test run config is not static");if(!s&&(r!=null&&r.deviceUdid)&&r.deviceUdid.split(",").length!==1)throw Error("provided static config contains multi devices")}function YE(s){let{testName:e,executionId:t,testResultId:r,customTag:n}=s,i=[{executionId:t},{testResultId:r}];return e&&i.push({testName:e}),n&&i.push({customTag:n}),i}function XE(s,e,t){let{fullReset:r,setNoReset:n,skipLoadBalancer:i}=e,o=s===_.TESTIM_TDC,a=s===_.TESTIM_HEADSPIN,c=o?"tdc":"headspin",l=a&&O.flags.enableBatchHeadSpin.isEnabled(),d=o&&(O.flags.enableBatchTDC.isEnabled()||O.flags.headSpinTdcEnableFlagCapability.isEnabled()),m=O.flags.increaseTDCRequestTimeout.isEnabled();return{[`${c}:capture.video`]:!0,...O.flags.tdcHsPreventNetworkCapture.isEnabled()&&{[`${c}:capture.network`]:!1},...i&&{[`${c}:controlLock`]:!0},[`${c}:retryNewSessionFailure`]:!1,[`${c}:sessionTags`]:YE(t),[`${c}:enableBatch`]:l||d,...!r&&{"appium:noReset":n},...m&&{[`${c}:newCommandTimeout`]:600,"appium:newCommandTimeout":600}}}function Pa(s){return"id"in s?s.id:s.packageName}function QE(s,e){return{[`${e===_.TESTIM_TDC?"tdc":"headspin"}:app.id`]:s}}function ZE({projectType:s,sessionCaps:e,options:t,nativeAppMetadata:r,appPath:n,androidActivityWait:i}){let{fullReset:o,setNoReset:a}=t,c={"appium:app":n},l=n==null?void 0:n.startsWith("http");n&&!l&&(c=QE(n,t.gridData.type));let m=()=>o===void 0&&n?!0:typeof o=="string"?o!=="false":o;switch(s){case"ios":return{...e,platformName:"iOS","appium:autoAcceptAlerts":!0,"appium:automationName":"XCUITest","appium:fullReset":m(),...r&&{"appium:bundleId":Pa(r)},...n&&c};case"android":return{...e,platformName:"Android","appium:fullReset":!!o,"appium:autoGrantPermissions":!a,"appium:automationName":"UiAutomator2",...i&&{"appium:appWaitActivity":`${i}, *`},...r&&{"appium:appPackage":Pa(r),"appium:appActivity":r.activity??".*"},...n&&c};default:throw Error(`unsupported mobile project ${s}`)}}function jr({projectType:s,sessionCaps:e,nativeAppMetadata:t,appPath:r,androidActivityWait:n,appiumPrefix:i="",shouldRunInEnhancedMode:o}){switch(s){case"ios":return{platformName:"iOS",[`${i}autoAcceptAlerts`]:!0,[`${i}automationName`]:o?"WaldoTestim":"XCUITest",[`${i}fullReset`]:!0,...t&&{[`${i}bundleId`]:Pa(t)},...r&&{[`${i}app`]:r},...e};case"android":return{platformName:"Android",[`${i}autoGrantPermissions`]:!0,[`${i}automationName`]:o?"WaldoTestim":"UiAutomator2",...n&&{[`${i}appWaitActivity`]:`${n}, *`},...t&&{[`${i}appPackage`]:Pa(t),[`${i}appActivity`]:t.activity??".*"},...r&&{[`${i}app`]:r},...e};default:throw Error(`unsupported mobile project ${s}`)}}function nb({projectType:s,nativeAppMetadata:e,appPath:t,androidActivityWait:r,sessionTags:n,options:i,gridInfo:o,shouldRunInEnhancedMode:a}){let c=XE(o.type,i,n);return ZE({projectType:s,sessionCaps:c,options:i,nativeAppMetadata:e,appPath:t,androidActivityWait:r,shouldRunInEnhancedMode:a})}function Oa({osVersion:s,mobileConfig:e}){let{staticAllocation:t,dynamicAllocation:r}=e;return s||(t!=null&&t.osVersion?t==null?void 0:t.osVersion:r!=null&&r.osVersionRegex?r==null?void 0:r.osVersionRegex:".*")}function _a({deviceName:s,mobileConfig:e,projectType:t,gridType:r}){let{staticAllocation:n,dynamicAllocation:i}=e,o=r===_.P_CLOUDY;return s||(n!=null&&n.deviceName?o?n.deviceUdid:n.deviceName:i!=null&&i.deviceNameRegex?t==="android"&&i.deviceNameRegex===".*"&&o?Tc:i.deviceNameRegex:t==="ios"&&r===_.BROWSERSTACK?"iPhone.*":o?t==="ios"?"apple":Tc:".*")}function eI(s,e){let{androidToken:t,iosToken:r}=s,n=e==="ios";if(!t&&!r)throw Error("missing access token for testim virtual cloud");if(n&&!r)throw Error("missing ios token for testim virtual cloud");if(!n&&!t)throw Error("missing android token for testim virtual cloud");return n?r:t}function tI(s){return{"appium:appiumVersion":"2.0.0","appium:platformVersion":"10",...ka(s,ks)}}function ib(s,e,t){return s?Object.entries(s).reduce((r,[n,i])=>{if(e(n)){if(!t)return r[n]=i,r;let o=n.replace(t,"");r[o]=i}return r},{}):{}}function rI(s){return ib(s,e=>e.startsWith("browserstack."),"browserstack.")}function sI(s){return ib(s,e=>!e.startsWith("browserstack."))}function ob(s){return!s||!ab(s)?"2.0.0":s}function ab(s){return s.split(".")[0]==="2"||s.includes("appium2")||s==="latest"}function cb({osVersion:s,projectType:e,appiumVersion:t,isBrowserStack:r=!1}){let n=/^(1[4-9](\.\d+){0,2})$|^\^\(\?=1[4-9]((\.\d+){0,2})\.\*\)\.\*$/,i=/^(10(\.\d+){0,2})$|^\^\(\?=10((\.\d+){0,2})\.\*\)\.\*$/,o=/^(1[7-9](\.\d+){0,2})$|^\^\(\?=1[7-9]((\.\d+){0,2})\.\*\)\.\*$/,a=r&&i.test(s),c=e==="android"&&(n.test(s)||a),l=e==="ios"&&o.test(s),d=c||l;if(t){let m=ab(t);return!m&&d?(console.warn(`Appium 2 is required for version: ${s}, forcing appium 2 for current session.`),!0):m}return d}function ka(s,e){let t={};return Object.entries(s).forEach(([r,n])=>{let i=`${e}${r}`;t[i]=n}),t}async function nI({projectType:s,nativeAppMetadata:e,appPath:t,androidActivityWait:r,options:n,gridInfo:i,sessionTags:o,testRunConfig:a,shouldRunInEnhancedMode:c}){let{osVersion:l,deviceName:d}=n,m=(a==null?void 0:a.mobile)||{},{type:u}=i,f=eI(i,s),h=await ri({gridId:i.gridId,projectType:s,projectId:n.project,companyId:n.company.companyId}),g=h==null?void 0:h.find(({udid:S})=>{var E;return((E=m.staticAllocation)==null?void 0:E.deviceUdid)===S}),y=(g==null?void 0:g.osVersion)??Oa({osVersion:l,mobileConfig:m}),T=(g==null?void 0:g.name)??_a({deviceName:d,mobileConfig:m,projectType:s,gridType:u}),w=ze(n.editorUrl,n.project,o.testId,o.testResultId,o.branch),b={device:T,os_version:y,"waldo:displayName":`${o.testName}-${o.executionId}-${o.testResultId}`,"waldo:externalUrl":w,...c&&{"waldo:automationName":"WaldoTestim"},"waldo:options":{token:f}};return jr({projectType:s,sessionCaps:b,nativeAppMetadata:e,appPath:t,androidActivityWait:r,shouldRunInEnhancedMode:c})}function iI({projectType:s,nativeAppMetadata:e,appPath:t,androidActivityWait:r,options:n,gridInfo:i,sessionTags:o,testRunConfig:a}){let{osVersion:c,deviceName:l}=n,d=(a==null?void 0:a.mobile)||{},{user:m,key:u,type:f}=i,h=O.flags.enableAppium2pCloudy.isEnabled(),g=Oa({osVersion:c,mobileConfig:d}),y=_a({deviceName:l,mobileConfig:d,projectType:s,gridType:f}),T=/^[a-zA-Z]+$/.test(y),w={...g!==".*"&&{pCloudy_DeviceVersion:g},...T&&{pCloudy_DeviceManufacturer:y},...!T&&{pCloudy_DeviceFullName:y}},b={pCloudy_Username:m,pCloudy_ApiKey:u,pCloudy_Individual:o.pCloudyIndividual,pCloudy_EnableVideo:!0,pCloudy_EnablePerformanceData:!0,pCloudy_EnableDeviceLogs:!0,...w,pCloudy_DurationInMinutes:n.duration?Number(n.duration):Number(Bd),pCloudy_ApplicationName:t,appiumVersion:"1.21.0",newCommandTimeout:600,lunchTimeout:"90000",uiautomator2ServerInstallTimeout:15e4,uiautomator2ServerLaunchTimeout:2e5};return h&&(b=tI(b)),t="",jr({projectType:s,sessionCaps:b,nativeAppMetadata:e,appPath:t,androidActivityWait:r,...h&&{appiumPrefix:ks}})}function oI({projectType:s,nativeAppMetadata:e,appPath:t,androidActivityWait:r,options:n,gridInfo:i,sessionTags:o,testRunConfig:a}){let{osVersion:c,deviceName:l}=n,d=(a==null?void 0:a.mobile)||{},{type:m}=i,u=Oa({osVersion:c,mobileConfig:d}),f=_a({deviceName:l,mobileConfig:d,projectType:s,gridType:m}),h=(0,Br.omit)({...n.saucelabs},["automationName","platformName"]),g={...h["sauce:options"]};if(delete h["sauce:options"],cb({osVersion:h.platformVersion||u,projectType:s,appiumVersion:g.appiumVersion})){let T={debug:!0,networkLogs:!0},w={user:i.user,key:i.key,name:o.testResultId,build:o.executionId,appiumVersion:ob(g.appiumVersion),deviceName:f,tags:Object.values(o)},b={"appium:platformVersion":u,"appium:deviceName":f,...ka(h,ks),"sauce:options":{...T,...w,...(0,Br.omit)(g,"appiumVersion")}};return jr({projectType:s,sessionCaps:b,appiumPrefix:ks,nativeAppMetadata:e,appPath:t,androidActivityWait:r})}let y={"saucelabs.user":i.user,"saucelabs.key":i.key,platformVersion:u,deviceName:f,tags:Object.values(o),name:o.testResultId,build:o.executionId,...h,...g};return jr({projectType:s,sessionCaps:y,nativeAppMetadata:e,appPath:t,androidActivityWait:r})}function aI({projectData:s,projectType:e,nativeAppMetadata:t,appPath:r,androidActivityWait:n,options:i,gridInfo:o,sessionTags:a,testRunConfig:c}){let{osVersion:l,deviceName:d}=i,m=(c==null?void 0:c.mobile)||{},{type:u}=o,f=Oa({osVersion:l,mobileConfig:m}),h=_a({deviceName:d,mobileConfig:m,projectType:e,gridType:u}),g=rI(i.browserstack),y=(0,Br.omit)(sI(i.browserstack),["automationName","platformName","project","build","name"]),T={buildName:`${a.executionName} - ${a.executionId}`,projectName:`${s.name} - ${s.projectId}`,sessionName:`${a.testName} - ${a.testId}`},w=O.flags.enableAppium2BrowserStack.isEnabled();if(w||cb({osVersion:y.platformVersion||f,projectType:e,isBrowserStack:!0,appiumVersion:g.appiumVersion})){let S={...T,userName:o.user,accessKey:o.key,appiumVersion:w?"2.0.1":ob(g.appiumVersion),debug:!0,networkLogs:!0},E={"appium:platformVersion":f,"appium:deviceName":h,...ka(y,ks),"bstack:options":{...S,...(0,Br.omit)(g,"appiumVersion")}};return jr({projectType:e,sessionCaps:E,appiumPrefix:ks,nativeAppMetadata:t,appPath:r,androidActivityWait:n})}let b={...T,os_version:y.platformVersion||f,device:y.deviceName||h,realDevice:!0,buildTags:Object.values(a).join(","),"browserstack.user":o.user,"browserstack.key":o.key,"browserstack.debug":!0,"browserstack.networkLogs":!0,...y,...ka(g,"browserstack.")};return jr({projectType:e,sessionCaps:b,nativeAppMetadata:t,appPath:r,androidActivityWait:n})}async function cI(s){if(_.TESTIM_TDC===s.gridInfo.type||_.TESTIM_HEADSPIN===s.gridInfo.type)return nb(s);if(_.TESTIM_TVC===s.gridInfo.type)return await nI(s);if(_.P_CLOUDY===s.gridInfo.type)return iI(s);if(_.SAUCELABS===s.gridInfo.type)return oI(s);if(_.BROWSERSTACK===s.gridInfo.type)return aI(s);throw new Error(`unsupported grid type ${s.gridInfo.type}`)}function lI(s,e){var l,d;let{staticAllocation:t,dynamicAllocation:r,type:n}=e||{},{deviceName:i,osVersion:o,deviceUdid:a}=s,c={};return n==="dynamic"&&(!i&&((l=r==null?void 0:r.selector)!=null&&l.manufacturer)&&(c.manufacturer=r.selector.manufacturer),!o&&((d=r==null?void 0:r.selector)!=null&&d.osVersion)&&(c.os_version=r.selector.osVersion)),n==="static"&&!a&&(t!=null&&t.deviceUdid)&&(c.device_id=t.deviceUdid),i&&(c.manufacturer=i),o&&(c.os_version=o),a&&(c.device_id=a,delete c.os_version,delete c.manufacturer),c}async function lb(s){let{gridInfo:e,nativeAppMetadata:t,options:r,appPath:n,testRunConfig:i}=s,{selectedGrid:o}=(i==null?void 0:i.mobile)||{};if(i!=null&&i.mobile&&(o==null?void 0:o.type)!==e.type)throw Error(`selected grid type ${o.type} is not equal to grid type ${e.type}`);sb({nativeAppMetadata:t,appPath:n,gridInfo:e});let a=St.getGridConnection(e),c=await cI(s);if(e.type===_.TESTIM_HEADSPIN||e.type===_.TESTIM_TDC){let y=e.type===_.TESTIM_HEADSPIN?"headspin":"tdc",T=lI(r,i==null?void 0:i.mobile);if(!(0,Br.isEmpty)(T)){let w=Object.entries(T).map(([b,S])=>S.split(",").map(E=>E===".*"||E==="="?"":`${b}:${E}`).join(",")).join(" ").trim();c[`${y}:selector`]=w}}let l=e.type===_.TESTIM_TVC?{alwaysMatch:c}:c,d=O.flags.increaseTDCRequestTimeout.isEnabled(),m=0,u=(0,ip.default)("2m"),f=(0,ip.default)("12m"),h=hr(O.flags.appiumConnectionRetryCount.getValue(),m),g=hr(O.flags.appiumConnectionRequestTimeout.getValue(),u);return d&&g<f&&(g=f),{...a,desiredCapabilities:c,connectionRetryTimeout:g,capabilities:l,connectionRetryCount:h,logLevel:r.appiumLogLevel}}async function ub(s){var h,g;let{projectType:e,gridInfo:t,nativeAppMetadata:r,options:n,appPath:i,androidActivityWait:o,sessionTags:a,testRunConfig:c}=s,{deviceUdid:l}=n;sb({nativeAppMetadata:r,appPath:i,gridInfo:t}),JE({deviceUdid:l,gridInfo:t,testRunConfig:c});let d=l||((g=(h=c.mobile)==null?void 0:h.staticAllocation)==null?void 0:g.deviceUdid),m=await St.getGridDirectConnection(t,d),f=nb({projectType:e,nativeAppMetadata:r,appPath:i,androidActivityWait:o,options:n,sessionTags:a,testRunConfig:c,gridInfo:t});return d&&(f["appium:udid"]=d),{...m,desiredCapabilities:f,capabilities:f,connectionRetryCount:0,logLevel:n.appiumLogLevel}}function pb(s){let{projectType:e,nativeAppMetadata:t,appPath:r,androidActivityWait:n}=s,o=jr({projectType:e,sessionCaps:{dontStopAppOnReset:!0,fullReset:!1},nativeAppMetadata:t,appPath:r,androidActivityWait:n});return e==="ios"&&delete o.app,o}function db(s){var t,r;let e={...s};return delete e.path,delete e.user,delete e.key,delete e.desiredCapabilities,delete e.capabilities["saucelabs.user"],delete e.capabilities["saucelabs.key"],delete e.capabilities["browserstack.user"],delete e.capabilities["browserstack.key"],(t=e.capabilities["sauce:options"])==null||delete t.user,(r=e.capabilities["sauce:options"])==null||delete r.key,delete e.capabilities.key,delete e.capabilities.user,e}var ip,Br,ks,KE,op=v(()=>{"use strict";ip=I(require("ms"));de();oe();Ca();Br=require("lodash");B();ae();ge();ks="appium:",KE=[_.BROWSERSTACK,_.SAUCELABS,_.TESTIM_HEADSPIN,_.TESTIM_TDC,_.TESTIM_TVC,_.P_CLOUDY]});var La,fb=v(()=>{"use strict";La=class{constructor(){this.sessionTabs={}}on(){}tabCount(){}getAllOpenTabIds(){return[]}isSessionTab(){return!1}getAllTabInfos(){return{}}async addNewTab(){}addOpenerStepId(){}addOpenerStep(){}getTabUtilsByTabIdAndSessionId(){}getTabUtilsByTabId(){return{}}getTabInfo(){return{}}getTabUtils(){return{}}getMainTabInfo(){}getMainTabUtils(){return{}}getMainTabId(){return null}async isMainTabExists(){return!1}clearAllTabs(){}async switchTab(){}async getTabDetails(){}async isMainTabIncognito(){return!1}async getTabIdByTabInfo(){return NaN}}});var Da,gb=v(()=>{"use strict";B();Da=class{constructor(e){this.driver=e;this._abortedSteps=[];this.unescapeHTML=sn;this.getLinksFromUnescapeHTML=nn}resetAbort(){this._abortedSteps.length=0}abort(e){this._abortedSteps.push(e)}get abortedSteps(){return this._abortedSteps}async executeInAut(e,t){throw new Error("not implemented (mobile)")}extractTargetText(e){throw new Error("not implemented (mobile)")}getCookie(e){throw new Error("not implemented (mobile)")}setCookie(e){throw new Error("not implemented (mobile)")}async getNextDynamicParent(e,t){throw new Error("not implemented (mobile)")}}});var ap,Na,hb=v(()=>{"use strict";$();ap=C("mobile-frame-locator-mock"),Na=class{foundFrameCallback(){return ap.info("foundFrameCallback-mock invoked"),{}}locate(){return ap.info("locate-mock invoked"),{}}async findFrame(){return ap.info("findFrame-mock invoked"),{}}}});var uI,bb,yb,Os,cp=v(()=>{"use strict";uI=I(require("webdriverio")),bb=require("@applitools/eyes-sdk-core");fb();Hu();$();gb();qu();we();Yu();hb();Xu();yb=C("appium-test-player"),Os=class{constructor(e,t,r,n=uI,i=void 0,o=void 0){this.id=e;this.driver=n;let{SessionPlayer:a,commonConstants:c,StepActionFactory:l,MobileLocateElementPlayer:d}=Z(),m=new Da(this.driver);this.stepActionFactory=new l(m),xa(this.driver,this.stepActionFactory),this.playbackTimeoutCalculator=new Ps(ta()),this.sessionPlayer=new a(e,{tabService:new La,cookieUtils:void 0,FrameLocator:Na,portSelector:Qo,LocateElementPlayer:d,stepActionUtils:m,stepActionFactory:this.stepActionFactory,playbackTimeoutCalculator:this.playbackTimeoutCalculator,makeSDK:bb.makeSDK}),this.sessionPlayer.setShouldMonitorPerformance(Boolean(r)),this.sessionPlayer.playbackManager.isRemoteSession=!0,this.sessionPlayer.playbackManager.isLocalRun=!1,this.sessionPlayer.playbackManager.testRetryCount=i,this.sessionPlayer.playbackManager.previousTestResultId=o,this.sessionPlayer.playbackManager.userParamsData=t||{},this.onStepCompleted=this.onStepCompleted.bind(this),this.sessionPlayer.playbackManager.on(c.playback.RESULT,this.onStepCompleted)}onStepCompleted(e,t,r,n){}async onDone(){let{playbackManager:e}=this.sessionPlayer,{executionId:t,testResult:{resultId:r}={},appiumApi:n}=e,i={executionId:t,testResultId:r,sessionId:n==null?void 0:n.sessionId};try{n!=null&&n.sessionId&&(await(n==null?void 0:n.endSession()),yb.info("appium session deleted",{...i}))}catch(o){yb.error("error while deleting appium session",{...i,error:o})}finally{let{commonConstants:o}=Z();e.off(o.playback.RESULT)}}getSessionId(){var e;return(e=this.sessionPlayer.playbackManager.appiumApi)==null?void 0:e.sessionId}}});async function pI(s){return await Te(`${s}/api/status`)}async function Tb(s,e){return await Te(`${s}/api/devices/${e}/status`)}async function wb(s){if((await pI(s)).fsmState!=="Ready")throw new Error("TMA is not ready")}var vb=v(()=>{"use strict";Ge()});var Sb={};z(Sb,{WorkerLocalTma:()=>dp});var $r,lp,up,pp,dp,Eb=v(()=>{"use strict";Ge();op();qn();B();$();_t();cp();we();vb();Ca();$r=C("worker-appium"),lp=class extends Error{},up=class extends Error{},pp=class extends Error{},dp=class extends Dt{constructor(){super(...arguments);this.baseDevicePath=(t,r)=>`${t}/api/devices/${r}`}initPlayer(t){return new Os(this.id,t.runParams,this.options.shouldMonitorPerformance,void 0,t.retryCount,t.previousTestResultId)}async initAndGetAppiumAPI(t){if(t.sessionPlayer.playbackManager.appiumApi)return t.sessionPlayer.playbackManager.appiumApi;let{AppiumApi:r}=Z(),{DOMParser:n}=await import("linkedom"),i=new r(this.sessionData.serverAddress,this.sessionData.sessionId,n,!1);return t.sessionPlayer.playbackManager.appiumApi=i,i}async getBrowserOnce(t,r,n,i){var E;if(Q.onGetSession(this.id,this.testName,t.runMode),!this.options.localTmaUrl||!this.options.deviceUdid)throw new Error("Missing localTmaUrl or deviceUdid");let{localTmaUrl:o,deviceUdid:a,projectData:c}=this.options;await wb(o);let{project:l,authData:{token:d=""}={}}=this.options,{driver:m}=n,u=c.type,f=this.options.appId;if(f){let{mobileApp:k}=await St.getMobileAppDataByAppId({appId:f,projectId:l,token:d});t.nativeApp=k}let h=u==="android"?t.androidActivityWait:null,g=t.nativeAppMetadata,y=t.downloadableAppPublicLink,T=t.appPackageNameOrBundleId;if(!g)throw new Error("Application not specified. Please provide the required application for execution and try again.");if(!T)throw new Error("The application appears to be corrupted. Please ensure the application is in a valid state before running the test.");let[{appInstalled:w,version:b},S]=await Promise.all([this.getAppStateFromDevice(o,a,T),Tb(o,a)]).catch(k=>{throw this.handleDeviceNotFoundError(k),k});if($r.info("device status and app state",{deviceStatus:S,appInstalled:w,version:b,executionId:this.executionId,testResultId:this.testResultId}),!w&&t.isAppFromDevice&&!f)throw new Error("The application is not installed on the target device. Please ensure the application is installed and try again.");!w&&y&&(await this.installApp(o,a,y),$r.info("Application installed successfully",{deviceUdid:a,executionId:this.executionId,testResultId:this.testResultId}));try{let k={testName:this.testName,executionId:this.executionId,testResultId:this.testResultId,project:`${(E=this.options.projectData)==null?void 0:E.name}-${this.options.project}`},D=pb({projectType:u,nativeAppMetadata:g,appPath:y,androidActivityWait:h,sessionTags:k,gridInfo:i,options:this.options,testRunConfig:this.testRunConfig}),G={capabilities:{udid:a,...D}};$r.info("requesting new appium session from TMA",{tmaSessionSettings:G,executionId:this.executionId,testResultId:this.testResultId});let x=await this.requestNewAppiumSessionFromTma(o,G,g);this.sessionData=x;let R=await m.attach({sessionId:x.sessionId,capabilities:D,options:{capabilities:D}});this.device=await St.updateTmaDeviceDetails(a,this.options,t),$r.info(`init new appium session with local TMA testName: ${this.testName}`,{sessionId:R.sessionId,testResultId:this.testResultId,nativeAppMetadata:g,sessionCaps:R.capabilities})}catch(k){throw $r.error("failed to start application",{err:k}),k}}async requestNewAppiumSessionFromTma(t,r,n){var i,o;try{let a=await Ve({url:`${t}/api/session`,headers:{"Content-Type":"application/json"},body:r,timeout:6e4}),c={name:n.name,version:n.version};return{...a,appInfo:c,env:"local-tma"}}catch(a){this.handleDeviceNotFoundError(a);let c=(o=(i=a.response)==null?void 0:i.body)==null?void 0:o.message;throw a.status===500&&typeof c=="string"&&c.startsWith("Failed to create driver session")?new pp(c):a}}async getAppStateFromDevice(t,r,n){let i=this.options.projectData.type==="ios"?"bundles":"apps",o=`${this.baseDevicePath(t,r)}/${i}`,c=(await Te(o)).find(l=>"id"in l?l.id===n:l.packageName===n);return c?{appInstalled:!0,version:c.version}:{appInstalled:!1,version:""}}async installApp(t,r,n){var i,o;try{let a=await Bt(n);await Js(`${this.baseDevicePath(t,r)}/apps`,{},{file:{buffer:a.body,fileName:"app"}})}catch(a){this.handleDeviceNotFoundError(a);let c=(o=(i=a.response)==null?void 0:i.body)==null?void 0:o.message,l="Failed to install app";throw c&&(l=`${l}: ${c}`),new up(l,{cause:a})}}handleDeviceNotFoundError(t){var n,i;let r=(i=(n=t.response)==null?void 0:n.body)==null?void 0:i.message;if(t.status===404&&typeof r=="string"&&(r!=null&&r.startsWith("Ensure that the requested device")))throw new lp(`Device Unavailable: Please ensure that the specified device ${this.options.deviceUdid} is currently connected`)}async runTestOnce(t,r){let{manifestVersion:n,localAssetService:i}=Z(),{sessionPlayer:o}=r,a=n||"runner";Q.onWaitToTestComplete(this.id),o.playbackManager.executionId=t.executionId,o.playbackManager.executionName=t.executionName,o.playbackManager.appiumSessionData={...this.sessionData,device:this.device,nativeApp:t.nativeApp},await this.initAndGetAppiumAPI(r),i.initialize({serverUrl:this.options.localRCASaver});let c=async()=>{try{let l=await new Promise((m,u)=>{o.playByTestId({testId:this.testId,executionId:this.executionId,resultId:this.testResultId,baseUrl:this.baseUrl,userData:this.userData,version:a,resolve:m,isLocalRun:!1,overrideTestConfigId:this.overrideTestConfigId,branch:this.branch,remoteRunId:t.remoteRunId}).catch(u)});return await i.drain(),l.stepsResults=null,l.resultId=this.testResultId,{...l,...t.seleniumPerfStats.getStats()}}catch(l){throw $r.error("error while running appium tests",{err:l}),l}};try{return await super.runTestOnce(t,r),await c()}catch(l){throw $r.error("failed to run test once",{err:l}),l}}}});var Rb={};z(Rb,{WorkerAppium:()=>mp});var Ib,Wr,mp,xb=v(()=>{"use strict";B();op();Ib=require("linkedom");qn();$();_t();cp();we();Ca();oe();ds();Wr=C("worker-appium"),mp=class extends Dt{initPlayer(t){return new Os(this.id,t.runParams,this.options.shouldMonitorPerformance,void 0,t.retryCount,t.previousTestResultId)}async getBrowserOnce(t,r,n,i){let o=this.options.projectData.type,a=(o==="android"||o==="ios")&&await t.isTestRecordedWithEnhancedMode();if(i.type!==_.TESTIM_TVC&&a)throw Error("The provided test(s) were authored in Enhanced Mode and can run only on VMG!");Q.onGetSession(this.id,this.testName,t.runMode);let{driver:c}=n,l=await St.getAppIdFromGridOrTestimPublicLink({testRunHandler:t,options:this.options,pendingAppUploads:this.executionQueue.pendingAppUploads}),d=o==="android"?t.androidActivityWait:null,m=t.nativeAppMetadata;if(!m)throw new Error("Application not specified. Please provide the required application for execution and try again.");try{let u={testName:this.testName,executionId:this.executionId,executionName:t.executionName,testResultId:this.testResultId,project:`${this.options.projectData.name}-${this.options.project}`,...this.options.customTag&&{customTag:this.options.customTag},testId:this.testId,branch:this.branch,pCloudyIndividual:`${this.executionId}-${this.uniqueId}`},f={projectData:this.options.projectData,projectType:o,nativeAppMetadata:m,appPath:l,androidActivityWait:d,sessionTags:u,gridInfo:i,options:this.options,testRunConfig:this.testRunConfig,shouldRunInEnhancedMode:a},h;this.options.skipLoadBalancer&&this.options.deviceUdid?(this.options.lockDevice&&await St.lockDevice(i,this.options.deviceUdid),h=await ub(f)):h=await lb({...f,shouldRunInEnhancedMode:a}),Wr.info("starting appium session",{testResultId:this.testResultId,executionId:this.executionId,sessionTags:u,nativeAppMetadata:m,capabilities:db(h)}),h.headers={"User-Agent":this.getUserAgentString()};let g=this.getServerAddressFromGrid();this.activeSession=await c.remote(h),this.device=await St.updateDeviceOnRemoteTestResult(t,this.activeSession,g,this.options,a);let y=`${g}/session/${this.activeSession.sessionId}`;this.updateSlotData(y),Wr.info("appium session started successfully",{sessionId:this.activeSession.sessionId,testResultId:this.testResultId,executionId:this.executionId,sessionCaps:this.activeSession.capabilities})}catch(u){throw Wr.error("failed to start application",{testResultId:this.testResultId,executionId:this.executionId,err:u}),u}}startKeepAlive(t){let{errors:r}=Z(),n=async()=>{try{await t.getOrientation()}catch(i){Wr.error("failed to keep appium session alive",{err:i}),r!=null&&r.AppiumSessionTerminatedError&&i instanceof r.AppiumSessionTerminatedError&&this.stopKeepAlive()}};this.keepAliveIndex=setInterval(n,25e3)}stopKeepAlive(){this.keepAliveIndex&&clearTimeout(this.keepAliveIndex)}updateSlotData(t){try{this.options.slotService==="redis"&&qf(this.options.company.companyId,this.options.projectData.projectId,{testResultId:this.testResultId,executionId:this.executionId,type:"execution",source:this.options.source,sessionUrl:t},this.id)}catch(r){Wr.error("failed to update slot data",{err:r})}}getServerAddressFromGrid(){let{host:t,port:r,accessToken:n,type:i}=this.options.gridData;return i===_.TESTIM_HEADSPIN||i===_.TESTIM_TDC?`https://${t}:${r}/v0/${n}/wd/hub`:i===_.P_CLOUDY?`https://${t}/appiumcloud/wd/hub`:`https://${t}:${r}/wd/hub`}getDirectAddressConnection(){let{protocol:t,hostname:r,port:n,path:i}=this.activeSession.options;if(t&&r&&n&&i)return`${t}://${r}:${n}${i}`}async runTestOnce(t,r){var f,h,g;let{manifestVersion:n,AppiumApi:i,localAssetService:o}=Z(),{sessionPlayer:a}=r,c=n||"runner",l=this.options.timeout;Q.onWaitToTestComplete(this.id),a.playbackManager.executionId=t.executionId,a.playbackManager.executionName=t.executionName;let d;if(this.options.skipLoadBalancer){let y=this.options.deviceUdid||((f=this.testRunConfig.mobile)==null?void 0:f.staticAllocation.deviceUdid),{protocol:T,hostname:w,port:b,path:S}=await St.getHeadSpinDeviceConnection(this.options.gridData,y);d=`${T}://${w}:${b}${S}`}else d=this.getDirectAddressConnection()||this.getServerAddressFromGrid();let m=this.activeSession.capabilities;a.playbackManager.appiumSessionData={env:"remote",capabilities:m,sessionId:this.activeSession.sessionId,sessionToken:this.options.gridData.accessToken,gridType:this.options.gridData.type,projectType:this.options.projectData.type,gridId:this.options.gridData.gridId,companyId:(h=this.options.company)==null?void 0:h.companyId,device:this.device,nativeApp:t.nativeApp},a.playbackManager.appiumApi=new i(d,this.activeSession.sessionId,Ib.DOMParser,((g=this.device)==null?void 0:g.domMode)==="enhanced"),this.startKeepAlive(a.playbackManager.appiumApi),o.initialize({serverUrl:this.options.localRCASaver});let u=async()=>{try{let y=await new Promise((w,b)=>{a.playByTestId({testId:this.testId,executionId:this.executionId,resultId:this.testResultId,baseUrl:this.baseUrl,userData:this.userData,version:c,resolve:w,isLocalRun:!1,overrideTestConfigId:this.overrideTestConfigId,branch:this.branch,remoteRunId:t.remoteRunId}).catch(b)});return this.stopKeepAlive(),await o.drain(),y.stepsResults=null,y.resultId=this.testResultId,{...y,...t.seleniumPerfStats.getStats()}}catch(y){throw Wr.error("error while running appium tests",{testResultId:this.testResultId,executionId:this.executionId,err:y}),this.stopKeepAlive(),y}};try{return await super.runTestOnce(t,r),await pe(u(),l)}catch(y){throw Wr.error("failed to run test once",{err:y}),y}}getUserAgentString(){return"Testim/CI-Branch:runner-v4.157.0"}}});var Ma,Ab=v(()=>{"use strict";B();Un();X();Ma=class{constructor(e){this.id=e;this.driver=new _r}async onDone(){try{await pe(this.driver.end(),12e4)}catch(t){t instanceof ce&&await this.driver.forceEnd().catch(()=>null)}this.driver=null}getSessionId(){return this.driver.getSessionId()}}});async function Cb(){let s=await Promise.any(dI.map(async e=>{try{return await Te(e)}catch{return null}}));return s==null?void 0:s.ip}var dI,Ua,Fa=v(()=>{"use strict";Ge();dI=["https://api.ipify.org?format=json","https://ipinfo.io/json","https://api.my-ip.io/ip.json"];Ua=({timeout:s})=>({timeout:s,...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}})});var Pb,Ba,kb=v(()=>{"use strict";Pb=I(require("ws"));B();Fa();Ba=class{constructor(){this._cdpWs=null;this._cdpUrl=null;this._cdpCallbacks=new Map}async initSession(e,t=500){await this.stopSession(),this._cdpUrl=e,await this.initCDPWebsocket(t)}async initCDPWebsocket(e=500){if(this._cdpWs)return this._cdpWs;let t=Ua({timeout:e}),r=new Pb.default(this._cdpUrl,t),n=Jt(o=>{r.once("open",o)}),i=Jt(o=>{r.once("error",o)}).catch(()=>{r.close(),r.removeAllListeners()});return r.on("message",o=>this.onCDPMessage(o)),this._cdpWs=Promise.race([n,i]).then(()=>r),this._cdpWs}onCDPMessage(e){var n;let t=JSON.parse(e),r=this._cdpCallbacks.get(t.id);r&&(this._cdpCallbacks.delete(t.id),t.error?r.reject(new Error(t.error)):(n=t.result.exceptionDetails)!=null&&n.exception?r.reject(new Error(t.result.exceptionDetails.exception.description)):r.resolve(t.result))}async stopSession(){let e=this._cdpWs;if(this._cdpUrl=null,this._cdpWs=null,this._cdpCallbacks.clear(),e)try{return(await e).close()}catch{return}}async cdpCommand(e,t,r){let n=await this.initCDPWebsocket();this._lastWsId||=0;let i=this._lastWsId++,o=new Promise((c,l)=>{this._cdpCallbacks.set(i,{resolve:c,reject:l})}),a={method:e,params:t,id:i};return r&&Object.assign(a,{sessionId:r}),n.send(JSON.stringify(a)),o}}});var $a,fp,ja,Ob=v(()=>{"use strict";B();$a=I(require("chrome-launcher"));Oo();kb();An();fp=class{constructor(e){this.sessionId=e;this._isAlive=!1;this.cdpTestRunner=new Ba}async init(e){var h,g,y,T;let{browserOptions:t,testName:r,testRunConfig:n,gridInfo:i,customExtensionLocalLocation:o,executionId:a,testResultId:c,printFinalCaps:l,mode:d}=e,m=ko({browserOptions:t,testName:r,testRunConfig:n,gridInfo:i,customExtensionLocalLocation:o,executionId:a,testResultId:c,printFinalCaps:l,mode:d}),u=[...((h=m.desiredCapabilities)==null?void 0:h.chromeOptions.args)??[],...((T=(y=(g=m.capabilities)==null?void 0:g.alwaysMatch)==null?void 0:y["goog:chromeOptions"])==null?void 0:T.args)??[],...$a.Launcher.defaultFlags().filter(w=>w!=="--disable-extensions")];this.chrome=await $a.launch({chromeFlags:u,startingUrl:void 0,ignoreDefaultFlags:!0}),this.chrome.process.once("exit",()=>{this._isAlive=!1}),this.chrome.process.once("close",()=>{this._isAlive=!1}),this._isAlive=!0;let f=await br(`localhost:${this.chrome.port}`);await this.cdpTestRunner.initSession(f),ms(()=>this.chrome.kill())}isAlive(){return this._isAlive}start(){}async stop(){await this.cdpTestRunner.stopSession(),this.chrome&&await this.chrome.kill(),this._isAlive=!1}getSessionId(){return this.sessionId}},ja=class{constructor(e){this.id=e;this.sessionId=re();this.driver=new fp(this.sessionId)}async onDone(){return this.driver.stop()}getSessionId(){return this.sessionId}}});var gp={};z(gp,{WorkerExtension:()=>si});function mI(s){return s instanceof Error&&"type"in s&&typeof s.type=="string"}function _b(s){return mI(s)?s:new Error(s)}var mt,si,Wa=v(()=>{"use strict";$e();X();qn();B();$();_t();oe();Ab();Ob();ct();mt=C("worker-ext"),si=class extends Dt{initPlayer(){return this.options.useChromeLauncher?new ja(this.id):new Ma(this.id)}async _getBrowserOnce(e,t,r,n){var o;let{driver:i}=r;try{return await i.init({projectData:this.options.projectData,overrideConfiguration:e.overrideTestConfig,browserOptions:this.options,testId:e.testId,testName:this.testName,testRunConfig:this.testRunConfig,gridInfo:n,customExtensionLocalLocation:t,executionId:this.executionId,executionName:e.executionName,testResultId:this.testResultId,seleniumPerfStats:e.seleniumPerfStats,fastInit:(o=this.options.lightweightMode)==null?void 0:o.general,lambdatestService:this.lambdatestService,printFinalCaps:this.options.printFinalCaps,mode:K.EXTENSION})}catch(a){throw mt.error("failed to get browser",{err:a,gridInfo:n,whitelistedPublicIp:Qi(),initializedFromCache:Zi(),testId:e.testId,resultId:e.testResultId,publicIps:this.options.publicIps}),a}}async getBrowserOnce(e,t,r,n){return Q.onGetSession(this.id,this.testName,e.runMode),this._getBrowserOnce(e,t,r,n)}isUsingChromeLauncher(e){return Boolean(this.options.useChromeLauncher)}async updateTestStatusOnGrid(e,t,r){var i;let n=t?"passed":"failed";if(this.lambdatestService.isLambdatestRun()&&await e.executeJS(`lambda-status=${n}`),"browserstack"in this.options&&((i=this.options.browserstack)!=null&&i["browserstack.user"])){let o={action:"setSessionStatus",arguments:{status:n,reason:r}};await e.execute(`browserstack_executor: ${JSON.stringify(o)}`)}}async runTestOnce(e,t){let{testResultId:r,executionId:n,testId:i}=this;U("WorkerExtension runTestOnce");let o=async d=>{let m=this.options.timeoutWasGiven?Math.max(1e4,this.options.timeout):this.options.testStartTimeout;try{return await pe(e.runTestUsingCDP(d.cdpTestRunner),m,Ue.TEST_START_TIMEOUT_MSG)}catch(u){if(!(u instanceof ce))throw u;return mt.warn("timeout while running test using CDP. Running checkViaRestAPIIfTestStarted",{testResultId:r}),await e.checkViaRestAPIIfTestStarted()}},a=async(d,m,u)=>{try{let f=await d.url(m);return u.driverUrlFinished=!0,f}catch(f){throw mt.error("error from driver.url",{err:f,testResultId:r,executionId:n,testId:i,url:m,urlLength:m.length}),f}},c=async d=>{let m=await e.onStarted(this.options.testStartTimeout);return d.testRunHandlerOnStartedHadFinished=!0,m},l=async()=>{var f;if(U("WorkerExtension runExtTest"),((f=this.options.lightweightMode)==null?void 0:f.disableRemoteStep)||this.options.disableSockets||e.listenToRemoteStep(t.driver),this.isUsingChromeLauncher(t)){Q.onWaitToTestStart(this.id),Q.onWaitToTestComplete(this.id);try{return{...await o(t.driver),...e.seleniumPerfStats.getStats()}}catch(h){throw mt.warn("failed to run test via CDP",{err:h}),h}}let{driver:m}=t,u={driverUrlFinished:!1,testRunHandlerOnStartedHadFinished:!1};try{let h=await e.getRunTestUrl();Q.onWaitToTestStart(this.id);try{await pe(Promise.all([a(t.driver,h,u),c(u)]),this.options.testStartTimeout,Ue.TEST_START_TIMEOUT_MSG)}catch(T){if(!(T instanceof ce))throw T;mt.warn("timeout occurred (see log's payload). Running checkViaRestAPIIfTestStarted",{testResultId:r,executionId:n,testId:i,...u}),await e.checkViaRestAPIIfTestStarted()}Q.onWaitToTestComplete(this.id);let g=new AbortController,y=T=>{e.onCompletedCleanup(),mt.warn("on browser closed error detected",{err:T,testResultId:r,executionId:n,testId:i}),m.unregisterToClosedBrowser(y),T.type=Qs.BROWSER_CLOSED,g.abort(T)};m.registerToClosedBrowser(y);try{let T=pe(e.onCompleted(),this.testRunTimeout,Ue.TEST_COMPLETE_TIMEOUT_MSG),w=await Ic(T,g.signal);m.unregisterToClosedBrowser(y);try{await this.updateTestStatusOnGrid(m,Boolean(w.success),w.reason)}catch(E){mt.error("Could not update the grid about the test status",{err:E})}m.isAlive()||(mt.warn(`possible grid unresponsive for test ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),w.gridIssues="could not validate grid is alive");let b=m.maxKeepAliveGap();return b>=3e4&&(mt.warn(`possible browser keep alive issue ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),w.keepAliveIssue=b),{...w,...e.seleniumPerfStats.getStats()}}catch(T){throw mt.warn("timeout wait until test completed",{err:T,testResultId:r,executionId:n,testId:i}),_b(T)}finally{m.unregisterToClosedBrowser(y)}}catch(h){throw mt.warn("failed to start url",{err:h}),_b(h)}};t.driver.start();try{return await super.runTestOnce(e,t),U("WorkerExtension super.runTestOnce"),await l()}catch(d){throw mt.error("failed to run test",{err:d,testId:e.testId,resultId:e.testResultId}),d}}}});var yp={};z(yp,{WorkerExtensionSingleBrowser:()=>hp});var fI,gI,hp,bp=v(()=>{"use strict";$e();B();$();Nu();_t();Wa();fI=C("base-worker"),gI=500,hp=class extends si{async _releasePlayer(){if(!this.testPlayer)return;let{projectId:t}=this.userData||{};await Gn(this.id,this.releaseSlotOnTestFinished,t,this.options.company.companyId,this.options.slotService,this.testPlayer),this.testPlayer=null}onQueueCompleted(){return this._releasePlayer()}async getBrowserOnce(t,r,n,i){return Q.onGetSession(this.id,`worker ${this.id}`,t.runMode),this._getBrowserOnce(t,r,n,i)}async getTestPlayer(t,r){return this.testPlayer&&!this.testPlayer.driver.isAlive()&&(fI.warn("WorkerExtensionSingleBrowser is releasing a dead player",{workerId:this.id}),await this._releasePlayer()),this.testPlayer||(this.testPlayer=await super.getTestPlayer(t,r)),this.testPlayer}async runTest(t,r,n){let i=this.handleQuarantine(t);if(i)return i;U("before runTest onTestStarted single browser");let o=await this.onTestStarted(this.id,t.testId,t.testResultId,n,t.retryKey);t.baseUrl=o.config.baseUrl;let a=await this.getTestPlayer(t,r);return t.markClearBrowser(),await this.runTestOnce(t,a)}async runTestCleanup(){var t;if(!this.executionQueue.hasMoreTests()){await this.onQueueCompleted();return}(t=this.options.lightweightMode)!=null&&t.general&&await ue(gI)}}});var Tp,Va,Lb=v(()=>{"use strict";Un();ae();$e();xl();ct();hu();X();$();oe();Rh();Wo();Tp=C("worker-manager"),Va=class{constructor(e){this.customExtensionLocalLocation=e;this.workerIdCount=0;this.parallelCount=0;this.workers=new Map;this.combinedTestResults={};this.workerUniqueIds=[];this.onWorkerFinished=async(e,...t)=>{this.workers.has(e)&&(this.workers.delete(e),this.executionQueue.hasMoreTests()&&this.workers.size<this.parallelCount&&this.runWorker(...t))};this.runWorker=async(...e)=>{let t=++this.workerIdCount;this.workers.set(t,null);let r=this.executionQueue.getNext();if(!r){this.workers.delete(t);return}let n=this.workerUniqueIds[t%this.parallelCount],i=await this.createWorker(r.runConfig.browserValue,...e);this.workers.set(t,i),i.id=t,i.uniqueId=n,i.run(r,this.onWorkerFinished,...e)}}async getWorkerType({mode:e,localTmaUrl:t},r){if(e)switch(e){case K.SELENIUM:return(await Promise.resolve().then(()=>(tp(),ep))).WorkerSelenium;case K.APPIUM:return t?(await Promise.resolve().then(()=>(Eb(),Sb))).WorkerLocalTma:(await Promise.resolve().then(()=>(xb(),Rb))).WorkerAppium;default:return Fn.isFeatureAvailableForProject("useSameBrowserForMultiTests")?(await Promise.resolve().then(()=>(bp(),yp))).WorkerExtensionSingleBrowser:(await Promise.resolve().then(()=>(Wa(),gp))).WorkerExtension}else switch(r){case(Mr.find(n=>n===r)&&Fn.isFeatureAvailableForProject("useSameBrowserForMultiTests")):return(await Promise.resolve().then(()=>(bp(),yp))).WorkerExtensionSingleBrowser;case Mr.find(n=>n===r):return(await Promise.resolve().then(()=>(Wa(),gp))).WorkerExtension;case Vn.find(n=>n===r):return(await Promise.resolve().then(()=>(tp(),ep))).WorkerSelenium;default:throw new A(`browser ${r} is not supported`)}}async createWorker(e,...t){let r=t[0],n=await this.getWorkerType({mode:r.mode,localTmaUrl:r.localTmaUrl},e);try{return U("before new Worker",r.mode),new n(this.executionQueue,...t)}finally{U("after new Worker",r.mode)}}async runTests(e,t,r,n,i,o,a,c){if(e&&e.length===0)return;let l=!1,d=0,m=(u,f)=>new Promise(h=>{var ie,Ee,Et,Gr,P,N,j,J;let g=i.project,y=e.length;this.parallelCount=a,this.workerUniqueIds=this.generateUniqueIds(this.parallelCount),this.executionQueue=new $o(r,n,e,i,o,t),this.combinedTestResults={};let T=((ie=i.company)==null?void 0:ie.ucid)||"",w=(Ee=i.company)==null?void 0:Ee.companyId,b=(Et=i.company)==null?void 0:Et.name,S=i.source||"cli",E=i.user,k=(Gr=i.company)==null?void 0:Gr.planType,D=(P=i.company)==null?void 0:P.isStartUp,G=(N=i.projectData)==null?void 0:N.name,x=(j=i.projectData)==null?void 0:j.type,R=i.lightweightMode,L=(J=i.gridData)==null?void 0:J.type,M=(Oe,It,ve,ac,ci,cc)=>(d++,kf({executionId:r,projectId:g,testId:It,resultId:ve,ucid:T,companyId:w,companyName:b,projectName:G,companyPlan:k,source:S,user:E,lightweightMode:R,isStartUp:D,projectType:x,appSource:cc,gridType:L}),t.testStartAndReport(Oe,r,ve,ac,ci)),V=async(Oe,It,ve,ac,ci,cc)=>{var fd,gd,hd;d--;let et={...(R==null?void 0:R.onlyTestIdsNoSuite)&&{show:!0},...ve.seleniumStats&&{seleniumStats:ve.seleniumStats},...ve.gridIssues&&{gridIssues:ve.gridIssues},...ve.keepAliveIssue&&{keepAliveIssue:ve.keepAliveIssue},...i.host&&{gridHost:i.host}};if(ve.seleniumPerfMarks&&(t.concatSeleniumPerfMarks(ve.seleniumPerfMarks),delete ve.seleniumPerfMarks),i.grid||i.gridId?(et.gridName=i.grid||((fd=i.gridData)==null?void 0:fd.name),et.gridType=(gd=i.gridData)==null?void 0:gd.type,et.gridProvider=(hd=i.gridData)==null?void 0:hd.provider):i.localTmaUrl?(et.gridName="local-tma-from-options",et.gridType="local-tma"):i.useLocalChromeDriver?(et.gridName="local-chrome-driver-from-options",et.gridType="local-chrome"):i.useChromeLauncher?(et.gridName="chrome-launcher-from-options",et.gridType="local-chrome"):i.browserstack?et.gridName="browserstack-from-options":i.saucelabs&&(et.gridName="saucelabs-from-options"),await t.testEndAndReport(Oe,ve,r,ac,ci,et).catch(KT=>Tp.error("testEndAndReport threw an error",{err:KT})),ci)return;this.combinedTestResults[ve.resultId]=ve,Of({executionId:r,projectId:g,testId:It,resultId:ve.resultId,result:ve,ucid:T,companyId:w,companyName:b,projectName:G,companyPlan:k,source:S,user:E,lightweightMode:R,logger:Tp,isStartUp:D,projectType:x,appSource:cc}),c&&!ve.success&&(this.executionQueue.stop(),l=!0),(Object.keys(this.combinedTestResults).length===y||l&&d===0)&&h(this.combinedTestResults)},W=(Oe,It)=>{this.combinedTestResults[It.resultId]=It,t.onTestIgnored(Oe,It.resultId),d--,(Object.keys(this.combinedTestResults).length===y||l&&d===0)&&h(this.combinedTestResults)},q=(Oe,It)=>t.onGridSlot(Oe,It);for(i.userData={loginData:{...Er(),refreshToken:Yi(),authData:Er(),token:u,userAccessKey:f},projectId:i.project,company:i.company,servicesUrl:he()},U("in localStrategy before createWorker");this.workers.size<this.parallelCount&&this.executionQueue.hasMoreTests();)this.runWorker(i,this.customExtensionLocalLocation,r,M,V,q,W)});try{let u=await kt(),f=await Xi(),h=await m(u,f);if(this.workers.size>0&&this.workers.clear(),l)throw new zt;return h}catch(u){throw Tp.error("failed running parallel workers",{executionId:r,err:u}),u}}generateUniqueIds(e){return Array.from({length:e},(t,r)=>`worker-${r+1}`)}}});var wp,le,Db=v(()=>{"use strict";wp=class{static colorString(e,t){return`${e}${t}${wp.Reset}`}},le=wp;le.Reset="\x1B[0m",le.Bright="\x1B[1m",le.Dim="\x1B[2m",le.Underscore="\x1B[4m",le.Blink="\x1B[5m",le.Reverse="\x1B[7m",le.Hidden="\x1B[8m",le.FgBlack="\x1B[30m",le.FgRed="\x1B[31m",le.FgGreen="\x1B[32m",le.FgYellow="\x1B[33m",le.FgBlue="\x1B[34m",le.FgMagenta="\x1B[35m",le.FgCyan="\x1B[36m",le.FgWhite="\x1B[37m",le.FgGray="\x1B[90m",le.BgBlack="\x1B[40m",le.BgRed="\x1B[41m",le.BgGreen="\x1B[42m",le.BgYellow="\x1B[43m",le.BgBlue="\x1B[44m",le.BgMagenta="\x1B[45m",le.BgCyan="\x1B[46m",le.BgWhite="\x1B[47m",le.BgGray="\x1B[100m"});var ni,Nb,Ga,vp,Sp,Vr,Ep=v(()=>{"use strict";ni=I(require("lodash"));B();$();ae();oe();$e();as();Rl();xl();ge();de();_t();yg();X();Lb();Wo();Nb=require("uuid");Db();({CLI_MODE:Ga}=jt),vp=C("test-plan-runner"),Sp=class{constructor(e){this.customExtensionLocalLocation=e;this.startTime=Date.now()}static get id(){return Sp._id}async runTestAllPhases(e,t,r,n,i,o,a,c){let l={},d=new Va(this.customExtensionLocalLocation),m=async()=>{let g=i.beforeParallel||1,y=!0,T=await d.runTests(e,c,o,a,i,n,g,y);Object.assign(l,T)},u=async()=>{let g=wi||i.parallel,y=!1;U("right before this.workerManager.runTests");let T=await d.runTests(t,c,o,a,i,n,g,y);U("right after this.workerManager.runTests"),Object.assign(l,T)},f=async()=>{let g=i.afterParallel||1,y=!1,T=await d.runTests(r,c,o,a,i,n,g,y);Object.assign(l,T)};_f({executionId:o,projectId:i.project}),U("right before runBeforeTests");try{return await m(),U("right before runTestPlanTests"),await u(),U("right after runTestPlanTests"),await f(),l}catch(g){if(vp.error("error running test plan",{err:g}),g instanceof zt)return c.markAllQueuedTests(o,fe.ABORTED,"aborted",!1);throw g}finally{await h()}async function h(){var y,T,w,b;if((y=i.lightweightMode)!=null&&y.disablePixelValidation)return;if(i.mode===Ga.SELENIUM){let[{getSessionPlayer:S},{makeSDK:E}]=await Promise.all([Promise.resolve().then(()=>(we(),rr)),import("@applitools/eyes-sdk-core")]),{EyeSdkBuilder:k}=S();await k.closeBatch(o,E);return}let g;try{if(!((b=(w=(T=i.company)==null?void 0:T.activePlan)==null?void 0:w.premiumFeatures)!=null&&b.applitools)||(g=await Ap(i.project),ni.default.isEmpty(g)||!o))return;let{runKey:S,url:E}=g;await require("@applitools/eyes-sdk-core").makeSDK({name:"Testim.io",version:"4.0.0",spec:{}}).closeBatches({settings:{batchIds:[o],serverUrl:E,apiKey:S}})}catch{}}}async runTestPlan(e,t,r,n,i,o,a,c){var b,S,E;let l=re(),d=n.project;Xd(l),e.forEach(k=>Object.assign(k,{isBeforeTestPlan:!0})),r.forEach(k=>Object.assign(k,{isAfterTestPlan:!0}));let m=[...e,...t,...r],u=new So(m,n,o,a),f=ni.default.chain(m).map(k=>{var D;return((D=k.overrideTestConfig)==null?void 0:D.name)||""}).uniq().compact().value(),h=(f==null?void 0:f.length)===1?f[0]:null,g=(b=n.lightweightMode)!=null&&b.onlyTestIdsNoSuite?[]:m.map(k=>k.name),y=(S=n.lightweightMode)!=null&&S.onlyTestIdsNoSuite?{beforeTests:e,tests:t,afterTests:r}:u.executionStart(l,d,this.startTime,i,g);U("before testListInfoPromise");let T=await y;(E=n.lightweightMode)!=null&&E.onlyTestIdsNoSuite||Q.onTestPlanStarted(T.beforeTests,T.tests,T.afterTests,i,l,c,h),U("before runTestAllPhases");let w=await this.runTestAllPhases(T.beforeTests,T.tests,T.afterTests,a,n,l,i||"All Tests",u);return U("before executionEnd"),await u.executionEnd(l),U("after executionEnd"),{results:w,executionId:l,testPlanName:i,configName:h}}isJsonString(e){try{JSON.parse(e)}catch{return!1}return!0}handleReportFailure(e,t){try{e.text?t=e.text:t=JSON.stringify(e)}catch{}console.error(le.colorString(le.FgMagenta,t)),process.exit(-1)}async reportTestRunnerStarted(e,t){try{return await Ip(e,t.testOptimization)}catch(r){return this.handleReportFailure(r,"Failed Report: Test Runner Started")}}async reportTestRunnerFinished(e){try{return await Rp(e)}catch(t){return this.handleReportFailure(t,"Failed Report: Test Runner Finished")}}async runTestPlans(e,t){vp.info("start to run test plan",{options:{...e,token:void 0,userParamsData:void 0},branchToUse:t});function r(d){return ni.default.flattenDeep(Object.values(d)).reduce((m,u)=>m.concat(u.beforeTests,u.tests,u.afterTests),[])}let n={},i={},o=e.project,a={testPlans:[],testPlansData:{}};O.flags.enableTestPlanAggregation.isEnabled()?(await se(e.testPlanIds,async d=>{let m=await ii(o,e.testPlan,[d],t,e.intersections);m.testPlans.forEach(u=>{a.testPlans.push(u);let f=u._id;a.testPlansData[f]=m.testPlansData[f]})}),await se(e.testPlan,async d=>{let m=await ii(o,[d],e.testPlanIds,t,e.intersections);m.testPlans.forEach(u=>{a.testPlans.push(u);let f=u._id;a.testPlansData[f]=m.testPlansData[f]})})):a=await ii(o,e.testPlan,e.testPlanIds,t,e.intersections);let c=a.testPlans,l=a.testPlansData;if(!c||c.length===0)throw new A(`no test plan to run ${e.testPlan}`);if(!l||Object.keys(l).length===0){if(e.passZeroTests)return[];throw new A(`no test to run in test plan ${e.testPlan}`)}return e.mode!==Ga.APPIUM&&await Lu(e,r(l)),await se(c,async d=>{var h;let m=d.testPlanId;n[m]={};let u={...e};u.baseUrl||=d.startUrl,u.appId||=((h=d.mobileApp)==null?void 0:h.appId)||void 0,u.gridId||=d.gridId,e.grid&&delete u.gridId,u.gridData=await yf(e,d);let f=u.overrideExecutionName||d.name;return await se(l[m],async g=>{let y=await this.runTestPlan(g.beforeTests,g.tests,g.afterTests,u,f,m,t);Q.onTestPlanFinished(y.results,d.name,this.startTime,y.executionId,!1),n[m][y.executionId]=y.results;let T=Object.keys(n[m]).map(E=>({executionId:E,status:_u(n[m][E])})),w=Object.keys(n[m]).map(E=>n[m][E]).reduce((E,k)=>Object.assign(E,k),{}),b=_u(w);Object.assign(i,w);let S=b?T[0].executionId:T.find(E=>!E.status).executionId;return await xp(o,m,{success:b,executions:T,executionId:S}),y})})}async runAnonymousTestPlan(e,t){var c;vp.info("start to run anonymous",{options:{...e,token:void 0},branchToUse:t}),U("before getSuite");let r=await Ah(e,t);if(U("after getSuite"),!((c=r==null?void 0:r.tests[0])!=null&&c.length)){if(e.rerunFailedByRunId)throw new A("No failed tests found in the provided run");if(e.passZeroTests)return[];throw new A("No tests to run")}t="branch"in r&&r.branch||t;let n=r;if(e.rerunFailedByRunId&&!n.runName){if(!n.runExists)throw new A("Invalid run ID - no such run.");n.runName===""&&(n.runName=`rerun-${e.rerunFailedByRunId}`)}let i=e.overrideExecutionName||n.runName||[].concat(e.label,e.name,e.suites).join(" "),o=!0;U("Right before validateConfig + runAnonymousTestPlan tests map");let a;return e.appId&&e.mode===Ga.APPIUM&&(a=await ti({appId:e.appId,projectId:e.project})),await se(r.tests,async l=>{if(a&&l.forEach(m=>{"nativeApp"in m&&(m.nativeApp=a)}),e.resultId){let m=l[0];m.resultId=e.resultId,l=[m]}e.mode!==Ga.APPIUM&&await Lu(e,l),U("right before runTestPlan");let d=await this.runTestPlan([],l,[],e,i,null,t,o);return U("right after runTestPlan"),await Q.onTestPlanFinished(d.results,i,this.startTime,d.executionId,o),d})}async run(e){let t=wn(),r=[];await this.reportTestRunnerStarted(e.project,e),en(e)?r=await this.runTestPlans(e,t):r=await this.runAnonymousTestPlan(e,t),await this.reportTestRunnerFinished(e.project);let n=ni.default.flattenDeep(r);return U("right before onAllTestPlansFinished"),await Q.onAllTestPlansFinished(n),U("right after onAllTestPlansFinished"),n.map(i=>i.results).reduce((i,o)=>Object.assign(i,o),{})}},Vr=Sp;Vr._id=(0,Nb.v4)()});var Ae={};z(Ae,{addTestRetry:()=>nu,clearTestResult:()=>ku,deleteCloudflareTunnel:()=>Np,fetchLambdatestConfig:()=>ou,fixGridAppIDStructure:()=>np,forceUpdateCloudflareTunnelRoutes:()=>Dp,getAllGrids:()=>Il,getAppDetails:()=>ti,getApplitoolsIntegrationData:()=>Ap,getBrowserStackSessionMetaData:()=>RI,getCloudflareTunnel:()=>Lp,getEditorUrl:()=>SI,getGridSlot:()=>El,getHybridGridProvider:()=>Sl,getLabFeaturesByProjectId:()=>yu,getMobileDevicesFromGrid:()=>ri,getRealData:()=>Xl,getS3Artifact:()=>kn,getS3ArtifactText:()=>Yl,getSuiteTestList:()=>Du,getTestPlan:()=>vI,getTestPlanTestList:()=>ii,getTestResults:()=>Nr,getUsageForCurrentBillingPeriod:()=>Op,initializeUserWithAuth:()=>_p,isTestResultCompleted:()=>Pu,keepAliveCompanySlots:()=>Kl,keepAliveGrid:()=>wl,loadSfdcCredential:()=>kp,loadTest:()=>$n,releaseCompanySlot:()=>ql,releaseGridSlot:()=>vl,reportExecutionFinished:()=>Eo,reportExecutionStarted:()=>su,reportRunnerFinished:()=>Rp,reportRunnerStarted:()=>Ip,requestCompanySlot:()=>Hl,saveRemoteStep:()=>Tu,saveTestPlanResult:()=>xp,updateCompanySlot:()=>zl,updateExecutionTests:()=>ru,updateRemoteRunFailure:()=>Mp,updateTestDataArtifact:()=>Io,updateTestResult:()=>qo,updateTestStatus:()=>Pr,uploadAppToGrid:()=>sp,uploadRunDataArtifact:()=>Ou,validateUserAccessKey:()=>bl});async function _s(){let s=await kt();if(!s)throw new Error("Failed to get token from server");return{[$c]:Vr.id,Authorization:`Bearer ${s}`}}async function Re({url:s,body:e,headers:t={},timeout:r,retry:n}){let i=await _s(),o={...t,...i};return Ve({url:`${he()}${s||""}`,body:e,headers:o,timeout:r,retry:n})}async function TI(s,e,t,r={},n=void 0){let i=await _s(),o={...r,...i};return await Js(`${he()}${s||""}`,e,t,o,n)}async function oi(s,e){let t=await _s();return await Pc(`${he()}${s||""}`,e,t)}async function Ub(s,e){let t=await _s();return await Ks(`${he()}${s||""}`,e,t)}async function wI(s,e){let t=await _s();return await Ys(`${he()}${s||""}`,e||void 0,t)}async function Pe(s,e,t,r){let n=await _s();return await Te(`${he()}${s||""}`,e||void 0,n,r,t)}function kn(s,e){return(0,ee.default)(()=>Pe(`/storage${s}`,null,{isBinary:!0},e),{retries:te,factor:1})}function Yl(s){return(0,ee.default)(()=>wI(`/storage${s}`))}async function Ip(s,e){return await Re({url:"/test-runner",body:{projectId:s,testOptimization:e}})}async function Rp(s){return await Ub("/test-runner",{projectId:s})}async function vI(s,e){let t=n=>n===null?[]:typeof n=="string"&&JSON.parse(n)||n;return(await(0,ee.default)(()=>Pe("/testPlan",{projectId:s,name:e.join(",")}),{retries:te,factor:1})).map(({testConfigIds:n,beforeAllLabels:i,testLabels:o,afterAllLabels:a,...c})=>Object.assign(c,{testConfigIds:t(n),beforeAllLabels:t(i),testLabels:t(o),afterAllLabels:t(a)}))}async function kp({branch:s,projectId:e}){let t=await(0,ee.default)(()=>Pe(`/branch/branchData/${encodeURIComponent(s)}`,{projectId:e}),{retries:te,factor:1});return t==null?void 0:t.sfdcCredential}function $n({testId:s,branch:e,projectId:t,skipSharedSteps:r=!1,useBranchMap:n=!0}){return(0,ee.default)(()=>Pe(`/test/${s}`,{projectId:t,branch:e,skipSharedSteps:r,useBranchMap:n}),{retries:te,factor:1})}function xp(s,e,t){return(0,ee.default)(()=>Re({url:"/testPlan/result",body:{projectId:s,testPlanId:e,result:t}}),{retries:te,factor:1})}function Pr(s,e,t,r,n,i,o=te){return(0,ee.default)(()=>oi("/result/run/test",{runId:e,testId:t,resultId:r,status:n,projectId:s,runnerVersion:hI,...i}),{retries:o,factor:1})}function ru(s,e,t,r,n,i,o,a){return(0,ee.default)(()=>oi("/result/run/tests",{runId:s,runnerStatuses:e,status:t,reason:r,success:n,startTime:i,endTime:o,projectId:a}),{retries:te,factor:1})}async function su({executionId:s,projectId:e,labels:t,startTime:r,executions:n,config:i,resultLabels:o,remoteRunId:a,localRunUserId:c,isLocalRun:l,intersections:d}){let{isCi:m}=await Promise.resolve().then(()=>(so(),Af));return Re({timeout:9e4,url:"/result/run",body:{runId:s,projectId:e,labels:t,startTime:r,execution:n,status:"RUNNING",config:i,resultLabels:o,remoteRunId:a,intersections:d,metadata:{isCiRun:m,localRunUserId:c,isLocalRun:l}},retry:3})}function Eo(s,e,t,r,n={},i=void 0,o=void 0){let a=Date.now();return(0,ee.default)(()=>oi("/result/run",{runId:e,projectId:t,endTime:a,status:s,success:r,tmsOptions:n,remoteRunId:i,resultExtraData:o}),{retries:te,factor:1})}async function ii(s,e,t,r,n){return(0,ee.default)(()=>Re({url:"/testPlan/list",body:{projectId:s,names:e,planIds:t,branch:r,intersections:n},timeout:12e4}),{retries:te,factor:1})}function Du({projectId:s,labels:e,testIds:t,testNames:r,testConfigNames:n,suiteNames:i,suiteIds:o,branch:a,rerunFailedByRunId:c,testConfigIds:l,intersections:d}){return(0,ee.default)(()=>Re({url:"/suite/v2/list",body:{projectId:s,labels:e,testIds:t,testNames:r,testConfigNames:n,suiteNames:i,suiteIds:o,branch:a,rerunFailedByRunId:c,testConfigIds:l,intersections:d}}),{retries:te,factor:1})}async function ti({appId:s,projectId:e}){try{return await(0,ee.default)(()=>Pe(`/mobile-app/app/${s}?projectId=${e}`),{retries:te,factor:1})}catch(t){throw new Error(`Could not load app with the ID ${s}`,{cause:t})}}async function Op(s){try{return await(0,ee.default)(()=>Pe(`/plan/project/${s}/usage-current-billing-period`),{retries:te,factor:1})}catch(e){Nt.error("failed getting usage for current billing period",{projectId:s,error:e});return}}function Pu(s,e,t){return(0,ee.default)(()=>Pe(`/result/${s}/isComplete`,{projectId:e,testRetryKey:t}),{retries:te,factor:1})}function Nr(s,e,t,r){return(0,ee.default)(()=>Pe(`/test/v2/${s}/result/${e}`,{projectId:t,branch:r}),{retries:te,factor:1})}function wl(s,e){return Re({url:`/grid/keep-alive?reqId=${re()}`,body:{projectId:s,slots:e},timeout:1e4})}function vl(s,e,t,r,n){return Re({url:`/grid/release?reqId=${re()}`,body:{companyId:s,projectId:e,slotId:t,gridId:r,browser:n}})}function Sl(s){return Re({url:"/grid/hybrid/provider",body:s})}function El(s){return(0,ee.default)(()=>Pe("/grid/grid-slot",{...s,reqId:re()}),{retries:te,factor:1})}async function _p({projectId:s,token:e,branchName:t,lightweightMode:r,localGrid:n,publicIp:i,gridId:o,grid:a,clientCliVersion:c,clientNodeVersion:l,clientNpmVersion:d}){var m,u;try{return await(0,ee.default)(()=>Ve({url:`${he()}/executions/initialize`,body:{projectId:s,token:e,branchName:t||"master",lightweightMode:r,localGrid:n,publicIp:i,gridId:o,gridName:a,clientCliVersion:c,clientNodeVersion:l,clientNpmVersion:d},timeout:6e4}),{retries:te,factor:1})}catch(f){if(Nt.error("error initializing info from server",f),(m=f.message)!=null&&m.includes("Bad Request"))throw new A("Error trying to retrieve CLI token. Your CLI token and project might not match. Please make sure to pass `--project` and `--token` that match to each other or make sure they match in your ~/.testim file.");if((u=f.code)!=null&&u.includes("ENOTFOUND"))throw new A("Due to network connectivity issues, Testim CLI has been unable to connect to the Testim backend.");if(f.text)try{let h=JSON.parse(f.text),g=h.clientMessage.color||"red",y=h.clientMessage.bgColor||"bgBlack";console.log(Cp.default[y](Cp.default[g](h.clientMessage.text))),h.exitCode&&process.exit(h.exitCode)}catch{Nt.error("Error parsing error message from server",f)}throw f}}async function SI(){if(tt)return{editorUrl:tt};try{return await(0,ee.default)(()=>Pe("/system-info/editor-url"),{retries:te,onFailedAttempt:s=>{if(s.attemptNumber>=te)throw s},factor:1})}catch(s){return Nt.error("cannot retrieve editor-url from server",{err:s}),{editorUrl:"https://app.testim.io"}}}function Il(s){return(0,ee.default)(()=>Pe("/grid",{companyId:s}),{retries:te,factor:1})}function Xl(s,e,t){return(0,ee.default)(()=>Pe(`/real-data/${e}?${t}&projectId=${s}`),{retries:te,factor:1})}function qo(s,e,t,r,n){return(0,ee.default)(()=>Re({url:"/result/test",body:{projectId:s,resultId:e,testId:t,testResult:r,remoteRunId:n}}),{retries:te,factor:1})}function ku(s,e,t,r){return(0,ee.default)(()=>Re({url:"/result/test/clear",body:{projectId:s,resultId:e,testId:t,testResult:r}}),{retries:te,factor:1})}function Tu(s,e,t,r){return(0,ee.default)(()=>Re({url:"/remoteStep",body:{projectId:s,resultId:e,stepId:t,remoteStep:r}}),{retries:te,factor:1})}function EI(s){return s.startsWith("/")?s:`/${s}`}function II(s,e,t){let r=EI(s);return t&&(r=`/${t}${r}`),e&&(r=`/${e}${r}`),r}async function Fb(s,e,t,r,n,i="application/octet-stream"){let o=null;i==="application/json"&&(o=".json");let a=`${n}_${re()}${o||""}`,c=`${e}/${t}/${a}`,l=II(c,bI,s),d=Buffer.from(Mb.gzip(r,{level:3})),m={file:{fileName:a,buffer:d}};return await(0,ee.default)(()=>TI(`/storage${l}`,{},m,{"X-Asset-Encoding":"gzip"}),{retries:te,factor:1}),l}function nu({projectId:s,runId:e,testId:t,newResultId:r,originalTestResultId:n,previousTestResultId:i,testResult:o}){return(0,ee.default)(()=>Re({url:"/result/test/retry",body:{projectId:s,newResultId:r,originalTestResultId:n,previousTestResultId:i,testId:t,runId:e,testResult:o}}),{retries:te,factor:1})}async function Ap(s){try{return await Pe(`/integration/applitools/v3/connected?projectId=${s}`)}catch(e){return Nt.warn("could'nt get applitools integration data.",{err:e}),{}}}async function Lp(s,e){try{return await oi("/tunnel",{companyId:s,routes:e})}catch(t){return Nt.warn("could'nt get tunnel.",{err:t}),{}}}async function Dp(s,e){try{return await Re({url:`/tunnel/${e}`,body:{companyId:s}})}catch(t){Nt.warn("could'nt get tunnel.",{err:t});return}}async function Np(s,e){try{return await Ub(`/tunnel/${e}`,{companyId:s})}catch(t){Nt.warn("could'nt get tunnel.",{err:t});return}}function Mp(s){return Ve({url:`${he()}/result/remoteRunFailure`,body:s})}async function ri({projectId:s,projectType:e,gridId:t,companyId:r,selectors:n}){let i=`${yI}/mobileDevices/${t}/${r}?projectType=${e}`;i=n?`${i}&selectors=${encodeURIComponent(n)}`:i;try{return await(0,ee.default)(()=>Pe(i,{projectId:s}),{retries:te,factor:1})}catch(o){return Nt.warn("could'nt get devices from headspin grid.",{err:o}),null}}async function sp({projectId:s,gridId:e,app:t,timeout:r}){return(0,ee.default)(()=>Re({url:`/mobile-app/app/upload-to-grid?projectId=${s}&gridId=${e}`,body:t,timeout:r}),{retries:te,factor:1})}async function np(s){return(0,ee.default)(()=>Re({url:"/mobile-app/app/fix-grid-app-id",body:s}),{retries:te,factor:1})}async function Hl(s,e){return(0,ee.default)(()=>Re({url:"/slot-management/request-slot",body:{companyId:s,projectId:e}}),{retries:te,factor:1})}async function ql(s,e,t){return(0,ee.default)(()=>Re({url:"/slot-management/release-slot",body:{companyId:s,projectId:e,slotId:t}}),{retries:te,factor:1})}async function zl(s,e,t){return(0,ee.default)(()=>oi("/slot-management/update-slot",{slotId:t.slotId,companyId:s,projectId:e,slot:t}),{retries:te,factor:1})}function Kl(s,e,t){return Re({url:`/slot-management/keep-alive?reqId=${re()}`,body:{slots:t,companyId:s,projectId:e},timeout:1e4})}async function RI(s,e){return await Te(`${Ws}/sessions/${s}`,void 0,{Authorization:`Basic ${Buffer.from(`${e.user}:${e.key}`).toString("base64")}`})}async function bl(s){try{return await Pe("/v2/project/validateUserAccessKey",s),!0}catch(e){return Nt.error("error validating user access key",{error:e}),!1}}var Cp,cr,Mb,ee,Pp,hI,Nt,te,yI,bI,ou,yu,Ou,Io,ge=v(()=>{"use strict";Cp=I(require("chalk")),cr=I(require("lodash")),Mb=I(require("pako"));B();ae();oe();Ge();ct();ee=I(require("p-retry")),Pp=I(require("object-hash"));X();$();Ep();hI=rt(),Nt=C("testim service api"),te=3,yI="/grid",bI="test-result-artifacts";ou=async s=>(0,ee.default)(()=>Pe("/grid/lt/config",{companyId:s}),{retries:te,factor:1}),yu=async s=>(0,ee.default)(()=>Pe(`/labFeature/v2/project/${s}`),{retries:te,factor:1});Ou=cr.memoize(async(s,e,t,r)=>{if(!cr.isEmpty(r))return await Fb(s,e,t,JSON.stringify(r),"test-run-data","application/json")},(s,e,t,r)=>`${(0,Pp.default)(r)}:${e}:${t}`),Io=cr.memoize(async(s,e,t,r,n)=>!r||cr.isEmpty(r)?void 0:await Fb(s,e,t,JSON.stringify((()=>{let o=cr.clone(r);if(n!=null&&n.hiddenParams){let a=n.hiddenParams||[];(Array.isArray(a)?a:Object.keys(a)).forEach(l=>{o[l]&&Object.assign(o,{[l]:Fc.HIDDEN_PARAM})})}return o})()),"test-test-data","application/json"),(s,e,t,r)=>`${(0,Pp.default)(r)}:${e}:${t}`)});function Ha(){return rt()}var Up=v(()=>{"use strict";B()});function CI(s){K.EXTENSION!==s&&process.nextTick(()=>{try{(we(),qe(rr)).getSessionPlayer()}catch{}})}function PI(s){var e,t;(t=(e=s.clientConfig)==null?void 0:e.clientMessages)!=null&&t.length&&s.clientConfig.clientMessages.forEach(r=>{let n=r.color||"yellow",i=r.bgColor||"bgBlack";console.log(Fp.default[i](Fp.default[n](r.text)))})}function kI(s){let{serviceUrl:e}=s;Vs(e),Pt(async()=>s,Yr.CACHE_FN_NAME,Yr.TTL,{serviceUrl:e})()}async function ai(s){let{project:e,token:t,userAccessKey:r,lightweightMode:n,useLocalChromeDriver:i,useChromeLauncher:o,mode:a,gridId:c,grid:l}=s,d=Boolean(n==null?void 0:n.general),m=Boolean(i||o),u=d?AI:xI,f=Ha(),h=Nc(),g=await Gm(),y=null;if(O.flags.getPublicIpFrom3rdPartyServices.isEnabled()&&!m)try{y=await Cb()}catch(b){Bb.error("failed to get public ip",b)}let T=!0;U("before initializeUserWithAuth");let w=await Pt(async()=>(CI(a),T=!1,await _p({projectId:e,token:t,branchName:s.branch,lightweightMode:n,localGrid:m,publicIp:y,gridId:c,grid:l,clientCliVersion:f,clientNodeVersion:h,clientNpmVersion:g})),"initializeUserWithAuth",u,{project:e,token:t,branchName:s.branch,lightweightModeGeneral:d,localGrid:m,gridId:c,grid:l,publicIp:y})();return PI(w),kI(w.clientConfig),s.publicIps=[w.clientPublicIp],U("after initializeUserWithAuth"),y&&w.clientPublicIp&&w.clientPublicIp!==y&&(Bb.error("public ip mismatch",{publicIpFromExternalService:y,publicIpFromServices:w.clientPublicIp}),s.publicIps.push(y)),pf(w.authData,{projectId:e,token:t,userAccessKey:r,publicIp:w.clientPublicIp,initializedFromCache:T}),w}var Fp,Bb,xI,AI,jb=v(()=>{"use strict";Fp=I(require("chalk"));$e();ge();Xt();ct();Fa();oe();$();de();Up();B();is();ae();Bb=C("initializeUserWithAuth"),xI=1e3*60*5,AI=1e3*60*60*10});async function Vb(s){var r;let e=Promise.resolve();s.useLocalChromeDriver&&(s.chromeBinaryLocation=s.downloadBrowser?await Ji():s.chromeBinaryLocation,e=cn({projectId:s.project,userId:s.user},{chromeBinaryLocation:s.chromeBinaryLocation},Boolean((r=s.lightweightMode)==null?void 0:r.general)),s.useLocalChromeDriver=!0),!s.playerRequirePath&&s.mode!==K.EXTENSION&&await vr(s.playerLocation,s.canary),s.mode!==K.SELENIUM&&s.mode!==K.APPIUM&&!s.ext&&await cl(s.extensionLocation);let t;if(s.installCustomExtension){let n=Boolean(s.useLocalChromeDriver||s.useChromeLauncher);t=await al(s.installCustomExtension,n)}return await e,t}async function Gb(s){var o;OI.info("prepare MockNetwork",{location:s});let e=await Lc(s),t=Buffer.isBuffer(e)?e:e.body;if(t.byteLength>$b*1e6)throw new Error(`${Bp} exceeded ${$b}MB`);let r;try{r=JSON.parse(t.toString("utf-8"))}catch(a){throw new Error(`${Bp} cannot be parsed.${qa.EOL}${a}`)}let n=new Wb.default;if(!n.validate(Kc,r)){let a=(o=n.errors)==null?void 0:o.map((c,l)=>`${++l}) ${c.dataPath} ${c.message}`).join(qa.EOL);throw new Error(`${Bp} is malformed.${qa.EOL}${a}`)}return r.entries}var qa,Wb,$b,Bp,OI,jp=v(()=>{"use strict";qa=I(require("node:os"));B();Em();un();Wb=I(require("ajv"));oe();dl();$();jb();$b=1,Bp="JSON file supplied to --mock-network-pattern",OI=C("prepare runner")});function Jb(s){return s.start&&Ir(null,"cli-start-command",{downloadBrowser:Boolean(s.downloadBrowser)}),!!(s.startV2||s.start||s.agent)}async function Yb(s){let e=!!s.start;if(Number.isNaN(s.agentPort))throw new A("Agent port is not number");let t=Ro(s);return console.log("Start Testim CLI on Agent mode"),{project:s.project,token:s.token,agentMode:!0,agentPort:s.agentPort,agentBind:s.agentBind,openEditor:s.openEditor,startTestimBrowser:e,ext:s.ext,extensionPath:s.extensionPath,playerLocation:s.playerPath||t,canary:s.canary,playerPath:s.playerPath,playerRequirePath:s.playerRequirePath,downloadBrowser:Boolean(s.downloadBrowser)}}var Xb=v(()=>{"use strict";_n();Rr();X()});var Ls,Gp,Qb=v(()=>{"use strict";Ls="SECRETS",Gp={get secretsKey(){return Ls},get proxySecrets(){return new Proxy({},{get(s,e){return`${Ls}.${e}`}})},injectProxySecretsStoreToGlobal(){Object.assign(globalThis,{[Ls]:this.proxySecrets})},containsSecrets(s){return typeof s=="string"?s.includes(Ls):JSON.stringify(s).includes(Ls)},extractSecretKeysFromCode(s){let e=new Set,r=(typeof s=="string"?s:JSON.stringify(s)).match(new RegExp(`${Ls}\\.\\w+`,"g"));return r==null||r.map(n=>{let i=n.split(".")[1];i&&e.add(i)}),e},replaceValuesWithDecryptedSecrets({testData:s,secretsRecord:e}){let r=this.secretsKey.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`^${r}\\.(\\w+)$`),i=o=>{Array.isArray(o)?o.forEach((a,c)=>{if(typeof a=="string"){let l=a.match(n);if(l){let d=l[1];o[c]=e[d]??a}}else typeof a=="object"&&a!==null&&i(a)}):o&&typeof o=="object"&&Object.entries(o).forEach(([a,c])=>{if(typeof c=="string"){let l=c.match(n);if(l){let d=l[1];o[a]=e[d]??c}}else typeof c=="object"&&c!==null&&i(c)})};i(s)}}});var Jp={};z(Jp,{doLogin:()=>Kp,getProjectId:()=>UI,getToken:()=>FI});async function UI(){return tT("projectId")}async function FI(){return tT("token")}function eT(s,e){return Promise.race([s,ue(e).then(()=>{throw new ce("timeout")})])}async function BI(){let s=(await import("express")).default(),e=async function(){return eT(new Promise(n=>{s.get("/loginInfo",(i,o)=>{n(JSON.parse(Buffer.from(i.query.info,"base64").toString())),o.status(200).end()})}),6e4).catch(()=>null)}();await new Promise((r,n)=>{let i=s.listen(42543,o=>{o&&n(o),r(i.address().port)})});try{let{getEditorUrl:r}=await Promise.resolve().then(()=>(ge(),Ae)),{editorUrl:n}=await r();go(`${n}/#/new-test`)}catch{console.log(`Unable to open Testim automatically - please manually go to ${tt||mr}`)}return await e}async function Kp({overwriteExisting:s=!0,projects:e=null}={}){let t=Hp.homedir(),r=qp.join(t,".testim");if(await ye(r)&&!s)return;let i={},[{default:o},{default:a}]=await Promise.all([import("prompts"),import("ora")]),c=a("Getting credentials from Tricentis Testim extension ...").start();if(e||(e=await eT(BI(),62e3).catch(()=>null)),e!=null&&e.token){i.token=e.token,i.projectId=e.projectId,c.succeed(),await Zb(r,i);return}if(e!=null&&e.length){c.succeed();let l=e.length===1?{project:e[0]}:await o({type:"select",name:"project",message:"There are multiple projects associated with your user account. Please select the project you would like to connect to:",choices:e.map(d=>({title:d.name,value:d}))});i.token=l.project.ci.token,i.projectId=l.project.id,await Zb(r,i);return}c.fail(),console.log("Error getting credentials - please pass `--token` and `--project` to the CLI or try again")}async function Zb(s,e){await zp.promises.writeFile(s,Ka.stringify(e)),console.log(`Testim credentials saved in '${s}'`)}async function tT(s){let e=Hp.homedir(),t=qp.join(e,".testim"),r=await ye(t),n={};if(r)try{n=Ka.parse((await zp.promises.readFile(t)).toString())}catch{}return n||={},n[s]}var Hp,qp,Ka,zp,Ja=v(()=>{"use strict";Hp=I(require("os")),qp=I(require("path")),Ka=I(require("yaml"));B();zp=require("fs");X();$l();ae()});var uT={};z(uT,{process:()=>XI,program:()=>p});var Xp,oT,Ya,aT,Ht,Me,cT,jI,$I,Ne,Zp,WI,VI,sT,lT,GI,Qp,Xa,ed,Yp,Mt,nT,HI,qI,zI,KI,p,JI,YI,iT,XI,td=v(()=>{"use strict";Xp=I(require("ms")),oT=I(require("chalk")),Ya=I(require("node:fs")),aT=I(require("node:url")),Ht=I(require("lodash")),Me=I(require("node:path"));B();_n();Rr();Xb();Xt();cT=require("commander");oe();X();Hr();B();de();Qb();Wo();ae();jI="Testim Automation",$I=s=>s.replace(/-([a-z])/g,(e,t)=>t.toUpperCase()),Ne=(s,e)=>(e.push(s),e),Zp=new cT.Command,WI=s=>s.split(","),VI=(s,e)=>!s||s.length===0?e:s,sT=["enable-heavy-ad-intervention","heavy-ad-privacy-mitigations","use-fake-device-for-media-stream","use-fake-ui-for-media-stream","proxy-server"],lT=()=>{function s(g){return g.includes("-h, --help")}function e(g){return g.includes("--params [params-json-string]")}function t(g){return g.includes("--ext")||g.includes("--extension-path")||g.includes("--headless-extension-download-path")}function r(g){return g.includes("--player-path")||g.includes("--player-require-path")}function n(g){return g.includes("--executionId")||g.includes("--source")||g.includes("--resultId")||g.includes("--remoteRunId")||g.includes("--schedulerId")}function i(g){return g.includes("--get-browser-timeout")||g.includes("--get-browser-retries")||g.includes("--get-session-timeout")||g.includes("--get-session-retries")||g.includes("--driver-request-timeout")||g.includes("--driver-request-retries")}function o(g){return g.includes("--user")}function a(g){return g.includes("shouldMonitorPerformance")}function c(g){return g.includes("--save-rca-locally")}function l(g){return g.includes("--exit-code-ignore-failing-tests")}function d(g){return g.includes("--high-speed")}function m(g){return g.includes("--urls")}function u(g){return g.includes("--test-start-timeout")}function f(g){return g.includes("--install-lazy-deps")}function h(g){return g.includes("--print-final-caps")||g.includes("--print-grids")}Zp.help(g=>g.split(`
`).filter(T=>!t(T)&&!e(T)&&!s(T)&&!r(T)&&!n(T)&&!a(T)&&!o(T)&&!i(T)&&!c(T)&&!l(T)&&!d(T)&&!m(T)&&!u(T)&&!f(T)&&!h(T)).join(`
`))},GI=(s,e)=>{let t=e?`Please use ${e} instead.`:"";console.log(oT.default.yellow(`
WARNING: ${s} is deprecated. ${t}
`))},Qp=["clover","html","json-summary","json","lcov","lcovonly","teamcity","text-lcov","text-summary","text"],{env:Xa,argv:ed,exit:Yp,cwd:Mt}=global.process,nT={development:{usw2:{servicesUrl:"https://services.dev.testim.io"},euc1:{servicesUrl:"https://services-eu.dev.testim.io"}},staging:{usw2:{servicesUrl:"https://services.staging.testim.io"},euc1:{servicesUrl:"https://services-eu.staging.testim.io"}},production:{usw2:{servicesUrl:"https://services.testim.io"},euc1:{servicesUrl:"https://services-eu.prod.testim.io"}}},HI={"us-west-2":"usw2","eu-central-1":"euc1"},qI=16,zI=async s=>{let e=s.length>qI?s.slice(0,4):HI[Ed],t=await Yc(Yr.CACHE_FN_NAME);if(t&&t.region===e){Vs(t.servicesUrl);return}let n=(nT[Rt]||nT.production)[e]||{servicesUrl:"https://services.testim.io"};Xa.SERVICES_HOST||Vs(n.servicesUrl)},KI=new Set(["trace","debug","info","warn","error","silent"]);Wc(ed,new Set(["run","connect","agent","tunneld","start","init","install-lazy-deps"]));Zp.description("Testim.io CLI").option("-h --help","output usage information",lT).option("-o --options-file [options-file.json]","").option("-c --config-file [config-file.js]","").option("--test-config [test-config]","test config name to override for all tests in current execution",Ne,[]).option("--test-config-id [test-config-id]","test config ID to override for all tests in current execution",Ne,[]).option("--params-file [params-file.json | params-file.js]","").option("--params [params-json-string]","").option("-t, --testId [test-id]","test ID to run",Ne,[]).option("--test-id [test-id]","test ID to run",Ne,[]).option("-l, --label [label]","labels to search test by",Ne,[]).option("-n, --name [test-name]","test name to run",Ne,[]).option("--project [project-id]","project ID").option("-r, --report-file [report junit xml path]","where to save junit xml results file").option("--urls","add step urls to the junit report").option("--override-report-file-classname [override-report-file-classname]","custom junit class name for the junit reporter").option("--reporters [names]","report types",WI).option("-h, --host [host-name]","host name or ip containing the selenium grid").option("-p, --port [host-port]","host port").option("-g, --grid [grid-name]","grid name").option("--path [grid-path]","grid path").option("--protocol [grid-protocol]","grid protocol http or https").option("--grid-username [grid-username]","grid http basic auth username").option("--grid-password [grid-password]","grid http basic auth password").option("-gi --grid-id [grid-id]","grid ID").option("-b, --browser [browser-type]","browser type (chrome/firefox)").option("-h, --headless [headless]","run in headless mode").option("-m, --mode [runner-mode]","use extension or selenium mode (extension/selenium/appium)").option("--branch [branch]","branch name",void 0).option("--base-url [base-url]","change base-url to a specified url for all tests in current execution").option("--token [token]","identification token to testim").option("--parallel [number-of-tests]","number of tests to run in parallel").option("--before-parallel [number-of-tests]","number of tests to run in parallel during the before phase of a test plan").option("--after-parallel [number-of-tests]","number of tests to run in parallel during the after phase of a test plan").option("--canary [canary-mode]","enable canary mode",!1).option("--test-plan [test-plan-name]","test plan to run",Ne,[]).option("--test-plan-id [test-plan-id]","test plan to run",Ne,[]).option("--suite [suite-name]","suite to run",Ne,[]).option("--suite-id [suite-id]","suite ID to run",Ne,[]).option("--rerun-failed-by-run-id [run-id]","allows re-running failed tests from a specific run ID").option("--disable-grid-check [boolean]","disable checking if selenium grid is available",!1).option("--disable-native-events [boolean]","pass nativeEvents=false capability to the selenium browser (in selenium mode)",!1).option("--disable-timeout-retry [boolean]","disable retry after test pass test timeout",!1).option("--ca-file [ca-file-location]","ca certificate file location").option("--proxy [proxy-url]","proxy url to all requests").option("--proxy-for-grid [proxy-for-grid]","used together with --proxy to also router grid traffic through a proxy").option("--result-label [result-label]","result label",Ne,[]).option("-oen --override-execution-name [execution-name]","override the default execution name","").option("--retries [max_num_of_retries]","number of retries on test failure, defaults to 0 (no retries)",Number,0).option("--set-retention [retention-in-days]","set the number of days for results retention").option("--user [user-id]","user ID for local Testim-CLI").option("--user-access-key [user-access-key]","EXPERIMENTAL").option("--pass-zero-tests","don't fail the run if no tests were found").option("--device-name [device-name]","The device name to use, iPhone 12, Nexus 5X, SM-G900P etc....").option("--device-udid [device-udid]","Unique Device Identifier").option("--custom-tag [custom-tag]","tag grid result with custom tag").option("-slb --skip-load-balancer","skipping automatic allocation (AppiumLB) for mobile runs on mobile gird that support it",!1).option("--no-lock-device","skipping locking device internal use for TDC grid").option("--os-version [os-version]","The operating system version number").option("--app-id [app-id]","The application id from app library on Testim Editor App").option("--appium-log-level [appium-log-level]","Level of logging verbosity").option("--set-no-reset [set-no-reset]","set noReset appium capability, by default set to false",!1).option("-fr --full-reset [full-reset]","set fullReset appium capability to true to reinstall application on session start and session end").option("--duration [duration]","The duration of the test run in minutes",Number).option("-str --suppress-tms-reporting [suppress-tms-reporting]","disable test management reporting",!1).option("-tsr --tms-suppress-reporting [tms-suppress-reporting]","disable test management reporting",!1).option("-tid --tms-run-id [tms-run-id]","update existing result in test management","").option("-tff --tms-field-file [tms-field-file.json]","pass field file location to add custom result field to the tms result report","").option("--disable-file-cache","disable internal CLI file caching").option("--clear-file-cache","clear internal CLI file cache").option("--file-cache-location [directory]"," internal CLI file caching location").option("--test-start-timeout [test-start-timeout]","The time to wait for a test to start after getting a browser session",Number,Number(Xa.TESTIM_TEST_START_TIMEOUT)||2*60*1e3).option("--timeout [test-timeout]","Test run timeout in milliseconds",Number).option("--browser-timeout [open-browser-timeout]","Get browser from grid timeout in milliseconds",Number).option("--new-browser-wait-timeout [max-wait-to-browser]","Maximum get browser wait in minutes",Number).option("--get-browser-timeout [get-browser-timeout]","Timeout for a single attempt to get browser from the grid configured in the project's plan",Number).option("--get-browser-retries [get-browser-retries]","Number of attempts to get browser from the grid configured in the project's plan",Number).option("--get-session-timeout [get-session-timeout]",'Timeout for "/session" request to the selenium server',Number,(0,Xp.default)("90s")).option("--get-session-retries [get-session-retries]",'Retries for "/session" request to the selenium server',Number,3).option("--driver-request-timeout [driver-request-timeout]","Timeout for any WebDriver request to the grid server",Number,(0,Xp.default)("90s")).option("--driver-request-retries [driver-request-retries]","Retries for any WebDriver request to the grid server",Number,3).option("--local-tma-url [local-tma-url]","use a local TMA instance for appium session").option("--use-local-chrome-driver [use-local-chrome-driver]","use a local ChromeDriver instance instead of a selenium grid").option("--chrome-binary-location [chrome-binary-location]","Chrome binary location").option("--use-chrome-launcher","use a local Chrome installation without selenium").option("-mnh --mock-network-har","use the HAR file configured in the Testim editor to mock network traffic").option("-mnp --mock-network-pattern [local file location path]","use a JSON rule file to mock network traffic (Rule file schema: https://help.testim.io/page/mocking-network-traffic)").option("-omf --override-mapping-file [local file location path]","pass map file location to override mock network (see schema: https://help.testim.io/page/mocking-network-traffic)").option("-dmn --disable-mock-network","Disable mock mode for the entire CLI run").option("--run-quarantined-tests","Run quarantine tests").option("--collect-code-coverage","collect code coverage for all js files under base url").option("--code-coverage-url-filter [url pattern]","collect code coverage for all js files matching url filter (url including asterisk)").option("--code-coverage-report-path [path]","where to save coverage report (default ./coverage)").option("--code-coverage-source-map-path [path]","path of source code").option("--code-coverage-reporter [reporter]",`set code coverage reporter (default html and text), options: ${Qp.join("/")}`,Ne,[]).option("--code-coverage-include [pattern]","set selecting files for coverage (default src/**)",Ne,[]).option("--sauce-user [sauce-lab-user]","user to connect to sauce labs").option("--sauce-key [sauce-lab-key]","key to use when connecting to sauce labs").option("--sauce-options [sauce-options]","json file of browser and os options for sauce").option("--browserstack-user [browserstack-user]","user to connect to browserStack").option("--browserstack-key [browserstack-key]","key to use when connecting to browserStack").option("--browserstack-options [browserstack-options]","json file of browser and os options for browserStack").option("--perfecto-token [perfecto-token]","security token to use when connecting to perfecto").option("--perfecto-options [perfecto-options]","json file of browser and os options for perfecto").option("--experitest-token [experitest-token]","security token to use when connecting to experitest").option("--testobject-key [testobject-key]","api key to use when connecting to testobject").option("--testobject-options [testobject-options]","json file of options for testobject").option("--sealights-lab-id [sealights-lab-id]","SeaLight Lab ID").option("--sealights-build-session-id [sealights-build-session-id]","SeaLight Session Build ID").option("--sealights-test-stage [sealights-test-stage]","SeaLight Test Stage Name").option("--ext [extension src path]","use extension from path (default it '/..')").option("--extension-path [path to extension archived file]","override the used extension").option("--install-custom-extension [chrome extension zipped file url or local path]","chrome extension to be installed in the browser").option("--player-path [path to player file]").option("--player-require-path [path to unminified player - development only]").option("--inspect [port]","Opens node inspector at given port",Number).option("--tunneld","run a tunnel daemon only").option("--tunnel [tunnel]","enable tunnel").option("--tunnel-routes [routes]","tunnel routes for cloudflare tunnels").option("--tunnel-port [tunnel-port]","tunnel port address").option("--tunnel-host-header [tunnel-host-header]","tunnel host header").option("--tunnel-region [tunnel-region]","ngrok tunnel region").option("--tunnel-diagnostics","collect ngrok tunnel diagnostics").option("--tunnel-use-http-address [tunnel-use-http-address]","use http:// address instead of https://",!1).option("--external-lambdatest-tunnel-id [tunnel-id]","use existing lambdatest tunnel ID").option("--external-lambdatest-use-wss","use wss instead of ssh for LT",!1).option("--external-lambdatest-disable-automation-tunneling","don't tunnel Testim calls in LT tunnel",!0).option("--external-lambdatest-mitm","Turn on LT Man in the middle",!1).option("--external-lambdatest-NTLM-tunnel-username [tunnel-NTLM-username]","Tunnel NTLM username").option("--external-lambdatest-NTLM-tunnel-password [tunnel-NTLM-password]","Tunnel NTLM password").option("--w3c-capabilities [enable-w3c-caps-mode]","enable/disable w3c capabilities format (default enable)",JSON.parse,!0).option("--old-capabilities [enable-old-caps-mode]","enable/disable old capabilities format (default enable)",JSON.parse,!0).option("--disable-sockets","Disable CLI sockets",!1).option("--executionId [execution-id]","","").option("--remoteRunId [remote-run-id]","","").option("--schedulerId [scheduler-id]","","").option("--source [source]","","cli").option("--resultId [result-id]","","").option("--connect, --agent [enable-agent-mode]","enable Testim CLI agent mode",!1).option("--start [enable-start]","Connect to testim and open the editor in a standalone browser",!1).option("--download-browser","when used with the start option, downloads a fixed version to run Testim editor in",!1).option("--agent-port [agent-port]","set agent port",Number,42543).option("--agent-bind [agent-host-bind]","set agent host bind","127.0.0.1").option("--chrome-extra-prefs [chrome-extra-prefs]","add extra chrome preferences","").option("--chrome-extra-args [chrome-extra-args]","add extra chrome arguments separated by ','","").option("--chrome-block-location [chrome-block-location]","block chrome geolocation",!1).option("--chrome-user-data-dir [chrome-user-data-dir]","use custom chrome user date dir",!1).option("--disable-cookies-same-site-none-requires-secure [disable-same-site-none-requires-secure]","Disable cookies without SameSite must be secure",!1).option("--selenium-caps-file [selenium-caps-file.json]","json file to merge into Testim selenium desired capabilities").option("--version [version]","print the current version of the Testim CLI and exit",!1).option("--monitor-performance","collect test playback performance data").option("--high-speed","DEPRECATED: use --turbo-mode instead").option("--turbo-mode","run in turbo mode (providing that tests are configured with browsers that use extension mode [chrome, edge chromium])").option("--lightweight-mode [settings]","run lightweight mode").option("--create-prefeched-data [location]","prefetch data into local cache file").option("--use-prefeched-data [location]","use prefetched data from local cache file, and force using only cached data").option("--save-rca-locally [path]","save root cause analysis assets locally").option("--exit-code-ignore-failing-tests","return exit code of zero when tests fail. non zero exit code will mean a real error occurred").option("--intersect-with-label [label]","Out of the execution's test list, run only those tests that have the specified label",Ne,[]).option("--intersect-with-suite [suiteName]","Out of the execution's test list, run only those tests that are included in the specified suite (by suite name)",Ne,[]).option("--intersect-with-suite-id [suiteId]","Out of the execution's test list, run only those tests that are included in the specified suite (by suite ID)",Ne,[]).option("--apply-intersections-to-before-and-after-sections [boolean]","For a test plan's before/after tests, run tests that intersect with specified intersection flags",void 0).option("--install-lazy-deps [install-lazy-deps]","Install all lazy dependencies from package.json",!1).option("--bypass-node-version-check [bypass-node-version-check]","Allow running with incompatible Node.js versions",!1).option("--print-grids","Print available grids and exit",!1).option("--print-final-caps","Print the final calculated capabilities",!1).option("--headless-extension-download-path [headless-extension-download-path]","Path to download headless extension","").parse(ed);p=Zp.opts(),JI=()=>{p.grid||p.gridId||(p.host||(p.host="ondemand.saucelabs.com"),p.port||(p.port=80))},YI=()=>{p.grid||p.gridId||(p.host||(p.host="hub-cloud.browserstack.com"),p.port||(p.port=80))},iT=s=>{var r;if(!O.flags.secrets.isEnabled({projectId:p.project}))return;let t=Ya.readFileSync(s);(r=Gp)!=null&&r.containsSecrets(t.toString())&&Gp.injectProxySecretsStoreToGlobal()},XI=async()=>{var T,w,b,S,E,k,D,G;p.inspect&&require("node:inspector").open(p.inspect);let s={},e={},t=[],r={};if(!ed.slice(2).length)throw lT(),new qr;if(p.version){let x="Testim CLI Version: ";Xa.npm_package_version&&(console.log(x,Xa.npm_package_version),Yp(0));let R=rt();R&&(console.log(x,R),Yp(0)),console.log("Could not find version, please check the package.json manually"),Yp(0)}if(p.installLazyDeps)return{installLazyDepsMode:!0};p.disableFileCache&&Nm(),p.clearFileCache&&ss();let n=p.fileCacheLocation||p.usePrefechedData||p.createPrefechedData;if(n){let x=Me.resolve(n);Lm(x)}if(p.usePrefechedData&&Mm(),p.playerRequirePath){let x=Me.resolve(p.playerRequirePath);console.log("Using Local Clickim for Player Require Path =",x);let R=Me.join(x,"tsconfig.node.json"),M=require("ts-node").register({project:R,ignore:[/node_modules/,new RegExp(`^${Ht.escapeRegExp(Me.relative(Mt(),__dirname))}`)],transpileOnly:!0});require("tsconfig-paths").register({paths:M.config.options.paths,baseUrl:M.config.options.baseUrl}),(we(),qe(rr)).options.playerPath=x;let W=require("node:module"),q=W.prototype.require;W.prototype.require=function(Ee){return Ee==="rox-alias"?q.call(this,"rox-node"):Ee==="canvas"?{}:q.apply(this,arguments)}}if(p.caFile&&(global.caFileContent=Ya.readFileSync(p.caFile)),p.proxy&&(global.proxyUri=p.proxy,global.SuperagentProxy=require("superagent-proxy"),global.ProxyAgent=require("proxy-agent").ProxyAgent,global.HttpsProxyAgent=require("https-proxy-agent").HttpsProxyAgent),p.proxyForGrid&&!p.proxy)throw new A("missing --proxy option");if(Jb(p))return Yb(p);try{let x={};p.configFile?(iT(p.configFile),x=require(Me.join(Mt(),p.configFile)).config):p.optionsFile&&(x=require(Me.join(Mt(),p.optionsFile))),x&&typeof x.then=="function"&&(x=await x),Object.keys(x).forEach(R=>{let L=$I(R);p[L]=VI(p[L],x[R])})}catch(x){throw x.message=`Unable to read options file: ${x.message}`,x}if(p.tunneld)return{tunnel:!0,tunnelPort:p.tunnelPort,tunnelRoutes:p.tunnelRoutes,tunnelRoutesOutput:p.tunnelRoutesOutput,tunnelHostHeader:p.tunnelHostHeader,tunnelRegion:p.tunnelRegion,tunnelDiagnostics:p.tunnelDiagnostics,tunnelUseHttpAddress:p.tunnelUseHttpAddress,tunnelOnlyMode:!0,token:p.token,project:p.project};let i=((T=p.testConfig)==null?void 0:T.length)||((w=p.testConfigId)==null?void 0:w.length),o=((b=p.testPlan)==null?void 0:b.length)||((S=p.testPlanId)==null?void 0:S.length),a=((E=p.suite)==null?void 0:E.length)||((k=p.suiteId)==null?void 0:k.length);if(p.seleniumCapsFile)try{r=require(Me.join(Mt(),p.seleniumCapsFile))}catch(x){throw new A(`Failed to parse selenium caps file file error: ${x.message}`)}if((D=p.reporters)!=null&&D.includes("junit")&&!p.reportFile&&console.log("Warning: please define --report-file option for JUnit reporter"),!p.tunnel&&p.externalLambdatestTunnelId)throw new A("missing --tunnel parameter");if(!p.tunnel&&p.externalLambdatestUseWss)throw new A("missing --tunnel parameter");if(!p.tunnel&&[p.tunnelPort,p.tunnelHostHeader,p.tunnelRegion,p.tunnelDiagnostics].some(Boolean))throw new A("missing --tunnel parameter");if(p.chromeExtraPrefs)try{e=require(Me.join(Mt(),p.chromeExtraPrefs))}catch(x){throw new A(`Failed to read/open chrome extra prefs file error: ${x.message}`)}if(p.chromeExtraArgs){let x=p.chromeExtraArgs.split(",");for(let R of x){let[L]=R.split("=");sT.includes(L)||p.useLocalChromeDriver||p.useChromeLauncher?(t.push(R),L==="proxy-server"&&t.push("proxy-bypass-list=*.testim.io;*.coralogix.com;*.rollout.io")):console.warn(`Ignoring an unsupported chrome arg (${L}), allowed values: ${JSON.stringify(sT)}`)}}if(p.paramsFile)try{p.paramsFile.endsWith("js")&&iT(p.paramsFile),s={...s,...require(Me.join(Mt(),p.paramsFile))}}catch(x){throw new A(`Failed to read/open params file error: ${x.message}`)}if(p.params)try{s={...s,...JSON.parse(p.params)}}catch(x){throw new A(`Failed to parse params string error: ${x.message}`)}if(p.sauceUser&&!p.sauceKey||!p.sauceUser&&p.sauceKey)throw new A("missing --sauce-user <sauce-user> or --sauce-key <sauce-key>");if(p.sauceUser&&p.sauceKey&&(JI(),p.saucelabs={},p.saucelabs.username=p.sauceUser,p.saucelabs.accessKey=p.sauceKey),p.sauceOptions)try{let x=require(Me.join(Mt(),p.sauceOptions)),R=x.platformName&&["ios","android"].includes(x.platformName.toLowerCase());if(x.browserName){let M=x.browserName.toLowerCase();switch(M){case"microsoftedge":p.browser="edge";break;default:p.browser=M}}p.browser==="edge"&&parseFloat(x.version)>=79&&(p.browser="edge-chromium");let L=parseFloat(x.version)<50&&!["dev","beta"].includes(x.version);if(!R&&p.browser==="chrome"&&L)throw new A("The minimum chrome supported version is 50.0");p.saucelabs={...p.saucelabs,...x}}catch(x){throw new A(`Failed to parse saucelabs options file error: ${x.message}`)}if(p.browserstackUser&&!p.browserstackKey||!p.browserstackUser&&p.browserstackKey)throw new A("missing --browserstack-user <browserstack-user> or --browserstack-key <browserstack-key>");if(p.browserstackUser&&p.browserstackKey&&(YI(),p.browserstack={},p.browserstack["browserstack.user"]=p.browserstackUser,p.browserstack["browserstack.key"]=p.browserstackKey),p.browserstackOptions)try{let x=require(Me.join(Mt(),p.browserstackOptions)),R=x.platform&&["mac","android"].includes(x.platform.toLowerCase());if(x.browserName&&(p.browser=x.browserName.toLowerCase()),p.browser==="edge"&&parseFloat(x.browser_version)>=79&&(p.browser="edge-chromium"),!R&&parseFloat(x.browser_version)<50&&p.browser==="chrome")throw new A("The minimum chrome supported version is 50.0");p.browserstack={...p.browserstack,...x}}catch(x){throw new A(`Failed to parse browserstack options file error: ${x.message}`)}if(p.perfecto={},p.perfectoToken&&(p.perfecto.securityToken=p.perfectoToken),p.perfectoOptions)try{let x=require(Me.join(Mt(),p.perfectoOptions)),R={location:"US East",securityToken:p.perfectoToken};p.perfecto={...R,...x}}catch(x){throw new A(`Failed to parse perfecto options file error: ${x.message}`)}if(p.testobjectSauce={},p.testobjectKey&&(p.testobjectSauce.testobjectApiKey=p.testobjectKey),p.testobjectOptions)try{let x=require(Me.join(Mt(),p.testobjectOptions)),R={testobjectApiKey:p.testobjectKey};p.testobjectSauce={...R,...x}}catch(x){throw new A(`Failed to parse test object options file error: ${x.message}`)}p.sealightsTestStage!==jI&&Ir(null,"cli-sealights_stage_changed",{projectId:p.project});let c={seaLights:{buildSessionId:p.sealightsBuildSessionId,labId:p.sealightsLabId,testStage:p.sealightsTestStage}};if(p.testOptimization=c,!p.project){let R=await(await Promise.resolve().then(()=>(Ja(),Jp))).getProjectId();if(R)p.project=R;else throw new A("missing project-id info, either --login to provide new credentials or use --project <project-id>")}zI(p.project),O.flags.forceTurboModeIfNeeded.isEnabled({projectId:p.project})&&(p.turboMode=!0),p.testConfig&&(p.testConfig=[p.testConfig].flat()),p.testConfigId&&(p.testConfigId=[p.testConfigId].flat()),p.retries=!p.retries||typeof p.retries=="boolean"?1:Number(p.retries)+1,p.browserTimeout=!p.browserTimeout||typeof p.browserTimeout=="boolean"?60*1e3:p.browserTimeout,p.newBrowserWaitTimeout=!p.newBrowserWaitTimeout||typeof p.newBrowserWaitTimeout=="boolean"?10*60*1e3:p.newBrowserWaitTimeout*60*1e3,p.getBrowserTimeout||(p.getBrowserTimeout=p.browserTimeout),p.getBrowserRetries||(p.getBrowserRetries=Math.round(p.newBrowserWaitTimeout/p.browserTimeout)),p.getSessionTimeout=Math.max(p.browserTimeout,p.getSessionTimeout),p.driverRequestTimeout=Math.max(p.browserTimeout,p.driverRequestTimeout);let d=Boolean(p.timeout);if(p.timeout=!p.timeout||typeof p.timeout=="boolean"?10*60*1e3:p.timeout,p.beforeParallel=!p.beforeParallel||typeof p.beforeParallel=="boolean"?1:Number(p.beforeParallel),p.parallel=!p.parallel||typeof p.parallel=="boolean"?1:Number(p.parallel),p.afterParallel=!p.afterParallel||typeof p.afterParallel=="boolean"?1:Number(p.afterParallel),p.tunnelPort=!p.tunnelPort||typeof p.tunnelPort=="boolean"?"80":p.tunnelPort,p.port&&=Number(p.port),!p.token){let R=await(await Promise.resolve().then(()=>(Ja(),Jp))).getToken();if(R)p.token=R;else throw new A("missing Testim Access Token, either --login to provide new credentials or use --token <testim-access-token>, contact info@testim.io if you need a new one.")}let m=x=>x<=0||!Number.isInteger(x);if(m(p.retries))throw new A("test failure retry count could not be a negative number or string, --retries <max_num_of_retries>");if(p.retries>21)throw new A("Max number of retries exceeded. Number cannot be greater than 20, --retries <max_num_of_retries>");if(m(p.browserTimeout))throw new A("get browser timeout could not be a negative number, --browser-timeout <get-browser-timeout>");if(m(p.newBrowserWaitTimeout))throw new A("max new browser wait timeout could not be a negative number, --new-browser-wait-timeout <max-wait-to-browser>");if(m(p.timeout))throw new A("test run timeout could not be a negative number, --timeout <run-timeout>");if(m(p.beforeParallel))throw new A("before-parallel could not be a negative number or not number, --before-parallel <number-of-tests>");if(m(p.parallel))throw new A("parallel could not be a negative number or not number, --parallel <number-of-tests>");if(m(p.afterParallel))throw new A("after-parallel could not be a negative number or not number, --after-parallel <number-of-tests>");if(p.mode&&![K.EXTENSION,K.SELENIUM,K.APPIUM].includes(p.mode))throw new A(`runner mode <${p.mode}> is not supported`);if(p.browser&&![...Mr,...Vn].includes(p.browser))throw new A(`browser ${p.browser} is not supported`);if(p.mode!==K.SELENIUM&&p.disableNativeEvents)throw new A("--disable-native-events is only applicable in selenium mode");if(p.appiumLogLevel||(p.appiumLogLevel="silent"),!KI.has(p.appiumLogLevel))throw new A(`runner appium-log-level <${p.appiumLogLevel}> is not supported`);if(p.testPlan&&p.testPlan.length===0&&p.testPlanId&&p.testPlanId.length===0){if(typeof p.host!="string"&&typeof p.grid!="string"&&typeof p.gridId!="string"&&!p.localTmaUrl&&!p.useLocalChromeDriver&&!p.useChromeLauncher&&!p.createPrefechedData&&!p.printGrids)throw new A("missing remote grid address parameter, specify --host <host-name-or-ip> or --grid <grid-name> or --grid-id <grid-id>")}else if(p.testId.length||p.label.length||p.name.length||i||p.browser||a||p.localTmaUrl||p.useLocalChromeDriver||p.useChromeLauncher)throw new A("cannot set --testId, --label, --name, --browser, --test-config, --test-config-id, --local-tma-url, --use-local-chrome-driver --use-chrome-launcher or --suite with --test-plan option");if(!o&&(p.beforeParallel!==1||p.afterParallel!==1))throw new A("cannot set --before-parallel or --after-parallel without --test-plan option");if([p.host,p.grid,p.gridId].filter(Boolean).length>1)throw new A("please define exactly one of --grid or --grid-id or --host");if((G=p.host)!=null&&G.includes("/")&&(/^(f|ht)tps?:\/\//i.test(p.host)||(p.host=`http://${p.host}`),p.host=aT.parse(p.host).hostname),p.resultLabel.length){p.resultLabel=p.resultLabel.map(R=>R.trim()).filter(Boolean);let x=p.resultLabel.filter(R=>R.length>=250).filter(Boolean);if(p.branch==="auto-detect"&&p.resultLabel.includes("auto-detect-branch")&&yr()&&p.resultLabel.unshift(yr()),x.length)throw new A("A result label cannot exceed 250 characters")}let f=Ro(p);if(!p.w3cCapabilities&&!p.oldCapabilities)throw new A("cannot set --w3c-capabilities and --old-capabilities options as false");if(p.protocol||=p.port===443?"https":"http",!["http","https"].includes(p.protocol))throw new A("invalid --protocol value, allow --protocol http or https");if(p.rerunFailedByRunId&&p.branch)throw new A("It is not possible to use --branch with --rerun-failed-by-run-id. Tests will automatically run on the same branch that was used in the original run");if(p.rerunFailedByRunId&&(a||p.name.length||p.testId.length||p.label.length||o))throw new A("Re-running failed tests is not possible when suite (--suite), label (--label), plan (--test-plan), or other test flags (--test) are provided. Please remove these flags and try again");if(p.setRetention&&!Ht.inRange(Ht.parseInt(p.setRetention),1,11))throw new A("Please provide the number of days that the test results will be retained for (--set-retention must be a whole number between 1 to 10)");p.setRetention&&=Number(p.setRetention);let h="is no longer supported, please use --override-mapping-file";if(p.mockNetworkHar)throw new A(`--mock-network-har ${h}`);if(p.mockNetworkPattern)throw new A(`--mock-network-pattern ${h}`);if(p.disableMockNetwork&&p.overrideMappingFile)throw new A("You can either use --disable-mock-network or --override-mapping-file");if(!p.collectCodeCoverage&&p.codeCoverageSourceMapPath)throw new A("cannot set --code-coverage-source-map-path without passing --collect-code-coverage");if(!p.collectCodeCoverage&&p.codeCoverageReporter.length)throw new A("cannot set --code-coverage-reporter without passing --collect-code-coverage");if(!p.collectCodeCoverage&&p.codeCoverageInclude.length)throw new A("cannot set --code-coverage-include without passing --collect-code-coverage");if(p.collectCodeCoverage&&p.codeCoverageReporter&&Ht.difference(p.codeCoverageReporter,Qp).length){let x=Ht.difference(p.codeCoverageReporter,Qp);throw new A(`invalid --code-coverage-reporter parameters ${x.join("/")}`)}p.codeCoverageReporter=p.codeCoverageReporter.length===0?["html","text"]:p.codeCoverageReporter,p.codeCoverageInclude=p.codeCoverageInclude.length===0?["src/**"]:p.codeCoverageInclude;let g={mockNetworkHar:"--mock-network-har",mockNetworkPattern:"--mock-network-pattern",overrideMappingFile:"--override-mapping-file",codeCoverageUrlFilter:"--code-coverage-url-filter",collectCodeCoverage:"--collect-code-coverage",disableMockNetwork:"--disable-mock-network",useChromeLauncher:"--use-chrome-launcher"},y=Object.keys(g).filter(x=>Boolean(p[x]));if([K.APPIUM,K.SELENIUM].includes(p.mode)&&y.length){let x=y.length>1?"are":"is";throw new A(`${y.map(R=>g[R]).join(" and ")} ${x} only applicable in extension mode`)}if((p.useChromeLauncher||p.useLocalChromeDriver)&&(p.browser="chrome"),p.tmsFieldFile)try{let x=Ya.readFileSync(p.tmsFieldFile);p.tmsCustomFields=JSON.parse(x)}catch(x){throw new A(`failed to parse field file error: ${x.message}`)}if(p.applyIntersectionsToBeforeAndAfterSections&&!p.intersectWithLabel&&!p.intersectWithSuite&&!p.intersectWithSuiteId)throw new A("--apply-intersections-to-before-and-after-sections flag must be combined with at least one of the available --intersect-with flags");if(p.highSpeed&&(GI("--high-speed","--turbo-mode"),p.turboMode=!0),p.skipLoadBalancer&&!p.deviceUdid)throw new A("It is not possible to skip load balancer without specifying deviceUdid");if(p.deviceUdid&&(p.deviceName||p.osVersion))throw new A("It is not possible to use --osVersion or --deviceName with --device-udid. device-udid is unique and cannot be combined with another flag");if(p.setNoReset&&p.fullReset)throw new A("It is not possible to set both --set-no-reset and --full-reset capabilities to true at the same time!");if(p.lightweightMode)try{let x={general:!0,disableLabs:!0,disableFeatureFlags:!0,disableAssets:!0,disablePixelValidation:!0,disableResults:!0,disableStepDelay:!0,disableRemoteStep:!0,assumePreloadedSharedSteps:!0,disableVisibilityCheck:!1,disableLocators:!1,bypassSetup:!1,disableAutoImprove:!0,disableQuotaBlocking:!0,onlyTestIdsNoSuite:!0,uploadAssetsAndResultsOnFailure:!0,preloadTests:!0,disableProjectDefaults:!0,type:"lightweight"},R=typeof p.lightweightMode=="string"?JSON.parse(p.lightweightMode):{};p.lightweightMode={...x,...R}}catch(x){throw new A(`failed to parse lightweightMode settings error: ${x.message}`)}else p.turboMode&&![K.APPIUM,K.SELENIUM].includes(p.mode)?p.lightweightMode={general:!0,disableLabs:!1,disableFeatureFlags:!1,disableAssets:!0,disablePixelValidation:!1,disableResults:!0,disableStepDelay:!0,disableRemoteStep:!1,assumePreloadedSharedSteps:!1,disableVisibilityCheck:!1,disableLocators:!1,bypassSetup:!1,disableQuotaBlocking:!1,disableAutoImprove:!1,onlyTestIdsNoSuite:!1,uploadAssetsAndResultsOnFailure:!0,preloadTests:!1,disableProjectDefaults:!1,type:"turboMode"}:p.turboMode&&[K.APPIUM,K.SELENIUM].includes(p.mode)&&console.warn(`
When running the CLI in Selenium mode, the Turbo Mode option is ignored, as they are not compatible concurrently`);if(typeof p.baseUrl=="boolean")throw new A("base url cannot be used as a flag, and must contain a string value");return{testId:[p.testId].flat(),name:[p.name].flat(),label:[p.label].flat(),suites:[p.suite].flat(),suiteIds:[p.suiteId].flat(),testPlan:[p.testPlan].flat(),testPlanIds:[p.testPlanId].flat(),reportFile:p.reportFile,urls:p.urls,reportFileClassname:p.overrideReportFileClassname,reporters:p.reporters,project:p.project,host:p.host,headless:p.headless,localTmaUrl:p.localTmaUrl,useLocalChromeDriver:p.useLocalChromeDriver,chromeBinaryLocation:p.chromeBinaryLocation,useChromeLauncher:p.useChromeLauncher,port:p.port,grid:p.grid,gridId:p.gridId,disableNativeEvents:p.disableNativeEvents,saucelabs:p.saucelabs,browserstack:p.browserstack,baseUrl:p.baseUrl,branch:(p.branch==="auto-detect"?yr():p.branch)||"master",autoDetect:p.branch==="auto-detect",token:p.token,userAccessKey:p.userAccessKey,userParamsData:s,mode:p.mode,browser:p.browser,beforeParallel:p.beforeParallel,parallel:p.parallel,afterParallel:p.afterParallel,canary:p.canary,rerunFailedByRunId:p.rerunFailedByRunId,disableGridCheck:p.disableGridCheck,disableTimeoutRetry:p.disableTimeoutRetry,resultLabels:p.resultLabel,path:p.path,protocol:p.protocol,perfecto:p.perfecto,experitestToken:p.experitestToken,testobjectSauce:p.testobjectSauce,testOptimization:p.testOptimization,gridUsername:p.gridUsername,gridPassword:p.gridPassword,overrideExecutionName:p.overrideExecutionName,tmsSuppressReporting:Boolean(p.suppressTmsReporting)||Boolean(p.tmsSuppressReporting),tmsRunId:p.tmsRunId,tmsCustomFields:p.tmsCustomFields,proxyForGrid:p.proxyForGrid,retentionDays:p.setRetention,passZeroTests:Boolean(p.passZeroTests),runQuarantinedTests:Boolean(p.runQuarantinedTests),deviceName:p.deviceName,deviceUdid:p.deviceUdid,customTag:p.customTag,osVersion:p.osVersion,duration:p.duration,skipLoadBalancer:p.skipLoadBalancer,lockDevice:p.lockDevice,appId:p.appId,appiumLogLevel:p.appiumLogLevel,setNoReset:p.setNoReset,fullReset:p.fullReset,ext:p.ext,extensionPath:p.extensionPath,extensionLocation:[p.extensionPath].filter(Boolean),playerLocation:p.playerPath||f,playerPath:p.playerPath,playerRequirePath:p.playerRequirePath,tunnel:p.tunnel,tunnelPort:p.tunnelPort,tunnelRoutes:p.tunnelRoutes,tunnelRoutesOutput:p.tunnelRoutesOutput,tunnelHostHeader:p.tunnelHostHeader,tunnelRegion:p.tunnelRegion,tunnelDiagnostics:p.tunnelDiagnostics,tunnelUseHttpAddress:p.tunnelUseHttpAddress,externalLambdatestTunnelId:p.externalLambdatestTunnelId,externalLambdatestNTLMTunnelUsername:p.externalLambdatestNTLMTunnelUsername,externalLambdatestNTLMTunnelPassword:p.externalLambdatestNTLMTunnelPassword,externalLambdatestUseWss:p.externalLambdatestUseWss||!1,externalLambdatestDisableAutomationTunneling:Boolean(p.externalLambdatestDisableAutomationTunneling),externalLambdatestMitm:Boolean(p.externalLambdatestMitm),beforeTest:p.beforeTest,afterTest:p.afterTest,beforeSuite:p.beforeSuite,afterSuite:p.afterSuite,timeout:p.timeout,timeoutWasGiven:d,browserTimeout:p.browserTimeout,newBrowserWaitTimeout:p.newBrowserWaitTimeout,getBrowserTimeout:p.getBrowserTimeout,getBrowserRetries:p.getBrowserRetries,getSessionTimeout:p.getSessionTimeout,getSessionRetries:p.getSessionRetries,driverRequestTimeout:p.driverRequestTimeout,driverRequestRetries:p.driverRequestRetries,testStartTimeout:p.testStartTimeout,testConfigNames:p.testConfig,testConfigIds:p.testConfigId,overrideMappingFile:p.overrideMappingFile,disableMockNetwork:p.disableMockNetwork,codeCoverageUrlFilter:p.codeCoverageUrlFilter,collectCodeCoverage:p.collectCodeCoverage,codeCoverageReportPath:p.codeCoverageReportPath,codeCoverageSourceMapPath:p.codeCoverageSourceMapPath,codeCoverageReporter:p.codeCoverageReporter,codeCoverageInclude:p.codeCoverageInclude,executionId:p.executionId,remoteRunId:p.remoteRunId,schedulerId:p.schedulerId,source:p.source,resultId:p.resultId,installCustomExtension:p.installCustomExtension,w3cCapabilities:p.w3cCapabilities,oldCapabilities:p.oldCapabilities,chromeBlockLocation:p.chromeBlockLocation,chromeUserDataDir:p.chromeUserDataDir,retries:p.retries,chromeExtraPrefs:e,chromeExtraArgs:t,disableCookiesSameSiteNoneRequiresSecure:p.disableCookiesSameSiteNoneRequiresSecure,seleniumCapsFileContent:r,shouldMonitorPerformance:p.monitorPerformance,user:p.user,lightweightMode:p.lightweightMode,createPrefechedData:p.createPrefechedData,saveRCALocally:p.saveRcaLocally,exitCodeIgnoreFailingTests:p.exitCodeIgnoreFailingTests,disableSockets:p.disableSockets,intersections:{labels:p.intersectWithLabel.length?[p.intersectWithLabel].flat():void 0,suiteNames:p.intersectWithSuite.length?[p.intersectWithSuite].flat():void 0,suiteIds:p.intersectWithSuiteId.length?[p.intersectWithSuiteId].flat():void 0,applyIntersectionsToBeforeAndAfterSections:p.applyIntersectionsToBeforeAndAfterSections},downloadBrowser:p.downloadBrowser,slotService:"mongo",printGrids:p.printGrids,printFinalCaps:p.printFinalCaps}}});var rd,QI,Ds,pT,dT,sd,mT,fT=v(()=>{"use strict";B();X();$();Cn();rd=C("testimNgrok"),QI=".whitelisted-ngrok.testim.io",Ds="",dT=async(s,e={})=>{if(!e.ngrokToken)throw new A("tunnel feature is not enabled, please contact support - info@testim.io.");let t;e.isNgrokWhitelisted&&(t=`${re()}-${s.projectData.projectId}${QI}`);let r={proto:"http",addr:s.tunnelPort||80,authtoken:e.ngrokToken,hostname:t};s.tunnelHostHeader&&(r.host_header=s.tunnelHostHeader),s.tunnelRegion&&(r.region=s.tunnelRegion);let i=await(await ut("ngrok")).connect(r);s.tunnelUseHttpAddress&&i.startsWith("https://")?(rd.info("replace https to http"),Ds=i.replace("https://","http://")):Ds=i,s.tunnelDiagnostics&&sd(),s.baseUrl=Ds},sd=async(s=!0)=>{try{let t=(await ut("ngrok")).getApi(),{tunnels:r}=await t.listTunnels(),n=r.find(i=>i.public_url===Ds);console.log("ngrok stats",n),rd.info("ngrok stats",{tunnel:n})}catch(e){rd.error("error collecting ngrok stats",{err:e})}s&&(pT=setTimeout(()=>sd(),1e4))},mT=async s=>{if(!Ds)return;clearTimeout(pT),s.tunnelDiagnostics&&await sd(!1),await(await ut("ngrok")).disconnect(Ds)}});var lr,id,gT,eR,tR,nd,Qa,ec,Za,rR,hT,yT,bT=v(()=>{"use strict";lr=I(require("os")),id=I(require("fs")),gT=I(require("child_process"));B();ge();eR="https://github.com/cloudflare/cloudflared/releases/download/2024.1.5/",tR={win32ia32:{path:"cloudflared-windows-386.exe"},win32x64:{path:"cloudflared-windows-amd64.exe"},darwinx64:{path:"cloudflared-darwin-amd64.tgz",extract:!0},linuxia32:{path:"cloudflared-linux-386"},linuxx64:{path:"cloudflared-linux-amd64"}},nd=lr.tmpdir(),Qa=`${nd}/cloudflared`,ec=null,Za=null,rR=async()=>{if(await ye(Qa))return;let e=tR[lr.platform()+lr.arch()];if(!e)throw new Error(`tunnel on ${lr.platform()+lr.arch()} platform is not supported.`);let t=e.extract?nd+e.path:Qa;await Je(`${eR}/${e.path}`,t),e.extract&&await ot(t,nd),await id.promises.chmod(Qa,"755")},hT=async s=>{let e=s.baseUrl||`http://localhost:${s.tunnelPort||80}`,t="tunnelRoutes"in s&&s.tunnelRoutes||[e],[r]=await Promise.all([Lp(s.company.companyId,t),rR()]);ec=r._id,Za=gT.spawn(Qa,["tunnel","--no-autoupdate","run","--token",r.token],{stdio:"inherit"}),await Dp(s.company.companyId,ec),"tunnelRoutesOutput"in s&&s.tunnelRoutesOutput&&await id.promises.writeFile(s.tunnelRoutesOutput,JSON.stringify(r.routesMapping,null,2)),s.baseUrl=`${s.tunnelUseHttpAddress?"http":"https"}://${r.routesMapping[e]}`},yT=async s=>{let e=[];return ec&&e.push(Np(s.company.companyId,ec)),Za&&e.push(new Promise((t,r)=>{Za.on("close",n=>{n&&r(new Error(`tunnel process exited with code ${n}`)),t()}),Za.kill()})),await Promise.all(e)}});var od={};z(od,{connect:()=>rc,disconnect:()=>sc,serveTunneling:()=>iR});var tc,TT,wT,nR,rc,sc,iR,ad=v(()=>{"use strict";fT();An();bT();ct();tc=I(require("ora"));$();oe();Ao();TT=C("tunnel"),wT=s=>{var e;return[_.TESTIM_LAMBDATEST,_.HYBRID].includes((e=s.gridData)==null?void 0:e.type)&&s.gridData.tunnel==="lambdatest"},nR=s=>{var e;return s.tunnelRoutes||((e=s.gridData)==null?void 0:e.type)===_.HYBRID&&s.gridData.tunnel==="cloudflare"},rc=async s=>{if(!s.tunnel)return;let e=Er(),t;try{wT(s)?(t=(0,tc.default)("Starting testim lambdatest tunnel...").start(),await ne.connectTunnel(s)):nR(s)?(t=(0,tc.default)("Starting testim cloudflare tunnel...").start(),await hT(s)):(t=(0,tc.default)("Starting testim ngrok tunnel...").start(),await dT(s,e)),t.succeed()}catch(r){let n="Failed to start tunnel. Please contact support@testim.io";throw r.isInvalidCredsForLT&&(n="Could not connect to LambdaTest. Check your credentials and then try again."),TT.error("Failed to open tunnel",{err:r}),t==null||t.fail(n),new Error(r.isInvalidCredsForLT?`${n}
${r.stdoutResult}`:n)}},sc=async s=>{if(s.tunnel)try{wT(s)?await ne.disconnectTunnel(s):"tunnelRoutes"in s?await yT(s):await mT(s)}catch(e){let t="catch error - failed to close tunnel";throw TT.error(t,{err:e}),new Error(t)}},iR=async(s,e=new Promise(()=>{}))=>(await rc(s),ms(()=>sc(s)),await e)});var IT={};z(IT,{init:()=>AR,run:()=>ER});async function oR(s){let e=s.project,t=await Op(e);if(t!=null&&t.isExecutionBlocked)throw console.error("You have reached the limit of runs for the billing month, please upgrade your plan at https://www.testim.io/upgrade-contact-us?source=cli"),Ir(s.authData.uid,"execution-quota-surpassed",{projectId:e}),new Gs}function cR(s,e){var i,o,a,c,l,d,m,u,f,h,g,y,T;let t=Di(e.activePlan),r=s.parallel;if(t==="free"&&r>ST)throw new A(`The free plan allows only ${ST} parallel runs, please upgrade your plan at https://www.testim.io/upgrade-contact-us?source=cli. Run aborted`);if(e.followL2CPlan){let w=(i=s.projectData)!=null&&i.type?aR[s.projectData.type]:void 0,b=(o=e.activePlan)!=null&&o.premiumFeatures.parallelism&&w?(a=e.activePlan)==null?void 0:a.premiumFeatures.parallelism[w]:0;b&&r>b&&(console.warn(`It looks like your command used more parallel processing than your plan supports (${r} vs. ${b}).
We'll use the maximum of ${b} for now. To use more, you can adjust your command or upgrade your plan.`),s.parallel=b);let S=(l=(c=e.activePlan)==null?void 0:c.premiumFeatures)==null?void 0:l.tunnel;if(s.tunnel&&!S)throw new A("Tunnel is not allowed for your current plan, please upgrade your plan at https://www.testim.io/upgrade-contact-us?source=cli. Run aborted");let E=(m=(d=e.activePlan)==null?void 0:d.premiumFeatures)==null?void 0:m.runInTurboMode;s.lightweightMode&&!E&&(console.warn(`
Turbo mode is not allowed for your current plan, please upgrade your plan at https://www.testim.io/upgrade-contact-us?source=cli. Turbo mode disabled for this run.`),s.lightweightMode=void 0)}if(e.tvcLicense&&((u=s.gridData)==null?void 0:u.type)===_.TESTIM_TVC){let w=e.tvcLicense.expireAt||1;if(Date.now()>w&&!e.churnedByL2C)throw new A("Your license has expired. Please contact us at https://www.testim.io/upgrade-contact-us?source=cli to renew your license. Run aborted");let b=Number((h=(f=e.plan.premiumFeatures)==null?void 0:f.parallelism)==null?void 0:h.mobile);if(r>b)throw new A(`Your license allows only ${b} parallel runs. Please contact us to upgrade your license at https://www.testim.io/upgrade-contact-us?source=cli. Run aborted`)}if(e.tdcLicense&&((g=s.gridData)==null?void 0:g.type)===_.TESTIM_TDC){let w=e.tdcLicense.expireAt||1;if(Date.now()>w)throw new A("Your license has expired. Please contact us at https://www.testim.io/upgrade-contact-us?source=cli to renew your license. Run aborted")}let n=s.retentionDays;if(n){let w=(T=(y=e.activePlan)==null?void 0:y.premiumFeatures)==null?void 0:T.resultRetention;if(n>w)throw new A(`Retention days (${n}) cannot be greater than the company's retention days (${w}). Run aborted`)}if(Yt(s)){if(O.flags.removeMobileTrialRestrictions.isEnabled())return;let w=e.tvcLicense,b=e.tdcLicense;if(w!=null&&w.isPaid||b!=null&&b.isPaid)return;let S=e==null?void 0:e.createdAt;if(new Date(S)<new Date(O.flags.applyMobileRestrictionFromDate.getValue()))return;s.timeout>=6e5&&(s.timeout=6e5,console.warn("Mobile Trial projects are limited to 10 minutes of execution time. The timeout has been reduced to 10 minutes."));let k=s.retries;k&&k>=1&&(s.retries=0,console.warn("Mobile Trial projects are not allowed to have test retries."))}}async function lR(s){var e;if(!((e=s.lightweightMode)!=null&&e.disableQuotaBlocking))try{await oR(s)}catch(t){if([A,Gs].some(r=>t instanceof r))throw t;cd.error("could not validate cli account",{err:t})}}function uR(s){let e=Er();return xf({userId:e.uid,name:e.uid,traits:{projectId:s,company:{id:s,lastCIRun:Math.floor(Date.now()/1e3)}}})}async function pR(s,{disableResults:e=!1,disableRemoteStep:t=!1}){if(O.flags.useNewWSCLI.isEnabled()&&!e&&!t)return wt.connect(s);if(!t){let{remoteStepService:r}=await Promise.resolve().then(()=>(Fo(),gh));await r.init(s)}if(!e){let{testResultService:r}=await Promise.resolve().then(()=>(Bo(),bh));r.init(s)}}function dR(s,e){let{branch:t,autoDetect:r}=s;if(vf(e,r),!e&&!r)throw new A(`branch ${t} does not exist, run aborted.`)}async function mR(s,e){let{id:t,type:r}=e,i=ET.get(s,"company.activePlan.premiumFeatures.ttaForSalesforce")||r==="sfdc"||r==="desktopWeb"&&O.flags.sfdcHybridCompany.isEnabled(),o=wn();i&&(s.sfdcCredential=await kp({projectId:t,branch:o}))}function fR(s,e){let{id:t,name:r,activePlan:n={}}=e,i=Boolean(n.isPoc),o=Boolean(n.isStartUp),a=Di(n);a==="free"&&(s.newBrowserWaitTimeout=s.newBrowserWaitTimeout<vT?vT:s.newBrowserWaitTimeout),O.setCompanyId(t),O.setIsPOC(i),O.setIsStartUp(o),O.setPlanType(a),Ot.setPlanType(a),s.company={ucid:"",companyId:t,name:r,planType:a,isPOC:i,isStartUp:o,activePlan:n}}function gR(s,e){s.editorUrl=tt||e}function hR(s,e){s.allGrids=e}function yR(s,e){s.authData=e}function bR(s,e){let{id:t,name:r,type:n,defaults:i}=e;O.setProjectId(t),O.setProjectType(n),s.projectData={projectId:t,type:n,name:r,defaults:i}}async function TR(s){var e;s.gridData=await bf(s),(e=s.gridData)!=null&&e.name&&(s.grid=s.gridData.name)}function wR(s,e){s.mode=["android","ios"].includes(e.type||"")?"appium":s.mode}async function vR(s){let{project:e}=s,t={projectId:e};s.overrideMappingFile&&(bt("user-override-file",t),s.mockNetworkRules=await Gb(s.overrideMappingFile))}async function SR(s,e){U("in runner.js runRunner");let{project:t,remoteRunId:r,useLocalChromeDriver:n,useChromeLauncher:i}=s;r||(s.source=n||i?"cli-local":"cli"),await lR(s),U("in runRunner before tunnel.connect"),await rc(s),U("in runRunner after tunnel.connect");let a=await new Vr(e).run(s);return U("before tunnel.disconnect"),await sc(s),await xR(s.slotService,t,s.company.companyId),U("after tunnel.disconnect and gridService.keepAlive.end"),a}function IR(s){var e;Ot.shouldShowFreeGridRunWarning((e=s.gridData)==null?void 0:e.type)&&console.log(`
\x1B[4m\x1B[36mOur Free grid offers basic service performance.
If you need faster results, contact us to upgrade your plan and dramatically improve your tests\u2019 run times.\x1B[0m
`)}function RR(s,e,t){s==="redis"&&In.start(t,e),s==="mongo"&&bn.start(e)}async function xR(s,e,t){s==="redis"&&await In.end(t,e),s==="mongo"&&await bn.end(e)}async function AR(s){var h,g,y,T;U("start runner init");let{project:e,lightweightMode:t,useChromeLauncher:r,mode:n,disableSockets:i}=s,o=pR(e,{disableResults:i||Boolean((t==null?void 0:t.disableResults)&&(r||n===K.SELENIUM)),disableRemoteStep:i||Boolean(t==null?void 0:t.disableRemoteStep)});o.catch(()=>{});let{authData:a,companyByProjectId:c,projectById:l,branchName:d,allGrids:m,clientConfig:u}=await ai(s);if(c.disabled)throw new A("The company is disabled.");if(l.disabled)throw new A("The project is disabled.");if(s.printGrids){let w=m.sort((b,S)=>b.type.localeCompare(S.type));console.table(w.reduce((b,S)=>{class E{constructor(G,x){this.Type=G,this.Browsers=x}}let k=Object.entries(S.browsers||{"N/A":""}).map(D=>D.join(":")).join(", ");return b[S.name]=new E(S.type,k),b},{})),process.exit(0)}if(await o,U("after featureFlagsReady and socketConnected"),gR(s,u.editorUrl),fR(s,c),bR(s,l),wR(s,l),dR(s,d),hR(s,m),yR(s,a),await mR(s,l),await TR(s),cR(s,c),(h=s.extensionLocation)!=null&&h.length||(s.extensionLocation=[bg(s)]),O.flags.clearRunnerFileCache.isEnabled())try{await ss(),cd.info("runner file cache cleared")}catch(w){cd.error("failed to clear runner file cache",{err:w})}(g=s.lightweightMode)!=null&&g.disableLabs||await Fn.loadLabFeatures(l.id,c.activePlan),((y=s.lightweightMode)==null?void 0:y.type)==="turboMode"&&(O.flags.highSpeedMode.getValue()==="disabled"||s.company.planType==="free")&&delete s.lightweightMode,((T=s.lightweightMode)==null?void 0:T.type)==="turboMode"&&console.log(`
Turbo mode will ignore step delays. Test artifacts like screenshots and logs will only be saved for failed runs. For more information see our docs: https://help.testim.io/docs/turbo-mode`),RR(s.slotService,e,c.id),uR(e),await vR(s),IR(s);let f=wn();await Q.setOptions(s,f)}var ET,vT,ST,cd,aR,ER,RT=v(()=>{"use strict";ET=I(require("lodash"));B();ad();$e();as();ds();Rr();Rl();ge();ct();Xt();$();_t();ae();oe();X();Ep();Mo();hu();de();Sn();jp();_n();vT=30*60*1e3,ST=1,cd=C("runner");aR={desktopWeb:"web",mobileWeb:"web",android:"mobile",ios:"mobile",sfdc:"sfdc"};ER=SR});function xT(s){s.get("/",(e,t)=>{let r=ld();return t.status(200).json({success:!0,isTestimAgent:!0,startMode:r})}),s.get("/version",(e,t)=>{t.status(200).json({node:process.version,app:Ha()})}),s.get("/loginInfo",(e,t)=>{try{let r=JSON.parse(Buffer.from(e.query.info,"base64").toString());Kp({overwriteExisting:!1,projects:r}),t.status(200).end()}catch{t.status(400).end()}})}var AT=v(()=>{"use strict";Ja();ud();Up()});var pd,CT,Ns,nc,PT=v(()=>{"use strict";pd=I(require("chalk"));Ss();CT=require("express");$();X();Ns=C("cli-router"),nc=(0,CT.Router)();nc.post("/run",async(s,e)=>{let{code:t,stepId:r,incomingParams:n,context:i,testResultId:o,retryIndex:a,stepResultId:c,timeout:l,fileDataUrl:d}=s.body;if(typeof t!="string"||!r||!n||!i||!o||typeof a!="number"||!c||typeof l!="number"){e.status(400).json({success:!1,code:"invalid-params"});return}let m={stepId:r,testResultId:o,retryIndex:a,stepResultId:c,timeout:l,fileDataUrl:d,nodePackageParams:n.nodePackageParams};try{let u=await vs(t,r,n,i,o,a,c,l,d);u.success||(console.log(pd.default.red(u.result.resultValue)),Ns.error("CLI Action Failure",{message:u.result.resultValue,...m})),e.status(200).json({success:!0,data:u})}catch(u){Ns.error("failed to run cli code",{err:u,...m}),console.log(pd.default.red("failed to run cli code",u)),e.status(500).json({success:!1,code:"internal-error"})}});nc.post("/install",async(s,e)=>{let{stepId:t,testResultId:r,retryIndex:n,packageData:i,stepResultId:o,timeout:a}=s.body;if(!t||typeof i!="object"||!r||typeof n!="number"||!o||typeof a!="number"){e.status(400).json({success:!1,code:"invalid-params"});return}let c={stepId:t,testResultId:r,retryIndex:n,stepResultId:o,timeout:a,packageData:i};try{let l=await ws(t,r,n,i,o,a);Ns.info("installed packages successfully",c),e.status(200).json({success:!0,data:l})}catch(l){if(l instanceof At){Ns.error("failed to install node packages",{err:l,...c}),e.status(200).json({success:!1,code:"invalid-node-package",message:l.message});return}if(l instanceof ce){Ns.error("timeout installing node package",{err:l,...c}),e.status(200).json({success:!1,code:"timeout"});return}Ns.error("failed to install node packages",{err:l,...c}),e.status(500).json({success:!1,code:"internal-error"})}})});var kT=v(()=>{"use strict";PT()});var DT={};z(DT,{orchestrateRoutes:()=>CR});function CR(s){let e=(0,_T.default)();e.disable("x-powered-by"),s(e),e.use(dd.default.urlencoded({extended:!1,limit:"50mb"})),e.use((0,LT.default)()),e.use(dd.default.json({limit:"50mb"}));let r={methods:["GET","PUT","POST","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],credentials:!0,maxAge:86400,origin:We||Id?"*":["http://localhost:3000","https://app.testim.io","https://app.staging.testim.io","https://app-eu.staging.testim.io","https://app.dev.testim.io","https://app-eu.dev.testim.io","https://app-eu.prod.testim.io","https://playground.testim.io","chrome-extension://pebeiooilphfmbohdbhbomomkkoghoia","https://tta-crm.tricentis.com"]};return e.use("*",(0,OT.default)(r)),xT(e),e.use("/cliJs",nc),e.use((n,i)=>{i.status(404).send("Endpoint Not Found")}),e}var OT,_T,dd,LT,NT=v(()=>{"use strict";OT=I(require("cors")),_T=I(require("express")),dd=I(require("body-parser")),LT=I(require("compression"));AT();kT();ae()});var UT={};z(UT,{init:()=>PR});async function PR({agentPort:s,agentBind:e,project:t,token:r}){let{orchestrateRoutes:n}=await Promise.resolve().then(()=>(NT(),DT));return new Promise((i,o)=>{let a=()=>{};t&&(uf(t,r),a=u=>{u.use((f,h,g)=>{Object.assign(f,{project:t}),g()})});let c=n(a),l=MT.createServer(c);l.listen(s,e),l.on("error",d),l.on("listening",m);function d(u){if(u.syscall!=="listen")return o(u);switch(u.code){case"EACCES":case"EPERM":return o(new A(`Port ${s} requires elevated privileges`));case"EADDRINUSE":return o(new A(`Port ${s} is already in use, is another Testim instance running?`));default:return o(u)}}function m(){let{port:u}=l.address();console.log(`Running on port: ${u}`),kR()}})}async function kR(){await require("prompts")({name:"",type:"text",message:'Type the word "stop" or Press Ctrl + C.',validate:t=>t.toUpperCase().trim()==="STOP"}),console.log("Exiting Testim CLI"),process.exit(0)}var MT,FT=v(()=>{"use strict";MT=I(require("http"));ct();X()});var HT={};z(HT,{getStartedWithStart:()=>ld,runAgentMode:()=>DR});async function DR(s){var r;let e;if(await vr(s.playerLocation,s.canary),s.startTestimBrowser){await UR();try{e=await MR(s)}catch(n){throw(r=n==null?void 0:n.message)!=null&&r.includes("user data directory is already in use")?new A('Please close all chrome browsers that were opened with "testim start" and try again'):n}}let t=await Promise.resolve().then(()=>(FT(),UT));return e!=null&&e.webdriverApi&&setTimeout(()=>{setTimeout(()=>(Qu(),qe(eb)))},6e3),t.init(s)}function ld(){return VT}function BT(s){try{return process.kill(s,0)}catch{return!1}}async function NR(s,e,t){let r=ur.join($t,`chrome-${dn}-process`),n=3e3,i=()=>{ke.rmSync(r,{recursive:!0}),console.log(`

Browser session ended`),process.exit(0)};if(await ye(r)){let f=JSON.parse(ke.readFileSync(r));if(BT(f.pid)){let h=()=>BT(f.pid)?setTimeout(h,n):i();return h(),{webdriverApi:f}}}let o=await Ji();await ye(Ms)||await ke.promises.mkdir(Ms,{recursive:!0});let c=[...GT(Ms,e,t,o).desiredCapabilities.chromeOptions.args,...oc.Launcher.defaultFlags().filter(f=>!["--disable-extensions","--disable-component-extensions-with-background-pages"].includes(f))],l={GOOGLE_API_KEY:"AIzaSyCkfPOPZXDKNn8hhgu3JrA62wIgC93d44k",GOOGLE_DEFAULT_CLIENT_ID:"811574891467.apps.googleusercontent.com",GOOGLE_DEFAULT_CLIENT_SECRET:"kdloedMFGdGla2P1zacGjAQh"},d=s.extensionPath?"http://localhost:3000/app/":new URL("?startMode=true",tt||mr).href,m=await oc.launch({chromeFlags:c,startingUrl:d,ignoreDefaultFlags:!0,userDataDir:Ms,chromePath:o,envVars:l}),u={port:m.port,pid:m.pid,cdpUrl:await br(`localhost:${m.port}`)};return ke.writeFileSync(r,JSON.stringify(u)),m.process.once("exit",i),m.process.once("close",i),{webdriverApi:u}}async function MR(s){let e=`${Dd}/extension/testim-full-master.zip`,t=ur.basename(e),r=ur.join($t,t),n=ur.join($t,`${t}__unzipped__`),i=!(s.ext||s.extensionPath);if(i&&await ye(r)){let f=await ke.promises.stat(r);i=Date.now()-_R>f.mtimeMs}if(await ke.promises.mkdir($t,{recursive:!0}),i){let f=(0,$T.default)("Downloading Testim Editor").start();await Je(e,r);try{await ot(r,n)}catch{await ke.promises.rm(r,{recursive:!0,force:!0}),await Je(e,r);try{await ot(r,n)}catch{throw await ke.promises.rm(r,{recursive:!0,force:!0}),f.fail("Failed to download Testim Editor"),new Error("Failed to download Testim Editor")}}finally{s.downloadBrowser||await ke.promises.rm(n,{recursive:!0,force:!0})}f.succeed()}let o=s.extensionPath?null:(await ke.promises.readFile(s.ext||r)).toString("base64");if(s.downloadBrowser)return await NR(s,o,n);await cn({projectId:s.project},{chromeBinaryLocation:s.chromeBinaryLocations});let a=GT(Ms,o,s.extensionPath,s.chromeBinaryLocations),{WebDriver:c}=(Un(),qe(Jg)),{SeleniumPerfStats:l}=(gs(),qe(pg)),d=new c;d.seleniumPerfStats=new l;let m=await d.initClient(a);VT=!0;let u=`${s.extensionPath?"http://localhost:3000/app/":tt||mr}?startMode=true`;await d.url(u),Object.assign(d,{initialUrl:u});try{d.cdpUrl=await br(m.value["goog:chromeOptions"].debuggerAddress)}catch{}return{webdriverApi:d}}function GT(s,e,t,r){let n=e?[e]:[],i=[`--user-data-dir=${s}`,"--log-level=OFF","--silent-debugger-extension-api","--no-first-run"];t&&i.push(`--load-extension=${t}`);try{let o=Po();o.length&&o.forEach(a=>i.push(`--disable-features=${a}`))}catch{}return{logLevel:OR,desiredCapabilities:{chromeOptions:{args:i,extensions:n,binary:r},browserName:"chrome"},host:"localhost",port:9515}}async function UR(){if(await ye(ic))try{let{webSocketDebuggerUrl:s}=await FR();await BR(s),await ke.promises.unlink(ic)}catch(s){s&&s.message==="unable to connect to devtools http server"&&await ke.promises.unlink(ic)}}async function FR(){let s=await ke.promises.readFile(ic,{encoding:"utf8"}),[e,t]=s.split(`
`).map(i=>i.trim()),r=Number.parseInt(e,10);if(!Number.isInteger(r)||r<1||r>65535)throw new Error("invalid port number");if(!t.startsWith("/devtools/browser/"))throw new Error("invalid devtools browser url");let n=await br(`localhost:${r}`,500);if(!n.endsWith(t))throw new Error("invariant webSocketDebuggerUrl miss match");return{port:r,webSocketDebuggerUrl:n}}async function BR(s,e=100){let t=await jR(s,e);return Jt(r=>{t.send(JSON.stringify({id:0,method:"Browser.close"}),r)})}async function jR(s,e=100){let t=Ua({timeout:e}),r=new WT.default(s,t),n=Jt(o=>{r.once("open",o)}).then(()=>{r.removeAllListeners()}),i=Jt(o=>{r.once("error",o)}).catch(()=>{r.close(),r.removeAllListeners()});return Promise.race([n,i]).then(()=>r)}var jT,$T,WT,ke,ur,oc,OR,_R,Ms,LR,ic,VT,ud=v(()=>{"use strict";jT=I(require("ms")),$T=I(require("ora")),WT=I(require("ws")),ke=I(require("node:fs")),ur=I(require("node:path")),oc=I(require("chrome-launcher"));ae();un();X();dl();B();Oo();Fa();OR=Ti?"verbose":"silent",_R=(0,jT.default)("1h"),Ms=ur.join($t,"profile"),LR="DevToolsActivePort",ic=ur.join(Ms,LR);VT=!1});var UN=require("source-map-support/register");var hi=I(require("os")),Fs=I(require("url")),Bs=I(require("http")),lc=I(require("https")),ui=I(require("form-data")),pi=class{constructor(){this.onloadstart=null;this.onprogress=null;this.onabort=null;this.onerror=null;this.onload=null;this.ontimeout=null;this.onloadend=null;this._listeners={}}addEventListener(e,t){e=e.toLowerCase(),this._listeners[e]||=[],this._listeners[e].push(t)}removeEventListener(e,t){let r;e=e.toLowerCase(),this._listeners[e]&&(r=this._listeners[e].indexOf(t),r!==-1&&this._listeners[e].splice(r,1))}dispatchEvent(e){var n;e.currentTarget=this,e.target=this;let t=e.type,r=this._listeners[t]||[];for(let i of r)i==null||i.call(this,e);(n=this[`on${t}`])==null||n.call(this,e)}},di=class extends pi{constructor(t){super();this._request=t;this._contentType=null;this._body=null}_reset(){this._contentType=null,this._body=null}_setData(t){if(t!=null)if(typeof t=="string")t.length!==0&&(this._contentType="text/plain;charset=UTF-8"),this._body=Buffer.from(t,"utf8");else if(Buffer.isBuffer(t))this._body=t;else if(t instanceof ArrayBuffer){let r=Buffer.alloc(t.byteLength),n=new Uint8Array(t);for(let i=0;i<t.byteLength;i++)r[i]=n[i];this._body=r}else if("buffer"in t&&t.buffer instanceof ArrayBuffer){let r=Buffer.alloc(t.byteLength),n=t.byteOffset,i=new Uint8Array(t.buffer);for(let o=0;o<t.byteLength;o++)r[o]=i[o+n];this._body=r}else if(typeof t=="object"&&t instanceof ui.default)this._body=null;else throw new Error(`Unsupported send() data ${t}`)}_finalizeHeaders(t,r){this._contentType&&!("content-type"in r)&&(t["Content-Type"]=this._contentType),this._body&&(t["Content-Length"]=this._body.length.toString())}_startUpload(t){this._body&&t.write(this._body),t.end()}},Us=class{constructor(e){this.type=e;this.target=null;this.currentTarget=null;this.lengthComputable=!1;this.loaded=0;this.total=0;this.bubbles=!1;this.cancelable=!1}},mi=class extends Error{},fi=class extends Error{},gi=class extends Error{},pr=class extends Error{},xe=class extends pi{constructor(t){super();this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.nodejsHttpAgent=Bs.globalAgent;this.nodejsHttpsAgent=lc.globalAgent;this.nodejsBaseUrl=null;this._restrictedMethods={CONNECT:!0,TRACE:!0,TRACK:!0};this._restrictedHeaders={"accept-charset":!0,"accept-encoding":!0,"access-control-request-headers":!0,"access-control-request-method":!0,connection:!0,"content-length":!0,cookie:!0,cookie2:!0,date:!0,dnt:!0,expect:!0,host:!0,"keep-alive":!0,origin:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,via:!0};this._privateHeaders={"set-cookie":!1,"set-cookie2":!1};this._userAgent=`Mozilla/5.0 (${hi.type()} ${hi.arch()}) node.js/${process.versions.node} v8/${process.versions.v8}`;this.onreadystatechange=null;this.readyState=xe.UNSENT;this.response=null;this.responseText="";this.responseType="";this.status=0;this.statusText="";this.timeout=0;this.upload=new di(this);this._method=null;this._url=null;this._sync=!1;this._headers=null;this._loweredHeaders=null;this._mimeOverride=null;this._request=null;this._response=null;this._responseParts=null;this._responseHeaders=null;this._aborting=null;this._error=null;this._loadedBytes=0;this._totalBytes=0;this._lengthComputable=!1;this._anonymous=t==null?void 0:t.anon}static nodejsSet(t){xe.prototype.nodejsSet(t)}nodejsSet(t){if("httpAgent"in t&&(this.nodejsHttpAgent=t.httpAgent),"httpsAgent"in t&&(this.nodejsHttpsAgent=t.httpsAgent),"baseUrl"in t){let r=t.baseUrl;if(r!==null&&!Fs.parse(r,!1,!0).protocol)throw new mi("baseUrl must be an absolute URL");this.nodejsBaseUrl=r}}open(t,r,n){if(t=t.toUpperCase(),t in this._restrictedMethods)throw new gi(`HTTP method ${t} is not allowed in XHR`);let i=this._parseUrl(r);n===void 0&&(n=!0),this._method=t,this._url=i,this._sync=!n,this._headers={},this._loweredHeaders={},this._mimeOverride=null,this._setReadyState(xe.OPENED),this._request=null,this._response=null,this.status=0,this.statusText="",this._responseParts=[],this._responseHeaders=null,this._loadedBytes=0,this._totalBytes=0,this._lengthComputable=!1}setRequestHeader(t,r){if(this.readyState!==xe.OPENED)throw new pr("XHR readyState must be OPENED");let n=t.toLowerCase();this._restrictedHeaders[n]||n.startsWith("sec-")||n.startsWith("proxy-")||(r=r.toString(),n in this._loweredHeaders?(t=this._loweredHeaders[n],this._headers[t]=`${this._headers[t]}, ${r}`):(this._loweredHeaders[n]=t,this._headers[t]=r))}send(t){if(this.readyState!==xe.OPENED)throw new pr("XHR readyState must be OPENED");if(this._request)throw new pr("send() already called");switch(this._url.protocol){case"file:":this._sendFile();break;case"http:":case"https:":this._sendHttp(t);break;default:throw new fi(`XHR request to ${this._url.href} failed: unsupported protocol '${this._url.protocol}'. Please use supported protocols like HTTP, HTTPS, or file.`)}}abort(){this._request&&(this._request.abort(),this._setError(),this._dispatchProgress("abort"),this._dispatchProgress("loadend"))}getResponseHeader(t){var n;let r=t.toLowerCase();return((n=this._responseHeaders)==null?void 0:n[r])||null}getAllResponseHeaders(){return this._responseHeaders?Object.entries(this._responseHeaders).map(([t,r])=>`${t}: ${r}`).join(`\r
`):""}overrideMimeType(t){if([xe.LOADING,xe.DONE].includes(this.readyState))throw new pr("overrideMimeType() not allowed in LOADING or DONE");this._mimeOverride=t.toLowerCase()}_setReadyState(t){this.readyState=t;let r=new Us("readystatechange");this.dispatchEvent(r)}_sendFile(){throw this._url.method!=="GET"?new fi("The file protocol only supports GET"):new Error("Protocol file: not implemented")}_sendHttp(t){if(this._sync)throw new Error("Synchronous XHR processing not implemented");t!=null&&(this._method==="GET"||this._method==="HEAD")?t=null:t||="",this.upload._setData(t),this._finalizeHeaders(t),this._sendHxxpRequest(t)}_sendHxxpRequest(t){let r=this._url.protocol==="http:"?this.nodejsHttpAgent:this.nodejsHttpsAgent,i=(this._url.protocol==="http:"?Bs:lc).request({hostname:this._url.hostname,port:this._url.port,path:this._url.path,auth:this._url.auth,method:this._method,headers:this._headers,agent:r});typeof t=="object"&&t instanceof ui.default&&t.pipe(i),this._request=i,this.timeout&&i.setTimeout(this.timeout,()=>this._onHttpTimeout(i)),i.on("response",o=>this._onHttpResponse(i,o)),i.on("error",()=>this._onHttpRequestError(i)),this.upload._startUpload(i),this._request===i&&this._dispatchProgress("loadstart")}_finalizeHeaders(t){typeof t=="object"&&t instanceof ui.default&&Object.assign(this._headers,t.getHeaders()),this._headers.Connection="keep-alive",this._headers.Host=this._url.host,this._anonymous&&(this._headers.Referer="about:blank"),this._headers["User-Agent"]=this._userAgent,this.upload._finalizeHeaders(this._headers,this._loweredHeaders)}_onHttpResponse(t,r){if(this._request!==t)return;if([301,302,303,307,308].includes(r.statusCode)){this._url=this._parseUrl(r.headers.location),this._method="GET","content-type"in this._loweredHeaders&&(delete this._headers[this._loweredHeaders["content-type"]],delete this._loweredHeaders["content-type"]),"Content-Type"in this._headers&&delete this._headers["Content-Type"],delete this._headers["Content-Length"],this.upload._reset(),this._finalizeHeaders(),this._sendHxxpRequest();return}this._response=r,this._response.on("data",i=>this._onHttpResponseData(r,i)),this._response.on("end",()=>this._onHttpResponseEnd(r)),this._response.on("close",()=>this._onHttpResponseClose(r)),this.status=this._response.statusCode,this.statusText=Bs.STATUS_CODES[this.status],this._parseResponseHeaders(r);let n=this._responseHeaders["content-length"];n?(this._totalBytes=parseInt(n,10),this._lengthComputable=!0):this._lengthComputable=!1,this._setReadyState(xe.HEADERS_RECEIVED)}_onHttpResponseData(t,r){if(this._response===t)return this._responseParts.push(r),this._loadedBytes+=r.length,this.readyState!==xe.LOADING&&this._setReadyState(xe.LOADING),this._dispatchProgress("progress")}_onHttpResponseEnd(t){if(this._response===t)return this._parseResponse(),this._request=null,this._response=null,this._setReadyState(xe.DONE),this._dispatchProgress("load"),this._dispatchProgress("loadend")}_onHttpResponseClose(t){if(this._response!==t)return;let r=this._request;return this._setError(),r.abort(),this._setReadyState(xe.DONE),this._dispatchProgress("error"),this._dispatchProgress("loadend")}_onHttpTimeout(t){if(this._request===t)return this._setError(),t.abort(),this._setReadyState(xe.DONE),this._dispatchProgress("timeout"),this._dispatchProgress("loadend")}_onHttpRequestError(t){if(this._request===t)return this._setError(),t.abort(),this._setReadyState(xe.DONE),this._dispatchProgress("error"),this._dispatchProgress("loadend")}_dispatchProgress(t){let r=new Us(t);r.lengthComputable=this._lengthComputable,r.loaded=this._loadedBytes,r.total=this._totalBytes,this.dispatchEvent(r)}_setError(){this._request=null,this._response=null,this._responseHeaders=null,this._responseParts=null}_parseUrl(t){let r,n,i,o=this.nodejsBaseUrl===null?t:Fs.resolve(this.nodejsBaseUrl,t),a=Fs.parse(o,!1,!0);return a.hash=null,a.auth&&(i!=null||n!=null)&&(r=a.auth.indexOf(":"),r===-1?i||(i=a.auth):(i||(i=a.substring(0,r)),n||(n=a.substring(r+1)))),(i||n)&&(a.auth=`${i}:${n}`),a}_parseResponseHeaders(t){this._responseHeaders={},Object.entries(t.headers).forEach(([r,n])=>{let i=r.toLowerCase();this._privateHeaders[i]||(this._mimeOverride!==null&&i==="content-type"&&(n=this._mimeOverride),this._responseHeaders[i]=n)}),this._mimeOverride!==null&&!("content-type"in this._responseHeaders)&&(this._responseHeaders["content-type"]=this._mimeOverride)}_parseResponse(){let t=Buffer.concat(this._responseParts);switch(this._responseHeaders["content-encoding"]==="gzip"&&(t=require("zlib").gunzipSync(t)),this._responseParts=null,this.responseType){case"text":this._parseTextResponse(t);break;case"json":this.responseText=null;try{this.response=JSON.parse(t.toString("utf-8"))}catch{this.response=null}break;case"buffer":this.responseText=null,this.response=t;break;case"arraybuffer":{this.responseText=null;let r=new ArrayBuffer(t.length),n=new Uint8Array(r);for(let i=0;i<t.length;i++)n[i]=t[i];this.response=r;break}default:this._parseTextResponse(t)}}_parseTextResponse(t){try{this.responseText=t.toString(this._parseResponseEncoding())}catch{this.responseText=t.toString("binary")}this.response=this.responseText}_parseResponseEncoding(){let t=this._responseHeaders["content-type"],r=/;\s*charset=(.*)$/.exec(t);return t&&r?r[1]:"utf-8"}},_e=xe;_e.SyntaxError=mi,_e.ProgressEvent=Us,_e.SecurityError=gi,_e.XMLHttpRequest=xe,_e.InvalidStateError=pr,_e.XMLHttpRequestUpload=di,_e.UNSENT=0,_e.OPENED=1,_e.HEADERS_RECEIVED=2,_e.LOADING=3,_e.DONE=4;Object.assign(global,{xhr2:_e,XMLHttpRequest:_e});var qT=I(require("semver"));$e();jp();Xt();un();var md=I(require("chalk")),zT=require("node:events");oe();An();X();oe();so();$();var Hb=I(require("os")),$p=I(require("path")),Wp=I(require("chalk")),za=require("fs");ae();function qb(s){var e,t,r;if(!((e=s==null?void 0:s.message)!=null&&e.includes("SIGINT")))try{let n=Hb.homedir();(0,za.mkdirSync)($p.resolve(n,".testim_logs"),{recursive:!0});let i=$p.resolve(n,".testim_logs",`${new Date().toISOString().replace(/:|\./g,"_")}.log`);console.log("Oops :( The test runner has encountered an unexpected error. A complete log of this run can be found in:"),console.log(`	${i}`),Pd&&console.log(`Call stack: ${s==null?void 0:s.stack}`),(t=s==null?void 0:s.message)!=null&&t.includes("Unable to compile TypeScript")&&((r=s.stack)!=null&&r.includes("runner/src"))&&process.argv.some(o=>o.includes("player-require-path"))&&(console.log(Wp.default.red("Looks like you got a TypeScript compile error champ - but it's not a very good one because we use TypeScript in transpile-only mode")),console.log(Wp.default.red("change require('ts-node/register/transpile-only'); to require('ts-node/register'); for better errors"))),(0,za.writeFileSync)(i,`${s}
${s==null?void 0:s.stack}

${JSON.stringify(s,Object.getOwnPropertyNames(s),2)}`)}catch{}}an();var LI=C("process-handler"),zb=!1;function DI(s){return s instanceof Error?1:zb?0:(s||={},Object.values(s).some(({runnerStatus:t,success:r,testStatus:n,status:i})=>[t,i].includes(fe.SKIPPED)||[t,i].includes(fe.FAILED)&&n===Ye.EVALUATING?!1:r!==!0)?1:0)}function NI(){try{Qt("chromedriver").stop()}catch{}}function Kb(){zb=!0}async function Vp(s){s!=null&&s.stack&&(ls?console.error(s,s.stack):qb(s)),NI(),await LI.waitForFlush(),process.exit(DI(s))}ge();$();de();td();var $R=C("cli-entry");function WR(s){if(!qT.satisfies(process.version,s))throw new A(`Testim.io CLI supports Node.js ${s}. This condition was not satisfied with current version: ${process.version}`);let e=20,t=22,r=Number(process.versions.node.split(".")[0]),n=new Date("2026-04-30T00:00:00.000Z"),i=n<=new Date,o=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}).format(n);if(r<e)throw new A(`Testim.io CLI supports Node.js ${e} and above, please upgrade to a newer Node.js version`);if(r<t&&i)throw new A(`Testim.io CLI supports Node.js ${t} and above, please upgrade to a newer Node.js version`);r<t&&console.log(md.default.yellow(`Testim.io CLI will stop supporting Node.js < ${t} on ${o}. please upgrade to a newer Node.js version.`))}async function VR(){console.log("Starting Testim.io CLI");let[s,e]=await Promise.all([Promise.resolve().then(()=>(B(),Y)),Promise.resolve().then(()=>(td(),uT))]);U("Starting Testim.io CLI"),Kf(Vp);try{WR(s.getEnginesVersion())}catch(t){console.log("Argument Error:",t.message),process.exit(1)}try{await O.fetch({proxy:p.proxy});let t=await e.process();if(U("in main, after options.process"),Zd(global.proxyUri),zT.EventEmitter.defaultMaxListeners="parallel"in t&&t.parallel>10?t.parallel*3:30,Qd(t.project),Dm("token"in t&&typeof t.token=="string"?t.token:"anonymous_encrypt_key"),s.isInstallLazyDepsMode(t)){console.log("Lazy dependency installation started");let{installAllLazyDependencies:i}=await Promise.resolve().then(()=>(Cn(),Qf));return await i()}if(s.isLoginMode(t))return;if(s.isCreatePrefetchedDataMode(t)){await ss(),await ai(t);let{preloadTests:i}=await Promise.resolve().then(()=>(No(),lh));await i(t),!t.playerRequirePath&&t.mode!==K.EXTENSION&&await vr(t.playerLocation,t.canary);let o=await _m();o.success?console.log(`created prefetched data at ${ji()}`):console.error("failed to create prefetch data",o.error);return}let r=await Promise.resolve().then(()=>(RT(),IT));if(s.isTunnelOnlyMode(t)){await r.init(t);let{serveTunneling:i}=await Promise.resolve().then(()=>(ad(),od));await i(t);return}if(s.isAgentMode(t)){let{runAgentMode:i}=await Promise.resolve().then(()=>(ud(),HT));return i(t)}if(t.saveRCALocally){let{initServer:i}=await Promise.resolve().then(()=>(eu(),gg)),{port:o}=await i(t);t.localRCASaver=`http://localhost:${o}`}t.exitCodeIgnoreFailingTests&&Kb(),U("right before testRunner.init/prepareRunner.prepare"),await r.init(t);let n=await Vb(t);return U("right after testRunner.init/prepareRunner.prepare"),await r.run(t,n)}catch(t){if(t instanceof qr)return;let r=s.getArgsOnRemoteRunFailure();return r&&await Mp({...r,error:t.message}).catch(()=>{}),t instanceof A?(console.log(md.default.red("Argument Error:",t.message)),t):(console.log("Error:",t.message),$R.error("runner ended with unexpected error",{err:t}),t)}}VR().then(s=>{Array.isArray(s)&&s.length===0&&console.log("No tests ran"),Vp(s)});
//# sourceMappingURL=cli.js.map
