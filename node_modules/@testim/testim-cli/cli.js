#! /usr/bin/env node
"use strict";var nw=Object.create;var Kn=Object.defineProperty;var ow=Object.getOwnPropertyDescriptor;var iw=Object.getOwnPropertyNames;var aw=Object.getPrototypeOf,cw=Object.prototype.hasOwnProperty;var w=(s,e)=>()=>(s&&(e=s(s=0)),e);var W=(s,e)=>{for(var t in e)Kn(s,t,{get:e[t],enumerable:!0})},Nd=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of iw(e))!cw.call(s,n)&&n!==t&&Kn(s,n,{get:()=>e[n],enumerable:!(r=ow(e,n))||r.enumerable});return s};var E=(s,e,t)=>(t=s!=null?nw(aw(s)):{},Nd(e||!s||!s.__esModule?Kn(t,"default",{value:s,enumerable:!0}):t,s)),ie=s=>Nd(Kn({},"__esModule",{value:!0}),s);var Oe={};W(Oe,{log:()=>_,measure:()=>uw});function _(...s){if(!Ud)return;let e=Date.now();console.log(`${e-lw}			${e-Fd}			`,...s),Fd=e}function uw(s,e){if(!Ud)return;let t=Date.now();try{s()}finally{console.log(e||s.name,"took",Date.now()-t)}}var Ud,lw,Fd,Le=w(()=>{"use strict";Ud=process.env.MEASURE_TESTIM_CLI_PERFORMANCE,lw=Date.now(),Fd=Date.now()});var Ba,at,$a,Yr=w(()=>{"use strict";Ba={NULL:"\uE000",Unidentified:"\uE000",Cancel:"\uE001",Help:"\uE002","Back space":"\uE003",Backspace:"\uE003",Tab:"\uE004",Clear:"\uE005",Return:"\uE006",Enter:"\uE007",Shift:"\uE008",Control:"\uE009",Alt:"\uE00A",Pause:"\uE00B",Escape:"\uE00C",Space:"\uE00D"," ":"\uE00D",Pageup:"\uE00E",PageUp:"\uE00E",Page_Up:"\uE00E",Pagedown:"\uE00F",PageDown:"\uE00F",Page_Down:"\uE00F",End:"\uE010",Home:"\uE011","Left arrow":"\uE012",Arrow_Left:"\uE012",ArrowLeft:"\uE012","Up arrow":"\uE013",Arrow_Up:"\uE013",ArrowUp:"\uE013","Right arrow":"\uE014",Arrow_Right:"\uE014",ArrowRight:"\uE014","Down arrow":"\uE015",Arrow_Down:"\uE015",ArrowDown:"\uE015",Insert:"\uE016",Delete:"\uE017",Semicolon:"\uE018",Equals:"\uE019","Numpad 0":"\uE01A","Numpad 1":"\uE01B","Numpad 2":"\uE01C","Numpad 3":"\uE01D","Numpad 4":"\uE01E","Numpad 5":"\uE01F","Numpad 6":"\uE020","Numpad 7":"\uE021","Numpad 8":"\uE022","Numpad 9":"\uE023",Multiply:"\uE024",Add:"\uE025",Separator:"\uE026",Subtract:"\uE027",Decimal:"\uE028",Divide:"\uE029",F1:"\uE031",F2:"\uE032",F3:"\uE033",F4:"\uE034",F5:"\uE035",F6:"\uE036",F7:"\uE037",F8:"\uE038",F9:"\uE039",F10:"\uE03A",F11:"\uE03B",F12:"\uE03C",Command:"\uE03D",Meta:"\uE03D",Zenkaku_Hankaku:"\uE040",ZenkakuHankaku:"\uE040"},at="element-6066-11e4-a52e-4f735466cecf",$a=79});function z(s=16){let e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",t="";for(let r=0;r<s;r++){let n=Math.floor(Math.random()*e.length);t+=e[n]}return t}function ct(s,e,t,r,n){let o="";return n=n?encodeURIComponent(n):"master",e&&t&&(o=`${s}/#/project/${e}/branch/${n}/test/${t}`,r&&(o+=`?result-id=${r}`)),o}function Wa(s,e){return`Basic ${Buffer.from(`${s}:${e}`).toString("base64")}`}function Ge(s){let e=/^(https?:\/\/)/i,t=new RegExp("^(?:(?:(?:https?|ftp):)?\\/\\/)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z0-9\\u00a1-\\uffff][a-z0-9\\u00a1-\\uffff_-]{0,62})?[a-z0-9\\u00a1-\\uffff]\\.)+(?:[a-z\\u00a1-\\uffff]{2,}\\.?))(?::\\d{2,5})?(?:[/?#]\\S*)?$","i");return e.test(s)||t.test(s)}var Ga=w(()=>{"use strict"});var qa,jd,Bd,ro=w(()=>{qa={ngrok:"4.3.3",webpack:"5.74.0",playwright:"0.12.1",puppeteer:"2.1.1","selenium-webdriver":"3.6.0","v8-to-istanbul":"9.1.0","istanbul-lib-coverage":"3.2.0","@bcoe/v8-coverage":"0.2.3","convert-source-map":"1.7.0",multer:"1.4.5-lts.1"},jd={"@applitools/eyes-sdk-core":"13.11.29","@testim/coralogix-logger":"1.1.27-beta.1","@testim/webdriverio":"0.0.8","abort-controller":"3.0.0",ajv:"6.12.6","analytics-node":"5.0.0","appium-dom-utils":"1.0.6",archiver:"5.3.0","body-parser":"1.20.1",chalk:"4.1.2","chrome-launcher":"0.15.0","combine-source-map":"0.8.0",commander:"10.0.0",compression:"1.7.4",cors:"2.8.5","crypto-js":"4.1.1","data-uri-to-buffer":"2.0.2",decompress:"4.2.1",express:"4.17.3",fkill:"7.2.1","form-data":"3.0.0",glob:"7.2.0","https-proxy-agent":"5.0.0","istanbul-lib-report":"3.0.0","istanbul-reports":"3.1.5",jimp:"0.16.2",jsdom:"19.0.0",jsonwebtoken:"9.0.0",lodash:"4.17.21","memory-fs":"0.5.0",memorystream:"0.3.1",moment:"2.29.4",ms:"2.1.2",npm:"8.19.2","object-hash":"3.0.0",ora:"5.4.1","p-limit":"4.0.0","p-retry":"4.6.2",pako:"1.0.11",portfinder:"1.0.28","promise-queue":"2.2.5",prompts:"2.4.2","proxy-agent":"5.0.0","rox-node":"4.9.18",semver:"7.3.2","serialize-error":"7.0.1","socket.io-client":"4.5.4","source-map-support":"0.5.19",superagent:"3.8.3","superagent-proxy":"3.0.0","test-exclude":"6.0.0",threads:"0.12.0","ua-parser-js":"0.7.33","validate-npm-package-name":"3.0.0",webdriverio:"7.24.0",winston:"3.6.0","winston-transport":"4.5.0",ws:"8.5.0",xml2js:"0.4.23",yaml:"1.10.0"},Bd={node:">= 14.0.0"}});var Vs,$d,Wd,so,Gd,no,Xr,Vd,ge,qd,Hd,oo,Ne,Ha,FR,io,zd,UR,Kd,jR,Jd,Yd,Qr,Xd,Qd,Zd,le=w(()=>{"use strict";Vs=process.env.SERVICES_HOST||"https://services.testim.io",$d="https://testimstatic.blob.core.windows.net",Wd="https://tstresultfiles.azureedge.net";process.env.GATEWAY_URL&&(process.env.CORALOGIX_URL=`${process.env.GATEWAY_URL}/testim/coralogix/api/v1/logs`,process.env.SERVICES_HOST=`${process.env.GATEWAY_URL}/testim/services`,process.env.EXTENSION_SERVICES_HOST=process.env.TUNNEL_GATEWAY?process.env.SERVICES_HOST:Vs,Vs=process.env.SERVICES_HOST);so=parseInt(process.env.DISABLE_AGENT_ORIGIN_CHECK||"0",10),Gd=parseInt(process.env.DISABLE_DEBUGGER_INFINITE_TIMEOUT||"0",10),no=parseInt(process.env.OVERRIDE_TIMEOUTS||"0",10),Xr=process.env.EDITOR_URL,Vd=process.env.WEBSOCKET_HOST||`${Vs}/ws`,ge=Vs,qd=parseInt(process.env.LOGGER_CONSOLE||"0",10),Hd=parseInt(process.env.LOGGER_DEBUG||"0",10),oo=parseInt(process.env.WEBDRIVER_DEBUG||"0",10),Ne=parseInt(process.env.IS_ON_PREM||"0",10),Ha=process.env.REQUESTS_QUEUE_SIZE?parseInt(process.env.REQUESTS_QUEUE_SIZE,10):void 0,FR=parseInt(process.env.DEBUG_MODE||"0",10),io=process.env.TESTIM_CONCURRENT_WORKER_COUNT?parseInt(process.env.TESTIM_CONCURRENT_WORKER_COUNT,10):null,zd=process.env.ROLLOUT_KEY||"5b5560729601aa6484276518",UR=parseInt(process.env.DF_ENABLE_VIDEO||"0",10),Kd=parseInt(process.env.START_WORKER_DELAY_MS||"1500",10),jR=process.env.APPIUM_VERSION||"1.10.1",Jd=process.env.GATEWAY_URL,Yd=process.env.EXTENSION_SERVICES_HOST||Vs,Qr=process.env.GATEWAY_URL?`${process.env.GATEWAY_URL}/testim/blob`:$d,Xd=process.env.GATEWAY_URL?`${process.env.GATEWAY_URL}/testim/edge`:Wd,Qd=$d,Zd=Wd});var za={};W(za,{CoralogixTransport:()=>Zr});var Ie,ep,mw,fw,Zr,Ka=w(()=>{"use strict";Ie=require("@testim/coralogix-logger"),ep=E(require("winston-transport")),mw={silly:Ie.Severity.verbose,verbose:Ie.Severity.verbose,info:Ie.Severity.info,http:Ie.Severity.info,warn:Ie.Severity.warning,warning:Ie.Severity.warning,error:Ie.Severity.error,silent:Ie.Severity.verbose,critical:Ie.Severity.critical,crit:Ie.Severity.critical,debug:Ie.Severity.debug},fw=["err","error","reason","e"],Zr=class extends ep.default{constructor(t){t=Object.assign({},Zr.options,t);super(t);this.options=t,this.logger=new Ie.CoralogixLogger(t.category||""),this.name="Coralogix Transport",t.timestamp&&(this.timestamp=t.timestamp)}log(t,r){let{category:n,level:o,message:i,meta:a={},...c}=t,l=Object.assign({},a,this.options.extraFields,c),d=new Ie.Log;d.severity=mw[o],d.text=i,d.category=n,l.className&&(d.className=l.className),l.methodName&&(d.methodName=l.methodName),l.threadId&&(d.threadId=l.threadId),delete l.className,delete l.methodName,delete l.threadId,delete l.category,delete l.level,delete l.message;let m=!1;a instanceof Error&&(m=!0,l.msg=a.message+a.stack,i&&(l.msg=`${i}
${l.msg}`));for(let p of fw)a[p]instanceof Error&&(l[p]={message:a[p].message,stack:a[p].stack,name:a[p].name,type:a[p].type,cause:a[p].cause,...a[p]});Object.keys(l).length>0&&(i&&!m&&(l.msg=i),d.text=l),this.logger.addLog(d),r(null,!0)}waitForFlush(){return this.logger.waitForFlush()}static configure(t){Ie.CoralogixLogger.configure(t),Zr.options=t}}});var ec={};W(ec,{getLogger:()=>R,setExecutionId:()=>Xa,setProjectId:()=>Qa,setProxyUri:()=>Za});function yw(){let s=[],e=()=>Promise.resolve();if(!Ne){let{CoralogixTransport:t}=(Ka(),ie(za));t.configure(sp);let r=new t({category:"ROOT"});s.push(r),e=()=>r.waitForFlush()}return qd&&s.push(new Et.transports.Console({format:Et.format.combine(Et.format.colorize(),Et.format.simple())})),[s,e]}function Xa(s){Ja=s}function Qa(s){np=s}function Za(s){if(Ne||!s)return;let{CoralogixTransport:e}=(Ka(),ie(za));e.configure({...sp,proxyUri:s})}function tp(s){return{projectId:np,time:new Date().toISOString(),...Ja&&!s&&{executionId:Ja}}}function R(s){return new Ya(Ew.child({category:s}))}var rp,Et,hw,gw,sp,bw,ww,Tw,vw,Ew,Ja,np,Ya,j=w(()=>{"use strict";rp=E(require("os")),Et=E(require("winston"));le();U();hw=rp.hostname(),gw=lt(),sp={privateKey:"d0eb01da-f966-1663-63c6-8871225d7c39",applicationName:"testim",subsystemName:"runner"};[bw,ww]=yw(),Tw=Hd?"debug":"info",vw={release:Boolean(!0),branch:"production"},Ew=Et.createLogger({levels:Et.config.syslog.levels,level:Tw,transports:bw,defaultMeta:{name:"runner",hostname:hw,nodeVersion:process.version,runnerVersion:gw,...vw}}),Ja=null,np=null;Ya=class{constructor(e){this._logger=e;this.debug=this.debug.bind(this),this.info=this.info.bind(this),this.warn=this.warn.bind(this),this.error=this.error.bind(this),this.fatal=this.fatal.bind(this)}debug(e,t={}){this.innerLog("debug",e,t)}info(e,t={}){this.innerLog("info",e,t)}warn(e,t={}){this.innerLog("warning",e,t)}error(e,t={}){this.innerLog("error",e,t)}fatal(e,t={}){this.innerLog("crit",e,t)}innerLog(e,t,r={}){let{executionId:n}=r;try{this._logger.log(e,Object.assign({meta:r,message:t},tp(n)))}catch(o){try{this._logger.log("crit",Object.assign({message:`failed to log message ${o.message}, ${o.stack}`},tp(n)))}catch{}}}waitForFlush(){return ww()}}});var ip={};W(ip,{AbortError:()=>je,ArgError:()=>I,ClientError:()=>br,GetBrowserError:()=>zt,GridConcurrencyError:()=>yr,GridError:()=>dt,NoArgsError:()=>gr,NotImplementedError:()=>ts,NpmPackageError:()=>pt,NpmPermissionsError:()=>Tr,PageNotAvailableError:()=>ut,PlaygroundCodeError:()=>wr,QuotaDepletedError:()=>es,SeleniumCrashError:()=>qs,SeleniumError:()=>Lt,StopRunOnError:()=>Nt,TimeoutError:()=>J});var op,je,gr,I,Lt,Nt,zt,ut,J,es,dt,yr,pt,qs,br,wr,Tr,ts,q=w(()=>{"use strict";op=require("p-retry"),je=class extends Error{constructor(t="aborted"){super(t);this.name="AbortError"}},gr=class extends Error{constructor(){super(...arguments);this.name="NoArgsError"}},I=class extends Error{constructor(){super(...arguments);this.name="ArgError"}},Lt=class extends Error{constructor(t){super(t.orgStatusMessage||t.message);this.name="SeleniumError",this.errorType=t.type}},Nt=class extends Error{constructor(){super(...arguments);this.name="StopRunOnError"}},zt=class extends Error{constructor(t,r){super(t);this.type=r}},ut=class extends op.AbortError{},J=class extends Error{},es=class extends Error{},dt=class extends Error{constructor(){super(...arguments);this.name="GridError"}toString(){return this.message}},yr=class extends dt{constructor(){super(...arguments);this.name="GridConcurrencyError"}},pt=class extends Error{constructor(){super(...arguments);this.name="NpmPackageError"}},qs=class extends Error{constructor(){super(...arguments);this.message="selenium driver crashed";this.name="SeleniumCrashError"}},br=class extends Error{},wr=class extends Error{},Tr=class extends Error{constructor(t){super(`Testim had missing write access to ${t}`);this.path=t}},ts=class extends Error{constructor(e=!1){let t="not implemented";e&&(t="should be implemented on descendant"),super(t)}}});function ao(s){return!!s&&(typeof s=="object"||typeof s=="function")&&typeof s.then=="function"&&typeof s.catch=="function"}function se(s){return new Promise(e=>{setTimeout(e,s)})}function te(s,e,t="Timeout Error"){no&&!ap&&(ap=!0,console.log("Debugger connected - timeouts were overridden to 10 minutes to improve debugging"));let r=new J(t);return e=no?Number(no)||6e5:e,Promise.race([s,se(e).then(()=>{throw r})])}async function de(s,e,{concurrency:t}={}){if(t){cp||(cp=(await import("p-limit")).default);let r=cp(t);return await Promise.all(Array.from(s,(n,o)=>r(()=>e(n,o))))}return await Promise.all(Array.from(s,e))}function mt(s){return new Promise((e,t)=>{s((r,n)=>r?t(r):e(n))})}var ap,cp,tc=w(()=>{"use strict";q();le();ap=!1});var zs,lp,Sw,Hs,up,Rw,Iw,dp,pp=w(()=>{"use strict";zs=E(require("lodash"));le();lp=require("dns");j();tc();Sw=R("http-request-counters"),Hs=!1,up=async()=>{if(Ne)return!0;let s=["www.google.com","www.facebook.com","www.microsoft.com","testim.io"];try{let e=Boolean(await de(s,t=>lp.promises.lookup(t)));return e||(Hs=!0),e}catch{return Sw.error("network connectivity test failed"),Hs=!0,!1}},Rw=zs.throttle(up,10*1e3),Iw=60*1e3*15,dp=()=>{let s={call:new Map,success:new Map,fail:new Map};function e(n,o){let i=n.get(o)||0;n.set(o,i+1),setTimeout(()=>{let a=n.get(o)||1;n.set(o,a-1)},Iw)}function t(n,o=n.name){return async function(...i){e(s.call,o);try{let a=await n.call(null,...i);return e(s.success,o),a}catch(a){throw e(s.fail,o),Hs||Rw(),a}}}async function r(){if(Hs||!await up())return!1;let n=zs.sum([...s.fail.values()]),o=zs.sum([...s.call.values()]);return n<o*.1}return r.counters=s,t.counters=s,t.isNetworkHealthy=r,t.didNetworkConnectivityTestFail=()=>Hs,t}});var Dt={};W(Dt,{deleteFullRes:()=>kw,deleteReq:()=>Ks,didNetworkConnectivityTestFail:()=>cc,download:()=>ic,get:()=>Er,getFullRes:()=>Lw,getText:()=>Ow,head:()=>Nw,isNetworkHealthy:()=>ac,post:()=>Rt,postForm:()=>sc,postFullRes:()=>_w,put:()=>oc});function Pw(){return global.caFileContent}function Cw(s,e){let t=[];s.on("data",r=>{t.push(r)}),s.on("end",()=>{e(null,Buffer.concat(t))})}function Aw(){return!St.default.Request.prototype.proxy&&global.SuperagentProxy&&global.SuperagentProxy(St.default),global.proxyUri}function vr(s,e=!1){let t=Pw();t&&s.ca(t);let r=!e&&Aw();r&&s.proxy(r)}async function mp(s,e={},t={},r=rs){let n=St.default.delete(s).send(e).timeout(r).set(t);return vr(n),await n}async function fp(s,e,t={},r=rs,n=0){let o=St.default.post(s).send(e).timeout(r).set(t);vr(o),n&&o.retry(n);try{return await o}catch(i){throw i.url=s,i.originalRequestTimeout=r,i.additionalSetHeaders=t,i}}async function nc(s,e,t={},r=rs,{isBinary:n=!1,skipProxy:o=!1}={}){let i=St.default.get(s).query(e||{}).timeout(r).set(t);return n&&i.buffer(!0),vr(i,o),await i}var St,rc,qe,rs,xw,Kt,Ks,kw,Rt,_w,sc,Ow,Er,Lw,Nw,oc,ic,ac,cc,It=w(()=>{"use strict";St=E(require("superagent"));j();pp();rc=R("http-request"),qe=dp(),rs=parseInt(process.env.DEFAULT_REQUEST_TIMEOUT||"0",10)||3e4,xw=6e4;Kt=(s,e,t)=>{throw rc.error(s,{...t,error:e}),e};Ks=qe(async(s,e,t,r)=>{try{let n=await mp(s,e,t,r);return n.type==="text/plain"?n.text:n.body}catch(n){return Kt("failed to delete request",n,{url:s})}});kw=qe(mp),Rt=qe(async({url:s,body:e,headers:t,timeout:r,retry:n})=>{try{let o=await fp(s,e,t,r,n);return o.type==="text/plain"?o.text:o.body}catch(o){return Kt("failed to post request",o,{url:s})}});_w=qe(fp),sc=qe(async(s,e,t,r={},n=rs)=>{let o=St.default.post(s).type("form").timeout(n).set(r);o.field(e),Object.keys(t).forEach(i=>{o.attach(i,t[i].buffer,t[i].fileName)}),vr(o);try{let i=await o;return i.type==="text/plain"?i.text:i.body}catch(i){return Kt("failed to post request",i,{url:s})}});Ow=qe(async(s,e,t)=>{try{return(await nc(s,e,t)).text}catch(r){return Kt("failed to getText request",r,{url:s,query:e})}}),Er=qe(async(s,e,t,r,n)=>{try{return(await nc(s,e,t,r,n)).body}catch(o){return Kt("failed to get request",o,{url:s,query:e})}}),Lw=qe((s,e,t,r)=>nc(s,e,t,r)),Nw=qe(async s=>{let e=St.default.head(s).timeout(rs);vr(e);try{return await e}catch(t){return Kt("failed to head request",t,{url:s})}}),oc=qe(async(s,e,t={},r=rs)=>{let n=St.default.put(s).send(e).timeout(r).set(t);vr(n);try{return(await n).body}catch(o){return Kt("failed to put request",o,{url:s})}}),ic=qe(async s=>{rc.info("start to download",{url:s});let e=St.default.get(s).timeout(xw).buffer(!0).parse(Cw);vr(e);try{let t=await e;return rc.info("finished to download",{url:s}),t}catch(t){return Kt("failed to download",t,{url:s})}}),ac=qe.isNetworkHealthy,cc=qe.didNetworkConnectivityTestFail});function ft(){let s;return require.main?(require.main.filename.includes("/src")||require.main.filename.includes("\\src")?s=Mt.resolve(__dirname,"../../"):s=Mt.resolve(__dirname,""),s):process.cwd()}function co(s,e){return Ge(s)?e||Mt.join(process.cwd(),s.replace(/^.*[\\/]/,"")):e||Mt.basename(s)}function lt(){try{return require(`${__dirname}/package.json`).version}catch{return""}}function Mw(){try{return Bd.node}catch{return""}}async function uo(s,e,t=!0){let r=await He.promises.readdir(s,{withFileTypes:!0});await He.promises.mkdir(e,{recursive:t});for(let n of r){let o=Mt.join(s,n.name),i=Mt.join(e,n.name);n.isDirectory()?await uo(o,i):await He.promises.copyFile(o,i)}}async function be(s){try{return await He.promises.access(s),!0}catch(e){if(e.code==="ENOENT")return!1;throw e}}var Mt,hp,gp,He,Dw,Sr,ze,yp,lo,lc,tt,uc,dc=w(()=>{"use strict";Mt=E(require("path"));Ga();ro();hp=E(require("p-retry")),gp=E(require("decompress")),He=require("fs"),Dw=3;Sr=async s=>{let e=await Promise.resolve().then(()=>(It(),Dt));return(0,hp.default)(()=>e.download(s),{retries:Dw})},ze=async(s,e)=>{let t=await Sr(s);return He.promises.writeFile(e,t.body)},yp=async(s,e)=>new Promise((t,r)=>{try{let n=(0,He.createWriteStream)(e);(0,He.createReadStream)(s).pipe(n),n.on("finish",()=>{n.close(()=>t())})}catch(n){r(n)}});lo=async(s,e)=>{let t=co(s,e);return Ge(s)?ze(s,t):yp(s,t)},lc=async s=>Ge(s)?Sr(s):He.promises.readFile(s),tt=async(s,e)=>await(0,gp.default)(s,e),uc=s=>(0,He.statSync)(s).size/1e6});var Ut={};W(Ut,{CLI_MODE:()=>X,MOBILE_APP_SOURCE:()=>po,gridMessages:()=>ss,gridTypes:()=>ue,mobileWeb:()=>mc,runnerStatus:()=>pc,runnerTestStatus:()=>pe,sessionType:()=>Ft,socketEventTypes:()=>rt,stepResult:()=>Ys,test:()=>fc,testRunStatus:()=>Js,testStatus:()=>Ke,timeoutMessages:()=>Be});var Be,Js,pc,pe,Ke,ss,mc,fc,rt,X,Ft,ue,Ys,po,ae=w(()=>{"use strict";Be={GET_BROWSER_TIMEOUT_MSG:"get-browser-timeout",TEST_START_TIMEOUT_MSG:"test-start-timeout",TEST_COMPLETE_TIMEOUT_MSG:"test-complete-timeout"},Js={COMPLETED:"completed",RUNNING:"running"},pc={RUNNING:"RUNNING",SKIPPED:"SKIPPED",FINISHED:"FINISHED",ABORTED:"ABORTED",QUEUED:"QUEUED",TIMEOUT:"TIMEOUT"},pe={PASSED:"PASSED",FAILED:"FAILED",ABORTED:"ABORTED",SKIPPED:"SKIPPED",QUEUED:"QUEUED",PENDING:"PENDING"},Ke={DRAFT:"draft",EVALUATING:"evaluating",ACTIVE:"active",QUARANTINE:"quarantine"},ss={NOT_FOUND:"The specified grid is not available",UNKNOWN:"Test couldn't get browser - unknown error"},mc={MOBILE_WEB_REMOTE_RUN_HEADER_SPACING:50},fc={HIDDEN_PARAM:"TST_HIDDEN_PARAM"},rt={TEST_RESULT_CREATED:"test-result-created",TEST_RESULT_UPDATED:"test-result-updated",REMOTE_STEP_SAVED:"remote-step-saved"},X={EXTENSION:"extension",SELENIUM:"selenium",APPIUM:"appium"},Ft={CODELESS:"codeless",CODEFUL:"codeful"},ue={TESTIM_ENTERPRISE:"testimEnterprise",TESTIM:"testim",LAMBDATEST:"testimLambdaTest",DEVICE_FARM:"testimDF",HYBRID:"testimHybrid",BROWSERSTACK:"browserstack",SAUCELABS:"saucelabs",TESTIM_HEADSPIN:"testimHeadspin"},Ys={SETUP_TIMEOUT:"setup-timeout",NETWORK_ERROR:"network-error",GRID_ERROR:"grid-error",SELENIUM_ERROR:"selenium-error",BROWSER_CLOSED:"browser-closed"},po={FROM_LIBRARY:"from-library",FROM_DEVICE:"from-device"}});function Rr(s){return s.files.length>0?Ft.CODEFUL:Ft.CODELESS}function Xs(s,e){var t,r,n;return((t=s.testConfigNames)!=null&&t.length||(r=s.testConfigIds)!=null&&r.length||s.testPlan.length||s.testPlanIds.length)&&!s.browser?[...new Set(e.map(o=>{var i;return(i=o.runConfig)==null?void 0:i.browserValue}))]:[(n=s.browser)==null?void 0:n.toLowerCase()]}function Fw(){let{argv:s}=process;if(s.includes("--remoteRunId"))return{remoteRunId:s[s.indexOf("--remoteRunId")+1],projectId:s[s.indexOf("--project")+1],token:s[s.indexOf("--token")+1]}}var Qs,bp,Je,Uw,jw,Bw,$w,Ww,Gw,hc,wp=w(()=>{"use strict";ae();Qs=s=>{var e,t;return Boolean(((e=s.testPlan)==null?void 0:e.length)||((t=s.testPlanIds)==null?void 0:t.length))},bp=s=>Boolean(s.resultId&&s.source==="remote-run"),Je=(s,e)=>s.testStatus===Ke.QUARANTINE&&!bp(e)&&!e.runQuarantinedTests;Uw=s=>Boolean(s.initCodimMode),jw=s=>Boolean(s.loginMode),Bw=s=>Boolean(s.tunnelOnlyMode),$w=s=>Boolean(s.createPrefechedData),Ww=s=>Boolean(s.installLazyDepsMode),Gw=s=>Boolean(s.agentMode),hc=(s,e)=>{s.forEach((t,r)=>{e.has(t)&&(s[r]=`--${t}`)})}});function mo(s){let e=gc.default.duration(s);return`${e.hours()}:${e.minutes()}:${e.seconds()}.${e.milliseconds()}`}function yc(s){return gc.default.duration(s).asSeconds()}var gc,Tp=w(()=>{"use strict";gc=E(require("moment"))});var Zs,ns,en,vp=w(()=>{"use strict";Zs=s=>!(!s||"fileName"in s),ns=s=>{var e;return s&&"fileName"in s?(e=s.fileName)==null?void 0:e.endsWith(".app"):!1},en=s=>{var e,t;return((e=s.projectData)==null?void 0:e.type)==="ios"||((t=s.projectData)==null?void 0:t.type)==="android"}});var H={};W(H,{TESTIM_BROWSER_DIR:()=>jt,TimeoutError:()=>J,buildBasicHeader:()=>Wa,calcPercentile:()=>go,copy:()=>yp,copyDir:()=>uo,delay:()=>se,doesPathExist:()=>be,download:()=>Sr,downloadAndSave:()=>ze,extractElementId:()=>xe,getArgsOnRemoteRunFailure:()=>Fw,getBrowserInfo:()=>rn,getCdpAddressForHost:()=>Pr,getCliLocation:()=>ft,getDuration:()=>mo,getDurationSec:()=>yc,getEnginesVersion:()=>Mw,getEnvironmentGitBranch:()=>xr,getLocalFileSizeInMB:()=>uc,getPlanType:()=>ho,getRunConfigByBrowserName:()=>sn,getRunnerVersion:()=>lt,getSessionType:()=>Rr,getSource:()=>lo,getSourceAsBuffer:()=>lc,getSourcePath:()=>co,getTestUrl:()=>ct,getUniqBrowsers:()=>Xs,groupTestsByRetries:()=>wc,guid:()=>z,hasTestPlanFlag:()=>Qs,isAgentMode:()=>Gw,isAppForVirtualIosDevice:()=>ns,isAppFromDevice:()=>Zs,isCreatePrefetchedDataMode:()=>$w,isInitCodimMode:()=>Uw,isInstallLazyDepsMode:()=>Ww,isLoginMode:()=>jw,isMobileProject:()=>en,isPromise:()=>ao,isQuarantineAndNotRemoteRun:()=>Je,isRemoteRun:()=>bp,isTunnelOnlyMode:()=>Bw,isURL:()=>Ge,promiseFromCallback:()=>mt,promiseMap:()=>de,promiseTimeout:()=>te,removePropertyFromObject:()=>fo,replaceArgsWithNoDashes:()=>hc,unzipFile:()=>tt});function rn(s){return s=s.toLowerCase(),bc.find(e=>e.browserValue===s)}function sn(s,e,t){s=s.toLowerCase();let r=bc.find(o=>o.browserName.toLowerCase()===s||s.includes(o.synonyms))||bc[0],n=tn.find(o=>o.osName==="Windows 10");return e&&(e.platform?n=tn.find(o=>o.sl.platform===e.platform):e.platformName&&(n=tn.find(o=>o.sl.platformName===e.platformName))),t&&(t.os_version?n=tn.find(o=>o.bs.os_version===t.os_version):t.platform&&(n=tn.find(o=>o.bs.platform===t.platform))),Ir.merge(r,n)}function xr(){return process.env.GIT_BRANCH||process.env.CIRCLE_BRANCH||process.env.TRAVIS_BRANCH||process.env.CI_BRANCH}function fo(s,e,t){for(let r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t(r,e)?delete s[r]:typeof s[r]=="object"&&fo(s[r],e,t))}function xe(s){return s.ELEMENT||s[at]}function ho(s){s||(s={});let e=Date.now(),t=s.expireAt||s.expireAT;return s.plan!=="free"?"pro":t?t<e?"free":"trial":"free"}function wc(s=[]){return Ir.chain(s).groupBy(e=>e.originalTestResultId||e.resultId).values().reduce((e,t)=>{if(!t)return e;if(t.length===1)return e.push(t[0]),e;let r=Ir.orderBy(t,o=>typeof o.retryCount=="number"?o.retryCount:1),n=Ir.chain(r).last().cloneDeep().value();return n&&(n.retryTestResults=r,e.push(n)),e},[]).compact().value()}async function Pr(s,e){let t=await Promise.resolve().then(()=>(It(),Dt));try{return(await t.get(`http://${s}/json/version`,void 0,void 0,e)).webSocketDebuggerUrl}catch{throw new Error("unable to connect to devtools server")}}var Ep,Ir,Sp,Vw,jt,tn,bc,go,U=w(()=>{"use strict";Ep=E(require("os")),Ir=E(require("lodash")),Sp=E(require("path"));Yr();dc();wp();Tp();Ga();tc();vp();Vw=Ep.homedir(),jt=Sp.join(Vw,".testim-browser-profile"),tn=[{osName:"Linux",bs:{os:"LINUX"},sl:{platform:"Linux"}},{osName:"Windows 10",bs:{os:"WINDOWS",os_version:"10"},sl:{platform:"Windows 10"}},{osName:"Windows 8",bs:{os:"WINDOWS",os_version:"8"},sl:{platform:"Windows 8"}},{osName:"Windows 8.1",bs:{os:"WINDOWS",os_version:"8.1"},sl:{platform:"Windows 8.1"}},{osName:"Windows 7",bs:{os:"WINDOWS",os_version:"7"},sl:{platform:"Windows 7"}},{osName:"Windows XP",bs:{os:"WINDOWS",os_version:"XP"},sl:{platform:"Windows XP"}},{osName:"macOS Big Sur",bs:{os:"OS X",os_version:"Big Sur",safari_version:"14"},sl:{platform:"macOS 11",safari_version:"14"}},{osName:"macOS Catalina",bs:{os:"OS X",os_version:"Catalina",safari_version:"13"},sl:{platform:"macOS 10.15",safari_version:"13"}},{osName:"macOS Mojave",bs:{os:"OS X",os_version:"Mojave",safari_version:"12"},sl:{platform:"macOS 10.14",safari_version:"12"}},{osName:"macOS High Sierra",bs:{os:"OS X",os_version:"High Sierra",safari_version:"11"},sl:{platform:"macOS 10.13",safari_version:"11"}},{osName:"macOS Sierra",bs:{os:"OS X",os_version:"Sierra",safari_version:"10"},sl:{platform:"macOS 10.12",safari_version:"10.0"}},{osName:"OS X El Capitan",bs:{os:"OS X",os_version:"El Capitan",safari_version:"9.1"},sl:{platform:"OS X 10.11",safari_version:"9.0"}},{osName:"OS X Yosemite",bs:{os:"OS X",os_version:"Yosemite",safari_version:"8"},sl:{platform:"OS X 10.10",safari_version:"8.0"}},{osName:"OS X Mavericks",bs:{os:"OS X",os_version:"Mavericks",safari_version:"7.1"},sl:{platform:"OS X 10.9",safari_version:"7.0"}},{osName:"OS X Mountain Lion",bs:{os:"OS X",os_version:"Mountain Lion",safari_version:"6.2"},sl:{platform:"OS X 10.8",safari_version:"6.0"}},{osName:"OS X Lion",bs:{os:"OS X",os_version:"Lion",safari_version:"6"},sl:{}},{osName:"OS X Snow Leopard",bs:{os:"OS X",os_version:"Snow Leopard",safari_version:"5.1"},sl:{}},{osName:"iOS",bs:{platform:"MAC"},sl:{platformName:"iOS",appiumVersion:"1.6.4"}},{osName:"Android",bs:{platform:"ANDROID"},sl:{platformName:"Android",appiumVersion:"1.6.4"}}],bc=[{browserName:"Chrome",bs:{browser:"Chrome",browser_version:"94"},sl:{browserName:"chrome",version:"94.0"},browserValue:"chrome"},{browserName:"Firefox",bs:{browser:"Firefox",browser_version:"89"},sl:{browserName:"firefox",version:"89.0"},browserValue:"firefox"},{browserName:"Safari",bs:{browser:"Safari"},sl:{browserName:"safari"},browserValue:"safari"},{browserName:"Edge",bs:{browser:"Edge",browser_version:"18"},sl:{browserName:"MicrosoftEdge",version:"18.17763"},browserValue:"edge",eol:!0},{browserName:"Edge Chromium",bs:{browser:"Edge",browser_version:"94"},sl:{browserName:"MicrosoftEdge",version:"94"},synonyms:["edge-chromium"],browserValue:"edge-chromium",seleniumName:"MicrosoftEdge"},{browserName:"Internet Explorer 11",bs:{browser:"IE",browser_version:"11"},sl:{browserName:"internet explorer",version:"11.0"},synonyms:["ie11"],browserValue:"ie11",eol:!0},{browserName:"Browser",bs:{},sl:{browserName:"Browser"},browserValue:"browser"},{browserName:"Android",bs:{browserName:"android"},sl:{},browserValue:"android"},{browserName:"iPad",bs:{browserName:"iPad"},sl:{},browserValue:"ipad"},{browserName:"iPhone",bs:{browserName:"iPhone"},sl:{},browserValue:"iphone"}];go=(s,e)=>{if(s.length===0)return 0;if(typeof e!="number")throw new TypeError("p must be a number");if(s=[...s].sort((r,n)=>r-n),e<=0)return s[0];if(e>=100)return s.at(-1);let t=Math.ceil(s.length*(e/100))-1;return s[t]}});var Tc={};W(Tc,{$schema:()=>qw,default:()=>Yw,definitions:()=>Hw,properties:()=>Jw,required:()=>Kw,type:()=>zw});var qw,Hw,zw,Kw,Jw,Yw,Rp=w(()=>{qw="http://json-schema.org/draft-07/schema#",Hw={request:{type:"object",required:["url"],additionalProperties:!1,properties:{url:{type:"string"},method:{type:"string",pattern:"^GET$|^HEAD$|^POST$|^PUT$|^DELETE$|^CONNECT$|^OPTIONS$|^TRACE$|^PATCH$"}}},header:{type:"object",required:["name","value"],additionalProperties:!1,properties:{name:{type:"string"},value:{type:"string"}}},cookie:{type:"object",required:["name","value"],additionalProperties:!1,properties:{name:{type:"string"},value:{type:"string"},path:{type:"string"},domain:{type:"string"},expires:{type:"string",format:"date-time"},httpOnly:{type:"boolean"},secure:{type:"boolean"}}},response:{type:"object",required:["status"],additionalProperties:!1,properties:{status:{type:"integer",minimum:100,exclusiveMaximum:600},headers:{type:"array",items:{$ref:"#/definitions/header"}},cookies:{type:"array",items:{$ref:"#/definitions/cookie"}},content:{type:"object",required:["text"],additionalProperties:!1,properties:{text:{type:"string"}}}}},redirectResponse:{type:"object",required:["redirectUrl"],additionalProperties:!1,properties:{redirectUrl:{type:"string"}}},passthroughResponse:{type:"object",required:["passthrough"],additionalProperties:!1,properties:{passthrough:{type:"boolean",enum:[!0]}}},entry:{type:"object",required:["request","response"],additionalProperties:!1,properties:{request:{$ref:"#/definitions/request"},response:{oneOf:[{$ref:"#/definitions/response"},{$ref:"#/definitions/redirectResponse"},{$ref:"#/definitions/passthroughResponse"}]},maxHits:{type:"integer",minimum:1}}}},zw="object",Kw=["entries"],Jw={version:{type:"string",enum:["1.2","1.2.0"]},creator:{type:"string"},entries:{type:"array",items:{$ref:"#/definitions/entry"}}},Yw={$schema:qw,definitions:Hw,type:zw,required:Kw,properties:Jw}});async function _p(){try{return await te(yo.promises.readFile(vo()).then(async s=>{let e=await kp;return Zw(e,s)}),3e4)}catch{return{}}}function Zw(s,e){let t=e.slice(0,16),r=e.slice(16),n=Buffer.from(s),o=is.createDecipheriv("aes-256-cbc",Buffer.concat([n,Buffer.alloc(32)],32),t),i=o.update(r);return JSON.parse(Buffer.concat([i,o.final()]))}function ht(s,e,t=Xw,r=void 0){return async()=>{if(!Pp)return await s();let n=e;r&&(e+=JSON.stringify(r));let o=await eT(e);if(o)return nn.debug("cache hit:",{fnName:e}),o;if(nn.debug("cache miss:",{fnName:e}),!Cp)throw new Error(`Attempted to rebuild cache for ${n}. cache miss is not allowed with current run configuration`);let i=await s();return i&&await tT(e,i,t),i}}async function eT(s){let t=(await Eo)[s];if(!t)return;let{value:r,expiry:n}=t;if(!(n<Date.now())&&r)return r}async function tT(s,e,t){if(vc)throw nn.error("calling set after waitForSave is not allowed",{key:s,ttl:t}),new Error("calling set after waitForSave is not allowed");try{let r=await Eo;r[s]={value:e,expiry:Date.now()+t},Ap=new Promise(n=>{To=n}),Qw(r)}catch{nn.error("failed updating cache")}}async function Op(){let s=await Eo;Object.keys(s).forEach(e=>{delete s[e]})}function Lp(s){Pp=s}function rT(s=!0){Cp=s}async function Np(){try{return vc=!0,await Ap}finally{vc=!1}}function Dp(s){wo=s,Eo=_p()}var yo,bo,is,Ip,nn,wo,xp,To,Pp,Cp,vc,Ap,kp,Xw,vo,Eo,Qw,Mp,Fp,cI,Up,Jt=w(()=>{"use strict";yo=E(require("fs")),bo=E(require("path")),is=E(require("crypto"));U();Ip=require("lodash");j();nn=R("local cache"),wo=bo.resolve(ft(),"testim-cache"),Pp=!0,Cp=!0,vc=!1,Ap=new Promise(s=>{To=s}),kp=new Promise(s=>{xp=s}),Xw=1e3*60*60*3,vo=()=>bo.resolve(bo.resolve(wo,"testim.cache"));Eo=_p(),Qw=(0,Ip.debounce)(async s=>{let e;try{let t=await kp,r=is.randomBytes(16),n=JSON.stringify(s),o=Buffer.from(t),i=is.createCipheriv("aes-256-cbc",Buffer.concat([o,Buffer.alloc(32)],32),r),a=Buffer.concat([r,i.update(n),i.final()]);await be(wo)||await yo.promises.mkdir(wo,{recursive:!0}),await yo.promises.writeFile(vo(),a)}catch(t){nn.error("failed saving cache",{err:t}),e=t}To(e?{success:!1,error:e}:{success:!0})},200);Mp=xp,Fp=Lp.bind(void 0,!1),cI=Lp.bind(void 0,!0),Up=()=>rT(!1)});function So(){return{cliLocation:ft(),userInfo:as.userInfo(),platform:as.platform(),release:as.release()}}var as,Ec=w(()=>{"use strict";as=E(require("os"));U()});function sT(s){try{return Ro.resolve(Ro.dirname(require.resolve(`${s}/package.json`)),require(`${s}/package.json`).main||"")}catch(e){if(e.code==="ERR_PACKAGE_PATH_NOT_EXPORTED")return require.resolve(s);throw e}}function Yt(s){let e=sT(s);return require(e)}var Ro,on=w(()=>{"use strict";Ro=E(require("path"))});async function Wp(s){return(await Bp(`npm view ${s} version`)).stdout.trim()}function Rc(s){try{return Yt(s)}catch{return!1}}function Gp(s,e){return require(cs.join(s,`./node_modules/${e}/package.json`)).version}async function xo(s,e,t){function r(c){let d=/EACCES[^']+'(.+)'/.exec(c.stderr);return d===null?!1:d[1]}function n(c){return/The "to" argument must be of type string./.exec(c.stderr)}let o=cs.join(s,"npm-shrinkwrap.json"),i=cs.join(s,"npm-shrinkwrap-dummy.json"),a=!1;try{try{await be(o)&&(await Sc.promises.rename(o,i),a=!0)}catch{}return await Bp(`npm i ${e} --no-save --no-prune --prefer-offline --no-audit --progress=false`,{...t,cwd:s}).catch(c=>{let l=r(c),d=n(c);throw l||d?($p.info("Failed to install package due to insufficient write access",{...So(),package:e,path:l||s}),console.error(`

Testim failed installing the package ${e} due to insufficient permissions.
This is probably due to an installation of @testim/testim-cli with sudo, and running it without sudo.
Testim had missing write access to ${l||s}

`),new Tr(l||s)):c})}finally{if(a)try{await Sc.promises.rename(i,o)}catch{}}}function Vp(s,e,t,r){return new Promise((n,o)=>{let i=t?["--proxy",t]:[],a=t?{env:Object.assign(process.env,{HTTP_PROXY:t,HTTPS_PROXY:t})}:{},c="",l="",d="--no-save --no-package-lock --no-prune --prefer-offline --no-audit --progress=false".split(" "),m=(0,Io.spawn)("node",[nT,"i","--prefix",s,...d,...e,...i],a);m.stderr.pipe(process.stderr),m.stdout.pipe(process.stdout),m.stdout.on("data",p=>{c+=p}),m.stderr.on("data",p=>{l+=p}),m.on("close",p=>{var f;if(p){let h;try{let g=(f=/npm ERR! 404 {2}'(.+)' is not in the npm registry/gm.exec(l))==null?void 0:f[1];h=`404 Not Found - GET https://registry.npmjs.org/${g==null?void 0:g.split("@")[0]} - Not found`}catch{h=`Npm Install closed with exit code ${p}
 stdout: ${c} stderr: ${l}`}$p.debug(`Npm Install closed with exit code ${p}`,{message:h}),o(new pt(h))}else n(c)}),setTimeout(()=>{try{m.kill()}finally{o(new J)}},r)})}var Sc,cs,jp,Io,Bp,$p,nT,an=w(()=>{"use strict";Sc=E(require("fs")),cs=E(require("path"));U();jp=require("util"),Io=require("child_process");j();Ec();on();q();Bp=(0,jp.promisify)(Io.exec),$p=R("cli-service");nT=cs.resolve(require.resolve("npm").replace("index.js",""),"bin","npm-cli.js")});var Jp={};W(Jp,{install:()=>iT,isReady:()=>cT,start:()=>aT});var qp,Hp,zp,Kp,Ic,oT,iT,aT,cT,Yp=w(()=>{"use strict";qp=E(require("fkill")),Hp=E(require("p-retry"));an();It();U();on();zp="chromedriver",Kp=9515,Ic=`http://localhost:${Kp}/wd/hub`,oT=["--url-base=/wd/hub","--disable-build-check","--whitelisted-ips=0.0.0.0","--log-level=OFF"],iT=async()=>{await xo(ft(),`${zp} --detect_chromedriver_version`)},aT=async()=>{process.env.NODE_OPTIONS="",await(0,qp.default)(`:${Kp}`,{silent:!0}),await Yt(zp).start(oT,!0)},cT=async({chromeBinaryLocation:s})=>{await(0,Hp.default)(async()=>{var n;let e=await Er(`${Ic}/status`);if(!((n=e==null?void 0:e.value)!=null&&n.ready))throw new Error("status failed");let t={...s&&{binary:s}},r=await Rt({url:`${Ic}/session`,body:{desiredCapabilities:{browserName:"chrome",chromeOptions:t}},headers:{"Content-Type":"application/json"}});if(!r||r.status!==0||!r.sessionId)throw new Error("create session failed");await Ks(`${Ic}/session/${r.sessionId}`)},{retries:99,factor:1,minTimeout:30})}});var cn={};W(cn,{getSessionPlayerFolder:()=>Ac,prepareChromeDriver:()=>Ar,prepareCustomExtension:()=>Pc,prepareExtension:()=>Cc,preparePlayer:()=>kr});async function Pc(s,e=!1){if(!s)return;if(Ge(s)){let n=ls.join(process.cwd(),s.replace(/^.*[\\/]/,""));if(await lT(s)>xc&&!e)throw new I(Xp);return await ze(s,n),n}let t=ls.resolve(s);if(!Zp.existsSync(t))throw new I(`Failed to find custom extension in location: ${t}`);if(uc(t)>xc&&!e)throw new I(Xp);return t}async function lT(s){let e=(It(),ie(Dt));try{let r=(await e.head(s)).headers["content-length"];return(r?parseInt(r,10):0)/1e6}catch(t){throw Co.warn("failed to download custom extension",{err:t}),new I(`Failed to download custom extension from location: ${s}`)}}function Cc(s){Co.info("prepare extension",{locations:s});let e=s.map(t=>({location:t,path:co(t)}));return ht(()=>de(e,({location:t,path:r})=>lo(t,r)),"prepareExtension",tm,e)()}async function Ar(s={},e={},t=!1){let n=require("ora")("Starting Driver").start(),o=await Promise.resolve().then(()=>(Yp(),Jp));try{await o.install(),await o.start(),t||await o.isReady(e),n.succeed("Chrome Driver initiated successfully")}catch(i){let a="Failed to initiate Chrome Driver";throw i instanceof Tr||(Co.error(a,{...s,...So(),error:(0,em.serializeError)(i)}),console.log(`
1. If you don't have Chrome, please install it from https://www.google.com/chrome.
2. If Chrome is installed, please verify it's binary directory:
    - installed where chromedriver expects it (see https://github.com/SeleniumHQ/selenium/wiki/ChromeDriver#requirements).
    - exists in your PATH environment variables.
3. Try adding --chrome-binary-location flag to Testim CLI specifying the exact location of chrome binary in your computer (e.g on Windows "C:/Program Files/Google/Chrome/Application/chrome.exe").
4. You can always use a standalone Selenium grid and providing it's details with the --host and --port flags (see https://www.npmjs.com/package/selenium-standalone)`)),n.fail(a),i}}async function uT(){let s=`${Qr}/extension/sessionPlayer_LATEST_RELEASE`;return(await Sr(s)).body.toString("utf8")}async function dT(s,e){if(!Ge(s)||Ge(s)&&e||Ne)return s;let t=await uT();return`${s}-${t}`}function Ac(){let s=ft();return ls.resolve(s,"testim-bin")}function pT(){let s=Ac();return ls.resolve(s,"sessionPlayer.zip")}async function rm(s,e,t=!1){try{return await lo(s,e),await tt(e,Ac())}catch(r){if(t)throw r;return await rm(s,e,!0)}}async function kr(s,e){Co.info("prepare player",{location:s,canary:e});let t=pT();return ht(async()=>{let r=await dT(s,e);return await rm(r,t),{}},"preparePlayer",tm,[s,e,t])()}var Qp,Zp,ls,em,Co,tm,xc,Xp,us=w(()=>{"use strict";Qp=E(require("ms")),Zp=E(require("fs")),ls=E(require("path"));le();Jt();em=require("serialize-error");j();Ec();q();U();Co=R("prepare runner and testim start"),tm=(0,Qp.default)("0.5 day"),xc=16,Xp=`The size of the custom extension is more than ${xc}MB`});function mT(){let s=ln.type().toLowerCase();return s==="darwin"?ln.arch()==="arm"?"mac_arm":"mac":s==="windows_nt"?ln.arch()==="x64"?"win64":"win32":"linux"}async function ko(){let s=mT(),e="https://storage.googleapis.com/chromium-browser-snapshots",t={linux:"Linux_x64",mac:"Mac",mac_arm:"Mac_Arm",win32:"Win",win64:"Win_x64"};if(!(s in t))throw new I(`Unsupported platform: ${s}`);let r=parseInt(un,10)>591479?"chrome-win":"chrome-win32",n={linux:"chrome-linux",mac:"chrome-mac",mac_arm:"chrome-mac",win32:r,win64:r},o={linux:"chrome",mac:"Chromium.app/Contents/MacOS/Chromium",mac_arm:"Chromium.app/Contents/MacOS/Chromium",win32:"chrome.exe",win64:"chrome.exe"},i=`${e}/${t[s]}/${un}/${n[s]}.zip`,a=Ao.join(kc,n[s]),c=`${a}.zip`,l=Ao.join(a,o[s]);if(await be(l))return l;if(!await be(c)){let m=(0,_c.default)("Downloading Chromium").start();try{await sm.promises.mkdir(kc),await ze(i,c)}catch(p){let f=`Failed to download Chromium: ${p.message}`;throw m.fail(f),new Error(f)}m.succeed()}let d=(0,_c.default)("Extracting Chromium").start();try{await tt(c,kc)}catch(m){let p=`Failed to extract Chromium: ${m.message}`;throw d.fail(p),new Error(p)}return d.succeed(),l}var sm,ln,Ao,_c,un,kc,Oc=w(()=>{"use strict";sm=E(require("fs")),ln=E(require("os")),Ao=E(require("path")),_c=E(require("ora"));q();U();un="1000968",kc=Ao.join(jt,`chrome-${un}`)});async function om(s,e){return Oo=s,Mc=e,await Lc()}function im(s,e,t){st=s.token,Oo=e,Mc=t,pn=Fc(st),_o=s.refreshToken,Nc=s.ngrokToken,Dc=s.isNgrokWhitelisted}function fT(s=Oo,e=Mc){return ht(()=>(dn.info("request to get cli token from server"),Rt({url:`${ge}/auth/token`,body:{projectId:s,token:e}})),"getTokenV3",nm*10,{projectId:s,token:e})()}async function hT(){return dn.info("request to refresh JWT cli token from server"),st=(await Rt({url:`${ge}/auth/refreshToken`,body:{token:st,refreshToken:_o}})).token,pn=Fc(st),st}async function Lc(){try{let s=await fT();return dn.info("successfully get cli token from server"),st=s.token,pn=Fc(st),_o=s.refreshToken,Nc=s.ngrokToken,Dc=s.isNgrokWhitelisted,st}catch(s){throw s.message.includes("Unauthorized")?new I("Error trying to retrieve CLI token. Your CLI token and project might not match. Please make sure to pass `--project` and `--token` that match to each other or make sure they match in your ~/.testim file."):(dn.error(`While trying to retrieve CLI token. caught error: ${s}`,{projectId:Oo}),new I(`While trying to retrieve CLI token, caught error: ${s}`))}}function Fc(s){return require("jsonwebtoken").decode(s).exp*1e3}async function Xt(){if(!pn)return Lc();if(pn<Date.now()+4*nm)try{return await hT()}catch(s){return dn.error("failed to refresh token, executing fallback",s),Lc()}return st}function Lo(){return _o}function Bt(){return st?{uid:require("jsonwebtoken").decode(st).id,ngrokToken:Nc,isNgrokWhitelisted:Dc}:{}}var dn,st,pn,_o,Nc,Dc,Oo,Mc,nm,xt=w(()=>{"use strict";le();It();Jt();q();j();dn=R("testim-custom-token"),Oo=null,Mc=null,nm=5*60*1e3});var am={};W(am,{isCi:()=>ds});var ds,No=w(()=>{"use strict";ds=Boolean(process.env.CI||process.env.CONTINUOUS_INTEGRATION||process.env.BUILD_NUMBER||process.env.RUN_ID||!1)});var ve={};W(ve,{addTestRetry:()=>al,clearTestResult:()=>nl,deleteCloudflareTunnel:()=>dl,fetchLambdatestConfig:()=>tl,forceUpdateCloudflareTunnelRoutes:()=>ul,getAllGrids:()=>el,getAppDetails:()=>Hc,getApplitoolsIntegrationData:()=>cl,getCloudflareTunnel:()=>ll,getEditorUrl:()=>vT,getGridById:()=>Fo,getGridByName:()=>Qc,getHybridGridProvider:()=>Xc,getLabFeaturesByProjectId:()=>rl,getMobileDevicesFromGrid:()=>ml,getRealData:()=>hn,getS3Artifact:()=>fn,getSuiteTestList:()=>qc,getTestPlan:()=>TT,getTestPlanTestList:()=>Vc,getTestResults:()=>_r,getUsageForCurrentBillingPeriod:()=>zc,initializeUserWithAuth:()=>Zc,isTestResultCompleted:()=>Kc,keepAliveGrid:()=>Jc,loadSfdcCredential:()=>jc,loadTest:()=>Bc,releaseGridSlot:()=>Yc,reportExecutionFinished:()=>Mo,reportExecutionStarted:()=>Gc,saveRemoteStep:()=>ol,saveTestPlanResult:()=>$c,updateExecutionTests:()=>Wc,updateRemoteRunFailure:()=>pl,updateTestDataArtifact:()=>Uo,updateTestResult:()=>sl,updateTestStatus:()=>ps,uploadRunDataArtifact:()=>il});async function mn(){let s=await Xt();if(!s)throw new Error("Failed to get token from server");return{Authorization:`Bearer ${s}`}}async function nt({url:s,body:e,headers:t={},timeout:r,retry:n}){let o=await mn(),i=Object.assign({},t,o);return Rt({url:`${ge}${s||""}`,body:e,headers:i,timeout:r,retry:n})}async function bT(s,e,t,r={},n=void 0){let o=await mn(),i=Object.assign({},r,o);return await sc(`${ge}${s||""}`,e,t,i,n)}async function Do(s,e){let t=await mn();return await oc(`${ge}${s||""}`,e,t)}async function wT(s,e){let t=await mn();return await Ks(`${ge}${s||""}`,e,t)}async function Pe(s,e,t,r){let n=await mn();return await Er(`${ge}${s||""}`,e||void 0,n,r,t)}function fn(s,e){return(0,oe.default)(()=>Pe(`/storage${s}`,null,{isBinary:!0},e),{retries:ne})}async function TT(s,e){let t=n=>n==null?[]:typeof n=="string"&&JSON.parse(n)||n;return(await(0,oe.default)(()=>Pe("/testPlan",{projectId:s,name:e.join(",")}),{retries:ne})).map(({testConfigIds:n,beforeAllLabels:o,testLabels:i,afterAllLabels:a,...c})=>Object.assign(c,{testConfigIds:t(n),beforeAllLabels:t(o),testLabels:t(i),afterAllLabels:t(a)}))}async function jc({branch:s,projectId:e}){let t=await(0,oe.default)(()=>Pe(`/branch/branchData/${s}`,{projectId:e}),{retries:ne});return t==null?void 0:t.sfdcCredential}function Bc({testId:s,branch:e,projectId:t,skipSharedSteps:r=!1,useBranchMap:n=!0}){return(0,oe.default)(()=>Pe(`/test/${s}`,{projectId:t,branch:e,skipSharedSteps:r,useBranchMap:n}),{retries:ne})}function $c(s,e,t){return(0,oe.default)(()=>nt({url:"/testPlan/result",body:{projectId:s,testPlanId:e,result:t}}),{retries:ne})}function ps(s,e,t,r,n,o,i=ne){return(0,oe.default)(()=>Do("/result/run/test",{runId:e,testId:t,resultId:r,status:n,projectId:s,runnerVersion:gT,...o}),{retries:i})}function Wc(s,e,t,r,n,o,i,a){return(0,oe.default)(()=>Do("/result/run/tests",{runId:s,runnerStatuses:e,status:t,reason:r,success:n,startTime:o,endTime:i,projectId:a}),{retries:ne})}async function Gc({executionId:s,projectId:e,labels:t,startTime:r,executions:n,config:o,resultLabels:i,remoteRunId:a,localRunUserId:c,isLocalRun:l,intersections:d}){let{isCi:m}=await Promise.resolve().then(()=>(No(),am));return nt({timeout:9e4,url:"/result/run",body:{runId:s,projectId:e,labels:t,startTime:r,execution:n,status:"RUNNING",config:o,resultLabels:i,remoteRunId:a,intersections:d,metadata:{isCiRun:m,localRunUserId:c,isLocalRun:l}},retry:3})}function Mo(s,e,t,r,n={},o=void 0,i=void 0){let a=Date.now();return(0,oe.default)(()=>Do("/result/run",{runId:e,projectId:t,endTime:a,status:s,success:r,tmsOptions:n,remoteRunId:o,resultExtraData:i}),{retries:ne})}async function Vc(s,e,t,r,n){return(0,oe.default)(()=>nt({url:"/testPlan/list",body:{projectId:s,names:e,planIds:t,branch:r,intersections:n},timeout:12e4}),{retries:ne})}function qc({projectId:s,labels:e,testIds:t,testNames:r,testConfigNames:n,suiteNames:o,suiteIds:i,branch:a,rerunFailedByRunId:c,testConfigIds:l,intersections:d}){return(0,oe.default)(()=>nt({url:"/suite/v2/list",body:{projectId:s,labels:e,testIds:t,testNames:r,testConfigNames:n,suiteNames:o,suiteIds:i,branch:a,rerunFailedByRunId:c,testConfigIds:l,intersections:d}}),{retries:ne,factor:1})}async function Hc({appId:s,projectId:e}){try{return await(0,oe.default)(()=>Pe(`/mobile-app/app/${s}?projectId=${e}`),{retries:ne,factor:1})}catch(t){Wt.error("failed getting application details",{appId:s,error:t});return}}async function zc(s){try{return await(0,oe.default)(()=>Pe(`/plan/project/${s}/usage-current-billing-period`),{retries:ne})}catch(e){Wt.error("failed getting usage for current billing period",{projectId:s,error:e});return}}function Kc(s,e,t){return(0,oe.default)(()=>Pe(`/result/${s}/isComplete`,{projectId:e,testRetryKey:t}),{retries:ne})}function _r(s,e,t,r){return(0,oe.default)(()=>Pe(`/test/v2/${s}/result/${e}`,{projectId:t,branch:r}),{retries:ne,factor:1})}function Jc(s,e){return nt({url:`/grid/keep-alive?reqId=${z()}`,body:{projectId:s,slots:e},timeout:1e4})}function Yc(s,e,t,r,n){return nt({url:`/grid/release?reqId=${z()}`,body:{companyId:s,projectId:e,slotId:t,gridId:r,browser:n}})}function Xc(s){return nt({url:"/grid/hybrid/provider",body:s})}function Qc(s,e,t,r,n){return(0,oe.default)(()=>Pe("/grid/name",{companyId:s,projectId:e,name:t,browser:r,executionId:n,reqId:z()}),{retries:ne})}function Fo(s,e,t,r,n){return(0,oe.default)(()=>Pe(`/grid/${t}`,{companyId:s,projectId:e,browser:r,executionId:n,reqId:z()}),{retries:ne})}async function Zc({projectId:s,token:e,branchName:t,lightweightMode:r,localGrid:n}){var o,i;try{return await(0,oe.default)(()=>Rt({url:`${ge}/executions/initialize`,body:{projectId:s,token:e,branchName:t||"master",lightweightMode:r,localGrid:n}}),{retries:ne})}catch(a){throw Wt.error("error initializing info from server",a),(o=a==null?void 0:a.message)!=null&&o.includes("Bad Request")?new I("Error trying to retrieve CLI token. Your CLI token and project might not match. Please make sure to pass `--project` and `--token` that match to each other or make sure they match in your ~/.testim file."):(i=a==null?void 0:a.code)!=null&&i.includes("ENOTFOUND")?new I("Due to network connectivity issues, Testim CLI has been unable to connect to the Testim backend."):a}}async function vT(){if(Xr)return{editorUrl:Xr};try{return await(0,oe.default)(()=>Pe("/system-info/editor-url"),{retries:ne,onFailedAttempt:s=>{if(s.attemptNumber>=ne)throw s}})}catch{return Wt.error("cannot retrieve editor-url from server"),{editorUrl:"https://app.testim.io"}}}function el(s){return(0,oe.default)(()=>Pe("/grid",{companyId:s}),{retries:ne})}function hn(s,e,t){return(0,oe.default)(()=>Pe(`/real-data/${e}?${t}&projectId=${s}`),{retries:ne})}function sl(s,e,t,r,n){return(0,oe.default)(()=>nt({url:"/result/test",body:{projectId:s,resultId:e,testId:t,testResult:r,remoteRunId:n}}),{retries:ne})}function nl(s,e,t,r){return(0,oe.default)(()=>nt({url:"/result/test/clear",body:{projectId:s,resultId:e,testId:t,testResult:r}}),{retries:ne})}function ol(s,e,t,r){return(0,oe.default)(()=>nt({url:"/remoteStep",body:{projectId:s,resultId:e,stepId:t,remoteStep:r}}),{retries:ne})}function ET(s){return s.startsWith("/")?s:`/${s}`}function ST(s,e,t){let r=ET(s);return t&&(r=`/${t}${r}`),e&&(r=`/${e}${r}`),r}async function lm(s,e,t,r,n,o="application/octet-stream"){let i=null;o==="application/json"&&(i=".json");let a=`${n}_${z()}${i||""}`,c=`${e}/${t}/${a}`,l=ST(c,"test-result-artifacts",s),d=Buffer.from(cm.gzip(r,{level:3})),m={file:{fileName:a,buffer:d}};return await(0,oe.default)(()=>bT(`/storage${l}`,{},m,{"X-Asset-Encoding":"gzip"}),{retries:ne,factor:1}),l}function al({projectId:s,runId:e,testId:t,newResultId:r,originalTestResultId:n,previousTestResultId:o,testResult:i}){return(0,oe.default)(()=>nt({url:"/result/test/retry",body:{projectId:s,newResultId:r,originalTestResultId:n,previousTestResultId:o,testId:t,runId:e,testResult:i}}),{retries:ne})}async function cl(s){try{return await Pe(`/integration/applitools/v3/connected?projectId=${s}`)}catch(e){return Wt.warn("could'nt get applitools integration data.",{err:e}),{}}}async function ll(s,e){try{return await Do("/tunnel",{companyId:s,routes:e})}catch(t){return Wt.warn("could'nt get tunnel.",{err:t}),{}}}async function ul(s,e){try{return await nt({url:`/tunnel/${e}`,body:{companyId:s}})}catch(t){Wt.warn("could'nt get tunnel.",{err:t});return}}async function dl(s,e){try{return await wT(`/tunnel/${e}`,{companyId:s})}catch(t){Wt.warn("could'nt get tunnel.",{err:t});return}}function pl(s){return Rt({url:`${ge}/result/remoteRunFailure`,body:s})}async function ml({projectId:s,projectType:e,gridId:t,companyId:r,selectors:n}){let o=`${yT}/mobileDevices/${t}/${r}?projectType=${e}`;o=n?`${o}&selectors=${encodeURIComponent(n)}`:o;try{return await(0,oe.default)(()=>Pe(o,{projectId:s}),{retries:ne})}catch(i){return Wt.warn("could'nt get devices from headspin grid.",{err:i}),null}}var Qt,cm,oe,Uc,gT,Wt,ne,yT,tl,rl,il,Uo,Te=w(()=>{"use strict";Qt=E(require("lodash")),cm=E(require("pako"));U();le();ae();It();xt();oe=E(require("p-retry")),Uc=E(require("object-hash"));q();j();gT=lt(),Wt=R("testim service api"),ne=3,yT="/grid";tl=async()=>(0,oe.default)(()=>Pe("/grid/lt/config"),{retries:ne}),rl=async s=>(0,oe.default)(()=>Pe(`/labFeature/v2/project/${s}`),{retries:ne});il=Qt.memoize(async(s,e,t,r)=>{if(!Qt.isEmpty(r))return await lm(s,e,t,JSON.stringify(r),"test-run-data","application/json")},(s,e,t,r)=>`${(0,Uc.default)(r)}:${e}:${t}`),Uo=Qt.memoize(async(s,e,t,r,n)=>!r||Qt.isEmpty(r)?void 0:await lm(s,e,t,JSON.stringify((()=>{let i=Qt.clone(r);if(n!=null&&n.hiddenParams){let{hiddenParams:a}=n;(a||[]).forEach(c=>{i[c]&&Object.assign(i,{[c]:fc.HIDDEN_PARAM})})}return i})()),"test-test-data","application/json"),(s,e,t,r)=>`${(0,Uc.default)(r)}:${e}:${t}`)});var Or={};W(Or,{getSessionPlayer:()=>re,options:()=>hl});var jo,hl,fl,re,Ee=w(()=>{"use strict";jo=require("path"),hl={playerPath:void 0},re=()=>{if(fl)return fl;let s=(Le(),ie(Oe));s.log("getSessionPlayerRequire start");let{getSessionPlayerFolder:e}=(us(),ie(cn)),t=e(),r=hl.playerPath?(0,jo.resolve)(hl.playerPath,"src/background/sessionPlayerInit.ts"):(0,jo.join)(t,"sessionPlayer.js"),n=require(r);return s.log("getSessionPlayerRequire end"),fl=n,n}});function xT(s){process.nextTick(()=>{if([X.SELENIUM,X.APPIUM].includes(s))try{(Ee(),ie(Or)).getSessionPlayer(),require("jsdom")}catch{}})}async function gn(s){let{project:e,token:t,lightweightMode:r,useLocalChromeDriver:n,useChromeLauncher:o,mode:i}=s,a=Boolean(r==null?void 0:r.general),c=Boolean(n||o),l=a?IT:RT;_("before initializeUserWithAuth");let d=await ht(async()=>(xT(i),await Zc({projectId:e,token:t,branchName:s.branch,lightweightMode:r,localGrid:c})),"initializeUserWithAuth",l,{project:e,token:t,branchName:s.branch,lightweightModeGeneral:a,localGrid:c})();return _("after initializeUserWithAuth"),im(d.authData,s.project,s.token),d}var RT,IT,um=w(()=>{"use strict";Le();Te();Jt();xt();ae();RT=1e3*60*5,IT=1e3*60*60*10});async function mm(s){var o;let e=Promise.resolve(),t=!s.host&&!s.gridId&&!s.grid&&(!s.testPlan||s.testPlan.length===0),r=s.files.length!==0;(t&&r||s.useLocalChromeDriver)&&(s.chromeBinaryLocation=s.downloadBrowser?await ko():s.chromeBinaryLocation,e=Ar({projectId:s.project,userId:s.user},{chromeBinaryLocation:s.chromeBinaryLocation},Boolean((o=s.lightweightMode)==null?void 0:o.general)),s.useLocalChromeDriver=!0),!s.playerRequirePath&&s.mode!==X.EXTENSION&&await kr(s.playerLocation,s.canary),s.mode===X.EXTENSION&&!s.ext&&await Cc(s.extensionLocation);let n;if(s.installCustomExtension){let i=Boolean(s.useLocalChromeDriver||s.useChromeLauncher);n=await Pc(s.installCustomExtension,i)}return await e,n}async function fm(s){var i;PT.info("prepare MockNetwork",{location:s});let e=await lc(s),t=Buffer.isBuffer(e)?e:e.body;if(t.byteLength>dm*1e6)throw new Error(`${gl} exceeded ${dm}MB`);let r;try{r=JSON.parse(t.toString("utf-8"))}catch(a){throw new Error(`${gl} cannot be parsed.${Bo.EOL}${a}`)}let n=new pm.default;if(!n.validate(Tc,r)){let a=(i=n.errors)==null?void 0:i.map((c,l)=>`${++l}) ${c.dataPath} ${c.message}`).join(Bo.EOL);throw new Error(`${gl} is malformed.${Bo.EOL}${a}`)}return r.entries}var Bo,pm,dm,gl,PT,yl=w(()=>{"use strict";Bo=E(require("os"));U();Rp();us();pm=E(require("ajv"));ae();Oc();um();dm=1,gl="JSON file supplied to --mock-network-pattern",PT=(j(),ie(ec)).getLogger("prepare runner")});function gm(s,e=process){async function t(r){await te(de(hm,async n=>n()),1e4).catch(()=>null),s(r)}e.on("uncaughtException",async r=>{yn.error("Caught exception",{err:r}),console.log("Uncaught exception"),r.message&&console.log("Message =",r.message),r.reason&&console.log("Reason =",r.reason),await t(r)}),e.on("unhandledRejection",r=>{var n;if(yn.fatal("Caught unhandled promise rejection",r),!((n=r==null?void 0:r.message)!=null&&n.includes("ENOTFOUND x-api.rollout.io")))throw r}),e.on("rejectionHandled",()=>{yn.error("Caught rejection handled")}),e.once("SIGTERM",()=>{let r="Runner aborted - SIGTERM event",n=new Error(r);throw yn.error(r),t(n),n}),e.once("SIGINT",()=>{let r="Runner aborted - SIGINT event",n=new Error(r);throw yn.error(r),t(n),n}),e.once("exit",r=>{s(r)})}function ms(s){hm.push(s)}var yn,hm,bn=w(()=>{"use strict";j();U();yn=R("process-handler"),hm=[]});function vl(s,e){let t=s.canary?"-master.zip":".zip",r=`${e?Qd:Qr}/extension/testim-firefox-profile${t}`,n=`${e?Zd:Qr}/extension/testim-headless${t}`;return{firefox:r,chrome:n,"edge-chromium":n}}function vm(s){let{chrome:e,firefox:t}=vl(s,!1);return s.browser==="firefox"?t:s.browser==="chrome"?e:[e,t]}function Wo(s){let e=`${Qr}/extension/sessionPlayer`;return s.canary?`${e}-master`:e}var Go=w(()=>{"use strict";le()});function xm(s){Ne||(s!=null&&s.userId||(s={anonymousId:Im}),Rm.identify(s))}function gt(s,e){return fs("ci",s,e)}function fs(s,e,t){if(Ne)return;let r=s?{userId:s}:{anonymousId:Im};Rm.track(Object.assign(r,{event:e,properties:t}))}var Sm,Rm,Im,hs=w(()=>{"use strict";le();Sm=E(require("analytics-node")),Rm=new Sm.default("sJOSIGKa5x5rJEGsaOlCjrgozAf7FnVY",{flushAt:1}),Im=require("crypto").randomBytes(20).toString("hex")});function Pm(s){return s.start&&fs(null,"cli-start-command",{downloadBrowser:Boolean(s.downloadBrowser)}),!!(s.startV2||s.start||s.agent)}async function Cm(s){let e=["playground-playwright","playground-puppeteer","playground-selenium"],t=!1,r=!1,n=!1,o=!1;if(s.start&&(o=!0),Number.isNaN(s.agentPort))throw new I("Agent port is not number");if(typeof s.agent=="string"&&e.some(a=>s.agent.includes(a))){let a=s.agent.split(",").map(c=>c.trim());a.includes("playground-playwright")&&(t=!0),a.includes("playground-puppeteer")&&(r=!0),a.includes("playground-selenium")&&(n=!0)}let i=Wo(s);return console.log("Start Testim CLI on Agent mode"),{project:s.project,token:s.token,agentMode:!0,agentPort:s.agentPort,agentBind:s.agentBind,openEditor:s.openEditor,installPlaygroundPlaywrightDeps:t,installPlaygroundPuppeteerDeps:r,installPlaygroundSeleniumDeps:n,startTestimBrowser:o,ext:s.ext,extensionPath:s.extensionPath,playerLocation:s.playerPath||i,canary:s.canary,playerPath:s.playerPath,playerRequirePath:s.playerRequirePath,downloadBrowser:Boolean(s.downloadBrowser)}}var Am=w(()=>{"use strict";Go();hs();q()});function qo(s){let{platform:e}=process;e==="win32"?(0,Vo.exec)(`start chrome ${s}`):e==="darwin"?(0,Vo.exec)(`open -a "Google Chrome" ${s}`):e==="linux"&&(0,Vo.exec)(`google-chrome ${s}`)}var Vo,El=w(()=>{"use strict";Vo=require("child_process")});var Tn={};W(Tn,{doLogin:()=>xl,getProjectId:()=>NT,getToken:()=>DT});async function NT(){return Om("projectId")}async function DT(){return Om("token")}function _m(s,e){return Promise.race([s,se(e).then(()=>{throw new J("timeout")})])}async function MT(){let s=(await import("express")).default(),e=async function(){return _m(new Promise(n=>{s.get("/loginInfo",(o,i)=>{n(JSON.parse(Buffer.from(o.query.info,"base64").toString())),i.status(200).end()})}),6e4).catch(()=>null)}();await new Promise((r,n)=>{let o=s.listen(42543,i=>{i&&n(i),r(o.address().port)})});try{let{getEditorUrl:r}=await Promise.resolve().then(()=>(Te(),ve)),{editorUrl:n}=await r();qo(`${n}/#/new-test`)}catch{console.log("Unable to open Testim automatically - please manually go to https://app.testim.io")}return await e}async function xl({overwriteExisting:s=!0,projects:e=null}={}){let t=Sl.homedir(),r=Rl.join(t,".testim");if(await be(r)&&!s)return;let o={},[{default:i},{default:a}]=await Promise.all([import("prompts"),import("ora")]),c=a("Getting credentials from Testim extension ...").start();if(e||(e=await _m(MT(),62e3).catch(()=>null)),e!=null&&e.token){o.token=e.token,o.projectId=e.projectId,c.succeed(),await km(r,o);return}if(e!=null&&e.length){c.succeed();let l=e.length===1?{project:e[0]}:await i({type:"select",name:"project",message:"There are multiple projects associated with your user account. Please select the project you would like to connect to:",choices:e.map(d=>({title:d.name,value:d}))});o.token=l.project.ci.token,o.projectId=l.project.id,await km(r,o);return}c.fail(),console.log("Error getting credentials - please pass `--token` and `--project` to the CLI or try again")}async function km(s,e){await Il.promises.writeFile(s,Ho.stringify(e)),console.log(`Testim credentials saved in '${s}'`)}async function Om(s){let e=Sl.homedir(),t=Rl.join(e,".testim"),r=await be(t),n={};if(r)try{n=Ho.parse((await Il.promises.readFile(t)).toString())}catch{}return n||(n={}),n[s]}var Sl,Rl,Ho,Il,gs=w(()=>{"use strict";Sl=E(require("os")),Rl=E(require("path")),Ho=E(require("yaml"));U();Il=require("fs");El()});var Um={};W(Um,{process:()=>qT});var Pl,Nm,Cl,Dm,yt,Me,Mm,FT,Ce,kl,UT,jT,Lm,Fm,BT,Al,Ko,_l,$T,zo,Pt,WT,u,GT,VT,qT,jm=w(()=>{"use strict";Pl=E(require("ms")),Nm=E(require("chalk")),Cl=E(require("fs")),Dm=E(require("url")),yt=E(require("lodash")),Me=E(require("path"));U();Go();Am();Jt();Mm=require("commander");ae();q();Yr();U();FT=s=>s.replace(/-([a-z])/g,(e,t)=>t.toUpperCase()),Ce=(s,e)=>(e.push(s),e),kl=new Mm.Command,UT=s=>s.split(","),jT=(s,e)=>!s||s.length===0?e:s,Lm=["enable-heavy-ad-intervention","heavy-ad-privacy-mitigations","use-fake-device-for-media-stream","use-fake-ui-for-media-stream","proxy-server"],Fm=()=>{function s(h){return h.includes("-h, --help")}function e(h){return h.includes("--params [params-json-string]")}function t(h){return h.includes("--ext")||h.includes("--extension-path")}function r(h){return h.includes("--player-path")||h.includes("--player-require-path")}function n(h){return h.includes("--executionId")||h.includes("--source")||h.includes("--resultId")||h.includes("--remoteRunId")||h.includes("--schedulerId")}function o(h){return h.includes("--get-browser-timeout")||h.includes("--get-browser-retries")||h.includes("--get-session-timeout")||h.includes("--get-session-retries")||h.includes("--driver-request-timeout")||h.includes("--driver-request-retries")}function i(h){return h.includes("--user")}function a(h){return h.includes("shouldMonitorPerformance")}function c(h){return h.includes("--save-rca-locally")}function l(h){return h.includes("--exit-code-ignore-failing-tests")}function d(h){return h.includes("--high-speed")}function m(h){return h.includes("--urls")}function p(h){return h.includes("--test-start-timeout")}function f(h){return h.includes("--install-lazy-deps")}kl.help(h=>h.split(`
`).filter(y=>!t(y)&&!e(y)&&!s(y)&&!r(y)&&!n(y)&&!a(y)&&!i(y)&&!o(y)&&!c(y)&&!l(y)&&!d(y)&&!m(y)&&!p(y)&&!f(y)).join(`
`))},BT=(s,e)=>{let t=e?`Please use ${e} instead.`:"";console.log(Nm.default.yellow(`
WARNING: ${s} is deprecated. ${t}
`))},Al=["clover","html","json-summary","json","lcov","lcovonly","teamcity","text-lcov","text-summary","text"],{env:Ko,argv:_l,stdout:$T,exit:zo,cwd:Pt}=global.process,WT=["trace","debug","info","warn","error","silent"];hc(_l,new Set(["run","connect","agent","tunneld","start","init","install-lazy-deps"]));kl.description("Testim.io CLI").option("--run [file-glob-pattern]","codeful test files to run",Ce,[]).option("-h --help","output usage information",Fm).option("-o --options-file [options-file.json]","").option("-c --config-file [config-file.js]","").option("--test-config [test-config]","test config name to override for all tests in current execution",Ce,[]).option("--test-config-id [test-config-id]","test config ID to override for all tests in current execution",Ce,[]).option("--params-file [params-file.json]","").option("--params [params-json-string]","").option("-t, --testId [test-id]","test ID to run",Ce,[]).option("-w, --webpackConfig [webpack-configuration]","webpack configuration used to build the code based project").option("--test-id [test-id]","test ID to run",Ce,[]).option("-l, --label [label]","labels to search test by",Ce,[]).option("-n, --name [test-name]","test name to run",Ce,[]).option("--project [project-id]","project ID").option("-r, --report-file [report junit xml path]","where to save junit xml results file").option("--urls","add step urls to the junit report").option("--override-report-file-classname [override-report-file-classname]","custom junit class name for the junit reporter").option("--reporters [names]","report types",UT).option("-h, --host [host-name]","host name or ip containing the selenium grid").option("-p, --port [host-port]","host port").option("-g, --grid [grid-name]","grid name").option("--path [grid-path]","grid path").option("--protocol [grid-protocol]","grid protocol http or https").option("--grid-username [grid-username]","grid http basic auth username").option("--grid-password [grid-password]","grid http basic auth password").option("-gi --grid-id [grid-id]","grid ID").option("-b, --browser [browser-type]","browser type (chrome/firefox)").option("-h, --headless [headless]","run in headless mode").option("-m, --mode [runner-mode]","use extension or selenium mode (extension/selenium/appium)").option("--branch [branch]","branch name",void 0).option("--base-url [base-url]","change base-url to a specified url for all tests in current execution").option("--token [token]","identification token to testim").option("--is-regression-baseline-run","save doms and run results as regression baseline data").option("--parallel [number-of-tests]","number of tests to run in parallel").option("--before-parallel [number-of-tests]","number of tests to run in parallel during the before phase of a test plan").option("--after-parallel [number-of-tests]","number of tests to run in parallel during the after phase of a test plan").option("--canary [canary-mode]","enable canary mode",!1).option("--test-plan [test-plan-name]","test plan to run",Ce,[]).option("--test-plan-id [test-plan-id]","test plan to run",Ce,[]).option("--suite [suite-name]","suite to run",Ce,[]).option("--suite-id [suite-id]","suite ID to run",Ce,[]).option("--rerun-failed-by-run-id [run-id]","allows re-running failed tests from a specific run ID").option("--disable-grid-check [boolean]","disable checking if selenium grid is available",!1).option("--disable-native-events [boolean]","pass nativeEvents=false capability to the selenium browser (in selenium mode)",!1).option("--disable-timeout-retry [boolean]","disable retry after test pass test timeout",!1).option("--ca-file [ca-file-location]","ca certificate file location").option("--proxy [proxy-url]","proxy url to all requests").option("--proxy-for-grid [proxy-for-grid]","used together with --proxy to also router grid traffic through a proxy").option("--result-label [result-label]","result label",Ce,[]).option("-oen --override-execution-name [execution-name]","override the default execution name","").option("--retries [max_num_of_retries]","number of retries on test failure, defaults to 0 (no retries)",Number,0).option("--set-retention [retention-in-days]","set the number of days for results retention").option("--user [user-id]","user ID for local Testim-CLI").option("--pass-zero-tests","don't fail the run if no tests were found").option("--device-model [device-model]","The device model	to use, iPhone 12, Nexus 5X, SM-G900P etc....").option("--device-udid [device-udid]","the device unique  id").option("--os-version [os-version]","The operating system version number").option("--app-id [app-id]","The application id from app library on Testim Editor App").option("--appium-log-level [appium-log-level]","Level of logging verbosity").option("-rad --reset-app-data [reset-app-data]","set noReset appium  capability to true, default value true!",!1).option("-fr --full-reset [full-reset]","set fullReset appium capability to true to reinstall application on session start and session end").option("-roso --reset-on-session-start-only [reset-on-session-start-only]","set resetOnSessionStartOnly appium capability to true to avoid uninstall app on session end (ios run only)",!1).option("-str --suppress-tms-reporting [suppress-tms-reporting]","disable test management reporting",!1).option("-tsr --tms-suppress-reporting [tms-suppress-reporting]","disable test management reporting",!1).option("-tid --tms-run-id [tms-run-id]","update existing result in test management","").option("-tff --tms-field-file [tms-field-file.json]","pass field file location to add custom result field to the tms result report","").option("--disable-file-cache","disable internal CLI file caching").option("--file-cache-location [directory]"," internal CLI file caching location").option("--test-start-timeout [test-start-timeout]","The time to wait for a test to start after getting a browser session",Number,Number(Ko.TESTIM_TEST_START_TIMEOUT)||2*60*1e3).option("--timeout [test-timeout]","Test run timeout in milliseconds",Number).option("--browser-timeout [open-browser-timeout]","Get browser from grid timeout in milliseconds",Number).option("--new-browser-wait-timeout [max-wait-to-browser]","Maximum get browser wait in minutes",Number).option("--get-browser-timeout [get-browser-timeout]","Timeout for a single attempt to get browser from the grid configured in the project's plan",Number).option("--get-browser-retries [get-browser-retries]","Number of attempts to get browser from the grid configured in the project's plan",Number).option("--get-session-timeout [get-session-timeout]",'Timeout for "/session" request to the selenium server',Number,(0,Pl.default)("90s")).option("--get-session-retries [get-session-retries]",'Retries for "/session" request to the selenium server',Number,3).option("--driver-request-timeout [driver-request-timeout]","Timeout for any WebDriver request to the grid server",Number,(0,Pl.default)("90s")).option("--driver-request-retries [driver-request-retries]","Retries for any WebDriver request to the grid server",Number,3).option("--use-local-chrome-driver [use-local-chrome-driver]","use a local ChromeDriver instance instead of a selenium grid").option("--chrome-binary-location [chrome-binary-location]","Chrome binary location").option("--use-chrome-launcher","use a local Chrome installation without selenium").option("-mnh --mock-network-har","use the HAR file configured in the Testim editor to mock network traffic").option("-mnp --mock-network-pattern [local file location path]","use a JSON rule file to mock network traffic (Rule file schema: https://help.testim.io/page/mocking-network-traffic)").option("-omf --override-mapping-file [local file location path]","pass map file location to override mock network (see schema: https://help.testim.io/page/mocking-network-traffic)").option("-dmn --disable-mock-network","Disable mock mode for the entire CLI run").option("--run-quarantined-tests","Run quarantine tests").option("--collect-code-coverage","collect code coverage for all js files under base url").option("--code-coverage-url-filter [url pattern]","collect code coverage for all js files matching url filter (url including asterisk)").option("--code-coverage-report-path [path]","where to save coverage report (default ./coverage)").option("--code-coverage-source-map-path [path]","path of source code").option("--code-coverage-reporter [reporter]",`set code coverage reporter (default html and text), options: ${Al.join("/")}`,Ce,[]).option("--code-coverage-include [pattern]","set selecting files for coverage (default src/**)",Ce,[]).option("--sauce-user [sauce-lab-user]","user to connect to sauce labs").option("--sauce-key [sauce-lab-key]","key to use when connecting to sauce labs").option("--sauce-options [sauce-options]","json file of browser and os options for sauce").option("--browserstack-user [browserstack-user]","user to connect to browserStack").option("--browserstack-key [browserstack-key]","key to use when connecting to browserStack").option("--browserstack-options [browserstack-options]","json file of browser and os options for browserStack").option("--perfecto-token [perfecto-token]","security token to use when connecting to perfecto").option("--perfecto-options [perfecto-options]","json file of browser and os options for perfecto").option("--experitest-token [experitest-token]","security token to use when connecting to experitest").option("--testobject-key [testobject-key]","api key to use when connecting to testobject").option("--testobject-options [testobject-options]","json file of options for testobject").option("--ext [extension src path]","use extension from path (default it '/..')").option("--extension-path [path to extension archived file]","override the used extension").option("--install-custom-extension [chrome extension zipped file url or local path]","chrome extension to be installed in the browser").option("--player-path [path to player file]").option("--player-require-path [path to unminified player - development only]").option("--init [init]","Path for an initial test app").option("--inspect [port]","Opens node inspector at given port",Number).option("--login","Log in to Testim").option("--require-credentials","Log in to Testim if not already logged in").option("--tunneld","run a tunnel daemon only").option("--tunnel [tunnel]","enable tunnel").option("--tunnel-routes [routes]","tunnel routes for cloudflare tunnels").option("--tunnel-port [tunnel-port]","tunnel port address").option("--tunnel-host-header [tunnel-host-header]","tunnel host header").option("--tunnel-region [tunnel-region]","ngrok tunnel region").option("--tunnel-diagnostics","collect ngrok tunnel diagnostics").option("--tunnel-use-http-address [tunnel-use-http-address]","use http:// address instead of https://",!1).option("--external-lambdatest-tunnel-id [tunnel-id]","use existing lambdatest tunnel ID").option("--external-lambdatest-use-wss","use wss instead of ssh for LT",!1).option("--external-lambdatest-disable-automation-tunneling","don't tunnel Testim calls in LT tunnel",!0).option("--external-lambdatest-mitm","Turn on LT Man in the middle",!1).option("--w3c-capabilities [enable-w3c-caps-mode]","enable/disable w3c capabilities format (default enable)",JSON.parse,!0).option("--old-capabilities [enable-old-caps-mode]","enable/disable old capabilities format (default enable)",JSON.parse,!0).option("--disable-sockets","Disable CLI sockets",!1).option("--executionId [execution-id]","","").option("--remoteRunId [remote-run-id]","","").option("--schedulerId [scheduler-id]","","").option("--source [source]","","cli").option("--resultId [result-id]","","").option("--connect, --agent [enable-agent-mode]","enable Testim CLI agent mode",!1).option("--start [enable-start]","Connect to testim and open the editor in a standalone browser",!1).option("--download-browser","when used with the start option, downloads a fixed version to run Testim editor in",!1).option("--agent-port [agent-port]","set agent port",Number,42543).option("--agent-bind [agent-host-bind]","set agent host bind","127.0.0.1").option("--chrome-extra-prefs [chrome-extra-prefs]","add extra chrome preferences","").option("--chrome-extra-args [chrome-extra-args]","add extra chrome arguments separated by ','","").option("--chrome-block-location [chrome-block-location]","block chrome geolocation",!1).option("--chrome-user-data-dir [chrome-user-data-dir]","use custom chrome user date dir",!1).option("--disable-cookies-same-site-none-requires-secure [disable-same-site-none-requires-secure]","Disable cookies without SameSite must be secure",!1).option("--selenium-caps-file [selenium-caps-file.json]","json file to merge into Testim selenium desired capabilities").option("--version [version]","print the current version of the Testim CLI and exit",!1).option("--monitor-performance","collect test playback performance data").option("--high-speed","DEPRECATED: use --turbo-mode instead").option("--turbo-mode","run in turbo mode").option("--lightweight-mode [settings]","run lightweight mode").option("--create-prefeched-data [location]","prefetch data into local cache file").option("--use-prefeched-data [location]","use prefetched data from local cache file, and force using only cached data").option("--save-rca-locally [path]","save root cause analysis assets locally").option("--exit-code-ignore-failing-tests","return exit code of zero when tests fail. non zero exit code will mean a real error occurred").option("--intersect-with-label [label]","Out of the execution's test list, run only those tests that have the specified label",Ce,[]).option("--intersect-with-suite [suiteName]","Out of the execution's test list, run only those tests that are included in the specified suite (by suite name)",Ce,[]).option("--intersect-with-suite-id [suiteId]","Out of the execution's test list, run only those tests that are included in the specified suite (by suite ID)",Ce,[]).option("--install-lazy-deps [install-lazy-deps]","Install all lazy dependencies from package.json",!1).parse(_l);u=kl.opts(),GT=()=>{u.grid||u.gridId||(u.host||(u.host="ondemand.saucelabs.com"),u.port||(u.port=80))},VT=()=>{u.grid||u.gridId||(u.host||(u.host="hub-cloud.browserstack.com"),u.port||(u.port=80))},qT=async()=>{var g,y,T,C,b,v,x,k,D;u.inspect&&require("inspector").open(u.inspect);let s={},e={},t=[],r={};if(!_l.slice(2).length)throw Fm(),new gr;if(u.requireCredentials){let S=await Promise.resolve().then(()=>(gs(),Tn)),O=await S.getProjectId(),P=await S.getToken();(!O||!P)&&await S.doLogin()}if(u.login)return await(await Promise.resolve().then(()=>(gs(),Tn))).doLogin(),{loginMode:!0};if(u.init)return{initCodimMode:!0,initTestProject:u.init};if(u.version){let S="Testim CLI Version: ";Ko.npm_package_version&&(console.log(S,Ko.npm_package_version),zo(0));let O=lt();O&&(console.log(S,O),zo(0)),console.log("Could not find version, please check the package.json manually"),zo(0)}if(u.installLazyDeps)return{installLazyDepsMode:!0};u.disableFileCache&&Fp();let n=u.fileCacheLocation||u.usePrefechedData||u.createPrefechedData;if(n){let S=Me.resolve(n);Dp(S)}if(u.usePrefechedData&&Up(),u.playerRequirePath){let S=Me.resolve(u.playerRequirePath);console.log("Using Local Clickim for Player Require Path =",S);let O=Me.join(S,"tsconfig.node.json"),N=require("ts-node").register({project:O,ignore:[/node_modules/,new RegExp(`^${yt.escapeRegExp(Me.relative(Pt(),__dirname))}`)],transpileOnly:!0});require("tsconfig-paths").register({paths:N.config.options.paths,baseUrl:N.config.options.baseUrl}),(Ee(),ie(Or)).options.playerPath=S;let V=require("module"),Y=V.prototype.require;V.prototype.require=function(fe){return fe==="rox-alias"?Y.call(this,"rox-node"):Y.apply(this,arguments)}}if(u.caFile&&(global.caFileContent=Cl.readFileSync(u.caFile)),u.proxy&&(global.proxyUri=u.proxy,global.SuperagentProxy=require("superagent-proxy"),global.ProxyAgent=require("proxy-agent"),global.HttpsProxyAgent=require("https-proxy-agent")),u.proxyForGrid&&!u.proxy)throw new I("missing --proxy option");if(Pm(u))return Cm(u);try{let S={};u.configFile?S=require(Me.join(Pt(),u.configFile)).config:u.optionsFile&&(S=require(Me.join(Pt(),u.optionsFile))),S&&typeof S.then=="function"&&(S=await S),Object.keys(S).forEach(O=>{let P=FT(O);u[P]=jT(u[P],S[O])})}catch(S){throw S.message=`Unable to read options file: ${S.message}`,S}if(u.tunneld)return{tunnel:!0,tunnelPort:u.tunnelPort,tunnelRoutes:u.tunnelRoutes,tunnelRoutesOutput:u.tunnelRoutesOutput,tunnelHostHeader:u.tunnelHostHeader,tunnelRegion:u.tunnelRegion,tunnelDiagnostics:u.tunnelDiagnostics,tunnelUseHttpAddress:u.tunnelUseHttpAddress,tunnelOnlyMode:!0,token:u.token,project:u.project};let o=((g=u.testConfig)==null?void 0:g.length)||((y=u.testConfigId)==null?void 0:y.length),i=((T=u.testPlan)==null?void 0:T.length)||((C=u.testPlanId)==null?void 0:C.length),a=((b=u.suite)==null?void 0:b.length)||((v=u.suiteId)==null?void 0:v.length);if(u.seleniumCapsFile)try{r=require(Me.join(Pt(),u.seleniumCapsFile))}catch(S){throw new I(`Failed to parse selenium caps file file error: ${S.message}`)}if((x=u.reporters)!=null&&x.includes("junit")&&!u.reportFile&&console.log("Warning: please define --report-file option for JUnit reporter"),!u.tunnel&&u.externalLambdatestTunnelId)throw new I("missing --tunnel parameter");if(!u.tunnel&&u.externalLambdatestUseWss)throw new I("missing --tunnel parameter");if(!u.tunnel&&[u.tunnelPort,u.tunnelHostHeader,u.tunnelRegion,u.tunnelDiagnostics].some(Boolean))throw new I("missing --tunnel parameter");if(u.chromeExtraPrefs)try{e=require(Me.join(Pt(),u.chromeExtraPrefs))}catch(S){throw new I(`Failed to read/open chrome extra prefs file error: ${S.message}`)}if(u.chromeExtraArgs){let S=u.chromeExtraArgs.split(",");for(let O of S){let[P]=O.split("=");Lm.includes(P)||u.useLocalChromeDriver||u.useChromeLauncher?(t.push(O),P==="proxy-server"&&t.push("proxy-bypass-list=*.testim.io;*.coralogix.com;*.cloudinary.com;*.rollout.io")):console.warn(`Ignoring an unsupported chrome arg (${P}), allowed values: ${JSON.stringify(Lm)}`)}}if(u.paramsFile)try{s=Object.assign({},s,require(Me.join(Pt(),u.paramsFile)))}catch(S){throw new I(`Failed to read/open params file error: ${S.message}`)}if(u.params)try{s=Object.assign({},s,JSON.parse(u.params))}catch(S){throw new I(`Failed to parse params string error: ${S.message}`)}if(u.sauceUser&&!u.sauceKey||!u.sauceUser&&u.sauceKey)throw new I("missing --sauce-user <sauce-user> or --sauce-key <sauce-key>");if(u.sauceUser&&u.sauceKey&&(GT(),u.saucelabs={},u.saucelabs.username=u.sauceUser,u.saucelabs.accessKey=u.sauceKey),u.sauceOptions)try{let S=require(Me.join(Pt(),u.sauceOptions)),O=S.platformName&&["ios","android"].includes(S.platformName.toLowerCase());if(S.browserName){let N=S.browserName.toLowerCase();switch(N){case"microsoftedge":u.browser="edge";break;default:u.browser=N}}u.browser==="edge"&&parseFloat(S.version)>=$a&&(u.browser="edge-chromium");let P=parseFloat(S.version)<50&&!["dev","beta"].includes(S.version);if(!O&&u.browser==="chrome"&&P)throw new I("The minimum chrome supported version is 50.0");u.saucelabs=Object.assign({},u.saucelabs,S)}catch(S){throw new I(`Failed to parse saucelabs options file error: ${S.message}`)}if(u.browserstackUser&&!u.browserstackKey||!u.browserstackUser&&u.browserstackKey)throw new I("missing --browserstack-user <browserstack-user> or --browserstack-key <browserstack-key>");if(u.browserstackUser&&u.browserstackKey&&(VT(),u.browserstack={},u.browserstack["browserstack.user"]=u.browserstackUser,u.browserstack["browserstack.key"]=u.browserstackKey),u.browserstackOptions)try{let S=require(Me.join(Pt(),u.browserstackOptions)),O=S.platform&&["mac","android"].includes(S.platform.toLowerCase());if(S.browserName&&(u.browser=S.browserName.toLowerCase()),u.browser==="edge"&&parseFloat(S.browser_version)>=$a&&(u.browser="edge-chromium"),!O&&parseFloat(S.browser_version)<50&&u.browser==="chrome")throw new I("The minimum chrome supported version is 50.0");u.browserstack=Object.assign({},u.browserstack,S)}catch(S){throw new I(`Failed to parse browserstack options file error: ${S.message}`)}if(u.perfecto={},u.perfectoToken&&(u.perfecto.securityToken=u.perfectoToken),u.perfectoOptions)try{let S=require(Me.join(Pt(),u.perfectoOptions)),O={location:"US East",securityToken:u.perfectoToken};u.perfecto=Object.assign({},O,S)}catch(S){throw new I(`Failed to parse perfecto options file error: ${S.message}`)}if(u.testobjectSauce={},u.testobjectKey&&(u.testobjectSauce.testobjectApiKey=u.testobjectKey),u.testobjectOptions)try{let S=require(Me.join(Pt(),u.testobjectOptions)),O={testobjectApiKey:u.testobjectKey};u.testobjectSauce=Object.assign({},O,S)}catch(S){throw new I(`Failed to parse test object options file error: ${S.message}`)}if(!u.project){let O=await(await Promise.resolve().then(()=>(gs(),Tn))).getProjectId();if(O)u.project=O;else throw new I("missing project-id info, either --login to provide new credentials or use --project <project-id>")}u.mode||(u.mode=u.run.length?"selenium":"extension"),u.testConfig&&(u.testConfig=[u.testConfig].flat()),u.testConfigId&&(u.testConfigId=[u.testConfigId].flat()),u.retries=!u.retries||typeof u.retries=="boolean"?1:Number(u.retries)+1,u.browserTimeout=!u.browserTimeout||typeof u.browserTimeout=="boolean"?60*1e3:u.browserTimeout,u.newBrowserWaitTimeout=!u.newBrowserWaitTimeout||typeof u.newBrowserWaitTimeout=="boolean"?10*60*1e3:u.newBrowserWaitTimeout*60*1e3,u.getBrowserTimeout||(u.getBrowserTimeout=u.browserTimeout),u.getBrowserRetries||(u.getBrowserRetries=Math.round(u.newBrowserWaitTimeout/u.browserTimeout)),u.getSessionTimeout=u.browserTimeout<u.getSessionTimeout?u.getSessionTimeout:u.browserTimeout,u.driverRequestTimeout=u.browserTimeout<u.driverRequestTimeout?u.driverRequestTimeout:u.browserTimeout;let c=Boolean(u.timeout);if(u.timeout=!u.timeout||typeof u.timeout=="boolean"?10*60*1e3:u.timeout,u.beforeParallel=!u.beforeParallel||typeof u.beforeParallel=="boolean"?1:Number(u.beforeParallel),u.parallel=!u.parallel||typeof u.parallel=="boolean"?1:Number(u.parallel),u.afterParallel=!u.afterParallel||typeof u.afterParallel=="boolean"?1:Number(u.afterParallel),u.parallel>1&&u.run&&!u.gridId&&!u.grid&&(!u.testPlan||u.testPlan.length===0)&&!((k=u.testPlanId)!=null&&k.length)&&$T.isTTY&&!u.headless&&!Ko.TERM&&((await require("prompts")({type:"toggle",name:"isSure",message:"Running in parallel without --headless flag will open several browsers on your computer. Are you sure?",initial:!1,active:"yes",inactive:"no"})).isSure||zo(0)),u.tunnelPort=!u.tunnelPort||typeof u.tunnelPort=="boolean"?"80":u.tunnelPort,u.port&&(u.port=Number(u.port)),u.retries<=0||Number.isNaN(u.retries))throw new I("test failure retry count could not be a negative number or string, --retries <max_num_of_retries>");if(u.retries>21)throw new I("Max number of retries exceeded. Number cannot be greater than 20, --retries <max_num_of_retries>");if(!u.token){let O=await(await Promise.resolve().then(()=>(gs(),Tn))).getToken();if(O)u.token=O;else throw new I("missing Testim Access Token, either --login to provide new credentials or use --token <testim-access-token>, contact info@testim.io if you need a new one.")}if(u.browserTimeout<=0||Number.isNaN(u.browserTimeout))throw new I("get browser timeout could not be a negative number, --browser-timeout <get-browser-timeout>");if(u.newBrowserWaitTimeout<=0||Number.isNaN(u.newBrowserWaitTimeout))throw new I("max new browser wait timeout could not be a negative number, --new-browser-wait-timeout <max-wait-to-browser>");if(u.timeout<=0||Number.isNaN(u.timeout))throw new I("test run timeout could not be a negative number, --timeout <run-timeout>");if(u.beforeParallel<=0||Number.isNaN(u.beforeParallel))throw new I("before-parallel could not be a negative number or not number, --before-parallel <number-of-tests>");if(u.parallel<=0||Number.isNaN(u.parallel))throw new I("parallel could not be a negative number or not number, --parallel <number-of-tests>");if(u.afterParallel<=0||Number.isNaN(u.afterParallel))throw new I("after-parallel could not be a negative number or not number, --after-parallel <number-of-tests>");if(![X.EXTENSION,X.SELENIUM,X.APPIUM].includes(u.mode))throw new I(`runner mode <${u.mode}> is not supported`);if(u.mode!==X.SELENIUM&&u.disableNativeEvents)throw new I("disable-native-events is only applicable in selenium mode");if(!u.browser&&!o&&!i&&(u.browser="chrome"),u.appiumLogLevel||(u.appiumLogLevel="silent"),!WT.includes(u.appiumLogLevel))throw new I(`runner appium-log-level <${u.appiumLogLevel}> is not supported`);if(u.testPlan&&u.testPlan.length===0&&u.testPlanId&&u.testPlanId.length===0){if(typeof u.host!="string"&&typeof u.grid!="string"&&typeof u.gridId!="string"&&u.run.length===0&&!u.useLocalChromeDriver&&!u.useChromeLauncher&&!u.createPrefechedData)throw new I("missing remote grid address parameter, specify --host <host-name-or-ip> or --grid <grid-name> or --grid-id <grid-id>")}else if(u.testId.length||u.label.length||u.name.length||o||u.browser||a||u.useLocalChromeDriver||u.useChromeLauncher)throw new I("cannot set --testId, --label, --name, --browser, --test-config, --test-config-id, --use-local-chrome-driver --use-chrome-launcher or --suite with --test-plan option");if(!i&&(u.beforeParallel!==1||u.afterParallel!==1))throw new I("cannot set --before-parallel or --after-parallel without --test-plan option");if((u.testId.length||i||u.label.length||u.name.length||a)&&u.file)throw new I("Cannot pass codeful automation tests with --testId --label --name or --suite");if([u.host,u.grid,u.gridId].filter(Boolean).length>1)throw new I("please define exactly one of --grid or --grid-id or --host");if((D=u.host)!=null&&D.includes("/")&&(/^(f|ht)tps?:\/\//i.test(u.host)||(u.host=`http://${u.host}`),u.host=Dm.parse(u.host).hostname),u.resultLabel.length){u.resultLabel=u.resultLabel.map(O=>O.trim()).filter(Boolean);let S=u.resultLabel.filter(O=>O.length>=250).filter(Boolean);if(u.branch==="auto-detect"&&u.resultLabel.includes("auto-detect-branch")&&xr()&&u.resultLabel.unshift(xr()),S.length)throw new I("A result label cannot exceed 250 characters")}let d=vm(u),m=Wo(u);if(!u.w3cCapabilities&&!u.oldCapabilities)throw new I("cannot set --w3c-capabilities and --old-capabilities options as false");if(u.protocol||(u.protocol=u.port===443?"https":"http"),!["http","https"].includes(u.protocol))throw new I("invalid --protocol value, allow --protocol http or https");if(u.rerunFailedByRunId&&u.branch)throw new I("It is not possible to use --branch with --rerun-failed-by-run-id. Tests will automatically run on the same branch that was used in the original run");if(u.rerunFailedByRunId&&(a||u.name.length||u.testId.length||u.label.length||i))throw new I("Re-running failed tests is not possible when suite (--suite), label (--label), plan (--test-plan), or other test flags (--test) are provided. Please remove these flags and try again");if(u.run.length){let S=require("glob");if(u.files=yt.flatMap(u.run,O=>S.sync(O)),u.files.length===0)throw new I(`No files found at path '${u.run}'.`)}else u.files=[];if(u.setRetention&&!yt.inRange(yt.parseInt(u.setRetention),1,11))throw new I("Please provide the number of days that the test results will be retained for (--set-retention must be a whole number between 1 to 10)");u.setRetention&&(u.setRetention=Number(u.setRetention));let p="is no longer supported, please use --override-mapping-file";if(u.mockNetworkHar)throw new I(`--mock-network-har ${p}`);if(u.mockNetworkPattern)throw new I(`--mock-network-pattern ${p}`);if(u.disableMockNetwork&&u.overrideMappingFile)throw new I("You can either use --disable-mock-network or --override-mapping-file");if(!u.collectCodeCoverage&&u.codeCoverageSourceMapPath)throw new I("cannot set --code-coverage-source-map-path without passing --collect-code-coverage");if(!u.collectCodeCoverage&&u.codeCoverageReporter.length)throw new I("cannot set --code-coverage-reporter without passing --collect-code-coverage");if(!u.collectCodeCoverage&&u.codeCoverageInclude.length)throw new I("cannot set --code-coverage-include without passing --collect-code-coverage");if(u.collectCodeCoverage&&u.codeCoverageReporter&&yt.difference(u.codeCoverageReporter,Al).length){let S=yt.difference(u.codeCoverageReporter,Al);throw new I(`invalid --code-coverage-reporter parameters ${S.join("/")}`)}u.codeCoverageReporter=u.codeCoverageReporter.length===0?["html","text"]:u.codeCoverageReporter,u.codeCoverageInclude=u.codeCoverageInclude.length===0?["src/**"]:u.codeCoverageInclude;let f={mockNetworkHar:"--mock-network-har",mockNetworkPattern:"--mock-network-pattern",overrideMappingFile:"--override-mapping-file",codeCoverageUrlFilter:"--code-coverage-url-filter",collectCodeCoverage:"--collect-code-coverage",disableMockNetwork:"--disable-mock-network",useChromeLauncher:"--use-chrome-launcher"},h=Object.keys(f).filter(S=>Boolean(u[S]));if(u.mode!==X.EXTENSION&&h.length){let S=h.length>1?"are":"is";throw new I(`${h.map(O=>f[O]).join(" and ")} ${S} only applicable in extension mode`)}if(u.tmsFieldFile)try{let S=Cl.readFileSync(u.tmsFieldFile);u.tmsCustomFields=JSON.parse(S)}catch(S){throw new I(`failed to parse field file error: ${S.message}`)}if(u.highSpeed&&(BT("--high-speed"," --turbo-mode"),u.turboMode=!0),u.deviceUdid&&(u.deviceModel||u.osVersion))throw new I("It is not possible to use --osVersion or  --deviceModel with  --device-udid. device-udid is unique and cannot be combined with another flag");if(u.resetAppData&&u.fullReset)throw new I("It is not possible to set both --reset-app-data and --full-reset capabilities to true at the same time!");if(u.resetOnSessionStartOnly&&!u.fullReset&&console.warn("Ignoring --reset-on-session-start-only flag, should be used when --full-reset is provided for ios runs"),u.lightweightMode)try{let S={general:!0,disableLabs:!0,disableFeatureFlags:!0,disableAssets:!0,disablePixelValidation:!0,disableResults:!0,disableStepDelay:!0,disableRemoteStep:!0,assumePreloadedSharedSteps:!0,disableVisibilityCheck:!1,disableLocators:!1,bypassSetup:!1,disableAutoImprove:!0,disableQuotaBlocking:!0,onlyTestIdsNoSuite:!0,uploadAssetsAndResultsOnFailure:!0,preloadTests:!0,disableProjectDefaults:!0,type:"lightweight"},O=typeof u.lightweightMode=="string"?JSON.parse(u.lightweightMode):{};u.lightweightMode=Object.assign({},S,O)}catch(S){throw new I(`failed to parse lightweightMode settings error: ${S.message}`)}else u.turboMode&&u.mode===X.EXTENSION&&(u.lightweightMode={general:!0,disableLabs:!1,disableFeatureFlags:!1,disableAssets:!0,disablePixelValidation:!1,disableResults:!0,disableStepDelay:!0,disableRemoteStep:!1,assumePreloadedSharedSteps:!1,disableVisibilityCheck:!1,disableLocators:!1,bypassSetup:!1,disableQuotaBlocking:!1,disableAutoImprove:!1,onlyTestIdsNoSuite:!1,uploadAssetsAndResultsOnFailure:!0,preloadTests:!1,disableProjectDefaults:!1,type:"turboMode"});if(typeof u.baseUrl=="boolean")throw new I("base url cannot be used as a flag, and must contain a string value");return{testId:[u.testId].flat(),name:[u.name].flat(),label:[u.label].flat(),suites:[u.suite].flat(),suiteIds:[u.suiteId].flat(),testPlan:[u.testPlan].flat(),testPlanIds:[u.testPlanId].flat(),files:[u.files].flat(),webpackConfig:u.webpackConfig,reportFile:u.reportFile,urls:u.urls,reportFileClassname:u.overrideReportFileClassname,reporters:u.reporters,project:u.project,host:u.host,headless:u.headless,useLocalChromeDriver:u.useLocalChromeDriver,chromeBinaryLocation:u.chromeBinaryLocation,useChromeLauncher:u.useChromeLauncher,port:u.port,grid:u.grid,gridId:u.gridId,disableNativeEvents:u.disableNativeEvents,saucelabs:u.saucelabs,browserstack:u.browserstack,baseUrl:u.baseUrl,branch:(u.branch==="auto-detect"?xr():u.branch)||"master",autoDetect:u.branch==="auto-detect",token:u.token,userParamsData:s,mode:u.mode,isRegressionBaselineRun:u.isRegressionBaselineRun,browser:u.browser,beforeParallel:u.beforeParallel,parallel:u.parallel,afterParallel:u.afterParallel,canary:u.canary,rerunFailedByRunId:u.rerunFailedByRunId,disableGridCheck:u.disableGridCheck,disableTimeoutRetry:u.disableTimeoutRetry,resultLabels:u.resultLabel,path:u.path,protocol:u.protocol,perfecto:u.perfecto,experitestToken:u.experitestToken,testobjectSauce:u.testobjectSauce,gridUsername:u.gridUsername,gridPassword:u.gridPassword,overrideExecutionName:u.overrideExecutionName,tmsSuppressReporting:Boolean(u.suppressTmsReporting)||Boolean(u.tmsSuppressReporting),tmsRunId:u.tmsRunId,tmsCustomFields:u.tmsCustomFields,proxyForGrid:u.proxyForGrid,retentionDays:u.setRetention,passZeroTests:Boolean(u.passZeroTests),runQuarantinedTests:Boolean(u.runQuarantinedTests),deviceModel:u.deviceModel,deviceUdid:u.deviceUdid,osVersion:u.osVersion,appId:u.appId,appiumLogLevel:u.appiumLogLevel,resetAppData:u.resetAppData,fullReset:u.fullReset,resetOnSessionStartOnly:u.resetOnSessionStartOnly,ext:u.ext,extensionLocation:[u.extensionPath||d].flat(),extensionPath:u.extensionPath,playerLocation:u.playerPath||m,playerPath:u.playerPath,playerRequirePath:u.playerRequirePath,tunnel:u.tunnel,tunnelPort:u.tunnelPort,tunnelRoutes:u.tunnelRoutes,tunnelRoutesOutput:u.tunnelRoutesOutput,tunnelHostHeader:u.tunnelHostHeader,tunnelRegion:u.tunnelRegion,tunnelDiagnostics:u.tunnelDiagnostics,tunnelUseHttpAddress:u.tunnelUseHttpAddress,externalLambdatestTunnelId:u.externalLambdatestTunnelId,externalLambdatestUseWss:u.externalLambdatestUseWss||!1,externalLambdatestDisableAutomationTunneling:Boolean(u.externalLambdatestDisableAutomationTunneling),externalLambdatestMitm:Boolean(u.externalLambdatestMitm),beforeTest:u.beforeTest,afterTest:u.afterTest,beforeSuite:u.beforeSuite,afterSuite:u.afterSuite,timeout:u.timeout,timeoutWasGiven:c,browserTimeout:u.browserTimeout,newBrowserWaitTimeout:u.newBrowserWaitTimeout,getBrowserTimeout:u.getBrowserTimeout,getBrowserRetries:u.getBrowserRetries,getSessionTimeout:u.getSessionTimeout,getSessionRetries:u.getSessionRetries,driverRequestTimeout:u.driverRequestTimeout,driverRequestRetries:u.driverRequestRetries,testStartTimeout:u.testStartTimeout,testConfigNames:u.testConfig,testConfigIds:u.testConfigId,overrideMappingFile:u.overrideMappingFile,disableMockNetwork:u.disableMockNetwork,codeCoverageUrlFilter:u.codeCoverageUrlFilter,collectCodeCoverage:u.collectCodeCoverage,codeCoverageReportPath:u.codeCoverageReportPath,codeCoverageSourceMapPath:u.codeCoverageSourceMapPath,codeCoverageReporter:u.codeCoverageReporter,codeCoverageInclude:u.codeCoverageInclude,executionId:u.executionId,remoteRunId:u.remoteRunId,schedulerId:u.schedulerId,source:u.source,resultId:u.resultId,installCustomExtension:u.installCustomExtension,w3cCapabilities:u.w3cCapabilities,oldCapabilities:u.oldCapabilities,chromeBlockLocation:u.chromeBlockLocation,chromeUserDataDir:u.chromeUserDataDir,retries:u.retries,chromeExtraPrefs:e,chromeExtraArgs:t,disableCookiesSameSiteNoneRequiresSecure:u.disableCookiesSameSiteNoneRequiresSecure,seleniumCapsFileContent:r,shouldMonitorPerformance:u.monitorPerformance,user:u.user,lightweightMode:u.lightweightMode,createPrefechedData:u.createPrefechedData,saveRCALocally:u.saveRcaLocally,exitCodeIgnoreFailingTests:u.exitCodeIgnoreFailingTests,disableSockets:u.disableSockets,intersections:{labels:u.intersectWithLabel.length?[u.intersectWithLabel].flat():void 0,suiteNames:u.intersectWithSuite.length?[u.intersectWithSuite].flat():void 0,suiteIds:u.intersectWithSuiteId.length?[u.intersectWithSuiteId].flat():void 0},downloadBrowser:u.downloadBrowser}}});var zT={};var ys,Bm,$m,Jo,HT,Wm=w(()=>{"use strict";ys=E(require("path")),Bm=require("fs"),$m=require("child_process"),Jo=ys.resolve(__filename),HT=!Jo.includes("node_modules")&&ys.dirname(Jo).endsWith("src");HT&&!(0,Bm.existsSync)(ys.resolve(Jo,"..","..","..","webdriverio","build","index.js"))&&(console.log("Hi developer, we're initializing the runner dev env for the first time for you \u2764\uFE0F"),(0,$m.execSync)("yarn workspace @testim/webdriverio build",{cwd:ys.resolve(Jo,"..","..")}))});var Ol={};W(Ol,{installAllLazyDependencies:()=>YT,lazyRequire:()=>he});async function he(s,e={}){let t=Rc(s);if(t)return t;let r;e.silent||(r=(0,Gm.default)(`Installing ${s} before first usage...`).start());try{let n=await JT(s);return r&&r.succeed(),n}catch(n){KT.warn("failed to install dependency lazily",{dependency:s,err:n});let o=qm(s),i=`${s}@${o}`,c=process.argv.includes("npx")?"":"-g ",l=`Installation of ${s} failed. This typically means you are running an out-of-date version of Node.js or NPM.Please manually install by running the following command: npm install ${c}${i}`;throw r&&r.fail(l),n}}async function JT(s){return bs.has(s)||(bs.set(s,Vm(s)),bs.get(s).catch(()=>{bs.delete(s)})),bs.get(s)}async function Vm(s){let e=Rc(s);if(e)return e;let t=qm(s),r=`${s}@${t}`;return await xo(ft(),r),Yt(s)}async function YT(){let s=Object.keys(qa);for(let e of s)await Vm(e)}function qm(s){let e=Object.entries(qa).find(([t])=>t===s);if(!e)throw new Error("The given package name is not lazyDependencies");return e[1]}var Gm,KT,bs,bt=w(()=>{"use strict";Gm=E(require("ora"));an();j();U();ro();on();KT=R("lazy-require"),bs=new Map});var Jm={};W(Jm,{init:()=>QT});async function QT(s){var T,C;let e=typeof s=="string"?s:"";(typeof s!="string"||!s.trim())&&(e=(await(0,Nl.default)({type:"text",name:"project",message:"Please enter Project name",validate:v=>String(v).length>3})).project);let t=Zt.resolve(e);er.existsSync(t)&&er.readdirSync(t).length!==0&&(console.log(`${t} is not empty. Quitting...`),process.exit(1));let r=t.substr(Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\"))+1),n=(0,zm.default)(r);if(!n.validForNewPackages){let b=`The name '${r}' is not a valid package name:`;throw console.log(Yo.default.red(b)),n.errors&&n.errors.forEach(v=>console.log(Yo.default.red(v))),n.warnings&&n.warnings.forEach(v=>console.log(Yo.default.yellowBright(`warning: ${v}`))),new I(`${b}
validation errors:
${((T=n.errors)==null?void 0:T.join(`
`))||""}
warnings:
${((C=n.warnings)==null?void 0:C.join(`
`))||""}`)}let i=(await(0,Nl.default)({type:"toggle",name:"isJs",message:"Add support for TypeScript?",initial:!0,active:"no",inactive:"yes"})).isJs?"template.js":"template.ts",a="codim",c=Zt.join(__dirname,a,i),l=Zt.join(process.cwd(),e),d=(0,Ll.default)(`Creating new test project in ${l}`).start();await uo(c,l);let m=Zt.join(__dirname,a,i,"package.json"),p=Zt.join(process.cwd(),e,"package.json"),h=(await er.promises.readFile(m)).toString().replace("~testim-codeful-test-project~",r);await er.promises.writeFile(p,h);let g="node_modules",y=Zt.join(process.cwd(),e,".gitignore");await er.promises.writeFile(y,g),d.succeed(),d=(0,Ll.default)("Installing dependencies").start(),await XT("npm install",{cwd:l}),d.succeed(),console.log(`Testim Dev Kit project folder successfully created in ${l}.`)}var er,Zt,Hm,Ll,Yo,Nl,zm,Km,XT,Ym=w(()=>{"use strict";er=E(require("fs")),Zt=E(require("path")),Hm=E(require("child_process")),Ll=E(require("ora")),Yo=E(require("chalk")),Nl=E(require("prompts")),zm=E(require("validate-npm-package-name")),Km=require("util");q();dc();XT=(0,Km.promisify)(Hm.exec)});var Qm={};W(Qm,{preloadTests:()=>vn});async function vn(s){if(!Array.isArray(s.testId)||!s.testId.length)return{};let e={branch:s.branch,projectId:s.project};return await ht(async()=>{let t=await de(s.testId,r=>Bc({...e,testId:r}),{concurrency:2});return Xm.keyBy(t,"testData.id")},"loadTests",ZT,[e,s.testId])()}var Xm,ZT,Xo=w(()=>{"use strict";Xm=E(require("lodash"));Jt();Te();U();ZT=1e3*60*60*10});function Dl(){return lt()}async function tf(){if(!Ne)try{let s=await te(tv(),5e3,"The API call to NPM timed out"),e=Dl();e&&ef.lt(e,s)&&console.log(Zm.default.yellow(`Warning: You are using version ${e}, a newer version is available. To update please run npm install (npm install -g @testim/testim-cli)`))}catch(s){ev.warn("Failed to get NPM version",{err:s})}}var Zm,ef,ev,tv,Ml=w(()=>{"use strict";Zm=E(require("chalk")),ef=E(require("semver"));U();le();an();Jt();j();ev=R("npm-driver"),tv=ht(()=>Wp("@testim/testim-cli"),"getNpmVersion")});var Fl,sv,ws,rf,sf,Ul,nf,of=w(()=>{"use strict";U();q();j();bt();Fl=R("testimNgrok"),sv=".whitelisted-ngrok.testim.io",ws="",sf=async(s,e={})=>{if(!e.ngrokToken)throw new I("tunnel feature is not enabled, please contact support - info@testim.io.");let t;e.isNgrokWhitelisted&&(t=`${z()}-${s.projectData.projectId}${sv}`);let r={proto:"http",addr:s.tunnelPort||80,authtoken:e.ngrokToken,hostname:t};s.tunnelHostHeader&&(r.host_header=s.tunnelHostHeader),s.tunnelRegion&&(r.region=s.tunnelRegion);let o=await(await he("ngrok")).connect(r);s.tunnelUseHttpAddress&&o.startsWith("https://")?(Fl.info("replace https to http"),ws=o.replace("https://","http://")):ws=o,s.tunnelDiagnostics&&Ul(),s.baseUrl=ws},Ul=async(s=!0)=>{try{let t=(await he("ngrok")).getApi(),{tunnels:r}=await t.listTunnels(),n=r.find(o=>o.public_url===ws);console.log("ngrok stats",n),Fl.info("ngrok stats",{tunnel:n})}catch(e){Fl.error("error collecting ngrok stats",{err:e})}s&&(rf=setTimeout(()=>Ul(),1e4))},nf=async s=>{if(!ws)return;clearTimeout(rf),s.tunnelDiagnostics&&await Ul(!1),await(await he("ngrok")).disconnect(ws)}});var tr,Bl,af,ov,iv,jl,Qo,ei,Zo,av,cf,lf,uf=w(()=>{"use strict";tr=E(require("os")),Bl=E(require("fs")),af=E(require("child_process"));U();Te();ov="https://github.com/cloudflare/cloudflared/releases/download/2022.4.1/",iv={win32ia32:{path:"cloudflared-windows-386.exe"},win32x64:{path:"cloudflared-windows-amd64.exe"},darwinx64:{path:"cloudflared-darwin-amd64.tgz",extract:!0},linuxia32:{path:"cloudflared-linux-386"},linuxx64:{path:"cloudflared-linux-amd64"}},jl=tr.tmpdir(),Qo=`${jl}/cloudflared`,ei=null,Zo=null,av=async()=>{if(await be(Qo))return;let e=iv[tr.platform()+tr.arch()];if(!e)throw new Error(`tunnel on ${tr.platform()+tr.arch()} platform is not supported.`);let t=e.extract?jl+e.path:Qo;await ze(`${ov}/${e.path}`,t),e.extract&&await tt(t,jl),await Bl.promises.chmod(Qo,"755")},cf=async s=>{let e=s.baseUrl||`http://localhost:${s.tunnelPort||80}`,t="tunnelRoutes"in s&&s.tunnelRoutes||[e],[r]=await Promise.all([ll(s.company.companyId,t),av()]);ei=r._id,Zo=af.spawn(Qo,["tunnel","--no-autoupdate","run","--force","--token",r.token],{stdio:"inherit"}),await ul(s.company.companyId,ei),"tunnelRoutesOutput"in s&&s.tunnelRoutesOutput&&await Bl.promises.writeFile(s.tunnelRoutesOutput,JSON.stringify(r.routesMapping,null,2)),s.baseUrl=`${s.tunnelUseHttpAddress?"http":"https"}://${r.routesMapping[e]}`},lf=async s=>{let e=[];return ei&&e.push(dl(s.company.companyId,ei)),Zo&&e.push(new Promise((t,r)=>{Zo.on("close",n=>{n&&r(new Error(`tunnel process exited with code ${n}`)),t()}),Zo.kill()})),await Promise.all(e)}});var K,pf,lv,uv,dv,df,ti,$l,M,ye=w(()=>{"use strict";K=E(require("rox-node"));j();U();le();pf=R("FeatureFlagsService"),lv=!Ne&&!0&&!Jd,uv=2e4,dv=60*60*24,df=["labs","disabled","enabled"],ti=class extends K.default.Variant{constructor(e="disabled"){super(e,df)}getValue(){let e=super.getValue();return df.includes(e)?e:(pf.warn('unexpected value for lab feature flag. Falling back to value "labs"',{featureFlagName:this.name,value:e}),"labs")}},$l=class{constructor(){this.flags={useNewWSCLI:new K.default.Flag,useSafariWebdriverVisibilityChecks:new K.default.Flag,useClickimVisibilityChecks:new K.default.Flag,runGetElementCodeInAut:new K.default.Flag,enableFrameSwitchOptimization:new K.default.Flag,maximumJsResultSize:new K.default.Configuration(2e3*1024),skipFileInputClicks:new K.default.Flag,errorMessageOnBadNetwork:new K.default.Flag(!0),warnOnBadNetwork:new K.default.Flag(!1),overrideAzureStorageUrl:new K.default.Flag,useJsInputCodeInSafari:new K.default.Flag,useJsInputCodeInFirefox:new K.default.Flag,autoSaveDownloadFileFireFox:new K.default.Flag(!0),safariSelectOptionDispatchEventOnSelectElement:new K.default.Flag(!0),experimentalPreCodeCompilation:new K.default.Flag(!0),experimentalAsyncCustomCode:new K.default.Flag,useSameBrowserForMultiTests:new ti("labs"),highSpeedMode:new ti,usePortedHtml5DragDrop:new K.default.Flag,testNamesToBeforeSuiteHook:new K.default.Flag,addCustomCapabilities:new K.default.Variant("{}"),enableWorkerThreadsCliCodeExecution:new K.default.Flag(!0),LTNetworkCapabilities:new K.default.Flag,downloadToBase64:new K.default.Flag,dec2022eolBrowsers:new K.default.Flag,publicGridURL:new K.default.Configuration("public-grid.testim.io"),allowAppFromDeviceRuns:new K.default.Flag(!0)},K.default.register("default",this.flags)}setProjectId(e){K.default.setCustomStringProperty("projectId",e)}setProjectType(e){K.default.setCustomStringProperty("projectType",e)}setCompanyProductType(e){K.default.setCustomStringProperty("productType",e)}setCompanyId(e){K.default.setCustomStringProperty("companyId",e)}setPlanType(e){K.default.setCustomStringProperty("planType",e)}setIsPOC(e){K.default.setCustomBooleanProperty("isPOC",e)}setIsStartUp(e){K.default.setCustomBooleanProperty("isStartUp",e)}setRunnerMode(e){K.default.setCustomStringProperty("runnerMode",e)}async fetch(){if(!lv)return;let e={fetchIntervalInSec:dv,disableNetworkFetch:!1};if(global.ProxyAgent){let t=new global.ProxyAgent(global.proxyUri);Object.assign(e,{httpsAgent:t,httpAgent:t})}return te(K.default.setup(zd,e),uv).catch(t=>pf.error("failed to get feature flag status",t))}},M=new $l});var ff,hf,rr,gf,yf,mf,pv,mv,ri,fv,hv,ee,si=w(()=>{"use strict";ff=E(require("ms")),hf=E(require("p-retry")),rr=E(require("os")),gf=E(require("portfinder")),yf=E(require("child_process"));U();It();Te();q();j();Go();ae();ye();mf=R("lambdatestService"),pv="https://downloads.lambdatest.com/tunnel/v3",mv={win32ia32:"windows/32bit/LT_Windows.zip",win32x64:"windows/64bit/LT_Windows.zip",darwinia32:"mac/32bit/LT_Mac.zip",darwinx64:"mac/64bit/LT_Mac.zip",darwinarm64:"mac/64bit/LT_Mac.zip",linuxia32:"linux/32bit/LT_Linux.zip",linuxx64:"linux/64bit/LT_Linux.zip",freebsdia32:"freebsd/32bit/LT_Freebsd.zip",freebsdx64:"freebsd/64bit/LT_Freebsd.zip"},ri=`${rr.tmpdir()}/LT`,fv=`${ri}/LT`,hv=(0,ff.default)("15m"),ee=class{constructor(){this.isActive=!1}static isLambdatestGrid(e){return e.type===ue.LAMBDATEST||e.type===ue.HYBRID&&e.provider==="lambdatest"}isLambdatestRun(){return this.isActive}async enableIfNeeded(e){ee.isLambdatestGrid(e)&&(ee.lambdatestConfigPromise||(ee.lambdatestConfigPromise=tl()),ee.lambdatestConfig=await ee.lambdatestConfigPromise,this.isActive=!0)}disable(){this.isActive=!1}get getSessionTimeout(){return this.isActive?hv:null}get getSessionRetries(){return this.isActive?1:null}static async prepareTunnel(){if(await be(fv))return;let t=mv[rr.platform()+rr.arch()];if(!t)throw new Error(`tunnel on ${rr.platform()+rr.arch()} platform is not supported.`);let r=`${ri}.zip`;await ze(`${pv}/${t}`,r),await tt(r,ri)}static async connectTunnel(e){if(e.externalLambdatestTunnelId){ee.tunnelName=e.externalLambdatestTunnelId;return}await this.prepareTunnel();let t=await gf.getPortPromise(),{gridData:r={},gridUsername:n,gridPassword:o}=e,i=global.proxyUri;ee.tunnelName=z();let a=["--tunnelName",ee.tunnelName,"--infoAPIPort",String(t)];if(e.externalLambdatestUseWss&&(a=[...a,"--mode","ws"]),e.externalLambdatestDisableAutomationTunneling&&(a=[...a,"--bypassHosts","run.testim.io,services.testim.io,api.coralogix.com,conf.rollout.io,statestore.rollout.io,push.rollout.io,analytic.rollout.io,res.cloudinary.com"]),r.tunnelUser&&r.tunnelKey)a=[...a,"--user",r.tunnelUser,"--key",r.tunnelKey];else if(n&&o)a=[...a,"--user",n,"--key",o];else throw new I("tunnel requires username and password");if(i)try{let d=new URL(i);a=[...a,"--proxy-host",d.hostname],d.port&&(a=[...a,"--proxy-port",d.port]),d.username&&d.password&&(a=[...a,"--proxy-user",d.username,"--proxy-pass",d.password])}catch{throw new I("proxy url is invalid")}e.externalLambdatestMitm&&(a=[...a,"--mitm"]),ee.tunnel=yf.spawn("./LT",a,{cwd:ri});let c="",l="";ee.tunnel.stdout.on("data",d=>{c+=d.toString()}),ee.tunnel.stderr.on("data",d=>{l+=d.toString()});try{let d=await(0,hf.default)(()=>Er(`http://127.0.0.1:${t}/api/v1.0/info`,{},{},void 0,{skipProxy:!0}),{retries:30,minTimeout:2e3});mf.info("LT tunnel info",d)}catch(d){throw mf.error("Failed to start LT tunnel",{err:d,stdoutResult:c,stderrResult:l}),d}}static async disconnectTunnel(e){if(!(e.externalLambdatestTunnelId||!ee.tunnel))return new Promise((t,r)=>{ee.tunnel.on("close",n=>{n&&r(new Error(`tunnel process exited with code ${n}`)),t()}),ee.tunnel.kill()})}getCapabilities(e,t,r,n,o){if(!this.isActive)return{};let i=ee.lambdatestConfig.CAPABILITIES[t]||{},a={...ee.tunnelName&&{tunnel:!0,tunnelName:ee.tunnelName}},c=[],{mode:l,canary:d,ext:m,extensionPath:p,installCustomExtension:f}=e;if(l===X.EXTENSION&&!m){let h=vl({canary:d},!0);!p&&h[t]&&(c=[...c,h[t]]),p&&Ge(p)&&(c=[...c,p])}return f&&Ge(f)&&(c=[...c,f]),{build:r,name:`${n} - ${o}`,platform:ee.lambdatestConfig.PLATFORM,selenium_version:ee.lambdatestConfig.SELENIUM_VERSION,resolution:ee.lambdatestConfig.RESOLUTION,timezone:ee.lambdatestConfig.TIMEZONE,...i,loadExtension:c,...a,console:!0,queueTimeout:300,network:M.flags.LTNetworkCapabilities.isEnabled()}}}});var Wl={};W(Wl,{connect:()=>oi,disconnect:()=>ii,serveTunneling:()=>yv});var ni,bf,wf,gv,oi,ii,yv,Gl=w(()=>{"use strict";of();bn();uf();xt();ni=E(require("ora"));j();ae();si();bf=R("tunnel"),wf=s=>{var e;return[ue.LAMBDATEST,ue.HYBRID].includes((e=s.gridData)==null?void 0:e.type)&&s.gridData.tunnel==="lambdatest"},gv=s=>{var e;return s.tunnelRoutes||((e=s.gridData)==null?void 0:e.type)===ue.HYBRID&&s.gridData.tunnel==="cloudflare"},oi=async s=>{if(!s.tunnel)return;let e=Bt(),t;try{wf(s)?(t=(0,ni.default)("Starting testim lambdatest tunnel...").start(),await ee.connectTunnel(s)):gv(s)?(t=(0,ni.default)("Starting testim cloudflare tunnel...").start(),await cf(s)):(t=(0,ni.default)("Starting testim ngrok tunnel...").start(),await sf(s,e)),t.succeed()}catch(r){let n="Failed to start tunnel. Please contact support@testim.io";throw bf.error("Failed to open tunnel",{err:r}),t==null||t.fail(n),new Error(n)}},ii=async s=>{if(s.tunnel)try{wf(s)?await ee.disconnectTunnel(s):"tunnelRoutes"in s?await lf(s):await nf(s)}catch(e){let t="catch error - failed to close tunnel";throw bf.error(t,{err:e}),new Error(t)}},yv=async(s,e=new Promise(()=>{}))=>(await oi(s),ms(()=>ii(s)),await e)});function bv(s){if(s.protocol)return s.protocol;if([ue.TESTIM,ue.BROWSERSTACK,ue.SAUCELABS].includes(s.type)&&s.port===443)return"https";if([ue.TESTIM_ENTERPRISE,ue.LAMBDATEST,ue.DEVICE_FARM].includes(s.type)){let e=Tf.exec(s.host);return(e==null?void 0:e[2])||"https"}return""}function wv(s){let e=Tf.exec(s);return e==null?void 0:e[3]}function ci(s){var y,T,C,b,v,x,k,D,S;let e=s&&wv(s.host),t=s==null?void 0:s.port,r=s==null?void 0:s.path,n=s&&bv(s),o=s==null?void 0:s.token,i=s==null?void 0:s.slotId,a=(y=s==null?void 0:s.hybrid)==null?void 0:y.tunnel,c=(T=s==null?void 0:s.external)==null?void 0:T.user,l=(C=s==null?void 0:s.external)==null?void 0:C.key,d=s==null?void 0:s.type,m=d===ue.HYBRID?a&&((x=(v=(b=s.hybrid)==null?void 0:b.external)==null?void 0:v[s.hybrid.tunnel])==null?void 0:x.user):c,p=d===ue.HYBRID?a&&((S=(D=(k=s.hybrid)==null?void 0:k.external)==null?void 0:D[s.hybrid.tunnel])==null?void 0:S.key):l,f=s==null?void 0:s.name,h=s&&(s._id||s.gridId),g=s==null?void 0:s.provider;return{host:e,port:t,path:r,protocol:n,accessToken:o,slotId:i,gridId:h,tunnel:a,user:c,key:l,type:d,name:f,provider:g,tunnelUser:m,tunnelKey:p}}async function Ef(s,e,t,r,n){let o;try{o=await n()}catch(i){throw Ye.error("failed to get grid",{projectId:s,companyId:e,err:i}),new Error(ss.UNKNOWN)}if(Ye.info("get grid info",Object.assign({},o,{projectId:s,companyId:e})),!o||!["success","error"].includes(o.status))throw Ye.error("invalid response - get grid",{res:o}),new Error(ss.UNKNOWN);if(o.status==="success"){let i=ci(o.grid);return Tv(t,e,i.gridId,i.slotId,r),i}throw o.code==="not-found"?new dt(ss.NOT_FOUND):o.code==="no-available-slot"?new yr(`Failed to run test on ${r} - concurrency limit reached`):(Ye.error("invalid code error response - get grid",{res:o}),new dt(ss.UNKNOWN))}function vv(s,e,t,r,n,o){return Ef(t,e,s,n,()=>Fo(e,t,r,n,o))}function Ev(s,e,t,r,n,o,i){return Ef(t,e,s,n,()=>{var l;let c=(l=i.allGrids)==null?void 0:l.find(d=>(d.name||"").toLowerCase()===r.toLowerCase());return c!=null&&c._id?Fo(e,t,c._id,n,o):Qc(e,t,r,n,o)})}function Sf(s){return el(s)}async function Rf(s,e,t){let n=(t||await Sf(s)).find(o=>o._id===e);if(!n)throw new I(`Failed to find grid id: ${e}`);return ci(n)}async function Sv(s,e,t){let n=(t||await Sf(s)).find(o=>(o.name||"").toLowerCase()===e.toLowerCase());if(!n)throw new I(`Failed to find grid name: ${e}`);return ci(n)}async function Vl(s,e){let t=En[s];if(!t)return;let{slotId:r,gridId:n,browser:o,companyId:i}=t;if(delete En[s],!r){Ye.warn("failed to find grid slot id",{projectId:e});return}Ye.info("release slot id",{projectId:e,companyId:i,slotId:r,gridId:n,browser:o});try{await Yc(i,e,r,n,o)}catch(a){Ye.error("failed to release slot",{projectId:e,err:a})}}async function Rv(s){let e=Object.values(En).filter(Boolean);if(e.length!==0){Ye.info("keep alive worker slots",{projectId:s,slots:e});try{await Jc(s,e)}catch(t){Ye.error("failed to update grid keep alive",{err:t,slots:e,projectId:s})}}}function Iv(s){vf=global.setInterval(Rv,1e4,s)}async function xv(s){let e=Object.keys(En);if(e.length){Ye.warn("not all slots released before end runner flow",{projectId:s});try{await de(e,t=>Vl(Number(t),s))}catch(t){Ye.error("failed to release all slots",{err:t,projectId:s})}}}async function Pv(s){await xv(s),clearInterval(vf)}function Cv(s,e){let{testobjectSauce:t,saucelabs:r}=e;if(s==="testobject")return t.testobjectApiKey;if(s==="saucelabs")return r.accessKey}function Av(s,e){let{saucelabs:t}=e;if(s==="saucelabs")return t.username}function If(s){let t=(()=>ai.isEmpty(s.testobjectSauce)?ai.isEmpty(s.saucelabs)?ai.isEmpty(s.perfecto)?"hostAndPort":"perfecto":"saucelabs":"testobject")(),{host:r,port:n,path:o,protocol:i}=s,a=Cv(t,s),c=Av(t,s);return{host:r,port:n,path:o,protocol:i,type:t,user:c,key:a}}async function xf(s,e){let t=s.company.companyId;return await Rf(t,e.gridId,s.allGrids)}async function Pf(s){let{allGrids:e=void 0,company:t,host:r,useLocalChromeDriver:n,useChromeLauncher:o,gridId:i,grid:a}=s;if(n||o)return{mode:"local"};if(r)return If(s);let c=t==null?void 0:t.companyId;if(i)return Rf(c,i,e);if(a)return Sv(c,a,e);if(Qs(s)||s.tunnelOnlyMode){Ye.info("skipping getting grid, as it is set on test plan",{companyId:c});return}throw new dt("Missing host or grid configuration")}async function Cf(s,e,t,r){return await(async()=>{let{host:i,project:a,grid:c,gridId:l,useLocalChromeDriver:d,useChromeLauncher:m,company:p}=t,f=p==null?void 0:p.companyId;if(d||m)return{mode:"local"};if(i)return If(t);if(l)return vv(r,f,a,l,s,e);if(c)return Ev(r,f,a,c,s,e,t);throw new dt("Missing host or grid configuration")})()}var ai,Ye,En,Tf,vf,Tv,Sn,Af,Ts=w(()=>{"use strict";ai=E(require("lodash"));Te();j();U();ae();q();Ye=R("grid-service"),En={},Tf=/(^(https?):\/{2})?(.*)/,vf=null;Tv=(s,e,t,r,n)=>{En[s]={gridId:t,companyId:e,slotId:r,browser:n}};Sn={start:Iv,end:Pv};Af=async(s={},e={},t={},r={},n={})=>{var h,g,y;let{company:{companyId:o}={}}=s,{gridId:i,type:a}=e,c=s.browser||t.browserValue,l=Boolean(s.tunnel),{maxRetries:d,currentRetry:m}=n;if(!i||!a||(a===ue.LAMBDATEST&&await((h=r.enableIfNeeded)==null?void 0:h.call(r,e)),a!==ue.HYBRID||!o||!c||!d||!m))return e;let p=await Xc({companyId:o,gridId:i,maxRetries:d,currentRetry:m,browser:c,usingTunnel:l});Ye.info("handling hybrid grid",{response:p,companyId:o});let f=ci({...e,...p.connectionDetails,provider:p.provider});return p.provider!=="lambdatest"&&((g=r.disable)==null||g.call(r)),p.provider==="lambdatest"&&await((y=r.enableIfNeeded)==null?void 0:y.call(r,f)),f}});function In(){return li||"master"}function kf(s="master",e="false"){if(typeof s!="string"&&(s!=null&&s.branch)&&s.branch==="master"){li="master";return}if(s&&!s.isArchived){li=s.branch||s;return}li=e?"master":void 0}var li,ql=w(()=>{"use strict"});var xn,Hl,kv,zl,_v,Kl,ui,di,pi,mi,fi,hi=w(()=>{"use strict";U();ae();xn=s=>{let{status:e,sessionType:t,success:r,mobile:n}=s;return n!=null&&n.isAppFromDevice||n!=null&&n.isAppForIosVirtualDevice?!1:e===pe.FAILED||t===Ft.CODEFUL&&r===!1},Hl=s=>{let{status:e}=s;return e===pe.ABORTED},kv=s=>{let{status:e,sessionType:t,success:r}=s;return e===pe.PASSED||t===Ft.CODEFUL&&r===!0},zl=s=>s.runnerStatus===pc.SKIPPED,_v=s=>s.testStatus===Ke.EVALUATING,Kl=(s,e)=>e?!s.runConfig:!1,ui=(s,e)=>Object.values(s).filter(t=>{var r,n;return zl(t)&&Je(t,e||((r=t.mobile)==null?void 0:r.isAppFromDevice)||((n=t.mobile)==null?void 0:n.isAppForIosVirtualDevice))}).length,di=s=>Object.values(s).filter(e=>xn(e)&&_v(e)).length,pi=(s,e)=>Object.values(s).filter(t=>xn(t)&&!Kl(t,e)),mi=(s,e)=>Object.values(s).filter(t=>kv(t)&&!Kl(t,e)),fi=(s,e)=>Object.values(s).filter(t=>Hl(t)&&!Kl(t,e))});function Ov(s){let e=s.indexOf("--token");if(e===-1&&(e=s.indexOf("--t")),e!==-1)try{let t=s.slice();return t.splice(e,2),t}catch{}return s}var gi,Of,yi,Lf=w(()=>{"use strict";j();hi();gi=R("debug-reporter"),Of={token:void 0,userParamsData:void 0,projectData:void 0,allGrids:void 0,gridData:void 0,awsAccessKeyId:void 0,awsSecretAccessKey:void 0,runParams:void 0,perfecto:void 0,testobjectSauce:void 0},yi=class{constructor(e){this.options=e}onTestStarted(e,t){gi.info("Test Started",{testId:e.testId,testName:e.name,resultId:e.resultId,workerId:t})}onTestFinished(e,t){let r=this.options.gridData||{},n=r.provider,o=r.host,i=r.gridId,a=r.type,c=r.failedGetBrowserAttempts;gi.info("Test Finished",{testId:e.testId,testName:e.name,resultId:e.resultId,success:e.success,duration:e.duration,browser:this.options.browser,companyId:this.options.company.companyId,grid:{provider:n,host:o,failedGetBrowserAttempts:c,id:i,type:a},workerId:t})}onTestPlanStarted(e,t,r,n,o,i,a){let c=Ov(process.argv);gi.info("Test Plan Started",{executionId:o,testPlanName:n,isAnonymous:i,configName:a,options:Object.assign({},this.options,Of),args:c})}onTestPlanFinished(e,t,r,n,o,i){let a=mi(e,i).length,c=Object.keys(e).length-a;gi.info("Test Plan Finished",{isAnonymous:o,passed:a,failed:c,testPlanName:t,options:Object.assign({},this.options,Of),duration:r,executionId:n})}}});var Jl,Ct,Pn=w(()=>{"use strict";ae();Jl=class{constructor(){this._planType="free"}setPlanType(e){this._planType=e}get isTestStatusEnabled(){return["pro","trial"].includes(this._planType)}shouldShowFreeGridRunWarning(e){return this._planType!=="pro"&&e===ue.DEVICE_FARM}},Ct=new Jl});var Xl={};W(Xl,{Reporter:()=>Lv});var sr,Cn,Lr,bi,Nf,Yl,Lv,Ql=w(()=>{"use strict";sr=E(require("chalk")),Cn=E(require("lodash"));U();ae();Pn();hi();Lr={success:sr.default.green,warn:sr.default.yellow,error:sr.default.red},{CLI_MODE:bi}=Ut,Nf="device",Yl=class{constructor(e,t){this.options=e;this.branchToUse=t;this.config={showWorkerNames:e.parallel>1}}toWorkerIdPrefix(e){return this.config.showWorkerNames?`W:${e}`:""}printWorkerDivider(){console.log("-".repeat(process.stdout.columns||83))}onTestStarted(e,t,r,n){let o=n?"File":"Test",i=e.isTestsContainer?"":`(${e.testId})`,a=e.isTestsContainer?"":`url: ${sr.default.underline(ct(this.options.editorUrl,this.options.project,e.testId,e.resultId,this.branchToUse))}`;console.log(this.toWorkerIdPrefix(t),`${o} "${e.name}" started ${i} ${a}`.trim())}onTestFinished(e,t,r,n){if(n)return;let o=e.success?pe.PASSED:pe.FAILED,i=e.isTestsContainer?" ":`(${e.testId})`,a=Lr[e.success?"success":"error"];console.log(a(this.toWorkerIdPrefix(t),`Test "${e.name}" finished status: ${o} ${i} duration: ${mo(e.duration)}`))}printAllFailedTests(e){if(!e.length)return;let t=e.map(r=>{let n=ct(this.options.editorUrl,this.options.project,r.testId,r.resultId,this.branchToUse);return r.isTestsContainer?r.name:`${r.name} : ${n}`});console.log(Lr.error("Failed runs are:")),console.log(Lr.error(t.join(`
\r`)))}onTestPlanFinished(e,t,r,n,o,i){let a=pi(e,i),c=mi(e,i),l=fi(e,i),d=c.length,m=l.length,p=a.length,f="",h="";if(Ct.isTestStatusEnabled){let b=di(e);f=` FAILED-EVALUATING: ${b}`,p-=b,h=` SKIPPED: ${ui(e,this.options)}`}let g=this.buildTestPlanName(o,t,i),y,T=Lr[p?"error":"success"],C=`PASSED: ${d} FAILED: ${p}${f} ABORTED: ${m}${h} Duration: ${mo(r)}`;i||g.trim()===""||g.trim()==="Anonymous"?y=`Tests completed. ${C} (Execution ID: ${n})`:y=`Test plan${g} completed ${C} (${n})`,this.printWorkerDivider(),console.log(T(y)),this.printWorkerDivider(),this.printAllFailedTests(a)}buildTestPlanName(e,t,r){if(r)return"";let n=Cn.isEmpty(this.options.suites)?"":`Suite: ${this.options.suites}`,o=Cn.isEmpty(this.options.label)?"":`Label: ${this.options.label}`,i=Cn.isEmpty(this.options.name)?"":`Name: ${this.options.name}`,a=Cn.isEmpty(this.options.testId)?"":`Test Id: ${this.options.testId}`,c=[i,o,n,a].filter(Boolean).join(", ");return e?` anonymous (${c})`:` '${t}'`}onTestPlanStarted(e,t,r,n,o,i,a,c){let l=p=>{p.forEach((f,h)=>{var T;let g=(T=f.testData)!=null&&T.index?`- ${f.testData.index} / ${f.testData.total} Data set`:"",y=c?"":`(${f.testId})`;console.log("	",h+1,":",`${f.name}${Je(f,this.options)?"-quarantine":""}`,y,g)})},d=a?`config '${a}'`:"default configs";if(c)console.log(`Run test plan, Project: ${this.options.project} (Execution ID: ${o}):`);else{let p=this.options.sfdcCredential?` SfdcCredential: ${this.options.sfdcCredential}`:"",f=`${d}, Project: ${this.options.project}, Branch: ${this.branchToUse}${p}`;console.log(`Run${this.buildTestPlanName(i,n)} test plan with ${f} (${o})`)}this.printWorkerDivider(),e.length>0&&(console.log("Before all:"),l(e)),console.log(c?"File list:":"Test list:"),l(t),r.length>0&&(console.log("After all:"),l(r)),this.printWorkerDivider()}onGetSlot(e,t){let r=this.options.grid||this.options.gridId,n=this.options.mode===bi.APPIUM?Nf:t;r&&console.log(this.toWorkerIdPrefix(e),`Get ${sr.default.underline(n)} slot from ${sr.default.underline(r)}`)}onGetSession(e,t,r){let n=r===bi.APPIUM?Nf:"browser";console.log(this.toWorkerIdPrefix(e),`Get ${n} to run ${sr.default.underline(t)}`)}onWaitToTestStart(e){console.log(this.toWorkerIdPrefix(e),"Wait for test start")}onWaitToTestComplete(e,t,r){let n=t?"file":"test";console.log(this.toWorkerIdPrefix(e),`Wait for ${n} complete`),r&&t&&console.log(this.toWorkerIdPrefix(e),`Chrome Debugger available at ${r}`)}onGetBrowserFailure(e,t,r){if(r!==2)return;let n=this.options.grid||this.options.gridId,o=this.options.mode===bi.APPIUM?"device":"browser";if(n)console.log(Lr.warn(this.toWorkerIdPrefix(e),`It is taking us some time to get a ${o} from the grid ${n}`));else if(this.options.useLocalChromeDriver)console.log(Lr.warn(this.toWorkerIdPrefix(e),"We are having issues starting ChromeDriver for you locally"));else if(this.options.host){let i=this.options.mode===bi.APPIUM?"Appium":"Selenium";console.log(Lr.warn(this.toWorkerIdPrefix(e),`We are having issues reaching your ${i} grid at ${this.options.host}:${this.options.port||4444}`))}}},Lv=Yl});var tu={};W(tu,{Reporter:()=>jv});function Nv(s){let e=s.testData||{},t=typeof e.total=="number"?` - ${e.index} / ${e.total} Data set`:"";return`${s.name}${t}`}function Dv(s){return s.visitedUrlsList||console.log("No URLs found:","Please contact our support team or remove the --urls flag from the CLI command"),`${s.visitedUrlsList||""}`}function Mv(s){return`${s.visitedUrlsJson||""}`}async function Fv(s,e,t,r,n,o){function i(p){let f=ct(s,t,p.testId,p.resultId,r),h={$:{name:Nv(p),classname:n,time:yc(p.duration),ownedBy:p.testOwnerName,ownerEmail:p.testOwnerEmail},"system-out":f};if(xn(p)||Hl(p)){let g=`Step Failed: ${p.failureReason||p.reason}`,y=xn(p)?`${g} More info at: ${f}`:g;h.failure={$:{message:y}}}return zl(p)&&Je(p,o)&&Ct.isTestStatusEnabled&&(h.skipped={}),o.urls&&(h["visited-urls-list"]=Dv(p),h["visited-urls-json"]=Mv(p)),h}function a(p){let{results:f,testPlanName:h,configName:g}=p,y=f||{},C={name:(g&&h?`${h} with config '${g}'`:h)||"selenium run",tests:l(y),failure:d(y),timestamp:c(e)};if(Ct.isTestStatusEnabled){C.skipped=ui(y,o);let b=di(y);C.failure-=b,C["failure-evaluating"]=b}return{$:C,testcase:Object.keys(y).map(b=>i(y[b]))}}function c(p){let f=Object.keys(p).map(g=>p[g].startTime),h=Math.min.apply(null,f);return h?new Date(h).toISOString():new Date().toISOString()}function l(p){return Object.keys(p).length}function d(p){return pi(p).length+fi(p).length}let m={testsuites:{testsuite:e.map(p=>a(p))}};try{return new eu.Builder().buildObject(m)}catch(p){return Uv(p)}}function Uv(s){let e=new eu.Builder,t={testsuites:{testsuite:{$:{name:"selenium run",tests:1,failure:1,timestamp:Date.now()},testcase:{$:{name:"junit reporter generator failed",classname:"testim.io.jUnitXmlReporter"},error:{$:{message:s.message}}}}}};return e.buildObject(t)}var eu,Df,Zl,jv,ru=w(()=>{"use strict";eu=E(require("xml2js"));U();Df=require("fs");Pn();hi();Zl=class{constructor(e,t){this.options=e;this.branchToUse=t;this.classname="testim.io.test",typeof e.reportFileClassname=="string"&&(this.classname=e.reportFileClassname),e.reportFileClassname===!0&&(this.classname="")}async createResultsReport(e){let t=this.options.reportFile,r=this.options.project,n=await Fv(this.options.editorUrl,e,r,this.branchToUse,this.classname,this.options);if(t)try{return await Df.promises.writeFile(t,n),console.log("JUnit XML file saved to",t),e}catch(o){return console.error("could not save report file",t,o),e}}async onAllTestPlansFinished(e){await this.createResultsReport(e)}};jv=Zl});var Mf={};W(Mf,{Reporter:()=>Bv});function vs(s){return s?s.replace(/\|/g,"||").replace(/'/g,"|'").replace(/\n/g,"|n").replace(/\r/g,"|r").replace(/\u0085/g,"|x").replace(/\u2028/g,"|l").replace(/\u2029/g,"|p").replace(/\[/g,"|[").replace(/\]/g,"|]"):""}var su,nu,Bv,Ff=w(()=>{"use strict";j();su=R("team-city-reporter");nu=class{constructor(e){this.options=e}getPrintName(e){let t=e.config||{},r=typeof t.testDataTotal=="number"?` - ${t.testDataIndex} / ${t.testDataTotal} Data set`:"",n=`${e.name} (${e.testId})${r}`;return vs(n)}onTestStarted(e,t,r,n,o){if(r){su.debug("skip report test started because is rerun");return}let i=this.getPrintName(e);console.log(`##teamcity[testStarted name='${i}' captureStandardOutput='true' flowId='${o}']`)}onTestFailed(e,t,r,n,o,i){if(o){su.debug("skip report test failed because is rerun");return}let a=this.getPrintName(e);console.log(`##teamcity[testFailed name='${a}' message='${vs(t)}' details='${vs(r)}' flowId='${i}']`)}onTestFinished(e,t,r){if(r){su.debug("skip report test finished because is rerun");return}let n=this.getPrintName(e);console.log(`##teamcity[testFinished name='${n}' duration='${e.duration}' flowId='${e.resultId}']`)}onTestIgnored(e,t,r="ignore"){let n=this.getPrintName(t);console.log(`##teamcity[testIgnored name='${n}' message='${vs(r)}']`)}onTestPlanStarted(e,t,r,n){console.log(`##teamcity[testSuiteStarted name='${vs(n)}']`)}onTestPlanFinished(e,t){console.log(`##teamcity[testSuiteFinished name='${vs(t)}']`)}},Bv=nu});var Uf={};W(Uf,{Reporter:()=>$v});var ou,$v,jf=w(()=>{"use strict";ou=class{constructor(e){this.options=e}onTestStarted(e,t){console.log(JSON.stringify({name:"testStarted",data:{test:e,workerId:t}}))}onTestFinished(e,t){console.log(JSON.stringify({name:"testFinished",data:{test:e,workerId:t}}))}onTestPlanStarted(e,t,r,n,o){let i={name:"suiteStarted",data:{projectId:this.options.project,executionId:o}};console.log(JSON.stringify(i))}onTestPlanFinished(e){console.log(JSON.stringify({name:"suiteFinished",data:{testResults:e}}))}},$v=ou});var Bf={};W(Bf,{Reporter:()=>Wv});var iu,Wv,$f=w(()=>{"use strict";U();El();iu=class{constructor(e,t){this.options=e;this.branchToUse=t}onTestStarted(e,t,r,n){if(n)return;let o=ct(this.options.editorUrl,this.options.project,e.testId,e.resultId,this.branchToUse);return qo(o)}},Wv=iu});var Gv,au,Q,Gt=w(()=>{"use strict";Lf();j();Gv=R("reporter"),au=class{constructor(){this.reporters=[];this.onGetBrowserFailure=this.generateHook("onGetBrowserFailure");this.onGetBrowserSuccess=this.generateHook("onGetBrowserSuccess");this.onTestPlanStarted=this.generateHook("onTestPlanStarted");this.onGetSlot=this.generateHook("onGetSlot");this.onGetSession=this.generateHook("onGetSession");this.onTestFinished=this.generateHook("onTestFinished");this.onTestFailed=this.generateHook("onTestFailed");this.onTestPassed=this.generateHook("onTestPassed");this.onTestStarted=this.generateHook("onTestStarted");this.onTestIgnored=this.generateHook("onTestIgnored");this.onWaitToTestStart=this.generateHook("onWaitToTestStart");this.onWaitToTestComplete=this.generateHook("onWaitToTestComplete");this.onTestPlanFinished=this.generateHook("onTestPlanFinished",this.onTestPlanFinishedMutator);this.onAllTestPlansFinished=this.generateHook("onAllTestPlansFinished",this.onAllTestPlansFinishedMutator)}async setOptions(e,t){this.reporters=[];let r=e.reporters;if(this.reporters.push(new yi(e)),r===void 0||r.length===0){let{Reporter:n}=await Promise.resolve().then(()=>(Ql(),Xl));if(this.reporters.push(new n(e,t)),(e==null?void 0:e.reportFile)!==void 0){let{Reporter:o}=await Promise.resolve().then(()=>(ru(),tu));this.reporters.push(new o(e,t))}}else(await Promise.all([r.includes("teamcity")&&Promise.resolve().then(()=>(Ff(),Mf)),r.includes("console")&&Promise.resolve().then(()=>(Ql(),Xl)),r.includes("junit")&&Promise.resolve().then(()=>(ru(),tu)),r.includes("json")&&Promise.resolve().then(()=>(jf(),Uf)),r.includes("chrome")&&Promise.resolve().then(()=>($f(),Bf))])).forEach(o=>{o&&this.reporters.push(new o.Reporter(e,t))})}onTestPlanFinishedMutator(e,t,r,n,o,i,a){let c={};if(a){let d=Object.values(a);if(d.length>0){for(let m of Object.values(a))c[m.id]=m;for(let m of Object.keys(e))d.some(p=>p.parentResultId!==m)||(c[m]=e[m])}else Gv.warn("childTestResults is not array"),c=e}else c=e;let l=Date.now()-(r||0);return[c,t,l,n,o,i,void 0]}onAllTestPlansFinishedMutator(e){for(let t of e)if(t.childTestResults){t.results={};let r=Object.values(t.childTestResults);for(let n of r)t.results[n.id]=n;for(let n of Object.keys(e))r.some(o=>o.parentResultId!==n)||(t.results[n]=e[n])}return[e]}generateHook(e,t){return async(...r)=>{var o;let n=t==null?void 0:t(...r);for(let i of this.reporters)await((o=i[e])==null?void 0:o.call(i,...n||r))}}},Q=new au});function Gf(s,e){return e!=null&&e.type&&(s[`${e.type}Mode`]=!0),s}function Vf({executionId:s,projectId:e,testId:t,resultId:r,companyId:n,companyName:o,projectName:i,companyPlan:a,sessionType:c,source:l,user:d,lightweightMode:m,isStartUp:p,projectType:f,appSource:h}){let g=Gf({executionId:s,projectId:e,testId:t,resultId:r,companyId:n,companyName:o,projectName:i,companyPlan:a,sessionType:c,source:Wf(l,d),isStartUp:p,projectType:f,...["android","ios"].includes(f)&&h&&{appSource:h}},m);gt("test-run-ci",g)}function qf({executionId:s,projectId:e,testId:t,resultId:r,result:n,companyId:o,companyName:i,projectName:a,companyPlan:c,sessionType:l,source:d,user:m,lightweightMode:p,logger:f,isStartUp:h,projectType:g,appSource:y}){try{let T=Gf({executionId:s,projectId:e,testId:t,resultId:r,companyId:o,companyName:i,projectName:a,companyPlan:c,sessionType:l,mockNetworkEnabled:n.wasMockNetworkActivated,source:Wf(d,m),isStartUp:h,projectType:g,...["android","ios"].includes(g)&&y&&{appSource:y}},p);if(n.success){gt("test-run-ci-success",T);return}gt("test-run-ci-fail",Object.assign({},T,{failureReason:n.failureReason}))}catch(T){f.error("failed to update test end analytics",{err:T})}}function Hf({executionId:s,projectId:e,sessionType:t}){gt("batch-run-ci",{executionId:s,projectId:e,sessionType:t})}var Wf,cu=w(()=>{"use strict";hs();No();Wf=(s,e)=>s!=="cli"&&s!=="cli-local"?s:ds&&e?"ci-with-user":ds?"ci":e?"cli-with-user":s});var Vv,Kf=w(()=>{"use strict";Vv=require("istanbul-lib-report")});var Jf,Yf,qv,Xf,Nr,Hv,Qf,lu,zv,Zf,eh=w(()=>{"use strict";Jf=E(require("ora")),Yf=E(require("moment")),qv=E(require("test-exclude")),Xf=E(require("fs")),Nr=E(require("path")),Hv=E(require("istanbul-reports")),Qf=E(require("istanbul-lib-report"));Te();q();U();j();bt();Kf();lu=R("test-run-status"),zv=async(s,e,t)=>{let{mergeProcessCovs:n}=await he("@bcoe/v8-coverage"),o={result:[]},i=new Map,c=(await hn(s,"testResult",`runId=${t}`)).data.docs;return await de(c.flatMap(l=>l.JSCoverageURLS||[]),async l=>{let d=await fn(l,9e4);await de(d,async m=>{if(!i.has(m.url)){let p=m.text;m.sourceUrl&&(i.set(m.url,"TEMP"),p=await(void 0)(m.sourceUrl)),i.set(m.url,{text:p,url:m.url,sourceMapType:m.sourceMapType,hash:m.hash})}delete m.text,o=n([o,{result:[m]}])})},{concurrency:20}),{covUrlMap:i,mergedCoverages:o}},Zf=async(s,e,t,r)=>{if(!s.collectCodeCoverage)return;lu.info("start js coverage process");let n=(0,Jf.default)(`analyzing coverage for ${t} ${t===1?"test":"tests"}`).start(),o=Nr.resolve(s.codeCoverageReportPath||"./coverage"),i=Nr.resolve(o,`.js/${(0,Yf.default)().format("DDMMYYYYHHmmss")}`),a=s.codeCoverageSourceMapPath?Nr.resolve(s.codeCoverageSourceMapPath):void 0;try{let[c,{mergedCoverages:l,covUrlMap:d}]=await Promise.all([he("istanbul-lib-coverage"),zv(s.project,e,r)]);if(l.result.length===0){n.fail("Failed to report coverage information - js code coverage is empty");return}lu.info("start js coverage merge and remap",{numOfFiles:d.size,numMergedCoverages:l.result.length});let m=c.createCoverageMap({}),p={};await de(l.result,async({url:h,functions:g})=>{let{text:y,sourceMapType:T}=d.get(h),C=await(void 0).getSourceMap({sourceMapType:T,url:h,source:y,sourceMapDir:a});p[h]=C;let b=await(void 0).convertV8ToIstanbul(s,{source:y,sourceMap:C,functions:g});m.merge(b)}),await(void 0).remapCoverage(s,i,p);let f=await(void 0).saveCoverageReports(s,m,o,i);return n.succeed(),f}catch(c){let l="Failed to report coverage information";c instanceof I?n.fail(`${l}, missing arg: ${c.message}`):n.fail(l),lu.error(l,{err:c})}}});var th={};W(th,{SELENIUM_PERF_MARKS:()=>Ae,SeleniumPerfStats:()=>Vt});var Ae,Vt,Es=w(()=>{"use strict";U();Ae={GET_BROWSER:"GET_BROWSER",GET_HTML:"GET_HTML",GET_ELEMENT:"GET_ELEMENT",GET_SCREENSHOT:"GET_SCREENSHOT"},Vt=class{constructor(){this.marks=Object.fromEntries(Object.values(Object.assign({ALL:"ALL"},Ae)).map(e=>[e,[]]));this.startTimes={}}markStart(e){let t=z();return this.startTimes[`${e}:${t}`]=Date.now(),t}markEnd(e,t){let r=Date.now()-this.startTimes[`${t}:${e}`];if(delete this.startTimes[`${t}:${e}`],!this.marks[t]){this.marks.ALL.push(r);return}this.marks[t].push(r)}getStats(){let e=Object.entries(this.marks).flatMap(([t,r])=>!Array.isArray(r)||!r.length?[]:[[`${t}_COUNT`,r.length],[`${t}_P50`,go(r,50)],[`${t}_P95`,go(r,95)]]);return{seleniumPerfMarks:this.marks,seleniumStats:Object.fromEntries(e)}}}});var oh={};W(oh,{initServer:()=>Yv,mapFilesToLocalDrive:()=>du});function du(s,e){var t;try{s.failurePath=(s.failurePath||[]).map(r=>Object.assign(r,wi[r.id]?{screenshot:wi[r.id]}:{})),Object.keys(Ss).forEach(r=>{s.assets||(s.assets={}),s.assets[nh[r]]=Ss[r]}),s.assets||(s.assets={}),s.assets.screenshots=Object.values(wi)}catch(r){e&&e.error("failed to map files to local drive",{err:r}),s.failurePath||(s.failurePath=[]),s.assets||(s.assets={}),(t=s.assets).screenshots||(t.screenshots=[])}}async function Yv({agentPort:s,agentBind:e,saveRCALocally:t}){let r=await he("multer"),n=typeof t=="string"?t:Kv;await uu.promises.mkdir(n,{recursive:!0});let o=r({storage:r.diskStorage({async destination(c,l,d){let m=JSON.parse(c.body.metadata||"{}");if(!m.testResultId)return d(new Error("missing testResultId"),"");let p=An.join(n,m.testResultId);try{await uu.promises.mkdir(p,{recursive:!0})}catch(f){return d(f,"")}return d(null,p)},filename(c,l,d){let{fileName:m}=c.body,p=JSON.parse(c.body.metadata||"{}");if(!p.stepId&&!m)return d(new Error("missing stepId or fileName"),"");if(p.stepId){let f=An.extname(m);return d(null,`step_${p.stepId}_${p.stepName||""}${f}`.replace(/[/\\?%*:|"<>\s]/g,"-"))}return d(null,m)}})}),i=(0,sh.default)();i.post("/",o.single("file"),(c,l)=>{var m;let d=JSON.parse(c.body.metadata||"{}");d.stepId&&(wi[d.stepId]=c.file.path),d.testResultId&&Jv.includes(d.subType)&&(Ss[m=d.subType]||(Ss[m]=[]),Ss[d.subType].push(c.file.path)),l.sendStatus(200)}),i.use((c,l)=>l.status(404).send("Endpoint Not Found"));let{createServer:a}=await import("http");return await new Promise((c,l)=>{let d=a(i);d.listen(s,e),d.on("error",m),d.on("listening",()=>c(d.address()));function m(p){if(p.syscall!=="listen")return l(p);switch(p.code){case"EACCES":case"EPERM":return l(new I(`Port ${s} requires elevated privileges`));case"EADDRINUSE":return l(new I(`Port ${s} is already in use`));default:return l(p)}}})}var uu,rh,An,sh,Kv,wi,Ss,nh,Jv,pu=w(()=>{"use strict";uu=E(require("fs")),rh=E(require("os")),An=E(require("path")),sh=E(require("express"));q();bt();Kv=An.join(rh.tmpdir(),"testim/rca/"),wi={},Ss={},nh={"test-log":"consoleLogs","har-file":"networkLogs"},Jv=Object.keys(nh)});var nr,mu,Ti,ih=w(()=>{"use strict";nr=E(require("lodash"));U();j();mu=R("override-test-data-builder"),Ti=class{constructor(e,t,r){this.params=e;this.testInfoList=t;this.projectId=r}isObjectNotArray(e){return nr.isObject(e)&&!Array.isArray(e)}isArrayOfObjects(e){return Array.isArray(e)&&e.filter(t=>!this.isObjectNotArray(t)).length===0}overrideTestData(){let{params:e,projectId:t}=this;return this.isObjectNotArray(e)&&typeof e.overrideTestData<"u"&&(this.isObjectNotArray(e.overrideTestData)&&!nr.isEmpty(e.overrideTestData)?(Object.keys(e.overrideTestData).forEach(r=>this.overrideSingleTest(r,e.overrideTestData[r])),delete e.overrideTestData):mu.error("invalid overrideTestData",{overrideTestData:e.overrideTestData,projectId:t})),this.isObjectNotArray(e)&&typeof e.overrideAllTestsData<"u"&&(nr.isObject(e.overrideAllTestsData)&&!nr.isEmpty(e.overrideAllTestsData)?(this.testInfoList.map(n=>n.name).forEach(n=>this.overrideSingleTest(n,e.overrideAllTestsData)),delete e.overrideAllTestsData):mu.error("invalid overrideAllTestsData",{overrideAllTestsData:e.overrideAllTestsData,projectId:t})),this.testInfoList}overrideSingleTest(e,t){let{projectId:r}=this;if(this.isObjectNotArray(t)||this.isArrayOfObjects(t)){this.replaceAndCreateOverrideTestData(e,t);return}mu.error("skip override test data to test name",{testName:e,projectId:r}),console.error(`Invalid override test data provided to test '${e}'`)}replaceAndCreateOverrideTestData(e,t){let r=this.mapTestListToUniqueId(e);if(r.length!==0)return this.createNewTestPerOverrideTestData(r,t)}mapTestListToUniqueId(e){let{testInfoList:t}=this;return nr.chain(t).map(r=>{if(r.name.toLowerCase()===e.toLowerCase())return this.generateTestUniqId(r)}).compact().uniq().value()}createNewTestPerOverrideTestData(e,t){let{testInfoList:r}=this;return[...new Set(e)].map(n=>{let o=r.map(d=>this.generateTestUniqId(d)),i=o.indexOf(n),a=o.lastIndexOf(n),c=r[i],l=this.createNewTestItems(c,t);return r.splice(i,a-i+1,...l)})}createNewTestItems(e,t){return[].concat(t).map((r,n)=>{let o=z();return Object.assign({},e,{resultId:o,testData:{value:r,index:n+1,total:t.length||1}})})}getTestType(e){return e.isBeforeTestPlan?"before":e.isAfterTestPlan?"after":"test"}generateTestUniqId(e){return`${e.testId}:${e.testConfig.id}:${this.getTestType(e)}`}}});async function vi(s,...e){if(!(!s||typeof s!="function"))try{return await s(...e)||{}}catch(t){throw ot.warn("failed to run hook",{err:t}),new I(`failed to run hook promise ${t.message}`)}}var Dr,ot,Xv,Qv,Zv,eE,Ei,ah=w(()=>{"use strict";Dr=E(require("lodash"));U();ae();Ts();Te();q();j();Gt();bn();eh();Es();pu();le();ye();ih();Pn();ot=R("test-run-status"),Xv=xr(),Qv=process.env.GIT_COMMIT||process.env.CIRCLE_SHA1||process.env.TRAVIS_COMMIT,Zv=process.env.GIT_URL||process.env.CIRCLE_REPOSITORY_URL,eE=lt();Ei=class{constructor(e,t,r,n){this.testInfoList=e;this.options=t;this.branchToUse=n;this.exportsGlobal={};this.startTime=null;this.beforeSuiteParams={};this.executionStartedPromise=Promise.resolve();this.seleniumPerfStats=new Vt;var a,c,l,d,m;(a=this.options).runParams||(a.runParams={}),this.fileUserParamsData=this.options.userParamsData;let o=Xs(t,e),i=t.lightweightMode?t.lightweightMode.type:t.mode;this.execConfig={parallel:io||t.parallel||1,browser:o,gitBranch:Xv,gitCommit:Qv,gitRepoUrl:Zv,runnerVersion:eE,gridHost:t.host||((c=t.gridData)==null?void 0:c.host),testimBranch:n,canaryMode:t.canary,source:t.source,schedulerId:t.schedulerId,testPlanId:r,testPlans:t.testPlan,testLabels:t.label,testSuites:[...new Set(e.flatMap(p=>p.testSuites))],testNames:t.name,testIds:t.testId,testConfigs:t.testConfigNames,testConfigIds:t.testConfigIds,port:t.port,browserTimeout:t.browserTimeout,timeout:t.timeout,newBrowserWaitTimeout:t.newBrowserWaitTimeout,tunnel:t.tunnel,tunnelPort:t.tunnelPort,tunnelHostHeader:t.tunnelHostHeader,runnerMode:i,gridId:t.gridId||((l=t.gridData)==null?void 0:l.gridId),gridName:t.grid||((d=t.gridData)==null?void 0:d.name),gridType:(m=t.gridData)==null?void 0:m.type,retentionDays:t.retentionDays,codeCoverageReportPath:t.codeCoverageReportPath,collectCodeCoverage:t.codeCoverageUrlFilter||t.collectCodeCoverage,sessionType:Rr(t)},this.testRunStatus=this.calcTestRunStatus()}waitForExecutionStartedFinished(){return this.executionStartedPromise}getTestResult(e){return this.testRunStatus[e]}async addRetryTestResult({newResultId:e,originalTestResultId:t,previousTestResultId:r,projectId:n,executionId:o,retryCount:i=1}){let a=this.testRunStatus[t]||{},{config:c,isTestsContainer:l,testId:d,name:m,testStatus:p,testCreatorName:f,testCreatorEmail:h,testOwnerName:g,testOwnerEmail:y,testLabels:T,testSuites:C,allLabels:b}=a,v={originalTestResultId:t,previousTestResultId:r,config:Dr.cloneDeep(c),testId:d,status:"QUEUED",name:m,resultId:e,isTestsContainer:l,retryCount:i,testStatus:p};return this.testRunStatus[e]=Object.assign({},v,{testCreatorName:f,testCreatorEmail:h,testOwnerName:g,testOwnerEmail:y,testLabels:T,testSuites:C,allLabels:b}),al({projectId:n,runId:o,testId:d,newResultId:e,originalTestResultId:t,previousTestResultId:r,testResult:v})}getAllTestResults(){return this.testRunStatus}testStart(e,t,r,n){let o=this.getTestResult(r);o.workerId=e;let i=this.options.files.length>0;return Q.onTestStarted(o,e,n,i,r),o}async updateTestStatusRunning(e,t,r){var l;let{project:n,remoteRunId:o,projectData:i}=this.options;if((l=this.options.lightweightMode)!=null&&l.onlyTestIdsNoSuite)return this.executionStartedPromise;let a="";try{a=await Uo(n,e.testId,e.resultId,e.config.testData,i.defaults)||""}catch(d){ot.error("failed to upload test data artifact (runner)",{err:d})}let c=Dr.cloneDeep(e.config);return delete c.testData,c.testDataUrl=a,await this.executionStartedPromise,ps(n,t,e.testId,e.resultId,"RUNNING",{startTime:e.startTime,config:c,remoteRunId:o,testRetryKey:r})}async testStartReport(e,t,r){if(Je(e,this.options))return;let n=this.exportsGlobal;try{let o=await vi(this.options.beforeTest,Object.assign({},e,{exportsGlobal:n,globalParameters:n}),this.options.userData.loginData.token);return e.config.testData=Object.assign({},e.config.testData,this.exportsGlobal,this.fileUserParamsData,this.beforeSuiteParams,o),this.options.runParams[e.resultId]=e.config.testData,e.startTime=Date.now(),await this.updateTestStatusRunning(e,t,r),e}catch(o){throw ot.error("Failed to start test",{err:o}),o}}testStartAndReport(e,t,r,n,o){let i=this.testStart(e,t,r,n);return this.testStartReport(i,t,o)}onGridSlot(e,t){let r=this.getTestResult(e);r.config.gridInfo=Object.assign({},t,{key:void 0,user:void 0}),ot.info("on get grid info",{gridInfo:r.config.gridInfo})}reportTestStatus(e,t,r,n){let{name:o,testId:i,testStatus:a}=r,{resultId:c,success:l}=t;if(a===Ke.EVALUATING&&Ct.isTestStatusEnabled){Q.onTestIgnored(e,r,`test in ${Ke.EVALUATING} status`);return}if(l){Q.onTestPassed(o);return}Q.onTestFailed(r,r.failureReason,ct(this.options.editorUrl,this.options.project,i,c,this.branchToUse),i,n,c)}calcResultText(e){return e.success?pe.PASSED:pe.FAILED}onTestIgnored(e,t){let r=this.getTestResult(t);Q.onTestIgnored(e,r,`test in ${Ke.QUARANTINE}`)}testEnd(e,t,r,n,o){let i=this.getTestResult(t.resultId),a=t.endTime-t.startTime||0;i.sessionId=n,i.startTime=t.startTime||i.startTime||Date.now(),i.duration=a,t.duration=a,i.failureReason=t.failureReason||t.reason,t.failureReason=i.failureReason,i.failurePath=t.failurePath,i.resultId=t.resultId,i.success=t.success,this.options.saveRCALocally&&du(i,ot),i.resultUrl=ct(this.options.editorUrl,this.options.project,i.testId,i.resultId,this.branchToUse),i.status=this.calcResultText(t),t.status=i.status,t.name=i.name,t.testStatus=i.testStatus,t.testId||(t.testId=i.testId),t.testCreatorName=i.testCreatorName,t.testCreatorEmail=i.testCreatorEmail,t.testOwnerName=i.testOwnerName,t.testOwnerEmail=i.testOwnerEmail,t.testData=i.config&&typeof i.config.testDataTotal=="number"?{total:i.config.testDataTotal,index:i.config.testDataIndex}:{},this.reportTestStatus(e,t,i,o);let c=this.options.files.length>0;Q.onTestFinished(i,e,o,c);let l=Object.assign({},this.exportsGlobal,t.exportsGlobal);return this.exportsGlobal=l,i}async testEndReport(e,t,r,n){var i;let o=r.exportsGlobal;try{try{await vi(this.options.afterTest,Object.assign({},e,{exportsGlobal:o,globalParameters:o}),this.options.userData.loginData.token)}catch(a){ot.error("HOOK threw an error",{test:e.testId,err:a}),console.error("HOOK threw an error",a)}return(i=this.options.lightweightMode)!=null&&i.onlyTestIdsNoSuite?void 0:await ps(this.options.project,t,e.testId,e.resultId,"FINISHED",{startTime:e.startTime,endTime:r.endTime,success:e.success,failureReason:e.failureReason,remoteRunId:this.options.remoteRunId,...n},5)}catch(a){throw ot.error("Failed to update test finished",{err:a}),a}}testEndAndReport(e,t,r,n,o,i){let a=this.testEnd(e,t,r,n,o);return this.testEndReport(a,r,t,i)}calcTestRunStatus(){let{options:e,testInfoList:t}=this,r=e.company.companyId,n=t.map(o=>{var m,p,f,h;let i=e.browser?sn(e.browser,e.saucelabs,e.browserstack):o.runConfig;if(i&&M.flags.dec2022eolBrowsers.isEnabled()&&((m=rn(i.browserValue))!=null&&m.eol))throw new I(`Unsupported Browser: ${i.browserName}`);let a=!M.flags.allowAppFromDeviceRuns.isEnabled()&&Zs(o.nativeApp),c=en(e)&&(ns(o.nativeApp)||a),l=Je(o,e)||c,d={testId:o.testId,status:l?pe.SKIPPED:pe.QUEUED,name:o.name,resultId:o.resultId,isTestsContainer:o.isTestsContainer,testStatus:o.testStatus||Ke.DRAFT,testCreatorName:o.creatorName,testCreatorEmail:o.creatorEmail,testOwnerName:o.testOwnerName,testOwnerEmail:o.testOwnerEmail,testLabels:o.testLabels,testSuites:o.testSuites,allLabels:o.allLabels,...c&&{reason:ns(o.nativeApp)?"virtual-build":"app-from-device"},config:Object.assign({},this.execConfig,{companyId:r,testData:((p=o.testData)==null?void 0:p.value)||null,isBeforeTestPlan:o.isBeforeTestPlan,isAfterTestPlan:o.isAfterTestPlan,testDataTotal:((f=o.testData)==null?void 0:f.total)||null,testDataIndex:((h=o.testData)==null?void 0:h.index)||null,baseUrl:e.baseUrl||o.baseUrl||o.testConfig.baseUrl,testConfig:o.overrideTestConfig||o.testConfig,browser:i.browserValue.toLowerCase()})};return[o.resultId,d]});return Object.fromEntries(n)}async executionStart(e,t,r,n,o){ot.info("execution started",{executionId:e});let{options:i}=this,{remoteRunId:a,projectData:c}=i;ms(()=>Promise.all([Sn.end(t),Mo("ABORTED",e,t,!1,void 0,a,void 0)])),this.startTime=r||Date.now();let l={projectId:t,executionId:e,...M.flags.testNamesToBeforeSuiteHook.isEnabled()&&{testNames:o}},d=await vi(i.beforeSuite,l),m=new Ti(d,Dr.cloneDeep(this.testInfoList),t);this.testInfoList=m.overrideTestData(),this.testRunStatus=this.calcTestRunStatus(),this.beforeSuiteParams=d;let{testInfoList:p}=this,f=[],h=[],g=[];for(let T of p){if(T.isBeforeTestPlan){f.push(T);continue}if(T.isAfterTestPlan){g.push(T);continue}h.push(T)}let y=async()=>{let T=Dr.cloneDeep(this.testRunStatus);await de(Object.keys(T),async x=>{var P;let k=T[x],D=(P=k.config)==null?void 0:P.testData,S=k.testId,O=await Uo(t,S,x,D,c.defaults);O&&(delete k.config.testData,k.config.testDataUrl=O)});let C=Boolean(i.useLocalChromeDriver||i.useChromeLauncher),b={executionId:e,projectId:t,labels:n||[],startTime:r,executions:T,config:this.execConfig,resultLabels:i.resultLabels,remoteRunId:i.remoteRunId,localRunUserId:i.user,isLocalRun:C,intersections:i.intersections},v=Gc(b);return this.executionStartedPromise=v,v.catch(x=>ot.error(x)),v};try{await y()}catch(T){ot.error("Failed to start suite",{err:T}),console.error("Failed to start test run. Please contact support@testim.io")}return{beforeTests:f,tests:h,afterTests:g}}concatSeleniumPerfMarks(e){Dr.chain(e).keys().each(t=>{let r=t;this.seleniumPerfStats.marks[r]&&(this.seleniumPerfStats.marks[r]=[...this.seleniumPerfStats.marks[r],...e[r]])}).value()}async executionEnd(e){var d;let t=wc(this.testRunStatus),r=t.length,n=0,o=0,i=0;for(let{status:m,testStatus:p}of t)m===pe.PASSED&&n++,m===pe.SKIPPED&&o++,m===pe.FAILED&&p===Ke.EVALUATING&&i++;let{seleniumPerfMarks:a,...c}=this.seleniumPerfStats.getStats();try{await vi(this.options.afterSuite,{exportsGlobal:this.exportsGlobal,tests:t,total:r,passed:n,skipped:o})}catch(m){console.log("check your callback handler on afterSuite Hook for syntax or exception errors"),ot.warn("error while running afterSuite Hook",{err:m,projectId:this.options.projectData.projectId,executionId:this.options.executionId})}let l=await Zf(this.options,this.branchToUse,r,e);if(Object.assign(c,{coverageSummary:l}),!((d=this.options.lightweightMode)!=null&&d.onlyTestIdsNoSuite))try{return await Mo("FINISHED",e,this.options.project,r===n+o+i,{tmsSuppressReporting:this.options.tmsSuppressReporting,tmsRunId:this.options.tmsRunId,tmsCustomFields:this.options.tmsCustomFields},this.options.remoteRunId,c)}catch(m){throw ot.error("Failed to update suite finished",{err:m}),m}}async markAllQueuedTests(e,t,r,n){let o=Object.keys(this.testRunStatus).filter(i=>this.getTestResult(i).status==="QUEUED");await Wc(e,["QUEUED"],t,r,n,this.startTime,null,this.options.project);for(let i of o){let a=this.getTestResult(i);a.status=t,a.failureReason=r,a.success=n}return this.testRunStatus}}});function rE(s,e){let t={browserName:"safari",...e==="safari technology preview"&&{"safari.options":{technologyPreview:!0}}};return Object.assign(s.desiredCapabilities,t),s}function yu(s){return uh.readFileSync(s,{encoding:"base64"})}function mh(s,e,t){if(!(t!=null&&t.isLambdatestRun()&&Ge(s))&&s){let r=yu(s);kn.info(`adding extension: custom, path: ${s} length: ${r.length} hash: ${gu(r)} current extension count: ${e.length}`),e.push(r)}}function fh(s,e,t,r,n){if(n!=null&&n.isLambdatestRun())return;if(s.ext||r){let c=typeof s.ext=="string"?s.ext:`${__dirname}/..`,l=r||c,d=`--load-extension=${l}`;kn.info(`adding extension: testim unpacked , path: ${l}`),t.push(d);return}let o=s.canary?"-master.zip":".zip",i=hu.join(process.cwd(),`testim-headless${o}`),a=yu(i);kn.info(`adding extension: testim zipped, path: ${i} length: ${a.length} hash: ${gu(a)} current extension count: ${e.length}`),e.push(a)}function sE(s,e,t,r,n,o,i){var g,y;let a=t.seleniumName||t.browserValue,c=[],l=[...ph];e.headless&&l.push("--headless");let d=()=>e.mode!==X.EXTENSION,m={prefs:{"profile.default_content_setting_values.popups":fu.CONTENT_SETTING_ALLOW,"profile.default_content_setting_values.automatic_downloads":fu.CONTENT_SETTING_ALLOW,"plugins.always_open_pdf_externally":!0,"safebrowsing.enabled":!0,"profile.content_settings.exceptions.clipboard":{"[*.],*":{last_modified:Date.now(),setting:1}},"download.allow_office_viewer_for_download":!1},w3c:d()};Si(n)&&(m.prefs["download.default_directory"]="C:\\Users\\testnode",m.w3c=!0,s.desiredCapabilities.version="latest-1",s.desiredCapabilities["aws:maxDurationSecs"]=2400,s.desiredCapabilities["aws:idleTimeoutSecs"]=60),Si(n)&&a==="MicrosoftEdge"&&(s.desiredCapabilities["ms:edgeChromium"]=!0),e.chromeExtraPrefs&&Object.assign(m.prefs,e.chromeExtraPrefs),e.chromeExtraArgs&&e.chromeExtraArgs.forEach(T=>l.push(`--${T}`)),e.chromeBlockLocation&&(m.prefs["profile.default_content_setting_values.geolocation"]=fu.CONTENT_SETTING_BLOCK),e.chromeUserDataDir&&l.push(`--user-data-dir=${e.chromeUserDataDir}`),(y=(g=e.projectData)==null?void 0:g.defaults)!=null&&y.disableChromiumGpu&&l.push("--disable-gpu"),Object.assign(s.desiredCapabilities,{browserName:a});function p(){t.mobileEmulation&&(m.mobileEmulation={deviceMetrics:{width:t.mobileEmulation.device.width,height:t.mobileEmulation.device.height+mc.MOBILE_WEB_REMOTE_RUN_HEADER_SPACING,pixelRatio:t.mobileEmulation.device.deviceScaleFactor},userAgent:t.mobileEmulation.userAgent})}p(),mh(r,c,i),e.mode===X.EXTENSION&&fh(e,c,l,o,i),c.length>0&&(m.extensions=c),e.disableCookiesSameSiteNoneRequiresSecure&&(m.localState={"browser.enabled_labs_experiments":["cookies-without-same-site-must-be-secure@2"]}),m.args=l;let f={MicrosoftEdge:"edgeOptions",chrome:"chromeOptions"}[a],h={MicrosoftEdge:"ms",chrome:"goog"}[a];return ee.isLambdatestGrid(n)&&delete m.w3c,e.oldCapabilities&&n.type!=="testimEnterprise"&&!(i!=null&&i.isLambdatestRun())&&(s.desiredCapabilities[f]=m),(e.w3cCapabilities||n.type==="testimEnterprise")&&(s.desiredCapabilities[`${h}:${f}`]=m),s}function oE(s,e,t){let r={"pdfjs.disabled":!0};if(M.flags.autoSaveDownloadFileFireFox.isEnabled()&&Object.assign(r,{"browser.helperApps.neverAsk.saveToDisk":lh.join(","),"browser.helperApps.neverAsk.openFile":lh.join(","),"browser.helperApps.alwaysAsk.force":!1,"browser.download.manager.useWindow":!1,"browser.download.manager.focusWhenStarting":!1,"browser.download.manager.alertOnEXEOpen":!1,"browser.download.manager.showWhenStarting":!1,"browser.download.manager.closeWhenDone":!0,"browser.download.manager.showAlertOnComplete":!1}),Object.assign(s.desiredCapabilities,{acceptInsecureCerts:!0,browserName:"firefox",marionette:!0,"moz:firefoxOptions":{prefs:r}},t!=null&&t.isLambdatestRun()?{enableCustomTranslation:!0}:{}),e.disableCookiesSameSiteNoneRequiresSecure&&(s.desiredCapabilities["moz:firefoxOptions"].prefs["network.cookie.sameSite.noneRequiresSecure"]=!1),e.mode===X.EXTENSION)if(e.ext)s.desiredCapabilities.testim_firefox_profile=e.ext;else{let n=e.canary?"-master.zip":".zip",o=hu.join(process.cwd(),`testim-firefox-profile${n}`);s.desiredCapabilities.firefox_profile=yu(o)}return e.headless&&(s.desiredCapabilities["moz:firefoxOptions"].args||(s.desiredCapabilities["moz:firefoxOptions"].args=[]),s.desiredCapabilities["moz:firefoxOptions"].args.push("-headless")),s}function iE(s,e,t){let{saucelabs:r}=s;return r!=null&&r.username&&r.accessKey?t?(t.sl.version=t.browserValue==="safari"?t.sl.safari_version:t.sl.version,t.sl.appiumVersion=r.appiumVersion||t.sl.appiumVersion,Object.assign({},t.sl,r,{name:e})):Object.assign({},r,{name:e}):{}}function aE(s,e,t){return wt.isEmpty(s.browserstack)?{}:t?(t.bs.browser_version=t.browserValue==="safari"?t.bs.safari_version:t.bs.browser_version,t.browserValue==="safari"&&t.bs.safari_version==="10"&&Object.assign(t.bs,{"safari.options":{technologyPreview:!0}}),Object.assign({},t.bs,s.browserstack,{name:e})):Object.assign({},s.browserstack,{name:e})}function cE(s){return s.perfecto?s.perfecto:{}}function lE(s,e,t){if(s.experitestToken){let r=e==="safari";return{accessKey:s.experitestToken,browserVersion:"latest",platformName:r?"MAC":"WIN10",seleniumScreenshot:r,newSessionWaitTimeout:t}}return{}}function uE(s,e={}){let{gridData:t={},gridUsername:r,gridPassword:n}=s,o=r||t.user||e.user,i=n||t.key||e.key,a={};return o&&i&&(a.Authorization=Wa(o,i)),a}function Ri(s,e,t,r,n,o,i,a=null){var g,y,T,C,b,v;if(r.mode==="local"){let x=[],k=[...ph],D={};return s.headless&&k.push("--headless"),s.silentDebuggerExtensionApi&&k.push("--silent-debugger-extension-api"),s.remoteDebuggingPort!==void 0&&k.push(`--remote-debugging-port=${s.remoteDebuggingPort}`),s.chromeExtraArgs&&s.chromeExtraArgs.forEach(S=>k.push(`--${S}`)),s.chromeBinaryLocation&&(D.binary=s.chromeBinaryLocation),s.mode!=="selenium"&&fh(s,x,k,null,a),mh(n,x,a),{logLevel:ch,desiredCapabilities:{chromeOptions:{args:k,extensions:x,...D},browserName:"chrome"},host:"localhost",port:9515}}let{driverRequestTimeout:c,driverRequestRetries:l}=s,d=uE(s,r),m={host:r.host,port:r.port||4444,path:r.path||"/wd/hub",protocol:r.protocol||"http",logLevel:ch,connectionRetryTimeout:c,connectionRetryCount:l,getSessionTimeout:Math.max(a.getSessionTimeout,s.getSessionTimeout),getSessionRetries:a.getSessionRetries||s.getSessionRetries,deprecationWarnings:!1,desiredCapabilities:{javascriptEnabled:!0,locationContextEnabled:!0,handlesAlerts:!0,rotatable:!0,acceptSslCerts:!0,unexpectedAlertBehaviour:"accept",nativeEvents:!0,testName:e},...!wt.isEmpty(d)&&{headers:d},...s.proxyForGrid&&{agent:global.ProxyAgent(global.proxyUri)}};Si(r)&&(s.oldCapabilities=!1,s.w3cCapabilities=!0,m.desiredCapabilities={unexpectedAlertBehaviour:"accept"}),s.disableNativeEvents&&(m.desiredCapabilities.nativeEvents=!1),r.user&&r.key&&(r.type==="saucelabs"&&(s.saucelabs||(s.saucelabs={}),(g=s.saucelabs).username||(g.username=r.user),(y=s.saucelabs).accessKey||(y.accessKey=r.key)),r.type==="browserstack"&&(s.browserstack||(s.browserstack={}),(T=s.browserstack)["browserstack.user"]||(T["browserstack.user"]=r.user),(C=s.browserstack)["browserstack.key"]||(C["browserstack.key"]=r.key))),r.key&&r.type==="perfecto"&&(s.perfecto.securityToken=r.key);let p=Number(s.browserTimeout/1e3),f=s.browser||(t==null?void 0:t.browserValue);wt.merge(m.desiredCapabilities,iE(s,e,t),aE(s,e,t),cE(s),lE(s,f,p),a==null?void 0:a.getCapabilities(s,f,o,i,e));let h=null;switch(!s.ext&&!s.extensionPath&&((b=r.host)!=null&&b.endsWith(".testim.io"))&&!s.canary&&s.mode===X.EXTENSION&&(f==="chrome"?h="/opt/testim-headless":f==="edge-chromium"&&(h="C:/selenium/testim-headless")),(v=r.host)!=null&&v.endsWith(".testim.io")&&f==="edge-chromium"&&(m.desiredCapabilities.version="83"),f){case"chrome":case"edge-chromium":m=nE(m,s,t,n,r,h,a);break;case"firefox":m=oE(m,s,a);break;case"safari":case"safari technology preview":m=rE(m,f);break;default:break}wt.merge(m.desiredCapabilities,s.seleniumCapsFileContent);try{let x={"hub.lambdatest.com":"lambdatest",[M.flags.publicGridURL.getValue()]:"testim","testgrid-devicefarm.us-west-2.amazonaws.com":"devicefarm"},k=P=>P[r.provider]||P[m.host]||P[x[m.host]],D=P=>{var N,B;return k(P)||P[(N=m.desiredCapabilities)==null?void 0:N.browserName]||P[(B=m.desiredCapabilities)==null?void 0:B.version]||P||{}},S=JSON.parse(M.flags.addCustomCapabilities.getValue()||"{}"),O=D(D(S));Object.keys(O).length&&(kn.info(`Adding custom capabilities: ${JSON.stringify(O)}`),Object.assign(m.desiredCapabilities,O))}catch(x){kn.error("Failed to load custom capabilities",{error:x,customCapabilities:M.flags.addCustomCapabilities.getValue()})}return Si(r)&&m.desiredCapabilities&&!m.capabilities&&(tE(m.desiredCapabilities),m.capabilities={alwaysMatch:m.desiredCapabilities,firstMatch:[{}]},delete m.desiredCapabilities),m}function hh({projectType:s,gridInfo:e,nativeApp:t,options:r,appPath:n,androidActivityWait:o}){let{deviceModel:i,osVersion:a,deviceUdid:c,fullReset:l,resetAppData:d,resetOnSessionStartOnly:m}=r,p={};if(!t&&!n)throw Error("missing mobile app!");if(e.type!==ue.TESTIM_HEADSPIN)throw Error("unsupported grid was detected please make sure to select supported mobile grid");let f={protocol:e.protocol||"https",hostname:e.host,port:e.port,path:`/v0/${e.accessToken}/wd/hub`,logLevel:r.appiumLogLevel},h={"headspin:capture":!0,...!l&&!d&&{"appium:noReset":!0},...!l&&d&&{"appium:noReset":!1}};switch(s){case"ios":h={...h,platformName:"iOS","appium:autoAcceptAlerts":!0,"appium:automationName":"XCUITest",...l&&{"appium:fullReset":l,"appium:resetOnSessionStartOnly":m},...t&&{"appium:bundleId":t.id},...n&&{"appium:app":n}};break;case"android":h={...h,platformName:"Android",...l&&{"appium:fullReset":l},...!l&&d&&{"appium:autoGrantPermissions":!0},"appium:automationName":"UiAutomator2","appium:appWaitActivity":o,...t&&{"appium:appPackage":t.id||t.packageName,"appium:appActivity":t.activity},...n&&{"appium:app":n}};break;default:throw Error(`unsupported mobile project ${s}`)}return i&&(p.model=i),a&&(p.os_version=a),c&&(p.device_id=c,delete p.model,delete p.os_version),wt.isEmpty(p)||(h["headspin:selector"]=p),{...f,desiredCapabilities:h,capabilities:h}}var uh,hu,dh,wt,kn,ch,fu,ph,gu,Si,tE,nE,lh,Ii=w(()=>{"use strict";uh=E(require("fs")),hu=E(require("path")),dh=E(require("crypto")),wt=E(require("lodash"));U();le();j();ye();ae();si();kn=R("testim-desired-capabilities-builder"),ch=oo?"verbose":"silent",fu={CONTENT_SETTING_DEFAULT:0,CONTENT_SETTING_ALLOW:1,CONTENT_SETTING_BLOCK:2,CONTENT_SETTING_ASK:3},ph=["--disable-popup-blocking","--ignore-gpu-blacklist","--auto-select-desktop-capture-source=Entire screen","--ignore-certificate-errors","--disable-features=TranslateUI","--disable-background-networking","--disable-sync","--metrics-recording-only","--disable-default-apps","--mute-audio","--no-first-run","--disable-back-forward-cache"],gu=(...s)=>dh.createHash("sha256").update(s.join("")).digest("hex"),Si=s=>s.type===ue.DEVICE_FARM||s.type===ue.HYBRID&&s.provider==="devicefarm",tE=s=>{Object.prototype.hasOwnProperty.call(s,"version")&&(s.browserVersion=s.version,delete s.version),Object.prototype.hasOwnProperty.call(s,"platform")&&(s.platformName=s.platform,delete s.platform),Object.prototype.hasOwnProperty.call(s,"acceptSslCerts")&&(s.acceptInsecurecerts=s.acceptSslCerts,delete s.acceptSslCerts),Object.prototype.hasOwnProperty.call(s,"unexpectedAlertBehaviour")&&(s.unhandledPromptBehavior=s.unexpectedAlertBehaviour,delete s.unexpectedAlertBehaviour)};nE=wt.memoize(sE,(s,e,t,r,n,o)=>{let i=JSON.stringify(s.desiredCapabilities),a=JSON.stringify(wt.omit(e,"runParams")),c=JSON.stringify(t),l=JSON.stringify(n.type);return gu(i,a,c,r,l,o)}),lh=["application/force-download","application/pdf","application/x-pdf","application/acrobat","applications/vnd.pdf","text/pdf","text/x-pdf","application/vnd.cups-pdf"]});function Fe(s){var e,t,r,n,o,i,a;return((e=s.message)==null?void 0:e.match(/Command not found/))||s.message==="HTTP method not allowed"||s.message==="Unknown error"||((t=s.message)==null?void 0:t.match(/Unknown timeout type/))||((r=s.seleniumStack)==null?void 0:r.type)==="UnknownCommand"||((n=s.message)==null?void 0:n.match(/did not match a known command/))||((o=s.message)==null?void 0:o.match(/Server returned HTTP response code: 405 for URL/))||((i=s.seleniumStack)==null?void 0:i.message)==="The arguments passed to a command are either invalid or malformed."||((a=s.message)==null?void 0:a.match(/Invalid timeout type specified: ms/))}function gh(s,e,t){if(!e||!s)return s;if(s.includes("%"))return s.replace(/ /g,"%20");try{return decodeURI(s)!==s?s:encodeURI(s)}catch(r){return t&&t.warn("tried to encode url but failed",{err:r,url:s}),s}}var wu=w(()=>{"use strict"});function Tu(s){function e(p){return p?[Node.ELEMENT_NODE,Node.DOCUMENT_NODE,Node.DOCUMENT_FRAGMENT_NODE].includes(p.nodeType):!1}function t(p){return p?r(p.parentNode,e):null}function r(p,f){for(let h=p;h&&h!==p.ownerDocument;h=h.parentNode)if(f(h))return h;return null}function n(p,f){for(let h=p;h&&h!==p.ownerDocument;h=t(h))if(f(h))return h;return null}function o(p,f){if(!p||!f)return null;p instanceof DocumentFragment&&(p=p.host);let g=window.getComputedStyle(p).getPropertyValue(f);if(g&&g!=="inherit")return g;let y=t(p);return o(y,f)}function i(p){let f=p.getBoundingClientRect();if(f.width>0&&f.height>0)return!0;if(p.tagName.toUpperCase()==="PATH"&&f.width+f.height>0){let g=o(p,"stroke-width");return!!g&&parseInt(g,10)>0}return o(p,"overflow")==="hidden"?!1:Array.from(p.childNodes).some(g=>g.nodeType===Node.TEXT_NODE?!0:e(g)?i(g):!1)}function a(p){return o(p,"overflow")==="hidden"}function c(p){return!p||!a(p)||!p.childNodes.length?!1:Array.from(p.childNodes).every(f=>f.nodeType===Node.TEXT_NODE?!1:!e(f)||!i(f)?!0:c(f))}function l(p){var f;return p?(f=p.parentNode)!=null&&f.host?!0:l(p.parentNode):!1}if(!s||!l(s)&&!document.contains(s))return!1;switch(s.tagName.toUpperCase()){case"BODY":return!0;case"SCRIPT":case"NOSCRIPT":return!1;case"OPTGROUP":case"OPTION":{let p=r(s,f=>f.tagName.toUpperCase()==="SELECT");return Tu(p)}case"INPUT":if(s.type==="hidden")return!1;break;default:break}if(o(s,"visibility")!=="visible")return!1;let d=!!n(s,p=>Number(o(p,"opacity"))===0),m=!!n(s,p=>o(p,"display")==="none");return!(d||m||!i(s)||c(s))}var yh=w(()=>{"use strict"});var bh,wh,xi,dE,Pi,Th=w(()=>{"use strict";bh=E(require("promise-queue"));le();wh=E(require("@testim/webdriverio"));Le();U();j();Yr();yh();wu();Es();xi=R("WebDriverApi"),dE=function(){return{screenWidth:Math.floor(window.innerWidth||0),screenHeight:Math.floor(window.innerHeight||0)}},Pi=class{constructor(){this.w3cRequests={}}windowHandleMaximize(){return this.addToQueue(()=>this.client.windowHandleMaximize().then(e=>({height:e.value.height,width:e.value.width})))}rejectWithLog(e,t){let{testName:r,testResultId:n}=this,o=t?t.toString().substr(0,2e3):"";return xi.warn("error from selenium",{err:e,testResultId:n,testName:r,crashingFunc:o}),Promise.reject(e)}initQueueRequests(){let e=1/0;this.isAndroid()&&(e=1),typeof Ha<"u"&&(e=Ha);let t=1/0;this.queue=new bh.default(e,t)}async addToQueue(e){let t=this.seleniumPerfStats.markStart();try{return await this.queue.add(e)}catch(r){return this.rejectWithLog(r,e)}finally{this.seleniumPerfStats.markEnd(t)}}async initClient(e,t,r){this.testName=t,this.testResultId=r,e.deprecationWarnings=!1,this.client=wh.remote(e),this.initQueueRequests(),_("right before addToQueue");let n=this.seleniumPerfStats.markStart(Ae.GET_BROWSER);try{await this.addToQueue(()=>(xi.info("requesting browser",{testResultId:r,testName:t}),_("before this.client.init"),this.client.init())),_("after client init")}finally{await this.seleniumPerfStats.markEnd(n,Ae.GET_BROWSER)}}get isMobile(){return this.client.isMobile}getSessionId(){var e,t;return(t=(e=this.client)==null?void 0:e.requestHandler)==null?void 0:t.sessionID}isChrome(){return this.client.desiredCapabilities.browserName==="chrome"}isChromium(){return this.isChrome()||this.isEdgeChromium()}isFirefox(){return this.client.desiredCapabilities.browserName==="firefox"}isSafari(){return this.client.desiredCapabilities.browserName==="safari"||this.client.desiredCapabilities.browserName==="safari technology preview"}isAndroid(){return this.client.desiredCapabilities.platformName==="Android"}isEdgeChromium(){return this.client.desiredCapabilities.browserName==="MicrosoftEdge"&&!this.client.desiredCapabilities._isOldEdge}execute(...e){return this.addToQueue(()=>{let t=e.shift();if(typeof t!="string"&&typeof t!="function")return Promise.reject(new Error("number or type of arguments don't agree with execute protocol command"));typeof t=="function"&&(t=`return (${t}).apply(null, arguments)`);let r=i=>{throw i.executedScript=t,i},n=()=>this.client.requestHandler.create("/session/:sessionId/execute/sync",{script:t,args:e}).catch(r),o=()=>this.client.requestHandler.create("/session/:sessionId/execute",{script:t,args:e}).catch(r);return this.w3cRequests.execute?n():o().catch(i=>{if(Fe(i))return this.w3cRequests.execute=!0,n();throw i})})}executeAsync(...e){return this.addToQueue(()=>{let t=e.shift();if(typeof t!="string"&&typeof t!="function")return Promise.reject(new Error("number or type of arguments don't agree with execute protocol command"));typeof t=="function"&&(t=`return (${t}).apply(null, arguments)`);let r=()=>this.client.requestHandler.create("/session/:sessionId/execute/async",{script:t,args:e}),n=()=>this.client.requestHandler.create("/session/:sessionId/execute_async",{script:t,args:e});return this.w3cRequests.executeAsync?r():n().catch(o=>{if(Fe(o))return this.w3cRequests.executeAsync=!0,r();throw o})})}async executeCDP(e,t={}){var n;if(!this.isChromium())return;let r=await this.client.requestHandler.create({path:"/session/:sessionId/chromium/send_command_and_get_result",method:"POST"},{cmd:e,params:t});return(n=r==null?void 0:r.value)!=null&&n.targetInfos?r.value.targetInfos:[]}takeScreenshot(){let e=this.seleniumPerfStats.markStart(Ae.GET_SCREENSHOT);return this.addToQueue(()=>this.client.screenshot()).finally(()=>this.seleniumPerfStats.markEnd(e,Ae.GET_SCREENSHOT))}takeElementScreenshot(e){let t=this.seleniumPerfStats.markStart(Ae.GET_SCREENSHOT);return this.addToQueue(()=>this.client.elementIdScreenshot(xe(e))).finally(()=>this.seleniumPerfStats.markEnd(t,Ae.GET_SCREENSHOT))}getElementBySelector(e){return this.addToQueue(()=>this.client.element(e))}elementIdDisplayed(e){return this.addToQueue(()=>{let t=()=>this.client.elementIdDisplayed(e),r=()=>this.execute(Tu,{ELEMENT:e,[at]:e});return this.w3cRequests.elementIdDisplayed?r():t().catch(n=>{if(Fe(n))return this.w3cRequests.elementIdDisplayed=!0,r();throw n})})}windowHandles(){return this.addToQueue(()=>{let e=()=>this.client.requestHandler.create("/session/:sessionId/window_handles"),t=()=>this.client.requestHandler.create("/session/:sessionId/window/handles");return this.w3cRequests.windowHandles?t():e().catch(r=>{if(Fe(r))return this.w3cRequests.windowHandles=!0,t();throw r})})}url(e){return this.addToQueue(()=>this.client.url(gh(e,this.isSafari(),xi)))}reloadTab(){return this.addToQueue(()=>this.client.refresh())}source(){return this.addToQueue(()=>this.client.source())}timeouts(e,t){return this.addToQueue(()=>{let r=()=>this.client.requestHandler.create("/session/:sessionId/timeouts",{type:e,ms:t}),n=()=>this.client.requestHandler.create("/session/:sessionId/timeouts",{[e]:t});return this.w3cRequests.timeouts?n():r().catch(o=>{if(Fe(o))return this.w3cRequests.timeouts=!0,n();throw o})})}scroll(e,t){e=typeof e=="number"?e:0,t=typeof t=="number"?t:0;let r=function(n,o){window.scrollTo(n,o)};return this.execute(r,e,t)}setValue(e,t){return this.elementIdClear(xe(e)).then(()=>this.elementIdValue(xe(e),t))}getViewportSize(e){return this.execute(dE).then(t=>typeof e=="string"&&e.match(/(width|height)/)?(e=`screen${e.slice(0,1).toUpperCase()}${e.slice(1)}`,t.value[e]):{width:t.value.screenWidth||0,height:t.value.screenHeight||0})}keys(e){let t=i=>Ba.hasOwnProperty(i)?[Ba[i]]:i.split(""),r=[];if(typeof e=="string")r=t(e);else if(e instanceof Array)for(let i of e)r=r.concat(t(i));else return Promise.reject(new Error("number or type of arguments don't agree with keys protocol command"));let n=()=>this.client.requestHandler.create("/session/:sessionId/keys",{value:r}),o=()=>{let i=r.map(c=>({type:"keyDown",value:c})),a=r.map(c=>({type:"keyUp",value:c}));return this.actions([{type:"key",id:"keys",actions:[...i,...a]}])};return this.w3cRequests.keys?o():this.addToQueue(()=>n().catch(i=>{if(Fe(i))return this.w3cRequests.keys=!0,o();throw i}))}elementIdValue(e,t){return this.addToQueue(()=>this.client.elementIdValue(e,t))}elementIdClear(e){return this.addToQueue(()=>this.client.elementIdClear(e))}submitForm(e){return this.addToQueue(()=>this.client.submit(xe(e)))}buttonPress(e){return this.addToQueue(()=>this.client.buttonPress(e))}findElementAndPress(e,t,r,n){return this.moveTo(xe(e),t,r).then(()=>this.buttonPress(n))}rightClick(e,t,r){return this.findElementAndPress(e,t,r,"right")}leftClick(e,t,r){return this.findElementAndPress(e,t,r,"left")}elementIdClick(e){return this.addToQueue(()=>this.client.elementIdClick(e))}actions(e){return this.addToQueue(()=>this.client.actions(e))}doDoubleClick(){return this.addToQueue(()=>this.client.doDoubleClick())}dragAndDrop(e,t){return this.addToQueue(()=>this.client.dragAndDrop(e,t))}buttonDown(){return this.addToQueue(()=>this.client.buttonDown())}buttonUp(){return this.addToQueue(()=>this.client.buttonUp())}moveTo(e,t,r){let n={};return typeof t=="number"&&(n.xoffset=t),typeof r=="number"&&(n.yoffset=r),this.isSafari()&&!n.hasOwnProperty("yoffset")&&(n.yoffset=1),this.isSafari()&&!n.hasOwnProperty("xoffset")&&(n.xoffset=1),typeof e=="string"&&(n.element=e),this.addToQueue(()=>this.client.requestHandler.create("/session/:sessionId/moveto",n))}uploadFile(e){return this.addToQueue(()=>this.client.uploadFile(e))}getUrl(){return this.addToQueue(()=>this.client.getUrl())}getTitle(){return this.addToQueue(()=>this.client.getTitle())}windowHandleSize(e="current",t){return this.addToQueue(()=>{let r={};typeof e=="object"&&([e,t]=["current",e]);let n={path:`/session/:sessionId/window/${e}/size`,method:"GET"};if(typeof t=="object"&&t.width&&t.height&&(n.method="POST",r={width:Math.abs(t.width),height:Math.abs(t.height)}),n.method==="POST"&&typeof r.width!="number"&&typeof r.height!="number")return Promise.reject(new Error("number or type of arguments don't agree with windowHandleSize protocol command"));let o=()=>this.client.requestHandler.create(n,r),i=()=>(n.path="/session/:sessionId/window/rect",this.client.requestHandler.create(n,r));return this.w3cRequests.windowHandleSize?i():o().catch(a=>{if(Fe(a))return this.w3cRequests.windowHandleSize=!0,i();throw a})})}setCookie(e,t,r,n,o,i,a){return this.addToQueue(()=>this.client.setCookie({name:e,value:t,domain:r,httpOnly:n,secure:o,path:i,expiry:a&&Math.floor(a)}))}getCookie(e){return this.addToQueue(()=>this.client.requestHandler.create("/session/:sessionId/cookie").then(t=>(t.value=t.value||[],typeof e=="string"?t.value.find(r=>r.name===e||r.name===encodeURIComponent(encodeURIComponent(e)))||null:t.value||(typeof e=="string"?null:[]))))}deleteCookie(e){return this.addToQueue(()=>this.client.deleteCookie(e))}isVisibleWithinViewport(e){return this.addToQueue(()=>this.client.isVisibleWithinViewport(e))}getCurrentTabId(){return this.addToQueue(()=>this.client.getCurrentTabId())}frame(e){return this.addToQueue(()=>this.client.frame(e))}switchTab(e){return this.addToQueue(()=>this.client.switchTab(e))}alertAccept(){return this.addToQueue(()=>this.client.alertAccept())}log(e="browser"){return this.addToQueue(()=>this.client.log(e))}end(){return this.w3cRequests={},this.queue?this.addToQueue(()=>this.client.end()):Promise.resolve()}forceEnd(){return this.w3cRequests={},this.client?this.client.end():Promise.resolve()}touchPerform(e){return this.addToQueue(()=>this.client.touchPerform(e))}touchAction(e){return this.addToQueue(()=>this.client.touchAction(e))}pressKeycode(e){return this.addToQueue(()=>this.client.pressKeycode(e))}setImmediateValue(e,t){return this.addToQueue(()=>this.client.setImmediateValue(e,t))}elementIdText(e){return this.addToQueue(()=>this.client.elementIdText(e)).then(t=>t.value)}isAppInstalled(e){return this.addToQueue(()=>this.client.isAppInstalled(e)).then(t=>{let r=!!t.value;return xi.info(`is app (${e}) installed? ${r}`,t),r})}launch(){return this.addToQueue(()=>this.client.launch())}context(e){return this.addToQueue(()=>this.client.context(e))}elementIdLocation(e){return this.addToQueue(()=>this.client.elementIdLocation(e))}}});var vh,Eh=w(()=>{"use strict";vh=function(s,e){let t=["pointerup","pointerdown","pointermove"],r=getLocatedElement(s.locatedElement);if(!r)throw new Error("element not found");let n=s.events,o={status:"done",success:!0};window.__unloadNavigator=function(){e(o)};let i=function(p){function f(C,b,v){return v>C&&v<b}let h=p.pointerPosition||{},g=r.getBoundingClientRect(),y=h.originX&&f(g.left,g.left+g.width,h.originX)?h.originX:g.left+g.width/2,T=h.originY&&f(g.top,g.top+g.height,h.originY)?h.originY:g.top+g.height/2;return{x:y,y:T}},a=function(p,f){return{screenX:0,screenY:0,clientX:p,clientY:f,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,bubbles:!0,cancelable:!0,button:0,pointerType:"mouse",isPrimary:!0}},c=function(p,f,h){if(!window.PointerEvent)return;let g=a(f,h);return new window.PointerEvent(p,g)},l=function(p,f,h){let g=document.createEvent("MouseEvents");return g.initMouseEvent(p,!0,!0,document.defaultView,1,0,0,f,h,!1,!1,!1,!1,0,document.body?document.body.parentNode:document.documentElement),g},d=function(){var f;let p=document.activeElement;for(;(f=p.shadowRoot)!=null&&f.activeElement;)p=p.shadowRoot.activeElement;return p},m=function(p){let f=i(p),h=p.event;return t.includes(h)?c(h,f.x,f.y):l(h,f.x,f.y)};try{n.map(f=>m(f)).filter(Boolean).forEach(f=>r.dispatchEvent(f));let p=d();dispatchFocus(s.elementToFocusLocatedElement,p),window.__unloadNavigator&&(window.removeEventListener("unload",window.__unloadNavigator),window.__unloadNavigator=null),e(o)}catch(p){window.__unloadNavigator&&(window.removeEventListener("unload",window.__unloadNavigator),window.__unloadNavigator=null),e({status:"done",result:p.toString(),success:!1})}}});function Mr(s,e){function t(o){let i=document.createEvent("HTMLEvents");return i.initEvent(o,!0,!1),i}function r(){var i;let o=document.activeElement;for(;(i=o.shadowRoot)!=null&&i.activeElement;)o=o.shadowRoot.activeElement;return o}function n(o,i){i&&(i.dispatchEvent(t("focusout")),i.dispatchEvent(t("blur"))),o.dispatchEvent(t("focusin")),o.dispatchEvent(t("focus")),typeof o.focus=="function"&&o.focus();let a=r();i&&a===i&&typeof i.blur=="function"&&i.blur()}if(s){let o=getLocatedElement(s);if(o&&o!==e)try{n(o,e)}catch{}}else e&&typeof e.blur=="function"&&e.blur()}var Ci=w(()=>{"use strict"});var Ih={};W(Ih,{WebDriver:()=>Fr});async function hE(s){var e,t;try{let r=(t=(e=s==null?void 0:s.value)==null?void 0:e["goog:chromeOptions"])==null?void 0:t.debuggerAddress;return r?await mE(r):void 0}catch(r){Ve.info("Error getting cdpAddress",r);return}}var Xe,Rh,Ve,or,pE,At,mE,ir,fE,Sh,Fr,_n=w(()=>{"use strict";Xe=E(require("lodash"));U();Le();Ii();Rh=E(require("ua-parser-js"));Yr();j();wu();Th();q();Eh();Ci();ye();Es();Ve=R("webdriver"),[or,pE]=[0,2],{extractElementId:At,getCdpAddressForHost:mE}=H,ir=()=>(Ee(),ie(Or)).getSessionPlayer().codeSnippets,fE=()=>(Ee(),ie(Or)).getSessionPlayer().locatorBuilderUtils,Sh=()=>(Ee(),ie(Or)).getSessionPlayer().utils;Fr=class extends Pi{constructor(){super(),this.started=!1,this.keepAliveTimer=null,this.unsupportedActions={},this._isAlive=!1,this._keepAliveRequests=[],this.cdpUrl=void 0,this.browserClosedCallbacks=[],this.browserClosedFailedKeepAlives=0,this.ignoreHiddenTagsText=!1}registerToClosedBrowser(e){this.browserClosedCallbacks.push(e)}unregisterToClosedBrowser(e){this.browserClosedCallbacks=this.browserClosedCallbacks.filter(t=>t!==e)}async init(e,t,r,n,o,i,a,c=new Vt,l=!1,d){var h,g,y,T,C;this.browserClosedFailedKeepAlives=0,this.ignoreHiddenTagsText=(y=(g=(h=e==null?void 0:e.company)==null?void 0:h.activePlan)==null?void 0:g.premiumFeatures)==null?void 0:y.ignoreHiddenTagsText,this.browserClosedCallbacks=[];let m=Ri(e,t,r,n,o,i,a,d);m.desiredCapabilities&&delete m.desiredCapabilities.marionette,m.capabilities&&delete m.capabilities.alwaysMatch.marionette,this.initUnsupportedActions(d==null?void 0:d.isLambdatestRun()),this.browserAndOS=null,this.seleniumPerfStats=c;let p=l?0:1500,f=l?()=>{}:()=>this.executeJS("window.focus()");try{_("before initClient in webdriver.js init");let b=await this.initClient(m,t,a);_("after initResult before getCdpAddress in init"),this.cdpUrl=await hE(b),_("after getCdpAddress in webdriver.js init"),Ve.info(`init new session testName: ${t}`,{sessionId:this.getSessionId(),testResultId:a}),await se(p),await f(),_("after focus and delay in webdriver.js init")}catch(b){if(Ve.error("failed to init webdriver",{err:b}),b.seleniumStack){let v=new Lt(b.seleniumStack),x=((C=(T=e==null?void 0:e.company)==null?void 0:T.activePlan)==null?void 0:C.plan)==="free";throw v.message.includes("timed out waiting for a node")&&x?new Error("Our free grids are in full capacity, please try again or upgrade to our Professional plan"):v}throw new Error("failed to init client driver")}}initUnsupportedActions(e){e&&(this.unsupportedActions={...this.unsupportedActions,move:!0})}isAlive(){return this._isAlive}maxKeepAliveGap(){let e=n=>Xe.zip(Xe.dropRight(n,1),Xe.drop(n,1)),t=this._keepAliveRequests.map(({start:n})=>n).filter(Boolean),r=e(t).map(([n,o])=>o-n);return Math.max(...r)}isClosedBrowserError(e){return!e||!e.seleniumStack||!e.message?!1:e.seleniumStack.type==="UnknownError"&&(e.message.includes("CLIENT_STOPPED_SESSION")||e.message.includes("BROWSER_TIMEOUT")||e.message.includes("was terminated due to TIMEOUT"))||e.seleniumStack.type==="NoSuchWindow"&&e.message.includes("window was already closed")||e.seleniumStack.type==="SelectorTimeoutError"&&e.message.includes("chrome not reachable")}start(){if(this.started)return;this.started=!0;let e=this,t=function(){function r(a){e._keepAliveRequests.push({start:Date.now(),id:a})}function n(a,c){(e._keepAliveRequests.find(l=>l.id===c)||{})[a]=Date.now()}function o(){return window.getTestimStatus&&window.getTestimStatus()}if(e.queue.getQueueLength()>0)return Promise.resolve();let i=z();return r(i),e.executeJS(o).then(()=>{e._isAlive=!0,n("end",i),e.browserClosedFailedKeepAlives=0}).catch(a=>{if(n("error",i),a.seleniumStack&&a.seleniumStack.type==="UnexpectedAlertOpen")return e.browserClosedFailedKeepAlives=0,Ve.warn("close unexpected alert open"),e.alertAccept().catch(c=>Ve.warn("failed to click on alert",{err:c}));if(Ve.warn("err while getting testim status",{err:a}),e._isAlive=!1,e.isClosedBrowserError(a)){e.browserClosedFailedKeepAlives++;let c=3;e.browserClosedFailedKeepAlives>=c&&e.browserClosedCallbacks.forEach(l=>{try{l(a)}catch{}})}else e.browserClosedFailedKeepAlives=0})};this.keepAliveTimer=setInterval(t,1e4)}switchToLocatedFrame(e){return this.getElement(e).then(async t=>{let r=At(t.value);return await this.switchToFrame({ELEMENT:r,[at]:r}),t})}switchToFrame(e){return this.frame(e)}switchToTopFrame(){return this.frame().catch(e=>{var t;throw(t=e.message)!=null&&t.includes("ECONNREFUSED")?new qs:e})}getElement(e){let t=this.seleniumPerfStats.markStart(Ae.GET_ELEMENT);return typeof e=="string"||typeof e=="number"?this.getElementBySelector(`[testim_dom_element_id='${e}']`).finally(()=>this.seleniumPerfStats.markEnd(t,Ae.GET_ELEMENT)):e&&e.shadowPath&&e.shadowPath.length||M.flags.runGetElementCodeInAut.isEnabled()&&this.isSafari()?this.execute(`
                    var fn = ${ir().getLocatedElementCode};
                    return fn.apply(null, arguments);
                `,e).finally(()=>this.seleniumPerfStats.markEnd(t,Ae.GET_ELEMENT)):this.getElementBySelector(`[testim_dom_element_id='${e&&e.testimId}']`).finally(()=>this.seleniumPerfStats.markEnd(t,Ae.GET_ELEMENT))}executeJS(e,t){return this.execute(e,t)}executeJSWithArray(e,t){return t.unshift(e),this.execute.apply(this,t)}executeCodeAsync(e,t,r){return this.timeouts("script",t).then(()=>this.executeAsync(e,r))}async markDynamicParent(e,t,r){function n(o){var i=o.attributeName,a=o.attributeValue,c=getLocatedElement(o.locatedElement);if(!c)throw new Error("could not find dynamic parent");c.setAttribute(i,a)}return this.executeJS(`
            var getLocatedElement = ${ir().getLocatedElementCode};
            var setDynamicParentAttribute = ${n.toString()};
            return setDynamicParentAttribute.apply(null, arguments)
        `,{attributeName:fE().DYNAMIC_PARENT_FIELD_NAME,attributeValue:t,locatedElement:e.locatedElement})}getLocatedElementRectWithPadding(e){function t(r){var n=getLocatedElement(r);if(!n)return null;var o=parseInt(window.getComputedStyle(n).paddingTop.replace("px",""),10)||0,i=parseInt(window.getComputedStyle(n).paddingLeft.replace("px",""),10)||0,a=n.getBoundingClientRect();return{top:Math.round(a.top+o),left:Math.round(a.left+i)}}return this.executeJS(`
            var getLocatedElement = ${ir().getLocatedElementCode};
            var getLocation = ${t.toString()};
            return getLocation.apply(null, arguments)
        `,e)}getElementLocationWithPadding(e){return this.getLocatedElementRectWithPadding(e)}getLocatedElementRect(e){function t(r){var n=getLocatedElement(r);if(!n)return null;var o=n.getBoundingClientRect();return{bottom:Math.round(o.bottom),height:Math.round(o.height),x:Math.round(o.left),right:Math.round(o.right),y:Math.round(o.top),width:Math.round(o.width)}}return this.executeJS(`
            var getLocatedElement = ${ir().getLocatedElementCode};
            var getLocation = ${t.toString()};
            return getLocation.apply(null, arguments)
        `,e)}getElementLocation(e){return this.getLocatedElementRect(e.locatedElement)}getTargetText(e){return this.getElementTextJS(e.locatedElement)}getElementTextJS(e){function t(r,n){function o(d){if(!d.childNodes||d.childNodes.length===0)return d;var m=Array.apply(null,d.childNodes).filter(function(p){return p.nodeType===Node.ELEMENT_NODE});return m.forEach(function(p){typeof p.tagName=="string"&&p.tagName.toLowerCase()==="title"?d.removeChild(p):o(p)}),d}function i(d){var m=d.tagName;return m==="INPUT"||m==="TEXTAREA"}function a(d){try{if(d.shadowRoot&&Object.getOwnPropertyDescriptor(d.ownerDocument.defaultView.Node.prototype,"textContent").get.toString().indexOf("[native code]")===-1)return d.shadowRoot.textContent.replace(/(\r\n|\n|\r)/gm,"")}catch{}if(n&&Array.prototype.some.call(d.children,function(f){return f.hidden})){var m=d.cloneNode(!0),p=Array.prototype.filter.call(m.children,function(f){return f.hidden});return p.forEach(function(f){m.removeChild(f)}),m.textContent.replace(/(\r\n|\n|\r)/gm,"")}return d.textContent.replace(/(\r\n|\n|\r)/gm,"")}function c(d){if(i(d))return d.value;if(d instanceof SVGElement){var m=d.cloneNode(!0);return o(m).textContent.replace(/(\r\n|\n|\r)/gm,"")}else return a(d)}var l=getLocatedElement(r);return l?c(l):""}return this.executeJS(`
            var getLocatedElement = ${ir().getLocatedElementCode};
            var extractText = ${t.toString()};
            return extractText.apply(null, arguments)
        `,e,this.ignoreHiddenTagsText).then(r=>r.value)}getHTML(e){let t=ir().getHtmlCode(null,e),r=this.seleniumPerfStats.markStart(Ae.GET_HTML);return this.executeJS(t).then(n=>(this.seleniumPerfStats.markEnd(r,Ae.GET_HTML),n.value)).catch(n=>{this.seleniumPerfStats.markEnd(r,Ae.GET_HTML);let o=Object.assign(new Error,{success:!1,reason:n.toString(),errorType:"internal-error"});throw this.client.requestHandler.sessionID||(o.extraInfo="Inside getHtml catch and trying to check if in quirks mode - but the session has already terminated"),o})}maximizeWithoutValidation(){return this.windowHandleMaximize()}setViewportSizeNEW(e,t){let n=function(){return{screenWidth:Math.floor(window.innerWidth||0),screenHeight:Math.floor(window.innerHeight||0)}},o=(a,c=1)=>this.windowHandleSize().then(l=>this.execute(n).then(d=>{let m=l.value.width-d.value.screenWidth,p=l.value.height-d.value.screenHeight;return this.windowHandleSize({width:a.width+m,height:a.height+p})}).then(()=>this.execute(n)).then(d=>{if(c<5&&(d.value.screenWidth!==a.width||d.value.screenHeight!==a.height))return o(a,c+1)}));if(typeof e!="object"||typeof e.width!="number"||typeof e.height!="number"||typeof t<"u"&&typeof t!="boolean")throw new Error("number or type of arguments don't agree with setViewportSize command");return(typeof t>"u"?!0:t)?o(e):this.windowHandleSize(e)}setViewportSize(e,t){var r=!0;return this.setViewportSizeNEW({width:e,height:t},r)}getBrowserMajorVersion(e){try{return parseInt(e.browser.major,10)}catch(t){return Ve.error("failed to get browser version",{err:t}),0}}getBrowserAndOS(){function e(t,r){var n=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(n[1]))return"Internet Explorer "+r.major;if(n[1]==="Chrome"&&t.match(/\bOPR\/(\d+)/)!==null)return"opera";if(n[1]==="Chrome"&&t.match(/\bEdge|Edg\/(\d+)/)!==null)return"edge";n=n[2]?[n[1],n[2]]:[t.appName,t.appVersion,"-?"];var o=t.match(/version\/(\d+)/i);return o!==null&&n.splice(1,1,o[1]),n[0].toLowerCase()}return this.browserAndOS?Promise.resolve(this.browserAndOS):this.executeJS(function(){return typeof window>"u"||!window.navigator||!window.navigator.userAgent?"unknown":window.navigator.userAgent}).then(t=>{let r=t.value,n=(0,Rh.default)(r),o=n.os;return this.browserAndOS={os:o.name+" "+o.version,browserMajor:this.getBrowserMajorVersion(n),browser:e(t.value,n.browser),userAgent:r,browserVersion:n.browser.version},this.browserAndOS})}getUserAgentInfo(){return this.executeJS(`return ${ir().getUserAgentInfo()}`).then(e=>e.value)}setValue(e,t){return super.setValue(e,t)}getRelativeMoveActions(e,t){let{rect:r,clickOffset:n}=e,o=this.inViewCenter(r),i=Math.floor(n.x-o.x),a=Math.floor(n.y-o.y);return!Sh().isWithinBounds(-o.x,o.x,i)||!Sh().isWithinBounds(-o.y,o.y,a)?(Ve.warn("using center as fallback for offset"),this.getMoveActions(0,0,t)):this.getMoveActions(i,a,t)}computeAbsoluteMovement(e){let{frameOffset:t,rect:r,clickOffset:n}=e,o=r.left+n.x+t.x,i=r.top+n.y+t.y;return{x:o,y:i}}actWithActionsAPI(e,t,r,n){let o=this.getRelativeMoveActions(e,r),i=this.getClickActions(n,t);return this.actions([{type:"pointer",id:"mouse",parameters:{pointerType:"mouse"},actions:o.concat(i)}]).catch(a=>{Ve.error("tried to use element origin but failed because of visibility, trying absolute",a);let{x:c,y:l}=this.computeAbsoluteMovement(e),d=this.getMoveActions(c,l);return this.actions([{type:"pointer",id:"mouse",parameters:{pointerType:"mouse"},actions:d.concat(i)}])})}doubleClickWithActionsAPI(e,t){return this.actWithActionsAPI(t,or,e,["pointerDown","pointerUp","pointerDown","pointerUp"])}doubleClickWithJS(e){return this.executeCodeAsync(`
            var getLocatedElement = ${ir().getLocatedElementCode};
            var dispatchFocus = ${Mr.toString()};
            var doubleClick = ${vh.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return doubleClick.call(null, eventData, done);
        `,e.timeout,e)}getClickActions(e=[],t){return e.map(r=>({type:r,button:t}))}getClickActionList(e=[],t){return[{type:"pointer",id:"mouse",actions:this.getClickActions(e,t)}]}leftClickWithActionsAPI(e,t){return this.actWithActionsAPI(t,or,e,["pointerDown","pointerUp"])}rightClickWithActionsAPI(e,t){return this.actWithActionsAPI(t,pE,e,["pointerDown","pointerUp"])}rightClick(e,t){return this.unsupportedActions.move?this.rightClickWithActionsAPI(e,t):super.rightClick(e).catch(r=>{if(Fe(r))return this.unsupportedActions.move=!0,this.rightClickWithActionsAPI(e,t);throw r})}leftClick(e,t){return this.unsupportedActions.move?this.leftClickWithActionsAPI(e,t):super.leftClick(e).catch(r=>{if(Fe(r))return this.unsupportedActions.move=!0,this.leftClickWithActionsAPI(e,t);throw r})}dragAndDropOldAPI(e,t){return this.moveTo(At(e)).then(()=>this.buttonDown()).then(()=>this.moveTo(At(t))).then(()=>this.buttonUp())}calculateElementMiddlePoint(e,t={top:0,left:0}){return this.getLocatedElementRect(e).then(r=>{if(!r||!r.value)throw Ve.warn(`could not find element for locatedElement ${e}`),new Error("could not calculate rect");let{x:n,y:o,width:i,height:a}=r.value;return{x:t.left+n+i/2,y:t.top+o+a/2}})}hover(e,t){if(this.unsupportedActions.move)return this.moveToElementWithActionsAPI(e,t);let{rect:r,clickOffset:n}=t,o=this.inViewCenter(r),i=Math.floor(n.x-o.x),a=Math.floor(n.y-o.y);return this.moveTo(At(e),i,a).catch(c=>{if(Fe(c))return this.unsupportedActions.move=!0,this.moveToElementWithActionsAPI(e,t);throw c})}getMoveActions(e=1,t=1,r="viewport",n=0){return[{type:"pointerMove",duration:n,x:Math.floor(e)||1,y:Math.floor(t)||1,origin:r}]}moveWithActionsAPI(e){let t=this.getMoveActions(e.x,e.y);return this.actions([{type:"pointer",id:"mouse",actions:t}])}moveToElementWithActionsAPI(e,t){return this.actions([{type:"pointer",id:"mouse",actions:this.getRelativeMoveActions(t,e)}]).catch(r=>{Ve.error("tried to use element origin but failed because of visibility, trying location",r);let n=this.computeAbsoluteMovement(t);return this.moveWithActionsAPI(n)})}getDragCoordinates(e){let t=e.filter(o=>o.event==="mousemove"||o.event==="pointermove"),r=Xe.first(t).pointerPosition,n=Xe.last(t).pointerPosition;return{xDiff:n.screenX-r.screenX,yDiff:n.screenY-r.screenY}}dragWithMoveTo(e,t,r,n,o){return this.moveTo(At(e),n,o).then(()=>this.buttonDown()).then(()=>this.moveTo(At(e),t,r)).then(()=>this.buttonUp())}dragWithActionsAPI(e,t,r,n,o){let i=this.getMoveActions(n,o,e,1),a=this.getClickActions(["pointerDown"],or),c=this.getMoveActions(t,r,"pointer",1),l=this.getClickActions(["pointerUp"],or);return this.actions([{type:"pointer",id:"mouse",actions:i.concat(a).concat(c).concat(l)}])}drag(e,t,r,n,o){let{width:i,height:a}=t,c=r-i/2+1,l=n-a/2;return this.getDragCoordinates(o).then(d=>{let{xDiff:m,yDiff:p}=d;return this.unsupportedActions.move?this.dragWithActionsAPI(e,m,p,c,l):this.dragWithMoveTo(e,m,p,c,l).catch(f=>{if(Fe(f))return this.unsupportedActions.move=!0,this.dragWithActionsAPI(e,m,p,c,l);throw f})})}getMoveRelativeSequence(e,t,r,n){let o=p=>p*p,i=(p,f)=>Math.sqrt(o(p.x-f.x)+o(p.y-f.y)),a={x:e,y:t},c={x:r,y:n},l=10,d=Math.round(i(a,c)/l),m=Array.apply([],new Array(d)).map(()=>({x:Math.round((c.x-a.x)/d),y:Math.round((c.y-a.y)/d)}));return[{x:1,y:1}].concat(m)}getMoveAbsoluteSequence(e,t,r,n){return this.getMoveRelativeSequence(e,t,r,n).reduce((i,a)=>{let c=Xe.last(i);return i.concat({x:Math.round(c.x+a.x),y:Math.round(c.y+a.y)})},[{x:Math.round(e),y:Math.round(t)}])}async dragAndDropWithGeneratedMoves(e,t,r){let{fromRect:n,fromX:o,fromY:i,toRect:a,toX:c,toY:l}=r,d=this.getMoveRelativeSequence(n.left+o,n.top+i,a.left+c,a.top+l);await this.moveTo(At(e),Math.round(o),Math.round(i)),await this.buttonDown();for(let m of d)await this.moveTo(null,m.x,m.y);return await this.moveTo(At(t),Math.round(c),Math.round(l)),await this.buttonUp()}dragAndDropWithActionsAPIWithGeneratedMoves(e){let{fromRect:t,fromX:r,fromY:n,toRect:o,toX:i,toY:a}=e,c=Math.round(t.left+r),l=Math.round(t.top+n),d=Math.round(o.left+i),m=Math.round(o.top+a),p=this.getMoveAbsoluteSequence(t.left+r,t.top+n,o.left+i,o.top+a),f=this.getMoveActions(c,l),h=this.getClickActions(["pointerDown"],or),g=Xe.flatMap(p,b=>this.getMoveActions(b.x,b.y)),y=this.getMoveActions(d,m),T=this.getClickActions(["pointerUp"],or),C=f.concat(h).concat(g).concat(y).concat(T);return this.actions([{type:"pointer",id:"mouse",actions:C}])}dragAndDrop(e,t,r){return this.isSafari()?this.unsupportedActions.move?this.dragAndDropWithActionsAPIWithGeneratedMoves(r):this.dragAndDropWithGeneratedMoves(e,t,r).catch(n=>{if(Fe(n))return this.unsupportedActions.move=!0,this.dragAndDropWithActionsAPIWithGeneratedMoves(r);throw n}):this.unsupportedActions.move?this.dragAndDropWithActionsAPI(r):this.dragAndDropOldAPI(e,t).catch(n=>{if(Fe(n))return this.unsupportedActions.move=!0,this.dragAndDropWithActionsAPI(r);throw n})}doubleClickFallback(e,t,r){return this.isSafari()?this.doubleClickWithJS(t):this.doubleClickWithActionsAPI(e,r)}doubleClick(e,t,r){return this.unsupportedActions.move||this.isSafari()?this.doubleClickFallback(e,t,r):this.moveTo(At(e)).then(()=>this.doDoubleClick()).catch(n=>{if(Fe(n))return this.unsupportedActions.move=!0,this.doubleClickFallback(e,t,r);throw n})}dragAndDropWithActionsAPI(e){let{fromRect:t,fromX:r,fromY:n,toRect:o,toX:i,toY:a}=e,c=Math.round(t.left+r),l=Math.round(t.top+n),d=Math.round(o.left+i),m=Math.round(o.top+a);return this.moveWithActionsAPI({x:c,y:l}).then(()=>{let p=this.getClickActionList(["pointerDown"],or);return this.actions(p)}).then(()=>this.moveWithActionsAPI({x:d,y:m})).then(()=>{let p=this.getClickActionList(["pointerUp"],or);return this.actions(p)})}getTabIds(){return this.windowHandles().then(e=>e.value)}isVisible(e){return this.elementIdDisplayed(At(e)).then(t=>t.value)}getSource(){return this.source()}getElementRect(e){let t={width:0,height:0,top:0,left:0};return this.getElementLocation(e).catch(r=>Ve.error("error getting element location",{err:r})).then(r=>r!=null&&r.value?{top:r.value.y,left:r.value.x,width:r.value.width,height:r.value.height}:t)}end(){return Ve.info("delete session",{sessionId:this.getSessionId()}),this.getSessionId()||Ve.warn("failed to close session because session is undefined"),clearInterval(this.keepAliveTimer),super.end().catch(()=>{})}inViewCenter(e){return{x:e.width/2,y:e.height/2}}}});var vu,Eu,Ai,Su=w(()=>{"use strict";j();ye();Te();vu=R("lab-features-service"),Eu=class{constructor(){this.featuresForProject=[];this.labBatman=!1}async loadLabFeatures(e,t){(!t||!e)&&(vu.error("missing companyPlan or projectId when loading lab features",{companyPlan:t,projectId:e}),this.featuresForProject=[]);try{let r=this.isLabsEnabledForCompany(t),n=r?await rl(e):[];this.featuresForProject=n,this.labBatman=r}catch(r){vu.error("failed loading lab features",{err:r,companyPlan:t,projectId:e}),this.featuresForProject=[]}}isFeatureAvailableForProject(e){let t=M.flags[e];this.validateAsLabFeatureFlag(t);let r=t.getValue();if(r==="disabled")return!1;if(r==="enabled")return!0;let{featuresForProject:n,labBatman:o}=this,i=n.find(c=>c.featureFlagName===e),a=i==null?void 0:i.enabled;return Boolean(o&&a)}isLabsEnabledForCompany(e){var t;return Boolean((t=e==null?void 0:e.premiumFeatures)==null?void 0:t.enableLabFeatures)}validateAsLabFeatureFlag(e){if("getValue"in e)return;let t=`Attempted querying a lab feature flag which isn't a variant. This means that a wrong configuration is being used in FeatureFlagsService (for feature flag: ${e.name}`;throw vu.error(t,{featureFlagName:e.name}),new Error(t)}},Ai=new Eu});function Ph(s){let e=/^\\\\\?\\/.test(s),t=/[^\u0000-\u0080]+/.test(s);return e||t?s:s.replace(/\\/g,"/")}function gE(s,e,t,r,n={},o=void 0,i=void 0){let a=Object.keys(n).reduce((g,y)=>(g+=`
        var ${y} = require('${Ph(n[y])}');
        `,g),""),c=i?`
            ${Iu.default.toString()}
            var fileBuffer = dataUriToBuffer('${i}');
        `:"var fileBuffer = null;";function l(g,y){function T(){return g.apply(this,y)}return T.prototype=g.prototype,new T}let d=`

        const getMessage = arguments => {
            const args = Array.prototype.slice.call(arguments);
            let message = args.shift() + '';
            if (!args.length) {
                return message;
            }
            message = message.replace(/%([odifs])/g, function (s, param) {
                // Formatting is not yet supported.
                var arg;
                if (!args.length) {
                    return '';
                }
                arg = args.shift();
                if (param === 'o') {
                    return arg + '';
                } else if (param === 'd' || param === 'i') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseInt(arg, 10);
                    return isNaN(arg) ? '0' : arg + '';
                } else if (param === 'f') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseFloat(arg);
                    return isNaN(arg) ? '0.000000' : arg.toFixed(6) + '';
                } else if (param === 's') {
                    return arg + '';
                }
            });
            if (message) {
                args.unshift(message);
            }
            return args.join(' ').replace(/\\s*$/, ' ');
        };

        const pushNewMessage = (method, consoleArgs) => {
            const message = getMessage(consoleArgs);
            progress({
                method,
                msg: message,
                timestamp: Date.now()
            });
        };

        ["log", "info", "warn", "error", "debug"].forEach(function (method) {
            const nativeMethod = console[method];
            const oldMethod = nativeMethod && nativeMethod.bind(console);
            console[method] = function () {
                pushNewMessage(method, arguments);
                oldMethod && oldMethod.apply(console, arguments);
            };
        });
    `,m=`
        function injectCode(params, args, incomingParams, context, code, done) {
            var constructWithArguments = ${l.toString()}

            var resolve = function (result) {
                done({
                    status: 'done',
                    result: result,
                    success: true
                });
            };
            var reject = function (result) {
                done({
                    status: 'failed',
                    result: result,
                    success: false
                });
            };

            try {
                params.push(code);
                var functionToRun = constructWithArguments(Function, params);

                var result = functionToRun.apply(null, args);
                if (isPromise(result)) {
                    result.then(function (res) {
                        resolve({
                            resultValue: res,
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    }).catch(function (err) {
                        reject({
                            resultValue: err && err.toString(),
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    });
                } else {
                    resolve({
                        resultValue: result,
                        exports: exportedData,
                        exportsTest: exportedTestData,
                        exportsGlobal: exportedGlobalData
                    });
                }
            } catch (e) {
                reject({
                    resultValue: e && e.toString(),
                    exports: exportedData,
                    exportsTest: exportedTestData,
                    exportsGlobal: exportedGlobalData
                });
            }
        }
    `,p=`
        // A hack to fix an issue with stringified functions which use require. when compiling to JS, calls to require change to __require.
        const __require = require;
        ${a}

        ${c}

        ${d}

        var isPromise = ${ao.toString()}

        const {incomingParams, context, code} = input;

        var exportedData = {};
        var exportedTestData = {};
        var exportedGlobalData = {};

        var params = ["context"]
            .concat(incomingParams.as.functionParameters)
            .concat(${JSON.stringify(Object.keys(n))})
            .concat(['exports', 'exportsTest', 'exportsGlobal']);

        var args = [context]
            .concat(incomingParams.as.functionArguments)
            .concat([${Object.keys(n).join(",")}])
            .concat([exportedData, exportedTestData, exportedGlobalData]);

        if(fileBuffer) {
            params = params.concat(['fileBuffer']);
            args = args.concat([fileBuffer]);
        }

        ${m}

        injectCode(params, args, incomingParams, context, code, done);
    `,f=[],h=(0,ki.spawn)(l(Function,["input","done","progress",p]));return te(new Promise(g=>{h.send({incomingParams:e,context:t,code:r}).on("message",y=>{let T=Object.assign({},y,{tstConsoleLogs:f});Ue.debug("Run code worker response",{messageWithLogs:T,transactionId:s}),g(T)}).on("progress",y=>{f.push(y)}).on("error",y=>{y.message==="malformed data: URI"?Ue.error("Run code worker error",{err:y,transactionId:s,fileDataUrl:i}):Ue.error("Run code worker error",{err:y,transactionId:s}),g({tstConsoleLogs:f,status:"failed",result:{resultValue:y==null?void 0:y.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1})}).on("exit",()=>{Ue.debug("Run code worker has been terminated",{transactionId:s})})}),o).catch(g=>{if(!(g instanceof J))throw g;return Ue.warn("timeout to run code",{transactionId:s,err:g}),{tstConsoleLogs:f,status:"failed",result:{resultValue:g==null?void 0:g.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1}}).finally(()=>h==null?void 0:h.kill())}function yE(s){try{return{sync:!0,lib:globalThis.require(s)}}catch(e){if(e.code==="ERR_REQUIRE_ESM"){let t=globalThis.require("path");return{sync:!1,lib:Ru.promises.readFile(`${Rs}${t.sep}package.json`).then(n=>{let o=JSON.parse(n);return import(t.join(s,o.main||`${t.sep}index.js`))})}}throw e}}function bE(s,e,t,r,n={},o=void 0,i=void 0){Ur||(Ur=require("worker_threads"));let{Worker:a}=Ur,c=Object.keys(n).reduce((y,T)=>(y+=`
        var res = requireOrImportMethod('${Ph(n[T])}');
        if (res.sync) {
            var ${T} = res.lib;
        } else {
            var ${T} = await res.lib;
        }
        `,y),""),l=i?`
            ${Iu.default.toString()}
            var fileBuffer = dataUriToBuffer('${i}');
        `:"var fileBuffer = null;";function d(y,T){function C(){return y.apply(this,T)}return C.prototype=y.prototype,new C}let m=`
        const getMessage = arguments => {
            const args = Array.prototype.slice.call(arguments);
            let message = args.shift() + '';
            if (!args.length) {
                return message;
            }
            message = message.replace(/%([odifs])/g, function (s, param) {
                // Formatting is not yet supported.
                var arg;
                if (!args.length) {
                    return '';
                }
                arg = args.shift();
                if (param === 'o') {
                    return arg + '';
                } else if (param === 'd' || param === 'i') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseInt(arg, 10);
                    return isNaN(arg) ? '0' : arg + '';
                } else if (param === 'f') {
                    arg = typeof arg === 'boolean' ? (arg ? 1 : 0) : parseFloat(arg);
                    return isNaN(arg) ? '0.000000' : arg.toFixed(6) + '';
                } else if (param === 's') {
                    return arg + '';
                }
            });
            if (message) {
                args.unshift(message);
            }
            return args.join(' ').replace(/\\s*$/, ' ');
        };

        const pushNewMessage = (method, consoleArgs) => {
            const message = getMessage(consoleArgs);
            parentPort.postMessage({
                action: 'progress',
                data: {
                    method,
                    msg: message,
                    timestamp: Date.now(),
                }
            });
        };

        ["log", "info", "warn", "error", "debug"].forEach(function (method) {
            const nativeMethod = console[method];
            const oldMethod = nativeMethod && nativeMethod.bind(console);
            console[method] = function () {
                pushNewMessage(method, arguments);
                oldMethod && oldMethod.apply(console, arguments);
            };
        });
    `,p=`
        function injectCode(params, args, incomingParams, context, code) {
            var constructWithArguments = ${d.toString()}

            var resolve = function (result) {
                parentPort.postMessage({
                    action: 'finish',
                    data: {
                        status: 'done',
                        result: result,
                        success: true,
                    }
                });
            };
            var reject = function (result) {
                parentPort.postMessage({
                    action: 'finish',
                    data: {
                        status: 'failed',
                        result: result,
                        success: false,
                    }
                });
            };

            try {
                params.push(code);
                const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                var functionToRun = constructWithArguments(AsyncFunction, params);

                var result = functionToRun.apply(null, args);
                if (isPromise(result)) {
                    result.then(function (res) {
                        resolve({
                            resultValue: res,
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    }).catch(function (err) {
                        reject({
                            resultValue: err && err.toString(),
                            exports: exportedData,
                            exportsTest: exportedTestData,
                            exportsGlobal: exportedGlobalData
                        });
                    });
                } else {
                    resolve({
                        resultValue: result,
                        exports: exportedData,
                        exportsTest: exportedTestData,
                        exportsGlobal: exportedGlobalData
                    });
                }
            } catch (e) {
                reject({
                    resultValue: e && e.toString(),
                    exports: exportedData,
                    exportsTest: exportedTestData,
                    exportsGlobal: exportedGlobalData
                });
            }
        }
    `,f=`
        (async function() {
            // A hack to fix an issue with stringified functions which use require. when compiling to JS, calls to require change to __require.
            const __require = require;
            const { parentPort } = require('worker_threads');
            var requireOrImportMethod = ${yE}

            // requireCode will set async to be true if needed.
            ${c}

            ${l}

            ${m}

            var isPromise = ${ao.toString()}

            parentPort.once('message', input => {
                const {incomingParams, context, code} = input;

                var exportedData = {};
                var exportedTestData = {};
                var exportedGlobalData = {};

                var params = ["context"]
                    .concat(incomingParams.as.functionParameters)
                    .concat(${JSON.stringify(Object.keys(n))})
                    .concat(['exports', 'exportsTest', 'exportsGlobal']);

                var args = [context]
                    .concat(incomingParams.as.functionArguments)
                    .concat([${Object.keys(n).join(",")}])
                    .concat([exportedData, exportedTestData, exportedGlobalData]);

                if(fileBuffer) {
                    params = params.concat(['fileBuffer']);
                    args = args.concat([fileBuffer]);
                }

                ${p}

                injectCode(params, args, incomingParams, context, code);
            });
        })();
    `,h=[],g=new a(f,{eval:!0});return te(new Promise(y=>{g.on("message",T=>{if(T.action==="finish"){let{data:C}=T,b=Object.assign({},C,{tstConsoleLogs:h});Ue.debug("Run code worker response",{messageWithLogs:b,transactionId:s}),y(b)}else T.action==="progress"&&h.push(T.data)}).on("error",T=>{T.message==="malformed data: URI"?Ue.error("Run code worker error",{err:T,transactionId:s,fileDataUrl:i}):Ue.error("Run code worker error",{err:T,transactionId:s}),y({tstConsoleLogs:h,status:"failed",result:{resultValue:T==null?void 0:T.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1})}).on("exit",()=>{Ue.debug("Run code worker has been terminated",{transactionId:s})}),g.postMessage({incomingParams:e,context:JSON.parse(JSON.stringify(t)),code:r})}),o).catch(y=>{if(!(y instanceof J))throw y;return Ue.warn("timeout to run code",{transactionId:s,err:y}),{tstConsoleLogs:h,status:"failed",result:{resultValue:y==null?void 0:y.toString(),exports:{},exportsTest:{},exportsGlobal:{}},success:!1}}).finally(()=>g==null?void 0:g.terminate())}async function wE(s){try{await Ru.promises.rm(s,{recursive:!0,force:!0})}catch(e){Ue.warn("failed to remove install npm packages folder",{err:e})}}function Ch(s,e,t,r){return`${e}_${t}_${s}_${r}`}async function Is(s,e,t,r,n,o){let i=Ch(n,e,s,t),{data:a}=await TE(i,r,o);return a}async function xs(s,e,t,r,n,o,i,a,c,l){var h;let d=Object.fromEntries(((h=t.nodePackageParams)==null?void 0:h.map(g=>[g.paramName,g.testimPackageLocalLocation]))||[]),m=Ch(i,n,e,o);if(l){let g=await fn(l);g&&(c=g)}if(typeof Ur>"u")try{Ur=require("worker_threads")}catch{Ur=!1}Buffer.isBuffer(c)&&(Ue.debug("runCodeWithPackages: converted a buffer to base 64 string data URI",{fileDataUrl:c}),c=c.toString());let p="data:,";if(c==="data:"&&(Ue.debug("runCodeWithPackages, fileDataUrl was an empty string ",{fileDataUrl:c}),c=p),Ur&&M.flags.enableWorkerThreadsCliCodeExecution.isEnabled()){let g=await bE(m,t,r,s,d,a,c);return Object.assign({},g,{nodeVersion:process.version})}let f=await gE(m,t,r,s,d,a,c);return Object.assign({},f,{nodeVersion:process.version})}async function TE(s,e,t){let r=e.map(c=>`${c.packageName}@${c.packageVersion}`),n=Ah(),o=Rs.join(n,`/${s}`),i=global.proxyUri;async function a(){let c="";try{if(c=await Vp(o,r,i,t),Ue.info("npm package install finished",{transactionId:s,output:c,timeout:t}),Number(c.trim().split(" ")[1])<r.length)throw"npm package install failed, couldn't install all packages";return{data:e.map(d=>{let m=Gp(o,d.packageName),p=`${d.packageName}@${m}`,f=Rs.resolve(o,"node_modules",d.packageName);return Object.assign({},d,{packageFullName:p,packageLocalLocation:f})}),installFolder:o}}catch(l){throw Ue.warn("npm package install failed",{transactionId:s,err:l}),l}}try{return await te(a(),t)}catch(c){throw c instanceof J&&Ue.warn("timeout to install package",{packages:r,transactionId:s,err:c,timeout:t}),c}}function Ah(){return Rs.join(xh.tmpdir(),"/testim_local_packages")}function kh(){let s=Ah();return wE(s)}var Ru,xh,Rs,Iu,ki,Ue,Ur,jr=w(()=>{"use strict";Ru=E(require("fs")),xh=E(require("os")),Rs=E(require("path"));U();an();Iu=E(require("data-uri-to-buffer")),ki=require("threads");q();j();Te();ye();Ue=R("cli-service");ki.config.set({basepath:{node:__dirname}})});var ar={};W(ar,{run:()=>EE});function vE(s,e){try{let t=e.defaults.enforceMaximumJsResultSize,r=M.flags.maximumJsResultSize.getValue(),n=JSON.stringify(s).length>r;return t?n:!1}catch{return!1}}var EE,_h=w(()=>{"use strict";jr();q();ye();EE=async(s,e,t)=>{let{code:r,stepId:n,incomingParams:o,context:i,testResultId:a,retryIndex:c,stepResultId:l,runTimeout:d,fileDataUrl:m,s3filepath:p}=e.data;try{let f=await xs(r,n,o,i,a,c,l,d,m,p);return f&&vE({result:f.result,tstConsoleLogs:f.tstConsoleLogs},t)?{code:"js-result-max-size-exceeded",success:!1}:{data:f,success:!0}}catch(f){throw f instanceof J?new Error("Timeout while running action"):f}}});var xu,Cs,Pu=w(()=>{"use strict";j();xu=R("cookies-utils"),Cs=class{constructor(e){this.driver=e}async set(e){let t=e.domain;!e.hostOnly&&t&&!t.startsWith(".")&&(t=`.${t}`);try{return await this.driver.setCookie(e.name,e.value,t,e.httpOnly,e.secure,e.path,e.expirationDate)}catch(r){throw xu.error("failed to set cookie",{err:r}),r}}async get(e){try{return await this.driver.getCookie(e.name)}catch(t){throw xu.error("failed to get cookie",{err:t}),t}}async remove(e){try{return await this.driver.deleteCookie(e.name)}catch(t){throw xu.error("failed to remove cookie",{err:t}),t}}}});var Cu,SE,As,Au=w(()=>{"use strict";U();Cu=E(require("p-retry"));U();j();q();SE=R("window-utils"),As=class{constructor(e,t){this.id=e,this.driver=t}getElementFromPoint(e,t){function r(n,o){var i=document.elementFromPoint(n,o);return{testimId:i?i.getAttribute("testim_dom_element_id"):null,tagName:i?i.tagName:null}}return this.driver.executeJS(r,e,t).then(n=>n.value)}getLocation(){return this.driver.getUrl()}stopListeningToScroll(){return Promise.resolve()}resumeListeningToScroll(){return Promise.resolve()}scrollToPosition(e){return this.driver.scroll(e.x,e.y)}scrollToPositionWithoutAnimation(e){function t(r){var n="scrollBehavior"in document.documentElement.style;return n?window.scrollTo({left:r.x,top:r.y,behavior:"instant"}):window.scrollTo(r.x,r.y)}return this.driver.executeJS(t,e)}getCurrentScrollPosition(){function e(){return{x:window.scrollX,y:window.scrollY}}return this.driver.executeJS(e).then(t=>t.value)}navigate(e,t=15e3){let r=this;async function n(o=3){try{await r.driver.url(e)}catch(i){if(i.seleniumStack&&i.message.includes("method IWebBrowser2::Navigate2() failed")&&o>0)return SE.warn("selenium navigation failed. retrying to navigate",{err:i}),await se(1500),n(o-1);throw i}}return Promise.race([n(),se(t)])}reloadTab(e=15e3){return Promise.race([this.driver.reloadTab(),se(e)])}getViewportSize(){return this.driver.getViewportSize()}maximizeWithoutValidation(){return this.driver.maximizeWithoutValidation()}getFullPageSize(){function e(){var t=document.body,r=document.documentElement,n=Math.max(t.scrollHeight,t.offsetHeight,r.clientHeight,r.scrollHeight,r.offsetHeight),o=Math.max(t.scrollWidth,t.offsetWidth,r.clientWidth,r.scrollWidth,r.offsetWidth);return{height:n,width:o}}return this.driver.executeJS(e).then(t=>t.value)}extractToNewWindow(){return Promise.resolve()}async checkSize(e){await se(1e3);let t=await this.getViewportSize();return t.width!==e.width||t.height!==e.height?Promise.reject({actualSize:t,expectedSize:e}):{actualSize:t,expectedSize:e}}async setViewportSize(e){return await this.driver.setViewportSize(e.width,e.height),await this.checkSize(e)}async validatePageIsAvailable(){function e(){var r;if(typeof location<"u")r=location;else if(typeof window<"u"&&typeof window.location<"u")r=window.location;else return!1;return r.href!=="chrome-error://chromewebdata/"&&r.href!=="safari-resource:/ErrorPage.html"&&r.href.indexOf("res://ieframe.dll/http_404.htm")!==0&&r.href.indexOf("ms-appx-web://microsoft.microsoftedge/assets/errorpages/")!==0}if(!(await this.driver.executeJS(e)).value)throw new ut("validatePageIsAvailable:PageNotAvailableError")}focusTab(){return this.driver.switchTab(this.id)}quit(){}async getOsAndBrowser(){let e=await(0,Cu.default)(()=>this.driver.getBrowserAndOS(),{retries:3});return{uaBrowserName:e.browser,uaOs:e.os,userAgent:e.userAgent,browserVersion:e.browserVersion}}getUserAgentInfo(){return(0,Cu.default)(()=>this.driver.getUserAgentInfo(),{retries:3})}}});var ku,_i,Oh=w(()=>{"use strict";ku=E(require("p-retry")),_i=class{constructor(e,t,r={takeScreenshots:!0}){this.tabId=e,this.driver=t,this.options=r}base64AddPadding(e){return e+Array((4-e.length%4)%4+1).join("=")}shouldTakeScreenshots(){return typeof this.options.takeScreenshots!="boolean"?!0:this.options.takeScreenshots}async takeScreenshot(){if(!this.shouldTakeScreenshots())return{devicePixelRatio:1,image:""};let e=3,t=2e3,r=this.currentDevicePixelRatio?Promise.resolve(this.currentDevicePixelRatio):this.getDevicePixelRatio(),n=()=>Promise.all([r,this.driver.takeScreenshot()]),[o,i]=await(0,ku.default)(n,{retries:e,minTimeout:t}),a=i?i.value:"";return{image:`data:image/png;base64,${this.base64AddPadding(a.replace(/[\r\n]/g,""))}`,devicePixelRatio:o}}async takeElementScreenshot(e){if(!this.shouldTakeScreenshots())return{devicePixelRatio:1,image:""};let t=3,r=2e3,n=this.currentDevicePixelRatio?Promise.resolve(this.currentDevicePixelRatio):this.getDevicePixelRatio(),o=()=>Promise.all([n,this.driver.takeElementScreenshot(e)]),[i,a]=await(0,ku.default)(o,{retries:t,minTimeout:r}),c=a?a.value:"";return{image:`data:image/png;base64,${this.base64AddPadding(c.replace(/[\r\n]/g,""))}`,devicePixelRatio:i}}getDevicePixelRatio(){function e(){try{return window.devicePixelRatio}catch{return 1}}return this.driver.executeJS(e).then(t=>t.value)}forcePixelRatio(e=1){return this.currentDevicePixelRatio=e,Promise.resolve()}getCurrentDevicePixelRatio(){return this.currentDevicePixelRatio}}});async function Lh(s,e){let t=e.image||e,r=e.devicePixelRatio;if(!t)throw new Error("Failed to get image");let n=t.match(/^data\:[^;]*\;base64,(.*)$/);if(!n)throw new Error("Image is not in base64 format");let o=s.offset||{top:0,left:0};if(o.top*=r,o.left*=r,!s.elementRect)return RE.warn("missing elementRect",Dh.omit(s,"image")),{};let{elementRect:i}=s,a=await ks.default.read(Buffer.from(n[1],"base64")),c=i.left*r+o.left*r,l=i.top*r+o.top*r,d=i.width*r,m=i.height*r;c<0&&(d+=c,d=d<0?0:d,c=0),l<0&&(m+=l,m=m<0?0:m,l=0);let p=a.bitmap.width,f=a.bitmap.height;if(c+d>p&&(d=p-c),l+m>f&&(m=f-l),m<=0||d<=0)throw new On("height or width is equal or lower than zero");return{elementImage:await a.crop(c,l,d,m).getBase64Async(ks.default.MIME_PNG)}}async function IE(s,e){let t=await ks.default.read(s.width,s.height);for(let n of e){let o=n.image.match(/^data\:[^;]*\;base64,(.*)$/),i=await ks.default.read(Buffer.from(o[1],"base64"));await new Promise((a,c)=>{t.composite(i,n.position.left,n.position.top,l=>{if(l){c(l);return}a()})})}return await t.getBase64Async(ks.default.MIME_PNG)}function xE(s,e){return IE(s,e)}function PE(){return Promise.resolve()}function CE(s){function e(r){return typeof s[r]=="string"&&s[r].startsWith("data")}function t(r){return PE(s[r]).then(n=>({key:r,url:n}))}return Promise.all(Object.keys(s).filter(e).map(t)).then(r=>r.reduce((n,o)=>(n[o.key]=o.url,n),s))}function Nh(s,e){return e=e||1,s=s||{left:0,top:0,width:0,height:0},{left:e*Math.round(s.left),top:e*Math.round(s.top),width:e*Math.round(s.width),height:e*Math.round(s.height),pixelRatio:e}}var Dh,ks,RE,On,Oi,Mh=w(()=>{"use strict";Dh=E(require("lodash"));U();ks=E(require("jimp"));j();RE=R("image-capture-utils"),On=class extends Error{constructor(e){super(e),this.rectIsOutsideOfImageError=!0,Object.setPrototypeOf(this,On.prototype)}};Oi=class{constructor(e,t,r){this.windowUtils=t,this.screenshotUtils=r}async takeViewPortImage(){let e=await this.screenshotUtils.takeScreenshot();return typeof e=="string"?e:e.image}takeImageForComparison(){return this.takeViewPortImage()}async takeAreaDataUrl(e){e.areas&&(e=e.areas);let t=await this.screenshotUtils.takeScreenshot(),r=await Lh(e,t);return r.screenImage=t.image,r.absoluteScreenHighlight=Nh(e.elementRect,t.devicePixelRatio),r}async takeElementImage(e){let t=await this.screenshotUtils.takeElementScreenshot({ELEMENT:e});return typeof t=="string"?t:t.image}async takeArea(e){e.areas&&(e=e.areas);let t=await this.screenshotUtils.takeScreenshot();return CE({screenImage:t.image,absoluteScreenHighlight:Nh(e.elementRect,t.devicePixelRatio)})}forcePixelRatio(e){return this.screenshotUtils.forcePixelRatio(e)}getCurrentDevicePixelRatio(){return this.screenshotUtils.getCurrentDevicePixelRatio()}async takeStitchedDataUrl(e){let{windowUtils:t,screenshotUtils:r}=this,n=()=>se(250),o=Boolean(e);async function i(p,f){o?await t.scrollToPositionWithoutAnimation(p):await t.scrollToPosition(p),await n();let h=await r.takeScreenshot(),g=await Lh({elementRect:f},h);return{position:{left:p.x+f.left,top:p.y+f.top},size:{width:f.width,height:f.height},image:g.elementImage}}async function a(p){let f=[];for(let h of p){let g=await i(h.scrollPos,h.cropData);f.push(g)}return f}function c(p,f){let h=Math.max(p.width,f.width),g=f.width,y=Math.max(p.height,f.height),T=f.height,C=Array.from({length:Math.ceil(h/g)},(v,x)=>({scrollX:Math.min(x*g,h-g),cropX:x*g-Math.min(x*g,h-g),cropW:g-(x*g-Math.min(x*g,h-g))})),b=Array.from({length:Math.ceil(y/T)},(v,x)=>({scrollY:Math.min(x*T,y-T),cropY:x*T-Math.min(x*T,y-T),cropH:T-(x*T-Math.min(x*T,y-T))}));return C.flatMap(v=>b.map(x=>({scrollPos:{x:v.scrollX,y:x.scrollY},cropData:{top:x.cropY,left:v.cropX,width:v.cropW,height:x.cropH}})))}async function l(p,f){let h=await t.getCurrentScrollPosition(),g=c(p,f),y=await a(g);return await t.scrollToPosition(h),xE(p,y)}let[d,m]=await Promise.all([t.getFullPageSize(),t.getViewportSize()]);return await l(d,m)}}});var Fh,Li,Ni,Uh=w(()=>{"use strict";Fh=E(require("semver"));U();j();Au();Oh();Mh();Ee();Li=R("tab-service"),Ni=class{constructor(e){this.driver=e,this._utils={},this.sessionTabs={},this.pendingTabs={},this.addedTabs={}}on(){}tabCount(e){if(this.sessionTabs[e])return this.sessionTabs[e].tabCount}getAllOpenTabIds(e){let t=this.getAllTabInfos(e);return Object.keys(t).filter(r=>!t[r].isClosed)}getActiveTabInfo(e){return this.sessionTabs[e].lastActiveTabInfo}getAllTabIds(e){return Object.keys(this.getAllTabInfos(e)).map(t=>t)}isSessionTab(e,t){return this.getAllTabIds(e).includes(t)}createSesion(e){this.sessionTabs[e]||(this.addedTabs[e]=new Set,this.sessionTabs[e]={tabCount:0,tabInfos:{}})}setAddFrameHandlerCallBack(e){this.addFrameHandler=e}getAllTabInfoStrings(e){return this.getAllTabIds(e).map(r=>{let n=this.getTabInfo(e,r);return`tabId=${r}, url=${n.url}, order=${n.order}, isMain=${n.isMain}, openerStepId=${n.openerStepId}, isClosed=${n.isClosed}, currentUrl: ${n.currentUrl}, lastUpdatedUrl: ${n.lastUpdatedUrl}`})}getAllTabInfos(e){return this.sessionTabs[e].tabInfos}addNewTab(e,t,r,n={}){return this.addedTabs[e].has(t)?Promise.resolve():(this.addedTabs[e].add(t),Li.info(`Adding a new tab sessionId: ${e}, tabId: ${t}, openerId: ${r}`),this.addTab(e,t,this.sessionTabs[e].tabCount++,r,n))}addOpenerStepId(e,t,r){this.sessionTabs[e].tabInfos[t].openerStepId=r}addOpenerStep(e,t,r){this.sessionTabs[e].tabInfos[t].openerStepId=r.id,this.sessionTabs[e].tabInfos[t].openerOriginalStepId=r.originalStepId}fixMissingMainTab(e){if(this.getMainTabInfo(e))return;let r=this.getAllTabInfos(e);Object.keys(r).length!==0&&(Object.values(this.getAllTabInfos(e))[0].isMain=!0)}async buildTabInfo(e,t,r,n,o={}){let i=await this.getTabDetails(t,e,o),a=z();function c(l){return o.checkForMainTab?i.isMainTab:!i.isMainTab||i.isMainTab==="unknown"?!l.getMainTabInfo(e):i.isMainTab}return this.sessionTabs[e].tabInfos[t]={infoId:a,url:i.url,title:i.title,favIconUrl:i.favIconUrl,order:r,from:this.getTabInfo(e,i.openerTabId),isMain:c(this),openerStepId:n},a}async addTab(e,t,r,n,o={}){let i=await this.buildTabInfo(e,t,r,n,o),a=new As(t,this.driver);this._utils[i]={attachDebugger:()=>Promise.resolve(),detachDebugger:()=>Promise.resolve(),onDebuggerDetached:()=>{},tabId:t,domUtils:{getDOM:()=>Promise.resolve()},windowUtils:a,imageCaptureUtils:new Oi(t,a,new _i(t,this.driver,{takeScreenshots:o.takeScreenshots}))}}getTabUtilsByTabIdAndSessionId(e,t){let r=this.sessionTabs[e].tabInfos[t];return this._utils[r.infoId]}getTabUtilsByTabId(e){let t=Object.keys(this._utils).find(r=>this._utils[r].tabId===e);return this._utils[t]}getTabInfo(e,t){return this.sessionTabs[e].tabInfos[t]}getTabUtils(e,t){if(!t)return this.getMainTabUtils(e);if(this._utils[t.infoId])return this._utils[t.infoId];if(t.isMain)return this.getMainTabUtils(e);let r=this.getAllTabInfos(e),n=Object.keys(r).map(i=>r[i]).filter(i=>!i.isMain);if(n.length===1)return this._utils[n[0].infoId];let o=Object.keys(e).map(i=>e[i]).filter(i=>this.isSameTab(e,t,i));return o.length>0?this._utils[o[0].infoId]:this.getMainTabUtils(e)}exactUrlMatch(e,t,r){let n=r.filter(o=>o===t.url);return!!((e.url===t.url||e.currentUrl===t.url||e.currentUrl&&e.currentUrl===t.currentUrl)&&n.length===1)}singleExactMatchForParts(e,t,r,n){let{urlUtils:o}=re(),i=o.urlBreaker(e.url||e.currentUrl),a=o.urlBreaker(t.url||t.currentUrl),c=n(i),l=n(a),d=r.map(m=>o.urlBreaker(m)).map(m=>n(m)).filter(m=>m===c);return c===l&&d.length===1}isSameTab(e,t,r){let{tabMatcher:n}=re();if(n){let l=this.getAllTabInfos(e),d=Object.keys(l).map(m=>l[m]);return n.isSameTab(d,t,r)}if(t.isMain&&r.isMain||t.openerStepId&&r.openerStepId&&t.openerStepId===r.openerStepId)return!0;let o=this.getAllTabInfos(e),i=Object.keys(o).map(l=>o[l].url);if(this.exactUrlMatch(t,r,i))return!0;let a=l=>`${l.domain}/${l.path.join("/")}`;if(this.singleExactMatchForParts(t,r,i,a))return!0;let c=l=>`${l.domain}/${l.path.join("/")}#${l.hash}`;return!!(this.singleExactMatchForParts(t,r,i,c)||t.order===r.order)}getMainTabInfo(e){let t=this.getAllTabInfos(e);return Object.keys(t).map(r=>t[r]).find(r=>r.isMain)}getMainTabUtils(e){let t=this.getMainTabInfo(e);return t?this.getTabUtils(e,t):{}}removeTabInfo(e,t){let n=this.getAllTabInfos(e)[t];delete this.sessionTabs[e].tabInfos[t],delete this._utils[n.infoId],this.sessionTabs[e].tabCount--}getMainTabId(e){let t=this.getAllTabInfos(e);return Object.keys(t).find(r=>t[r].isMain)}isMainTabExists(e){return this.getMainTabId(e)?Promise.resolve(!0):Promise.resolve(!1)}clearAllTabs(e){let t=this.getAllTabInfos(e);this.sessionTabs[e].tabCount=0,Object.keys(t).forEach(r=>this.removeTabInfo(e,r))}clearNonMainTabs(e){let t=this.getAllTabInfos(e);Object.keys(t).filter(r=>!t[r].isMain).forEach(r=>this.removeTabInfo(e,r)),this.sessionTabs[e].tabCount=1}switchTab(e,t,{forceSwitch:r=!1}={}){let n=this.sessionTabs[t]?this.sessionTabs[t].tabCount:1;return typeof n=="number"&&n>1||r?this.driver.switchTab(e):Promise.resolve()}getTabDetails(e,t,r={}){return this.switchTab(e,t,r).then(()=>{if(r.skipLoadInfo)return{title:"",url:""};let n=Promise.resolve("unknown");return r.checkForMainTab&&(n=this.driver.executeJS("return window.__isMainTestimTab").then(o=>o.value)),Promise.all([this.driver.getTitle(),this.driver.getUrl(),n]).then(([o,i,a])=>({title:o,url:i,isMainTab:a}),o=>(Li.error("failed to get url or title",{err:o}),{title:"",url:""}))}).catch(n=>{Li.error("failed to switch to tab",{tabId:e,err:n})})}async getUnregisteredTabId(e){return(await this.driver.getTabIds()).find(r=>!this.getAllTabIds(e).includes(r))}async waitForTabToOpen(e){let t=await this.getUnregisteredTabId(e);return t||(await se(500),await this.waitForTabToOpen(e))}async tryToAddTab(e,t){if(this.pendingTabs[e])return;let r=await this.getUnregisteredTabId(e);r&&(await this.addNewTab(e,r),await this.addFrameHandler(r),this.sessionTabs[e].currentTab=null)}addNewPopup(e,t){let r=this.getAllTabInfos(e);return Object.keys(r).find(o=>r[o].openerStepId===t)?Promise.resolve():this.pendingTabs[e]?(Li.info(`overriding opener step id from ${this.pendingTabs[e]} to ${t}`),this.pendingTabs[e]=t,Promise.resolve()):(this.pendingTabs[e]=t,this.waitForTabToOpen(e).then(o=>this.addNewTab(e,o,this.pendingTabs[e]).then(()=>this.addFrameHandler(o)).then(()=>delete this.pendingTabs[e]).then(()=>this.sessionTabs[e].currentTab=null)))}waitToPendingTabs(e,t){let n=3e3,o=this;return t?new Promise(i=>{function a(){o.pendingTabs[e]===t&&n-500>0?(n-=500,setTimeout(a,500)):i()}a()}):Promise.resolve()}isMainTabIncognito(){return Promise.resolve(!1)}isInvalidStepVersion(e){let t=Fh.lt(e._version||e.version,"1.2.0"),r=!!e.parameterValues,n=r&&e.parameterValues.some(o=>o.type==="locate"&&!o.frameLocators);return t&&(!r||n)}getTabIdByTabInfo(e,t){var i,a;let{tabMatcher:r,commonConstants:n}=re();if(this.isInvalidStepVersion(t))return Promise.reject({success:!1,shouldRetry:!1,errorType:n.stepResult.INVALID_TEST_VERSION});if((i=t.useCurrentTab)!=null&&i.call(t))return this.driver.getCurrentTabId().then(c=>{if(c)return c;let l=this.getMainTabId(e);if(l)return l;throw new Error("Current tab not found")});let o=(a=t.tabInfo)==null?void 0:a.openerStepId;return this.waitToPendingTabs(e,o).then(()=>{let c;if(r){let l=this.getAllTabIds(e).map(d=>Object.assign({},this.getTabInfo(e,d),{tabId:d})).filter(d=>!d.isClosed);c=r.matchTabs(t,l)}else{let l=t.tabInfo;l?c=this.getAllTabIds(e).find(d=>{let m=this.getTabInfo(e,d);return this.isSameTab(e,m,l)}):c=this.getMainTabId(e)}return c?this.sessionTabs[e].currentTab===c?c:this.switchTab(c,e).then(()=>(this.sessionTabs[e].currentTab=c,c)).catch(l=>{let d=["no such window","no window found","the window could not be found"];if(l.message&&d.some(m=>l.message.toLowerCase().includes(m)))return this.sessionTabs[e].tabCount--,this.sessionTabs[e].tabInfos[c].isClosed=!0,this.getTabIdByTabInfo(e,t);throw l}):this.tryToAddTab(e,o).then(()=>{throw new Error("No tab ID found")})})}}});var _u,Di,Ou=w(()=>{"use strict";_u=class{constructor(){}select(){return console.log(`
			internal error - cant use port selector in selenium!!!!
`),Promise.reject({reason:"cant use port selector in selenium!"})}prepare(){}handleLegacyDataCaching(){}},Di=new _u});var _s,Lu=w(()=>{"use strict";Pu();Ee();_s=class{constructor(e,t){this.driver=e,this._abortedSteps=[],this.cookieUtils=t||new Cs(this.driver)}get sessionPlayerInit(){return re()}getTimeStamp(){return Date.now()}getTestimId(e){if(!e)return;let{locatorBuilderUtils:t}=this.sessionPlayerInit,r=t.TESTIM_ID_FIELD_NAME;return t.isEmptyResult(e)?t.EMPTY_RESULT_ID:e.getAttribute(r)}resetAbort(){this._abortedSteps=[]}abort(e){this._abortedSteps.push(e)}get abortedSteps(){return this._abortedSteps}restoreNativeAlerts(){}executeOverloadNativeAlertsInFrame(){}getClickOffset(e,t){let{utils:r}=this.sessionPlayerInit;return e&&r.isWithinBounds(0,t.width,e.x)&&r.isWithinBounds(0,t.height,e.y)?{xOffset:e.x,yOffset:e.y}:{xOffset:t.width/2,yOffset:t.height/2}}executeInAut(e,t){return this.driver.executeJS(t).then(r=>r.value)}extractTargetText(e){return this.driver.getTargetText(e)}extractText(e){return this.driver.getElementTextJS(e)}async markDynamicParent(e,t,r){return this.driver.markDynamicParent(e,t,r)}getCookie(e){return this.cookieUtils.get({name:e}).then(t=>t?[t]:[])}setCookie(e,t){return this.cookieUtils.set(e).then(r=>[r])}getNextDynamicParent(e,t){let r=`return ${this.sessionPlayerInit.codeSnippets.getNextDynamicParent(t)}`;return this.driver.executeJS(r).then(n=>n.value)}}});function Bh(s){class e{constructor(r,n){this.frameManager=r,this.locateElementPlayer=n,this._cache={}}cacheResults(r,n){this._cache[r]=n}getResultsFromCache(r){return this._cache[r]}cacheFrameLocateResults(r){if(r!=null&&r.seleniumFrameElement&&r.frameLocateResultUrl){let n=jh(r.seleniumFrameElement);n&&this.cacheResults(n,r.frameLocateResultUrl)}}async foundFrameCallback(r,n,o){let{frameOffset:i,locatedElement:a}=r,{locatorBuilderUtils:c}=re();if(c.isEmptyResult(a)){let p="got empty result in frame result, not rejected from locate element player";throw AE.error(p),new Error(p)}let l=await s.switchToLocatedFrame(a),d=jh(l.value),m=this.getResultsFromCache(d);return{frameId:-1,frameOffset:i,tabInfo:n.tabInfo,tabId:n.tabId,testimFrameId:o,testimFullFrameId:`${this.currentFrameHandler.testimFullFrameId}-${o}`,seleniumFrameElement:l.value,frameLocateResultUrl:m}}locate(r,n,o,i,a,c){let l=new this.locateElementPlayer(i);return r.targetId=`frameLocator_${n}`,l.locate(r,o,r.targetId).then(d=>(d.isVisible=!0,l.handleLocateResult(d,c,r).catch(()=>{throw new Error}))).then(d=>{let{locatedElement:m}=i.data[r.targetId];return s.getElementLocationWithPadding(m).then(p=>{let f=p.value||{top:0,left:0};return d.frameOffset={top:o.frameOffset.top+f.top,left:o.frameOffset.left+f.left},d})}).then(d=>(l.addFrameDataToContext&&l.addFrameDataToContext(d.targetId,d.locateResult),this.foundFrameCallback(d,a,r.testimFrameId))).then(d=>(this.currentFrameHandler=d,d))}async findFrame(r,n,o,i){let a=M.flags.enableFrameSwitchOptimization.isEnabled(),l=o.playback.resultsHandler.resultsByChronologicOrder.at(-1),d=1,m=Boolean(l)&&l.stepId===r.id&&l.results.length>d;if(a&&!m&&this.currentFrameHandler){let y=n.findIndex(T=>T.testimFrameId===this.currentFrameHandler.testimFrameId);if(y>-1){let T=n.slice(y+1),C=0;for(let b of T)C++,this.currentFrameHandler=await this.locate(b,C,this.currentFrameHandler,o,i,r);return this.currentFrameHandler}}let p=await i.getTopFrameHandler();p.frameOffset={top:0,left:0},await(a&&this.currentFrameHandler===p?this.currentFrameHandler:s.switchToTopFrame()),this.cacheFrameLocateResults(this.currentFrameHandler),this.currentFrameHandler=p;let h=0,g=p;for(let y of n)h++,g=await this.locate(y,h,g,o,i,r);return g}}return e}var AE,kE,_E,jh,$h=w(()=>{"use strict";j();ye();Ee();AE=R("frame-locator"),kE="ELEMENT",_E="element-6066-11e4-a52e-4f735466cecf",jh=s=>s?s[kE]||s[_E]:null});var Mi,Nu=w(()=>{"use strict";le();Mi=()=>{try{if(Gd)return!1;if(require("inspector").url())return!0}catch{}return!1}});var Du,Wh,Br,OE,Mu,$e,Ln=w(()=>{"use strict";U();xt();Du=E(require("ws")),Wh=require("events");j();le();Br=R("socket-ng-service"),OE=5e3,Mu=class extends Wh.EventEmitter{constructor(){super(...arguments);this.clientId=z();this.ws=null;this.filterMap={};this.listeners={}}onReconnect(t){Br.info("test result websocket re-connect"),setTimeout(()=>this.connect(t),OE)}formatUrl(t){return t.startsWith("http://")?t.replace("http://","ws://"):t.startsWith("https://")?t.replace("https://","wss://"):t}parseEvent(t){try{return JSON.parse(t)}catch(r){Br.error("failed to parse or trigger event",{err:r})}}connect(t){let r=this.formatUrl(Vd);return Xt().then(n=>new Promise(o=>{let i={...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};this.ws=new Du.default(`${r}?projectId=${t}&clientId=${this.clientId}&token=${n}`,i),this.ws.on("open",()=>{var a;return Br.info("websocket opened"),this.reSendAllExistingFilters(),(a=this.onConnect)==null||a.call(this),o()}),this.ws.on("close",a=>{Br.info("websocket closed",{event:a}),(!this.ws||this.ws.readyState===Du.default.CLOSED)&&this.onReconnect(t)}),this.ws.on("error",a=>{Br.info("websocket error",{event:a})}),this.ws.on("message",a=>{let c=this.parseEvent(a);c!=null&&c.type&&this.emit(c.type,c.data)})}))}sendMessage(t){if(!this.ws){Br.warn("tried to send error when websocket was disconnected");return}try{this.ws.send(JSON.stringify(t))}catch(r){Br.error("failed to stringify message for sending",{err:r})}}listenOnce(t,r,n){let o=i=>{r(i)&&(n(i),this.removeListener(t,o))};this.on(t,o)}listenTo(t,r,n,o){function i(c){n(c)&&o(c)}(Array.isArray(r)?r:[r]).forEach(c=>{var d,m;(d=this.listeners)[m=`${t}:${c}`]||(d[m]=[]);let l=i.bind(this);this.listeners[`${t}:${c}`].push(l),this.on(c,l)})}reSendAllExistingFilters(){Object.keys(this.filterMap).forEach(t=>{let r=this.filterMap[t];this.sendMessage({type:"add-filter",filter:r})})}addFilter(t,r,n,o=!1){return new Promise(i=>{let a=z(),c={query:r,id:a,type:n,fullDocument:o};this.listenOnce("add-filter:done",l=>l.id===a,i),this.sendMessage({type:"add-filter",filter:c}),this.filterMap[t]=c})}removeListeners(t,r){Object.keys(this.listeners).length!==0&&r.forEach(n=>{let o=this.listeners[`${t}:${n}`];o&&(delete this.listeners[`${t}:${n}`],o.forEach(i=>this.removeListener(n,i)))})}removeFilter(t,r){let n=this.filterMap[t];if(!n)return;let o=Array.isArray(r)?r:[r];this.removeListeners(t,o),delete this.filterMap[t],this.sendMessage({type:"remove-filter",filter:n})}},$e=new Mu});var Vh,Fu,LE,NE,DE,Gh,Fi,cr,Ui=w(()=>{"use strict";Vh=E(require("p-retry")),Fu=E(require("socket.io-client"));le();U();j();LE=50,NE=10,DE=5e3,Gh=10*1e3,Fi=R("base socket service"),cr=class{constructor(){this.attempts=0;this.rooms={};this.emitPromiseQueue=void 0}joinToMultipleResults(){let e=Object.keys(this.rooms);Fi.info("re-join all existing rooms",{testResultIds:e}),e.forEach(t=>{var n;let r=this.rooms[t];(n=this.emitJoinRoom)==null||n.call(this,t,r)})}joinRoom(e,t){this.rooms[e]=t}leaveRoom(e){delete this.rooms[e]}addSocketHandlers(){let e=(t,r)=>{let n="websocket";try{n=this._socket.io.engine.transport.name}catch{}Fi.error(`Error in SocketService websocket _${t}_ socket ${this._socket.id} is ${this.url} over ${n}. Reconnect attempts ${this.attempts}. Error is: ${r==null?void 0:r.message}`)};this._socket.on("reconnect_attempt",t=>{if(e("reconnect_attempt",{message:"reconnect attempt",attempt:t}),this.attempts++,this.attempts===NE&&!this.isAllowedWS&&(this._socket.io.opts.transports=["polling"],this._socket.io.opts.upgrade=!1),this.attempts>=LE)throw new Error(`Can't connect to Testim Servers.
Action required: Please allow opening a websockets connection to ${ge} in your firewall/proxy`)}),this._socket.on("connect_error",t=>{e("connect_error",t)}),this._socket.on("connect_timeout",t=>{e("connect_timeout",t)}),this._socket.on("error",t=>{e("error",t)}),this._socket.on("reconnect_error",t=>{this.prevErr&&this.prevErr.type===t.type||(this.prevErr=t,e("reconnect_error",t))}),this._socket.on("reconnect",()=>{Fi.info("reconnect to socket and re-join to rooms"),this.joinToMultipleResults()}),this._socket.on("connect",()=>{var t;this.attempts=0,this.isAllowedWS===void 0&&(this.isAllowedWS=this._socket.io.engine.transport&&this._socket.io.engine.transport.name==="websocket"),(t=this.onConnect)==null||t.call(this)})}initNewSocket(e,t){let r={query:{projectId:e},requestTimeout:Gh,transports:["websocket"],upgrade:!1,forceNew:!0,rejectUnauthorized:process.env.NODE_TLS_REJECT_UNAUTHORIZED!=="0",...global.caFileContent&&{ca:global.caFileContent},...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};return new Promise(n=>{this.url=`${ge}/${t}`,this._socket=Fu.connect(this.url,r),this.addSocketHandlers(),this._socket.on("connect",n),this._socket.open()})}init(e,t){let r={query:{projectId:e},requestTimeout:Gh,transports:["websocket"],upgrade:!1,rejectUnauthorized:process.env.NODE_TLS_REJECT_UNAUTHORIZED!=="0",...global.caFileContent&&{ca:global.caFileContent},...global.proxyUri&&{agent:new global.ProxyAgent(global.proxyUri)}};this.url=`${ge}/${t}`,this._socket=Fu.connect(this.url,r),this.addSocketHandlers()}emitPromise(e,t){let r={},n=()=>new Promise((o,i)=>{this._socket.emit(e,t,a=>a!=null&&a.success?o():(r[e]=t,i(new Error("bad ack"))))});return this.emitPromiseQueue=(this.emitPromiseQueue||Promise.resolve()).then(()=>(0,Vh.default)(()=>te(n(),DE),{retries:200,minTimeout:3e3,factor:1})).finally(()=>{Object.keys(r).length>0&&Fi.error("Bad acknowledge from socket emit",{errorneousEvents:r})}),this.emitPromiseQueue}}});var Uu,$r,qh=w(()=>{"use strict";Ui();Uu=class extends cr{constructor(){super(...arguments);this.listerers={}}init(t){super.init(t,"testResult"),this.listerers={}}listenToTestResult(t,r,n){this.listerers[t]&&(this._socket.off("testResult:updated",this.listerers[t]),delete this.listerers[t]),this.listerers[t]=o=>{o.resultId===t&&o.testId===r&&n(o.testResult)},this._socket.on("testResult:updated",this.listerers[t])}emitJoinRoom(t,r){return this.emitPromise("testResult:join",{resultId:t,testId:r})}async joinToTestResult(t,r){this.rooms[t]||(this.joinRoom(t,r),await this.emitJoinRoom(t,r))}emitLeaveRoom(t,r){return this.emitPromise("testResult:leave",{resultId:t,testId:r})}leaveTestResult(t,r){return this.listerers[t]?(this.leaveRoom(t),this._socket.off("testResult:updated",this.listerers[t]),delete this.listerers[t],this.emitLeaveRoom(t,r)):Promise.resolve()}getSocket(){return this._socket}},$r=new Uu});var zh={};W(zh,{testResultService:()=>Qe});var Hh,ju,Qe,Os=w(()=>{"use strict";Hh=require("events");Ln();ae();ye();qh();ju=class extends Hh.EventEmitter{init(e){if(M.flags.useNewWSCLI.isEnabled()){$e.onConnect=()=>this.emit("socket-connected");return}$r.init(e),$r.onConnect=()=>this.emit("socket-connected")}joinToTestResult(e,t){return M.flags.useNewWSCLI.isEnabled()?$e.addFilter(`${e}:testResult`,{resultId:e,testId:t},[rt.TEST_RESULT_UPDATED,rt.TEST_RESULT_CREATED]):$r.joinToTestResult(e,t)}async leaveTestResult(e,t){if(M.flags.useNewWSCLI.isEnabled()){$e.removeFilter(`${e}:testResult`,[rt.TEST_RESULT_UPDATED,rt.TEST_RESULT_CREATED]);return}await $r.leaveTestResult(e,t)}listenToTestResult(e,t,r){if(M.flags.useNewWSCLI.isEnabled()){$e.listenTo(`${e}:testResult`,[rt.TEST_RESULT_UPDATED,rt.TEST_RESULT_CREATED],n=>n.resultId===e&&n.testId===t,n=>r(n));return}$r.listenToTestResult(e,t,r)}getSocket(){if(!M.flags.useNewWSCLI.isEnabled())return $r.getSocket()}},Qe=new ju});var $,ce=w(()=>{"use strict";Ee();$=class{constructor(e,t,r,n={},o=void 0,i=void 0,a={}){this.step=e,this.context=t,this.frameHandler=r,this.frameId=0,this.stepActionUtils=o,this.locateElementPlayer=i,this.exportsGlobal=n,this.exportsTest=a}get driver(){return this.stepActionUtils.driver}get sessionPlayerInit(){return re()}async performAction(){throw new Error("not implemented")}getTarget(){let e=this.step.targetId||"targetId";return this.context.data[e]}async execute(e,t){var r;try{return{success:!0,...await this.performAction(e,t)}}catch(n){let o=(n==null?void 0:n.message)||((r=n==null?void 0:n.seleniumStack)==null?void 0:r.message),i=n==null?void 0:n.displayMessage;return{success:!1,reason:o,exception:n,errorType:this.sessionPlayerInit.commonConstants.stepResult.ACTION_EXCEPTION,resultInfo:{exception:`selenium exception: ${o}`,error:i||o}}}}}});function FE(s){return{getFrameIdByTestimFrameId(){},async setElementResultDataOnContext(e){let t=await s.getElement(e.locatedElement);e.seleniumElement=t.value},getElementRectangle(e){return s.getElementRect(e)},getOffsets(e){return Promise.resolve([e.frameOffset||{}])},htmlStringToDom(e,t,r,n,o=!0){let i=new ji.VirtualConsole,a=new ji.JSDOM(e,{virtualConsole:i}),{window:c}=a;return o&&setTimeout(()=>{c.close()},1e3*60),Object.assign(c.document,{TESTIM_URL:t})},shouldUseNativeVisibilityCheck(e,t,r,n){return e.opacity===0||e.isShadowed?!1:r===void 0||n===void 0?!0:M.flags.useClickimVisibilityChecks.isEnabled()?!1:t.isSafari()?M.flags.useSafariWebdriverVisibilityChecks.isEnabled():!0},async isVisible(e,t,r,n,o,i,a){let{locatorBuilderUtils:c,codeSnippets:l,visibilityUtils:d,positionUtils:m}=re();if(this.shouldUseNativeVisibilityCheck(n,s,d,m))return s.isVisible(e.seleniumElement);if(!e.seleniumElement)return{visible:!1,invisibleReason:"element not found"};try{await s.isVisible(e.seleniumElement)}catch{}if(!t||c.isEmptyResult(t))return{visible:!1,invisibleReason:"element not found"};let h=[m.calculateElementMiddlePoint(r),m.calculateClickPoint(n.clickOffset,r)].filter(Boolean),g=l.getVisibilityCode.getCompoundVisibilityInfoCode(e.locatedElement,h,!1,n),y;try{y=await s.execute(`return ${g}`)}catch(x){throw Wr.error("failed to execute getVisibilityCode",{err:x}),x}let{value:T}=y||{},C=T.elementVisibilityInfo||ME,[b,v]=T.elementsFromPointResults||[null,null];return d.checkElementVisibility(C,n,v,b,a,t)},scrollToElement(e,t){let{codeSnippets:r}=re(),n=r.scrollToElement;return s.execute(n(t))}}}var ji,Wr,ME,Nn,Kh=w(()=>{"use strict";ji=require("jsdom");ce();j();ye();Ee();Wr=R("locate-step-action"),ME={opacity:1,clientRects:{}};Nn=class extends ${execute(){return this.driver.getHTML(this.step)}static getUtils(e){return Object.assign(FE(e),{useLocatedElement:!0})}static getFrameIdByTestimFrameId(...e){throw Wr.warn("Unplanned access to getFrameIdByTestimFrameId()"),new Error("Use .getUtils() instead")}static setElementResultDataOnContext(...e){throw Wr.warn("Unplanned access to setElementResultDataOnContext()"),new Error("Use .getUtils() instead")}static getElementRectangle(...e){throw Wr.warn("Unplanned access to getElementRectangle()"),new Error("Use .getUtils() instead")}static getOffsets(...e){throw Wr.warn("Unplanned access to getOffsets()"),new Error("Use .getUtils() instead")}static htmlStringToDom(...e){throw Wr.warn("Unplanned access to htmlStringToDom()"),new Error("Use .getUtils() instead")}static isVisible(...e){throw Wr.warn("Unplanned access to isVisible()"),new Error("Use .getUtils() instead")}}});var Jh,Yh=w(()=>{"use strict";Jh=function(s,e,t,r,n,o,i,a){function c(T,C){if(!C)return{success:!1};elementScrollTo(C,T.x,T.y);let b=C.scrollLeft,v=C.scrollTop;return{success:Math.abs(v-T.y)<1&&Math.abs(b-T.x)<1,actualX:b,actualY:v}}function l(T,C,b,v,x,k,D){if(!b)return{x:v,y:x};let S=getLocatedElement(C);if(r&&!S)return{x:T.scrollWidth,y:T.scrollHeight};if(!S)throw new Error("could not find target element");let O=S.getBoundingClientRect(),P=0,N=0,B=Math.max(window.innerHeight-(O.height+10),0),V=Math.max(window.innerWidth-(O.width+10),0);return P=D?T.scrollTop+O.top-Math.min(x,B):T.scrollTop,N=k?T.scrollLeft+O.left-Math.min(v,V):T.scrollLeft,{x:Math.round(N),y:Math.round(P)}}let d=!s;if(s=d?document.scrollingElement||document.documentElement:getLocatedElement(s),!s)throw new Error("could not find target to scroll on");let m={top:s.scrollTop,left:s.scrollLeft},p=l(s,e,t,n,o,i,a),f=c(p,s);d&&!document.scrollingElement&&!f.success&&m.top===s.scrollTop&&m.left===s.scrollLeft&&(s=document.body,p=l(s,e,t,n,o,i,a),f=c(p,s));let h=f.actualX,g=f.actualY,y=getLocatedElement(e);if(t&&r&&!y)return{success:!1,expectedPosition:p};if(t){if(!y)throw new Error("could not find target to scroll to");let T=y.getBoundingClientRect();h=T.left,g=T.top}return{success:f.success,actualX:h,actualY:g}}});var Bi,Xh=w(()=>{"use strict";Yh();ce();Bi=class extends ${getFailureString(e,t,r,n,o){if(!e.isScrollToElement)return`Scrolling limit reached. Expected:(y: ${r}, x: ${t}); Actual:(y:${o}, x: ${n})`;let i="Scrolling limit reached";return e.shouldScrollTop&&(i+=`. Expected top margin: ${r}, actual: ${o}`),e.shouldScrollLeft&&(i+=`. Expected left margin: ${t}, actual: ${n}`),i}async scroll(e,t,r){let{codeSnippets:n,commonConstants:{stepResult:o}}=this.sessionPlayerInit,i=Math.round(Number(t.isScrollToElement?t.marginTop:t.y)),a=Math.round(Number(t.isScrollToElement?t.marginLeft:t.x)),c=this.driver.isFirefox()?function(d,m,p){d.scrollTo(m,p)}:function(d,m,p){d.scrollTop=p,d.scrollLeft=m},l=`
            var getLocatedElement = ${n.getLocatedElementCode};
            var elementScrollTo = ${c.toString()};
            var scroll = ${Jh.toString()};
            return scroll.apply(null, arguments)
        `;try{let d=await this.driver.executeJSWithArray(l,[r,e,Boolean(t.isScrollToElement),Boolean(t.isDynamicScroll),a,i,t.shouldScrollLeft,t.shouldScrollTop]);if(!(d!=null&&d.value))return{errorType:o.SCROLL_ACTION_FAILURE,success:!1};let{success:m,actualX:p,actualY:f}=d.value;return m?{success:!0}:{errorType:o.SCROLL_ACTION_FAILURE,success:!1,resultInfo:{error:this.getFailureString(t,a,i,p,f)}}}catch{return{errorType:o.SCROLL_ACTION_FAILURE,success:!1}}}scrollOnDocument(e,t){return this.scroll(t,e)}scrollOnElement(e,t){return this.scroll(t,e,this.getTarget().locatedElement)}execute(){let e=this.context,t=this.step,r=t.isScrollToElement?e.data.scrollToElement.locatedElement:null;return t.element.isDocument?this.scrollOnDocument(t,r):this.scrollOnElement(t,r)}}});var Qh,Zh=w(()=>{"use strict";Qh=function(s){let e={};function t(a){return a!=null&&a.toLowerCase?(a=a.toLowerCase(),a==="text"?"text/plain":a==="url"?"text/uri-list":a):a}let r={data:{},setData(a,c){e[t(a)]=c},getData(a){return e[t(a)]}},n=getLocatedElement(s.fromLocatedElement),o=getLocatedElement(s.toLocatedElement);if(!n)throw new Error("from element not found");if(!o)throw new Error("to element not found");let i=function(a,c){let l=document.createEvent("CustomEvent");l.initCustomEvent(c,!0,!0,null),l.dataTransfer=r,a.dispatchEvent?a.dispatchEvent(l):a.fireEvent&&a.fireEvent(`on${c}`,l)};i(n,"dragstart"),i(o,"drop"),i(n,"dragend")}});var eg,tg=w(()=>{"use strict";eg=(s,e)=>{let t=typeof Event=="function";window.__unloadNavigator=i,window.addEventListener("unload",window.__unloadNavigator);function r(b,v){var D;function x(S){function O(B){return o(B).find(V=>Array.apply(null,V.classList||[]).includes("Select-control"))}function P(B){let V=O(B);return V?V.querySelector("INPUT"):null}let N=P(S);N&&N.focus()}let k=(D=b.quirks)==null?void 0:D.isReactSelect;v.type==="mousedown"&&k&&x(b.element)}function n(b,v){var k;let x=(k=b.quirks)==null?void 0:k.isCKEditorFrame;v.type==="click"&&x&&document.body.focus()}function o(b){return b?[b].concat(o(b.parentNode)):[]}function i(b){let v={status:"done",result:b,success:!0};C.isNonTextableElemnet&&(v.reason="Set text on non input element"),e(v)}function a(b){b=b||{},e({status:"failed",result:b,success:!1})}function c(b){let v=t?new Event("mouseover",{composed:!0}):document.createEvent("Events");v.initEvent("mouseover",!0,!0),b.dispatchEvent(v)}function l(b){let v={},x=b.getBoundingClientRect(),k=x.left+x.width/2,D=x.top+x.height/2,P=f("mousemove",v,k,D,0);b.dispatchEvent(P)}function d(b,v){function x(P,N,B){return B>P&&B<N}let k=b.pointerPosition||{},D=v.getBoundingClientRect(),S=k.originX&&x(D.left,D.left+D.width,k.originX)?k.originX:D.left+D.width/2,O=k.originY&&x(D.top,D.top+D.height,k.originY)?k.originY:D.top+D.height/2;return{x:S,y:O}}function m(b,v,x){return{screenX:0,screenY:0,clientX:v,clientY:x,ctrlKey:Boolean(b.ctrl),altKey:Boolean(b.alt),shiftKey:Boolean(b.shift),metaKey:Boolean(b.meta),bubbles:!0,cancelable:!0,composed:!0}}function p(b,v,x,k){if(!window.PointerEvent)return;let D=m(v,x,k);return D.pointerType="mouse",D.isPrimary=!0,new window.PointerEvent(b,D)}function f(b,v,x,k,D){let S=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return S.initMouseEvent(b,!0,!0,document.defaultView,1,0,0,x,k,Boolean(v.ctrl),Boolean(v.alt),Boolean(v.shift),Boolean(v.meta),D,document.body?document.body.parentNode:document.documentElement),S}function h(b,v){let x=["pointerup","pointerdown","pointermove"],k=v.modifiers||{},D=d(b,v.element),S=v.button||0,O=b.event;return x.includes(O)?p(O,k,D.x,D.y):f(O,k,D.x,D.y,S)}function g(){var v;let b=document.activeElement;for(;(v=b.shadowRoot)!=null&&v.activeElement;)b=b.shadowRoot.activeElement;return b}function y(b){b.events.map(v=>{try{return h(v,b)}catch{return}}).filter(Boolean).forEach(v=>{b.element.dispatchEvent(v),r(b,v),n(b,v)}),window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator)}var C={element:s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),events:s.events,quirks:s.quirks,modifiers:s.modifiers,button:s.button};if(!C.element){a("element not found");return}c(C.element),l(C.element);try{y(C);let b=g(),v=C.quirks,x=v==null?void 0:v.isReactSelect,k=v==null?void 0:v.isCKEditorFrame;!x&&!k&&dispatchFocus(s.elementToFocusLocatedElement,b),i()}catch(b){a(b.toString())}}});var rg,sg=w(()=>{"use strict";rg=function(s,e){let t=typeof Event=="function",r=typeof PointerEvent=="function",n=40;window.__unloadNavigator=o,window.addEventListener("unload",window.__unloadNavigator);function o(b){e({status:"done",result:b,success:!0})}function i(b){b=b||{},e({status:"failed",result:b,success:!1})}function a(b){let v=t?new Event("mouseover",{composed:!0}):document.createEvent("Events");v.initEvent("mouseover",!0,!0),b.dispatchEvent(v)}function c(b){let v={},x=b.getBoundingClientRect(),k=x.left+x.width/2,D=x.top+x.height/2,P=p("mousemove",v,k,D,0);b.dispatchEvent(P)}function l(b,v){function x(P,N,B){return B>P&&B<N}let k=b.pointerPosition||{};if(C.isDrag)return{x:k.originX||0,y:k.originY||0};let D=v.getBoundingClientRect(),S=k.originX&&x(D.left,D.left+D.width,k.originX)?k.originX:D.left+D.width/2,O=k.originY&&x(D.top,D.top+D.height,k.originY)?k.originY:D.top+D.height/2;return{x:S,y:O}}function d(b,v,x){return{screenX:0,screenY:0,clientX:v,clientY:x,ctrlKey:Boolean(b.ctrl),altKey:Boolean(b.alt),shiftKey:Boolean(b.shift),metaKey:Boolean(b.meta),bubbles:!0,cancelable:!0,composed:!0}}function m(b,v,x,k,D){if(r){let O=d(v,x,k);return O.pointerType="mouse",O.isPrimary=!0,new window.PointerEvent(b,O)}let S=document.createEvent("PointerEvent");return S.initPointerEvent(b,!0,!0,document.defaultView,1,0,0,x,k,Boolean(v.ctrl),Boolean(v.alt),Boolean(v.shift),Boolean(v.meta),D,document.body?document.body.parentNode:document.documentElement,0,0,0,0,0,0,0,0,0,"mouse",0,!0),S}function p(b,v,x,k,D){let S=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return S.initMouseEvent(b,!0,!0,document.defaultView,1,0,0,x,k,Boolean(v.ctrl),Boolean(v.alt),Boolean(v.shift),Boolean(v.meta),D,document.body?document.body.parentNode:document.documentElement),S}function f(b,v){let x=["pointerup","pointerdown","pointermove"],k=v.modifiers||{},D=l(b,v.element),S=v.button||0,O=b.event;return x.includes(O)?m(O,k,D.x,D.y,S):p(O,k,D.x,D.y,S)}function h(b,v){function x(){return b.event==="click"&&v.isDrag&&!v.allEventsOnSameElement}return x()}function g(b,v,x){try{let k=f(v.events[b],v);h(k,v)||v.element.dispatchEvent(k)}catch{}if(b+1===v.events.length)x();else{let k=Math.min(v.events[b+1].timeStamp-v.events[b].timeStamp,n);setTimeout(()=>{g(b+1,v,x)},k)}}function y(b,v){g(0,b,()=>{window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),v()})}let C={eventIndex:0,element:s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),events:s.events,eventType:s.eventType,eventData:s.eventData,stepId:s.id,testResultId:s.testResultId,quirks:s.quirks,isDoubleClick:s.isDoubleClick,isDrag:s.isDrag,useRecordedMousedown:s.useRecordedMousedown,trackActiveElement:s.trackActiveElement,allEventsOnSameElement:s.allEventsOnSameElement};if(!C.element){i("element not found");return}a(C.element),c(C.element),y(C,()=>{o()})}});var ng,og=w(()=>{"use strict";ng=function(s,e){let t=typeof MouseEvent=="function",r=typeof DragEvent=="function",n=typeof PointerEvent=="function",o={};window.__unloadNavigator=i,window.addEventListener("unload",window.__unloadNavigator);function i(P){e({status:"done",result:P,success:!0})}function a(P){P=P||{},e({status:"failed",result:P,success:!1,keep:!0})}function c(P){return P!=null&&P.toLowerCase?(P=P.toLowerCase(),P==="text"?"text/plain":P==="url"?"text/uri-list":P):P}function l(){try{return new DataTransfer}catch{return{data:{},setData(N,B){o[c(N)]=B},getData(N){return o[c(N)]}}}}let d=["drag","dragstart","dragend"],m=["pointerup","pointerdown","pointermove"],p=d.concat(["drop","dragenter","dragover"]);function f(P){let N=P;for(;N&&N!==document.documentElement;){if(N.draggable)return N;N=N.parentElement}return null}function h(P,N,B){let V=N.element,Y=B.dispatchDragEventsOnClosestDraggable;if(d.includes(P.type)&&Y){if(!V&&N.lastDraggedElement)return N.lastDraggedElement;let Z=f(V);if(Z)return N.lastDraggedElement=Z,Z}return V}function g(P,N,B){function V(Jr,A,L){return L>Jr&&L<A}let Y=P.pointerPosition||{};if(N)return{x:Y.originX||0,y:Y.originY||0};let Z=B.getBoundingClientRect(),fe=Y.originX&&V(Z.left,Z.left+Z.width,Y.originX)?Y.originX:Z.left+Z.width/2,Ot=Y.originY&&V(Z.top,Z.top+Z.height,Y.originY)?Y.originY:Z.top+Z.height/2;return{x:fe,y:Ot}}function y(P,N,B){let V=(N==null?void 0:N.modifiers)||{},Y=g(P,B.isDrag,B.element),Z=(N==null?void 0:N.button)||0,fe=P.event;return m.includes(fe)?C(fe,V,Y.x,Y.y,Z):p.includes(fe)?v(fe,V,Y.x,Y.y,Z):b(fe,V,Y.x,Y.y,Z)}function T(P,N,B){return{screenX:0,screenY:0,clientX:N,clientY:B,ctrlKey:Boolean(P.ctrl),altKey:Boolean(P.alt),shiftKey:Boolean(P.shift),metaKey:Boolean(P.meta),bubbles:!0,cancelable:!0,composed:!0}}function C(P,N,B,V,Y){if(n){let fe=T(N,B,V);return fe.pointerType="mouse",fe.isPrimary=!0,new window.PointerEvent(P,fe)}let Z=document.createEvent("PointerEvent");return Z.initPointerEvent(P,!0,!0,document.defaultView,1,0,0,B,V,Boolean(N.ctrl),Boolean(N.alt),Boolean(N.shift),Boolean(N.meta),Y,document.body?document.body.parentNode:document.documentElement,0,0,0,0,0,0,0,0,0,"mouse",0,!0),Z}function b(P,N,B,V,Y){let Z=t?new MouseEvent("click",{composed:!0}):document.createEvent("MouseEvents");return Z.initMouseEvent(P,!0,!0,document.defaultView,1,0,0,B,V,Boolean(N.ctrl),Boolean(N.alt),Boolean(N.shift),Boolean(N.meta),Y,document.body?document.body.parentNode:document.documentElement),Z}function v(P,N,B,V){if(P==="dragstart"&&(window.TSTA||(window.TSTA={}),window.TSTA.dataTransfer=l()),!r){let fe=document.createEvent("CustomEvent");return fe.initCustomEvent(P,!0,!0,null),fe.dataTransfer=window.TSTA.dataTransfer,fe}let Y=T(N,B,V),Z=new window.DragEvent(P,Y);return Object.defineProperties(Z,{dataTransfer:{get(){return window.TSTA.dataTransfer}}}),Z}function x(P,N,B){let V=h(P,N,B);V&&V.dispatchEvent(P)}function k(P,N){function B(){return P.event==="click"&&N.isDrag&&!N.allEventsOnSameElement}return B()}function D(P,N,B){if(B){let V=Math.min(B.timeStamp-N.timeStamp,40);setTimeout(()=>{S(P)},V)}else window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),i()}function S(P){let N,B=P.events[P.eventIndex],V=P.events[++P.eventIndex];try{P.element=getLocatedElement(B.locatedElement),N=y(B,s,P)}catch(Y){return a(`exception in get event in drag step:${Y.message}`)}if(k(B,P))return D(P,B,V);if(N)try{x(N,P,B)}catch(Y){return a(`exception in executeEvent in drag step:${Y.message}`)}else return a(`cannot execute event ${B.event}`);D(P,B,V)}let O={eventIndex:0,allEventsOnSameElement:s.allEventsOnSameElement,events:s.events,eventType:s.eventType,eventData:s.eventData,stepId:s.id,testResultId:s.testResultId,isDrag:s.isDrag,useRecordedMousedown:s.useRecordedMousedown,trackActiveElement:s.trackActiveElement};setTimeout(()=>{try{S(O)}catch(P){a(P)}},0)}});var Dn,$i,ig=w(()=>{"use strict";Dn=E(require("lodash"));ce();Ci();Zh();tg();sg();ye();og();$i=class extends ${getDnDRectsAndOffsets(e,t,r,n){let o=this.stepActionUtils.getClickOffset(r,e.rectWithoutFrameOffset),i=this.stepActionUtils.getClickOffset(n,t.rectWithoutFrameOffset);return{fromRect:e.rectWithoutFrameOffset,fromX:o.xOffset,fromY:o.yOffset,toRect:t.rectWithoutFrameOffset,toX:i.xOffset,toY:i.yOffset}}async clickJs(){var c;let e=this.step,t=this.context,r=t.data[e.targetId||"targetId"],n=t.data.timeToPlayStep+3e3,o=e.events;if(!(o!=null&&o.length))return;let i={isRoot:r.isRoot,locatedElement:r.locatedElement,events:o,quirks:e.quirks,modifiers:e.modifiers,button:e.button},a=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${Mr.toString()};
            var doClick = ${eg.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return doClick.call(null, eventData, done);
        `;try{return(c=(await this.driver.executeCodeAsync(a,n,i)).value)!=null&&c.success?{success:!0}:{success:!1}}catch(l){return{success:!1,reason:l.message,exception:l}}}isWithinBounds(e,t,r){return r>e&&r<t}getEventSequenceOffset(){var c;let e=(c=this.step.events[0])==null?void 0:c.pointerPosition;if(!e)return{xOffset:0,yOffset:0};let r=this.context.data[this.step.targetId||"targetId"].rectWithoutFrameOffset,n=this.isWithinBounds(r.left,r.left+r.width,e.originX),o=this.isWithinBounds(r.top,r.top+r.height,e.originY),i=n?0:r.left+r.width/2-e.originX,a=o?0:r.top+r.height/2-e.originY;return{xOffset:i,yOffset:a}}addOffsetToEvents(e){this.step.events.forEach(t=>{t!=null&&t.pointerPosition&&(t.pointerPosition.originX+=e.xOffset,t.pointerPosition.originY+=e.yOffset)})}generateEventOfType(e,t){let r=Dn.cloneDeep(e);return r.event=t,r}fixAbsoluteDragEventSequence(){let e=this.step.events.find(o=>["mousedown","pointerdown"].includes(o.event));if(e){let o=this.step.events.indexOf(e);this.step.events.splice(o,0,this.generateEventOfType(e,"mouseover"))}let{recordPointerMoveEvents:t=!1}=this.context.project.defaults||{},r=this.step.events.find(o=>o.event==="mouseup")||t&&this.step.events.find(o=>o.event==="pointerup"),n=Dn.findLastIndex(this.step.events,o=>o.event==="mousemove")||t&&Dn.findLastIndex(this.step.events,o=>o.event==="pointermove");r&&n>0&&!this.step.allEventsOnSameElement&&this.step.events.splice(n+1,0,this.generateEventOfType(r,"mouseover")),this.step.isHTML5Drag&&!this.step.toElement&&(this.step.events=this.addDragendIfNeeded(this.step.events)),this.addOffsetToEvents(this.getEventSequenceOffset())}async dragPathJs(){var c,l;let e=this.step,t=this.context,r=t.data[e.targetId||"targetId"],n=t.data.timeToPlayStep+3e3;if(!((c=this.step.events)!=null&&c.length))return;this.fixAbsoluteDragEventSequence();let o=e.events,i={isRoot:r.isRoot,locatedElement:r.locatedElement,events:o,quirks:e.quirks,modifiers:e.modifiers,button:e.button,isDrag:!0,allEventsOnSameElement:e.allEventsOnSameElement},a=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${Mr.toString()};
            var doDragPath = ${rg.toString()};
            return doDragPath.apply(null, arguments);
        `;try{return(l=(await this.driver.executeCodeAsync(a,n,i)).value)!=null&&l.success?{success:!0}:{success:!1}}catch(d){return{success:!1,reason:d.message,exception:d}}}chooseAndRunAction(){let e=this.getTarget(),{locatedElement:t,seleniumElement:r,rectWithoutFrameOffset:n,rect:o}=e,{xOffset:i,yOffset:a}=this.stepActionUtils.getClickOffset(this.step.element.clickOffset,n),c={frameOffset:{x:o.left-n.left,y:o.top-n.top},rect:n,clickOffset:{x:i,y:a}};if(M.flags.skipFileInputClicks.isEnabled()&&e.tagName==="INPUT"&&(e.elementSymbol.includes('type="file"')||e.elementSymbol.includes("type='file'")||e.elementSymbol.includes("type=file")))return Promise.resolve({keep:!0,success:"skipped",reason:"Clicking on input type=file is disabled"});if(this.step.isDoubleClick){let p={elementToFocusLocatedElement:e.elementToFocusLocatedElement,locatedElement:t,events:this.step.events,timeout:this.context.data.timeToPlayStep+3e3};return this.driver.doubleClick(r,p,c)}if(this.step.isDrag){if(this.step.toElement){let p=this.context.data.toElement;if(this.step.isHTML5Drag){if(M.flags.usePortedHtml5DragDrop.isEnabled()){let y=this.generateHTML5DragEventSequence(),T=this.context.data.timeToPlayStep+3e3,C=this.context.data[this.step.targetId||"targetId"],b={transactionId:`${this.context.testResultId}:${this.step.id}`,id:this.step.id,testResultId:this.context.testResultId,eventType:this.step.type,events:y,eventData:{modifiers:this.step.modifiers,button:this.step.button},quirks:this.step.quirks,isDrag:this.step.isDrag,useRecordedMousedown:this.step.useRecordedMousedown,allEventsOnSameElement:this.step.allEventsOnSameElement,elementToFocusLocatedElement:C.elementToFocusLocatedElement,trackActiveElement:this.step.trackActiveElement,locatedElement:C.locatedElement,isRoot:C.isRoot},v=`
                        var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                        var dnd = ${ng.toString()};
                        var eventData = arguments[0];
                        var done = arguments[1];
                        return dnd.call(null, eventData, done);
                    `;return this.driver.executeCodeAsync(v,T,b)}let h=`
                        var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                        var dnd = ${Qh.toString()};
                        var eventData = arguments[0];
                        return dnd.call(null, eventData);
                    `,g={fromLocatedElement:t,toLocatedElement:p.locatedElement};return this.driver.executeJS(h,g)}let f=this.getDnDRectsAndOffsets(e,p,this.step.element.clickOffset,this.step.toElement.clickOffset);return this.driver.dragAndDrop(r,p.seleniumElement,f)}return this.dragPathJs()}let d=this.driver.isSafari()&&this.step.button===2,m=this.driver.isSafari()&&e.tagName==="SELECT";return this.driver.isSafari()&&m?Promise.resolve({keep:!0,success:"skipped",forceTreatAsWarning:!0,reason:"Safari does not support clicking on select elements"}):!m&&(!this.step.nativeEvents||d)?this.clickJs():this.step.button===2?this.driver.rightClick(r,c):this.driver.leftClick(r,c)}async performAction(){let e=await this.chooseAndRunAction();if(!e.status&&e.value&&e.value.keep&&(e=e.value),e.keep)return delete e.keep,e}addDragendIfNeeded(e){if(e.some(r=>r.event==="dragend"))return e;let t={event:"dragend",eventInfo:{detail:0},pointerPosition:this.getToElementPosition()};return e.concat(t)}getToElementPosition(){var t,r;if(!((r=(t=this.context.data)==null?void 0:t.toElement)!=null&&r.rect))return;let{rect:e}=this.context.data.toElement;return{originX:e.left+e.width/2,originY:e.top+e.height/2}}addDragOverBeforeDragEnd(e){let t=e.findIndex(n=>["dragend","drop"].includes(n.event)),r=e[t-1];if(!r||r.event!=="dragover"){let n={event:"dragover",eventInfo:{detail:0},pointerPosition:this.getToElementPosition(),fireOnTarget:!0};e.splice(t,0,n)}else r.fireOnTarget=!0;return e}fixEventSequence(e){let t=this.addDragendIfNeeded(e);return this.addDragOverBeforeDragEnd(t)}addElementLocatedElementToDragEvents(e,t,r){let n=o=>o.fireOnTarget||["drop","dragenter"].includes(o.event);return e.forEach(o=>o.locatedElement=n(o)?r:t),e}generateHTML5DragEventSequence(){let e=this.context.data.targetId,t=this.context.data.toElement,r=this.step.events.filter(n=>n.event!=="mousemove"&&n.event!=="pointermove");return r=this.fixEventSequence(r),r=this.addElementLocatedElementToDragEvents(r,e.locatedElement,t.locatedElement),this.step.dispatchDragEventsOnClosestDraggable&&r.forEach(n=>n.dispatchDragEventsOnClosestDraggable=!0),r}}});var Mn,ag=w(()=>{"use strict";ce();Mn=class extends ${async performAction(e){let{step:t,context:r,frameHandler:n,sessionPlayerInit:{paramEvaluator:o,utils:i,commonConstants:a}}=this,c=this.getTarget();try{let l=await this.stepActionUtils.extractTargetText(c),d,m;if(o){let p=o.computeExpression(t.expression2,r,this.exportsGlobal,this.exportsTest);d=l,m=p.evaluatedText}else{let p=await e.executeStep(t.expression2,r,n,this.exportsGlobal,this.locateElementPlayer,this.exportsTest);d=l,m=p.evaluatedText}try{return i.compareOrMatch(m,d)?{success:!0}:{success:!1,errorType:a.stepResult.TEXT_COMPARE_FAILURE,resultInfo:{expected:String(m),actual:d}}}catch{return{success:!1,errorType:a.stepResult.TEXT_COMPARE_FAILURE,resultInfo:{expected:m.toString(),actual:d}}}}catch(l){return{success:!1,reason:l.message,exception:l,shouldRetry:!0}}}}});var cg,UE,Wi,lg=w(()=>{"use strict";cg=E(require("lodash"));ce();j();UE=R("evaluate-expression-step-action"),Wi=class extends ${async execute(){let e=this.step,t=this.context,r=this.exportsGlobal,n=this.exportsTest;try{UE.info("runner running incoming params evaluation");let o=t.incomingParams||{};cg.isEmpty(o)&&(o=this.sessionPlayerInit.stepParamBuilder.getStepInputs(e,t,r,n));let i=["context",...o.as.functionParameters],a=[t,...o.as.functionArguments],l=`return ${e.subType==="text"?`'${e.expression.replace(/'/g,"\\'")}'`:e.expression}`.replace(/\n/g,"\\n"),m=Function.apply(Function,i.concat([l])).apply(null,a);return t.data[e.targetName]=m,t.data[e.targetId]=m,t.internalParams&&t.internalParams.add(e.targetId),{success:!0,evaluatedText:m,data:t.data}}catch(o){let{stepResult:i}=this.sessionPlayerInit.commonConstants;throw{errorType:i.EVALUATE_EXPRESSION_EXCEPTION,resultInfo:{exception:o.toString()},success:!1}}}}});var ug,dg=w(()=>{"use strict";ug=function(s,e){let t=typeof Event=="function",r=s.isRoot?document.documentElement:getLocatedElement(s.locatedElement),n={eventIndex:0,element:r,events:s.events,eventType:s.eventType,quirks:s.quirks};if(!r)throw new Error("element not found");window.__unloadNavigator=function(){fe()},window.addEventListener("unload",window.__unloadNavigator);let o=["keydown","keyup","keypress"],i=15;function a(A){try{if(!t)return;let L=new CustomEvent("textInput",{bubbles:!0,cancelable:!0});return A.eventData&&(L.data=A.eventData.data),L}catch{}}function c(A){try{let L=document.createEvent("TextEvent");L.data=A.eventData.data;let F=1,G=A.eventData.locale||"en-US";return L.initTextEvent("textInput",!0,!0,window,A.eventData.data,F,G),L}catch{}}function l(A){return a(A)||c()}function d(A,L,F){try{return new KeyboardEvent(A,{bubbles:!0,cancelable:!0,location:L.location||0,key:L.key||"",ctrlKey:Boolean(F.ctrl),shiftKey:Boolean(F.shift),altKey:Boolean(F.alt),metaKey:Boolean(F.meta)})}catch{}}function m(A,L,F){try{let G=document.createEvent("KeyboardEvent");return G.initKeyEvent(A,!0,!0,null,Boolean(F.ctrl),Boolean(F.alt),Boolean(F.shift),Boolean(F.meta),L.key||"",0),G}catch{}}function p(A,L,F){try{let G=document.createEvent("Events");return G.initEvent(A,!0,!0),G.altKey=Boolean(F.alt),G.ctrlKey=Boolean(F.ctrl),G.metaKey=Boolean(F.meta),G.shiftKey=Boolean(F.shift),G.keyCode=L.key||"",G}catch{}}function f(A,L,F){return d(A,L,F)||m(A,L,F)||p(A,L,F)}function h(A){let L=o.indexOf(A.event);if(typeof L!="number"||L<0)return null;let F=A.eventData,G=F.modifiers||{},me=f(A.event,F,G);return Object.defineProperties(me,{keyCode:{enumerable:!0,get(){return this._keyCode_}},charCode:{enumerable:!0,get(){return this._charCode_}},which:{enumerable:!0,get(){return this._keyCode_}}}),me._keyCode_=F.keyCode,me._charCode_=F.charCode||0,me}function g(A){return A.event==="textInput"?l(A):h(A)}function y(A,L){return function(){var G;return A.event==="textInput"&&!((G=L.quirks)!=null&&G.isAuth0Form)}()}function T(A,L){return A.event==="keyup"&&L.event==="keydown"?i:0}function C(A,L,F){let G=T(L,F);return Math.min(F.timeStamp-L.timeStamp,G)}function b(A){let L=Object.getOwnPropertyDescriptor(A,"value");if(!L)return;let F=A.value;A.value=`${F}#`,L.configurable&&delete A.value,A.value=F;let G=document.createEvent("HTMLEvents");G.initEvent("input",!0,!1),A.dispatchEvent(G),Object.defineProperty(A,"value",L)}function v(A){if(A.isInput)try{if(b(A.element),t)A.element.dispatchEvent(new Event("change"));else{let L=document.createEvent("HTMLEvents");L.initEvent("change",!1,!0),A.element.dispatchEvent(L)}}catch{}}function x(A,L,F){F?setTimeout(()=>{N(A)},C(A,L,F)):(window.__unloadNavigator&&window.removeEventListener("unload",window.__unloadNavigator),v(A),fe())}function k(A,L){return(A==="change"||A==="blur")&&L.element.tagName==="OPTION"}function D(A,L,F){return k(A.type,L)?L.element.parentElement:F.locatedElement?getLocatedElement(F.locatedElement):L.element}function S(A,L){let F=A.firstChild,G;for(;F;){if(F.nodeType===3){if(L.offset--<=0)return F}else if(F.nodeType===1&&(G=S(F,L),G))return G;F=F.nextSibling}return null}function O(A,L){if(!(!A||!L)){if(!isNaN(L.start))A.selectionStart=L.start,A.selectionEnd=L.end;else if(!isNaN(L.nodeOffset)){let F;if(A.firstChild?F=S(A,{offset:L.nodeOffset}):F=A,F){let G=window.getSelection(),me=document.createRange();try{G.removeAllRanges(),me.setStart(F,L.textOffset),me.setEnd(F,L.textOffset),G.addRange(me)}catch{}}}}}function P(A,L,F){if(L.isFocusable&&L.isSelectable(A)&&A.type!=="submit")try{O(L.element,F.eventData.selection)}catch{}let G=D(A,L,F);if(!G)throw new Error("could not find element");A.type==="submit"&&G.action?G.submit():G.dispatchEvent(A)}function N(A){let L,F=A.events[A.eventIndex],G=A.events[++A.eventIndex];try{L=g(F)}catch(me){return Ot(`exception in get event in text step:${me.message}`)}if(y(F,A))return x(A,F,G);if(L)try{P(L,A,F)}catch(me){return Ot(`exception in executeEvent in text step:${me.message}`)}else if(A.noEventExecuter)A.noEventExecuter(A,F);else return Ot(`cannot execute event ${F.event}`);x(A,F,G)}function B(A){let L=A.tagName;return L==="INPUT"||L==="TEXTAREA"}function V(A){return A.getAttribute?Boolean(A.getAttribute("contenteditable")==="true"):!1}function Y(A,L){if(A.isInput){A.element.value=L.eventData.text;let F=document.createEvent("Event");F.initEvent("input",!0,!1),A.element.dispatchEvent(F)}else A.isContentEditable&&(A.element.innerHTML=L.eventData.text)}function Z(){var L;let A=document.activeElement;for(;(L=A.shadowRoot)!=null&&L.activeElement;)A=A.shadowRoot.activeElement;return A}function fe(A){let L={status:"done",result:A,success:!0};n.isNonTextableElemnet&&(L.reason="Set text on non input element"),e(L)}function Ot(A){A=A||{};let L={status:"failed",result:A,success:!1};n.isNonTextableElemnet&&(L.reason="Set text on non input element"),e(L)}try{n.isInput=B(n.element),n.isContentEditable=V(n.element),!n.isInput&&!n.isContentEditable&&(n.isNonTextableElemnet=!0),n.isFocusable=n.isInput||n.isContentEditable,n.isSelectable=function(A){return A.type!=="keyup"},n.noEventExecuter=Y}catch(A){Ot(`exception in set text step:${A.message}`);return}let Jr=Z();dispatchFocus(s.elementToFocusLocatedElement,Jr),N(n)}});var Gi,pg=w(()=>{"use strict";ce();Ci();U();dg();Gi=class extends ${async setValueNative(){let e=this.context,t=this.getTarget();return this.step.delayBetweenChars?(await this.driver.elementIdClear(xe(t.seleniumElement)),await this.setTextDelayed()):this.driver.setValue(t.seleniumElement,e.stepText)}async setValueJS(){var d;let e=this.step,t=this.context,r=t.data[e.targetId||"targetId"],n=t.data.timeToPlayStep+3e3,o=e.events,{setTextDraftJs:i}=this.sessionPlayerInit.codeSnippets;if(r.isDraftEditor&&i)return this.driver.executeJS(i(r.locatedElement,t.stepText));if(!(o!=null&&o.length))return;let a={eventType:e.type,events:o,quirks:e.quirks,locatedElement:r.locatedElement,isRoot:r.isRoot,elementToFocusLocatedElement:r.elementToFocusLocatedElement},c=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var dispatchFocus = ${Mr};
            var setText = ${ug.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return setText.call(null, eventData, done);
        `,l=await this.driver.executeCodeAsync(c,n,a);return{success:Boolean((d=l.value)==null?void 0:d.success)}}async setTextDelayed(){let e=this.context.stepText,t=this.getTarget();for(let r=0;r<e.length;r++)await this.driver.elementIdValue(xe(t.seleniumElement),e[r]),r<e.length-1&&await se(this.step.delayBetweenChars)}async setValueAppendNative(){let e=[],t=this.context,r=this.getTarget();if(r!=null&&r.seleniumElement)return this.step.delayBetweenChars?this.setTextDelayed():(e.push(Array.from(t.stepText)),this.driver.elementIdValue(xe(r.seleniumElement),e));throw new Error("missing selenium element")}async performAction(){let e=this.getTarget(),t=this.driver.isSafari()&&e.locatedElement&&e.locatedElement.shadowPath&&Array.isArray(e.locatedElement.shadowPath)&&e.locatedElement.shadowPath.length>1;if(this.step.appendText){if(this.step.nativeEvents)return this.setValueAppendNative();let{stepResult:r}=this.sessionPlayerInit.commonConstants;return{success:!1,errorType:r.TEXT_ACTION_FAILURE,resultInfo:{error:"'Append Text' is only supported in Native Mode"}}}return this.step.nativeEvents&&!t?this.setValueNative():this.setValueJS()}}});var mg,fg=w(()=>{"use strict";mg=function(s,e){var d;function t(m,p){let f=`data-testim-${m}`,h="Native sessionStorage is not available";function g(y){return y!=null&&y.toString?y.toString().includes("[native code]"):!1}try{if(![window.sessionStorage.setItem,window.sessionStorage.getItem].every(g))throw new Error(h);let y=JSON.parse(window.sessionStorage.getItem(f)||"{}"),T=Object.assign({},y,p);window.sessionStorage.setItem(f,JSON.stringify(T))}catch(y){let T=y.message.toLowerCase().includes("quota"),C=y.message===h;if(y.message.includes("sessionStorage")||y.message.includes("The operation is insecure")||T||C){let b=document.head.querySelector("#testim-storage-backup");b||(b=document.createElement("meta"),b.id="testim-storage-backup",document.head.append(b));let v=JSON.parse(b.getAttribute(f)||"{}"),x=Object.assign({},v,p);if(b.setAttribute(f,JSON.stringify(x)),T||C){try{window.sessionStorage.removeItem(f)}catch{}(window.TSTA=window.TSTA||{}).useFallbackStorage=!0}return}throw y}}function r(m){return m.function?m.function.args.map(p=>p!=null&&p.locatedElement?getLocatedElement(p.locatedElement):p):m.directParams.map(p=>p.selector?document.querySelector(p.selector):p.value).concat(m.otherParams)}function n(m,p){function f(){return m.apply(this,p)}return f.prototype=m.prototype,new f}let o={},i={},a={},c=s.functionParams,l=s.transactionId;try{let m=r(s);m.push(o,i,a);let p=((d=s.function)==null?void 0:d.params)||c,h=(e||n(Function,p)).apply(null,m);typeof Promise<"u"&&h instanceof Promise?(t(l,{type:"promise"}),h.then(g=>{t(l,{status:"done",success:!0,result:{resultValue:g,exports:o,exportsTest:i,exportsGlobal:a}})},g=>{t(l,{status:"failed",success:!1,result:{resultValue:g.toString(),exports:o,exportsTest:i,exportsGlobal:a}})})):t(l,{status:"done",success:!0,result:{resultValue:h,exports:o,exportsTest:i,exportsGlobal:a}})}catch(m){t(l,{status:"failed",success:!1,result:{resultValue:m.toString(),exports:o,exportsTest:i,exportsGlobal:a}})}}});var Vi,Bu,lr,qi=w(()=>{"use strict";Vi=E(require("lodash"));U();ce();j();fg();ye();Bu=R("base-js-step-action"),lr=class extends ${isExceedingMaxResultSize(e,t){try{let r=t.project.defaults.enforceMaximumJsResultSize,n=M.flags.maximumJsResultSize.getValue(),o=JSON.stringify(e).length>n;return r?o:(o&&Bu.warn(`js result size exceeded ${n}, stepId: ${this.step.id}`),!1)}catch{return!1}}executeGetStatus(e){return this.driver.executeJS(t=>{let r=`data-testim-${t}`;try{return window.sessionStorage.getItem(r)}catch(n){if(n.message.includes("sessionStorage")||n.message.includes("The operation is insecure")){let o=document.head.querySelector("#testim-storage-backup");return o?o.getAttribute(r):"{}"}throw n}},e)}constructJSFunParams(e){let t=e.incomingParams,r=["context",...t.as.functionParameters,"exports","exportsTest","exportsGlobal"],n=[e.context,...t.as.functionArguments];return r.push(e.code),n.forEach(o=>{Vi.isObject(o)&&fo(o,"seleniumElement",Vi.isEqual)}),{function:{params:r,args:n},transactionId:e.transactionId,browser:e.browser,browserMajor:e.browserMajor}}checkStatus(e){let t=this,r=t.context.config.retryTimeout,n=t.context.data.timeToPlayStep-r;async function o(){let i;try{i=await t.executeGetStatus(e)}catch(l){Bu.warn("failed to get js status",{err:l}),i={value:{status:"exception"}}}let a;try{a=JSON.parse(i?i.value:"{}")}catch{Bu.warn("non object value",{selRes:i}),a={status:"exception"}}let c=t.stepActionUtils.abortedSteps.find(l=>l.id===t.step.id);return c||(a?a.status&&a.status==="done"?a:a.status&&a.status==="failed"?{success:!1,shouldRetry:!0,result:a.result}:n-r<=0?Object.assign(a,{success:!1,shouldRetry:!0}):(n-=r,await se(r),o()):{success:!0})}return o()}executeInAut(e){let t=M.flags.experimentalPreCodeCompilation.isEnabled(),r=M.flags.experimentalAsyncCustomCode.isEnabled(),n=this.constructJSFunParams(e),o=n.function.args.some(l=>Boolean(l==null?void 0:l.locatedElement)),i="undefined";if(t){let l=n.function.params.slice(0,-1);i=r?`async function(${l.join(",")}) {
                ${e.code}
            };`:`function(${l.join(",")}) {
                ${e.code}
            };`,n.function.params.pop()}let{codeSnippets:a}=this.sessionPlayerInit,c=`
            ${o?`var getLocatedElement = ${a.getLocatedElementCode};`:";"}
            var runCode = ${mg.toString()};
            var eventData = arguments[0];
            var funcToRun = ${i};
            return runCode.call(null, eventData, funcToRun);
        `;return t?this.driver.executeJS(c,n).catch(l=>this.handleExecutionError(l)):this.driver.executeJS(c,n)}codeExecDone(e){let{stepResult:t}=this.sessionPlayerInit.commonConstants,{context:r}=this,{result:n={},tstConsoleLogs:o,nodeVersion:i,navigateToDifferentDomain:a}=e;n.exports&&(r.data.exports=n.exports);let c={nodeVersion:i,tstConsoleLogs:o,data:r.data};return this.isFailedResult(n.resultValue)?Object.assign(c,{success:!1,errorType:t.JS_ASSERTION_FAILED}):this.isExceedingMaxResultSize({result:n,tstConsoleLogs:o},r)?Object.assign(c,{success:!1,errorType:t.JS_RESULT_MAX_SIZE_EXCEEDED}):(Object.assign(c,{success:!0,exportsTest:n.exportsTest,exportsGlobal:n.exportsGlobal}),a&&(c.navigateToDifferentDomain=a)),Promise.resolve(c)}codeExecFailed(e){let{stepResult:t}=this.sessionPlayerInit.commonConstants,{context:r}=this;if(e.type==="promise")return Promise.resolve({data:r.data,success:!1,shouldRetry:!0,isPendingPromise:!0,errorType:t.JS_ASSERTION_FAILED});if(e.reason==="stopped")return Promise.resolve(Object.assign({},e,{errorType:t.STOPPED}));let{result:n={},tstConsoleLogs:o}=e,i={tstConsoleLogs:o,data:r.data,exportsGlobal:n.exportsGlobal,exportsTest:n.exportsTest,success:!1,errorType:t.UNWRAPPED_AUT_REJECT,resultInfo:{error:n.resultValue}};return Promise.resolve(i)}checkCodeResponse(e){return e!=null&&e.success?this.codeExecDone(e):this.codeExecFailed(e)}async performAction(){let e=this.step,t=this.context;this.startTimestamp=Date.now();let r={transactionId:`${t.testResultId}:${e.id}`,id:e.id,eventType:e.type,code:e.code,incomingParams:t.incomingParams,exportsGlobal:this.exportsGlobal,exportsTest:this.exportsTest,context:{config:t.config,data:t.data},testResultId:t.testResultId},n=await this.driver.getBrowserAndOS();Object.assign(r,{browser:n.browser,browserMajor:n.browserMajor}),this.context.isPendingPromise||await this.executeInAut(r);let o=await this.checkStatus(r.transactionId);return await this.checkCodeResponse(o)}handleExecutionError(e){if((e==null?void 0:e.seleniumStack)&&e.seleniumStack.type==="JavaScriptError"&&e.seleniumStack.orgStatusMessage){let r=e.seleniumStack.orgStatusMessage.indexOf(`
Build info`),n=e.seleniumStack.orgStatusMessage.slice(0,r===-1?void 0:r);throw new Error(n)}throw e}}});var qt,hg=w(()=>{"use strict";qi();qt=class extends lr{isFailedResult(e){return e===!1}}});var Ls,gg=w(()=>{"use strict";qi();Ls=class extends lr{isFailedResult(e){return!e}}});var jE,Hi,yg=w(()=>{"use strict";ce();U();jE={8:"\uE008",9:"\uE004",13:"\uE007",27:"\uE00C",33:"\uE00E",34:"\uE00F",35:"\uE010",36:"\uE011",45:"\uE016",112:"\uE031",113:"\uE032",114:"\uE033",115:"\uE034",116:"\uE035",117:"\uE036",118:"\uE037",119:"\uE038",120:"\uE039",121:"\uE03A",122:"\uE03B",123:"\uE03C"},Hi=class extends ${setWithValueApi(e){let t=this.getTarget();return t!=null&&t.seleniumElement?this.driver.elementIdValue(xe(t.seleniumElement),e):Promise.reject(new Error("missing selenium element"))}performAction(){let e=[],t=this.step.events[0].eventData.keyCode;return t>=32&&t<=127?e.push(String.fromCharCode(t)):e.push(jE[t]),this.setWithValueApi(e)}}});function bg(s,e){function t(r,n){let o=Element.prototype.matches,i=o&&isNativeFunction(o)?o:document.createElement(r.tagName).__proto__.matches;do{if(i.call(r,n))return r;r=r.parentElement||r.parentNode}while(r!==null&&r.nodeType===1);return null}try{let r=getLocatedElement(s);if(!r)return{success:!1,status:"failed",result:"option element not found"};let n=t(r,"select");return n?(n.focus(),r.selected?{success:!0,status:"done"}:(r.selected=!0,["input","change"].map(i=>{let a=document.createEvent("HTMLEvents");return a.initEvent(i,!0,!1),a}).forEach(i=>{if(e){n.dispatchEvent(i);return}r.dispatchEvent(i)}),{success:!0,status:"done"})):{success:!1,status:"failed",result:"select element not found"}}catch(r){return{success:!1,status:"failed",result:r.toString()}}}var wg=w(()=>{"use strict"});var zi,Tg=w(()=>{"use strict";ce();wg();U();ye();zi=class extends ${async performAction(){var m,p;let e=this.context.data[this.step.targetId||"targetId"],{seleniumElement:t,locatedElement:r}=e,o=(await this.driver.getBrowserAndOS()).browserMajor,i=this.driver.isSafari(),a=Boolean((m=this.step.element)==null?void 0:m.isShadowed);if(!i||i&&o>=13&&!a)try{return await this.driver.elementIdClick(xe(t))}catch(f){if(!f.message.includes("Cannot check the displayedness of a non-Element argument"))throw f}let c=M.flags.safariSelectOptionDispatchEventOnSelectElement.isEnabled(),l=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var isNativeFunction = ${this.sessionPlayerInit.utils.isNativeFunction.toString()};
            var selectOption = ${bg.toString()};
            return selectOption.apply(null, arguments);
        `;return(p=(await this.driver.executeJSWithArray(l,[r,c])).value)!=null&&p.success?{success:!0}:{success:!1}}}});var Ki,vg=w(()=>{"use strict";ce();Ki=class extends ${async performAction(){await this.driver.submitForm(this.getTarget().seleniumElement)}}});var BE,Ji,Eg=w(()=>{"use strict";ce();BE=(s,e,t,r)=>({x:t,y:r,width:e,height:s,get top(){return this.y},get left(){return this.x},get right(){return this.x+this.width},get bottom(){return this.y+this.height},toJSON(){}}),Ji=class extends ${getRect(){return this.driver.isFirefox()?this.getTarget().rectWithoutFrameOffset:this.getTarget().rect}async performAction(){let e=this.getTarget(),{seleniumElement:t,rectWithoutFrameOffset:r,rect:n}=e,{width:o,height:i}=n,a=o/2,c=i/2,l=this.step.element.clickOffset;if(l&&this.step.shouldAccountForMouseOffsetInHover){let{x:m,y:p}=l;this.sessionPlayerInit.utils.isWithinTargetRect(BE(i,o,0,0),m,p)&&(a=m,c=p)}let d={frameOffset:{x:n.left-r.left,y:n.top-r.top},rect:r,clickOffset:{x:Math.floor(a),y:Math.floor(c)}};return await this.driver.hover(t,d),{success:!0}}}});var Sg,Rg=w(()=>{"use strict";Sg=function(s,e){function r(a,c){function l(h,g,y){return y>h&&y<g}let d=a.pointerPosition||{},m=c.getBoundingClientRect(),p=d.originX&&l(m.left,m.left+m.width,d.originX)?d.originX:m.left+m.width/2,f=d.originY&&l(m.top,m.top+m.height,d.originY)?d.originY:m.top+m.height/2;return{x:p,y:f}}function n(a,c,l){let d=r(a,l),m=(c==null?void 0:c.modifiers)||{},p={deltaX:a.deltaX,deltaY:a.deltaY,deltaZ:a.deltaZ,deltaMode:a.deltaMode,clientX:d.x,clientY:d.y,bubbles:!0,cancelable:!0,ctrl:Boolean(m.ctrl),alt:Boolean(m.alt),shift:Boolean(m.shift),meta:Boolean(m.meta)};return new WheelEvent("wheel",p)}function o(a,c){if(a.length===0){e({state:"success"});return}if(!c)throw new Error("element not found");let l=a.shift(),d=n(l,s.eventData,c),m=a[0]?Math.min(a[0].timeStamp-l.timeStamp,200):200;c.dispatchEvent(d),setTimeout(()=>{o(a,c)},m)}let i=getLocatedElement(s.locatedElement);o(s.events,i)}});var Yi,Ig=w(()=>{"use strict";ce();Rg();Yi=class extends ${async performAction(){var c;let e=this.step,t=this.context,r=e.events;if(!(r!=null&&r.length))return;let n={events:r,eventData:{modifiers:e.modifiers,button:e.button},locatedElement:this.getTarget().locatedElement},o=t.data.timeToPlayStep+3e3,i=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var wheel = ${Sg.toString()};
            var eventData = arguments[0];
            var done = arguments[1];
            return wheel.call(null, eventData, done);
        `;return{success:((c=(await this.driver.executeCodeAsync(i,o,n)).value)==null?void 0:c.state)==="success"}}}});var xg,Pg=w(()=>{"use strict";xg=function(s,e){let t=getLocatedElement(s);if(!t)throw new Error("element not found");function r(){let i=-1,a=0,c=[],l={waitOn(){let d=++i;return function(m){d in c||(c[d]=m,a++,e.length===a&&l.endWithCallback(c))}},endWith(d){l.endWithCallback=d}};return l}function n(i,a,c){let l=new XMLHttpRequest;l.open("GET",i),l.responseType="blob",l.onload=function(){if(this.status>=200&&this.status<300)c({blob:l.response,name:a});else throw new Error("Failed to load blob response code is not between 200 - 300")},l.onerror=function(){throw new Error("Failed to load blob")},l.send()}let o=r();e.forEach(i=>{n(i.url,i.name,o.waitOn())}),o.endWith(i=>{let a=createDropEvent(i);t.dispatchEvent(a)})}});var $E,Xi,Cg=w(()=>{"use strict";ce();j();Pg();ye();$E=R("drop-file-step-action"),Xi=class extends ${async performAction(){let{codeSnippets:e,utils:t}=this.sessionPlayerInit,r=this.context.data[this.step.targetId||"targetId"],n=M.flags.overrideAzureStorageUrl.isEnabled(),o=await t.addTokenToFileUrl(this.context.project.id,this.step.fileUrls,this.stepActionUtils.testimServicesApi,n,$E),i=`
        var getLocatedElement = ${e.getLocatedElementCode};
        var createDropEvent = ${e.createDropEvent.toString()};
        var downloadFileAndFireDropEvent = ${xg.toString()};
        return downloadFileAndFireDropEvent.apply(null, arguments)
    `;return await this.driver.executeJSWithArray(i,[r.locatedElement,o])}}});function _g(s={width:"2px",height:"2px",left:"0px",top:"400px"}){return`function getVisibleElement(locatedElement) {
        var input = getLocatedElement(locatedElement);
        if(input) {
            function parents(element, _elements) {
                _elements = _elements || [];
                _elements.push(element);
                if(element.parentNode && element.tagName !== 'BODY') {
                    return parents(element.parentNode, _elements);
                }
                return _elements;
            }

            function forceStyle(el, name, value) {
                el.style.setProperty(name, value, 'important');
            }

            Array.apply(null, parents(input)).forEach(function(el) {
                let element = el;
                if (element instanceof DocumentFragment) {
                    element = element.host
                }

                var displayMode = window.getComputedStyle(element).display;
                if(displayMode === "none") {
                    forceStyle(element, 'display', 'block');
                }
            })

            forceStyle(input, 'visibility', 'visible');
            forceStyle(input, 'width', '${s.width}');
            forceStyle(input, 'max-width', '${s.width}');
            forceStyle(input, 'height', '${s.height}');
            forceStyle(input, 'max-height', '${s.height}');
            forceStyle(input, 'z-index', 100000000);
            forceStyle(input, 'opacity', 1);
            forceStyle(input, 'top', '${s.top}');
            forceStyle(input, 'left', '${s.left}');
            forceStyle(input, 'position', 'fixed');
            forceStyle(input, 'pointer-events', 'all');
            input.removeAttribute("disabled");
            input.focus();
        }
    }`}async function GE(s,e){let t=null;try{t=(await ic(s)).body}catch(n){if(WE.error("failed to download input-file content",{err:{message:n.message,stack:n.stack,status:n.status}}),n.response)t=n.response.body;else throw n.cause?new Error(n.message):n}let r=`${Ag.tmpdir()}/${e}`;return await kg.promises.writeFile(r,t),r}function VE(s){return de(s,e=>GE(e.url,e.name))}function qE(s,e){return e(s)}async function Og(s,e){let t=await VE(s),r=await de(t,n=>qE(n,e));return Array.isArray(r)&&r.map(n=>n==null?void 0:n.value)}var Ag,kg,WE,Lg=w(()=>{"use strict";Ag=E(require("os"));It();kg=require("fs");U();j();WE=R("input-file-utils")});function zE(){return`async function downloadAndUpload(locatedElement, fileUrls) {
        const fileIsNative = typeof window.File === 'function' && (window.File.toString().indexOf('native code') > -1);
        const File = fileIsNative ? window.File : (function obtainSafeGlobals() {
            const attachTo  = document.body || document.documentElement;
            if (attachTo) {
                let tempIFrame;
                try {
                    tempIFrame = document.createElement('iframe');
                    tempIFrame.style.setProperty('display', 'none');
                    tempIFrame.style.setProperty('pointer-events', 'none');
                    attachTo.appendChild(tempIFrame);
                    const { File } = tempIFrame.contentWindow;
                    return File;
                } finally {
                    if (tempIFrame) {
                        tempIFrame.parentElement.remove(frame);
                    }
                }
            } else {
                return window.File;
            }
        })();
        const element = getLocatedElement(locatedElement);
        if(!element) {
            throw new Error('element not found');
        }

        function getFileBlob(url) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'blob';

                xhr.onload = function() {
                    if (this.status === 200) {
                        resolve(this.response);
                    } else {
                        reject(new Error('Could not load file, failure status:' + this.status));
                    }
                }
                xhr.onerror = function(e) {
                    reject(new Error("Error " + e.target.status + " occurred while loading the file."));
                };
                xhr.send();
            });

        }

        const fileList = await Promise.all(fileUrls.map(async ({ url, name }) => {
            let blob;
            try {
                const res = await fetch(url)
                blob = await res.blob();
            } catch (err) {
                blob = await getFileBlob(url); // Sometimes the fetch fails, try using XHR as fallback
            }
            return new File([blob], name, { type: blob.type });
        }));

        const dt = new DataTransfer();
        for (const file of fileList) {
            dt.items.add(file);
        }
        element.files = dt.files;

        let changeWasFired = false;
        const changeFiredHandler = (e) => {
            changeWasFired = true;
        };

        element.addEventListener("change", changeFiredHandler, true);
        await Promise.resolve(); // wait microtick
        element.dispatchEvent(new Event("input", { bubbles: true }));
        if (!changeWasFired) {
            element.dispatchEvent(new Event("change", { bubbles: true }));
        }
        element.removeEventListener("change", changeFiredHandler, true);
    }`}var Qi,Zi,Ng=w(()=>{"use strict";Lg();ce();j();U();ye();Qi=R("input-file-step-action"),Zi=class extends ${uploadFile(e){return this.driver.uploadFile(e)}forceInputToBeVisible(e,t){Qi.info("workaround - stepaction - move element to visible position");let r=`
            var getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
            var getVisibleElement = ${_g(t)};
            return getVisibleElement.apply(null, arguments);
        `;return this.driver.executeJS(r,e.locatedElement)}async safariPreUploadActions(e){let t={width:"150px",height:"150px",left:"10px",top:"10px"};try{return await this.forceInputToBeVisible(e,t)}catch(r){throw Qi.error("failed to set input file in Safari recovery",{err:r}),r}}async uploadFilesAndForceVisibility(e,t){try{this.driver.isSafari()&&await this.safariPreUploadActions(t),await this.uploadFiles(e,t)}catch(r){let n="The element is not editable",o="The element is not focusable",i="An element command could not be completed because the element is not visible on the page.",a="element not interactable",c="element is not pointer- or keyboard interactable",l="invalid element state: Element is not currently interactable and may not be manipulated",d="Element must not be hidden, disabled or read-only",m="is not reachable by keyboard",p=r?r.message:"";if(p===l||p.startsWith(d)||p.startsWith(n)||p.startsWith(o)||p.startsWith(i)||p.includes(m)||p.includes(a)||p.includes(c)){await this.forceInputToBeVisible(t),await this.uploadFiles(e,t);return}throw Qi.error("failed to set input file",{err:r}),r}}async uploadFiles(e,t){for(let r of e)await this.driver.elementIdValue(xe(t.seleniumElement),r)}async performAction(){let e=this.context.data[this.step.targetId||"targetId"],t=M.flags.overrideAzureStorageUrl.isEnabled(),r=M.flags.useJsInputCodeInSafari.isEnabled(),n=M.flags.useJsInputCodeInFirefox.isEnabled(),o=M.flags.downloadToBase64.isEnabled(),i=await this.sessionPlayerInit.utils.addTokenToFileUrl(this.context.project.id,this.step.fileUrls,this.stepActionUtils.testimServicesApi,t,Qi),a=this.driver.isSafari()&&(r||i.length>1),c=this.driver.isFirefox()&&(n||i.length>1);if(o&&(i=await Promise.all(i.map(async({name:d,url:m})=>{let p=await Sr(m);return{name:d,url:`data:${p.type};base64,${Buffer.from(p.body).toString("base64")}`}}))),a||c){await this.driver.executeJSWithArray(`
                const getLocatedElement = ${this.sessionPlayerInit.codeSnippets.getLocatedElementCode};
                const downloadAndUploadFile = ${zE()};
                return downloadAndUploadFile.apply(null, arguments);`,[e.locatedElement,i]);return}let l=await Og(i,this.uploadFile.bind(this));await this.uploadFilesAndForceVisibility(l,e)}}});var ea,ta,Dg=w(()=>{"use strict";ea=require("url");ce();ta=class extends ${async updateBaseUrl(e){let t=new ea.URL(e),r=new ea.URL(this.context.recordedBaseUrl),n=new ea.URL(this.context.baseUrl);return t.host===r.host&&r.host!==n.host&&(t.host=n.host),t.href}async performAction(){let e=this.context.data.testimNavigationStepDestination||this.context.data.url;if(this.step.openInNewTab){await this.driver.client.newWindow(e);return}let t=await this.updateBaseUrl(e);await this.driver.url(t)}}});var ra,Mg=w(()=>{"use strict";ce();U();ra=class extends ${async performAction(){await se(this.step.durationMS)}}});var sa,Fg=w(()=>{"use strict";ce();sa=class extends ${async execute(){try{return await this.driver.reloadTab(),{success:!0}}catch(e){return{success:!1,reason:e.message}}}}});var Fn,Ug=w(()=>{"use strict";ce();Fn=class extends ${async runApiInAut(e){var n;e.withCredentials=!0;let t=this.context.data.timeToPlayStep+3e3,{apiCall:r}=this.sessionPlayerInit;try{let o=await this.driver.executeCodeAsync(r,t,e);return(o==null?void 0:o.value)||{}}catch(o){throw(n=o==null?void 0:o.message)!=null&&n.includes("Javascript execution context no longer exists")?new Error('The page refreshed or changed while executing this step. Please consider unchecking "Send via web page" if this is expected.'):o}}runApiInBg(e){let{apiCall:t}=this.sessionPlayerInit;return new Promise(r=>{t(e,r)})}async performAction(){let{commonConstants:e}=this.sessionPlayerInit,t=this.step,r=this.context,n={id:t.id,url:r.apiUrl,method:t.method,headers:r.apiHeaders,body:r.apiBody,timeout:r.data.maxTotalStepTime,omitCookies:t.omitCookies,formData:t.formData,fileUrls:r.fileUrls},o;t.sendViaWebApp?o=await this.runApiInAut(n):o=await this.runApiInBg(n);let i=o.result||{},a={method:t.method,status:i.status,url:t.url};return o.success?i.status===0?{result:i,resultInfo:a,shouldRetry:!1,success:!1,reason:"Connection problem",errorType:e.stepResult.API_REQUEST_NETWORK_ERROR}:{result:i,resultInfo:a,shouldRetry:!1,success:!0}:{result:i,resultInfo:a,shouldRetry:!1,success:!1,reason:i.error||e.error.REQUEST_TIMED_OUT,errorType:i.error?e.stepResult.API_FAILURE:e.stepResult.API_REQUEST_NETWORK_ERROR}}}});var na,jg=w(()=>{"use strict";ce();na=class extends ${async performAction(){let e=this.step.extractTextParamName,t=await this.stepActionUtils.extractTargetText(this.getTarget());return this.context.data.exports=this.context.data.exports||{},this.context.data.exports[e]=t,{success:!0,data:this.context.data}}}});var oa,Bg=w(()=>{"use strict";ce();ia();oa=class extends ${async performAction(){return await Ns(this.step,this.context,this.driver,this.stepActionUtils.testimServicesApi.authenticationManager.getLoggedUserInfo(),this.frameHandler.frameManager)}}});function ur(s){if(Gr.has(s,"elementId"))return s.elementId;if(Gr.has(s,at))return s[at];if(Gr.has(s,aa))return s[aa]}var Gr,$g,aa,$u,Wu,Gu,Wg=w(()=>{"use strict";Gr=E(require("lodash")),$g=require("@applitools/eyes-sdk-core");Yr();ro();Ee();aa="ELEMENT";$u=class{isDriver(e){return Boolean((e==null?void 0:e.getPrototype)&&e.desiredCapabilities&&e.requestHandler)}isElement(e){if(!e)return!1;let t=e.value||e;return Boolean(t[at]||t[aa])}isSelector(e){return typeof e=="string"}transformDriver(e){return new Proxy(e,{get:(t,r)=>{if(r!=="then")return Reflect.get(t,r)}})}transformElement(e){let t=ur(e.value||e);return{[at]:t,[aa]:t}}transformSelector(e){return Gr.has(e,"selector")?Gr.has(e,"type")?e.type==="css"?`css selector:${e.selector}`:`${e.type}:${e.selector}`:e.selector:e}extractSelector(e){return Gr.has(e,"selector")?e.selector:void 0}isStaleElementError(e,t){if(!e)return!1;let r=e.originalError||e;return r instanceof Error?r.seleniumStack&&r.seleniumStack.type==="StaleElementReference":r.value&&r.selector&&r.selector===t}isEqualElements(e,t,r){if(!t||!r)return!1;let n=ur(t),o=ur(r);return n===o}async executeScript(e,t,r){let{value:n}=await e.execute(t,r);return n}async mainContext(e){return await e.frame(null),e}async parentContext(e){return await e.frameParent(),e}async childContext(e,t){return await e.frame(t),e}async findElement(e,t,r){let{value:n}=r?await e.elementIdElement(ur(r),t):await e.element(t);return n}async findElements(e,t,r){let{value:n}=r?await e.elementIdElements(ur(r),t):await e.elements(t);return n}async getWindowSize(e){let{value:t}=await e.windowHandleSize();return{width:t.width,height:t.height}}async setWindowSize(e,t){await e.windowHandlePosition({x:0,y:0}),await e.windowHandleSize(t)}async getDriverInfo(e){let t=e.desiredCapabilities;return{sessionId:e.requestHandler.sessionID||e.sessionId,isMobile:e.isMobile,isNative:e.isMobile&&!t.browserName,deviceName:t.deviceName,platformName:t.platformName||t.platform,platformVersion:t.platformVersion,browserName:t.browserName??t.name,browserVersion:t.browserVersion??t.version,pixelRatio:t.pixelRatio}}async getTitle(e){return e.getTitle()}async getUrl(e){return e.getUrl()}async visit(e,t){await e.url(t)}async takeScreenshot(e){return e.saveScreenshot()}async click(e,t){this.isSelector(t)&&(t=await this.findElement(e,t)),await e.elementIdClick(ur(t))}async hover(e,t,r){this.isSelector(t)&&(t=await this.findElement(e,t)),await e.moveTo(ur(t),r==null?void 0:r.x,r==null?void 0:r.y)}async type(e,t,r){this.isSelector(t)?t=await this.findElement(e,t):e.elementIdValue(ur(t),r)}async scrollIntoView(e,t,r=!1){this.isSelector(t)&&(t=await this.findElement(e,t)),await e.execute("arguments[0].scrollIntoView(arguments[1])",t,r)}async waitUntilDisplayed(e,t,r){await e.waitForVisible(t,r)}},Wu=class{constructor(){let{EyeSdkBuilder:e}=re(),t=jd["@applitools/eyes-sdk-core"]||"N/A";this.sdk=(0,$g.makeSDK)({name:"Testim.io",version:`4.0.0/eyes-sdk-core/${t}`,spec:new $u}),this.handleApplitoolsSdkResult=e.handleApplitoolsSdkResult}async getManager(e,t,r,n){let{EyeSdkBuilder:o}=re(),i=await this.sdk.makeManager({type:e?"vg":"classic",concurrency:t});return o.rememberCreatedBatch(r,n),i}},Gu=new Wu});var Vg,Gg,Un,qg=w(()=>{"use strict";Vg=E(require("lodash"));ce();j();Wg();Gg=R("pixel-validation-step-action"),Un=class extends ${async performAction(){var d,m;let{shouldUseVisualGrid:e,applitoolsSdkConfig:t,applitoolsSdkLogger:r,testResultId:n}=this.context;this.runContext=this.context.getRunContext(void 0);let o=((d=this.runContext.incomingParams)==null?void 0:d.final)||{},i=((m=t.batch)==null?void 0:m.id)||n,a=await Gu.getManager(e,this.context.config.applitoolsConcurrency||5,i,this.runContext.applitoolsIntegrationData),c=this.getTarget()||{},l;try{let p=await a.openEyes({driver:this.driver.client,config:t,logger:r}),h={region:this.step.action==="element"&&c.seleniumElement||void 0,fully:this.step.action==="stitched"};Vg.isPlainObject(o.applitoolsStepSettings)&&(Object.assign(h,o.applitoolsStepSettings),Gg.info("Applitools SDK step executed with applitoolsStepSettings parameter",{applitoolsStepSettings:o.applitoolsStepSettings})),await p.check({settings:h}),l={isApplitoolsSdkResult:!0,success:!0,eyesResults:await p.close()}}catch(p){Gg.error("Applitools SDK step failed",{err:p,info:p.info}),l={isApplitoolsSdkResult:!0,success:!1,err:p}}return await Gu.handleApplitoolsSdkResult(this.context,l,this.step)}}});var Ds,Vu=w(()=>{"use strict";U();jr();qi();Ds=class extends lr{async executeCliCode(){var h,g,y;let{step:e,context:t}=this,r=this.stepActionUtils.driver.isMobile;if(!((y=(g=(h=t.company)==null?void 0:h.activePlan)==null?void 0:g.premiumFeatures)==null?void 0:y.cliAction)&&!r)return{success:"skipped",reason:"CLI action is not enabled in your current plan"};let{code:o,id:i}=e,{incomingParams:a,testResultId:c,retryIndex:l,stepResultId:d}=t,m={config:t.config,data:t.data},p=t.data.timeToPlayStep,f=await xs(o,i,a,m,c,l,d,p);return await this.checkCodeResponse(f)}async performAction(){try{return await this.executeCliCode()}catch(e){let{stepResult:t}=this.sessionPlayerInit.commonConstants;return e instanceof J?{success:!1,errorType:t.ACTION_TIMEOUT}:{success:!1,reason:e.message,exception:e}}}}});var dr,Hg=w(()=>{"use strict";Vu();dr=class extends Ds{isFailedResult(e){return e===!1}}});var ca,zg=w(()=>{"use strict";Vu();ca=class extends Ds{isFailedResult(e){return!e}}});var la,Kg=w(()=>{"use strict";U();jr();ce();q();la=class extends ${async performAction(){let{context:e}=this,{stepId:t,packageData:r,resultId:n,retryIndex:o,stepResultId:i,timeToPlayBeforeExec:a}=e;try{return{data:await Is(t,n,o,r,i,a),success:!0}}catch(c){return c instanceof pt?{success:!1,code:"invalid-node-package",message:c.message}:c instanceof J?{success:!1,code:"timeout"}:{success:!1,reason:c.message,exception:c}}}}});var Ms,Jg=w(()=>{"use strict";ce();Ms=class extends ${async performAction(){return{success:"skipped",reason:"This step can run only on Chrome"}}}});var We,Yg=w(()=>{"use strict";ce();We=class extends ${async performAction(){var r,n;let{sfdc:e}=this.sessionPlayerInit,t=e.sfdcNewSePage(this.driver,this.context.sfdcLogHandler||((o,i)=>this.context.playback.sfdcAddLog(o,i)));t.log.info(`BEGIN STEP '${(n=(r=this.step).getStepPreview)==null?void 0:n.call(r)}'`);try{let o=this.context.sfdcTestActions;if(o===void 0)throw new Error("No test actions were compiled");return{success:!0,reason:await e.sfdcExecute(t,o,this.context)}}catch(o){return{success:!1,reason:o.reason||o.message,exception:o,shouldRetry:!1}}finally{t.releaseObjects()}}}});var ua,Xg=w(()=>{"use strict";ce();ua=class extends ${async performAction(){var r,n;let{sfdc:e}=this.sessionPlayerInit,t=e.sfdcNewSePage(this.driver,this.context.sfdcLogHandler||((o,i)=>this.context.playback.sfdcAddLog(o,i)));t.log.info(`BEGIN STEP '${(n=(r=this.step).getStepPreview)==null?void 0:n.call(r)}'`);try{return{success:!0,reason:await e.sfdcExecuteRecordedStep(t,this.step.recordedData,this.context)}}catch(o){return{success:!1,reason:o.reason||o.message,exception:o,shouldRetry:!1}}finally{t.releaseObjects()}}}});function KE(s,e){Object.keys(s).forEach(t=>{e.registerStepAction(t,s[t])})}function da(s,e){KE(JE,e),e.registerLocateStepActionUtils&&e.registerLocateStepActionUtils(Nn.getUtils(s))}var JE,qu=w(()=>{"use strict";Kh();Xh();ig();ag();lg();pg();hg();gg();yg();Tg();vg();Eg();Ig();Cg();Ng();Dg();Mg();Fg();Ug();jg();Bg();qg();Hg();zg();Kg();Jg();Yg();Xg();JE={locate:Nn,scroll:Bi,mouse:$i,submit:Ki,text:Gi,"special-key":Hi,"user-code":qt,"validation-code-step":qt,"wait-for-code-step":qt,"action-code-step":qt,"condition-step":Ls,"skip-code-step":Ls,"element-code-step":Ls,"evaluate-expression":Wi,"text-validation":Mn,"wait-for-text-validation":Mn,"select-option":zi,"drop-file":Xi,"input-file":Zi,hover:Ji,navigation:ta,wheel:Yi,sleep:ra,refresh:sa,"api-validation":Fn,"api-action":Fn,"api-code-step":qt,"extract-text":na,"simple-ui-verification":Un,"wait-for-simple-ui-verification":Un,"cli-validation-download-file":Ms,"cli-wait-for-download-file":Ms,"network-validation-step":Ms,"cli-validation-code-step":dr,"cli-wait-for-code-step":dr,"cli-action-code-step":dr,"cli-api-code-step":dr,"cli-condition-step":ca,"node-package":la,"email-code-step":qt,"cli-email-code-step":dr,"tdk-hybrid":oa,"sfdc-recorded-step":ua,"sfdc-step-login":We,"sfdc-step-loginas":We,"sfdc-step-logout":We,"sfdc-step-sobjectcreate":We,"sfdc-step-sobjectdelete":We,"sfdc-step-findrecord":We,"sfdc-step-quickaction":We,"sfdc-step-sobjectedit":We,"sfdc-step-sobjectvalidate":We,"sfdc-step-launchapp":We,"sfdc-step-closeconsoletabs":We,"sfdc-step-relatedlistaction":We}});var Hu,jn,zu=w(()=>{"use strict";Hu=class{on(){}},jn=new Hu});var Qg,YE,Zg,XE,Fs,Ku=w(()=>{"use strict";Qg=E(require("lodash")),YE=1e3,Zg=["simple-ui-verification","wait-for-simple-ui-verification"],XE=[...Zg,"custom-validation","sfdc-recorded-step","sfdc-step-login","sfdc-step-loginas","sfdc-step-logout","sfdc-step-sobjectcreate","sfdc-step-sobjectdelete","sfdc-step-findrecord","sfdc-step-quickaction","sfdc-step-sobjectvalidate","sfdc-step-launchapp","sfdc-step-closeconsoletabs","sfdc-step-sobjectedit","sfdc-step-relatedlistaction"],Fs=class{constructor(e){this.resetStepVariables(),this.resetRetryVariables(),this.isDebuggerConnected=e}resetStepVariables(e,t){this.currentRetryTimes=t||[],this.totalStepTime=e||0,this.totalStepTimesReport=[],this.currentRetryTimesReport={};let r=Date.now();this.currentRetryStart=r,this.lastUpdateTime=r}resetRetryVariables(){let e=Date.now();this.currentRetryStart=e,this.lastUpdateTime=e,this.totalStepTimesReport.push(this.currentRetryTimesReport),this.currentRetryTimesReport={}}initStepRun(e){let t=o=>{let i=this.getTotalStepTimeLeftToPlay(e,o),a=5e3;return i<=a?[a]:[Math.max(a,i/3)]};e.setStartTimestamp();let r=this.getTotalStepRunTime(e),n=XE.includes(e.stepType)?[r]:t(r);this.resetStepVariables(r,n),e.context.data.maxTotalStepTime=r}getStepTimes(){return this.totalStepTimesReport.push(this.currentRetryTimesReport),Qg.cloneDeep(this.totalStepTimesReport)}initRetryTime(){this.resetRetryVariables()}getTotalStepRunTime(e){let r=e.context.config.stepTimeout;return Zg.includes(e.stepType)&&(r=e.context.config.applitoolsStepTimeout||18e5),e.step.type.startsWith("sfdc-")&&(r=e.step.defaultTimeout),e.step.useStepTimeout&&e.step.stepTimeout?e.step.stepTimeout:r}getTotalStepTimeLeftToPlay(e,t=this.totalStepTime){let r=Date.now()-e.startTimestamp;return t-r}getCurrentRetryTime(e){return e.retryIndex<this.currentRetryTimes.length?this.currentRetryTimes[e.retryIndex]:this.getTotalStepTimeLeftToPlay(e)}getTotalCurrentRetryTimeLeft(e){let t=Date.now()-this.currentRetryStart;return this.getCurrentRetryTime(e)-t+YE}getTabTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getDynamicParentTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getFrameTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}getLocateTimeout(e){return this.getTotalCurrentRetryTimeLeft(e)}calcAndroidScrollTimeout(e){let r=2e3;return e.step.isScrollToElement&&(r=4e3),e.step.events.length*r+5e3}getActionTimeout(e){if(this.isDebuggerConnected)return 6e5;let t=5e3,r=e.step.type,n=3e4,o;return r==="sleep"?o=e.step.durationMS+t:r==="android-scroll"?o=Math.max(this.calcAndroidScrollTimeout(e),n):o=Math.max(this.getTotalStepTimeLeftToPlay(e),n),o}setStepPhaseTime(e){let t=Date.now(),r=t-this.lastUpdateTime;this.lastUpdateTime=t,this.currentRetryTimesReport[e]=r}reportGetTabTime(){this.setStepPhaseTime("tab")}reportGetFrameTime(){this.setStepPhaseTime("frame")}reportCalcConditionTime(){this.setStepPhaseTime("condition")}reportPreLocateActionsTime(){this.setStepPhaseTime("pre-locate")}reportFindElementsTime(){this.setStepPhaseTime("locate")}reportStepActionTime(){this.setStepPhaseTime("action")}}});var Ju={};W(Ju,{SeleniumTestPlayer:()=>Bn});var Bn,pa=w(()=>{"use strict";U();_n();Pu();Uh();Ou();Lu();$h();Nu();Ee();Os();qu();zu();Ku();Bn=class{constructor(e,t,r,n="code",o=new Fr,i,a){let{sessionPlayer:c,commonConstants:l,stepActionFactory:d}=re();this.driver=o,this.id=e;let m=new _s(this.driver);this.stepActionFactory=new d(m),da(this.driver,this.stepActionFactory),this.tabService=this.driver.tabService||new Ni(this.driver),this.driver.tabService=this.tabService,this.windowCreationListener=jn,this.playbackTimeoutCalculator=new Fs(Mi()),this.tabService.createSesion(e);let p=Bh(this.driver);this.sessionPlayer=new c(e,this.tabService,new Cs(this.driver),jn,p,Di,null,null,m,this.stepActionFactory,this.playbackTimeoutCalculator,Qe.getSocket(),n),this.sessionPlayer.setShouldMonitorPerformance&&this.sessionPlayer.setShouldMonitorPerformance(r),this.tabService.setAddFrameHandlerCallBack(this.sessionPlayer.addPlaybackFrameHandler.bind(this.sessionPlayer)),this.sessionPlayer.playbackManager.isRemoteSession=!0,this.sessionPlayer.playbackManager.isLocalRun=!1,this.sessionPlayer.playbackManager.testRetryCount=i,this.sessionPlayer.playbackManager.previousTestResultId=a,this.sessionPlayer.playbackManager.userParamsData=t||{},this.onStepCompleted=this.onStepCompleted.bind(this),this.sessionPlayer.playbackManager.on(l.playback.RESULT,this.onStepCompleted)}onStepCompleted(e,t,r,n){n!=null&&n.isTabOpener&&this.tabService.addNewPopup(this.id,n.id).catch(()=>{})}onDone(){let{commonConstants:e}=re(),t=1e3*60*2;return te(this.driver.end(),t).catch(r=>{if(r instanceof J)return this.driver.forceEnd().catch(()=>null)}).then(()=>{this.sessionPlayer.playbackManager.off(e.playback.RESULT,this.onStepCompleted),this.sessionPlayer=null,this.tabService=null,this.stepActionFactory=null,this.driver=null})}clearSessionTabs(){this.tabService.clearAllTabs(this.id)}async addTab(e,t={loadInfo:!0}){let n=(await this.driver.getTabIds()).at(-1);return await this.tabService.addNewTab(this.id,n,e,t),this.sessionPlayer.addPlaybackFrameHandler(n,void 0,{emptyPage:!0})}async addAllTabs(e,t={loadInfo:!0,checkForMainTab:!0,takeScreenshots:!0},r=[]){let n=await this.driver.getTabIds(),o=["app.testim.io"].concat(r);for(let i of n.reverse()){await this.tabService.addNewTab(this.id,i,e,{...t,forceSwitch:!0});let a=this.tabService.getTabInfo(this.id,i);if(o.some(c=>a.url.includes(c))){await this.tabService.removeTabInfo(this.id,i);continue}await this.sessionPlayer.addPlaybackFrameHandler(i,void 0,{emptyPage:!0})}if(this.tabService.tabCount(this.id)===1){let i=this.tabService.getMainTabInfo(this.id),a=this.tabService.getTabUtils(this.id,i);await this.tabService.switchTab(a.tabId,this.id,{forceSwitch:!0})}this.tabService.fixMissingMainTab(this.id)}getSessionId(){return this.driver.getSessionId()}}});var ry={};W(ry,{buildCodeTests:()=>Yu});async function QE(s,e,t,r,n){try{return await ey(s,e,t,r,n)}catch(o){if((o==null?void 0:o.code)==="ENOENT")return pr.compiler=null,pr.webpackConfig=null,r&&(r.data={}),await ey(s,e,t,r,n);throw o}}async function ey(s,e={mode:"development"},t=void 0,r=void 0,n=void 0){let o=await he("webpack"),i=mr.cloneDeep(e);e.externals={testim:"__testim"},e.devtool||(e.devtool="inline-source-map"),e.plugins||(e.plugins=[]),e.plugins.push(new o.DefinePlugin(ZE(t)),new o.DefinePlugin({"process.argv":JSON.stringify(process.argv)})),s=s.map(h=>ma.resolve(h));let a=s.map(()=>z(30));if(e.optimization={minimize:!1},Number(process.versions.node.split(".")[0])>=17){let h=require("crypto"),g=h.createHash;h.createHash=(y,T)=>g(y==="md4"?"sha256":y,T)}e.entry=Object.fromEntries(mr.zip(s,a).map(([h,g])=>[g,h])),e.output=Object.assign({devtoolModuleFilenameTemplate:h=>`file:///${h.absoluteResourcePath}`,filename:"[name].bundle.js"},e.output);let l;r?(mr.isEqual(pr.webpackConfig,i)&&pr.compiler||(pr.webpackConfig=i,pr.compiler=o(e)),l=pr.compiler):l=o(e);let d=r||new ty.default;l.outputFileSystem=d;let m=mt(h=>{n==null||n.addEventListener("abort",()=>{h(new je,void 0)})});try{let h=await Promise.race([mt(g=>l.run(g)),m]);if(h!=null&&h.hasErrors())throw new Error(h==null?void 0:h.toJson().errors.toString())}catch(h){let g=h.message.match(/Entry module not found: Error: Can't resolve '(.*)'/);throw g&&g.length===2?e.output&&e.output.library==="tdk"?new I(`Could not open dev-kit functions file in ${g[1]}`):new I(`Can't find test files in: '${g[1]}'`):new I(`Compilation Webpack Error in tests: ${h.message}`)}return{tests:[s.map((h,g)=>({code:d.readFileSync(ma.resolve("./dist",`${a[g]}.bundle.js`)),name:h})).map(({code:h,name:g})=>({code:h.toString(),baseUrl:"",name:ma.resolve(g),testConfig:{},testConfigId:null,testId:z(),resultId:z(),isTestsContainer:!0}))],runName:`Testim Dev Kit Run ${new Date().toLocaleString()}`}}function ZE(s){let e=mr.fromPairs(Object.keys(process.env).filter(r=>/^TDK_/i.test(r)||r==="BASE_URL").map(r=>[r,process.env[r]])),t={BASE_URL:s==null?void 0:s.baseUrl};return{"process.env":eS({...t,...e})}}function eS(s){return Object.fromEntries(Object.entries(s).map(([e,t])=>[e,JSON.stringify(t)]))}var mr,ma,ty,pr,Yu,Xu=w(()=>{"use strict";mr=E(require("lodash")),ma=E(require("path"));U();ty=E(require("memory-fs"));q();bt();pr={compiler:null,webpackConfig:null};Yu=QE});var oy={};W(oy,{compileFunctionsLibrary:()=>rd,findTestFolder:()=>Vr,findTests:()=>Qu,getLocalLocatorContents:()=>Zu,getLocalLocators:()=>$n,saveLocators:()=>td,saveTest:()=>ed});async function $n(){let s=await Vr(process.cwd()),e=Ze.join(s,"locators","locators.js");function t(n){let o=n.toString().replace("module.exports =","return").replace(/require/g,"(x => /locator.(.*).json/.exec(x)[1])");return new Function(o)()}let r=await it.promises.readFile(e).then(t,()=>({}));return Object.fromEntries(Object.keys(r).map(n=>[n.replace(/"/g,'\\"'),r[n]]))}async function Qu(s=process.cwd()){let e=await Vr(s),t=await it.promises.readdir(e,{withFileTypes:!0}),r=["webpack.config.js","tsconfig.js",".DS_Store","functions.js"],n=[".html",".json"];return t.filter(o=>!r.includes(o.name)&&!n.some(i=>o.name.endsWith(i))&&o.isFile()&&!o.name.startsWith(".")).map(o=>o.name)}async function tS(s){let e=Object.entries(s),t=e.map(([,n])=>n),r=await Promise.all(t);for(let n=0;n<r.length;n++)e[n][1]=r[n];return Object.fromEntries(e)}async function Zu(s,e=!1,t=process.cwd()){let r={};if(e){let n=await Vr(t);for(let o of Object.values(s))r[o]=it.promises.readFile(Ze.join(n,"locators",`locator.${o}.json`)).then(JSON.parse)}try{return await tS(r)}catch(n){return console.error(n),{}}}async function ed({body:s,name:e,locators:t,language:r="javascript"}){let n=await Vr(process.cwd()),o=Ze.join(n,"locators","locators.js"),i=Ze.join(n,e);if(!i.startsWith(n))throw new Error("A test name must be a valid file name and inside the tests directory");if(r==="javascript"?i.endsWith(".js")&&!i.endsWith(".test.js")?i=`${i.substr(0,i.length-3)}.test.js`:i.endsWith(".test.js")||(i+=".test.js"):i.endsWith(".ts")&&!i.endsWith(".test.ts")?i=`${i.substr(0,i.length-3)}.test.ts`:i.endsWith(".test.ts")||(i=`${i}.test.ts`),i.endsWith("locators/locators.js"))throw new Error("Cannot override locators file from the internet as it is evaluated by the runner");await it.promises.writeFile(i,s),await it.promises.mkdir(Ze.join(n,"locators")).catch(()=>{});for(let{id:l,body:d}of t)await it.promises.writeFile(Ze.join(n,"locators",`locator.${l}.json`),JSON.stringify(d));let a=Object.fromEntries(t.map(({name:l,id:d})=>[l,d])),c=await $n();Object.assign(c,a),await ny(o,c)}async function ny(s,e){let t=`module.exports = {
`;for(let[r,n]of Object.entries(e))t+=`  "${r}": require('./locator.${n}.json'),
`;t+="};",await it.promises.writeFile(s,t)}async function td(s,{mergeIntoExisting:e}={mergeIntoExisting:!1}){let t=await Vr(process.cwd()),r=Ze.join(t,"locators","locators.js");await it.promises.mkdir(Ze.join(t,"locators")).catch(()=>{});for(let{name:o,id:i,elementLocator:a}of s)await it.promises.writeFile(Ze.join(t,"locators",`locator.${i}.json`),JSON.stringify({name:o,id:i,elementLocator:a}));let n=Object.fromEntries(s.map(({name:o,id:i})=>[o,i]));if(e){let o=await $n();Object.assign(n,o)}await ny(r,n)}async function rd({fileSystem:s,bypassWebpack:e}={},t=void 0){let r=await Vr(process.cwd());if(t!=null&&t.aborted)throw new je;let n=Ze.join(r,"functions.js");if(e!=null&&e.testim){let i=require("module"),a=i.prototype.require;i.prototype.require=function(l){return l==="testim"?e.testim:a.apply(this,arguments)};try{return delete require.cache[require.resolve(n)],require(n)}finally{i.prototype.require=a}}return(await Yu([n],{output:{libraryTarget:"umd",library:"tdk",globalObject:"globalThis"},cache:{type:"memory"},mode:"development"},{},s,t)).tests[0][0].code}var sy,Ze,it,Vr,sd=w(()=>{"use strict";sy=E(require("lodash")),Ze=E(require("path")),it=require("fs");q();Xu();Vr=sy.memoize(async s=>(await it.promises.readdir(s)).includes("tests")&&(await it.promises.stat(Ze.join(s,"tests"))).isDirectory()?Ze.join(s,"tests"):s)});var iy={};W(iy,{getArgumentsFromContext:()=>qr});async function qr(s,e,t){let r=rS(s.parameterNames.map(n=>n.displayName),e.incomingParams.as);return await Promise.all(r.map(n=>typeof n=="object"&&n.locatedElement?t(n):n))}function rS(s,e){let t=[];for(let r of s){let n=e.functionParameters.indexOf(r);t.push(e.functionArguments[n])}return t}var Wn=w(()=>{"use strict"});var cy={};W(cy,{execute:()=>oS});async function iS(s,e,t,r,n,o){var a;let i;try{let{WebDriver:c}=await sS("selenium-webdriver");if(o.aborted)throw new ay;let{Executor:l,HttpClient:d}=require("selenium-webdriver/http"),m=s.driver.client.requestHandler.defaultOptions,p=s.driver.client.requestHandler.startPath,h=`${m.protocol}://${m.hostname}:${m.port}`+p,g=new d(h),y=new c(s.getSessionId(),new l(g));await aS(y,s.driver);let C=await nS(t,r,v=>y.findElement({css:v.selector})),b=e.bind(null,y,...C);return i=function(){g.send=async function(){throw new ay}},o.addEventListener("abort",i),await b(),{success:!0}}catch(c){return o.aborted?{success:!1,shouldRetry:!1,reason:"aborted"}:{success:!1,shouldRetry:!1,reason:(c==null?void 0:c.message)||c,extraInfo:(a=c==null?void 0:c.constructor)==null?void 0:a.name}}finally{i&&o.removeEventListener("abort",i)}}async function aS(s,e){if(e.cdpUrl){let t=await s.getAllWindowHandles();for(let r of t)if(await s.switchTo().window(r),await s.executeScript("return window.__isMainTestimTab"))break}}var ay,sS,nS,oS,ly=w(()=>{"use strict";({AbortError:ay}=(q(),ie(ip))),{lazyRequire:sS}=(bt(),ie(Ol)),{getArgumentsFromContext:nS}=(Wn(),ie(iy)),oS=iS});var uy={};W(uy,{execute:()=>cS});async function lS(s,e,t,r,n,o){var a;let i;try{let c=await he("puppeteer");if(o.aborted)throw new je;let l=await c.connect({browserWSEndpoint:s.driver.cdpUrl,defaultViewport:null,product:"chrome"});if(o.aborted)throw l.disconnect(),new je;i=function(){l.disconnect()},o.addEventListener("abort",i);let d=await l.pages(),m;for(let y of d)if(await y.evaluate(()=>window.__isMainTestimTab)){m=y;break}let p=m||d.at(-1),h=await qr(t,r,y=>p.$(y.selector));return await e.bind(null,p,...h)(),{success:!0}}catch(c){return o.aborted?{success:!1,shouldRetry:!1,reason:"aborted"}:{success:!1,shouldRetry:!1,reason:(c==null?void 0:c.message)||c,extraInfo:(a=c==null?void 0:c.constructor)==null?void 0:a.name}}finally{o.removeEventListener("abort",i)}}var cS,dy=w(()=>{"use strict";q();bt();Wn();cS=lS});var py={};W(py,{execute:()=>uS});async function dS(s,e,t,r,n,o){var a;let i;try{let c=await he("playwright");if(o.aborted)throw new je;let l=await c.chromium.connect({wsEndpoint:s.driver.cdpUrl});if(o.aborted)throw l.disconnect(),new je;i=function(){l.disconnect()},o.addEventListener("abort",i);let p=(await(await l.newContext({viewport:null})).pages()).at(-1),h=await qr(t,r,y=>p.$(y.selector));return await e.bind(null,p,...h)(),{success:!0}}catch(c){return o.aborted?{success:!1,shouldRetry:!1,reason:"aborted"}:{success:!1,reason:(c==null?void 0:c.message)||c,extraInfo:(a=c==null?void 0:c.constructor)==null?void 0:a.name}}finally{i&&o.removeEventListener("abort",i)}}var uS,my=w(()=>{"use strict";q();bt();Wn();uS=dS});var hy={};W(hy,{execute:()=>pS});async function mS(s,e,t,r,n,o,i,a){function c(){s.sessionPlayer.stopPlaying()}a.addEventListener("abort",c);function l(P){if(o.parameterValues){let N=o.parameterValues.find(B=>B.type==="locate"&&B.id===P.locatorId);return{elementLocator:N.elementLocator,id:N.id,name:"Hybrid Step Locator"}}return P.locatedElement.shadowPath?P.locatedElement.shadowPath[0]:P}let d=await qr(o,t,l),m=e.bind(null,...d),p=z(),f=z(),h=t.testResultId,g=t.config.baseUrl,y=fy.cloneDeep(t);y.loginData=r;let C=re().manifestVersion||"runner",b=!1,v=null,x="master",k=`Execute TDK Function '${o.functionName}'`,D=!0,S={fn:m,bypassSetup:!0,isBeforeOrAfterTest:!0,name:k,sourceCode:m.toString(),sourceName:m.name,testId:p,resultId:z()},O=typeof e.results=="boolean"&&!e.results;try{_("tdkHybridStepPlayback before addAllTabs"),n?(s.sessionPlayer.playbackAutUtils.frameManager=n,s.sessionPlayer.frameManager=n):await s.addAllTabs(null,{loadInfo:!0,checkForMainTab:!0,takeScreenshots:!O},[s.driver.initialUrl]),s.sessionPlayer.playbackManager.dontAssociateChildResult=!0,s.sessionPlayer.playbackManager.onlyLocalReporting=O,_("tdkHybridStepPlayback before playTestByCode");let P=await new Promise((N,B)=>{i==="agent"&&fS(s,N);function V(){B(new je),a.removeEventListener("abort",V)}a.addEventListener("abort",V),s.sessionPlayer.playTestByCode(p,f,h,g,y,C,N,b,v,x,[S],k,D).catch(B)});return _("tdkHybridStepPlayback after playTestByCode"),{success:P.success,shouldRetry:!1,resultInfo:{testId:p,executionId:f,resultId:S.resultId}}}catch(P){return{success:!1,error:P,shouldRetry:!1}}finally{a.removeEventListener("abort",c)}}function fS(s,e){let{commonConstants:t}=re();s.sessionPlayer.playbackManager.on(t.playback.START,({testResult:r})=>{let n=r.runnerStatus;Object.defineProperty(r,"runnerStatus",{get(){return n},set(o){n=o,o==="FINISHED"&&e(r)}})})}var fy,pS,gy=w(()=>{"use strict";fy=E(require("lodash"));Le();U();q();Wn();Ee();pS=mS});var fa={};W(fa,{abort:()=>id,execute:()=>Ns,run:()=>yS});async function Ns(s,e,t,r,n,o="cli"){let i=new by.AbortController,{signal:a}=i;od.set(e.stepResultId,i);try{_("before seleniumTestPlayer require");let{SeleniumTestPlayer:c}=(pa(),ie(Ju)),{compileFunctionsLibrary:l}=(sd(),ie(oy)),{functionName:d}=s,m={},p=!1,f=new c(e.id,m,p,Ft.CODEFUL,t);nd=f.sessionPlayer.codeSessionPlayer.proxy;let h=s.bypassWebpack?{testim:nd.wrappedSteps()}:!1;_("before compileFunctionsLibrary",{bypassWebpack:Boolean(s.bypassWebpack)});let g;try{g=await l({fileSystem:hS,bypassWebpack:h},a)}catch(T){return{success:!1,shouldRetry:!1,reason:`Unable to compile functions library. ${T.message}`,extraInfo:T.stack}}typeof globalThis>"u"&&(global.globalThis=process);let y;if(h?y=g[d]:(global.globalThis.__testim=nd.wrappedSteps(),(0,eval)(g),y=globalThis.tdk[d]),_("after hybridFunction obtain and eval"),!y)return{success:!1,shouldRetry:!1,reason:`Could not find function '${d}' locally. Please make sure you have a functions.js file with a '${d}' function defined`,extraInfo:Object.keys(globalThis.tdk)};if(y.type==="selenium"){let T=(ly(),ie(cy)).execute;return await T(f,y,s,e,o,a)}if(y.type==="puppeteer"){if(!f.driver.cdpUrl)return{success:!1,shouldRetry:!1,reason:"running puppeteer code requires the remote debugging protocol to be open. Please contact Testim support."};_("before puppeteerPlayback");let T=(dy(),ie(uy)).execute;try{return await T(f,y,s,e,o,a)}finally{_("after puppeteerPlayback")}}if(y.type==="playwright"){if(!f.driver.cdpUrl)return{success:!1,shouldRetry:!1,reason:"running playwright code requires the remote debugging protocol to be open. Please contact Testim support."};let T=(my(),ie(py)).execute;return await T(f,y,s,e,o,a)}if(y.type==="tdk"||!y.type){let T=(gy(),ie(hy)).execute;_("before tdkPlayback");try{return await T(f,y,e,r,n,s,o,a)}finally{_("after tdkPlayback")}}return{success:!1,shouldRetry:!1,reason:`unknown hybrid format ${y.type}`}}catch(c){gS.info("error running hybrid step",{err:c});return}finally{od.delete(e.stepResultId)}}function id(s){let e=od.get(s);if(e)e.abort();else throw new Error("No such stepResultId")}var yy,by,hS,gS,od,nd,yS,ia=w(()=>{"use strict";yy=E(require("memory-fs"));Le();by=require("abort-controller");j();ae();hS=new yy.default,gS=R("hybrid-step-playback"),od=new Map,yS=(s,e,t,r)=>{let{step:n,context:o}=e.data;return Ns(n,o,s,r.loginData)}});var ad={};W(ad,{run:()=>bS});var bS,wy=w(()=>{"use strict";U();jr();q();bS=async(s,e)=>{let{stepId:t,testResultId:r,retryIndex:n,stepResultId:o,packageData:i,timeout:a}=e.data;try{return{data:await Is(t,r,n,i,o,a),success:!0}}catch(c){if(c instanceof pt)return{success:!1,code:"invalid-node-package",message:c.message};if(c instanceof J)return{success:!1,code:"timeout"};throw c}}});async function vy(s,e,t,r){try{return await ol(s,e,t,r)}catch{ha.error("failed to report remote step state",{projectId:s,resultId:e,stepId:t});return}}async function TS(s,e,t,r,n){return ha.info("finished to run remote step",{stepId:t,sessionId:n}),await vy(s,e,t,{status:"completed",success:!0,failureReason:null,data:r})}async function Ty(s,e,t,r,n){return ha.info("failed to run remote step",{stepId:t,sessionId:n,failureReason:r}),await vy(s,e,t,{status:"completed",success:!1,failureReason:r})}async function Ey(s,e,t,r){if(!(t!=null&&t.type)||t.status==="completed")return;let{project:n,projectData:o,userData:i}=s,a=t.type,c=e.getSessionId(),l=t.id;ha.info("start play remote step",{stepType:a,stepId:l,sessionId:c});let d=wS[a];if(!d)return await Ty(n,r,l,`Failed to find step type ${a}`,c);try{let m=await d.run(e,t,o,i);return await TS(n,r,l,m,c)}catch(m){return await Ty(n,r,l,m.message,c)}}var ha,wS,Sy=w(()=>{"use strict";_h();ia();Te();wy();j();ha=R("step-playback"),wS={"cli-validation-code-step":ar,"cli-wait-for-code-step":ar,"cli-action-code-step":ar,"cli-api-code-step":ar,"cli-condition-step":ar,"cli-download-code-step":ar,"node-package":ad,"tdk-hybrid":fa}});var Ry={};W(Ry,{remoteStepServiceSocketIO:()=>ES});var cd,ES,Iy=w(()=>{"use strict";Ui();cd=class extends cr{constructor(){super(...arguments);this.listerers={}}init(t){super.init(t,"remoteStep"),this.listerers={}}emitJoinRoom(t){return this.emitPromise("remoteStep:join",{resultId:t})}emitLeaveRoom(t){return this.emitPromise("remoteStep:leave",{resultId:t})}async joinToRemoteStep(t){this.rooms[t]||(this.joinRoom(t),await this.emitJoinRoom(t))}listenToRemoteStep(t,r){this.listerers[t]&&(this._socket.off("remoteStep:saved",this.listerers[t]),delete this.listerers[t]),this.listerers[t]=n=>{n.resultId===t&&n.remoteStep&&n.remoteStep.status==="pending"&&r(n.remoteStep)},this._socket.on("remoteStep:saved",this.listerers[t])}async unlistenToRemoteStep(t){this.listerers[t]&&(this.leaveRoom(t),this._socket.off("remoteStep:saved",this.listerers[t]),delete this.listerers[t],await this.emitLeaveRoom(t))}},ES=new cd});var xy={};W(xy,{remoteStepService:()=>Us});var ld,Gn,ud,Us,ga=w(()=>{"use strict";Ln();ae();ye();({REMOTE_STEP_SAVED:ld}=rt),ud=class{async init(e){M.flags.useNewWSCLI.isEnabled()||(Gn=(await Promise.resolve().then(()=>(Iy(),Ry))).remoteStepServiceSocketIO,Gn.init(e))}joinToRemoteStep(e){return M.flags.useNewWSCLI.isEnabled()?$e.addFilter(`${e}:remoteStep`,{resultId:e},[ld]):Gn.joinToRemoteStep(e)}listenToRemoteStep(e,t){if(M.flags.useNewWSCLI.isEnabled()){$e.listenTo(`${e}:remoteStep`,[ld],r=>r.resultId===e&&r.remoteStep&&r.remoteStep.status==="pending",r=>t(r.remoteStep));return}Gn.listenToRemoteStep(e,t)}unlistenToRemoteStep(e){return M.flags.useNewWSCLI.isEnabled()?($e.removeFilter(`${e}:remoteStep`,[ld]),Promise.resolve()):Gn.unlistenToRemoteStep(e)}},Us=new ud});var Cy,Ay,ky,Se,SS,_y,Py,ya,Oy=w(()=>{"use strict";Cy=E(require("lodash"));U();le();Le();hs();xt();Te();Sy();Ay=E(require("p-retry")),ky=require("url");j();Xo();Es();ae();ga();Os();ye();Se=R("test-run-handler"),SS=3,_y=20*1e3,Py=s=>JSON.stringify(s).length<_y,ya=class{constructor(e,t,r,n,o,i){this._executionId=e;this._executionName=t;this._options=n;this._branch=o;this._testRunStatus=i;this.seleniumPerfStats=new Vt;this._totalRetryCount=1;this._retryCount=1;this._timeoutRetryCount=1;this.clearTestResultFinished=Promise.resolve(void 0);var c,l;this._testStatus=r.testStatus,this._testId=r.testId,this._testName=r.name,this._testResultId=r.resultId,this._code=r.code,this._baseUrl=n.baseUrl||r.baseUrl||r.testConfig.baseUrl,this._nativeApp=r.nativeApp,this._overrideTestConfigId=(c=r.overrideTestConfig)==null?void 0:c.id,this._maxRetryCount=n.retries,this._remoteRunId=n.remoteRunId;let a=!((l=r.runConfig)!=null&&l.isMobileWeb)&&n.browser;this._runConfig=a?sn(n.browser,n.saucelabs,n.browserstack):r.runConfig}async waitForExecutionStartedFinished(){return await this._testRunStatus.waitForExecutionStartedFinished(),await this.clearTestResultFinished}get testStatus(){return this._testStatus}get runMode(){return this._options.mode}get automationMode(){return this._code?"codeful":"codeless"}get code(){return this._code}get runConfig(){return this._runConfig}get testResultId(){return this._testResultId}get baseUrl(){return this._baseUrl}set baseUrl(e){this._baseUrl=e}get executionId(){return this._executionId}get executionName(){return this._executionName}get androidActivityWait(){var n;let e=this._nativeApp&&"appMetadata"in this._nativeApp?this._nativeApp.appMetadata:this._nativeApp;if((n=e==null?void 0:e.activity)!=null&&n.includes(e.id))return`${e.id}.*`;let{activity:t}=e,r=t.split(".").pop();return t.replace(r,"*")}get isFFAllowAppFromDeviceEnabled(){return M.flags.allowAppFromDeviceRuns.isEnabled()}get isAppFromDevice(){return Zs(this._nativeApp)}get isAppForIosVirtualDevice(){return ns(this._nativeApp)}get getAppSource(){if(this._nativeApp)return this.isAppFromDevice?po.FROM_DEVICE:po.FROM_LIBRARY}get nativeAppLink(){let e=null;return this._nativeApp&&"filePath"in this._nativeApp&&(e=`${ge}/storage${this._nativeApp.filePath}?access_token=${this._options.authData.token}`),e}async getNativeAppData(){let{appId:e,baseUrl:t}=this._options;if(t&&!this._nativeApp&&!e){let r=t||this.baseUrl;if(!r)return null;let[n,o]=r.split(":");return{packageName:n,activity:o}}return this._nativeApp&&!e?"appMetadata"in this._nativeApp?this._nativeApp.appMetadata:this._nativeApp:null}get branch(){return this._branch}get sfdcCredential(){return this._options.sfdcCredential}get remoteRunId(){return this._remoteRunId}get overrideTestConfigId(){return this._overrideTestConfigId}markClearBrowser(){this.clearBrowser=!0}async getRunRequestParams(){var r,n;let t={tokenV3:await Xt(),refreshToken:Lo(),projectId:this._options.project,executionId:this._executionId,executionName:this._executionName,testId:this._testId,resultId:this._testResultId,baseUrl:this._baseUrl,branch:this._branch,servicesUrl:Yd,remoteRunId:this.remoteRunId,previousTestResultId:this.previousTestResultId,testRetryCount:this.retryCount,...this.code&&{isCodeMode:!0,testName:this.testName},...this._options.shouldMonitorPerformance&&{shouldMonitorPerformance:!0},...this._options.company&&{companyId:this._options.company.companyId,onprem:this._options.company.onprem,storageBaseUrl:this._options.company.storageBaseUrl,storageType:this._options.company.storageType,planType:this._options.company.planType,isPOC:this._options.company.isPOC,isStartUp:this._options.company.isStartUp},...this._options.collectCodeCoverage&&{codeCoverageUrlFilter:this._options.codeCoverageUrlFilter||`${this.baseUrl}*`},...this._options.disableMockNetwork&&{disableMockNetwork:this._options.disableMockNetwork},...this._options.lightweightMode&&{lightweightMode:this._options.lightweightMode},...this.clearBrowser&&{clearBrowser:!0},...this._options.localRCASaver&&{localRCASaver:this._options.localRCASaver},...this.sfdcCredential&&{sfdcCredential:this.sfdcCredential}};if(this._options.disableMockNetwork&&gt("user-disable-mock"),t.lightweightMode&&((r=this._options.lightweightMode)!=null&&r.general)){Object.assign(t,{company:this._options.company});let o=this.runData,i=Py(o);Object.assign(t.lightweightMode,{isRunDataSentInUrl:i});let a=JSON.stringify(o).length,c=this.testId;i?(Object.assign(t,{runData:o}),Se.info(`Run data sent as URL param, test id: ${c} run data length: ${a}`)):Se.warn(`Run data is too big to be sent as a URL param. Test id: ${c}, run data size: ${a} (limit: ${_y} characters)`),Object.assign(t,{isLocalRun:Boolean(this._options.useLocalChromeDriver||this._options.useChromeLauncher)})}if((n=this._options.lightweightMode)!=null&&n.preloadTests&&this._options.useChromeLauncher){let o=await vn(this._options);Object.assign(t,{preloadedTest:o[t.testId]})}return t}async getRunTestUrl(){let e=await this.getRunRequestParams(),t=`https://run.testim.io/?params=${encodeURIComponent(JSON.stringify(e))}`;return Se.info(`Test (${this.testId}) run URL length: ${t.length}`),t}set sessionId(e){this._sessionId=e}get sessionId(){return this._sessionId}get testId(){return this._testId}get testName(){return this._testName}get runParams(){var e;return((e=this._options.runParams)==null?void 0:e[this._testResultId])||{}}get runData(){return{userParamsData:this.runParams,overrideTestConfigId:this._overrideTestConfigId||null}}async clearTestResult(){var o;let e={...this.runData,...this.runMode===X.EXTENSION&&{code:this.code},...this._options.mockNetworkRules&&{mockNetworkRules:this._options.mockNetworkRules}},t=this._timeoutRetryCount>1||this._retryCount>1;if((o=this._options.lightweightMode)!=null&&o.disableResults&&!t&&Py(e))return;let r=async()=>{try{return await il(this._options.project,this._testId,this._testResultId,e)}catch(i){return Se.error("failed to upload run data artifact (runner)",{err:i}),""}},n=async()=>{let i=await r();return await this._testRunStatus.waitForExecutionStartedFinished(),nl(this._options.project,this._testResultId,this._testId,{name:this._testName,resultId:this._testResultId,status:"pending",retryCount:this._retryCount,runDataUrl:i,runData:i?void 0:e,testRetryKey:this.retryKey})};return this.clearTestResultFinished=n(),this.clearTestResultFinished}hasMoreRetries(){return this._retryCount<this._maxRetryCount}get retryKey(){return`${this._retryCount}:${this._timeoutRetryCount}`}startNewRetry(){return this._retryCount++,this._timeoutRetryCount=1,this.onRetry()}async runTestUsingCDP(e){_("runTestUsingCDP");let{targetInfos:t}=await e.cdpCommand("Target.getTargets")||{targetInfos:[]},{targetId:r}=t.find(o=>o.type==="background_page"&&o.title==="Testim Editor")||{},{targetId:n}=t.find(o=>o.type==="page")||{};if(!r)throw new Error("testim extension not found");if(!n)throw new Error("AUT target not found");try{_("before Target.attachToTarget");let[o,i]=await Promise.all([e.cdpCommand("Target.attachToTarget",{targetId:r,flatten:!0}),this.getRunRequestParams()]),{sessionId:a}=o||{};_("before Runtime.evaluate"),await(0,Ay.default)(async()=>{let{result:l}=await e.cdpCommand("Runtime.evaluate",{expression:"typeof runTestimTest !== 'undefined'",returnByValue:!0},a);if(!l.value)throw new Error("runTestimTest not available on global scope")},{retries:100,minTimeout:30,factor:1}),_("after wait for runTestimTest function");let{result:c}=await e.cdpCommand("Runtime.evaluate",{expression:`runTestimTest(${JSON.stringify(i)})`,awaitPromise:!0,returnByValue:!0},a);if(c.subtype==="error")throw new Error(c.description);return _("after Runtime.evaluate"),c.value}catch(o){throw Se.error("error running test using CDP",{err:o}),new Error("Error running test using CDP")}}isRetryKeyMismatch(e){return e.testRetryKey&&e.testRetryKey!==this.retryKey}validateRunConfig(){let{baseUrl:e,runConfig:{browserValue:t}}=this;if(e&&t==="safari"){let r;try{r=new ky.URL(e)}catch{return}let{username:n,password:o}=r;if(n||o)throw new Error("Basic authentication in URL is not supported in Safari")}}onStarted(e){return new Promise(t=>{let r=!1,n=o=>{if(!r){if(this.isRetryKeyMismatch(o)){Se.warn(`ignoring result update for on started due to retry key mismatch, got ${o.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId});return}["running","completed"].includes(o.status)&&(o.resultId=this.testResultId,o.status==="completed"&&(Se.info("setting _wasCompletedOnStartedCheck to true",{testResult:o,resultId:this.testResultId,testId:this.testId,testRetryKey:this.retryKey}),this._wasCompletedOnStartedCheck=o),r=!0,t(o))}};if(this._options.disableSockets){let o=Date.now()+e,i=async()=>{if(Date.now()>o)return;let{testId:a,testResultId:c,branch:l,_options:{project:d}}=this;try{let m=await _r(a,c,d,l);n(m),r||setTimeout(i,3e3)}catch(m){Se.error("failed to check if done",{err:m}),setTimeout(i,3e3)}};setTimeout(i,3e3)}else Qe.listenToTestResult(this._testResultId,this._testId,n)})}async checkViaRestAPIIfTestStarted(){let{testId:e,testResultId:t,_options:{project:r},branch:n}=this;try{let o=await _r(e,t,r,n),i=["running","completed"];if(i.includes(o.status))return Se.info(`get status: ${o.status} after not get test started status`,{testId:e,testResultId:t,branch:n}),o;throw Se.error(`test not start test status: ${o.status} (expected [${i.join(", ")}])`,{testId:e,testResultId:t,branch:n}),new Error(Be.TEST_START_TIMEOUT_MSG)}catch(o){throw Se.error("failed to get test result after test start timeout",{err:o,testId:e,testResultId:t,branch:n}),new Error(Be.TEST_START_TIMEOUT_MSG)}}async onCompletedCleanup(){if(!this._options.disableSockets)return await Qe.leaveTestResult(this._testResultId,this._testId)}async onCompleted(){let e;try{let t=await new Promise(r=>{if(this._wasCompletedOnStartedCheck&&!this.isRetryKeyMismatch(this._wasCompletedOnStartedCheck)){Se.info("test was already completed in on started check",{resultId:this.testResultId,testId:this.testId}),r(this._wasCompletedOnStartedCheck);return}this._options.disableSockets||Qe.listenToTestResult(this._testResultId,this._testId,i=>{if(this.isRetryKeyMismatch(i)){Se.warn(`ignoring result update for on completed due to retry key mismatch, got ${i.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId});return}i.status==="completed"&&(i.resultId=this._testResultId,r(i))});let n=this._options.disableSockets?0:Math.floor(1e4+Math.random()*5e3),o=this._options.disableSockets?0:Math.floor(6e4+Math.random()*15e3);if(e=Cy.debounce(async()=>{try{let i=await _r(this._testId,this._testResultId,this._options.project,this.branch);return this.isRetryKeyMismatch(i)?(Se.warn(`ignoring result update for on completed (in reconnect) due to retry key mismatch, got ${i.testRetryKey}, current is ${this.retryKey}`,{resultId:this.testResultId,testId:this.testId}),!1):(i==null?void 0:i.status)==="completed"?(Se.info("Socket reconnected - Test complete",{testId:this._testId,resultId:this._testResultId,projectId:this._options.project}),i.resultId=this._testResultId,r(i),!0):!1}catch(i){return Se.warn("Error while trying to check status on socket connect",i),!1}},n,{maxWait:o}),!this._options.disableSockets)Qe.on("socket-connected",e);else{let i=()=>{setTimeout(async()=>{try{let{isComplete:a}=await Kc(this._testResultId,this._options.project,this.retryKey);a?await e()||(Se.warn("onConnected returned false even though isComplete was true"),i()):i()}catch(a){Se.error("failed to check is complete",{err:a}),i()}},3e3)};i()}});return await this.onCompletedCleanup(),t}finally{e&&!this._options.disableSockets&&Qe.off("socket-connected",e)}}listenToRemoteStep(e){Us.listenToRemoteStep(this.testResultId,t=>{Ey(this._options,e,t,this.testResultId)})}hasMoreTimeoutRetries(){let e=this._options.disableTimeoutRetry?1:SS;return this._timeoutRetryCount<e}startNewTimeoutRetry(){return this._timeoutRetryCount++,this.onRetry()}get retryCount(){return this._retryCount}get previousTestResultId(){return this._previousTestResultId}isAllowReportTestResultRetries(){var e,t,r;return Boolean((r=(t=(e=this._options.company)==null?void 0:e.activePlan)==null?void 0:t.premiumFeatures)==null?void 0:r.allowReportTestResultRetries)}async onRetry(){var e;this._previousTestResultId=this.testResultId,this.isAllowReportTestResultRetries()&&(this._totalRetryCount++,this._originalTestResultId||(this._originalTestResultId=this._previousTestResultId),this._testResultId=z(),!((e=this._options.lightweightMode)!=null&&e.onlyTestIdsNoSuite)&&await this._testRunStatus.addRetryTestResult({retryCount:this._totalRetryCount,executionId:this._executionId,projectId:this._options.project,newResultId:this._testResultId,originalTestResultId:this._originalTestResultId,previousTestResultId:this._previousTestResultId}))}}});var ba,Ly=w(()=>{"use strict";Oy();ba=class{constructor(e,t,r,n,o,i){this._waitingTests=r.map(a=>new ya(e,t,a,n,o,i))}stop(){this._waitingTests=[]}getNext(){let e=this._waitingTests.shift();if(e)return e}hasMoreTests(){return Boolean(this._waitingTests.length)}}});var RS,IS,Vn,dd=w(()=>{"use strict";Ts();j();RS=R("worker-utils"),IS=async(s,e,t)=>{e&&await Vl(s,t)},Vn=async(s,e,t,r)=>{RS.info("releasing player",{hasPlayer:Boolean(r)});try{await(r==null?void 0:r.onDone())}finally{await IS(s,e,t)}}});function OS(s,e,t,r){return{testId:s,reason:r,name:e,resultId:t,success:!1}}var fd,My,md,kt,xS,Ny,Dy,wa,PS,pd,CS,Ht,AS,kS,_S,_t,Ta=w(()=>{"use strict";fd=E(require("ms")),My=E(require("moment")),md=E(require("p-retry"));U();Le();Ts();Te();j();dd();Gt();si();ye();ga();Os();It();ae();q();kt=R("base-worker"),{GET_BROWSER_TIMEOUT_MSG:xS,TEST_START_TIMEOUT_MSG:Ny,TEST_COMPLETE_TIMEOUT_MSG:Dy}=Be,{SETUP_TIMEOUT:wa,NETWORK_ERROR:PS,GRID_ERROR:pd,BROWSER_CLOSED:CS,SELENIUM_ERROR:Ht,UNKNOWN_ERROR:AS}=Ys,kS=(0,fd.default)("1s"),_S=1;_t=class{constructor(e,t,r,n,o,i,a,c,l=!0){this.executionQueue=e;this.options=t;this.customExtensionLocalLocation=r;this.executionId=n;this.onTestStarted=o;this.onTestCompleted=i;this.onGridSlot=a;this.onTestIgnored=c;this.releaseSlotOnTestFinished=l;this.id=_t.getWorkerId();this.lambdatestService=new ee;this.isCodeMode=t.files&&t.files.length>0,this.baseUrl=t.baseUrl,this.testRunTimeout=t.timeout,this.isRegressionBaselineRun=t.isRegressionBaselineRun,this.userData=t.userData}static getWorkerId(){return _S++}async getGridSlot(e,t){let r=await Cf(e,t.executionId,this.options,this.id);return this.onGridSlot(t.testResultId,r),r}async getSlotOnce(e){let{browserValue:t}=this.testRunConfig;return Q.onGetSlot(this.id,t||"chrome"),await this.getGridSlot(t,e)}initPlayer(e){throw new ts(!0)}async getBrowserOnce(e,t,r,n){throw new ts(!0)}async runTestOnce(e,t){return e.sessionId=t.getSessionId(),kt.info("Test run started",{testId:e.testId,resultId:e.testResultId,seleniumSession:t.getSessionId()}),await e.clearTestResult()}handleQuarantine(e){if(!Je({testStatus:e.testStatus},this.options))return;let t={name:e.testName,testId:e.testId,resultId:e.testResultId,runnerStatus:pe.SKIPPED,testStatus:e.testStatus};return this.onTestIgnored(this.id,t),t}handleMobileTest(e){let t=!e.isFFAllowAppFromDeviceEnabled&&e.isAppFromDevice,r=e.isAppForIosVirtualDevice;if(t||r){let n={name:e.testName,testId:e.testId,resultId:e.testResultId,runnerStatus:pe.SKIPPED,testStatus:e.testStatus,mobile:{isAppFromDevice:t,isAppForIosVirtualDevice:r}};return this.onTestIgnored(this.id,n),n}}setSessionTimeout(){return this.options.mode===X.APPIUM?Math.max((0,fd.default)("180s"),this.options.getSessionTimeout):Math.max(this.lambdatestService.getSessionTimeout||0,this.options.getSessionTimeout)}async getTestPlayer(e,t){var o;let r=(o=this.userData)==null?void 0:o.projectId,n;try{_("before getSlotOnce retries");let i=0,a=await(0,md.default)(async()=>{let d=Date.now();try{return await te(this.getSlotOnce(e),this.options.getBrowserTimeout,Be.GET_BROWSER_TIMEOUT_MSG)}catch(m){let p={testId:this.testId,testResultId:this.testResultId,executionId:this.executionId};throw m instanceof yr?kt.info("could not get grid slot due to concurrency issue",p):kt.error("error getting grid slot",{error:m,...p}),i++,await se(this.options.getBrowserTimeout-(Date.now()-d)),m}},{retries:this.options.getBrowserRetries-1,minTimeout:0,factor:1});_("after getSlotOnce retries"),_("before getBrowserOnce retries");let c=this.options.getBrowserRetries-i;if(!c)throw new Error("No free browser slots in desired grid");let l=0;n=await(0,md.default)(async()=>{let d=Date.now(),m=this.initPlayer(e);try{a=await Af(this.options,a,this.testRunConfig,this.lambdatestService,{maxRetries:c,currentRetry:l+1}),this.options.gridData.provider=a.provider,this.options.gridData.host=a.host,this.options.gridData.failedGetBrowserAttempts=l;let p=this.setSessionTimeout();_("before getBrowserOnce");let f=await te(this.getBrowserOnce(e,t,m,a),p,Be.GET_BROWSER_TIMEOUT_MSG);return _("after getBrowserOnce"),Q.onGetBrowserSuccess(this.id,r),m||f}catch(p){let f={provider:a.provider,host:a.host,failedGetBrowserAttempts:l,id:this.options.gridData.gridId,type:a.type},h=this.options.mode===X.APPIUM?"device":"browser";throw kt.error(`error getting ${h} from grid`,{error:p,testId:this.testId,testResultId:this.testResultId,executionId:this.executionId,grid:f}),Q.onGetBrowserFailure(this.id,r,++l),m.onDone(),p instanceof ut||await se(this.options.getBrowserTimeout-(Date.now()-d)),p}},{retries:c-1,minTimeout:0,factor:1}),_("after getBrowserOnce retries")}catch(i){throw await Vn(this.id,this.releaseSlotOnTestFinished,r,n),i instanceof ut?i:i instanceof dt?new zt(i,pd):new zt(i,Ht)}return n}async runTest(e,t,r){var d;_("inside runTest");let n=(d=this.userData)==null?void 0:d.projectId,o=this.handleQuarantine(e);if(o)return o;let i=en(this.options)&&this.handleMobileTest(e);if(i)return i;_("before runTest onTestStarted");let a=e.getAppSource,c=await this.onTestStarted(this.id,e.testId,e.testResultId,r,e.retryKey,a);e.baseUrl=c.config.baseUrl;let l=await this.getTestPlayer(e,t);try{return await this.runTestOnce(e,l)}finally{await Vn(this.id,this.releaseSlotOnTestFinished,n,l)}}async runTestCleanup(){}async onQueueCompleted(){}run(){var m,p;let e=()=>process.nextTick(()=>this.run()),t=async(f,h,g)=>{var x;if(Je(f,this.options)||!h.isFFAllowAppFromDeviceEnabled&&h.isAppFromDevice||h.isAppForIosVirtualDevice)return e();let y=h.sessionId,T=k=>g==null?void 0:g.message.includes(k),C=g&&g instanceof zt,b=g&&(T(Ny)||T(Dy)),v=!f.success&&(h.hasMoreRetries()&&!C&&!b||b&&h.hasMoreTimeoutRetries());try{let k=h.retryKey;f.testRetryKey=k;let D=h.getAppSource;return await this.onTestCompleted(this.id,this.testId,f,y,v,D),this.executionQueue.hasMoreTests()&&!((x=this.options.lightweightMode)!=null&&x.general)&&await se(kS),await this.runTestCleanup(),v?(b?await h.startNewTimeoutRetry():await h.startNewRetry(),kt.info(`retry test id: ${this.testId} name: ${this.testName} again`,{testId:this.testId,testName:this.testName,isTimeoutErrors:b,testRetryKey:k,totalRetries:h._totalRetryCount}),this.testResultId=h.testResultId,await l(h,v)):await e()}catch(k){if(k instanceof Nt)return;kt.error("failed to process test result",{error:k}),e();return}},r=()=>`Due to network connectivity issues, Testim CLI has been unable to connect to the grid.
Please make sure the CLI has stable access to the internet. ${cc()?"(Internal: network connectivity test failed)":""}`,n=(f,h)=>{let g=this.options.mode===X.APPIUM?"device":"browser";if(!h&&M.flags.errorMessageOnBadNetwork.isEnabled())return{errorType:PS,reason:r()};let y=f instanceof Error?f.message:f;if(y.includes(xS))return{errorType:wa,reason:`Test couldn't get ${g}`};if(y.includes(Ny))return{errorType:wa,reason:"Test couldn't be started"};if(y.includes(Dy)){if(!this.testRunTimeout)return{errorType:wa,reason:"Test timeout reached: test is too long"};let T=My.default.duration(this.testRunTimeout,"milliseconds"),C=Math.floor(T.asMinutes()),b=T.seconds(),v=C>0?` ${C} min`:"",x=b>0?` ${b} sec`:"";return{errorType:wa,reason:`Test timeout reached (timeout:${v}${x}): test is too long`}}if(f instanceof zt&&f.type){if(f.type===pd)return{errorType:pd,reason:`Test couldn't get ${g} from grid - ${f.message}`};if(f.type===Ht)return{errorType:Ht,reason:`Failed to create new session - ${f.message}`}}return"type"in f&&f.type===CS?{errorType:Ht,reason:"Session terminated, it is possible that the cli could not connect to the grid to send keep-alive requests for a prolonged period"}:"failure"in f&&f.failure instanceof Lt?{errorType:Ht,reason:`Test couldn't get ${g} from grid - ${f.failure.message}`}:/SeleniumError: connect ECONNREFUSED/.test(f.message)||/Couldn't connect to selenium server/.test(f.message)?{errorType:Ht,reason:"Failed to connect to the grid, please check if the grid is accessible from your network"}:/terminated due to FORWARDING_TO_NODE_FAILED/.test(f.message)?{errorType:Ht,reason:"Session terminated, it is likely that the grid is out of memory or not responding, please try to rerun the test"}:/terminated due to PROXY_REREGISTRATION/.test(f.message)?{errorType:Ht,reason:"Session terminated, it is likely that the grid is not responding, please try to rerun the test"}:/forwarding the new session cannot find : Capabilities/.test(f.message)?{errorType:Ht,reason:`Session could not be created, please check that the ${g} you requested is supported in your plan`}:{errorType:AS,reason:y}},o=async(f,h)=>{var b;let g=await ac();!g&&M.flags.warnOnBadNetwork.isEnabled()&&console.warn(r()),kt.warn("error on run",{err:f});let y=(b=this.userData)==null?void 0:b.projectId,{errorType:T,reason:C}=n(f,g);sl(y,this.testResultId,this.testId,{status:Js.COMPLETED,success:!1,reason:C,errorType:T,testRetryKey:h.retryKey,setupStepResult:{status:Js.COMPLETED,success:!1,reason:C,errorType:T}},h.remoteRunId),await t(OS(this.testId,this.testName,this.testResultId,C),h,f)},i=async(f,h)=>{var b;let g=this.testId,y=this.testResultId,T=(b=this.userData)==null?void 0:b.projectId,C=this.branch;if(!g||!y||!T||!C)return kt.warn("Test failed. Not enough data to recover results via API",{err:f}),o(f,h);try{let v=await _r(g,y,T,C);if(kt.warn("Test failed. Got results via API",{err:f,testResult:v}),v&&v.status===Js.COMPLETED)return await t(v,h);throw f}catch(v){return v!==f&&kt.error("Failed to fetch test results from server",{testId:g,resultId:y,projectId:T,branch:C,err:v}),o(f,h)}},a=this.options.disableSockets||((m=this.options.lightweightMode)==null?void 0:m.disableResults)&&(this.options.useChromeLauncher||this.options.mode!=="extension"),c=this.options.disableSockets||((p=this.options.lightweightMode)==null?void 0:p.disableRemoteStep),l=async(f,h)=>{try{await Promise.all([!c&&Us.joinToRemoteStep(this.testResultId),!a&&Qe.joinToTestResult(this.testResultId,this.testId)]),f.validateRunConfig();let g=await this.runTest(f,this.customExtensionLocalLocation,h),y=await t(g,f);return _("After onRunComplete"),y}catch(g){return i(g,f)}finally{c||Us.unlistenToRemoteStep(this.testResultId)}},d=this.executionQueue.getNext();return d?(this.testId=d.testId,this.testName=d.testName,this.testResultId=d.testResultId,this.overrideTestConfigId=d.overrideTestConfigId,this.testRunConfig=d.runConfig,this.branch=d.branch,l(d)):this.onQueueCompleted()}}});var Fy={};W(Fy,{WorkerSelenium:()=>hd});function NS(s){let{playback:e}=re().commonConstants;function t(r){s.playbackManager.on(r,()=>{_(`Got event ${r}`)})}Object.values(e).forEach(t)}var va,LS,hd,Uy=w(()=>{"use strict";U();Le();Ta();j();Gt();q();Xo();ae();Au();pa();Ee();va=R("worker-selenium"),LS=1e9,hd=class extends _t{initPlayer(t){return new Bn(this.id,t.runParams,this.options.shouldMonitorPerformance,t.automationMode,void 0,t.retryCount,t.previousTestResultId)}async getBrowserOnce(t,r,n,o){_("in WorkerSelenium getBrowserOnce"),Q.onGetSession(this.id,this.testName,t.runMode);let{driver:i}=n;this.windowUtils=new As(this.id,i),n.clearSessionTabs();let{browserValue:a}=this.testRunConfig,c=t.baseUrl;try{let l=this.options.useLocalChromeDriver;await i.init(this.options,this.testName,this.testRunConfig,o,r,this.executionId,this.testResultId,t.seleniumPerfStats,l,this.lambdatestService),_("in WorkerSelenium after driver.init"),await n.addTab(void 0,{skipLoadInfo:l}),_("in WorkerSelenium after addTab"),l||await this.windowUtils.navigate(c,LS),await this.windowUtils.validatePageIsAvailable(),_("in WorkerSelenium after navigate")}catch(l){let d=l.message&&(l.message.startsWith("Malformed URL")||l.message.includes("Reached error page: about:neterror"))&&a==="firefox",m=l.message&&l.message==="invalid argument";throw l instanceof ut||d||m?new ut(`Page '${c}' is not available`):(va.error("failed to navigate to page",{err:l}),l)}}async runTestOnce(t,r){var d;let n=re(),{driver:o,sessionPlayer:i}=r,a=n.manifestVersion||"runner";Q.onWaitToTestComplete(this.id,this.isCodeMode),NS(i),i.playbackManager.executionId=t.executionId,i.playbackManager.executionName=t.executionName,i.setLightweightMode(this.options.lightweightMode),t.sfdcCredential&&i.setSfdcCredential(t.sfdcCredential),n.localAssetService&&n.localAssetService.initialize({serverUrl:this.options.localRCASaver});let c=null;(d=this.options.lightweightMode)!=null&&d.preloadTests&&(c=(await vn(this.options))[this.testId]);let l=async()=>{if(t.automationMode==="codeful"){i.callOrderScheduler?i.callOrderScheduler.schedule(()=>t.waitForExecutionStartedFinished(),{key:`test-result:${this.userData.projectId}:${this.testResultId}`}):await t.waitForExecutionStartedFinished(),_("right before playTestByCode");let p=new Promise((f,h)=>{i.playTestByCode(this.testId,this.executionId,this.testResultId,this.baseUrl,this.userData,a,f,!1,this.overrideTestConfigId,this.branch,t.code,t.testName).catch(h)});return te(p.then(f=>(_("right after playTestByCode"),f)),this.testRunTimeout,Be.TEST_COMPLETE_TIMEOUT_MSG).catch(f=>{var h;throw f instanceof J&&((h=i.stopPlayingOnTestTimeout)==null||h.call(i)),f}).then(f=>(f.resultId=this.testResultId,f))}let m=!1;return te(new Promise((p,f)=>{i.playByTestId(this.testId,this.executionId,this.testResultId,this.baseUrl,this.userData,a,p,!1,this.overrideTestConfigId,this.branch,m,t.remoteRunId,void 0,void 0,c).catch(f)}),this.testRunTimeout,Be.TEST_COMPLETE_TIMEOUT_MSG).catch(p=>{var f;throw p instanceof J&&((f=i.stopPlayingOnTestTimeout)==null||f.call(i)),p}).then(async p=>{n.localAssetService&&await n.localAssetService.drain(),p.stepsResults=null,p.resultId=this.testResultId,o.isAlive()||(va.warn(`possible grid unresponsive for test ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),p.gridIssues="could not validate grid is alive");let f=o.maxKeepAliveGap();f>=3e4&&(va.warn(`possible browser keep alive issue ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),p.keepAliveIssue=f);let g={...p,...t.seleniumPerfStats.getStats()};return this.lambdatestService.isLambdatestRun()&&await o.executeJS(`lambda-status=${g.success?"passed":"failed"}`).catch(()=>{}),g})};o.start(),_("right before super.runTestOnce in workerSelenium");try{await super.runTestOnce(t,r),_("right after super.runTestOnce in workerSelenium");let m=await l();return _("right after runSeleniumTest"),m}catch(m){throw va.error("failed to run test once",{err:m}),m}}}});var Ea,jy=w(()=>{"use strict";Ea=class{constructor(e){this.driver=e,this._utils={},this.sessionTabs={},this.pendingTabs={},this.addedTabs={}}on(){}tabCount(e){}getAllOpenTabIds(e){}getActiveTabInfo(e){}getAllTabIds(e){}isSessionTab(e,t){}createSesion(e){}setAddFrameHandlerCallBack(e){}getAllTabInfoStrings(e){}getAllTabInfos(e){}addNewTab(e,t,r,n={}){}addOpenerStepId(e,t,r){}addOpenerStep(e,t,r){}fixMissingMainTab(e){}buildTabInfo(e,t,r,n,o={}){}addTab(e,t,r,n,o={}){}getTabUtilsByTabIdAndSessionId(e,t){}getTabUtilsByTabId(e){}getTabInfo(e,t){}getTabUtils(e,t){}exactUrlMatch(e,t,r){}singleExactMatchForParts(e,t,r,n){}isSameTab(e,t,r){}getMainTabInfo(e){}getMainTabUtils(e){return{}}removeTabInfo(e,t){}getMainTabId(e){}isMainTabExists(e){}clearAllTabs(e){}clearNonMainTabs(e){}switchTab(e,t,{forceSwitch:r}={forceSwitch:!1}){}getTabDetails(e,t,r={}){}getUnregisteredTabId(e){}waitForTabToOpen(e){}tryToAddTab(e,t){}addNewPopup(e,t){}waitToPendingTabs(e,t){}isMainTabIncognito(){}isInvalidStepVersion(e){}getTabIdByTabInfo(e,t){}}});function By(s){class e{constructor(r,n){this.frameManager=r,this.locateElementPlayer=n}foundFrameCallback(r,n,o){return gd.info("foundFrameCallback-mock invoked"),{}}locate(r,n,o,i,a,c){return gd.info("locate-mock invoked"),{}}findFrame(r,n,o,i){return gd.info("findFrame-mock invoked"),{}}}return e}var gd,$y=w(()=>{"use strict";j();gd=R("mobile-frame-locator-mock")});var DS,MS,Sa,Wy=w(()=>{"use strict";DS=E(require("webdriverio"));jy();Ou();j();Lu();Nu();Ee();Os();qu();$y();zu();Ku();MS=R("appium-test-player"),Sa=class{constructor(e,t,r,n="code",o=DS,i,a){let{sessionPlayer:c,commonConstants:l,stepActionFactory:d,MobileLocateElementPlayer:m}=re();this.driver=o,this.id=e;let p=new _s(this.driver);this.stepActionFactory=new d(p),da(this.driver,this.stepActionFactory),this.tabService=new Ea(this.driver),this.windowCreationListener=jn,this.playbackTimeoutCalculator=new Fs(Mi()),this.tabService.createSesion(e);let f=By(this.driver);this.sessionPlayer=new c(e,this.tabService,null,null,f,Di,m,null,p,this.stepActionFactory,this.playbackTimeoutCalculator,Qe.getSocket(),n),this.sessionPlayer.setShouldMonitorPerformance&&this.sessionPlayer.setShouldMonitorPerformance(r),this.sessionPlayer.playbackManager.isRemoteSession=!0,this.sessionPlayer.playbackManager.isLocalRun=!1,this.sessionPlayer.playbackManager.testRetryCount=i,this.sessionPlayer.playbackManager.previousTestResultId=a,this.sessionPlayer.playbackManager.userParamsData=t||{},this.onStepCompleted=this.onStepCompleted.bind(this),this.sessionPlayer.playbackManager.on(l.playback.RESULT,this.onStepCompleted)}onStepCompleted(e,t,r,n){}async onDone(){try{await this.driver.activeSession.deleteSession()}catch(e){MS.error("error while deleting appium session",{error:e})}finally{let{commonConstants:e}=re();this.sessionPlayer.playbackManager.off(e.playback.RESULT),this.sessionPlayer=null,this.tabService=null,this.stepActionFactory=null,this.driver=null}}getSessionId(){return this.driver.activeSession.sessionId}}});var Vy={};W(Vy,{WorkerAppium:()=>yd});var Gy,qn,yd,qy=w(()=>{"use strict";Gy=E(require("jsdom"));le();Te();Ii();Ta();j();Gt();Wy();Ee();qn=R("worker-appium"),yd=class extends _t{initPlayer(e){return new Sa(this.id,e.runParams,this.options.shouldMonitorPerformance,e.automationMode,void 0,e.retryCount,e.previousTestResultId)}async getBrowserOnce(e,t,r,n){Q.onGetSession(this.id,this.testName,e.runMode);let{driver:o}=r,i=this.options.projectData.type,a=await e.getNativeAppData(),c=i==="android"?e.androidActivityWait:null,l=e.nativeAppLink;if(this.options.appId){let{project:d,appId:m}=this.options,p=await Hc({appId:m,projectId:d});if(!p)throw qn.error("mobile app not found",{appId:m,projectId:d}),new Error("mobile app not found");l=`${ge}/storage${p.filePath}?access_token=${this.options.authData.token}`}try{let d=hh({projectType:i,gridInfo:n,testRunConfig:this.testRunConfig,nativeApp:a,options:this.options,appPath:l,androidActivityWait:c}),m=await o.remote(d);Object.assign(o,{activeSession:m}),await this.updateDeviceInfo(e,m),qn.info(`init new appium session testName: ${this.testName}`,{sessionId:m.sessionId,testResultId:this.testResultId,nativeApp:a})}catch(d){throw qn.error("failed to start application",{err:d}),d}}getServerAddressFromGrid(){let{host:e,port:t,accessToken:r}=this.options.gridData;return`https://${e}:${t}/v0/${r}/wd/hub`}async updateDeviceInfo(e,t){var f;let{executionId:r,testId:n,testResultId:o}=e,{project:i,projectData:{type:a}={},company:{companyId:c=""}={},gridData:{gridId:l=""}={}}=this.options,d=await ml({projectId:i,projectType:a,companyId:c,gridId:l,selectors:`device_id:${t.capabilities.udid}`}),p={name:(f=d==null?void 0:d[0])==null?void 0:f.name,model:t.capabilities.deviceModel,osVersion:t.capabilities.platformVersion,udid:t.capabilities.udid,osType:t.capabilities.platformName,scaleFactor:t.capabilities.pixelRatio,virtual:!1};await ps(i,r,n,o,"RUNNING",{device:p})}getDirectAddressConnection(e){let{directConnectProtocol:t,directConnectHost:r,directConnectPort:n,directConnectPath:o}=e;if(t&&r&&n&&o)return`${t}://${r}:${n}${o}`}async runTestOnce(e,t){let r=re(),{sessionPlayer:n}=t,o=t.driver,i=r.manifestVersion||"runner";Q.onWaitToTestComplete(this.id,this.isCodeMode),n.playbackManager.executionId=e.executionId,n.playbackManager.executionName=e.executionName;let a=this.getDirectAddressConnection(o.activeSession.capabilities)||this.getServerAddressFromGrid(),c=new Gy.JSDOM("").window.DOMParser;n.playbackManager.appiumApi=new r.AppiumApi(a,o.activeSession.sessionId,c),r.localAssetService&&r.localAssetService.initialize({serverUrl:this.options.localRCASaver});let l=async()=>{try{let m=await new Promise((f,h)=>n.playByTestId(this.testId,this.executionId,this.testResultId,this.baseUrl,this.userData,i,f,!1,this.overrideTestConfigId,this.branch,!1,e.remoteRunId,void 0,void 0,void 0).catch(h));return r.localAssetService&&await r.localAssetService.drain(),m.stepsResults=null,m.resultId=this.testResultId,{...m,...e.seleniumPerfStats.getStats()}}catch(d){throw qn.error("error while running appium tests",{err:d}),d}};try{return await super.runTestOnce(e,t),await l.call(this)}catch(d){throw qn.error("failed to run test once",{err:d}),d}}}});var Ra,Hy=w(()=>{"use strict";U();_n();q();Ra=class{constructor(e){this.driver=new Fr,this.id=e}async onDone(){try{await te(this.driver.end(),12e4)}catch(t){t instanceof J&&await this.driver.forceEnd().catch(()=>{})}this.driver=null}getSessionId(){return this.driver.getSessionId()}}});var zy,Ia,Ky=w(()=>{"use strict";zy=E(require("ws"));U();Ia=class{constructor(){this._cdpWs=null;this._cdpUrl=null;this._cdpCallbacks=new Map}async initSession(e,t=500){await this.stopSession(),this._cdpUrl=e,await this.initCDPWebsocket(t)}async initCDPWebsocket(e=500){if(this._cdpWs)return this._cdpWs;let t=new zy.default(this._cdpUrl,{timeout:e}),r=mt(o=>{t.once("open",o)}),n=mt(o=>{t.once("error",o)}).catch(()=>{t.close(),t.removeAllListeners()});return t.on("message",o=>this.onCDPMessage(o)),this._cdpWs=Promise.race([r,n]).then(()=>t),this._cdpWs}onCDPMessage(e){var n;let t=JSON.parse(e),r=this._cdpCallbacks.get(t.id);r&&(this._cdpCallbacks.delete(t.id),t.error?r.reject(new Error(t.error)):(n=t.result.exceptionDetails)!=null&&n.exception?r.reject(new Error(t.result.exceptionDetails.exception.description)):r.resolve(t.result))}async stopSession(){let e=this._cdpWs;if(this._cdpUrl=null,this._cdpWs=null,this._cdpCallbacks.clear(),e)try{return(await e).close()}catch{return}}async cdpCommand(e,t,r){let n=await this.initCDPWebsocket();this._lastWsId||(this._lastWsId=0);let o=this._lastWsId++,i=new Promise((c,l)=>{this._cdpCallbacks.set(o,{resolve:c,reject:l})}),a={method:e,params:t,id:o};return r&&Object.assign(a,{sessionId:r}),n.send(JSON.stringify(a)),i}}});var Pa,bd,xa,Jy=w(()=>{"use strict";U();Pa=E(require("chrome-launcher"));Ii();Ky();bn();bd=class{constructor(e){this.sessionId=e,this.cdpTestRunner=new Ia}async init(e,t,r,n,o,i,a){let l=[...Ri(e,t,r,n,o,i,a).desiredCapabilities.chromeOptions.args,...Pa.Launcher.defaultFlags().filter(m=>m!=="--disable-extensions")];this.chrome=await Pa.launch({chromeFlags:l,startingUrl:void 0,ignoreDefaultFlags:!0}),this.chrome.process.once("exit",()=>{this._isAlive=!1}),this.chrome.process.once("close",()=>{this._isAlive=!1}),this._isAlive=!0;let d=await Pr(`localhost:${this.chrome.port}`);await this.cdpTestRunner.initSession(d),ms(()=>this.chrome.kill())}isAlive(){return this._isAlive}start(){}async stop(){await this.cdpTestRunner.stopSession(),this.chrome&&await this.chrome.kill(),this._isAlive=!1}getSessionId(){return this.sessionId}},xa=class{constructor(e){this.sessionId=z(),this.driver=new bd(this.sessionId),this.id=e}async onDone(){return this.driver.stop()}getSessionId(){return this.sessionId}}});var Yy={};W(Yy,{WorkerExtension:()=>Hn});var Tt,Hn,wd=w(()=>{"use strict";Le();q();Ta();U();j();Gt();ae();Hy();Jy();Tt=R("worker-ext"),Hn=class extends _t{initPlayer(){return this.options.useChromeLauncher?new xa(this.id):new Ra(this.id)}async _getBrowserOnce(e,t,r,n){var i;let{driver:o}=r;try{return await o.init(this.options,this.testName,this.testRunConfig,n,t,this.executionId,this.testResultId,e.seleniumPerfStats,(i=this.options.lightweightMode)==null?void 0:i.general,this.lambdatestService)}catch(a){throw Tt.error("failed to get browser",{err:a,gridInfo:n,testId:e.testId,resultId:e.testResultId}),a}}async getBrowserOnce(e,t,r,n){return Q.onGetSession(this.id,this.testName,e.runMode),this._getBrowserOnce(e,t,r,n)}isUsingChromeLauncher(e){return Boolean(this.options.useChromeLauncher)}async runTestOnce(e,t){let{testResultId:r,executionId:n,testId:o}=this;_("WorkerExtension runTestOnce");let i=async d=>{let m=this.options.timeoutWasGiven?Math.max(1e4,this.options.timeout):this.options.testStartTimeout;try{return await te(e.runTestUsingCDP(d.cdpTestRunner),m,Be.TEST_START_TIMEOUT_MSG)}catch(p){if(!(p instanceof J))throw p;return Tt.warn("timeout while running test using CDP. Running checkViaRestAPIIfTestStarted",{testResultId:r}),await e.checkViaRestAPIIfTestStarted()}},a=async(d,m,p)=>{try{let f=await d.url(m);return p.driverUrlFinished=!0,f}catch(f){throw Tt.error("error from driver.url",{err:f,testResultId:r,executionId:n,testId:o,url:m,urlLength:m.length}),f}},c=async d=>{let m=await e.onStarted(this.options.testStartTimeout);return d.testRunHandlerOnStartedHadFinished=!0,m},l=async()=>{var f;if(_("WorkerExtension runExtTest"),((f=this.options.lightweightMode)==null?void 0:f.disableRemoteStep)||this.options.disableSockets||e.listenToRemoteStep(t.driver),this.isUsingChromeLauncher(t)){Q.onWaitToTestStart(this.id),Q.onWaitToTestComplete(this.id,this.isCodeMode);try{return{...await i(t.driver),...e.seleniumPerfStats.getStats()}}catch(h){throw Tt.warn("failed to run test via CDP",{err:h}),h}}let{driver:m}=t,p={driverUrlFinished:!1,testRunHandlerOnStartedHadFinished:!1};try{let h=await e.getRunTestUrl();Q.onWaitToTestStart(this.id);try{await te(Promise.all([a(t.driver,h,p),c(p)]),this.options.testStartTimeout,Be.TEST_START_TIMEOUT_MSG)}catch(y){if(!(y instanceof J))throw y;Tt.warn("timeout occurred (see log's payload). Running checkViaRestAPIIfTestStarted",{testResultId:r,executionId:n,testId:o,...p}),await e.checkViaRestAPIIfTestStarted()}Q.onWaitToTestComplete(this.id,this.isCodeMode);let g=y=>{throw e.onCompletedCleanup(),Tt.warn("on browser closed error detected",{err:y,testResultId:r,executionId:n,testId:o}),m.unregisterToClosedBrowser(g),y.type=Ys.BROWSER_CLOSED,y};m.registerToClosedBrowser(g);try{let y=await te(e.onCompleted(),this.testRunTimeout,Be.TEST_COMPLETE_TIMEOUT_MSG);m.unregisterToClosedBrowser(g),this.lambdatestService.isLambdatestRun()&&await m.executeJS(`lambda-status=${y.success?"passed":"failed"}`).catch(()=>{}),m.isAlive()||(Tt.warn(`possible grid unresponsive for test ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),y.gridIssues="could not validate grid is alive");let T=m.maxKeepAliveGap();return T>=3e4&&(Tt.warn(`possible browser keep alive issue ${this.testId}, result ${this.testResultId} (execution: ${this.executionId})`),y.keepAliveIssue=T),{...y,...e.seleniumPerfStats.getStats()}}catch(y){throw Tt.warn("timeout wait until test completed",{err:y,testResultId:r,executionId:n,testId:o}),new Error(y)}finally{m.unregisterToClosedBrowser(g)}}catch(h){throw Tt.warn("failed to start url",{err:h}),new Error(h)}};t.driver.start();try{return await super.runTestOnce(e,t),_("WorkerExtension super.runTestOnce"),await l()}catch(d){throw Tt.error("failed to run test",{err:d,testId:e.testId,resultId:e.testResultId}),d}}}});var Xy={};W(Xy,{WorkerExtensionSingleBrowser:()=>Td});var FS,US,Td,Qy=w(()=>{"use strict";Le();U();j();dd();Gt();wd();FS=R("base-worker"),US=500,Td=class extends Hn{async _releasePlayer(){if(!this.testPlayer)return;let{projectId:t}=this.userData||{};await Vn(this.id,this.releaseSlotOnTestFinished,t,this.testPlayer),this.testPlayer=null}onQueueCompleted(){return this._releasePlayer()}async getBrowserOnce(t,r,n,o){return Q.onGetSession(this.id,`worker ${this.id}`,t.runMode),this._getBrowserOnce(t,r,n,o)}async getTestPlayer(t,r){return this.testPlayer&&!this.testPlayer.driver.isAlive()&&(FS.warn("WorkerExtensionSingleBrowser is releasing a dead player",{workerId:this.id}),await this._releasePlayer()),this.testPlayer||(this.testPlayer=await super.getTestPlayer(t,r)),this.testPlayer}async runTest(t,r,n){let o=this.handleQuarantine(t);if(o)return o;_("before runTest onTestStarted single browser");let i=await this.onTestStarted(this.id,t.testId,t.testResultId,n,t.retryKey);t.baseUrl=i.config.baseUrl;let a=await this.getTestPlayer(t,r);return t.markClearBrowser(),await this.runTestOnce(t,a)}async runTestCleanup(){var t;if(!this.executionQueue.hasMoreTests()){await this.onQueueCompleted();return}(t=this.options.lightweightMode)!=null&&t.general&&await se(US)}}});function jS(s,e){e===0?s():setTimeout(s,e*Kd)}var vd,Ca,Zy=w(()=>{"use strict";_n();U();le();Le();cu();xt();Su();q();j();ae();Ly();vd=R("parallel-worker-manager"),Ca=class{constructor(e){this.customExtensionLocalLocation=e}getWorkerType(e){switch(e){case X.SELENIUM:return(Uy(),ie(Fy)).WorkerSelenium;case X.APPIUM:return(qy(),ie(Vy)).WorkerAppium;default:return Ai.isFeatureAvailableForProject("useSameBrowserForMultiTests")?(Qy(),ie(Xy)).WorkerExtensionSingleBrowser:(wd(),ie(Yy)).WorkerExtension}}createWorkers(e,t,r,...n){let o=this.getWorkerType(r),i=()=>{try{return _("before new Worker",r),new o(t,...n)}finally{_("after new Worker",r)}};return Array.from(new Array(e),i)}async runTests(e,t,r,n,o,i,a,c,l){if(e&&e.length===0)return;let d=!1,m=0,p=f=>new Promise(h=>{var Ot,Jr,A,L,F,G;let g=o.project,y=new ba(r,n,e,o,i,t),T={},C=e.length,b=(Ot=o.company)==null?void 0:Ot.companyId,v=(Jr=o.company)==null?void 0:Jr.name,x=o.source||"cli",k=o.user,D=(A=o.company)==null?void 0:A.planType,S=(L=o.company)==null?void 0:L.isStartUp,O=(F=o.projectData)==null?void 0:F.name,P=(G=o.projectData)==null?void 0:G.type,N=o.lightweightMode,B=Rr(o),V=(me,et,we,Fa,zn,Ua)=>(m++,Vf({executionId:r,projectId:g,testId:et,resultId:we,companyId:b,companyName:v,projectName:O,companyPlan:D,sessionType:B,source:x,user:k,lightweightMode:N,isStartUp:S,projectType:P,appSource:Ua}),t.testStartAndReport(me,r,we,Fa,zn)),Y=async(me,et,we,Fa,zn,Ua)=>{var _d,Od,Ld;m--;let vt={...(N==null?void 0:N.onlyTestIdsNoSuite)&&{show:!0},...we.seleniumStats&&{seleniumStats:we.seleniumStats},...we.gridIssues&&{gridIssues:we.gridIssues},...we.keepAliveIssue&&{keepAliveIssue:we.keepAliveIssue},...o.host&&{gridHost:o.host}};if(we.seleniumPerfMarks&&(t.concatSeleniumPerfMarks(we.seleniumPerfMarks),delete we.seleniumPerfMarks),o.grid||o.gridId?(vt.gridName=o.grid||((_d=o.gridData)==null?void 0:_d.name),vt.gridType=(Od=o.gridData)==null?void 0:Od.type,vt.gridProvider=(Ld=o.gridData)==null?void 0:Ld.provider):o.useLocalChromeDriver?(vt.gridName="local-chrome-driver-from-options",vt.gridType="local-chrome"):o.useChromeLauncher?(vt.gridName="chrome-launcher-from-options",vt.gridType="local-chrome"):o.browserstack?vt.gridName="browserstack-from-options":o.saucelabs&&(vt.gridName="saucelabs-from-options"),await t.testEndAndReport(me,we,r,Fa,zn,vt).catch(sw=>vd.error("testEndAndReport threw an error",{err:sw})),zn)return;T[we.resultId]=we,qf({executionId:r,projectId:g,testId:et,resultId:we.resultId,result:we,companyId:b,companyName:v,projectName:O,companyPlan:D,sessionType:B,source:x,user:k,lightweightMode:N,logger:vd,isStartUp:S,projectType:P,appSource:Ua}),l&&!we.success&&(y.stop(),d=!0),(Object.keys(T).length===C||d&&m===0)&&h(T)},Z=(me,et)=>{T[et.resultId]=et,t.onTestIgnored(me,et.resultId),m--,(Object.keys(T).length===C||d&&m===0)&&h(T)},fe=(me,et)=>t.onGridSlot(me,et);o.userData={loginData:Object.assign({},Bt(),{refreshToken:Lo(),authData:Bt(),token:f}),projectId:o.project,company:o.company,servicesUrl:ge},_("in localStrategy before createWorker"),this.createWorkers(c,y,o.mode,o,this.customExtensionLocalLocation,r,V,Y,fe,Z).forEach((me,et)=>{_("before schedule worker.run after createWorkers"),jS(()=>{_("right before worker.run"),me.run()},et)})});try{let f=await Xt(),h=await p(f);if(d)throw new Nt;return h}catch(f){throw vd.error("failed running parallel workers",{executionId:r,err:f}),f}}}});var Aa,eb=w(()=>{"use strict";Ui();Aa=class extends cr{init(e){return super.initNewSocket(e,"real-data")}emitJoinRoom(e,t){this._socket.emit("testResult:listen",{query:`projectId=${t}&runId=${e}`})}joinToTestResultsByRunId(e,t){this.joinRoom(e,t),this.emitJoinRoom(e,t)}stopListenToTestResultsByRunId(e){this.leaveRoom(e),this._socket.emit("testResult:listen:stop",{})}listenToTestResultsByRunId(e){function t(r){e(r.data)}this._socket.on("testResult:changes",t.bind(this))}}});var Ed,Sd,ka,tb=w(()=>{"use strict";Ln();ae();ye();eb();({TEST_RESULT_CREATED:Ed,TEST_RESULT_UPDATED:Sd}=rt),ka=class{constructor(){M.flags.useNewWSCLI.isEnabled()||(this.realDataServiceSocketIO=new Aa)}init(e){return M.flags.useNewWSCLI.isEnabled()?Promise.resolve():this.realDataServiceSocketIO.init(e)}joinToTestResultsByRunId(e,t){if(M.flags.useNewWSCLI.isEnabled())return $e.addFilter(e,{runId:e},[Sd,Ed],!0);this.realDataServiceSocketIO.joinToTestResultsByRunId(e,t)}stopListenToTestResultsByRunId(e){if(M.flags.useNewWSCLI.isEnabled()){$e.removeFilter(e,[Sd,Ed]);return}this.realDataServiceSocketIO.stopListenToTestResultsByRunId(e)}listenToTestResultsByRunId(e,t){if(M.flags.useNewWSCLI.isEnabled()){$e.listenTo(e,[Sd,Ed],r=>r.runId===e,r=>t(r));return}this.realDataServiceSocketIO.listenToTestResultsByRunId(t)}}});async function nb(s,e){var t;if((t=s.lightweightMode)!=null&&t.onlyTestIdsNoSuite&&s.testId)return{tests:[s.testId.map(n=>({testId:n,testConfig:{},resultId:z()}))]};if(s.files.length>0){let{buildCodeTests:r}=await Promise.resolve().then(()=>(Xu(),ry)),n={};if(s.webpackConfig){let o=sb.join(process.cwd(),s.webpackConfig);n=require(o)}return r(s.files,n,{baseUrl:s.baseUrl})}return await qc({projectId:s.project,labels:s.label,testIds:s.testId,testNames:s.name,testConfigNames:s.testConfigNames,suiteNames:s.suites,suiteIds:s.suiteIds,branch:e,rerunFailedByRunId:s.rerunFailedByRunId,testConfigIds:s.testConfigIds,intersections:s.intersections})}function Rd(s){let e=Object.keys(s).length,t=Object.keys(s).reduce((r,n)=>r+(s[n].success===!0?1:0),0);return e===t}async function Id(s,e){let t=s.mode==="extension"?["edge-chromium","chrome"]:["firefox","chrome","edge-chromium","safari","safari technology preview","browser","android","ios","iphone","ipad"],r=rb.difference(Xs(s,e),t);if(r.length>0)throw gt("invalid-config-run",{browser:r.join(", "),mode:"runner"}),new I(`browser type <${r}> is not supported in ${s.mode} mode.`);return e}var rb,sb,ob=w(()=>{"use strict";rb=E(require("lodash")),sb=E(require("path"));U();hs();Te();q()});var Hr,ib,BS,_a,$S,Oa,ab=w(()=>{"use strict";Hr=E(require("lodash"));U();j();le();ae();Le();Ts();ql();cu();Te();xt();Gt();ah();q();Zy();tb();ob();({testRunStatus:ib,CLI_MODE:BS}=Ut),_a=R("test-plan-runner"),$S=1e3*60*5,Oa=class{constructor(e){this.startTime=Date.now();this.workerManager=new Ca(e)}async runTestAllPhases(e,t,r,n,o,i,a,c){let l={},d=Bt(),m=async()=>{let y=o.beforeParallel||1,T=!0,C=await this.workerManager.runTests(e,c,i,a,o,n,d,y,T);Object.assign(l,C)},p=async()=>{let y=io||o.parallel,T=!1;_("right before this.workerManager.runTests");let C=await this.workerManager.runTests(t,c,i,a,o,n,d,y,T);_("right after this.workerManager.runTests"),Object.assign(l,C)},f=async()=>{let y=o.afterParallel||1,T=!1,C=await this.workerManager.runTests(r,c,i,a,o,n,d,y,T);Object.assign(l,C)},h=Rr(o);Hf({executionId:i,projectId:o.project,sessionType:h}),_("right before runBeforeTests");try{return await m(),_("right before runTestPlanTests"),await p(),_("right after runTestPlanTests"),await f(),l}catch(y){if(_a.error("error running test plan",{err:y}),y instanceof Nt)return c.markAllQueuedTests(i,pe.ABORTED,"aborted",!1);throw y}finally{await g()}async function g(){var T,C,b,v;if((T=o.lightweightMode)!=null&&T.disablePixelValidation)return;if(o.mode===BS.SELENIUM){let{EyeSdkBuilder:x}=(await Promise.resolve().then(()=>(Ee(),Or))).getSessionPlayer();await x.closeBatch(i);return}let y;try{if(!((v=(b=(C=o.company)==null?void 0:C.activePlan)==null?void 0:b.premiumFeatures)!=null&&v.applitools)||(y=await cl(o.project),Hr.default.isEmpty(y)||!i))return;let{runKey:x,url:k}=y;await require("@applitools/eyes-sdk-core").makeSDK({name:"Testim.io",version:"4.0.0",spec:{}}).closeBatches({settings:{batchIds:[i],serverUrl:k,apiKey:x}})}catch{}}}async initRealDataService(e){let t=new ka;return await t.init(e),t}async listenToTestCreatedInFile(e,t,r,n){let o={};e.joinToTestResultsByRunId(r,t);let i=!0;return await new Promise(c=>{let l=d=>{i=!1,c(d)};e.listenToTestResultsByRunId(r,d=>{let m=d.id;if(!n.getTestResult(m)){let h=o[m],g=Hr.default.merge({},h,d,{resultId:m});if(o[m]=g,!h||h.status!==d.status){let T=(n.getTestResult(g.parentResultId)||{workerId:1}).workerId;[ib.RUNNING].includes(d.status)&&Q.onTestStarted(g,T),[ib.COMPLETED].includes(d.status)&&(g.duration=g.endTime-g.startTime||0,Q.onTestFinished(g,T))}}let p=!Object.values(o).some(h=>["QUEUED","RUNNING"].includes(h.runnerStatus)),f=!Object.values(n.getAllTestResults()).some(h=>["QUEUED","RUNNING"].includes(h.status));if(p&&f)return l(Object.values(o));if(f&&!p)return se(1e4).then(()=>{i&&l(o)})})})}async initRealDataServiceAndListenToTestsCreatedInFile(e,t,r){let n=await this.initRealDataService(e);return this.listenToTestCreatedInFile(n,e,t,r)}async runTestPlan(e,t,r,n,o,i,a,c){var k,D,S;let l=z(),d=n.project;Xa(l),e.forEach(O=>Object.assign(O,{isBeforeTestPlan:!0})),r.forEach(O=>Object.assign(O,{isAfterTestPlan:!0}));let m=[...e,...t,...r],p=new Ei(m,n,i,a),f=Hr.default.chain(m).map(O=>{var P;return((P=O.overrideTestConfig)==null?void 0:P.name)||""}).uniq().compact().value(),h=(f==null?void 0:f.length)===1?f[0]:null,g=n.files.length>0,y=(k=n.lightweightMode)!=null&&k.onlyTestIdsNoSuite?[]:m.map(O=>O.name),T=(D=n.lightweightMode)!=null&&D.onlyTestIdsNoSuite?{beforeTests:e,tests:t,afterTests:r}:p.executionStart(l,d,this.startTime,o,y),C;g&&(C=this.initRealDataServiceAndListenToTestsCreatedInFile(d,l,p)),_("before testListInfoPromise");let b=await T;(S=n.lightweightMode)!=null&&S.onlyTestIdsNoSuite||Q.onTestPlanStarted(b.beforeTests,b.tests,b.afterTests,o,l,c,h,g),_("before runTestAllPhases");let v=await this.runTestAllPhases(b.beforeTests,b.tests,b.afterTests,a,n,l,o||"All Tests",p),x=await te(C,$S).catch(async()=>{var P;_a.warn("timed out waiting for child results on websocket. using REST fallback",{projectId:d,executionId:l});let O=await hn(d,"testResult",`runId=${l}&sort=runOrder`);return Hr.default.chain(((P=O==null?void 0:O.data)==null?void 0:P.docs)||[]).groupBy("parentResultId").omit("undefined").values().flatten().value()});return _("before executionEnd"),await p.executionEnd(l),_("after executionEnd"),{results:v,executionId:l,testPlanName:o,configName:h,childTestResults:x}}async runTestPlans(e,t){_a.info("start to run test plan",{options:Object.assign({},e,{token:void 0,userParamsData:void 0}),branchToUse:t});function r(d){return Hr.default.flattenDeep(Object.values(d)).reduce((m,p)=>m.concat(p.beforeTests,p.tests,p.afterTests),[])}let n={},o={},i=e.project,a=await Vc(i,e.testPlan,e.testPlanIds,t,e.intersections),c=a.testPlans,l=a.testPlansData;if(!c||c.length===0)throw new I(`no test plan to run ${e.testPlan}`);if(!l||Object.keys(l).length===0){if(e.passZeroTests)return[];throw new I(`no test to run in test plan ${e.testPlan}`)}return await Id(e,r(l)),await de(c,async d=>{let m=d.testPlanId;n[m]={};let p=Object.assign({},e);p.baseUrl=e.baseUrl||d.startUrl,p.host=e.host,p.port=e.port,p.gridId=e.gridId||d.gridId,e.grid&&delete p.gridId,p.gridData=await xf(e,d);let f=p.overrideExecutionName||d.name;return await de(l[m],async h=>{let g=await this.runTestPlan(h.beforeTests,h.tests,h.afterTests,p,f,m,t),y=e.files.length>0;Q.onTestPlanFinished(g.results,d.name,this.startTime,g.executionId,!1,y,g.childTestResults),n[m][g.executionId]=g.results;let T=Object.keys(n[m]).map(x=>({executionId:x,status:Rd(n[m][x])})),C=Object.keys(n[m]).map(x=>n[m][x]).reduce((x,k)=>Object.assign(x,k),{}),b=Rd(C);Object.assign(o,C);let v=b?T[0].executionId:T.find(x=>!x.status).executionId;return await $c(i,m,{success:b,executions:T,executionId:v}),g})})}async runAnonymousTestPlan(e,t){var a;_a.info("start to run anonymous",{options:Object.assign({},e,{token:void 0}),branchToUse:t}),_("before getSuite");let r=await nb(e,t);if(_("after getSuite"),!((a=r==null?void 0:r.tests[0])!=null&&a.length)){if(e.rerunFailedByRunId)throw new I("No failed tests found in the provided run");if(e.passZeroTests)return[];throw new I("No tests to run")}t="branch"in r&&r.branch||t;let n=r;if(e.rerunFailedByRunId&&!n.runName){if(!n.runExists)throw new I("Invalid run ID - no such run.");n.runName===""&&(n.runName=`rerun-${e.rerunFailedByRunId}`)}let o=e.overrideExecutionName||n.runName||[].concat(e.label,e.name,e.suites).join(" "),i=!0;return _("Right before validateConfig + runAnonymousTestPlan tests map"),await de(r.tests,async c=>{if(e.resultId){let m=c[0];m.resultId=e.resultId,c=[m]}await Id(e,c),_("right before runTestPlan");let l=await this.runTestPlan([],c,[],e,o,null,t,i);_("right after runTestPlan");let d=e.files.length>0;return await Q.onTestPlanFinished(l.results,o,this.startTime,l.executionId,i,d,l.childTestResults),l})}async run(e){let t=In(),r=[];Qs(e)?r=await this.runTestPlans(e,t):r=await this.runAnonymousTestPlan(e,t);let n=Hr.default.flattenDeep(r);return _("right before onAllTestPlansFinished"),await Q.onAllTestPlansFinished(n),_("right after onAllTestPlansFinished"),n.map(o=>o.results).reduce((o,i)=>Object.assign(o,i),{})}}});var lb={};W(lb,{init:()=>aR,run:()=>oR});function GS(s){if(!xd.get(s,"company.activePlan.premiumFeatures.allowCLI")){let t=s.project;fs(s.authData.uid,"cli-not-supported",{projectId:t}),console.warn("Testim CLI is not supported in this plan")}}async function VS(s){let e=s.project,t=await zc(e);if(t!=null&&t.isExecutionBlocked)throw console.error("You have reached the limit of runs for the billing month, please upgrade your plan at https://www.testim.io/upgrade-contact-us?source=cli"),fs(s.authData.uid,"execution-quota-surpassed",{projectId:e}),new es}function qS(s,e){var o,i,a,c;if(ho(e.activePlan)==="free"){let l=s.parallel||1,d=((i=(o=e.activePlan)==null?void 0:o.premiumFeatures)==null?void 0:i.concurrency)||1;if(l>d)throw new I(`Cannot run with parallel ${s.parallel}. Max parallel value is ${d}`)}let r=s.retentionDays;if(!r)return;let n=(c=(a=e.activePlan)==null?void 0:a.premiumFeatures)==null?void 0:c.resultRetention;if(r>n)throw new I(`Retention days (${r}) cannot be greater than the company's retention days (${n}). Run aborted`)}async function HS(s){var e;if(!((e=s.lightweightMode)!=null&&e.disableQuotaBlocking))try{await Promise.all([VS(s),GS(s)])}catch(t){if([I,es].some(r=>t instanceof r))throw t;WS.error("could not validate cli account",{err:t})}}function zS(s){let e=Bt();return xm({userId:e.uid,name:e.uid,traits:{projectId:s,company:{id:s,lastCIRun:Math.floor(Date.now()/1e3)}}})}async function KS(s,{disableResults:e=!1,disableRemoteStep:t=!1}){if(M.flags.useNewWSCLI.isEnabled()&&!e&&!t)return $e.connect(s);if(!t){let{remoteStepService:r}=await Promise.resolve().then(()=>(ga(),xy));await r.init(s)}if(!e){let{testResultService:r}=await Promise.resolve().then(()=>(Os(),zh));r.init(s)}}function JS(s,e){let{branch:t,autoDetect:r}=s;if(kf(e,r),!e&&!r)throw new I(`branch ${t} does not exist, run aborted.`)}async function YS(s){let{project:e}=s,t=In();xd.get(s,"company.activePlan.premiumFeatures.ttaForSalesforce")&&(s.sfdcCredential=await jc({projectId:e,branch:t}))}function XS(s,e){let{onprem:t,id:r,storageBaseUrl:n,storageType:o,name:i,activePlan:a={}}=e;if(t){let{mode:m,extensionPath:p,ext:f,playerPath:h}=s;if([X.SELENIUM].includes(m)&&!h)throw new I("in selenium on prem mode --player-path must be provided");if(m==="extension"&&!p&&!f)throw new I("In extension on prem mode --ext or --extension-path must be provided")}let c=Boolean(a.isPoc),l=Boolean(a.isStartUp),d=ho(a);d==="free"&&(s.newBrowserWaitTimeout=s.newBrowserWaitTimeout<cb?cb:s.newBrowserWaitTimeout),M.setCompanyId(r),M.setIsPOC(c),M.setIsStartUp(l),M.setPlanType(d),Ct.setPlanType(d),s.company={companyId:r,onprem:t,storageBaseUrl:n,storageType:o,name:i,planType:d,isPOC:c,isStartUp:l,activePlan:a}}function QS(s,e){if(Xr){s.editorUrl=Xr;return}s.editorUrl=e.editorUrl}function ZS(s,e){s.allGrids=e}function eR(s,e){s.authData=e}function tR(s,e){let{id:t,name:r,type:n,defaults:o}=e;M.setProjectId(t),M.setProjectType(n),s.projectData={projectId:t,type:n,name:r,defaults:o}}async function rR(s){s.gridData=await Pf(s)}async function sR(s){let{project:e}=s,t={projectId:e};s.overrideMappingFile&&(gt("user-override-file",t),s.mockNetworkRules=await fm(s.overrideMappingFile))}async function nR(s,e){_("in runner.js runRunner");let{project:t,remoteRunId:r,useLocalChromeDriver:n,useChromeLauncher:o}=s;r||(s.source=n||o?"cli-local":"cli"),await tf(),_("in runner.js after checkNpmVersion"),await HS(s),_("in runRunner before tunnel.connect"),await oi(s),_("in runRunner after tunnel.connect");let a=await new Oa(e).run(s);return _("before tunnel.disconnect"),await ii(s),await Sn.end(t),_("after tunnel.disconnect and gridService.keepAlive.end"),a}function iR(s){var e;Ct.shouldShowFreeGridRunWarning((e=s.gridData)==null?void 0:e.type)&&console.log(`
\x1B[4m\x1B[36mOur Free grid offers basic service performance.
If you need faster results, contact us to upgrade your plan and dramatically improve your tests\u2019 run times.\x1B[0m
`)}async function aR(s){var g,y,T;_("start runner init");let{project:e,lightweightMode:t,useChromeLauncher:r,mode:n,disableSockets:o}=s,i=M.fetch(),a=KS(e,{disableResults:o||Boolean((t==null?void 0:t.disableResults)&&(r||n!=="extension")),disableRemoteStep:o||Boolean(t==null?void 0:t.disableRemoteStep)});i.catch(()=>{}),a.catch(()=>{});let{authData:c,editorConfig:l,companyByProjectId:d,projectById:m,branchName:p,allGrids:f}=await gn(s);if(qS(s,d),await Promise.all([i,a]),s.browser&&M.flags.dec2022eolBrowsers.isEnabled()){let C=rn(s.browser);if(C.eol)throw new I(`Unsupported browser: ${C.browserName}`)}_("after featureFlagsReady and socketConnected"),QS(s,l),XS(s,d),tR(s,m),JS(s,p),ZS(s,f),eR(s,c),await YS(s),(g=s.lightweightMode)!=null&&g.disableLabs||await Ai.loadLabFeatures(m.id,d.activePlan),((y=s.lightweightMode)==null?void 0:y.type)==="turboMode"&&(M.flags.highSpeedMode.getValue()==="disabled"||s.company.planType==="free")&&delete s.lightweightMode,((T=s.lightweightMode)==null?void 0:T.type)==="turboMode"&&console.log(`
Turbo mode will ignore step delays. Test artifacts like screenshots and logs will only be saved for failed runs. For more information see our docs: https://help.testim.io/docs/turbo-mode`),Sn.start(e),zS(e),await sR(s),await rR(s),iR(s);let h=In();await Q.setOptions(s,h)}var xd,cb,WS,oR,ub=w(()=>{"use strict";xd=E(require("lodash"));U();Ml();Gl();Le();Ts();hs();ql();Te();xt();j();Gt();le();ae();q();ab();Ln();Su();ye();Pn();yl();cb=30*60*1e3,WS=R("runner");oR=nR});function db(s){s.get("/",(e,t)=>{let r=Pd();return t.status(200).json({success:!0,isTestimAgent:!0,startMode:r})}),s.get("/version",(e,t)=>{t.status(200).json({node:process.version,app:Dl()})}),s.get("/loginInfo",(e,t)=>{try{let r=JSON.parse(Buffer.from(e.query.info,"base64").toString());xl({overwriteExisting:!1,projects:r}),t.status(200).end()}catch{t.status(400).end()}})}var pb=w(()=>{"use strict";gs();Cd();Ml()});function hb(s){let e=(0,fb.Router)();return e.post("/run",(t,r)=>{var a;if(!((a=t.body)!=null&&a.step)){r.status(400).send({error:"Missing step"});return}let{step:n,context:o,loginData:i}=t.body;if(!(s!=null&&s.webdriverApi)){r.status(503).send({success:!1,reason:"Testim Agent was not started with Testim Start."});return}t.setTimeout(0),Ns(n,o,s.webdriverApi,i,void 0,"agent").then(c=>{r.status(200).send(c)}).catch(c=>{mb.error("failed to run hybrid code",{e:c}),r.status(500).send(Object.assign({success:!1,error:c}))})}),e.post("/abort",(t,r)=>{var n;if(!((n=t.body)!=null&&n.stepResultId)){r.status(400).send({error:"missing stepResultId"});return}try{id(t.body.stepResultId),r.status(204).end()}catch(o){if(o&&o.message==="No such stepResultId"){r.status(400).send({error:"No such stepResultId"});return}mb.error("hybrid code abort unexpected error",{e:o}),r.status(500).send({error:"unexpected error",info:`${o?o.message:"N/A"}`})}}),e}var fb,mb,gb=w(()=>{"use strict";ia();fb=require("express");j();mb=R("hybrid-router")});var yb,zr,bb,wb=w(()=>{"use strict";yb=require("express");j();sd();zr=(0,yb.Router)(),bb=R("codim-router");zr.get("/tests",async(s,e)=>{let t=await Qu();e.json({tests:t,success:!0})});zr.get("/locators",async(s,e)=>{let t=await $n(),r=await Zu(t,Boolean(s.query.full));e.json({locators:t,contents:r,success:!0})});zr.post("/locators",async(s,e)=>{if(!s.body){e.status(400).send({success:!1,reason:"missing body"});return}if(!s.body.locators){e.status(400).send({success:!1,reason:"missing locators"});return}let{locators:t,mergeIntoExisting:r}=s.body;await td(t,{mergeIntoExisting:r||!1}),e.status(200).send({success:!0})});zr.get("/compile",async(s,e)=>{try{let t=await rd(s.body.name);e.send({success:!0,code:t})}catch(t){bb.error(t),e.json({success:!1,reason:t.message})}});zr.post("/saveTest",async(s,e)=>{if(!s.body){e.status(400).send({success:!1,reason:"missing body"});return}try{await ed(s.body),e.send({success:!0})}catch(t){e.json({success:!1,reason:t.message}),bb.error(t)}})});var Ad,Tb,js,La,vb=w(()=>{"use strict";Ad=E(require("chalk"));jr();Tb=require("express");j();q();js=R("cli-router"),La=(0,Tb.Router)();La.post("/run",async(s,e)=>{let{code:t,stepId:r,incomingParams:n,context:o,testResultId:i,retryIndex:a,stepResultId:c,timeout:l,fileDataUrl:d}=s.body;if(typeof t!="string"||!r||!n||!o||!i||typeof a!="number"||!c||typeof l!="number"){e.status(400).json({success:!1,code:"invalid-params"});return}try{let m=await xs(t,r,n,o,i,a,c,l,d);m.success||(console.log(Ad.default.red(m.result.resultValue)),js.error("CLI Action Failure",{message:m.result.resultValue})),e.status(200).json({success:!0,data:m})}catch(m){js.error("failed to run cli code",{err:m}),console.log(Ad.default.red("failed to run cli code",m)),e.status(500).json({success:!1,code:"internal-error"})}});La.post("/install",async(s,e)=>{let{stepId:t,testResultId:r,retryIndex:n,packageData:o,stepResultId:i,timeout:a}=s.body;if(!t||typeof o!="object"||!r||typeof n!="number"||!i||typeof a!="number"){e.status(400).json({success:!1,code:"invalid-params"});return}try{let c=await Is(t,r,n,o,i,a);js.info("installed packages successfully"),e.status(200).json({success:!0,data:c})}catch(c){if(c instanceof pt){js.error("failed to install node packages",{err:c}),e.status(200).json({success:!1,code:"invalid-node-package",message:c.message});return}if(c instanceof J){js.error("timeout installing node package"),e.status(200).json({success:!1,code:"timeout"});return}js.error("failed to install node packages",{err:c}),e.status(500).json({success:!1,code:"internal-error"})}})});var cR,Eb=w(()=>{"use strict";jr();j();vb();cR=R("cli-service");kh().catch(s=>cR.warn("failed to clean local package folder",{err:s}))});async function lR(s,e,t="utf8"){let r=Ib.join(Rb.tmpdir(),s);return await Sb.promises.writeFile(r,e,t),r}async function dR({code:s}){let e=Date.now();try{let t=`
        module.paths = ${JSON.stringify(module.paths)};
        process.on('unhandledRejection', (error) => {
            process.send({type: 'unhandledRejection', error: {message: error.message, stack: error.stack}});
            process.exit(1);
        });
        process.on('uncaughtException', (error) => {
            process.send({type: 'uncaughtException', error: {message: error.message, stack: error.stack}});
            process.exit(1);
        });
        ${s};
    `,r=await lR(`tst-playground-${Date.now()}.js`,t),n=uR(r);Kr[e]=n.child;let{error:o,exitCode:i}=await n;if(o)throw o;if(i!==0)throw new Error(`Process exited with exit code: ${i}`);return}finally{Kr[e]&&(Kr[e].kill(),delete Kr[e])}}async function Cb({code:s,type:e}){if(["playwright","puppeteer","selenium"].includes(e))return dR({code:s});throw new br}async function Ab(){Object.keys(Kr).forEach(s=>{Kr[s].kill(),delete Kr[s]})}var Sb,Rb,Ib,xb,Pb,Kr,uR,kb=w(()=>{"use strict";Sb=E(require("fs")),Rb=E(require("os")),Ib=E(require("path")),xb=require("child_process");q();Pb=["playwright","selenium","puppeteer"],Kr={};uR=s=>{let e,t=new Promise(n=>{e=n}),r=(0,xb.fork)(s,{stdio:["inherit","inherit","inherit","ipc"]});return t.child=r,r.on("message",n=>{if(!n)return;let{type:o,error:i}=n;i&&["uncaughtException","unhandledRejection"].includes(o)&&e({error:Object.assign(new wr,{innerStack:n.error.stack})})}),r.on("error",n=>{e({error:n})}),r.on("exit",n=>{e({exitCode:n})}),t}});var Lb,Na,Nb,_b,Ob,pR,Db=w(()=>{"use strict";Lb=require("express");j();q();le();kb();Na=(0,Lb.Router)(),Nb=R("playground-router"),_b=["localhost","app.testim.io","playground.testim.io","staging.testim.io","app.staging.testim.cc","tta-crm.tricentis.com"],Ob=s=>{if(!s)return{};try{return new URL(s)}catch{return{}}},pR=(s,e,t)=>{if(so)return t();let r=s.headers.referer,n=s.headers.origin;if(!r&&!n)return e.status(400).send();let o=Ob(r),i=Ob(n);return!_b.includes(o.hostname)&&!_b.includes(i.hostname)?e.status(400).send():t()};Na.post("/run",[pR],async(s,e)=>{let t=s.body||{},{code:r,type:n}=t;if(!r||!Pb.includes(n)){e.status(400).send({success:!1,reason:"missing arguments"});return}try{await Cb(t),e.send({success:!0})}catch(o){if(o instanceof br){e.status(404).send({success:!1});return}if(o instanceof wr){e.json({success:!1,type:"playground-error",stack:o.innerStack});return}e.json({success:!1,reason:o.message}),Nb.error(o)}});Na.post("/stop",(s,e)=>{try{Ab(),e.send({success:!0})}catch(t){e.json({success:!1,reason:t.message}),Nb.error(t)}})});function Fb(s){let e=(0,Mb.Router)();return e.get("/cdp-url",(t,r)=>{if(!s){r.status(503).send({error:"Testim standalone browser is not running"});return}r.status(200).send({url:s.webdriverApi.cdpUrl})}),e.get("/status",(t,r)=>{if(!s){r.status(503).send({ok:!1});return}r.status(200).send({ok:!0})}),e}var Mb,Ub=w(()=>{"use strict";Mb=require("express")});var Wb={};W(Wb,{orchestrateRoutes:()=>mR});function mR(s,e){let t=(0,Bb.default)();s(t),t.use(kd.default.urlencoded({extended:!1,limit:"50mb"})),t.use((0,$b.default)()),t.use(kd.default.json({limit:"50mb"}));let n={methods:["GET","PUT","POST","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],credentials:!0,maxAge:86400,origin:Ne||so?"*":["http://localhost:3000","https://app.testim.io","https://staging.testim.io","https://playground.testim.io","https://app.staging.testim.cc","chrome-extension://pebeiooilphfmbohdbhbomomkkoghoia","https://tta-crm.tricentis.com"]};return t.use("*",(0,jb.default)(n)),db(t),t.use("/files",zr),t.use("/playground",Na),t.use("/cliJs",La),t.use("/standalone-browser",Fb(e)),t.use("/hybrid",hb(e)),t.use((o,i)=>{i.status(404).send("Endpoint Not Found")}),t}var jb,Bb,kd,$b,Gb=w(()=>{"use strict";jb=E(require("cors")),Bb=E(require("express")),kd=E(require("body-parser")),$b=E(require("compression"));pb();gb();wb();Eb();Db();Ub();le()});var qb={};W(qb,{init:()=>fR});async function fR({agentPort:s,agentBind:e,project:t,token:r,installPlaygroundPlaywrightDeps:n,installPlaygroundPuppeteerDeps:o,installPlaygroundSeleniumDeps:i},a){await gR({installPlaygroundPlaywrightDeps:n,installPlaygroundPuppeteerDeps:o,installPlaygroundSeleniumDeps:i,project:t}),await hR({agentPort:s,agentBind:e,project:t,token:r},a)}async function hR({agentPort:s,agentBind:e,project:t,token:r},n){let{orchestrateRoutes:o}=await Promise.resolve().then(()=>(Gb(),Wb));return new Promise((i,a)=>{let c=()=>{};t&&(om(t,r),c=f=>{f.use((h,g,y)=>{Object.assign(h,{project:t}),y()})});let l=o(c,n),d=Vb.createServer(l);d.listen(s,e),d.on("error",m),d.on("listening",p);function m(f){if(f.syscall!=="listen")return a(f);switch(f.code){case"EACCES":case"EPERM":return a(new I(`Port ${s} requires elevated privileges`));case"EADDRINUSE":return a(new I(`Port ${s} is already in use, is another Testim instance running?`));default:return a(f)}}function p(){let{port:f}=d.address();console.log(`Running on port: ${f}`),yR()}})}function gR({installPlaygroundPlaywrightDeps:s,installPlaygroundPuppeteerDeps:e,installPlaygroundSeleniumDeps:t,project:r}){let n=[];return s&&n.push(he("playwright")),e&&n.push(he("puppeteer")),t&&n.push(he("selenium-webdriver"),Ar({projectId:r})),Promise.all(n)}async function yR(){await require("prompts")({name:"",type:"text",message:'Type the word "stop" or Press Ctrl + C.',validate:t=>t.toUpperCase().trim()==="STOP"}),console.log("Exiting Testim CLI"),process.exit(0)}var Vb,Hb=w(()=>{"use strict";Vb=E(require("http"));xt();q();bt();us()});var Zb={};W(Zb,{getStartedWithStart:()=>Pd,runAgentMode:()=>vR});async function vR(s){var r;let e;if(await kr(s.playerLocation,s.canary),s.startTestimBrowser){await RR();try{e=await SR(s)}catch(n){throw(r=n==null?void 0:n.message)!=null&&r.includes("user data directory is already in use")?new I('Please close all chrome browsers that were opened with "testim start" and try again'):n}}let t=await Promise.resolve().then(()=>(Hb(),qb));return e!=null&&e.webdriverApi&&setTimeout(async()=>{setTimeout(()=>(pa(),ie(Ju)));let o=["webpack"];for(let i of o)await he(i,{silent:!0}).catch(()=>null)},6e3),t.init(s,e)}function Pd(){return Xb}function zb(s){try{return process.kill(s,0)}catch{return!1}}async function ER(s,e,t){let r=fr.join(jt,`chrome-${un}-process`),n=3e3,o=()=>{ke.rmSync(r,{recursive:!0}),console.log(`

Browser session ended`),process.exit(0)};if(await be(r)){let f=JSON.parse(ke.readFileSync(r));if(zb(f.pid)){let h=()=>zb(f.pid)?setTimeout(h,n):o();return h(),{webdriverApi:f}}}let i=await ko();await be(Bs)||await ke.promises.mkdir(Bs,{recursive:!0});let c=[...Qb(Bs,e,t,i).desiredCapabilities.chromeOptions.args,...Ma.Launcher.defaultFlags().filter(f=>!["--disable-extensions","--disable-component-extensions-with-background-pages"].includes(f))],l={GOOGLE_API_KEY:"AIzaSyCkfPOPZXDKNn8hhgu3JrA62wIgC93d44k",GOOGLE_DEFAULT_CLIENT_ID:"811574891467.apps.googleusercontent.com",GOOGLE_DEFAULT_CLIENT_SECRET:"kdloedMFGdGla2P1zacGjAQh"},d=`${s.extensionPath?"http://localhost:3000/app/":"https://app.testim.io"}?startMode=true`,m=await Ma.launch({chromeFlags:c,startingUrl:d,ignoreDefaultFlags:!0,userDataDir:Bs,chromePath:i,envVars:l}),p={port:m.port,pid:m.pid,cdpUrl:await Pr(`localhost:${m.port}`)};return ke.writeFileSync(r,JSON.stringify(p)),m.process.once("exit",o),m.process.once("close",o),{webdriverApi:p}}async function SR(s){let e=`${Xd}/extension/testim-full-master.zip`,t=fr.basename(e),r=fr.join(jt,t),n=fr.join(jt,`${t}__unzipped__`),o=!(s.ext||s.extensionPath);if(o&&await be(r)){let f=await ke.promises.stat(r);o=Date.now()-wR>f.mtimeMs}if(await ke.promises.mkdir(jt,{recursive:!0}),o){let f=(0,Jb.default)("Downloading Testim Editor").start();await ze(e,r);try{await tt(r,n)}catch{await ke.promises.rm(r,{recursive:!0,force:!0}),await ze(e,r);try{await tt(r,n)}catch{throw await ke.promises.rm(r,{recursive:!0,force:!0}),f.fail("Failed to download Testim Editor"),new Error("Failed to download Testim Editor")}}finally{s.downloadBrowser||await ke.promises.rm(n,{recursive:!0,force:!0})}f.succeed()}let i=s.extensionPath?null:(await ke.promises.readFile(s.ext||r)).toString("base64");if(s.downloadBrowser)return await ER(s,i,n);await Ar({projectId:s.project},{chromeBinaryLocation:s.chromeBinaryLocations});let a=Qb(Bs,i,s.extensionPath,s.chromeBinaryLocations),{WebDriver:c}=(_n(),ie(Ih)),{SeleniumPerfStats:l}=(Es(),ie(th)),d=new c;d.seleniumPerfStats=new l;let m=await d.initClient(a);Xb=!0;let p=`${s.extensionPath?"http://localhost:3000/app/":"https://app.testim.io"}?startMode=true`;await d.url(p),Object.assign(d,{initialUrl:p});try{d.cdpUrl=await Pr(m.value["goog:chromeOptions"].debuggerAddress)}catch{}return{webdriverApi:d}}function Qb(s,e,t,r){let n=e?[e]:[],o=[`--user-data-dir=${s}`,"--log-level=OFF","--silent-debugger-extension-api","--no-first-run"];return t&&o.push(`--load-extension=${t}`),{logLevel:bR,desiredCapabilities:{chromeOptions:{args:o,extensions:n,binary:r},browserName:"chrome"},host:"localhost",port:9515}}async function RR(){if(await be(Da))try{let{webSocketDebuggerUrl:s}=await IR();await xR(s),await ke.promises.unlink(Da)}catch(s){s&&s.message==="unable to connect to devtools http server"&&await ke.promises.unlink(Da)}}async function IR(){let s=await ke.promises.readFile(Da,{encoding:"utf8"}),[e,t]=s.split(`
`).map(o=>o.trim()),r=Number.parseInt(e,10);if(!Number.isInteger(r)||r<1||r>65535)throw new Error("invalid port number");if(!t.startsWith("/devtools/browser/"))throw new Error("invalid devtools browser url");let n=await Pr(`localhost:${r}`,500);if(!n.endsWith(t))throw new Error("invariant webSocketDebuggerUrl miss match");return{port:r,webSocketDebuggerUrl:n}}async function xR(s,e=100){let t=await PR(s,e);return mt(r=>{t.send(JSON.stringify({id:0,method:"Browser.close"}),r)})}async function PR(s,e=100){let t=new Yb.default(s,{timeout:e}),r=mt(o=>{t.once("open",o)}).then(()=>{t.removeAllListeners()}),n=mt(o=>{t.once("error",o)}).catch(()=>{t.close(),t.removeAllListeners()});return Promise.race([r,n]).then(()=>t)}var Kb,Jb,Yb,ke,fr,Ma,bR,wR,Bs,TR,Da,Xb,Cd=w(()=>{"use strict";Kb=E(require("ms")),Jb=E(require("ora")),Yb=E(require("ws")),ke=E(require("fs")),fr=E(require("path")),Ma=E(require("chrome-launcher"));le();us();q();bt();Oc();U();bR=oo?"verbose":"silent",wR=(0,Kb.default)("1h"),Bs=fr.join(jt,"profile"),TR="DevToolsActivePort",Da=fr.join(Bs,TR);Xb=!1});var EN=require("source-map-support/register");var Dd;(Dd=Array.prototype).at||(Dd.at=function(s){let e=Number.isInteger(s)?s:0,t=e>=0?e:this.length+e;if(!(t<0||t>=this.length))return this[t]});var Md=require("perf_hooks");var to=E(require("os")),Ws=E(require("url")),Gs=E(require("http")),ja=E(require("https")),Jn=E(require("form-data")),Yn=class{constructor(){this.onloadstart=null;this.onprogress=null;this.onabort=null;this.onerror=null;this.onload=null;this.ontimeout=null;this.onloadend=null;this._listeners={}}addEventListener(e,t){var r;e=e.toLowerCase(),(r=this._listeners)[e]||(r[e]=[]),this._listeners[e].push(t)}removeEventListener(e,t){let r;e=e.toLowerCase(),this._listeners[e]&&(r=this._listeners[e].indexOf(t),r!==-1&&this._listeners[e].splice(r,1))}dispatchEvent(e){var n;e.currentTarget=this,e.target=this;let t=e.type,r=this._listeners[t]||[];for(let o of r)o==null||o.call(this,e);(n=this[`on${t}`])==null||n.call(this,e)}},Xn=class extends Yn{constructor(t){super();this._request=t;this._contentType=null;this._body=null}_reset(){this._contentType=null,this._body=null}_setData(t){if(!(typeof t>"u"||t===null))if(typeof t=="string")t.length!==0&&(this._contentType="text/plain;charset=UTF-8"),this._body=Buffer.from(t,"utf8");else if(Buffer.isBuffer(t))this._body=t;else if(t instanceof ArrayBuffer){let r=Buffer.alloc(t.byteLength),n=new Uint8Array(t);for(let o=0;o<t.byteLength;o++)r[o]=n[o];this._body=r}else if("buffer"in t&&t.buffer instanceof ArrayBuffer){let r=Buffer.alloc(t.byteLength),n=t.byteOffset,o=new Uint8Array(t.buffer);for(let i=0;i<t.byteLength;i++)r[i]=o[i+n];this._body=r}else if(typeof t=="object"&&t instanceof Jn.default)this._body=null;else throw new Error(`Unsupported send() data ${t}`)}_finalizeHeaders(t,r){this._contentType&&!("content-type"in r)&&(t["Content-Type"]=this._contentType),this._body&&(t["Content-Length"]=this._body.length.toString())}_startUpload(t){this._body&&t.write(this._body),t.end()}},$s=class{constructor(e){this.type=e;this.target=null;this.currentTarget=null;this.lengthComputable=!1;this.loaded=0;this.total=0;this.bubbles=!1;this.cancelable=!1}},Qn=class extends Error{},Zn=class extends Error{},eo=class extends Error{},hr=class extends Error{},Re=class extends Yn{constructor(t){super();this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.nodejsHttpAgent=Gs.globalAgent;this.nodejsHttpsAgent=ja.globalAgent;this.nodejsBaseUrl=null;this._restrictedMethods={CONNECT:!0,TRACE:!0,TRACK:!0};this._restrictedHeaders={"accept-charset":!0,"accept-encoding":!0,"access-control-request-headers":!0,"access-control-request-method":!0,connection:!0,"content-length":!0,cookie:!0,cookie2:!0,date:!0,dnt:!0,expect:!0,host:!0,"keep-alive":!0,origin:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,via:!0};this._privateHeaders={"set-cookie":!1,"set-cookie2":!1};this._userAgent=`Mozilla/5.0 (${to.type()} ${to.arch()}) node.js/${process.versions.node} v8/${process.versions.v8}`;this.onreadystatechange=null;this.readyState=Re.UNSENT;this.response=null;this.responseText="";this.responseType="";this.status=0;this.statusText="";this.timeout=0;this.upload=new Xn(this);this._method=null;this._url=null;this._sync=!1;this._headers=null;this._loweredHeaders=null;this._mimeOverride=null;this._request=null;this._response=null;this._responseParts=null;this._responseHeaders=null;this._aborting=null;this._error=null;this._loadedBytes=0;this._totalBytes=0;this._lengthComputable=!1;this._anonymous=t==null?void 0:t.anon}static nodejsSet(t){Re.prototype.nodejsSet(t)}nodejsSet(t){if("httpAgent"in t&&(this.nodejsHttpAgent=t.httpAgent),"httpsAgent"in t&&(this.nodejsHttpsAgent=t.httpsAgent),"baseUrl"in t){let r=t.baseUrl;if(r!==null&&!Ws.parse(r,!1,!0).protocol)throw new Qn("baseUrl must be an absolute URL");this.nodejsBaseUrl=r}}open(t,r,n){if(t=t.toUpperCase(),t in this._restrictedMethods)throw new eo(`HTTP method ${t} is not allowed in XHR`);let o=this._parseUrl(r);n===void 0&&(n=!0),this._method=t,this._url=o,this._sync=!n,this._headers={},this._loweredHeaders={},this._mimeOverride=null,this._setReadyState(Re.OPENED),this._request=null,this._response=null,this.status=0,this.statusText="",this._responseParts=[],this._responseHeaders=null,this._loadedBytes=0,this._totalBytes=0,this._lengthComputable=!1}setRequestHeader(t,r){if(this.readyState!==Re.OPENED)throw new hr("XHR readyState must be OPENED");let n=t.toLowerCase();this._restrictedHeaders[n]||/^sec-/.test(n)||/^proxy-/.test(n)||(r=r.toString(),n in this._loweredHeaders?(t=this._loweredHeaders[n],this._headers[t]=`${this._headers[t]}, ${r}`):(this._loweredHeaders[n]=t,this._headers[t]=r))}send(t){if(this.readyState!==Re.OPENED)throw new hr("XHR readyState must be OPENED");if(this._request)throw new hr("send() already called");switch(this._url.protocol){case"file:":this._sendFile();break;case"http:":case"https:":this._sendHttp(t);break;default:throw new Zn(`Unsupported protocol ${this._url.protocol}`)}}abort(){this._request&&(this._request.abort(),this._setError(),this._dispatchProgress("abort"),this._dispatchProgress("loadend"))}getResponseHeader(t){var n;let r=t.toLowerCase();return((n=this._responseHeaders)==null?void 0:n[r])||null}getAllResponseHeaders(){return this._responseHeaders?Object.entries(this._responseHeaders).map(([t,r])=>`${t}: ${r}`).join(`\r
`):""}overrideMimeType(t){if([Re.LOADING,Re.DONE].includes(this.readyState))throw new hr("overrideMimeType() not allowed in LOADING or DONE");this._mimeOverride=t.toLowerCase()}_setReadyState(t){this.readyState=t;let r=new $s("readystatechange");this.dispatchEvent(r)}_sendFile(){throw this._url.method!=="GET"?new Zn("The file protocol only supports GET"):new Error("Protocol file: not implemented")}_sendHttp(t){if(this._sync)throw new Error("Synchronous XHR processing not implemented");t!=null&&(this._method==="GET"||this._method==="HEAD")?t=null:t||(t=""),this.upload._setData(t),this._finalizeHeaders(t),this._sendHxxpRequest(t)}_sendHxxpRequest(t){let r=this._url.protocol==="http:"?this.nodejsHttpAgent:this.nodejsHttpsAgent,o=(this._url.protocol==="http:"?Gs:ja).request({hostname:this._url.hostname,port:this._url.port,path:this._url.path,auth:this._url.auth,method:this._method,headers:this._headers,agent:r});typeof t=="object"&&t instanceof Jn.default&&t.pipe(o),this._request=o,this.timeout&&o.setTimeout(this.timeout,()=>this._onHttpTimeout(o)),o.on("response",i=>this._onHttpResponse(o,i)),o.on("error",()=>this._onHttpRequestError(o)),this.upload._startUpload(o),this._request===o&&this._dispatchProgress("loadstart")}_finalizeHeaders(t){typeof t=="object"&&t instanceof Jn.default&&Object.assign(this._headers,t.getHeaders()),this._headers.Connection="keep-alive",this._headers.Host=this._url.host,this._anonymous&&(this._headers.Referer="about:blank"),this._headers["User-Agent"]=this._userAgent,this.upload._finalizeHeaders(this._headers,this._loweredHeaders)}_onHttpResponse(t,r){if(this._request!==t)return;if([301,302,303,307,308].includes(r.statusCode)){this._url=this._parseUrl(r.headers.location),this._method="GET","content-type"in this._loweredHeaders&&(delete this._headers[this._loweredHeaders["content-type"]],delete this._loweredHeaders["content-type"]),"Content-Type"in this._headers&&delete this._headers["Content-Type"],delete this._headers["Content-Length"],this.upload._reset(),this._finalizeHeaders(),this._sendHxxpRequest();return}this._response=r,this._response.on("data",o=>this._onHttpResponseData(r,o)),this._response.on("end",()=>this._onHttpResponseEnd(r)),this._response.on("close",()=>this._onHttpResponseClose(r)),this.status=this._response.statusCode,this.statusText=Gs.STATUS_CODES[this.status],this._parseResponseHeaders(r);let n=this._responseHeaders["content-length"];n?(this._totalBytes=parseInt(n,10),this._lengthComputable=!0):this._lengthComputable=!1,this._setReadyState(Re.HEADERS_RECEIVED)}_onHttpResponseData(t,r){if(this._response===t)return this._responseParts.push(r),this._loadedBytes+=r.length,this.readyState!==Re.LOADING&&this._setReadyState(Re.LOADING),this._dispatchProgress("progress")}_onHttpResponseEnd(t){if(this._response===t)return this._parseResponse(),this._request=null,this._response=null,this._setReadyState(Re.DONE),this._dispatchProgress("load"),this._dispatchProgress("loadend")}_onHttpResponseClose(t){if(this._response!==t)return;let r=this._request;return this._setError(),r.abort(),this._setReadyState(Re.DONE),this._dispatchProgress("error"),this._dispatchProgress("loadend")}_onHttpTimeout(t){if(this._request===t)return this._setError(),t.abort(),this._setReadyState(Re.DONE),this._dispatchProgress("timeout"),this._dispatchProgress("loadend")}_onHttpRequestError(t){if(this._request===t)return this._setError(),t.abort(),this._setReadyState(Re.DONE),this._dispatchProgress("error"),this._dispatchProgress("loadend")}_dispatchProgress(t){let r=new $s(t);r.lengthComputable=this._lengthComputable,r.loaded=this._loadedBytes,r.total=this._totalBytes,this.dispatchEvent(r)}_setError(){this._request=null,this._response=null,this._responseHeaders=null,this._responseParts=null}_parseUrl(t){let r,n,o,i=this.nodejsBaseUrl===null?t:Ws.resolve(this.nodejsBaseUrl,t),a=Ws.parse(i,!1,!0);return a.hash=null,a.auth&&(typeof o<"u"&&o!==null||typeof n<"u"&&n!==null)&&(r=a.auth.indexOf(":"),r===-1?o||(o=a.auth):(o||(o=a.substring(0,r)),n||(n=a.substring(r+1)))),(o||n)&&(a.auth=`${o}:${n}`),a}_parseResponseHeaders(t){this._responseHeaders={},Object.entries(t.headers).forEach(([r,n])=>{let o=r.toLowerCase();this._privateHeaders[o]||(this._mimeOverride!==null&&o==="content-type"&&(n=this._mimeOverride),this._responseHeaders[o]=n)}),this._mimeOverride!==null&&!("content-type"in this._responseHeaders)&&(this._responseHeaders["content-type"]=this._mimeOverride)}_parseResponse(){let t=Buffer.concat(this._responseParts);switch(this._responseHeaders["content-encoding"]==="gzip"&&(t=require("zlib").gunzipSync(t)),this._responseParts=null,this.responseType){case"text":this._parseTextResponse(t);break;case"json":this.responseText=null;try{this.response=JSON.parse(t.toString("utf-8"))}catch{this.response=null}break;case"buffer":this.responseText=null,this.response=t;break;case"arraybuffer":{this.responseText=null;let r=new ArrayBuffer(t.length),n=new Uint8Array(r);for(let o=0;o<t.length;o++)n[o]=t[o];this.response=r;break}default:this._parseTextResponse(t)}}_parseTextResponse(t){try{this.responseText=t.toString(this._parseResponseEncoding())}catch{this.responseText=t.toString("binary")}this.response=this.responseText}_parseResponseEncoding(){let t=this._responseHeaders["content-type"],r=/;\s*charset=(.*)$/.exec(t);return t&&r?r[1]:"utf-8"}},_e=Re;_e.SyntaxError=Qn,_e.ProgressEvent=$s,_e.SecurityError=eo,_e.XMLHttpRequest=Re,_e.InvalidStateError=hr,_e.XMLHttpRequestUpload=Xn,_e.UNSENT=0,_e.OPENED=1,_e.HEADERS_RECEIVED=2,_e.LOADING=3,_e.DONE=4;Object.assign(global,{xhr2:_e,XMLHttpRequest:_e,performance:Md.performance,...typeof Blob>"u"&&{Blob:require("buffer").Blob}});var ew=E(require("semver"));Le();yl();Jt();us();var tw=E(require("chalk")),rw=require("events");ae();bn();q();ae();No();j();var ym=E(require("os")),bl=E(require("path")),wl=E(require("chalk")),$o=require("fs");function bm(s){var e,t,r;if(!((e=s==null?void 0:s.message)!=null&&e.includes("SIGINT")))try{let n=ym.homedir();(0,$o.mkdirSync)(bl.resolve(n,".testim_logs"),{recursive:!0});let o=bl.resolve(n,".testim_logs",`${new Date().toISOString().replace(/:|\./g,"_")}.log`);console.log("Oops :( The test runner has encountered an unexpected error. A complete log of this run can be found in:"),console.log(`	${o}`),(t=s==null?void 0:s.message)!=null&&t.includes("Unable to compile TypeScript")&&((r=s.stack)!=null&&r.includes("runner/src"))&&process.argv.some(i=>i.includes("player-require-path"))&&(console.log(wl.default.red("Looks like you got a TypeScript compile error champ - but it's not a very good one because we use TypeScript in transpile-only mode")),console.log(wl.default.red("change require('ts-node/register/transpile-only'); to require('ts-node/register'); for better errors"))),(0,$o.writeFileSync)(o,`${s}
${s==null?void 0:s.stack}

${JSON.stringify(s,Object.getOwnPropertyNames(s),2)}`)}catch{}}on();var kT=R("process-handler"),wm=!1;function _T(s){return s instanceof Error?1:wm?0:(s||(s={}),Object.values(s).some(({runnerStatus:t,success:r,testStatus:n,status:o})=>[t,o].includes(pe.SKIPPED)||[t,o].includes(pe.FAILED)&&n===Ke.EVALUATING?!1:r!==!0)?1:0)}function OT(){try{Yt("chromedriver").stop()}catch{}}function Tm(){wm=!0}async function Tl(s){s!=null&&s.stack&&(ds?console.error(s,s.stack):bm(s)),OT(),await kT.waitForFlush(),process.exit(_T(s))}Te();j();var CR=R("cli-entry");function AR(s){if(!ew.satisfies(process.version,s))throw new I(`Required node version ${s} not satisfied with current version ${process.version}`);let e=14,t=16,r=Number(process.versions.node.split(".")[0]),n=new Date("2023-04-30T00:00:00.000Z")<=new Date;if(r<e)throw new I(`Testim.io CLI supports Node.js ${e} and above, please upgrade to a newer Node.js version`);if(r<t&&n)throw new I(`Testim.io CLI supports Node.js ${t} and above, please upgrade to a newer Node.js version`);r<t&&console.log("\x1B[33m%s\x1B[0m",`Testim.io CLI will stop supporting Node.js < ${t} on April 30 2023, please upgrade to a newer Node.js version`)}async function kR(){console.log("Starting Testim.io CLI");let[s,e]=await Promise.all([Promise.resolve().then(()=>(U(),H)),Promise.resolve().then(()=>(jm(),Um)),Promise.resolve().then(()=>(Wm(),zT)).catch(()=>{})]);_("Starting Testim.io CLI"),gm(Tl);try{AR(s.getEnginesVersion())}catch(t){console.log("Argument Error:",t.message),process.exit(1)}try{let t=await e.process();if(_("in main, after options.process"),Za(global.proxyUri),"parallel"in t&&t.parallel>5&&(rw.EventEmitter.defaultMaxListeners=t.parallel*2),Qa(t.project),Mp("token"in t&&typeof t.token=="string"?t.token:"anonymous_encrypt_key"),s.isInstallLazyDepsMode(t)){console.log("Lazy dependency installation started");let{installAllLazyDependencies:o}=await Promise.resolve().then(()=>(bt(),Ol));return await o()}if(s.isInitCodimMode(t)){let{init:o}=await Promise.resolve().then(()=>(Ym(),Jm));return o(t.initTestProject)}if(s.isLoginMode(t))return;if(s.isCreatePrefetchedDataMode(t)){await Op(),await gn(t);let{preloadTests:o}=await Promise.resolve().then(()=>(Xo(),Qm));await o(t),!t.playerRequirePath&&t.mode!==X.EXTENSION&&await kr(t.playerLocation,t.canary);let i=await Np();i.success?console.log(`created prefetched data at ${vo()}`):console.error("failed to create prefetch data",i.error);return}let r=await Promise.resolve().then(()=>(ub(),lb));if(s.isTunnelOnlyMode(t)){await r.init(t);let{serveTunneling:o}=await Promise.resolve().then(()=>(Gl(),Wl));await o(t);return}if(s.isAgentMode(t)){let{runAgentMode:o}=await Promise.resolve().then(()=>(Cd(),Zb));return o(t)}if(t.saveRCALocally){let{initServer:o}=await Promise.resolve().then(()=>(pu(),oh)),{port:i}=await o(t);t.localRCASaver=`http://localhost:${i}`}t.exitCodeIgnoreFailingTests&&Tm(),_("right before testRunner.init/prepareRunner.prepare");let[n]=await Promise.all([mm(t),r.init(t)]);return _("right after testRunner.init/prepareRunner.prepare"),await r.run(t,n)}catch(t){if(t instanceof gr)return;let r=s.getArgsOnRemoteRunFailure();return r&&await pl({...r,error:t.message}).catch(()=>{}),t instanceof I?(console.log(tw.default.red("Argument Error:",t.message)),t):t instanceof Lt?(console.log("Selenium Error:",t.message),t):(console.log("Error:",t.message),CR.error("runner ended with unexpected error",{err:t}),t)}}kR().then(s=>{Array.isArray(s)&&s.length===0&&console.log("No tests ran"),Tl(s)});
//# sourceMappingURL=cli.js.map
